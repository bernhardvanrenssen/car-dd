let e=class{constructor(e,t,s){this.owner=e,this.name=t,this.fn=s}unbind(){this.owner&&(this.owner.unbind(this.name,this.fn),this.owner=null,this.name=null,this.fn=null)}call(e,...t){this.fn&&this.fn.call(this.owner,arguments[0],arguments[1],arguments[2],arguments[3],arguments[4],arguments[5],arguments[6],arguments[7])}on(e,t){return this.owner.on(e,t)}},t=class{constructor(){this._suspendEvents=!1,this._additionalEmitters=[],this._events={},Object.defineProperty(this,"_events",{enumerable:!1,configurable:!1,writable:!0,value:{}})}set suspendEvents(e){this._suspendEvents=!!e}get suspendEvents(){return this._suspendEvents}on(t,s){const i=this._events[t];return void 0===i?this._events[t]=[s]:-1===i.indexOf(s)&&i.push(s),new e(this,t,s)}once(e,t){const s=this.on(e,((e,i,n,a,r,o,l,h)=>{t.call(this,e,i,n,a,r,o,l,h),s.unbind()}));return s}emit(e,t,s,i,n,a,r,o,l){if(this._suspendEvents)return this;let h=this._events[e];if(h&&h.length){h=h.slice(0);for(let c=0;c<h.length;c++)if(h[c])try{h[c].call(this,t,s,i,n,a,r,o,l)}catch(t){console.info("%c%s %c(event error)","color: #06f",e,"color: #f00"),console.log(t.stack)}}if(this._additionalEmitters.length){this._additionalEmitters.slice().forEach((h=>{h.emit(e,t,s,i,n,a,r,o,l)}))}return this}unbind(e,t){if(e){const s=this._events[e];if(!s)return this;if(t){const i=s.indexOf(t);-1!==i&&(1===s.length?delete this._events[e]:s.splice(i,1))}else delete this._events[e]}else this._events={};return this}addEmitter(e){this._additionalEmitters.includes(e)||this._additionalEmitters.push(e)}removeEmitter(e){const t=this._additionalEmitters.indexOf(e);-1!==t&&this._additionalEmitters.splice(t,1)}};const s=(e,t)=>{if(!e||!t)return!1;const i=e.length;if(i!==t.length)return!1;for(let n=0;n<i;n++)if(e[n]instanceof Array&&t[n]instanceof Array){if(!s(e[n],t[n]))return!1}else if(e[n]!==t[n])return!1;return!0};class i extends t{constructor(e,t={}){if(super(),this._destroyed=!1,this._path="",this._keys=[],this._data={},this._pathsWithDuplicates=null,this._parent=null,this._parentPath="",this._parentField=null,this._parentKey=null,this._latestFn=null,this._silent=!1,this._pathsWithDuplicates=null,t.pathsWithDuplicates){this._pathsWithDuplicates={};for(let e=0;e<t.pathsWithDuplicates.length;e++)this._pathsWithDuplicates[t.pathsWithDuplicates[e]]=!0}this.patch(e),this._parent=t.parent||null,this._parentPath=t.parentPath||"",this._parentField=t.parentField||null,this._parentKey=t.parentKey||null,this._latestFn=t.latestFn||null,this._silent=!1;const s=function(e){return function(t,s,i,n){if(!this._parent)return;let a,r=this._parentKey;!r&&this._parentField instanceof Array&&(r=this._parentField.indexOf(this),-1===r)||(t=`${this._parentPath}.${r}.${t}`,this._silent&&(a=this._parent.silence()),this._parent.emit(`${t}:${e}`,s,i,n),this._parent.emit(`*:${e}`,t,s,i,n),this._silent&&this._parent.silenceRestore(a))}};this.on("*:set",s("set")),this.on("*:unset",s("unset")),this.on("*:insert",s("insert")),this.on("*:remove",s("remove")),this.on("*:move",s("move"))}static _splitPath(e){const t=i._splitPathsCache;let s=t[e];return s?s=s.slice():(s=e.split("."),t[e]=s),s}silence(){this._silent=!0;const e=this.history&&this.history.enabled;e&&(this.history.enabled=!1);const t=this.sync&&this.sync.enabled;return t&&(this.sync.enabled=!1),[e,t]}silenceRestore(e){this._silent=!1,e[0]&&(this.history.enabled=!0),e[1]&&(this.sync.enabled=!0)}_prepare(e,t,s,n=!1,a=!1){let r,o;const l=(e._path?`${e._path}.`:"")+t,h=typeof s;if(e._keys.push(t),"object"===h&&s instanceof Array){for(e._data[t]=s.slice(0),r=0;r<e._data[t].length;r++)"object"==typeof e._data[t][r]&&null!==e._data[t][r]?e._data[t][r]instanceof Array?e._data[t][r].slice(0):e._data[t][r]=new i(e._data[t][r],{parent:this,parentPath:l,parentField:e._data[t],parentKey:null}):(o=this.silence(),this.emit(`${l}.${r}:set`,e._data[t][r],null,a),this.emit("*:set",`${l}.${r}`,e._data[t][r],null,a),this.silenceRestore(o));n&&(o=this.silence()),this.emit(`${l}:set`,e._data[t],null,a),this.emit("*:set",l,e._data[t],null,a),n&&this.silenceRestore(o)}else if("object"===h&&s instanceof Object){for(r in"object"!=typeof e._data[t]&&(e._data[t]={_path:l,_keys:[],_data:{}}),s)"object"==typeof s[r]?this._prepare(e._data[t],r,s[r],!0,a):(o=this.silence(),e._data[t]._data[r]=s[r],e._data[t]._keys.push(r),this.emit(`${l}.${r}:set`,s[r],null,a),this.emit("*:set",`${l}.${r}`,s[r],null,a),this.silenceRestore(o));n&&(o=this.silence()),this.emit(`${l}:set`,s,void 0,a),this.emit("*:set",l,s,void 0,a),n&&this.silenceRestore(o)}else n&&(o=this.silence()),e._data[t]=s,this.emit(`${l}:set`,s,void 0,a),this.emit("*:set",l,s,void 0,a),n&&this.silenceRestore(o);return!0}set(e,t,n=!1,a=!1,r=!1){let o,l,h=i._splitPath(e);const c=h.length,d=h[c-1];let u,p,m=this,f="",g=this;for(o=0;o<c-1;o++)m instanceof Array?(m=m[h[o]],m instanceof i&&(e=h.slice(o+1).join("."),g=m)):(o<c&&"object"!=typeof m._data[h[o]]&&(m._data[h[o]]&&g.unset((m._path?`${m._path}.`:"")+h[o]),m._data[h[o]]={_path:e,_keys:[],_data:{}},m._keys.push(h[o])),o===c-1&&m._path&&(f=`${m._path}.${h[o]}`),m=m._data[h[o]]);if(m instanceof Array){const s=parseInt(d,10);return!(m[s]===t&&!r)&&(l=m[s],l=l instanceof i?l.json():g.json(l),m[s]=t,t instanceof i&&(t._parent=g,t._parentPath=f,t._parentField=m,t._parentKey=null),n&&(u=g.silence()),g.emit(`${e}:set`,t,l,a),g.emit("*:set",e,t,l,a),n&&g.silenceRestore(u),!0)}if(m._data&&!m._data.hasOwnProperty(d))return"object"==typeof t?g._prepare(m,d,t,!1,a):(m._data[d]=t,m._keys.push(d),n&&(u=g.silence()),g.emit(`${e}:set`,t,null,a),g.emit("*:set",e,t,null,a),n&&g.silenceRestore(u),!0);if("object"==typeof t&&t instanceof Array){if(s(t,m._data[d])&&!r)return!1;if(l=m._data[d],l instanceof i||(l=g.json(l)),m._data[d]&&m._data[d].length===t.length){for(u=g.silence(),0===t.length&&(m._data[d]=t),o=0;o<m._data[d].length;o++)m._data[d][o]instanceof i?m._data[d][o].patch(t[o],!0):m._data[d][o]!==t[o]&&(m._data[d][o]=t[o],g.emit(`${e}.${o}:set`,m._data[d][o],l&&l[o]||null,a),g.emit("*:set",`${e}.${o}`,m._data[d][o],l&&l[o]||null,a));g.silenceRestore(u)}else{for(m._data[d]=[],t.forEach((e=>{this._doInsert(m,d,e,void 0,!0)})),u=g.silence(),o=0;o<m._data[d].length;o++)g.emit(`${e}.${o}:set`,m._data[d][o],l&&l[o]||null,a),g.emit("*:set",`${e}.${o}`,m._data[d][o],l&&l[o]||null,a);g.silenceRestore(u)}return n&&(u=g.silence()),g.emit(`${e}:set`,t,l,a),g.emit("*:set",e,t,l,a),n&&g.silenceRestore(u),!0}if("object"==typeof t&&t instanceof Object){let s,r=!1;l=m._data[d],l instanceof i||(l=g.json(l)),h=Object.keys(t),m._data[d]&&m._data[d]._data||(m._data[d]?g.unset((m._path?`${m._path}.`:"")+d):r=!0,m._data[d]={_path:e,_keys:[],_data:{}});for(const i in m._data[d]._data)t.hasOwnProperty(i)?m._data[d]._data.hasOwnProperty(i)?g._equals(m._data[d]._data[i],t[i])||(s=g.set(`${e}.${i}`,t[i],!0),s&&(r=!0)):(s=g._prepare(m._data[d],i,t[i],!0,a),s&&(r=!0)):(s=g.unset(`${e}.${i}`,!0),s&&(r=!0));for(o=0;o<h.length;o++)void 0===t[h[o]]&&m._data[d]._data.hasOwnProperty(h[o])?(s=g.unset(`${e}.${h[o]}`,!0),s&&(r=!0)):"object"==typeof t[h[o]]?m._data[d]._data.hasOwnProperty(h[o])?(s=g.set(`${e}.${h[o]}`,t[h[o]],!0),s&&(r=!0)):(s=g._prepare(m._data[d],h[o],t[h[o]],!0,a),s&&(r=!0)):g._equals(m._data[d]._data[h[o]],t[h[o]])||("object"==typeof t[h[o]]?(s=g.set(`${m._data[d]._path}.${h[o]}`,t[h[o]],!0),s&&(r=!0)):m._data[d]._data[h[o]]!==t[h[o]]&&(r=!0,-1===m._data[d]._keys.indexOf(h[o])&&m._data[d]._keys.push(h[o]),m._data[d]._data[h[o]]=t[h[o]],u=g.silence(),g.emit(`${m._data[d]._path}.${h[o]}:set`,m._data[d]._data[h[o]],null,a),g.emit("*:set",`${m._data[d]._path}.${h[o]}`,m._data[d]._data[h[o]],null,a),g.silenceRestore(u)));if(r){n&&(u=g.silence());const e=g.json(m._data[d]);return g.emit(`${m._data[d]._path}:set`,e,l,a),g.emit("*:set",m._data[d]._path,e,l,a),n&&g.silenceRestore(u),!0}return!1}return p=!m.hasOwnProperty("_data")&&m.hasOwnProperty(d)?m:m._data,!(p[d]===t&&!r)&&(n&&(u=g.silence()),l=p[d],l instanceof i||(l=g.json(l)),p[d]=t,g.emit(`${e}:set`,t,l,a),g.emit("*:set",e,t,l,a),n&&g.silenceRestore(u),!0)}has(e){const t=i._splitPath(e);let s=this;for(let e=0,i=t.length;e<i;e++){if(null==s)return;s=s._data?s._data[t[e]]:s[t[e]]}return void 0!==s}get(e,t=!1){const s=i._splitPath(e);let n=this;for(let e=0;e<s.length;e++){if(null==n)return;n=n._data?n._data[s[e]]:n[s[e]]}return t?n:null==n?null:this.json(n)}getRaw(e){return this.get(e,!0)}_equals(e,t){return e===t||!!(e instanceof Array&&t instanceof Array&&s(e,t))}unset(e,t=!1,s=!1){let n;const a=i._splitPath(e),r=a[a.length-1];let o=this,l=this;for(n=0;n<a.length-1;n++)o instanceof Array?(o=o[a[n]],o instanceof i&&(e=a.slice(n+1).join("."),l=o)):o=o._data[a[n]];if(!o._data||!o._data.hasOwnProperty(r))return!1;let h,c=o._data[r];if(c instanceof i||(c=l.json(c)),o._data[r]&&o._data[r]._data)for(n=o._data[r]._keys.length-1;n>=0;n--)l.unset(`${e}.${o._data[r]._keys[n]}`,!0);return o._keys.splice(o._keys.indexOf(r),1),delete o._data[r],t&&(h=l.silence()),l.emit(`${e}:unset`,c,s),l.emit("*:unset",e,c,s),t&&l.silenceRestore(h),!0}remove(e,t,s=!1,n=!1){const a=i._splitPath(e),r=a[a.length-1];let o=this,l=this;for(let t=0;t<a.length-1;t++)if(o instanceof Array)o=o[parseInt(a[t],10)],o instanceof i&&(e=a.slice(t+1).join("."),l=o);else{if(!o._data||!o._data.hasOwnProperty(a[t]))return!1;o=o._data[a[t]]}if(!(o._data&&o._data.hasOwnProperty(r)&&o._data[r]instanceof Array))return!1;const h=o._data[r];if(h.length<t)return!1;let c,d=h[t];return d instanceof i?d._parent=null:d=l.json(d),h.splice(t,1),s&&(c=l.silence()),l.emit(`${e}:remove`,d,t,n),l.emit("*:remove",e,d,t,n),s&&l.silenceRestore(c),!0}removeValue(e,t,s=!1,n=!1){const a=i._splitPath(e),r=a[a.length-1];let o=this,l=this;for(let t=0;t<a.length-1;t++)if(o instanceof Array)o=o[parseInt(a[t],10)],o instanceof i&&(e=a.slice(t+1).join("."),l=o);else{if(!o._data||!o._data.hasOwnProperty(a[t]))return;o=o._data[a[t]]}if(!(o._data&&o._data.hasOwnProperty(r)&&o._data[r]instanceof Array))return;const h=o._data[r],c=h.indexOf(t);if(-1===c)return;if(h.length<c)return;let d;return(t=h[c])instanceof i?t._parent=null:t=l.json(t),h.splice(c,1),s&&(d=l.silence()),l.emit(`${e}:remove`,t,c,n),l.emit("*:remove",e,t,c,n),s&&l.silenceRestore(d),!0}insert(e,t,s,n=!1,a=!1){const r=i._splitPath(e),o=r[r.length-1];let l=this,h=this;for(let t=0;t<r.length-1;t++)if(l instanceof Array)l=l[parseInt(r[t],10)],l instanceof i&&(e=r.slice(t+1).join("."),h=l);else{if(!l._data||!l._data.hasOwnProperty(r[t]))return;l=l._data[r[t]]}if(!(l._data&&l._data.hasOwnProperty(o)&&l._data[o]instanceof Array))return;const c=l._data[o];let d;return t=h._doInsert(l,o,t,s),void 0===s&&(s=c.length-1),n&&(d=h.silence()),h.emit(`${e}:insert`,t,s,a),h.emit("*:insert",e,t,s,a),n&&h.silenceRestore(d),!0}_doInsert(e,t,s,n,a=!1){const r=e._data[t];"object"!=typeof s||s instanceof i||null===s||(s=s instanceof Array?s.slice(0):new i(s));const o=e._path?`${e._path}.${t}`:t;if(null===s||a||this._pathsWithDuplicates&&this._pathsWithDuplicates[o]||-1===r.indexOf(s))return void 0===n?r.push(s):r.splice(n,0,s),s instanceof i?(s._parent=this,s._parentPath=o,s._parentField=r,s._parentKey=null):s=this.json(s),s}move(e,t,s,n=!1,a=!1){const r=i._splitPath(e),o=r[r.length-1];let l=this,h=this;for(let t=0;t<r.length-1;t++)if(l instanceof Array)l=l[parseInt(r[t],10)],l instanceof i&&(e=r.slice(t+1).join("."),h=l);else{if(!l._data||!l._data.hasOwnProperty(r[t]))return;l=l._data[r[t]]}if(!(l._data&&l._data.hasOwnProperty(o)&&l._data[o]instanceof Array))return;const c=l._data[o];if(c.length<t||c.length<s||t===s)return;let d,u=c[t];return c.splice(t,1),-1===s&&(s=c.length),c.splice(s,0,u),u instanceof i||(u=h.json(u)),n&&(d=h.silence()),h.emit(`${e}:move`,u,s,t,a),h.emit("*:move",e,u,s,t,a),n&&h.silenceRestore(d),!0}patch(e,t=!1){if("object"==typeof e){for(const t in e)"object"!=typeof e[t]||this._data.hasOwnProperty(t)?this._data[t]!==e[t]&&this.set(t,e[t]):this._prepare(this,t,e[t]);if(t)for(const t in this._data)e.hasOwnProperty(t)||this.unset(t)}}json(e){let t,s,i={};const n=void 0===e?this:e;let a,r;if(n instanceof Object&&n._keys){a=n._keys.length;for(let e=0;e<a;e++){t=n._keys[e];const a=n._data[t],o=typeof a;if("object"===o&&a instanceof Array)for(i[t]=a.slice(0),r=i[t].length,s=0;s<r;s++)"object"==typeof i[t][s]&&(i[t][s]=this.json(i[t][s]));else i[t]="object"===o&&a instanceof Object?this.json(a):a}}else{if(null===n)return null;if("object"==typeof n&&n instanceof Array)for(i=n.slice(0),a=i.length,s=0;s<a;s++)i[s]=this.json(i[s]);else if("object"==typeof n)for(t in n)n.hasOwnProperty(t)&&(i[t]=n[t]);else i=n}return i}forEach(e,t,s=""){const i=t||this;for(let t=0;t<i._keys.length;t++){const n=i._keys[t],a=i._data[n],r=this.schema&&this.schema.has(s+n)&&this.schema.get(s+n).type.name.toLowerCase()||typeof a;"object"===r&&a instanceof Array?e(s+n,"array",a,n):"object"===r&&a instanceof Object?(e(s+n,"object",a,n),this.forEach(e,a,`${s+n}.`)):e(s+n,r,a,n)}}latest(){return this._latestFn?this._latestFn():this}destroy(){this._destroyed||(this._destroyed=!0,this.emit("destroy"),this.unbind())}set latestFn(e){this._latestFn=e}get latestFn(){return this._latestFn}}i._splitPathsCache={};const n="pcui-collapsed",a="pcui-collapsible",r="pcui-disabled",o="pcui-error",l="flash",h="pcui-flex",c="pcui-focus",d="font-bold",u="pcui-grid",p="pcui-hidden",m="pcui-multiple-values",f="pcui-not-flexible",g="pcui-readonly",v="pcui-resizable",_="pcui-scrollable",y=["flexDirection","flexGrow","flexBasis","flexShrink","flexWrap","alignItems","alignSelf","justifyContent","justifySelf"];let x=class e extends t{constructor(e={}){var t,s,i,n;if(super(),this._destroyed=!1,this._parent=null,this._eventsParent=[],this._flashTimeout=null,this._suppressChange=!1,this._onMouseOver=e=>{this.emit("hover",e)},this._onMouseOut=e=>{this.emit("hoverend",e)},"string"==typeof e.dom?this._dom=document.createElement(e.dom):e.dom instanceof Node?this._dom=e.dom:this._dom=document.createElement("div"),void 0!==e.id&&(this._dom.id=e.id),this._dom.ui=this,this._onClickEvt=this._onClick.bind(this),this._dom.addEventListener("click",this._onClickEvt),this._dom.addEventListener("mouseover",this._onMouseOver),this._dom.addEventListener("mouseout",this._onMouseOut),this._dom.classList.add("pcui-element","font-regular"),e.class){const t=Array.isArray(e.class)?e.class:[e.class];for(const e of t)this._dom.classList.add(e)}this.enabled=null===(t=e.enabled)||void 0===t||t,this._hiddenParents=!e.isRoot,this.hidden=null!==(s=e.hidden)&&void 0!==s&&s,this.readOnly=null!==(i=e.readOnly)&&void 0!==i&&i,this.ignoreParent=null!==(n=e.ignoreParent)&&void 0!==n&&n,void 0!==e.width&&(this.width=e.width),void 0!==e.height&&(this.height=e.height),void 0!==e.tabIndex&&(this.tabIndex=e.tabIndex);for(const t in e)void 0!==e[t]&&-1!==y.indexOf(t)&&(this[t]=e[t]);e.binding&&(this.binding=e.binding)}destroy(){if(this._destroyed)return;if(this._destroyed=!0,this.binding?this.binding=null:this.unlink(),this.parent){const e=this.parent;for(const e of this._eventsParent)e.unbind();this._eventsParent.length=0,e.remove&&!e._destroyed&&e.remove(this),this._parent=null,!e._destroyed&&this._dom&&this._dom.parentElement&&this._dom.parentElement.removeChild(this._dom)}const e=this._dom;e&&(e.removeEventListener("click",this._onClickEvt),e.removeEventListener("mouseover",this._onMouseOver),e.removeEventListener("mouseout",this._onMouseOut),delete e.ui,this._dom=null),this._flashTimeout&&window.clearTimeout(this._flashTimeout),this.emit("destroy",e,this),this.unbind()}link(e,t){this._binding&&this._binding.link(e,t)}unlink(){this._binding&&this._binding.unlink()}flash(){this._flashTimeout||(this.class.add(l),this._flashTimeout=window.setTimeout((()=>{this._flashTimeout=null,this.class.remove(l)}),200))}_onClick(e){this.enabled&&this.emit("click",e)}_onHiddenToRootChange(e){this.emit(e?"hideToRoot":"showToRoot")}_onEnabledChange(e){e?this.class.remove(r):this.class.add(r),this.emit(e?"enable":"disable")}_onParentDestroy(){this.destroy()}_onParentDisable(){this._ignoreParent||this._enabled&&this._onEnabledChange(!1)}_onParentEnable(){this._ignoreParent||this._enabled&&this._onEnabledChange(!0)}_onParentShowToRoot(){const e=this.hiddenToRoot;this._hiddenParents=!1,e!==this.hiddenToRoot&&this._onHiddenToRootChange(this.hiddenToRoot)}_onParentHideToRoot(){const e=this.hiddenToRoot;this._hiddenParents=!0,e!==this.hiddenToRoot&&this._onHiddenToRootChange(this.hiddenToRoot)}_onReadOnlyChange(e){e?this.class.add(g):this.class.remove(g),this.emit("readOnly",e)}_onParentReadOnlyChange(e){this._ignoreParent||(e?this._readOnly||this._onReadOnlyChange(!0):this._readOnly||this._onReadOnlyChange(!1))}static register(t,s,i){e.registry.set(t,{cls:s,defaultArguments:i})}static unregister(t){e.registry.delete(t)}static create(t,s){const i=e.registry.get(t);if(!i)return void console.error("Invalid type passed to Element.create:",t);return new(0,i.cls)(Object.assign(Object.assign({},i.defaultArguments),s))}set enabled(e){if(this._enabled===e)return;const t=this.enabled;this._enabled=e,t!==e&&this._onEnabledChange(e)}get enabled(){return this._ignoreParent?this._enabled:this._enabled&&(!this._parent||this._parent.enabled)}set ignoreParent(e){this._ignoreParent=e,this._onEnabledChange(this.enabled),this._onReadOnlyChange(this.readOnly)}get ignoreParent(){return this._ignoreParent}get dom(){return this._dom}set parent(e){if(e===this._parent)return;const t=this.enabled,s=this.readOnly,i=this.hiddenToRoot;if(this._parent){for(let e=0;e<this._eventsParent.length;e++)this._eventsParent[e].unbind();this._eventsParent.length=0}this._parent=e,this._parent?(this._eventsParent.push(this._parent.once("destroy",this._onParentDestroy.bind(this))),this._eventsParent.push(this._parent.on("disable",this._onParentDisable.bind(this))),this._eventsParent.push(this._parent.on("enable",this._onParentEnable.bind(this))),this._eventsParent.push(this._parent.on("readOnly",this._onParentReadOnlyChange.bind(this))),this._eventsParent.push(this._parent.on("showToRoot",this._onParentShowToRoot.bind(this))),this._eventsParent.push(this._parent.on("hideToRoot",this._onParentHideToRoot.bind(this))),this._hiddenParents=this._parent.hiddenToRoot):this._hiddenParents=!0,this.emit("parent",this._parent);const n=this.enabled;n!==t&&this._onEnabledChange(n);const a=this.readOnly;a!==s&&this._onReadOnlyChange(a);const r=this.hiddenToRoot;r!==i&&this._onHiddenToRootChange(r)}get parent(){return this._parent}set hidden(e){if(e===this._hidden)return;const t=this.hiddenToRoot;this._hidden=e,e?this.class.add(p):this.class.remove(p),this.emit(e?"hide":"show"),this.hiddenToRoot!==t&&this._onHiddenToRootChange(this.hiddenToRoot)}get hidden(){return this._hidden}get hiddenToRoot(){return this._hidden||this._hiddenParents}set readOnly(e){this._readOnly!==e&&(this._readOnly=e,this._onReadOnlyChange(e))}get readOnly(){return this._ignoreParent?this._readOnly:this._readOnly||!(!this._parent||!this._parent.readOnly)}set error(e){this._hasError!==e&&(this._hasError=e,e?this.class.add(o):this.class.remove(o))}get error(){return this._hasError}get style(){return this._dom.style}get class(){return this._dom.classList}set width(e){this.style.width="number"==typeof e?`${e}px`:e}get width(){return this._dom.clientWidth}set height(e){this.style.height="number"==typeof e?`${e}px`:e}get height(){return this._dom.clientHeight}set tabIndex(e){this._dom.tabIndex=e}get tabIndex(){return this._dom.tabIndex}set binding(e){if(this._binding===e)return;let t,s;this._binding&&(t=this._binding.observers,s=this._binding.paths,this.unlink(),this._binding.element=null,this._binding=null),this._binding=e,this._binding&&(this._binding.element=this,t&&s&&this.link(t,s))}get binding(){return this._binding}get destroyed(){return this._destroyed}set flexDirection(e){this.style.flexDirection=e}get flexDirection(){return this.style.flexDirection}set flexGrow(e){this.style.flexGrow=e}get flexGrow(){return this.style.flexGrow}set flexBasis(e){this.style.flexBasis=e}get flexBasis(){return this.style.flexBasis}set flexShrink(e){this.style.flexShrink=e}get flexShrink(){return this.style.flexShrink}set flexWrap(e){this.style.flexWrap=e}get flexWrap(){return this.style.flexWrap}set alignItems(e){this.style.alignItems=e}get alignItems(){return this.style.alignItems}set alignSelf(e){this.style.alignSelf=e}get alignSelf(){return this.style.alignSelf}set justifyContent(e){this.style.justifyContent=e}get justifyContent(){return this.style.justifyContent}set justifySelf(e){this.style.justifySelf=e}get justifySelf(){return this.style.justifySelf}set disabled(e){this.enabled=!e}get disabled(){return!this.enabled}set element(e){this._dom=e}get element(){return this.dom}set innerElement(e){this._domContent=e}get innerElement(){return this._domContent}};x.EVENT_ENABLE="enable",x.EVENT_DISABLE="disable",x.EVENT_HIDE="hide",x.EVENT_HIDE_TO_ROOT="hideToRoot",x.EVENT_SHOW="show",x.EVENT_SHOW_TO_ROOT="showToRoot",x.EVENT_READ_ONLY="readOnly",x.EVENT_PARENT="parent",x.EVENT_CLICK="click",x.EVENT_HOVER="hover",x.EVENT_HOVER_END="hoverend",x.EVENT_DESTROY="destroy",x.registry=new Map;class w extends x{constructor(e={}){super(Object.assign({dom:"button"},e)),this._onKeyDown=e=>{"Escape"===e.key?this.blur():"Enter"===e.key&&this._onClick(e)},this.class.add("pcui-button"),this._unsafe=e.unsafe,this.text=e.text,this.size=e.size,this.icon=e.icon,this.dom.addEventListener("keydown",this._onKeyDown)}destroy(){this._destroyed||(this.dom.removeEventListener("keydown",this._onKeyDown),super.destroy())}_onClick(e){this.blur(),this.readOnly||super._onClick(e)}focus(){this.dom.focus()}blur(){this.dom.blur()}set text(e){this._text!==e&&(this._text=e,this._unsafe?this.dom.innerHTML=e:this.dom.textContent=e)}get text(){return this._text}set icon(e){this._icon!==e&&e.match(/^E\d{0,4}$/)&&(this._icon=e,e?this.dom.setAttribute("data-icon",String.fromCodePoint(parseInt(e,16))):this.dom.removeAttribute("data-icon"))}get icon(){return this._icon}set size(e){this._size!==e&&(this._size&&(this.class.remove(`pcui-${this._size}`),this._size=null),this._size=e,this._size&&this.class.add(`pcui-${this._size}`))}get size(){return this._size}}x.register("button",w);const b=[null,"top","right","bottom","left"],C=`${v}-resizing`,S="pcui-container",A=`${S}-dragged`,T=`${A}-child`;class P extends x{constructor(e={}){var t;super(e),this._scrollable=!1,this._flex=!1,this._grid=!1,this._domResizeHandle=null,this._resizePointerId=null,this._resizeData=null,this._resizeHorizontally=!0,this._resizeMin=100,this._resizeMax=300,this._draggedStartIndex=-1,this._onScroll=e=>{this.emit("scroll",e)},this._onResizeStart=e=>{null===this._resizePointerId&&(e.preventDefault(),e.stopPropagation(),this._domResizeHandle.setPointerCapture(e.pointerId),this._resizePointerId=e.pointerId,this._resizeStart())},this._onResizeMove=e=>{this._resizePointerId===e.pointerId&&(e.preventDefault(),e.stopPropagation(),this._resizeMove(e.clientX,e.clientY))},this._onResizeEnd=e=>{this._resizePointerId===e.pointerId&&(e.preventDefault(),e.stopPropagation(),this._resizeEnd(),this._domResizeHandle.releasePointerCapture(e.pointerId),this._resizePointerId=null)},this.class.add(S),this.domContent=this._dom,e.scrollable&&(this.scrollable=!0),this.flex=!!e.flex;let s=!!e.grid;s&&this.flex&&(console.error('Invalid Container arguments: "grid" and "flex" cannot both be true.'),s=!1),this.grid=s,this.resizable=null!==(t=e.resizable)&&void 0!==t?t:null,void 0!==e.resizeMin&&(this.resizeMin=e.resizeMin),void 0!==e.resizeMax&&(this.resizeMax=e.resizeMax)}destroy(){this._destroyed||(this.domContent=null,this._domResizeHandle&&(this._domResizeHandle.removeEventListener("pointerdown",this._onResizeStart),this._domResizeHandle.removeEventListener("pointermove",this._onResizeMove),this._domResizeHandle.removeEventListener("pointerup",this._onResizeEnd)),super.destroy())}append(e){const t=this._getDomFromElement(e);this._domContent.appendChild(t),this._onAppendChild(e)}appendBefore(e,t){const s=this._getDomFromElement(e);this._domContent.appendChild(s);const i=t&&this._getDomFromElement(t);this._domContent.insertBefore(s,i),this._onAppendChild(e)}appendAfter(e,t){const s=this._getDomFromElement(e),i=t&&this._getDomFromElement(t),n=i?i.nextSibling:null;n?this._domContent.insertBefore(s,n):this._domContent.appendChild(s),this._onAppendChild(e)}prepend(e){const t=this._getDomFromElement(e),s=this._domContent.firstChild;s?this._domContent.insertBefore(t,s):this._domContent.appendChild(t),this._onAppendChild(e)}remove(e){if(e.parent!==this)return;const t=this._getDomFromElement(e);this._domContent.removeChild(t),this._onRemoveChild(e)}move(e,t){const s=Array.prototype.indexOf.call(this.dom.childNodes,e.dom);-1===s?this.appendBefore(e,this.dom.childNodes[t]):t!==s&&(this.remove(e),t<s?this.appendBefore(e,this.dom.childNodes[t]):this.appendAfter(e,this.dom.childNodes[t-1]))}clear(){let e=this._domContent.childNodes.length;for(;e--;){const t=this._domContent.childNodes[e];t.ui&&t.ui!==this&&t.ui.destroy()}this._domResizeHandle&&(this._domResizeHandle.removeEventListener("pointerdown",this._onResizeStart),this._domResizeHandle.removeEventListener("pointermove",this._onResizeMove),this._domResizeHandle.removeEventListener("pointerup",this._onResizeEnd),this._domResizeHandle=null),this._domContent.innerHTML="",this.resizable&&(this._createResizeHandle(),this._dom.appendChild(this._domResizeHandle))}_getDomFromElement(e){return e.dom?e.dom:e.element?e.element:e}_onAppendChild(e){e.parent=this,this.emit("append",e)}_onRemoveChild(e){e.parent=null,this.emit("remove",e)}_createResizeHandle(){const e=document.createElement("div");e.classList.add("pcui-resizable-handle"),e.ui=this,e.addEventListener("pointerdown",this._onResizeStart),e.addEventListener("pointermove",this._onResizeMove),e.addEventListener("pointerup",this._onResizeEnd),this._domResizeHandle=e}_resizeStart(){this.class.add(C)}_resizeMove(e,t){if(this._resizeData){if(this._resizeHorizontally){let t=this._resizeData.x-e;"right"===this._resizable&&(t=-t),this.width=4+Math.max(this._resizeMin,Math.min(this._resizeMax,this._resizeData.width+t))}else{let e=this._resizeData.y-t;"bottom"===this._resizable&&(e=-e),this.height=Math.max(this._resizeMin,Math.min(this._resizeMax,this._resizeData.height+e))}this.emit("resize")}else this._resizeData={x:e,y:t,width:this.dom.clientWidth,height:this.dom.clientHeight}}_resizeEnd(){this._resizeData=null,this.class.remove(C)}resize(e=0,t=0){this._resizeStart(),this._resizeMove(0,0),this._resizeMove(4-e,-t),this._resizeEnd()}_getDraggedChildIndex(e){for(let t=0;t<this.dom.childNodes.length;t++)if(this.dom.childNodes[t].ui===e)return t;return-1}_onChildDragStart(e,t){this.class.add(T),this._draggedStartIndex=this._getDraggedChildIndex(t),t.class.add(A),this.emit("child:dragstart",t,this._draggedStartIndex)}_onChildDragMove(e,t){const s=this.dom.getBoundingClientRect(),i=e.clientX<s.left||e.clientX>s.right||e.clientY<s.top||e.clientY>s.bottom,n=this._getDraggedChildIndex(t);if(i)return t.class.remove(A),void(this._draggedStartIndex!==n&&(this.remove(t),this._draggedStartIndex<n?this.appendBefore(t,this.dom.childNodes[this._draggedStartIndex]):this.appendAfter(t,this.dom.childNodes[this._draggedStartIndex-1])));t.class.add(A);const a=e.clientY-s.top;let r=null;for(let e=0;e<this.dom.childNodes.length;e++){const s=this.dom.childNodes[e].ui,i=s.dom.offsetTop;if(e<n){if(a<=i+s.header.height){r=e;break}}else if(e>n&&a+t.height>=i+s.height){r=e;break}}null!==r&&n!==r&&(this.remove(t),r<n?this.appendBefore(t,this.dom.childNodes[r]):this.appendAfter(t,this.dom.childNodes[r-1]))}_onChildDragEnd(e,t){this.class.remove(T),t.class.remove(A);const s=this._getDraggedChildIndex(t);this.emit("child:dragend",t,s,this._draggedStartIndex),this._draggedStartIndex=-1}forEachChild(e){for(let t=0;t<this.dom.childNodes.length;t++){const s=this.dom.childNodes[t].ui;if(s){if(!1===e(s,t))break}}}_buildDomNode(e){const t=Object.keys(e);let s;return t.includes("root")?(s=this._buildDomNode(e.root),e.children.forEach((e=>{const t=this._buildDomNode(e);null!==t&&s.append(t)}))):(s=e[t[0]],this[`_${t[0]}`]=s),s}buildDom(e){e.forEach((e=>{const t=this._buildDomNode(e);this.append(t)}))}set flex(e){e!==this._flex&&(this._flex=e,e?this.class.add(h):this.class.remove(h))}get flex(){return this._flex}set grid(e){e!==this._grid&&(this._grid=e,e?this.class.add(u):this.class.remove(u))}get grid(){return this._grid}set scrollable(e){this._scrollable!==e&&(this._scrollable=e,e?this.class.add(_):this.class.remove(_))}get scrollable(){return this._scrollable}set resizable(e){e!==this._resizable&&(-1!==b.indexOf(e)?(this._resizable&&this.class.remove(`${v}-${this._resizable}`),this._resizable=e,this._resizeHorizontally="right"===e||"left"===e,e?(this.class.add(v),this.class.add(`${v}-${e}`),this._domResizeHandle||this._createResizeHandle(),this._dom.appendChild(this._domResizeHandle)):(this.class.remove(v),this._domResizeHandle&&this._dom.removeChild(this._domResizeHandle))):console.error(`Invalid resizable value: must be one of ${b.join(",")}`))}get resizable(){return this._resizable}set resizeMin(e){this._resizeMin=Math.max(0,Math.min(e,this._resizeMax))}get resizeMin(){return this._resizeMin}set resizeMax(e){this._resizeMax=Math.max(this._resizeMin,e)}get resizeMax(){return this._resizeMax}set domContent(e){this._domContent!==e&&(this._domContent&&this._domContent.removeEventListener("scroll",this._onScroll),this._domContent=e,this._domContent&&this._domContent.addEventListener("scroll",this._onScroll))}get domContent(){return this._domContent}}P.EVENT_APPEND="append",P.EVENT_REMOVE="remove",P.EVENT_SCROLL="scroll",P.EVENT_RESIZE="resize",x.register("container",P);class E extends x{constructor(e={}){var t,s,i,n,a;super(e),this.blurOnEnter=!0,this.blurOnEscape=!0,this._onInputFocus=e=>{this.class.add(c),this.emit("focus",e),this._prevValue=this._domInput.value},this._onInputBlur=e=>{this.class.remove(c),this.emit("blur",e)},this._onInputKeyUp=e=>{"Escape"!==e.key&&this._onInputChange(e),this.emit("keyup",e)},this._onInputCtxMenu=e=>{this._domInput.select()},this._updateInputReadOnly=()=>{!this.enabled||this.readOnly?this._domInput.setAttribute("readonly","true"):this._domInput.removeAttribute("readonly")},this.class.add("pcui-input-element");let r=e.input;r||(r=document.createElement("input"),r.type="text"),r.ui=this,r.tabIndex=0,r.autocomplete="off",this._onInputKeyDownEvt=this._onInputKeyDown.bind(this),this._onInputChangeEvt=this._onInputChange.bind(this),r.addEventListener("change",this._onInputChangeEvt),r.addEventListener("keydown",this._onInputKeyDownEvt),r.addEventListener("focus",this._onInputFocus),r.addEventListener("blur",this._onInputBlur),r.addEventListener("contextmenu",this._onInputCtxMenu,!1),this.dom.appendChild(r),this._domInput=r,this._suspendInputChangeEvt=!1,void 0!==e.value&&(this._domInput.value=e.value),this.placeholder=null!==(t=e.placeholder)&&void 0!==t?t:"",this.renderChanges=null!==(s=e.renderChanges)&&void 0!==s&&s,this.blurOnEnter=null===(i=e.blurOnEnter)||void 0===i||i,this.blurOnEscape=null===(n=e.blurOnEscape)||void 0===n||n,this.keyChange=null!==(a=e.keyChange)&&void 0!==a&&a,this._prevValue=null,this.on("change",(()=>{this.renderChanges&&this.flash()})),this.on("disable",this._updateInputReadOnly),this.on("enable",this._updateInputReadOnly),this.on("readOnly",this._updateInputReadOnly),this._updateInputReadOnly()}destroy(){if(this._destroyed)return;const e=this._domInput;e.removeEventListener("change",this._onInputChangeEvt),e.removeEventListener("keydown",this._onInputKeyDownEvt),e.removeEventListener("focus",this._onInputFocus),e.removeEventListener("blur",this._onInputBlur),e.removeEventListener("keyup",this._onInputKeyUp),e.removeEventListener("contextmenu",this._onInputCtxMenu),super.destroy()}_onInputKeyDown(e){if("Enter"===e.key&&this.blurOnEnter)this._suspendInputChangeEvt=this.keyChange,this._domInput.blur(),this._suspendInputChangeEvt=!1;else if("Escape"===e.key){this._suspendInputChangeEvt=!0;const t=this._domInput.value;this._domInput.value=this._prevValue,this._suspendInputChangeEvt=!1,this.keyChange&&t!==this._prevValue&&this._onInputChange(e),this.blurOnEscape&&this._domInput.blur()}this.emit("keydown",e)}_onInputChange(e){}focus(e){this._domInput.focus(),e&&this._domInput.select()}blur(){this._domInput.blur()}set placeholder(e){e?this.dom.setAttribute("placeholder",e):this.dom.removeAttribute("placeholder")}get placeholder(){var e;return null!==(e=this.dom.getAttribute("placeholder"))&&void 0!==e?e:""}set keyChange(e){this._keyChange!==e&&(this._keyChange=e,e?this._domInput.addEventListener("keyup",this._onInputKeyUp):this._domInput.removeEventListener("keyup",this._onInputKeyUp))}get keyChange(){return this._keyChange}get input(){return this._domInput}set renderChanges(e){this._renderChanges=e}get renderChanges(){return this._renderChanges}}const k="pcui-numeric-input",M=`${k}-slider-control`,I=`${M}-active`,D=`${M}-hidden`,R=/,/g;class L extends E{constructor(e={}){var t,s,i,n;const a=Object.assign({},e);delete a.value,delete a.renderChanges,super(a),this._sliderUsed=!1,this._onSliderMouseWheel=e=>{this._updatePosition(e.deltaY,e.shiftKey)},this._onSliderMouseMove=e=>{this._updatePosition(e.movementX,e.shiftKey)},this._onSliderMouseDown=e=>{this._sliderControl.dom.requestPointerLock(),this._sliderMovement=0,this._sliderPrevValue=this.value,this._sliderUsed=!0,this.binding&&(this._historyCombine=this.binding.historyCombine,this._historyPostfix=this.binding.historyPostfix,this.binding.historyCombine=!0,this.binding.historyPostfix=`(${Date.now()})`),this.emit("slider:mousedown",e)},this._onSliderMouseUp=()=>{document.exitPointerLock(),this._sliderUsed&&(this._sliderUsed=!1,this.value=this._sliderPrevValue+this._sliderMovement,this.binding&&(this.binding.historyCombine=this._historyCombine,this.binding.historyPostfix=this._historyPostfix,this._historyCombine=!1,this._historyPostfix=null),this.focus(),this.emit("slider:mouseup"))},this._onPointerLockChange=()=>{this._isScrolling()?(this._sliderControl.dom.addEventListener("mousemove",this._onSliderMouseMove,!1),this._sliderControl.dom.addEventListener("wheel",this._onSliderMouseWheel,{passive:!0}),this._sliderControl.class.add(I)):(this._sliderControl.dom.removeEventListener("mousemove",this._onSliderMouseMove,!1),this._sliderControl.dom.removeEventListener("wheel",this._onSliderMouseWheel),this._sliderControl.class.remove(I))},this.class.add(k),this._min=null!==(t=e.min)&&void 0!==t?t:null,this._max=null!==(s=e.max)&&void 0!==s?s:null,this._allowNull=null!==(i=e.allowNull)&&void 0!==i&&i,this._precision=null!==(n=e.precision)&&void 0!==n?n:7,Number.isFinite(e.step)?this._step=e.step:e.precision?this._step=10/Math.pow(10,e.precision):this._step=1,Number.isFinite(e.stepPrecision)?this._stepPrecision=e.stepPrecision:this._stepPrecision=.1*this._step,this._oldValue=void 0,Number.isFinite(e.value)?this.value=e.value:this._allowNull||(this.value=0),this._historyCombine=!1,this._historyPostfix=null,this._sliderPrevValue=0,this.renderChanges=e.renderChanges,e.hideSlider||(this._sliderControl=new x,this._sliderControl.class.add(M),this.dom.append(this._sliderControl.dom),this._sliderControl.dom.addEventListener("mousedown",this._onSliderMouseDown),this._sliderControl.dom.addEventListener("mouseup",this._onSliderMouseUp),document.addEventListener("pointerlockchange",this._onPointerLockChange,!1))}destroy(){this.destroyed||(this._sliderControl&&(this._sliderControl.dom.removeEventListener("mousedown",this._onSliderMouseDown),this._sliderControl.dom.removeEventListener("mouseup",this._onSliderMouseUp),this._sliderControl.dom.removeEventListener("mousemove",this._onSliderMouseMove,!1),this._sliderControl.dom.removeEventListener("wheel",this._onSliderMouseWheel),document.removeEventListener("pointerlockchange",this._onPointerLockChange,!1)),super.destroy())}_updatePosition(e,t){this._sliderMovement+=e/100*(t?this._stepPrecision:this._step),this.value=this._sliderPrevValue+this._sliderMovement}_onInputChange(e){this.value=this._normalizeValue(this._domInput.value)}_onInputKeyDown(e){if(this.enabled&&!this.readOnly){if("ArrowUp"===e.key||"ArrowDown"===e.key){const t="ArrowDown"===e.key?-1:1;this.value+=(e.shiftKey?this._stepPrecision:this._step)*t}super._onInputKeyDown(e)}}_getPointerLockElementByShadowRoot(e){const t=e.shadowRoot;if(t){const e=t.pointerLockElement;return this._getPointerLockElementByShadowRoot(e)}return e===this._sliderControl.dom}_isScrolling(){return!!this._sliderControl&&(document.pointerLockElement&&document.pointerLockElement.shadowRoot?this._getPointerLockElementByShadowRoot(document.pointerLockElement):document.pointerLockElement===this._sliderControl.dom)}_normalizeValue(e){try{if("string"==typeof e){if("0"===e)return 0;if(null!==(e=(e=(e=e.replace(R,".")).replace(/\s/g,"")).match(/^[*/+\-0-9().]+$/))&&e[0].length<20){let t=e[0];["+","-","/","*"].forEach((e=>{const s=t.split(e);s.forEach(((e,t)=>{s[t]=s[t].replace(/^0+/,"")})),t=s.join(e)})),e=Function(`"use strict";return (${t})`)()}}if(null==e||""===e){if(this._allowNull)return null;e=0}if(e=Number(e),isNaN(e)){if(this._allowNull)return null;e=0}return null!==this.min&&e<this.min&&(e=this.min),null!==this.max&&e>this.max&&(e=this.max),null!==this.precision&&(e=parseFloat(Number(e).toFixed(this.precision))),e}catch(e){return this._allowNull?null:0}}_updateValue(e,t){const s=e!==this._oldValue||t;return this._oldValue=e,this._domInput.value=null===e?"":String(e),this.class.remove(m),s&&this.emit("change",e),s}set value(e){e=this._normalizeValue(e);const t=this.class.contains(m)&&null===e&&this._allowNull;this._updateValue(e,t)&&this.binding&&this.binding.setValue(e),this._sliderControl&&this._sliderControl.class.remove(D)}get value(){const e=this._domInput.value;return""!==e?parseFloat(e):null}set values(e){const t=e.map((e=>this._normalizeValue(e))),s=t.some((e=>e!==t[0]));s?(this._updateValue(null),this.class.add(m),this._sliderControl&&this._sliderControl.class.add(D)):(this._updateValue(t[0]),this._sliderControl&&this._sliderControl.class.remove(D))}set min(e){this._min!==e&&(this._min=e,null!==this._min&&(this.value=this.value))}get min(){return this._min}set max(e){this._max!==e&&(this._max=e,null!==this._max&&(this.value=this.value))}get max(){return this._max}set precision(e){this._precision!==e&&(this._precision=e,null!==this._precision&&(this.value=this.value))}get precision(){return this._precision}set step(e){this._step=e}get step(){return this._step}}x.register("number",L,{renderChanges:!0});class F extends x{constructor(e={}){var t,s,i;super(Object.assign({dom:"span"},e)),this.class.add("pcui-label"),this._unsafe=null!==(t=e.unsafe)&&void 0!==t&&t,this.text=null!==(i=null!==(s=e.text)&&void 0!==s?s:e.value)&&void 0!==i?i:"",e.allowTextSelection&&this.class.add("pcui-default-mousedown"),e.nativeTooltip&&(this.dom.title=this.text),this.placeholder=e.placeholder,this.renderChanges=e.renderChanges,this.on("change",(()=>{this.renderChanges&&this.flash()}))}_updateText(e){return this.class.remove(m),this._text!==e&&(this._text=e,this._unsafe?this._dom.innerHTML=e:this._dom.textContent=e,this.emit("change",e),!0)}set text(e){null==e&&(e="");this._updateText(e)&&this._binding&&this._binding.setValue(e)}get text(){return this._text}set value(e){this.text=e}get value(){return this.text}set values(e){const t=e.some((t=>t!==e[0]));t?(this._updateText(""),this.class.add(m)):this._updateText(e[0])}set placeholder(e){e?this.dom.setAttribute("placeholder",e):this.dom.removeAttribute("placeholder")}get placeholder(){return this.dom.getAttribute("placeholder")}set renderChanges(e){this._renderChanges=e}get renderChanges(){return this._renderChanges}}x.register("label",F);const B="pcui-panel",O=`${B}-header`,z=`${O}-title`,V=`${B}-content`,N=`${B}-horizontal`,U=`${B}-sortable-icon`,H=`${B}-remove`;class G extends P{constructor(e={}){var t,s,i,n,a;const r=Object.assign(Object.assign({},e),{flex:!0});delete r.grid,delete r.flexDirection,delete r.scrollable,super(r),this._reflowTimeout=null,this._widthBeforeCollapse=null,this._heightBeforeCollapse=null,this._iconSort=null,this._btnRemove=null,this._onHeaderClick=e=>{this._collapsible&&(e.target!==this.header.dom&&e.target!==this._labelTitle.dom||(this.collapsed=!this.collapsed))},this._onDragStart=e=>{this.enabled&&!this.readOnly&&(e.stopPropagation(),e.preventDefault(),window.addEventListener("mouseup",this._onDragEndEvt),window.addEventListener("mouseleave",this._onDragEndEvt),window.addEventListener("mousemove",this._onDragMove),this.emit("dragstart"),this.parent&&this.parent._onChildDragStart&&this.parent._onChildDragStart(e,this))},this._onDragMove=e=>{this.emit("dragmove"),this.parent&&this.parent._onChildDragStart&&this.parent._onChildDragMove(e,this)},this.class.add(B),e.panelType&&this.class.add(`${B}-${e.panelType}`),this._suspendReflow=!0,this._initializeHeader(e),this._initializeContent(e),this.headerSize=null!==(t=e.headerSize)&&void 0!==t?t:32,this.collapsible=null!==(s=e.collapsible)&&void 0!==s&&s,this.collapsed=null!==(i=e.collapsed)&&void 0!==i&&i,this.collapseHorizontally=null!==(n=e.collapseHorizontally)&&void 0!==n&&n,this.sortable=null!==(a=e.sortable)&&void 0!==a&&a,this.removable=e.removable||!!e.onRemove||!1,this.domContent=this._containerContent.dom,this._suspendReflow=!1,this._reflow(),this._onDragEndEvt=this._onDragEnd.bind(this)}destroy(){this._destroyed||(this._reflowTimeout&&(cancelAnimationFrame(this._reflowTimeout),this._reflowTimeout=null),window.removeEventListener("mouseup",this._onDragEndEvt),window.removeEventListener("mouseleave",this._onDragEndEvt),window.removeEventListener("mousemove",this._onDragMove),super.destroy())}_initializeHeader(e){this._containerHeader=new P({flex:!0,flexDirection:"row",class:[O,d]}),this._labelTitle=new F({text:e.headerText,class:[z,d]}),this._containerHeader.append(this._labelTitle),this._containerHeader.dom.addEventListener("click",this._onHeaderClick),this.append(this._containerHeader)}_onClickRemove(e){e.preventDefault(),e.stopPropagation(),this.emit("click:remove")}_initializeContent(e){this._containerContent=new P({class:V,grid:e.grid,flex:e.flex,flexDirection:e.flexDirection,scrollable:e.scrollable,dom:e.content}),this.append(this._containerContent)}_reflow(){this._suspendReflow||(this._reflowTimeout&&(cancelAnimationFrame(this._reflowTimeout),this._reflowTimeout=null),!this.hidden&&this.collapsible&&(this.collapsed&&this.collapseHorizontally?this._containerHeader.style.top=-this.headerSize+"px":this._containerHeader.style.top="",this._reflowTimeout=requestAnimationFrame((()=>{this._reflowTimeout=null,this.collapsed?(this._widthBeforeCollapse||(this._widthBeforeCollapse=this.style.width),this._heightBeforeCollapse||(this._heightBeforeCollapse=this.style.height),this._collapseHorizontally?(this.height="",this.width=this.headerSize):this.height=this.headerSize,this.class.add(n)):(this.class.remove(n),this._collapseHorizontally?(this.height="",null!==this._widthBeforeCollapse&&(this.width=this._widthBeforeCollapse)):null!==this._heightBeforeCollapse&&(this.height=this._heightBeforeCollapse),this._widthBeforeCollapse=null,this._heightBeforeCollapse=null)}))))}_onDragEnd(e){window.removeEventListener("mouseup",this._onDragEndEvt),window.removeEventListener("mouseleave",this._onDragEndEvt),window.removeEventListener("mousemove",this._onDragMove),this._draggedChild===this&&(this._draggedChild=null),this.emit("dragend"),this.parent&&this.parent._onChildDragStart&&this.parent._onChildDragEnd(e,this)}set collapsible(e){e!==this._collapsible&&(this._collapsible=e,e?this.class.add(a):this.class.remove(a),this._reflow(),this.collapsed&&this.emit(e?"collapse":"expand"))}get collapsible(){return this._collapsible}set collapsed(e){this._collapsed!==e&&(this._collapsed=e,this._reflow(),this.collapsible&&this.emit(e?"collapse":"expand"))}get collapsed(){return this._collapsed}set sortable(e){this._sortable!==e&&(this._sortable=e,e?(this._iconSort=new F({class:U}),this._iconSort.dom.addEventListener("mousedown",this._onDragStart),this.header.prepend(this._iconSort)):this._iconSort&&(this._iconSort.destroy(),this._iconSort=null))}get sortable(){return this._sortable}set removable(e){this.removable!==e&&(e?(this._btnRemove=new w({icon:"E289",class:H}),this._btnRemove.on("click",this._onClickRemove.bind(this)),this.header.append(this._btnRemove)):(this._btnRemove.destroy(),this._btnRemove=null))}get removable(){return!!this._btnRemove}set collapseHorizontally(e){this._collapseHorizontally!==e&&(this._collapseHorizontally=e,e?this.class.add(N):this.class.remove(N),this._reflow())}get collapseHorizontally(){return this._collapseHorizontally}get content(){return this._containerContent}get header(){return this._containerHeader}set headerText(e){this._labelTitle.text=e}get headerText(){return this._labelTitle.text}set headerSize(e){this._headerSize=e;const t=this._containerHeader.dom.style;t.height=`${Math.max(0,e)}px`,t.lineHeight=t.height,this._reflow()}get headerSize(){return this._headerSize}}G.EVENT_COLLAPSE="collapse",G.EVENT_EXPAND="expand",x.register("panel",G);const W="pcui-boolean-input",j=`${W}-ticked`,q=`${W}-toggle`;class X extends x{constructor(e={}){var t;super(Object.assign({tabIndex:0},e)),this._onKeyDown=e=>{"Escape"!==e.key?this.enabled&&!this.readOnly&&" "===e.key&&(e.stopPropagation(),e.preventDefault(),this.value=!this.value):this.blur()},this._onFocus=()=>{this.emit("focus")},this._onBlur=()=>{this.emit("blur")},"toggle"===e.type?this.class.add(q):this.class.add(W),this.class.add(f),this.dom.addEventListener("keydown",this._onKeyDown),this.dom.addEventListener("focus",this._onFocus),this.dom.addEventListener("blur",this._onBlur),this._value=null,void 0!==e.value&&(this.value=e.value),this.renderChanges=null!==(t=e.renderChanges)&&void 0!==t&&t}destroy(){this._destroyed||(this.dom.removeEventListener("keydown",this._onKeyDown),this.dom.removeEventListener("focus",this._onFocus),this.dom.removeEventListener("blur",this._onBlur),super.destroy())}_onClick(e){return this.enabled&&this.focus(),this.enabled&&!this.readOnly&&(this.value=!this.value),super._onClick(e)}_updateValue(e){return this.class.remove(m),e!==this.value&&(this._value=e,e?this.class.add(j):this.class.remove(j),this.renderChanges&&this.flash(),this.emit("change",e),!0)}focus(){this.dom.focus()}blur(){this.dom.blur()}set value(e){this._updateValue(e)&&this._binding&&this._binding.setValue(e)}get value(){return this._value}set values(e){const t=e.some((t=>t!==e[0]));t?(this._updateValue(null),this.class.add(m)):this._updateValue(e[0])}set renderChanges(e){this._renderChanges=e}get renderChanges(){return this._renderChanges}}function Y(e){const t=e[0]/255,s=e[1]/255,i=e[2]/255;let n,a;const r=Math.max(t,s,i),o=r-Math.min(t,s,i),l=e=>(r-e)/6/o+.5;if(0===o)return n=a=0,[n,a,r];a=o/r;const h=l(t),c=l(s),d=l(i);return t===r?n=d-c:s===r?n=1/3+h-d:i===r&&(n=2/3+c-h),n<0?n+=1:n>1&&(n-=1),[n,a,r]}function $(e){const t=e[0],s=e[1],i=e[2];let n,a,r;const o=Math.floor(6*t),l=6*t-o,h=i*(1-s),c=i*(1-l*s),d=i*(1-(1-l)*s);switch(o%6){case 0:n=i,a=d,r=h;break;case 1:n=c,a=i,r=h;break;case 2:n=h,a=i,r=d;break;case 3:n=h,a=c,r=i;break;case 4:n=d,a=h,r=i;break;case 5:n=i,a=h,r=c}return[Math.round(255*n),Math.round(255*a),Math.round(255*r)]}x.register("boolean",X,{renderChanges:!0});const K="pcui-overlay",Z=`${K}-inner`,J=`${K}-clickable`,Q=`${K}-transparent`,ee=`${K}-content`;class te extends P{constructor(e={}){var t,s;super(e),this._onPointerDown=e=>{this.clickable&&!this.domContent.contains(e.target)&&(document.body.blur(),requestAnimationFrame((()=>{this.hidden=!0})),e.preventDefault(),e.stopPropagation())},this.class.add(K),this._domClickableOverlay=document.createElement("div"),this._domClickableOverlay.ui=this,this._domClickableOverlay.classList.add(Z),this.dom.appendChild(this._domClickableOverlay),this.on("show",(()=>{document.body.addEventListener("pointerdown",this._onPointerDown,!0)})),this.on("hide",(()=>{document.body.removeEventListener("pointerdown",this._onPointerDown,!0)})),this.domContent=document.createElement("div"),this.domContent.ui=this,this.domContent.classList.add(ee),this.dom.appendChild(this.domContent),this.clickable=null!==(t=e.clickable)&&void 0!==t&&t,this.transparent=null!==(s=e.transparent)&&void 0!==s&&s}destroy(){this._destroyed||super.destroy()}position(e,t){const s=this._domClickableOverlay.getBoundingClientRect(),i=this.domContent.getBoundingClientRect();e=Math.max(0,Math.min(s.width-i.width,e)),t=Math.max(0,Math.min(s.height-i.height,t)),this.domContent.style.position="absolute",this.domContent.style.left=`${e}px`,this.domContent.style.top=`${t}px`}set clickable(e){e?this.class.add(J):this.class.remove(J)}get clickable(){return this.class.contains(J)}set transparent(e){e?this.class.add(Q):this.class.remove(Q)}get transparent(){return this.class.contains(Q)}}x.register("overlay",te);class se extends E{constructor(e={}){super(e),this.class.add("pcui-text-input"),e.onValidate&&(this.onValidate=e.onValidate)}_onInputChange(e){if(!this._suspendInputChangeEvt){if(this.onValidate){const e=!this.onValidate(this.value);if(this.error=e,e)return}else this.error=!1;this.emit("change",this.value),this._binding&&this._binding.setValue(this.value)}}_updateValue(e){if(this.class.remove(m),e&&"object"==typeof e)if(Array.isArray(e)){let t=!1;for(let s=0;s<e.length;s++)if(e[s]&&"object"==typeof e[s]){t=!0;break}e=t?"[Not available]":e.map((e=>null===e?"null":e)).join(",")}else e="[Not available]";return e!==this.value&&(this._suspendInputChangeEvt=!0,this._domInput.value=null==e?"":String(e),this._suspendInputChangeEvt=!1,this.emit("change",e),!0)}set value(e){const t=this._updateValue(e);t&&(this.error=!1),t&&this._binding&&this._binding.setValue(e)}get value(){return this._domInput.value}set values(e){const t=e.some((t=>t!==e[0]));t?(this._updateValue(null),this.class.add(m)):this._updateValue(e[0])}}x.register("string",se,{renderChanges:!0});class ie extends x{constructor(e={}){var t,s,i;super(e),this._historyCombine=!1,this._historyPostfix=null,this._size=144,this._directInput=!0,this._colorHSV=[0,0,0],this._pickerChannels=[],this._channelsNumber=4,this._changing=!1,this._dragging=!1,this._callingCallback=!1,this._pickRectPointerId=null,this._pickHuePointerId=null,this._pickOpacityPointerId=null,this._evtColorPick=null,this._evtColorToPicker=null,this._evtColorPickStart=null,this._evtColorPickEnd=null,this._onKeyDown=e=>{"Escape"===e.key&&this.blur(),"Enter"===e.key&&this.enabled&&!this.readOnly&&(e.stopPropagation(),e.preventDefault())},this._onFocus=e=>{this.emit("focus")},this._onBlur=e=>{this.emit("blur")},this._pickRectPointerDown=e=>{null===this._pickRectPointerId&&(this._pickRect.setPointerCapture(e.pointerId),this._pickRectPointerId=e.pointerId,e.preventDefault(),e.stopPropagation(),this.emit("picker:color:start"),this._pickRectPointerMove(e))},this._pickRectPointerMove=e=>{if(this._pickRectPointerId!==e.pointerId)return;this._changing=!0;const t=this._pickRect.getBoundingClientRect(),s=Math.max(0,Math.min(this._size,Math.floor(e.clientX-t.left))),i=Math.max(0,Math.min(this._size,Math.floor(e.clientY-t.top)));this._colorHSV[1]=s/this._size,this._colorHSV[2]=1-i/this._size,this._directInput=!1;const n=$(this._colorHSV);for(let e=0;e<3;e++)this._pickerChannels[e].value=n[e];this._fieldHex.value=this._getHex(),this._directInput=!0,this._pickRectHandle.style.left=`${Math.max(4,Math.min(this._size-4,s))}px`,this._pickRectHandle.style.top=`${Math.max(4,Math.min(this._size-4,i))}px`,this._changing=!1},this._pickRectPointerUp=e=>{this._pickRectPointerId===e.pointerId&&(this.emit("picker:color:end"),this._pickRect.releasePointerCapture(e.pointerId),this._pickRectPointerId=null)},this._pickHuePointerDown=e=>{null===this._pickHuePointerId&&(this._pickHue.setPointerCapture(e.pointerId),this._pickHuePointerId=e.pointerId,e.preventDefault(),e.stopPropagation(),this.emit("picker:color:start"),this._pickHuePointerMove(e))},this._pickHuePointerMove=e=>{if(this._pickHuePointerId!==e.pointerId)return;this._changing=!0;const t=this._pickHue.getBoundingClientRect(),s=Math.max(0,Math.min(this._size,Math.floor(e.clientY-t.top)))/this._size,i=$([s,this._colorHSV[1],this._colorHSV[2]]);this._colorHSV[0]=s,this._directInput=!1;for(let e=0;e<3;e++)this._pickerChannels[e].value=i[e];this._fieldHex.value=this._getHex(),this._onChangeRgb(),this._directInput=!0,this._changing=!1},this._pickHuePointerUp=e=>{this._pickHuePointerId===e.pointerId&&(this.emit("picker:color:end"),this._pickHue.releasePointerCapture(e.pointerId),this._pickHuePointerId=null)},this._pickOpacityPointerDown=e=>{null===this._pickOpacityPointerId&&(this._pickOpacity.setPointerCapture(e.pointerId),this._pickOpacityPointerId=e.pointerId,e.preventDefault(),e.stopPropagation(),this.emit("picker:color:start"),this._pickOpacityPointerMove(e))},this._pickOpacityPointerMove=e=>{if(this._pickOpacityPointerId!==e.pointerId)return;this._changing=!0;const t=this._pickOpacity.getBoundingClientRect(),s=1-Math.max(0,Math.min(this._size,Math.floor(e.clientY-t.top)))/this._size;this._directInput=!1,this._pickerChannels[3].value=Math.max(0,Math.min(255,Math.round(255*s))),this._fieldHex.value=this._getHex(),this._directInput=!0,this._changing=!1},this._pickOpacityPointerUp=e=>{this._pickOpacityPointerId===e.pointerId&&(this.emit("picker:color:end"),this._pickOpacity.releasePointerCapture(e.pointerId),this._pickOpacityPointerId=null)},this.class.add("pcui-color-input",f),this._domColor=document.createElement("div"),this.dom.appendChild(this._domColor),this.dom.addEventListener("keydown",this._onKeyDown),this.dom.addEventListener("focus",this._onFocus),this.dom.addEventListener("blur",this._onBlur),this.dom.addEventListener("pointerdown",(e=>{this.enabled&&!this.readOnly&&this._overlay.hidden&&(this._openColorPicker(),e.stopPropagation(),e.preventDefault())})),this._value=null!==(t=e.value)&&void 0!==t?t:[0,0,255,1],this._channels=null!==(s=e.channels)&&void 0!==s?s:3,this._setValue(this._value),this.renderChanges=null!==(i=e.renderChanges)&&void 0!==i&&i,this.on("change",(()=>{this.renderChanges&&this.flash()})),this._overlay=new te({class:"picker-color",clickable:!0,hidden:!0,transparent:!0}),this.dom.appendChild(this._overlay.dom),this._pickRect=document.createElement("div"),this._pickRect.classList.add("pick-rect"),this._overlay.append(this._pickRect),this._pickRect.addEventListener("pointerdown",this._pickRectPointerDown),this._pickRect.addEventListener("pointermove",this._pickRectPointerMove),this._pickRect.addEventListener("pointerup",this._pickRectPointerUp),this._pickRectWhite=document.createElement("div"),this._pickRectWhite.classList.add("white"),this._pickRect.appendChild(this._pickRectWhite),this._pickRectBlack=document.createElement("div"),this._pickRectBlack.classList.add("black"),this._pickRect.appendChild(this._pickRectBlack),this._pickRectHandle=document.createElement("div"),this._pickRectHandle.classList.add("handle"),this._pickRect.appendChild(this._pickRectHandle),this._pickHue=document.createElement("div"),this._pickHue.classList.add("pick-hue"),this._overlay.append(this._pickHue),this._pickHue.addEventListener("pointerdown",this._pickHuePointerDown),this._pickHue.addEventListener("pointermove",this._pickHuePointerMove),this._pickHue.addEventListener("pointerup",this._pickHuePointerUp),this._pickHueHandle=document.createElement("div"),this._pickHueHandle.classList.add("handle"),this._pickHue.appendChild(this._pickHueHandle),this._pickOpacity=document.createElement("div"),this._pickOpacity.classList.add("pick-opacity"),this._overlay.append(this._pickOpacity),this._pickOpacity.addEventListener("pointerdown",this._pickOpacityPointerDown),this._pickOpacity.addEventListener("pointermove",this._pickOpacityPointerMove),this._pickOpacity.addEventListener("pointerup",this._pickOpacityPointerUp),this._pickOpacityHandle=document.createElement("div"),this._pickOpacityHandle.classList.add("handle"),this._pickOpacity.appendChild(this._pickOpacityHandle),this._panelFields=document.createElement("div"),this._panelFields.classList.add("fields"),this._overlay.append(this._panelFields),this._overlay.on("hide",(()=>{this._evtColorPick.unbind(),this._evtColorPick=null,this._evtColorToPicker.unbind(),this._evtColorToPicker=null,this._evtColorPickStart.unbind(),this._evtColorPickStart=null,this._evtColorPickEnd.unbind(),this._evtColorPickEnd=null}));const n=e=>new L({class:["field",`field-${e}`],precision:0,step:1,min:0,max:255,placeholder:e}),a=n("r");a.on("change",(()=>{this._onChangeRgb()})),this._pickerChannels.push(a),this._panelFields.appendChild(a.dom);const r=n("g");r.on("change",(()=>{this._onChangeRgb()})),this._pickerChannels.push(r),this._panelFields.appendChild(r.dom);const o=n("b");o.on("change",(()=>{this._onChangeRgb()})),this._pickerChannels.push(o),this._panelFields.appendChild(o.dom);const l=n("a");l.on("change",(e=>{this._onChangeAlpha(e)})),this._pickerChannels.push(l),this._panelFields.appendChild(l.dom),this._fieldHex=new se({class:["field","field-hex"],placeholder:"#"}),this._fieldHex.on("change",(()=>{this._onChangeHex()})),this._panelFields.appendChild(this._fieldHex.dom)}destroy(){this._destroyed||(this.dom.removeEventListener("keydown",this._onKeyDown),this.dom.removeEventListener("focus",this._onFocus),this.dom.removeEventListener("blur",this._onBlur),this._pickRect.removeEventListener("pointerdown",this._pickRectPointerDown),this._pickRect.removeEventListener("pointermove",this._pickRectPointerMove),this._pickRect.removeEventListener("pointerup",this._pickRectPointerUp),this._pickHue.removeEventListener("pointerdown",this._pickHuePointerDown),this._pickHue.removeEventListener("pointermove",this._pickHuePointerMove),this._pickHue.removeEventListener("pointerup",this._pickHuePointerUp),this._pickOpacity.removeEventListener("pointerdown",this._pickOpacityPointerDown),this._pickOpacity.removeEventListener("pointermove",this._pickOpacityPointerMove),this._pickOpacity.removeEventListener("pointerup",this._pickOpacityPointerUp),super.destroy())}focus(){this.dom.focus()}blur(){this.dom.blur()}_setColorPickerPosition(e,t){this._overlay.position(e,t)}_setPickerColor(e){if(!this._changing&&!this._dragging){if(this._channelsNumber>=3){const t=Y(e);this._colorHSV[0]=t[0],this._colorHSV[1]=t[1],this._colorHSV[2]=t[2]}this._directInput=!1;for(let t=0;t<e.length;t++)this._pickerChannels[t].value=e[t];this._fieldHex.value=this._getHex(),this._directInput=!0}}_openColorPicker(){this._callPicker(this.value.map((e=>Math.floor(255*e)))),this._evtColorPick=this.on("picker:color",(e=>{this.value=e.map((e=>e/255))})),this._evtColorPickStart=this.on("picker:color:start",(()=>{this.binding?(this._historyCombine=this.binding.historyCombine,this._historyPostfix=this.binding.historyPostfix,this.binding.historyCombine=!0,this._binding.historyPostfix=`(${Date.now()})`):(this._historyCombine=!1,this._historyPostfix=null)})),this._evtColorPickEnd=this.on("picker:color:end",(()=>{this.binding&&(this.binding.historyCombine=this._historyCombine,this.binding.historyPostfix=this._historyPostfix)}));const e=this._overlay.dom.getBoundingClientRect(),t=this.dom.getBoundingClientRect();this._setColorPickerPosition(t.left-e.left,t.bottom-e.top+1),this._evtColorToPicker=this.on("change",(()=>{this._setPickerColor(this.value.map((e=>Math.floor(255*e))))}))}_callPicker(e){for(let t=0;t<4;t++)e.length-1<t?this._overlay.class.remove(`c-${t+1}`):this._overlay.class.add(`c-${t+1}`);if(this._channelsNumber=e.length,this._channelsNumber>=3){const t=Y(e);this._colorHSV[0]=t[0],this._colorHSV[1]=t[1],this._colorHSV[2]=t[2]}this._directInput=!1;for(let t=0;t<e.length;t++)this._pickerChannels[t].value=e[t];this._fieldHex.value=this._getHex(),this._directInput=!0,this._overlay.hidden=!1,this._fieldHex.dom.focus(),window.setTimeout((()=>{this._fieldHex.dom.focus()}),100)}_valueToColor(e){return e=Math.floor(255*e),Math.max(0,Math.min(e,255))}_setValue(e){const t=this._valueToColor(e[0]),s=this._valueToColor(e[1]),i=this._valueToColor(e[2]),n=e[3];1===this._channels?this._domColor.style.backgroundColor=`rgb(${t}, ${t}, ${t})`:3===this._channels?this._domColor.style.backgroundColor=`rgb(${t}, ${s}, ${i})`:4===this._channels&&(this._domColor.style.backgroundColor=`rgba(${t}, ${s}, ${i}, ${n})`)}_updateValue(e){let t=!1;for(let s=0;s<e.length;s++)this._value[s]!==e[s]&&(t=!0,this._value[s]=e[s]);return this.class.remove(m),t&&(this._setValue(e),this.emit("change",e)),t}_getHex(){let e="";for(let t=0;t<this._channelsNumber;t++)e+=`00${this._pickerChannels[t].value.toString(16)}`.slice(-2).toUpperCase();return e}_onChangeHex(){if(!this._directInput)return;this._changing=!0;const e=this._fieldHex.value.trim().toLowerCase();if(/^([0-9a-f]{2}){3,4}$/.test(e))for(let t=0;t<this._channelsNumber;t++)this._pickerChannels[t].value=parseInt(e.slice(2*t,2*t+2),16);this._changing=!1}_onChangeRgb(){const e=this._pickerChannels.map((e=>e.value||0)).slice(0,this._channelsNumber),t=Y(e);if(this._directInput){const s=e[0]+e[1]+e[2];765!==s&&0!==s&&(this._colorHSV[0]=t[0]),this._colorHSV[1]=t[1],this._colorHSV[2]=t[2],this._dragging=!0,this.emit("picker:color:start"),this._fieldHex.value=this._getHex()}if(this._pickHueHandle.style.top=`${Math.floor(this._size*this._colorHSV[0])}px`,this._pickRectHandle.style.left=`${Math.max(4,Math.min(this._size-4,this._size*this._colorHSV[1]))}px`,this._pickRectHandle.style.top=`${Math.max(4,Math.min(this._size-4,this._size*(1-this._colorHSV[2])))}px`,this._channelsNumber>=3){const t=$([this._colorHSV[0],1,1]).join(",");this._pickRect.style.backgroundColor=`rgb(${t})`,this._pickRectHandle.style.backgroundColor=`rgb(${e.slice(0,3).join(",")})`,this._pickHueHandle.style.backgroundColor=`rgb(${t})`}this.callCallback()}_onChangeAlpha(e){4===this._channelsNumber&&(this._pickOpacityHandle.style.top=`${Math.floor(this._size*(1-Math.max(0,Math.min(255,e))/255))}px`,this._pickOpacityHandle.style.backgroundColor=`rgb(${e}, ${e}, ${e})`,this.callCallback())}callbackHandle(){this._callingCallback=!1,this.emit("picker:color",this._pickerChannels.map((e=>e.value||0)).slice(0,this._channelsNumber))}callCallback(){this._callingCallback||(this._callingCallback=!0,window.setTimeout((()=>{this.callbackHandle()}),1e3/60))}set value(e){e=e||[0,0,0,0];this._updateValue(e)&&this._binding&&this._binding.setValue(e)}get value(){return this._value.slice(0,this._channels)}set values(e){let t=!1;const s=e[0];for(let i=1;i<e.length;i++)if(Array.isArray(s)){if(!s.equals(e[i])){t=!0;break}}else if(s!==e[i]){t=!0;break}t?(this.value=null,this.class.add(m)):this.value=e[0]}set channels(e){this._channels!==e&&(this._channels=Math.max(0,Math.min(e,4)),this._setValue(this.value))}get channels(){return this._channels}set renderChanges(e){this._renderChanges=e}get renderChanges(){return this._renderChanges}}x.register("rgb",ie),x.register("rgba",ie,{channels:4});const ne=(e,t)=>{if(0===e.length)return t.length;if(0===t.length)return e.length;if(e===t)return 0;const s=[];for(let e=0;e<=t.length;e++)s[e]=[e];for(let t=0;t<=e.length;t++)s[0][t]=t;for(let i=1;i<=t.length;i++)for(let n=1;n<=e.length;n++)t.charAt(i-1)===e.charAt(n-1)?s[i][n]=s[i-1][n-1]:s[i][n]=Math.min(s[i-1][n-1]+1,Math.min(s[i][n-1]+1,s[i-1][n]+1));return s[t.length][e.length]},ae=(e,t)=>{if(e===t)return e.length;let s=0;const i=new Set;for(let e=0;e<t.length;e++)i.add(t.charAt(e));for(let t=0;t<e.length;t++)i.has(e.charAt(t))&&s++;return s},re=e=>{const t=[],s=e.replace(/([^A-Z])([A-Z][^A-Z])/g,"$1 $2").replace(/([A-Z0-9]{2,})/g," $1").split(/([\s\-_])/);for(let e=0;e<s.length;e++)s[e]=s[e].toLowerCase().trim(),s[e]&&"-"!==s[e]&&"_"!==s[e]&&t.push(s[e]);return t},oe=(e,t,s)=>{const i=[];for(const n of e){if(n.subFull!==1/0){i.push(n),n.edits===1/0&&(n.edits=0),n.sub===1/0&&(n.sub=n.subFull);continue}if(n.name===t||0===n.name.indexOf(t)){i.push(n),n.edits===1/0&&(n.edits=0),n.sub===1/0&&(n.sub=0);continue}if(ae(t,n.name)/t.length<s.containsCharsTolerance)continue;let e=1/0,a=1/0;for(let i=0;i<n.tokens.length;i++){if(n.tokens[i]===t){e=0,a=i;break}const r=ne(t,n.tokens[i]);(a===1/0||r<e)&&-1!==n.tokens[i].indexOf(t)?(a=i,e=r):a===1/0&&r<e&&r/Math.max(t.length,n.tokens[i].length)<=s.editsDistanceTolerance&&(e=r)}e!==1/0&&(i.push(n),n.edits=n.edits===1/0?e:n.edits+e,n.sub=n.sub===1/0?a:n.sub+a)}return i},le="pcui-select-input",he=`${le}-container-value`,ce=`${le}-multi`,de=`${le}-disabled-value`,ue=`${le}-has-disabled-value`,pe=`${le}-value`,me=`${le}-icon`,fe=`${le}-textinput`,ge=`${le}-list`,ve=`${le}-tags`,_e=`${le}-tags-empty`,ye=`${le}-tag`,xe=`${le}-tag-not-everywhere`,we=`${le}-shadow`,be=`${le}-fit-height`,Ce="pcui-selected",Se=`${le}-label-highlighted`,Ae=`${le}-create-new`,Te="pcui-open";class Pe extends x{constructor(e={}){var t,s,i,n;const a=new P({dom:e.dom});super(Object.assign(Object.assign({},e),{dom:a.dom})),this._timeoutLabelValueTabIndex=null,this._valueToText={},this._valueToLabel={},this._labelToValue=new Map,this._labelHighlighted=null,this._disabledOptions={},this._prefix="",this._onInputChange=e=>{this._suspendInputChange||this._lastInputValue!==e&&(this.open(),this._lastInputValue=e,this._filterOptions(e))},this._onInputKeyDown=e=>{if("Enter"===e.key&&this.enabled&&!this.readOnly){let t;if(e.stopPropagation(),e.preventDefault(),t=this._labelHighlighted&&this._labelToValue.has(this._labelHighlighted)?this._labelToValue.get(this._labelHighlighted):this._input.value,void 0!==t)return this.focus(),this.close(),void(this._valueToText[t]?this._onSelectValue(t):this._allowCreate&&(this._createFn?this._createFn(t):this._onSelectValue(t)))}this._onKeyDown(e)},this._onDocumentPointerDown=e=>{this.dom.contains(e.composedPath()[0])||this.close()},this._onKeyDown=e=>{if("Escape"!==e.key)if("Tab"!==e.key){if(this.enabled&&!this.readOnly)if("Enter"!==e.key||this._allowInput){if("ArrowUp"===e.key||"ArrowDown"===e.key)if(e.stopPropagation(),e.preventDefault(),(this._allowInput||this.multiSelect)&&this._containerOptions.hidden)this.open();else if(this._containerOptions.hidden){if(!this._options.length)return;let t=-1;for(let e=0;e<this._options.length;e++)if(this._options[e].v===this.value){t=e;break}"ArrowUp"===e.key?t--:"ArrowDown"===e.key&&t++,t>=0&&t<this._options.length&&this._onSelectValue(this._options[t].v)}else{if(!this._containerOptions.dom.childNodes.length)return;if(this._labelHighlighted){let t=this._labelHighlighted.dom;do{"ArrowUp"===e.key?t=t.previousSibling:"ArrowDown"===e.key&&(t=t.nextSibling)}while(t&&t.ui.hidden);t&&this._highlightLabel(t.ui)}else this._highlightLabel(this._containerOptions.dom.childNodes[0].ui)}}else this._labelHighlighted&&this._labelToValue.has(this._labelHighlighted)&&(this._onSelectValue(this._labelToValue.get(this._labelHighlighted)),this.close())}else this.close();else this.close()},this._onPointerDown=()=>{this._allowInput||this.focus()},this._onFocus=()=>{this.class.add(c),this.emit("focus"),this._input.hidden||this.open()},this._onBlur=()=>{this.class.remove(c),this.emit("blur")},this._onWheel=e=>{e.stopPropagation()},this._container=a,this._container.parent=this,this.class.add(le),this._containerValue=new P({class:he}),this._container.append(this._containerValue),this._domShadow=document.createElement("div"),this._domShadow.classList.add(we),this._containerValue.append(this._domShadow),this._allowInput=e.allowInput,this._allowInput&&this.class.add("pcui-select-input-allow-input"),this._allowCreate=e.allowCreate,this._createFn=e.createFn,this._createLabelText=e.createLabelText,this._labelValue=new F({class:pe,tabIndex:0}),this._labelValue.on("click",(()=>{this.enabled&&!this.readOnly&&this.toggle()})),this._containerValue.append(this._labelValue),this._labelIcon=new F({class:me,hidden:e.allowInput&&e.multiSelect}),this._containerValue.append(this._labelIcon),this._input=new se({class:fe,blurOnEnter:!1,keyChange:!0}),this._containerValue.append(this._input),this._lastInputValue="",this._suspendInputChange=!1,this._input.on("change",this._onInputChange),this._input.on("keydown",this._onInputKeyDown),this._input.on("focus",this._onFocus),this._input.on("blur",this._onBlur),e.placeholder&&(this.placeholder=e.placeholder),this._containerOptions=new P({class:ge,hidden:!0}),this._containerValue.append(this._containerOptions),this._containerTags=new P({class:ve,flex:!0,flexDirection:"row",hidden:!0}),this._container.append(this._containerTags),e.multiSelect&&(this.class.add(ce),this._containerTags.hidden=!1),this._labelValue.dom.addEventListener("keydown",this._onKeyDown),this._labelValue.dom.addEventListener("focus",this._onFocus),this._labelValue.dom.addEventListener("blur",this._onBlur),this._labelValue.dom.addEventListener("pointerdown",this._onPointerDown),this._containerOptions.dom.addEventListener("wheel",this._onWheel,{passive:!0}),this.on("hide",(()=>{this.close()})),this._type=null!==(t=e.type)&&void 0!==t?t:"string",this.invalidOptions=null!==(s=e.invalidOptions)&&void 0!==s?s:[],this.options=null!==(i=e.options)&&void 0!==i?i:[],this._optionsFn=e.optionsFn,this._allowNull=e.allowNull,this._values=null,void 0!==e.value?this.value=e.value:e.defaultValue?this.value=e.defaultValue:this.value=null,this._renderChanges=e.renderChanges,this.on("change",(()=>{this._updateInputFieldsVisibility(),this.renderChanges&&!this.multiSelect&&this._labelValue.flash()})),this._updateInputFieldsVisibility(!1),this._onSelect=e.onSelect,this.fallbackOrder=e.fallbackOrder,this.disabledOptions=e.disabledOptions,this._prefix=null!==(n=e.prefix)&&void 0!==n?n:""}destroy(){this._destroyed||(this._labelValue.dom.removeEventListener("keydown",this._onKeyDown),this._labelValue.dom.removeEventListener("pointerdown",this._onPointerDown),this._labelValue.dom.removeEventListener("focus",this._onFocus),this._labelValue.dom.removeEventListener("blur",this._onBlur),this._containerOptions.dom.removeEventListener("wheel",this._onWheel),window.removeEventListener("keydown",this._onKeyDown),document.removeEventListener("pointerdown",this._onDocumentPointerDown),this._timeoutLabelValueTabIndex&&(cancelAnimationFrame(this._timeoutLabelValueTabIndex),this._timeoutLabelValueTabIndex=null),super.destroy())}_initializeCreateLabel(){const e=new P({class:Ae,flex:!0,flexDirection:"row"}),t=new F({text:this._input.value,tabIndex:-1});e.append(t);let s=this._input.on("change",(s=>{t.destroyed||(t.text=s,this.invalidOptions&&-1!==this.invalidOptions.indexOf(s)?e.hidden||(e.hidden=!0,this._resizeShadow()):e.hidden&&(e.hidden=!1,this._resizeShadow()))}));e.on("click",(e=>{e.stopPropagation();const s=t.text;this.focus(),this.close(),this._createFn?this._createFn(s):s&&this._onSelectValue(s)})),t.on("destroy",(()=>{s.unbind(),s=null}));const i=new F({text:this._createLabelText});return e.append(i),this._containerOptions.append(e),e}_convertSingleValue(e){if(null===e&&this._allowNull)return e;if("string"===this._type)e=e?e.toString():"";else if("number"===this._type)e=e?parseInt(e,10):0;else if("boolean"===this._type)return!!e;return e}_convertValue(e){return null===e&&this._allowNull?e:this.multiSelect?Array.isArray(e)?e.map((e=>this._convertSingleValue(e))):e:this._convertSingleValue(e)}_onSelectValue(e){if(e=this._convertSingleValue(e),this.multiSelect)if(this._values){let t=!1;this._values.forEach((s=>{s?-1===s.indexOf(e)&&(s.push(e),t=!0):(s=[e],t=!0)})),t&&(this._onMultipleValuesChange(this._values),this.emit("change",this.value),this._binding&&this._binding.addValues([e]))}else this._value&&Array.isArray(this._value)?-1===this._value.indexOf(e)&&(this._value.push(e),this._addTag(e),this.emit("change",this.value),this._binding&&this._binding.addValues([e])):this.value=[e];else this.value=e}_highlightLabel(e){if(this._labelHighlighted!==e&&(this._labelHighlighted&&this._labelHighlighted.class.remove(Se),this._labelHighlighted=e,this._labelHighlighted)){this._labelHighlighted.class.add(Se);const e=this._labelHighlighted.dom.offsetTop,t=this._containerOptions.dom.scrollTop;e<t?this._containerOptions.dom.scrollTop=e:e+this._labelHighlighted.height>this._containerOptions.height+t&&(this._containerOptions.dom.scrollTop=e+this._labelHighlighted.height-this._containerOptions.height)}}_onValueChange(e){if(this.multiSelect){if(this._labelValue.value="",this._containerTags.clear(),this._containerTags.class.add(_e),e&&Array.isArray(e)){for(const t of e){this._addTag(t);const e=this._valueToLabel[String(t)];e&&e.class.add(Ce)}for(const t in this._valueToLabel){const s=this._valueToLabel[t];-1!==e.indexOf(this._convertSingleValue(t))?s.class.add(Ce):s.class.remove(Ce)}}}else{this._labelValue.value=this._prefix+(this._valueToText[String(e)]||""),e=String(e);for(const t in this._valueToLabel){const s=this._valueToLabel[t];t===e?s.class.add(Ce):s.class.remove(Ce)}}}_onMultipleValuesChange(e){this._labelValue.value="",this._containerTags.clear(),this._containerTags.class.add(_e);const t={},s={};e.forEach((e=>{e&&e.forEach((e=>{t[e]?s[e]++:(t[e]=this._addTag(e),s[e]=1)}))}));for(const i in s)if(s[i]!==e.length){t[i].class.add(xe);const e=this._valueToLabel[String(i)];e&&e.class.remove(Ce)}}_addTag(e){const t=new P({flex:!0,flexDirection:"row",class:ye});t.append(new F({text:this._valueToText[String(e)]||e}));const s=new w({size:"small",icon:"E132",tabIndex:-1});t.append(s),s.on("click",(()=>this._removeTag(t,String(e)))),this._containerTags.append(t),this._containerTags.class.remove(_e);const i=this._valueToLabel[String(e)];return i&&i.class.add(Ce),t.value=e,t}_removeTag(e,t){e.destroy();const s=this._valueToLabel[String(t)];if(s&&s.class.remove(Ce),this._values)this._values.forEach((e=>{if(!e)return;const s=e.indexOf(t);-1!==s&&e.splice(s,1)}));else if(this._value&&Array.isArray(this._value)){const e=this._value.indexOf(t);-1!==e&&this._value.splice(e,1)}this.emit("change",this.value),this._binding&&this._binding.removeValues([t])}_filterOptions(e){const t=this._containerOptions.dom;for(;t.firstChild;)t.removeChild(t.lastChild);if(e){const s=((e,t,s="",i={})=>{var n,a;if(!(s=s.toLowerCase().trim()))return[];const r=re(s);if(!r.length)return[];i.containsCharsTolerance=null!==(n=i.containsCharsTolerance)&&void 0!==n?n:.5,i.editsDistanceTolerance=null!==(a=i.editsDistanceTolerance)&&void 0!==a?a:.5;let o=e.map((e=>{const i=e[t].toLowerCase().trim().indexOf(s);return{name:e[t],item:e,tokens:re(e[t]),edits:1/0,subFull:-1!==i?i:1/0,sub:1/0}}));for(let e=0;e<r.length;e++)o=oe(o,r[e],i);o.sort(((e,t)=>e.subFull!==t.subFull?e.subFull-t.subFull:e.sub!==t.sub?e.sub-t.sub:e.edits!==t.edits?e.edits-t.edits:e.name.length-t.name.length));let l=o.map((e=>e.item));return i.hasOwnProperty("limitResults")&&l.length>i.limitResults&&(l=l.slice(0,i.limitResults)),l})(this._options,"t",e);s.forEach((e=>{const s=this._valueToLabel[String(e.v)];t.appendChild(s.dom)}))}else for(const e of this._options){const s=this._valueToLabel[String(e.v)];t.appendChild(s.dom)}this._createLabelContainer&&t.appendChild(this._createLabelContainer.dom),t.firstChild&&this._highlightLabel(t.firstChild.ui),this._resizeShadow()}_resizeShadow(){this._domShadow.style.height=`${this._containerValue.height+this._containerOptions.height}px`}_updateInputFieldsVisibility(e){let t=!1,s=!1;this._allowInput&&(e?(t=!0,s=!0):t=this.multiSelect||!this._valueToLabel[this.value]),this._labelValue.hidden=t,this._labelIcon.hidden=t,this._input.hidden=!t,s&&this._input.focus(),this._labelValue.hidden||(this._labelValue.tabIndex=-1,this._timeoutLabelValueTabIndex||(this._timeoutLabelValueTabIndex=requestAnimationFrame((()=>{this._timeoutLabelValueTabIndex=null,this._labelValue.tabIndex=0}))))}focus(){this._input.hidden?this._labelValue.dom.focus():this._input.focus()}blur(){this._allowInput?this._input.blur():this._labelValue.dom.blur()}open(){if(!this._containerOptions.hidden||!this.enabled||this.readOnly)return;if(this._updateInputFieldsVisibility(!0),this._optionsFn&&(this.options=this._optionsFn()),0===this._containerOptions.dom.childNodes.length)return;this._containerOptions.forEachChild((e=>{e.hidden=!1,this._labelToValue.get(e)===this.value&&this._highlightLabel(e)})),this._labelHighlighted||this._highlightLabel(this._containerOptions.dom.childNodes[0].ui),this._containerOptions.hidden=!1,this.class.add(Te),window.addEventListener("keydown",this._onKeyDown),document.addEventListener("pointerdown",this._onDocumentPointerDown);const e=(this._allowInput?this._input.dom:this._labelValue.dom).getBoundingClientRect();let t=e.bottom+this._containerOptions.height+25>=window.innerHeight;t&&e.top-this._containerOptions.height<0&&(t=!1,this._containerOptions.style.maxHeight=window.innerHeight-e.bottom-25+"px"),t?this.class.add(be):this.class.remove(be),this._resizeShadow()}close(){this._containerOptions.style.maxHeight="",this._highlightLabel(null),this._updateInputFieldsVisibility(!1),this._suspendInputChange=!0,this._input.value="",this._lastInputValue&&(this._lastInputValue="",this._filterOptions(null)),this._suspendInputChange=!1,this._containerOptions.hidden||(this._containerOptions.hidden=!0,this._domShadow.style.height="",this.class.remove(Te),window.removeEventListener("keydown",this._onKeyDown),document.removeEventListener("pointerdown",this._onDocumentPointerDown))}toggle(){this._containerOptions.hidden?this.open():this.close()}unlink(){super.unlink(),this._containerOptions.hidden||this.close()}_updateValue(e){e!==this._value&&(this._value=e,this._onValueChange(e),this._suppressChange||this.emit("change",e),this._binding&&this._binding.setValue(e))}_updateDisabledValue(e){const t={};this._containerOptions.forEachChild((e=>{t[e.dom.id]=e,this._disabledOptions[e.dom.id]?(e.enabled=!1,e.text=this._disabledOptions[e.dom.id]):(e.enabled=!0,e.text=this._valueToText[e.dom.id]),e.class.remove(de)}));const s=this._disabledOptions[e]?e:null;let i=null;if(s){if(this._fallbackOrder)for(let t=0;t<this._fallbackOrder.length;t++)if(this._fallbackOrder[t]!==e){i=this._fallbackOrder[t];break}this.disabledValue=s,t[s].class.add(de)}else this._disabledValue?(i=this._disabledValue,this.disabledValue=null):(i=e,this.disabledValue=null);return i}set options(e){if(!this._options||JSON.stringify(this._options)!==JSON.stringify(e)){this._containerOptions.clear(),this._labelHighlighted=null,this._valueToText={},this._valueToLabel={},this._options=e;for(const e of this._options){if(this._valueToText[String(e.v)]=e.t,""===e.v)return;const t=new F({text:e.t,tabIndex:-1,id:String(e.v)});this._labelToValue.set(t,e.v),this._valueToLabel[String(e.v)]=t,t.on("click",(t=>{t.stopPropagation(),this._onSelectValue(e.v),this.close(),this._onSelect&&this._onSelect(this.value)})),this._containerOptions.append(t)}this._createLabelContainer=null,this._createLabelText&&(this._createLabelContainer=this._initializeCreateLabel()),this.multiSelect&&this._values?this._onMultipleValuesChange(this._values):this._onValueChange(this.value),this._lastInputValue&&this._filterOptions(this._lastInputValue)}}get options(){return this._options.slice()}set invalidOptions(e){this._invalidOptions=e||null}get invalidOptions(){return this._invalidOptions}set disabledValue(e){this._disabledValue=e,null!==this._disabledValue?this.class.add(ue):this.class.remove(ue)}set disabledOptions(e){if(JSON.stringify(this._disabledOptions)===JSON.stringify(e))return;this._disabledOptions=e||{};const t=this._updateDisabledValue(this._value);this._updateValue(t)}set fallbackOrder(e){this._fallbackOrder=e||null}get multiSelect(){return this.class.contains(ce)}set value(e){this._values=null,this._suspendInputChange=!0,this._input.value="",this._lastInputValue&&(this._lastInputValue="",this._filterOptions(null)),this._suspendInputChange=!1,this.class.remove(m),e=this._convertValue(e),(!(this._value===e||this.multiSelect&&this._value&&this._value.equals(e))||null===e&&this._allowNull&&this.class.contains(m))&&(this.disabledValue=null,this._updateValue(e))}get value(){if(!this.multiSelect)return this._value;const e=[];return this._containerTags.dom.childNodes.forEach((t=>{e.push(t.ui.value)})),e}set values(e){e=e.map((e=>this._convertValue(e)));let t=!1;const s=e[0],i=this.multiSelect;this._values=null;for(let n=1;n<e.length;n++)if(!(e[n]===s||i&&e[n]&&e[n].equals(s))){t=!0;break}t?(this._labelValue.values=e,i?(this._values=e,this._value=null,this._onMultipleValuesChange(this._values),this.emit("change",this.value)):null!==this._value&&(this._value=null,this.emit("change",null)),this.class.add(m)):this.value=e[0]}set placeholder(e){this._input.placeholder=e}get placeholder(){return this._input.placeholder}set renderChanges(e){this._renderChanges=e}get renderChanges(){return this._renderChanges}}var Ee;x.register("select",Pe,{renderChanges:!0}),x.register("multiselect",Pe,{multiSelect:!0,renderChanges:!0}),x.register("tags",Pe,{allowInput:!0,allowCreate:!0,multiSelect:!0,renderChanges:!0});const ke="pcui-slider",Me=`${ke}-container`,Ie=`${ke}-bar`,De=`${ke}-handle`,Re=`${ke}-active`,Le=/Chrome\//.test(null===(Ee=globalThis.navigator)||void 0===Ee?void 0:Ee.userAgent);class Fe extends x{constructor(e={}){var t,s,i,n,a;super(e),this._historyCombine=!1,this._historyPostfix=null,this._cursorHandleOffset=0,this._pointerId=null,this._onPointerDown=e=>{"mouse"===e.pointerType&&0!==e.button||!this.enabled||this.readOnly||null!==this._pointerId||(e.stopPropagation(),this._domSlider.setPointerCapture(e.pointerId),this._pointerId=e.pointerId,this._onSlideStart(e.pageX))},this._onPointerMove=e=>{e.pointerId===this._pointerId&&(e.stopPropagation(),e.preventDefault(),this._onSlideMove(e.pageX))},this._onPointerUp=e=>{e.pointerId===this._pointerId&&null!==this._pointerId&&(e.stopPropagation(),this._domSlider.releasePointerCapture(e.pointerId),this._onSlideEnd(e.pageX),this._pointerId=null)},this._onKeyDown=e=>{if("Escape"===e.key)return void this.blur();if(!this.enabled||this.readOnly)return;if("ArrowLeft"!==e.key&&"ArrowRight"!==e.key)return;e.stopPropagation(),e.preventDefault();let t="ArrowLeft"===e.key?-1:1;e.shiftKey&&(t*=10),this.value+=t*this.step},this.class.add(ke);const r=new L({allowNull:e.allowNull,hideSlider:!0,min:e.min,max:e.max,keyChange:e.keyChange,placeholder:e.placeholder,precision:null!==(t=e.precision)&&void 0!==t?t:2,renderChanges:e.renderChanges,step:e.step});r.on("change",(e=>{this._onValueChange(e)})),r.on("focus",(()=>{this.emit("focus")})),r.on("blur",(()=>{this.emit("blur")})),r.parent=this,this.dom.appendChild(r.dom),this._numericInput=r,this._sliderMin=null!==(i=null!==(s=e.sliderMin)&&void 0!==s?s:e.min)&&void 0!==i?i:0,this._sliderMax=null!==(a=null!==(n=e.sliderMax)&&void 0!==n?n:e.max)&&void 0!==a?a:1,this._domSlider=document.createElement("div"),this._domSlider.classList.add(Me),this.dom.appendChild(this._domSlider),this._domBar=document.createElement("div"),this._domBar.classList.add(Ie),this._domBar.ui=this,this._domSlider.appendChild(this._domBar),this._domHandle=document.createElement("div"),this._domHandle.ui=this,this._domHandle.tabIndex=0,this._domHandle.classList.add(De),this._domBar.appendChild(this._domHandle),this._domSlider.addEventListener("pointerdown",this._onPointerDown),this._domHandle.addEventListener("keydown",this._onKeyDown),void 0!==e.value&&(this.value=e.value),void 0!==e.values&&(this.values=e.values),0===this.value&&this._updateHandle(0)}destroy(){this._destroyed||(this._domSlider.removeEventListener("pointerdown",this._onPointerDown),this._domHandle.removeEventListener("keydown",this._onKeyDown),super.destroy())}_updateHandle(e){const t=100*Math.max(0,Math.min(1,((e||0)-this._sliderMin)/(this._sliderMax-this._sliderMin))),s=this._domHandle.getBoundingClientRect().width;this._domHandle.style.left=`calc(${t}% + ${s/2}px)`}_onValueChange(e){this._updateHandle(e),this._suppressChange||this.emit("change",e),this._binding&&this._binding.setValue(e)}_calculateCursorHandleOffset(e){const t=Le?2:0,s=this._domHandle.getBoundingClientRect(),i=s.left-t,n=s.right;return this._cursorHandleOffset=e>=i&&e<=n?e-(i+(n-i)/2):0,this._cursorHandleOffset}_onSlideStart(e){this._domHandle.focus(),this._domSlider.addEventListener("pointermove",this._onPointerMove),this._domSlider.addEventListener("pointerup",this._onPointerUp),this.class.add(Re),this._calculateCursorHandleOffset(e)||this._onSlideMove(e),this.binding&&(this._historyCombine=this.binding.historyCombine,this._historyPostfix=this.binding.historyPostfix,this.binding.historyCombine=!0,this.binding.historyPostfix=`(${Date.now()})`)}_onSlideMove(e){const t=this._domBar.getBoundingClientRect();e-=this._cursorHandleOffset;let s=Math.max(0,Math.min(1,(e-t.left)/t.width))*(this._sliderMax-this._sliderMin)+this._sliderMin;s=parseFloat(s.toFixed(this.precision)),this.value=s}_onSlideEnd(e){this._calculateCursorHandleOffset(e)||this._onSlideMove(e),this.class.remove(Re),this._domSlider.removeEventListener("pointermove",this._onPointerMove),this._domSlider.removeEventListener("pointerup",this._onPointerUp),this.binding&&(this.binding.historyCombine=this._historyCombine,this.binding.historyPostfix=this._historyPostfix,this._historyCombine=!1,this._historyPostfix=null)}focus(){this._numericInput.focus()}blur(){this._domHandle.blur(),this._numericInput.blur()}set sliderMin(e){this._sliderMin!==e&&(this._sliderMin=e,this._updateHandle(this.value))}get sliderMin(){return this._sliderMin}set sliderMax(e){this._sliderMax!==e&&(this._sliderMax=e,this._updateHandle(this.value))}get sliderMax(){return this._sliderMax}set value(e){this._numericInput.value=e,this._numericInput.class.contains(m)?this.class.add(m):this.class.remove(m)}get value(){return this._numericInput.value}set values(e){this._numericInput.values=e,this._numericInput.class.contains(m)?this.class.add(m):this.class.remove(m)}set renderChanges(e){this._numericInput.renderChanges=e}get renderChanges(){return this._numericInput.renderChanges}set min(e){this._numericInput.min=e}get min(){return this._numericInput.min}set max(e){this._numericInput.max=e}get max(){return this._numericInput.max}set step(e){this._numericInput.step=e}get step(){return this._numericInput.step}set precision(e){this._numericInput.precision=e}get precision(){return this._numericInput.precision}set keyChange(e){this._numericInput.keyChange=e}get keyChange(){return this._numericInput.keyChange}set placeholder(e){this._numericInput.placeholder=e}get placeholder(){return this._numericInput.placeholder}}x.register("slider",Fe,{renderChanges:!0});const Be="pcui-text-area-input",Oe=`${Be}-resizable`,ze=`${Oe}-none`,Ve=`${Oe}-both`,Ne=`${Oe}-horizontal`,Ue=`${Oe}-vertical`;class He extends se{constructor(e={}){switch(super(e=Object.assign({input:document.createElement("textarea")},e)),this.class.add(Be),e.resizable){case"both":this.class.add(Ve);break;case"horizontal":this.class.add(Ne);break;case"vertical":this.class.add(Ue);break;default:this.class.add(ze)}}_onInputKeyDown(e){("Escape"===e.key&&this.blurOnEscape||"Enter"===e.key&&this.blurOnEnter&&!e.shiftKey)&&this._domInput.blur(),this.emit("keydown",e)}}x.register("text",He,{renderChanges:!0});class Ge extends x{constructor(e={}){var t,s,i;const n=Object.assign({},e);delete n.binding,super(n),this._inputs=[],this._applyingChange=!1,this._bindAllInputs=!1,this.class.add("pcui-vector-input");const a=Math.max(2,Math.min(4,null!==(t=e.dimensions)&&void 0!==t?t:3));for(let t=0;t<a;t++){const n=new L({min:e.min,max:e.max,precision:null!==(s=e.precision)&&void 0!==s?s:7,step:null!==(i=e.step)&&void 0!==i?i:1,stepPrecision:e.stepPrecision,renderChanges:e.renderChanges,placeholder:e.placeholder?Array.isArray(e.placeholder)?e.placeholder[t]:e.placeholder:null});n.on("slider:mousedown",(e=>{if(this._bindAllInputs=!!e.altKey,this._bindAllInputs){n.focus();for(let e=0;e<this._inputs.length;e++)this._inputs[e].class.add(c);this.binding&&(this.binding.historyCombine=!0)}})),n.on("slider:mouseup",(()=>{this._onInputChange(n),this._bindAllInputs=!1;for(let e=0;e<this._inputs.length;e++)this._inputs[e].class.remove(c);n.blur(),this.binding&&(this.binding.historyCombine=!1)})),n.on("change",(()=>{this._onInputChange(n)})),n.on("focus",(()=>{this.emit("focus")})),n.on("blur",(()=>{this.emit("blur")})),this.dom.appendChild(n.dom),n.parent=this,this._inputs.push(n)}e.binding&&(this.binding=e.binding),void 0!==e.value&&(this.value=e.value)}_onInputChange(e){if(this._applyingChange)return;const t=this._inputs.some((e=>e.class.contains(m)));if(t?this.class.add(m):this.class.remove(m),this._bindAllInputs){const t=Array(this._inputs.length).fill(e.value);this._updateValue(t)&&this._binding&&this._binding.setValue(t)}else this.emit("change",this.value)}_updateValue(e){return this.class.remove(m),JSON.stringify(this.value)!==JSON.stringify(e)&&(this._applyingChange=!0,this._inputs.forEach(((t,s)=>{const i=t.binding;let n=!1;i&&(n=i.applyingChange,i.applyingChange=!0),t.value=e&&void 0!==e[s]?e[s]:null,i&&(i.applyingChange=n)})),this.emit("change",this.value),this._applyingChange=!1,!0)}link(e,t){super.link(e,t),e=Array.isArray(e)?e:[e];if(1===(t=Array.isArray(t)?t:[t]).length||e.length!==t.length)for(let s=0;s<this._inputs.length;s++)this._inputs[s].link(e,`${t[0]}.${s}`);else for(let s=0;s<this._inputs.length;s++)this._inputs[s].link(e,t.map((e=>`${e}.${s}`)))}unlink(){super.unlink();for(const e of this._inputs)e.unlink()}focus(){this._inputs[0].focus()}blur(){for(const e of this._inputs)e.blur()}set value(e){if("string"==typeof e)try{if(e=JSON.parse(e),Array.isArray(e)&&e.some((e=>!Number.isFinite(e))))throw new Error("VectorInput value set to string which doesn't contain an array of numbers")}catch(t){console.error(t),e=[]}Array.isArray(e)||(e=[]);this._updateValue(e)&&this._binding&&this._binding.setValue(e)}get value(){return this._inputs.map((e=>e.value))}set values(e){e=this._inputs.map(((t,s)=>e.map((e=>e?e[s]:void 0)))),this._inputs.forEach(((t,s)=>{t.values=e[s]}))}set binding(e){super.binding=e;for(const t of this._inputs)t.binding=e?e.clone():null}get binding(){return super.binding}set placeholder(e){for(let t=0;t<this._inputs.length;t++)this._inputs[t].placeholder=e[t]||e||null}get placeholder(){return this._inputs.map((e=>e.placeholder))}get inputs(){return this._inputs.slice()}set renderChanges(e){for(const t of this._inputs)t.renderChanges=e}get renderChanges(){return this._inputs[0].renderChanges}set min(e){for(const t of this._inputs)t.min=e}get min(){return this._inputs[0].min}set max(e){for(const t of this._inputs)t.max=e}get max(){return this._inputs[0].max}set precision(e){for(const t of this._inputs)t.precision=e}get precision(){return this._inputs[0].precision}set step(e){for(const t of this._inputs)t.step=e}get step(){return this._inputs[0].step}}x.register("vec2",Ge,{dimensions:2,renderChanges:!0}),x.register("vec3",Ge,{dimensions:3,renderChanges:!0}),x.register("vec4",Ge,{dimensions:4,renderChanges:!0});var We="2.5.1",je="362a874";function qe(e,t){for(var s in t){var i=t[s];Array.isArray(i)?e[s]=qe([],i):e[s]=i&&"object"==typeof i?qe({},i):i}return e}var Xe={create:()=>"xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx".replace(/[xy]/g,(e=>{var t=16*Math.random()|0;return("x"===e?t:3&t|8).toString(16)}))},Ye={delimiter:"/",join(){for(var e=arguments.length,t=new Array(e),s=0;s<e;s++)t[s]=arguments[s];for(var i=t[0],n=0;n<t.length-1;n++){var a=t[n],r=t[n+1];r[0]!==Ye.delimiter?a&&r&&a[a.length-1]!==Ye.delimiter&&r[0]!==Ye.delimiter?i+=Ye.delimiter+r:i+=r:i=r}return i},normalize(e){for(var t=e.startsWith(Ye.delimiter),s=e.endsWith(Ye.delimiter),i=e.split("/"),n="",a=[],r=0;r<i.length;r++)""!==i[r]&&"."!==i[r]&&(".."===i[r]&&a.length>0?a=a.slice(0,a.length-2):(r>0&&a.push(Ye.delimiter),a.push(i[r])));return n=a.join(""),t||n[0]!==Ye.delimiter||(n=n.slice(1)),s&&n[n.length-1]!==Ye.delimiter&&(n+=Ye.delimiter),n},split(e){var t=e.lastIndexOf(Ye.delimiter);return-1!==t?[e.substring(0,t),e.substring(t+1)]:["",e]},getBasename:e=>Ye.split(e)[1],getDirectory:e=>Ye.split(e)[0],getExtension(e){var t=e.split("?")[0].split(".").pop();return t!==e?"."+t:""},isRelativePath:e=>"/"!==e.charAt(0)&&null===e.match(/:\/\//),extractPath(e){var t="",s=e.split("/"),i=0;if(s.length>1)if(Ye.isRelativePath(e))if("."===s[0])for(i=0;i<s.length-1;++i)t+=0===i?s[i]:"/"+s[i];else if(".."===s[0])for(i=0;i<s.length-1;++i)t+=0===i?s[i]:"/"+s[i];else for(t=".",i=0;i<s.length-1;++i)t+="/"+s[i];else for(i=0;i<s.length-1;++i)t+=0===i?s[i]:"/"+s[i];return t}},$e="undefined"!=typeof navigator?navigator.userAgent:"",Ke="undefined"!=typeof window?"browser":"undefined"!=typeof global?"node":"worker",Ze=/android/i.test($e)?"android":/ip(?:[ao]d|hone)/i.test($e)?"ios":/windows/i.test($e)?"windows":/mac os/i.test($e)?"osx":/linux/i.test($e)?"linux":/cros/i.test($e)?"cros":null,Je="browser"!==Ke?null:/Chrome\/|Chromium\/|Edg.*\//.test($e)?"chrome":/Safari\//.test($e)?"safari":/Firefox\//.test($e)?"firefox":"other";(()=>{var e=!1;try{var t=Object.defineProperty({},"passive",{get:function(){return e=!0,!1}});window.addEventListener("testpassive",null,t),window.removeEventListener("testpassive",null,t)}catch(e){}})();var Qe={name:Ze,browser:"browser"===Ke,worker:"worker"===Ke,android:"android"===Ze,browserName:Je};class et{off(){this._removed||this.handler.offByHandle(this)}on(e,t,s){return void 0===s&&(s=this),this.handler._addCallback(e,t,s,!1)}once(e,t,s){return void 0===s&&(s=this),this.handler._addCallback(e,t,s,!0)}set removed(e){e&&(this._removed=!0)}get removed(){return this._removed}constructor(e,t,s,i,n=!1){this._removed=!1,this.handler=e,this.name=t,this.callback=s,this.scope=i,this._once=n}}class tt{initEventHandler(){this._callbacks=new Map,this._callbackActive=new Map}_addCallback(e,t,s,i){if(this._callbacks.has(e)||this._callbacks.set(e,[]),this._callbackActive.has(e)){var n=this._callbackActive.get(e);n&&n===this._callbacks.get(e)&&this._callbackActive.set(e,n.slice())}var a=new et(this,e,t,s,i);return this._callbacks.get(e).push(a),a}on(e,t,s){return void 0===s&&(s=this),this._addCallback(e,t,s,!1)}once(e,t,s){return void 0===s&&(s=this),this._addCallback(e,t,s,!0)}off(e,t,s){if(e)this._callbackActive.has(e)&&this._callbackActive.get(e)===this._callbacks.get(e)&&this._callbackActive.set(e,this._callbackActive.get(e).slice());else for(var[i,n]of this._callbackActive)this._callbacks.has(i)&&this._callbacks.get(i)===n&&this._callbackActive.set(i,n.slice());if(e)if(t){var a=this._callbacks.get(e);if(!a)return this;for(var r=0;r<a.length;r++)a[r].callback===t&&(s&&a[r].scope!==s||(a[r].removed=!0,a.splice(r,1),r--));0===a.length&&this._callbacks.delete(e)}else{var o=this._callbacks.get(e);if(o){for(var l=0;l<o.length;l++)o[l].removed=!0;this._callbacks.delete(e)}}else{for(var h of this._callbacks.values())for(var c=0;c<h.length;c++)h[c].removed=!0;this._callbacks.clear()}return this}offByHandle(e){var t=e.name;e.removed=!0,this._callbackActive.has(t)&&this._callbackActive.get(t)===this._callbacks.get(t)&&this._callbackActive.set(t,this._callbackActive.get(t).slice());var s=this._callbacks.get(t);if(!s)return this;var i=s.indexOf(e);return-1!==i&&(s.splice(i,1),0===s.length&&this._callbacks.delete(t)),this}fire(e,t,s,i,n,a,r,o,l){if(!e)return this;var h,c=this._callbacks.get(e);if(!c)return this;this._callbackActive.has(e)?this._callbackActive.get(e)!==c&&(h=c.slice()):this._callbackActive.set(e,c);for(var d=0;(h||this._callbackActive.get(e))&&d<(h||this._callbackActive.get(e)).length;d++){var u=(h||this._callbackActive.get(e))[d];if(u.callback&&(u.callback.call(u.scope,t,s,i,n,a,r,o,l),u._once)){var p=this._callbacks.get(e),m=p?p.indexOf(u):-1;if(-1!==m){this._callbackActive.get(e)===p&&this._callbackActive.set(e,this._callbackActive.get(e).slice());var f=this._callbacks.get(e);if(!f)continue;f[m].removed=!0,f.splice(m,1),0===f.length&&this._callbacks.delete(e)}}}return h||this._callbackActive.delete(e),this}hasEvent(e){var t;return!!(null==(t=this._callbacks.get(e))?void 0:t.length)}constructor(){this._callbacks=new Map,this._callbackActive=new Map}}var st,it,nt;class at{static loadScript(e,t){var s=document.createElement("script");s.setAttribute("src",e),s.onload=()=>{t(null)},s.onerror=()=>{t("Failed to load script='"+e+"'")},document.body.appendChild(s)}static loadWasm(e,t,s){var i=at.wasmSupported()&&t.glueUrl&&t.wasmUrl?t.glueUrl:t.fallbackUrl;i?at.loadScript(i,(i=>{if(i)s(i,null);else{var n=window[e];window[e]=void 0,n({locateFile:()=>t.wasmUrl,onAbort:()=>{s("wasm module aborted.")}}).then((e=>{s(null,e)}))}})):s("No supported wasm modules found.",null)}static getModule(e){return at.modules.hasOwnProperty(e)||(at.modules[e]={config:null,initializing:!1,instance:null,callbacks:[]}),at.modules[e]}static initialize(e,t){if(!t.initializing){var s=t.config;(s.glueUrl||s.wasmUrl||s.fallbackUrl)&&(t.initializing=!0,at.loadWasm(e,s,((i,n)=>{i?s.errorHandler?s.errorHandler(i):console.error("failed to initialize module="+e+" error="+i):(t.instance=n,t.callbacks.forEach((e=>{e(n)})))})))}}}at.modules={},at.wasmSupported=(st=()=>{try{if("object"==typeof WebAssembly&&"function"==typeof WebAssembly.instantiate){var e=new WebAssembly.Module(Uint8Array.of(0,97,115,109,1,0,0,0));if(e instanceof WebAssembly.Module)return new WebAssembly.Instance(e)instanceof WebAssembly.Instance}}catch(e){}return!1},nt=it={},()=>(nt===it&&(nt=st()),nt));class rt{static setConfig(e,t){var s=at.getModule(e);s.config=t,s.callbacks.length>0&&at.initialize(e,s)}static getConfig(e){var t,s;return null==(s=at.modules)||null==(t=s[e])?void 0:t.config}static getInstance(e,t){var s=at.getModule(e);s.instance?t(s.instance):(s.callbacks.push(t),s.config&&at.initialize(e,s))}}class ot{get remainingBytes(){return this.dataView.byteLength-this.offset}reset(e){void 0===e&&(e=0),this.offset=e}skip(e){this.offset+=e}align(e){this.offset=this.offset+e-1&~(e-1)}_inc(e){return this.offset+=e,this.offset-e}readChar(){return String.fromCharCode(this.dataView.getUint8(this.offset++))}readChars(e){for(var t="",s=0;s<e;++s)t+=this.readChar();return t}readU8(){return this.dataView.getUint8(this.offset++)}readU16(){return this.dataView.getUint16(this._inc(2),!0)}readU32(){return this.dataView.getUint32(this._inc(4),!0)}readU64(){return this.readU32()+2**32*this.readU32()}readU32be(){return this.dataView.getUint32(this._inc(4),!1)}readArray(e){for(var t=0;t<e.length;++t)e[t]=this.readU8()}readLine(){for(var e=this.dataView,t="";!(this.offset>=e.byteLength);){var s=String.fromCharCode(this.readU8());if("\n"===s)break;t+=s}return t}constructor(e){this.offset=0,this.arraybuffer=e,this.dataView=new DataView(e)}}class lt extends tt{add(){for(var e=arguments.length,t=new Array(e),s=0;s<e;s++)t[s]=arguments[s];var i=!1,n=this._processArguments(t,!0);if(!n.length)return i;for(var a=0;a<n.length;a++)this._index[n[a]]||(i=!0,this._index[n[a]]=!0,this._list.push(n[a]),this.fire("add",n[a],this._parent));return i&&this.fire("change",this._parent),i}remove(){for(var e=arguments.length,t=new Array(e),s=0;s<e;s++)t[s]=arguments[s];var i=!1;if(!this._list.length)return i;var n=this._processArguments(t,!0);if(!n.length)return i;for(var a=0;a<n.length;a++)this._index[n[a]]&&(i=!0,delete this._index[n[a]],this._list.splice(this._list.indexOf(n[a]),1),this.fire("remove",n[a],this._parent));return i&&this.fire("change",this._parent),i}clear(){if(this._list.length){var e=this._list.slice(0);this._list=[],this._index={};for(var t=0;t<e.length;t++)this.fire("remove",e[t],this._parent);this.fire("change",this._parent)}}has(){for(var e=arguments.length,t=new Array(e),s=0;s<e;s++)t[s]=arguments[s];return!!this._list.length&&this._has(this._processArguments(t))}_has(e){if(!this._list.length||!e.length)return!1;for(var t=0;t<e.length;t++)if(1===e[t].length){if(this._index[e[t][0]])return!0}else{for(var s=!0,i=0;i<e[t].length;i++)if(!this._index[e[t][i]]){s=!1;break}if(s)return!0}return!1}list(){return this._list.slice(0)}_processArguments(e,t){var s=[],i=[];if(!e||!e.length)return s;for(var n=0;n<e.length;n++)if(e[n]instanceof Array){t||(i=[]);for(var a=0;a<e[n].length;a++)"string"==typeof e[n][a]&&(t?s.push(e[n][a]):i.push(e[n][a]));!t&&i.length&&s.push(i)}else"string"==typeof e[n]&&(t?s.push(e[n]):s.push([e[n]]));return s}get size(){return this._list.length}constructor(e){super(),this._index={},this._list=[],this._parent=e}}lt.EVENT_ADD="add",lt.EVENT_REMOVE="remove",lt.EVENT_CHANGE="change";var ht="undefined"!=typeof window&&window.performance&&window.performance.now?performance.now.bind(performance):Date.now,ct=/^(([^:/?#]+):)?(\/\/([^/?#]*))?([^?#]*)(\?([^#]*))?(#(.*))?/;class dt{toString(){var e="";return this.scheme&&(e+=this.scheme+":"),this.authority&&(e+="//"+this.authority),e+=this.path,this.query&&(e+="?"+this.query),this.fragment&&(e+="#"+this.fragment),e}getQuery(){var e={};if(this.query){var t=decodeURIComponent(this.query).split("&");for(var s of t){var i=s.split("=");e[i[0]]=i[1]}}return e}setQuery(e){var t="";for(var s in e)e.hasOwnProperty(s)&&(""!==t&&(t+="&"),t+=encodeURIComponent(s)+"="+encodeURIComponent(e[s]));this.query=t}constructor(e){var t=e.match(ct);this.scheme=t[2],this.authority=t[4],this.path=t[5],this.query=t[7],this.fragment=t[9]}}class ut{static set(e,t){}static get(e){return ut._traceChannels.has(e)}}ut._traceChannels=new Set,ut.stack=!1;var pt={DEG_TO_RAD:Math.PI/180,RAD_TO_DEG:180/Math.PI,clamp:(e,t,s)=>e>=s?s:e<=t?t:e,intToBytes24:e=>[e>>16&255,e>>8&255,255&e],intToBytes32:e=>[e>>24&255,e>>16&255,e>>8&255,255&e],bytesToInt24:(e,t,s)=>(e.length&&(s=e[2],t=e[1],e=e[0]),e<<16|t<<8|s),bytesToInt32:(e,t,s,i)=>(e.length&&(i=e[3],s=e[2],t=e[1],e=e[0]),(e<<24|t<<16|s<<8|i)>>>0),lerp:(e,t,s)=>e+(t-e)*pt.clamp(s,0,1),lerpAngle:(e,t,s)=>(t-e>180&&(t-=360),t-e<-180&&(t+=360),pt.lerp(e,t,pt.clamp(s,0,1))),powerOfTwo:e=>0!==e&&!(e&e-1),nextPowerOfTwo:e=>(e--,e|=e>>1,e|=e>>2,e|=e>>4,e|=e>>8,e|=e>>16,++e),nearestPowerOfTwo:e=>Math.pow(2,Math.round(Math.log(e)/Math.log(2))),random(e,t){var s=t-e;return Math.random()*s+e},smoothstep:(e,t,s)=>s<=e?0:s>=t?1:(s=(s-e)/(t-e))*s*(3-2*s),smootherstep:(e,t,s)=>s<=e?0:s>=t?1:(s=(s-e)/(t-e))*s*s*(s*(6*s-15)+10),roundUp:(e,t)=>0===t?e:Math.ceil(e/t)*t,between(e,t,s,i){var n=Math.min(t,s),a=Math.max(t,s);return i?e>=n&&e<=a:e>n&&e<a}};class mt{clone(){return new(0,this.constructor)(this.r,this.g,this.b,this.a)}copy(e){return this.r=e.r,this.g=e.g,this.b=e.b,this.a=e.a,this}equals(e){return this.r===e.r&&this.g===e.g&&this.b===e.b&&this.a===e.a}set(e,t,s,i){return void 0===i&&(i=1),this.r=e,this.g=t,this.b=s,this.a=i,this}lerp(e,t,s){return this.r=e.r+s*(t.r-e.r),this.g=e.g+s*(t.g-e.g),this.b=e.b+s*(t.b-e.b),this.a=e.a+s*(t.a-e.a),this}linear(e){return void 0===e&&(e=this),this.r=Math.pow(e.r,2.2),this.g=Math.pow(e.g,2.2),this.b=Math.pow(e.b,2.2),this.a=e.a,this}gamma(e){return void 0===e&&(e=this),this.r=Math.pow(e.r,1/2.2),this.g=Math.pow(e.g,1/2.2),this.b=Math.pow(e.b,1/2.2),this.a=e.a,this}mulScalar(e){return this.r*=e,this.g*=e,this.b*=e,this}fromString(e){var t,s=parseInt(e.replace("#","0x"),16);return e.length>7?t=pt.intToBytes32(s):(t=pt.intToBytes24(s))[3]=255,this.set(t[0]/255,t[1]/255,t[2]/255,t[3]/255),this}fromArray(e,t){var s,i,n,a;return void 0===t&&(t=0),this.r=null!=(s=e[t])?s:this.r,this.g=null!=(i=e[t+1])?i:this.g,this.b=null!=(n=e[t+2])?n:this.b,this.a=null!=(a=e[t+3])?a:this.a,this}toString(e,t){var{r:s,g:i,b:n,a:a}=this;if(t||s>1||i>1||n>1)return s.toFixed(3)+", "+i.toFixed(3)+", "+n.toFixed(3)+", "+a.toFixed(3);var r="#"+((1<<24)+(Math.round(255*s)<<16)+(Math.round(255*i)<<8)+Math.round(255*n)).toString(16).slice(1);if(!0===e){var o=Math.round(255*a).toString(16);this.a<16/255?r+="0"+o:r+=o}return r}toArray(e,t,s){return void 0===e&&(e=[]),void 0===t&&(t=0),void 0===s&&(s=!0),e[t]=this.r,e[t+1]=this.g,e[t+2]=this.b,s&&(e[t+3]=this.a),e}constructor(e=0,t=0,s=0,i=1){var n,a=e.length;3===a||4===a?(this.r=e[0],this.g=e[1],this.b=e[2],this.a=null!=(n=e[3])?n:1):(this.r=e,this.g=t,this.b=s,this.a=i)}}mt.BLACK=Object.freeze(new mt(0,0,0,1)),mt.BLUE=Object.freeze(new mt(0,0,1,1)),mt.CYAN=Object.freeze(new mt(0,1,1,1)),mt.GRAY=Object.freeze(new mt(.5,.5,.5,1)),mt.GREEN=Object.freeze(new mt(0,1,0,1)),mt.MAGENTA=Object.freeze(new mt(1,0,1,1)),mt.RED=Object.freeze(new mt(1,0,0,1)),mt.WHITE=Object.freeze(new mt(1,1,1,1)),mt.YELLOW=Object.freeze(new mt(1,1,0,1));var ft=1/255,gt=new Float32Array(1),vt=new Int32Array(gt.buffer);class _t{static float2Half(e){gt[0]=e;var t=vt[0],s=t>>16&32768,i=t>>12&2047,n=t>>23&255;return n<103?s:n>142?(s|=31744,s|=(255===n?0:1)&&8388607&t):n<113?s|=((i|=2048)>>114-n)+(i>>113-n&1):(s|=n-112<<10|i>>1,s+=1&i)}static float2Bytes(e,t,s,i){var n=255*e%1;if(t[s+0]=Math.round(255*(e%1-ft*n)),i>1){var a=65025*e%1;if(t[s+1]=Math.round(255*(n-ft*a)),i>2){var r=16581375*e%1;t[s+2]=Math.round(255*(a-ft*r)),i>3&&(t[s+3]=Math.round(255*r))}}}static float2BytesRange(e,t,s,i,n,a){e=pt.clamp((e-i)/(n-i),0,1),_t.float2Bytes(e,t,s,a)}static float2RGBA8(e,t){gt[0]=e;var s=vt[0];t.r=(s>>24&255)/255,t.g=(s>>16&255)/255,t.b=(s>>8&255)/255,t.a=(255&s)/255}}class yt{add(e){return this.x+=e.x,this.y+=e.y,this.z+=e.z,this}add2(e,t){return this.x=e.x+t.x,this.y=e.y+t.y,this.z=e.z+t.z,this}addScalar(e){return this.x+=e,this.y+=e,this.z+=e,this}addScaled(e,t){return this.x+=e.x*t,this.y+=e.y*t,this.z+=e.z*t,this}clone(){return new(0,this.constructor)(this.x,this.y,this.z)}copy(e){return this.x=e.x,this.y=e.y,this.z=e.z,this}cross(e,t){var s=e.x,i=e.y,n=e.z,a=t.x,r=t.y,o=t.z;return this.x=i*o-r*n,this.y=n*a-o*s,this.z=s*r-a*i,this}distance(e){var t=this.x-e.x,s=this.y-e.y,i=this.z-e.z;return Math.sqrt(t*t+s*s+i*i)}div(e){return this.x/=e.x,this.y/=e.y,this.z/=e.z,this}div2(e,t){return this.x=e.x/t.x,this.y=e.y/t.y,this.z=e.z/t.z,this}divScalar(e){return this.x/=e,this.y/=e,this.z/=e,this}dot(e){return this.x*e.x+this.y*e.y+this.z*e.z}equals(e){return this.x===e.x&&this.y===e.y&&this.z===e.z}equalsApprox(e,t){return void 0===t&&(t=1e-6),Math.abs(this.x-e.x)<t&&Math.abs(this.y-e.y)<t&&Math.abs(this.z-e.z)<t}length(){return Math.sqrt(this.x*this.x+this.y*this.y+this.z*this.z)}lengthSq(){return this.x*this.x+this.y*this.y+this.z*this.z}lerp(e,t,s){return this.x=e.x+s*(t.x-e.x),this.y=e.y+s*(t.y-e.y),this.z=e.z+s*(t.z-e.z),this}mul(e){return this.x*=e.x,this.y*=e.y,this.z*=e.z,this}mul2(e,t){return this.x=e.x*t.x,this.y=e.y*t.y,this.z=e.z*t.z,this}mulScalar(e){return this.x*=e,this.y*=e,this.z*=e,this}normalize(e){void 0===e&&(e=this);var t=e.x*e.x+e.y*e.y+e.z*e.z;if(t>0){var s=1/Math.sqrt(t);this.x=e.x*s,this.y=e.y*s,this.z=e.z*s}return this}floor(e){return void 0===e&&(e=this),this.x=Math.floor(e.x),this.y=Math.floor(e.y),this.z=Math.floor(e.z),this}ceil(e){return void 0===e&&(e=this),this.x=Math.ceil(e.x),this.y=Math.ceil(e.y),this.z=Math.ceil(e.z),this}round(e){return void 0===e&&(e=this),this.x=Math.round(e.x),this.y=Math.round(e.y),this.z=Math.round(e.z),this}min(e){return e.x<this.x&&(this.x=e.x),e.y<this.y&&(this.y=e.y),e.z<this.z&&(this.z=e.z),this}max(e){return e.x>this.x&&(this.x=e.x),e.y>this.y&&(this.y=e.y),e.z>this.z&&(this.z=e.z),this}project(e){var t=(this.x*e.x+this.y*e.y+this.z*e.z)/(e.x*e.x+e.y*e.y+e.z*e.z);return this.x=e.x*t,this.y=e.y*t,this.z=e.z*t,this}set(e,t,s){return this.x=e,this.y=t,this.z=s,this}sub(e){return this.x-=e.x,this.y-=e.y,this.z-=e.z,this}sub2(e,t){return this.x=e.x-t.x,this.y=e.y-t.y,this.z=e.z-t.z,this}subScalar(e){return this.x-=e,this.y-=e,this.z-=e,this}fromArray(e,t){var s,i,n;return void 0===t&&(t=0),this.x=null!=(s=e[t])?s:this.x,this.y=null!=(i=e[t+1])?i:this.y,this.z=null!=(n=e[t+2])?n:this.z,this}toString(){return"["+this.x+", "+this.y+", "+this.z+"]"}toArray(e,t){return void 0===e&&(e=[]),void 0===t&&(t=0),e[t]=this.x,e[t+1]=this.y,e[t+2]=this.z,e}constructor(e=0,t=0,s=0){3===e.length?(this.x=e[0],this.y=e[1],this.z=e[2]):(this.x=e,this.y=t,this.z=s)}}yt.ZERO=Object.freeze(new yt(0,0,0)),yt.HALF=Object.freeze(new yt(.5,.5,.5)),yt.ONE=Object.freeze(new yt(1,1,1)),yt.UP=Object.freeze(new yt(0,1,0)),yt.DOWN=Object.freeze(new yt(0,-1,0)),yt.RIGHT=Object.freeze(new yt(1,0,0)),yt.LEFT=Object.freeze(new yt(-1,0,0)),yt.FORWARD=Object.freeze(new yt(0,0,-1)),yt.BACK=Object.freeze(new yt(0,0,1));class xt{clone(){return(new(0,this.constructor)).copy(this)}copy(e){var t=e.data,s=this.data;return s[0]=t[0],s[1]=t[1],s[2]=t[2],s[3]=t[3],s[4]=t[4],s[5]=t[5],s[6]=t[6],s[7]=t[7],s[8]=t[8],this}set(e){var t=this.data;return t[0]=e[0],t[1]=e[1],t[2]=e[2],t[3]=e[3],t[4]=e[4],t[5]=e[5],t[6]=e[6],t[7]=e[7],t[8]=e[8],this}getX(e){return void 0===e&&(e=new yt),e.set(this.data[0],this.data[1],this.data[2])}getY(e){return void 0===e&&(e=new yt),e.set(this.data[3],this.data[4],this.data[5])}getZ(e){return void 0===e&&(e=new yt),e.set(this.data[6],this.data[7],this.data[8])}equals(e){var t=this.data,s=e.data;return t[0]===s[0]&&t[1]===s[1]&&t[2]===s[2]&&t[3]===s[3]&&t[4]===s[4]&&t[5]===s[5]&&t[6]===s[6]&&t[7]===s[7]&&t[8]===s[8]}isIdentity(){var e=this.data;return 1===e[0]&&0===e[1]&&0===e[2]&&0===e[3]&&1===e[4]&&0===e[5]&&0===e[6]&&0===e[7]&&1===e[8]}setIdentity(){var e=this.data;return e[0]=1,e[1]=0,e[2]=0,e[3]=0,e[4]=1,e[5]=0,e[6]=0,e[7]=0,e[8]=1,this}toString(){return"["+this.data.join(", ")+"]"}transpose(e){void 0===e&&(e=this);var t,s=e.data,i=this.data;s===i?(t=s[1],i[1]=s[3],i[3]=t,t=s[2],i[2]=s[6],i[6]=t,t=s[5],i[5]=s[7],i[7]=t):(i[0]=s[0],i[1]=s[3],i[2]=s[6],i[3]=s[1],i[4]=s[4],i[5]=s[7],i[6]=s[2],i[7]=s[5],i[8]=s[8]);return this}setFromMat4(e){var t=e.data,s=this.data;return s[0]=t[0],s[1]=t[1],s[2]=t[2],s[3]=t[4],s[4]=t[5],s[5]=t[6],s[6]=t[8],s[7]=t[9],s[8]=t[10],this}setFromQuat(e){var t=e.x,s=e.y,i=e.z,n=e.w,a=t+t,r=s+s,o=i+i,l=t*a,h=t*r,c=t*o,d=s*r,u=s*o,p=i*o,m=n*a,f=n*r,g=n*o,v=this.data;return v[0]=1-(d+p),v[1]=h+g,v[2]=c-f,v[3]=h-g,v[4]=1-(l+p),v[5]=u+m,v[6]=c+f,v[7]=u-m,v[8]=1-(l+d),this}invertMat4(e){var t=e.data,s=t[0],i=t[1],n=t[2],a=t[4],r=t[5],o=t[6],l=t[8],h=t[9],c=t[10],d=c*r-o*h,u=-c*i+n*h,p=o*i-n*r,m=-c*a+o*l,f=c*s-n*l,g=-o*s+n*a,v=h*a-r*l,_=-h*s+i*l,y=r*s-i*a,x=s*d+i*m+n*v;if(0===x)this.setIdentity();else{var w=1/x,b=this.data;b[0]=d*w,b[1]=u*w,b[2]=p*w,b[3]=m*w,b[4]=f*w,b[5]=g*w,b[6]=v*w,b[7]=_*w,b[8]=y*w}return this}transformVector(e,t){void 0===t&&(t=new yt);var s=this.data,{x:i,y:n,z:a}=e;return t.x=i*s[0]+n*s[3]+a*s[6],t.y=i*s[1]+n*s[4]+a*s[7],t.z=i*s[2]+n*s[5]+a*s[8],t}constructor(){this.data=new Float32Array(9),this.data[0]=this.data[4]=this.data[8]=1}}xt.IDENTITY=Object.freeze(new xt),xt.ZERO=Object.freeze((new xt).set([0,0,0,0,0,0,0,0,0]));class wt{add(e){return this.x+=e.x,this.y+=e.y,this}add2(e,t){return this.x=e.x+t.x,this.y=e.y+t.y,this}addScalar(e){return this.x+=e,this.y+=e,this}addScaled(e,t){return this.x+=e.x*t,this.y+=e.y*t,this}clone(){return new(0,this.constructor)(this.x,this.y)}copy(e){return this.x=e.x,this.y=e.y,this}cross(e){return this.x*e.y-this.y*e.x}distance(e){var t=this.x-e.x,s=this.y-e.y;return Math.sqrt(t*t+s*s)}div(e){return this.x/=e.x,this.y/=e.y,this}div2(e,t){return this.x=e.x/t.x,this.y=e.y/t.y,this}divScalar(e){return this.x/=e,this.y/=e,this}dot(e){return this.x*e.x+this.y*e.y}equals(e){return this.x===e.x&&this.y===e.y}equalsApprox(e,t){return void 0===t&&(t=1e-6),Math.abs(this.x-e.x)<t&&Math.abs(this.y-e.y)<t}length(){return Math.sqrt(this.x*this.x+this.y*this.y)}lengthSq(){return this.x*this.x+this.y*this.y}lerp(e,t,s){return this.x=e.x+s*(t.x-e.x),this.y=e.y+s*(t.y-e.y),this}mul(e){return this.x*=e.x,this.y*=e.y,this}mul2(e,t){return this.x=e.x*t.x,this.y=e.y*t.y,this}mulScalar(e){return this.x*=e,this.y*=e,this}normalize(e){void 0===e&&(e=this);var t=e.x*e.x+e.y*e.y;if(t>0){var s=1/Math.sqrt(t);this.x=e.x*s,this.y=e.y*s}return this}rotate(e){var t=Math.atan2(this.x,this.y)+e*pt.DEG_TO_RAD,s=Math.sqrt(this.x*this.x+this.y*this.y);return this.x=Math.sin(t)*s,this.y=Math.cos(t)*s,this}angle(){return Math.atan2(this.x,this.y)*pt.RAD_TO_DEG}angleTo(e){return Math.atan2(this.x*e.y+this.y*e.x,this.x*e.x+this.y*e.y)*pt.RAD_TO_DEG}floor(e){return void 0===e&&(e=this),this.x=Math.floor(e.x),this.y=Math.floor(e.y),this}ceil(e){return void 0===e&&(e=this),this.x=Math.ceil(e.x),this.y=Math.ceil(e.y),this}round(e){return void 0===e&&(e=this),this.x=Math.round(e.x),this.y=Math.round(e.y),this}min(e){return e.x<this.x&&(this.x=e.x),e.y<this.y&&(this.y=e.y),this}max(e){return e.x>this.x&&(this.x=e.x),e.y>this.y&&(this.y=e.y),this}set(e,t){return this.x=e,this.y=t,this}sub(e){return this.x-=e.x,this.y-=e.y,this}sub2(e,t){return this.x=e.x-t.x,this.y=e.y-t.y,this}subScalar(e){return this.x-=e,this.y-=e,this}fromArray(e,t){var s,i;return void 0===t&&(t=0),this.x=null!=(s=e[t])?s:this.x,this.y=null!=(i=e[t+1])?i:this.y,this}toString(){return"["+this.x+", "+this.y+"]"}toArray(e,t){return void 0===e&&(e=[]),void 0===t&&(t=0),e[t]=this.x,e[t+1]=this.y,e}static angleRad(e,t){return Math.atan2(e.x*t.y-e.y*t.x,e.x*t.x+e.y*t.y)}constructor(e=0,t=0){2===e.length?(this.x=e[0],this.y=e[1]):(this.x=e,this.y=t)}}wt.ZERO=Object.freeze(new wt(0,0)),wt.HALF=Object.freeze(new wt(.5,.5)),wt.ONE=Object.freeze(new wt(1,1)),wt.UP=Object.freeze(new wt(0,1)),wt.DOWN=Object.freeze(new wt(0,-1)),wt.RIGHT=Object.freeze(new wt(1,0)),wt.LEFT=Object.freeze(new wt(-1,0));class bt{add(e){return this.x+=e.x,this.y+=e.y,this.z+=e.z,this.w+=e.w,this}add2(e,t){return this.x=e.x+t.x,this.y=e.y+t.y,this.z=e.z+t.z,this.w=e.w+t.w,this}addScalar(e){return this.x+=e,this.y+=e,this.z+=e,this.w+=e,this}addScaled(e,t){return this.x+=e.x*t,this.y+=e.y*t,this.z+=e.z*t,this.w+=e.w*t,this}clone(){return new(0,this.constructor)(this.x,this.y,this.z,this.w)}copy(e){return this.x=e.x,this.y=e.y,this.z=e.z,this.w=e.w,this}div(e){return this.x/=e.x,this.y/=e.y,this.z/=e.z,this.w/=e.w,this}div2(e,t){return this.x=e.x/t.x,this.y=e.y/t.y,this.z=e.z/t.z,this.w=e.w/t.w,this}divScalar(e){return this.x/=e,this.y/=e,this.z/=e,this.w/=e,this}dot(e){return this.x*e.x+this.y*e.y+this.z*e.z+this.w*e.w}equals(e){return this.x===e.x&&this.y===e.y&&this.z===e.z&&this.w===e.w}equalsApprox(e,t){return void 0===t&&(t=1e-6),Math.abs(this.x-e.x)<t&&Math.abs(this.y-e.y)<t&&Math.abs(this.z-e.z)<t&&Math.abs(this.w-e.w)<t}length(){return Math.sqrt(this.x*this.x+this.y*this.y+this.z*this.z+this.w*this.w)}lengthSq(){return this.x*this.x+this.y*this.y+this.z*this.z+this.w*this.w}lerp(e,t,s){return this.x=e.x+s*(t.x-e.x),this.y=e.y+s*(t.y-e.y),this.z=e.z+s*(t.z-e.z),this.w=e.w+s*(t.w-e.w),this}mul(e){return this.x*=e.x,this.y*=e.y,this.z*=e.z,this.w*=e.w,this}mul2(e,t){return this.x=e.x*t.x,this.y=e.y*t.y,this.z=e.z*t.z,this.w=e.w*t.w,this}mulScalar(e){return this.x*=e,this.y*=e,this.z*=e,this.w*=e,this}normalize(e){void 0===e&&(e=this);var t=e.x*e.x+e.y*e.y+e.z*e.z+e.w*e.w;if(t>0){var s=1/Math.sqrt(t);this.x=e.x*s,this.y=e.y*s,this.z=e.z*s,this.w=e.w*s}return this}floor(e){return void 0===e&&(e=this),this.x=Math.floor(e.x),this.y=Math.floor(e.y),this.z=Math.floor(e.z),this.w=Math.floor(e.w),this}ceil(e){return void 0===e&&(e=this),this.x=Math.ceil(e.x),this.y=Math.ceil(e.y),this.z=Math.ceil(e.z),this.w=Math.ceil(e.w),this}round(e){return void 0===e&&(e=this),this.x=Math.round(e.x),this.y=Math.round(e.y),this.z=Math.round(e.z),this.w=Math.round(e.w),this}min(e){return e.x<this.x&&(this.x=e.x),e.y<this.y&&(this.y=e.y),e.z<this.z&&(this.z=e.z),e.w<this.w&&(this.w=e.w),this}max(e){return e.x>this.x&&(this.x=e.x),e.y>this.y&&(this.y=e.y),e.z>this.z&&(this.z=e.z),e.w>this.w&&(this.w=e.w),this}set(e,t,s,i){return this.x=e,this.y=t,this.z=s,this.w=i,this}sub(e){return this.x-=e.x,this.y-=e.y,this.z-=e.z,this.w-=e.w,this}sub2(e,t){return this.x=e.x-t.x,this.y=e.y-t.y,this.z=e.z-t.z,this.w=e.w-t.w,this}subScalar(e){return this.x-=e,this.y-=e,this.z-=e,this.w-=e,this}fromArray(e,t){var s,i,n,a;return void 0===t&&(t=0),this.x=null!=(s=e[t])?s:this.x,this.y=null!=(i=e[t+1])?i:this.y,this.z=null!=(n=e[t+2])?n:this.z,this.w=null!=(a=e[t+3])?a:this.w,this}toString(){return"["+this.x+", "+this.y+", "+this.z+", "+this.w+"]"}toArray(e,t){return void 0===e&&(e=[]),void 0===t&&(t=0),e[t]=this.x,e[t+1]=this.y,e[t+2]=this.z,e[t+3]=this.w,e}constructor(e=0,t=0,s=0,i=0){4===e.length?(this.x=e[0],this.y=e[1],this.z=e[2],this.w=e[3]):(this.x=e,this.y=t,this.z=s,this.w=i)}}bt.ZERO=Object.freeze(new bt(0,0,0,0)),bt.HALF=Object.freeze(new bt(.5,.5,.5,.5)),bt.ONE=Object.freeze(new bt(1,1,1,1));var Ct=new wt,St=new yt,At=new yt,Tt=new yt,Pt=new yt;class Et{static _getPerspectiveHalfSize(e,t,s,i,n){n?(e.x=i*Math.tan(t*Math.PI/360),e.y=e.x/s):(e.y=i*Math.tan(t*Math.PI/360),e.x=e.y*s)}add2(e,t){var s=e.data,i=t.data,n=this.data;return n[0]=s[0]+i[0],n[1]=s[1]+i[1],n[2]=s[2]+i[2],n[3]=s[3]+i[3],n[4]=s[4]+i[4],n[5]=s[5]+i[5],n[6]=s[6]+i[6],n[7]=s[7]+i[7],n[8]=s[8]+i[8],n[9]=s[9]+i[9],n[10]=s[10]+i[10],n[11]=s[11]+i[11],n[12]=s[12]+i[12],n[13]=s[13]+i[13],n[14]=s[14]+i[14],n[15]=s[15]+i[15],this}add(e){return this.add2(this,e)}clone(){return(new(0,this.constructor)).copy(this)}copy(e){var t=e.data,s=this.data;return s[0]=t[0],s[1]=t[1],s[2]=t[2],s[3]=t[3],s[4]=t[4],s[5]=t[5],s[6]=t[6],s[7]=t[7],s[8]=t[8],s[9]=t[9],s[10]=t[10],s[11]=t[11],s[12]=t[12],s[13]=t[13],s[14]=t[14],s[15]=t[15],this}equals(e){var t=this.data,s=e.data;return t[0]===s[0]&&t[1]===s[1]&&t[2]===s[2]&&t[3]===s[3]&&t[4]===s[4]&&t[5]===s[5]&&t[6]===s[6]&&t[7]===s[7]&&t[8]===s[8]&&t[9]===s[9]&&t[10]===s[10]&&t[11]===s[11]&&t[12]===s[12]&&t[13]===s[13]&&t[14]===s[14]&&t[15]===s[15]}isIdentity(){var e=this.data;return 1===e[0]&&0===e[1]&&0===e[2]&&0===e[3]&&0===e[4]&&1===e[5]&&0===e[6]&&0===e[7]&&0===e[8]&&0===e[9]&&1===e[10]&&0===e[11]&&0===e[12]&&0===e[13]&&0===e[14]&&1===e[15]}mul2(e,t){var s,i,n,a,r=e.data,o=t.data,l=this.data,h=r[0],c=r[1],d=r[2],u=r[3],p=r[4],m=r[5],f=r[6],g=r[7],v=r[8],_=r[9],y=r[10],x=r[11],w=r[12],b=r[13],C=r[14],S=r[15];return s=o[0],i=o[1],n=o[2],a=o[3],l[0]=h*s+p*i+v*n+w*a,l[1]=c*s+m*i+_*n+b*a,l[2]=d*s+f*i+y*n+C*a,l[3]=u*s+g*i+x*n+S*a,s=o[4],i=o[5],n=o[6],a=o[7],l[4]=h*s+p*i+v*n+w*a,l[5]=c*s+m*i+_*n+b*a,l[6]=d*s+f*i+y*n+C*a,l[7]=u*s+g*i+x*n+S*a,s=o[8],i=o[9],n=o[10],a=o[11],l[8]=h*s+p*i+v*n+w*a,l[9]=c*s+m*i+_*n+b*a,l[10]=d*s+f*i+y*n+C*a,l[11]=u*s+g*i+x*n+S*a,s=o[12],i=o[13],n=o[14],a=o[15],l[12]=h*s+p*i+v*n+w*a,l[13]=c*s+m*i+_*n+b*a,l[14]=d*s+f*i+y*n+C*a,l[15]=u*s+g*i+x*n+S*a,this}mulAffine2(e,t){var s,i,n,a=e.data,r=t.data,o=this.data,l=a[0],h=a[1],c=a[2],d=a[4],u=a[5],p=a[6],m=a[8],f=a[9],g=a[10],v=a[12],_=a[13],y=a[14];return s=r[0],i=r[1],n=r[2],o[0]=l*s+d*i+m*n,o[1]=h*s+u*i+f*n,o[2]=c*s+p*i+g*n,o[3]=0,s=r[4],i=r[5],n=r[6],o[4]=l*s+d*i+m*n,o[5]=h*s+u*i+f*n,o[6]=c*s+p*i+g*n,o[7]=0,s=r[8],i=r[9],n=r[10],o[8]=l*s+d*i+m*n,o[9]=h*s+u*i+f*n,o[10]=c*s+p*i+g*n,o[11]=0,s=r[12],i=r[13],n=r[14],o[12]=l*s+d*i+m*n+v,o[13]=h*s+u*i+f*n+_,o[14]=c*s+p*i+g*n+y,o[15]=1,this}mul(e){return this.mul2(this,e)}transformPoint(e,t){void 0===t&&(t=new yt);var s=this.data,{x:i,y:n,z:a}=e;return t.x=i*s[0]+n*s[4]+a*s[8]+s[12],t.y=i*s[1]+n*s[5]+a*s[9]+s[13],t.z=i*s[2]+n*s[6]+a*s[10]+s[14],t}transformVector(e,t){void 0===t&&(t=new yt);var s=this.data,{x:i,y:n,z:a}=e;return t.x=i*s[0]+n*s[4]+a*s[8],t.y=i*s[1]+n*s[5]+a*s[9],t.z=i*s[2]+n*s[6]+a*s[10],t}transformVec4(e,t){void 0===t&&(t=new bt);var s=this.data,{x:i,y:n,z:a,w:r}=e;return t.x=i*s[0]+n*s[4]+a*s[8]+r*s[12],t.y=i*s[1]+n*s[5]+a*s[9]+r*s[13],t.z=i*s[2]+n*s[6]+a*s[10]+r*s[14],t.w=i*s[3]+n*s[7]+a*s[11]+r*s[15],t}setLookAt(e,t,s){Tt.sub2(e,t).normalize(),At.copy(s).normalize(),St.cross(At,Tt).normalize(),At.cross(Tt,St);var i=this.data;return i[0]=St.x,i[1]=St.y,i[2]=St.z,i[3]=0,i[4]=At.x,i[5]=At.y,i[6]=At.z,i[7]=0,i[8]=Tt.x,i[9]=Tt.y,i[10]=Tt.z,i[11]=0,i[12]=e.x,i[13]=e.y,i[14]=e.z,i[15]=1,this}setFrustum(e,t,s,i,n,a){var r=2*n,o=t-e,l=i-s,h=a-n,c=this.data;return c[0]=r/o,c[1]=0,c[2]=0,c[3]=0,c[4]=0,c[5]=r/l,c[6]=0,c[7]=0,c[8]=(t+e)/o,c[9]=(i+s)/l,c[10]=(-a-n)/h,c[11]=-1,c[12]=0,c[13]=0,c[14]=-r*a/h,c[15]=0,this}setPerspective(e,t,s,i,n){return Et._getPerspectiveHalfSize(Ct,e,t,s,n),this.setFrustum(-Ct.x,Ct.x,-Ct.y,Ct.y,s,i)}setOrtho(e,t,s,i,n,a){var r=this.data;return r[0]=2/(t-e),r[1]=0,r[2]=0,r[3]=0,r[4]=0,r[5]=2/(i-s),r[6]=0,r[7]=0,r[8]=0,r[9]=0,r[10]=-2/(a-n),r[11]=0,r[12]=-(t+e)/(t-e),r[13]=-(i+s)/(i-s),r[14]=-(a+n)/(a-n),r[15]=1,this}setFromAxisAngle(e,t){t*=pt.DEG_TO_RAD;var{x:s,y:i,z:n}=e,a=Math.cos(t),r=Math.sin(t),o=1-a,l=o*s,h=o*i,c=this.data;return c[0]=l*s+a,c[1]=l*i+r*n,c[2]=l*n-r*i,c[3]=0,c[4]=l*i-r*n,c[5]=h*i+a,c[6]=h*n+r*s,c[7]=0,c[8]=l*n+r*i,c[9]=h*n-s*r,c[10]=o*n*n+a,c[11]=0,c[12]=0,c[13]=0,c[14]=0,c[15]=1,this}setTranslate(e,t,s){var i=this.data;return i[0]=1,i[1]=0,i[2]=0,i[3]=0,i[4]=0,i[5]=1,i[6]=0,i[7]=0,i[8]=0,i[9]=0,i[10]=1,i[11]=0,i[12]=e,i[13]=t,i[14]=s,i[15]=1,this}setScale(e,t,s){var i=this.data;return i[0]=e,i[1]=0,i[2]=0,i[3]=0,i[4]=0,i[5]=t,i[6]=0,i[7]=0,i[8]=0,i[9]=0,i[10]=s,i[11]=0,i[12]=0,i[13]=0,i[14]=0,i[15]=1,this}setViewport(e,t,s,i){var n=this.data;return n[0]=.5*s,n[1]=0,n[2]=0,n[3]=0,n[4]=0,n[5]=.5*i,n[6]=0,n[7]=0,n[8]=0,n[9]=0,n[10]=.5,n[11]=0,n[12]=e+.5*s,n[13]=t+.5*i,n[14]=.5,n[15]=1,this}setReflection(e,t){var s=e.x,i=e.y,n=e.z,a=this.data;return a[0]=1-2*s*s,a[1]=-2*s*i,a[2]=-2*s*n,a[3]=0,a[4]=-2*s*i,a[5]=1-2*i*i,a[6]=-2*i*n,a[7]=0,a[8]=-2*s*n,a[9]=-2*i*n,a[10]=1-2*n*n,a[11]=0,a[12]=-2*s*t,a[13]=-2*i*t,a[14]=-2*n*t,a[15]=1,this}invert(e){void 0===e&&(e=this);var t=e.data,s=t[0],i=t[1],n=t[2],a=t[3],r=t[4],o=t[5],l=t[6],h=t[7],c=t[8],d=t[9],u=t[10],p=t[11],m=t[12],f=t[13],g=t[14],v=t[15],_=s*o-i*r,y=s*l-n*r,x=s*h-a*r,w=i*l-n*o,b=i*h-a*o,C=n*h-a*l,S=c*f-d*m,A=c*g-u*m,T=c*v-p*m,P=d*g-u*f,E=d*v-p*f,k=u*v-p*g,M=_*k-y*E+x*P+w*T-b*A+C*S;if(0===M)this.setIdentity();else{var I=1/M,D=this.data;D[0]=(o*k-l*E+h*P)*I,D[1]=(-i*k+n*E-a*P)*I,D[2]=(f*C-g*b+v*w)*I,D[3]=(-d*C+u*b-p*w)*I,D[4]=(-r*k+l*T-h*A)*I,D[5]=(s*k-n*T+a*A)*I,D[6]=(-m*C+g*x-v*y)*I,D[7]=(c*C-u*x+p*y)*I,D[8]=(r*E-o*T+h*S)*I,D[9]=(-s*E+i*T-a*S)*I,D[10]=(m*b-f*x+v*_)*I,D[11]=(-c*b+d*x-p*_)*I,D[12]=(-r*P+o*A-l*S)*I,D[13]=(s*P-i*A+n*S)*I,D[14]=(-m*w+f*y-g*_)*I,D[15]=(c*w-d*y+u*_)*I}return this}set(e){var t=this.data;return t[0]=e[0],t[1]=e[1],t[2]=e[2],t[3]=e[3],t[4]=e[4],t[5]=e[5],t[6]=e[6],t[7]=e[7],t[8]=e[8],t[9]=e[9],t[10]=e[10],t[11]=e[11],t[12]=e[12],t[13]=e[13],t[14]=e[14],t[15]=e[15],this}setIdentity(){var e=this.data;return e[0]=1,e[1]=0,e[2]=0,e[3]=0,e[4]=0,e[5]=1,e[6]=0,e[7]=0,e[8]=0,e[9]=0,e[10]=1,e[11]=0,e[12]=0,e[13]=0,e[14]=0,e[15]=1,this}setTRS(e,t,s){var i=t.x,n=t.y,a=t.z,r=t.w,o=s.x,l=s.y,h=s.z,c=i+i,d=n+n,u=a+a,p=i*c,m=i*d,f=i*u,g=n*d,v=n*u,_=a*u,y=r*c,x=r*d,w=r*u,b=this.data;return b[0]=(1-(g+_))*o,b[1]=(m+w)*o,b[2]=(f-x)*o,b[3]=0,b[4]=(m-w)*l,b[5]=(1-(p+_))*l,b[6]=(v+y)*l,b[7]=0,b[8]=(f+x)*h,b[9]=(v-y)*h,b[10]=(1-(p+g))*h,b[11]=0,b[12]=e.x,b[13]=e.y,b[14]=e.z,b[15]=1,this}transpose(e){void 0===e&&(e=this);var t,s=e.data,i=this.data;s===i?(t=s[1],i[1]=s[4],i[4]=t,t=s[2],i[2]=s[8],i[8]=t,t=s[3],i[3]=s[12],i[12]=t,t=s[6],i[6]=s[9],i[9]=t,t=s[7],i[7]=s[13],i[13]=t,t=s[11],i[11]=s[14],i[14]=t):(i[0]=s[0],i[1]=s[4],i[2]=s[8],i[3]=s[12],i[4]=s[1],i[5]=s[5],i[6]=s[9],i[7]=s[13],i[8]=s[2],i[9]=s[6],i[10]=s[10],i[11]=s[14],i[12]=s[3],i[13]=s[7],i[14]=s[11],i[15]=s[15]);return this}getTranslation(e){return void 0===e&&(e=new yt),e.set(this.data[12],this.data[13],this.data[14])}getX(e){return void 0===e&&(e=new yt),e.set(this.data[0],this.data[1],this.data[2])}getY(e){return void 0===e&&(e=new yt),e.set(this.data[4],this.data[5],this.data[6])}getZ(e){return void 0===e&&(e=new yt),e.set(this.data[8],this.data[9],this.data[10])}getScale(e){return void 0===e&&(e=new yt),this.getX(St),this.getY(At),this.getZ(Tt),e.set(St.length(),At.length(),Tt.length()),e}get scaleSign(){return this.getX(St),this.getY(At),this.getZ(Tt),St.cross(St,At),St.dot(Tt)<0?-1:1}setFromEulerAngles(e,t,s){e*=pt.DEG_TO_RAD,t*=pt.DEG_TO_RAD,s*=pt.DEG_TO_RAD;var i=Math.sin(-e),n=Math.cos(-e),a=Math.sin(-t),r=Math.cos(-t),o=Math.sin(-s),l=Math.cos(-s),h=this.data;return h[0]=r*l,h[1]=-r*o,h[2]=a,h[3]=0,h[4]=n*o+l*i*a,h[5]=n*l-i*a*o,h[6]=-r*i,h[7]=0,h[8]=i*o-n*l*a,h[9]=l*i+n*a*o,h[10]=n*r,h[11]=0,h[12]=0,h[13]=0,h[14]=0,h[15]=1,this}getEulerAngles(e){void 0===e&&(e=new yt),this.getScale(Pt);var t=Pt.x,s=Pt.y,i=Pt.z;if(0===t||0===s||0===i)return e.set(0,0,0);var n,a,r=this.data,o=Math.asin(-r[2]/t),l=.5*Math.PI;return o<l?o>-l?(n=Math.atan2(r[6]/s,r[10]/i),a=Math.atan2(r[1]/t,r[0]/t)):(a=0,n=-Math.atan2(r[4]/s,r[5]/s)):(a=0,n=Math.atan2(r[4]/s,r[5]/s)),e.set(n,o,a).mulScalar(pt.RAD_TO_DEG)}toString(){return"["+this.data.join(", ")+"]"}constructor(){this.data=new Float32Array(16),this.data[0]=this.data[5]=this.data[10]=this.data[15]=1}}Et.IDENTITY=Object.freeze(new Et),Et.ZERO=Object.freeze((new Et).set([0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0]));class kt{clone(){return new(0,this.constructor)(this.x,this.y,this.z,this.w)}conjugate(e){return void 0===e&&(e=this),this.x=-1*e.x,this.y=-1*e.y,this.z=-1*e.z,this.w=e.w,this}copy(e){return this.x=e.x,this.y=e.y,this.z=e.z,this.w=e.w,this}equals(e){return this.x===e.x&&this.y===e.y&&this.z===e.z&&this.w===e.w}equalsApprox(e,t){return void 0===t&&(t=1e-6),Math.abs(this.x-e.x)<t&&Math.abs(this.y-e.y)<t&&Math.abs(this.z-e.z)<t&&Math.abs(this.w-e.w)<t}getAxisAngle(e){var t=2*Math.acos(this.w),s=Math.sin(t/2);return 0!==s?(e.x=this.x/s,e.y=this.y/s,e.z=this.z/s,(e.x<0||e.y<0||e.z<0)&&(e.x*=-1,e.y*=-1,e.z*=-1,t*=-1)):(e.x=1,e.y=0,e.z=0),t*pt.RAD_TO_DEG}getEulerAngles(e){var t,s,i;void 0===e&&(e=new yt);var n=this.x,a=this.y,r=this.z,o=this.w,l=2*(o*a-n*r);return l<=-.99999?(t=2*Math.atan2(n,o),s=-Math.PI/2,i=0):l>=.99999?(t=2*Math.atan2(n,o),s=Math.PI/2,i=0):(t=Math.atan2(2*(o*n+a*r),1-2*(n*n+a*a)),s=Math.asin(l),i=Math.atan2(2*(o*r+n*a),1-2*(a*a+r*r))),e.set(t,s,i).mulScalar(pt.RAD_TO_DEG)}invert(e){return void 0===e&&(e=this),this.conjugate(e).normalize()}length(){return Math.sqrt(this.x*this.x+this.y*this.y+this.z*this.z+this.w*this.w)}lengthSq(){return this.x*this.x+this.y*this.y+this.z*this.z+this.w*this.w}mul(e){var t=this.x,s=this.y,i=this.z,n=this.w,a=e.x,r=e.y,o=e.z,l=e.w;return this.x=n*a+t*l+s*o-i*r,this.y=n*r+s*l+i*a-t*o,this.z=n*o+i*l+t*r-s*a,this.w=n*l-t*a-s*r-i*o,this}mulScalar(e,t){return void 0===t&&(t=this),this.x=t.x*e,this.y=t.y*e,this.z=t.z*e,this.w=t.w*e,this}mul2(e,t){var s=e.x,i=e.y,n=e.z,a=e.w,r=t.x,o=t.y,l=t.z,h=t.w;return this.x=a*r+s*h+i*l-n*o,this.y=a*o+i*h+n*r-s*l,this.z=a*l+n*h+s*o-i*r,this.w=a*h-s*r-i*o-n*l,this}normalize(e){void 0===e&&(e=this);var t=e.length();return 0===t?(this.x=this.y=this.z=0,this.w=1):(t=1/t,this.x=e.x*t,this.y=e.y*t,this.z=e.z*t,this.w=e.w*t),this}set(e,t,s,i){return this.x=e,this.y=t,this.z=s,this.w=i,this}setFromAxisAngle(e,t){t*=.5*pt.DEG_TO_RAD;var s=Math.sin(t),i=Math.cos(t);return this.x=s*e.x,this.y=s*e.y,this.z=s*e.z,this.w=i,this}setFromEulerAngles(e,t,s){if(e instanceof yt){var i=e;e=i.x,t=i.y,s=i.z}var n=.5*pt.DEG_TO_RAD;e*=n,t*=n,s*=n;var a=Math.sin(e),r=Math.cos(e),o=Math.sin(t),l=Math.cos(t),h=Math.sin(s),c=Math.cos(s);return this.x=a*l*c-r*o*h,this.y=r*o*c+a*l*h,this.z=r*l*h-a*o*c,this.w=r*l*c+a*o*h,this}setFromMat4(e){var t,s=e.data,i=s[0],n=s[1],a=s[2],r=s[4],o=s[5],l=s[6],h=s[8],c=s[9],d=s[10];return 0===(t=i*i+n*n+a*a)?this.set(0,0,0,1):(i*=t=1/Math.sqrt(t),n*=t,a*=t,0===(t=r*r+o*o+l*l)?this.set(0,0,0,1):(r*=t=1/Math.sqrt(t),o*=t,l*=t,0===(t=h*h+c*c+d*d)?this.set(0,0,0,1):(h*=t=1/Math.sqrt(t),c*=t,(d*=t)<0?i>o?this.set(1+i-o-d,n+r,h+a,l-c):this.set(n+r,1-i+o-d,l+c,h-a):i<-o?this.set(h+a,l+c,1-i-o+d,n-r):this.set(l-c,h-a,n-r,1+i+o+d),this.mulScalar(1/this.length()))))}setFromDirections(e,t){var s=1+e.dot(t);return s<Number.EPSILON?Math.abs(e.x)>Math.abs(e.y)?(this.x=-e.z,this.y=0,this.z=e.x,this.w=0):(this.x=0,this.y=-e.z,this.z=e.y,this.w=0):(this.x=e.y*t.z-e.z*t.y,this.y=e.z*t.x-e.x*t.z,this.z=e.x*t.y-e.y*t.x,this.w=s),this.normalize()}slerp(e,t,s){var i=e.x,n=e.y,a=e.z,r=e.w,o=t.x,l=t.y,h=t.z,c=t.w,d=r*c+i*o+n*l+a*h;if(d<0&&(c=-c,o=-o,l=-l,h=-h,d=-d),Math.abs(d)>=1)return this.w=r,this.x=i,this.y=n,this.z=a,this;var u=Math.acos(d),p=Math.sqrt(1-d*d);if(Math.abs(p)<.001)return this.w=.5*r+.5*c,this.x=.5*i+.5*o,this.y=.5*n+.5*l,this.z=.5*a+.5*h,this;var m=Math.sin((1-s)*u)/p,f=Math.sin(s*u)/p;return this.w=r*m+c*f,this.x=i*m+o*f,this.y=n*m+l*f,this.z=a*m+h*f,this}transformVector(e,t){void 0===t&&(t=new yt);var s=e.x,i=e.y,n=e.z,a=this.x,r=this.y,o=this.z,l=this.w,h=l*s+r*n-o*i,c=l*i+o*s-a*n,d=l*n+a*i-r*s,u=-a*s-r*i-o*n;return t.x=h*l+u*-a+c*-o-d*-r,t.y=c*l+u*-r+d*-a-h*-o,t.z=d*l+u*-o+h*-r-c*-a,t}toString(){return"["+this.x+", "+this.y+", "+this.z+", "+this.w+"]"}constructor(e=0,t=0,s=0,i=1){4===e.length?(this.x=e[0],this.y=e[1],this.z=e[2],this.w=e[3]):(this.x=e,this.y=t,this.z=s,this.w=i)}}kt.IDENTITY=Object.freeze(new kt(0,0,0,1)),kt.ZERO=Object.freeze(new kt(0,0,0,0));var Mt=new yt,It=new yt,Dt=new yt,Rt=new yt,Lt=new yt;class Ft{add(e){var t=this.center,s=t.x,i=t.y,n=t.z,a=this.halfExtents,r=a.x,o=a.y,l=a.z,h=s-r,c=s+r,d=i-o,u=i+o,p=n-l,m=n+l,f=e.center,g=f.x,v=f.y,_=f.z,y=e.halfExtents,x=y.x,w=y.y,b=y.z,C=g-x,S=g+x,A=v-w,T=v+w,P=_-b,E=_+b;C<h&&(h=C),S>c&&(c=S),A<d&&(d=A),T>u&&(u=T),P<p&&(p=P),E>m&&(m=E),t.x=.5*(h+c),t.y=.5*(d+u),t.z=.5*(p+m),a.x=.5*(c-h),a.y=.5*(u-d),a.z=.5*(m-p)}copy(e){this.center.copy(e.center),this.halfExtents.copy(e.halfExtents)}clone(){return new Ft(this.center,this.halfExtents)}intersects(e){var t=this.getMax(),s=this.getMin(),i=e.getMax(),n=e.getMin();return s.x<=i.x&&t.x>=n.x&&s.y<=i.y&&t.y>=n.y&&s.z<=i.z&&t.z>=n.z}_intersectsRay(e,t){var s=Mt.copy(this.getMin()).sub(e.origin),i=It.copy(this.getMax()).sub(e.origin),n=e.direction;0===n.x?(s.x=s.x<0?-Number.MAX_VALUE:Number.MAX_VALUE,i.x=i.x<0?-Number.MAX_VALUE:Number.MAX_VALUE):(s.x/=n.x,i.x/=n.x),0===n.y?(s.y=s.y<0?-Number.MAX_VALUE:Number.MAX_VALUE,i.y=i.y<0?-Number.MAX_VALUE:Number.MAX_VALUE):(s.y/=n.y,i.y/=n.y),0===n.z?(s.z=s.z<0?-Number.MAX_VALUE:Number.MAX_VALUE,i.z=i.z<0?-Number.MAX_VALUE:Number.MAX_VALUE):(s.z/=n.z,i.z/=n.z);var a=Dt.set(Math.min(s.x,i.x),Math.min(s.y,i.y),Math.min(s.z,i.z)),r=Rt.set(Math.max(s.x,i.x),Math.max(s.y,i.y),Math.max(s.z,i.z)),o=Math.min(Math.min(r.x,r.y),r.z),l=Math.max(Math.max(a.x,a.y),a.z),h=o>=l&&l>=0;return h&&t.copy(e.direction).mulScalar(l).add(e.origin),h}_fastIntersectsRay(e){var t=Mt,s=It,i=Dt,n=Rt,a=Lt,r=e.direction;return t.sub2(e.origin,this.center),n.set(Math.abs(t.x),Math.abs(t.y),Math.abs(t.z)),i.mul2(t,r),!(n.x>this.halfExtents.x&&i.x>=0)&&(!(n.y>this.halfExtents.y&&i.y>=0)&&(!(n.z>this.halfExtents.z&&i.z>=0)&&(a.set(Math.abs(r.x),Math.abs(r.y),Math.abs(r.z)),s.cross(r,t),s.set(Math.abs(s.x),Math.abs(s.y),Math.abs(s.z)),!(s.x>this.halfExtents.y*a.z+this.halfExtents.z*a.y)&&(!(s.y>this.halfExtents.x*a.z+this.halfExtents.z*a.x)&&!(s.z>this.halfExtents.x*a.y+this.halfExtents.y*a.x)))))}intersectsRay(e,t){return t?this._intersectsRay(e,t):this._fastIntersectsRay(e)}setMinMax(e,t){this.center.add2(t,e).mulScalar(.5),this.halfExtents.sub2(t,e).mulScalar(.5)}getMin(){return this._min.copy(this.center).sub(this.halfExtents)}getMax(){return this._max.copy(this.center).add(this.halfExtents)}containsPoint(e){var t=this.getMin(),s=this.getMax();return!(e.x<t.x||e.x>s.x||e.y<t.y||e.y>s.y||e.z<t.z||e.z>s.z)}setFromTransformedAabb(e,t,s){void 0===s&&(s=!1);var i=e.center,n=e.halfExtents,a=t.data,r=a[0],o=a[4],l=a[8],h=a[1],c=a[5],d=a[9],u=a[2],p=a[6],m=a[10];if(s){var f=r*r+o*o+l*l;if(f>0){var g=1/Math.sqrt(f);r*=g,o*=g,l*=g}if((f=h*h+c*c+d*d)>0){var v=1/Math.sqrt(f);h*=v,c*=v,d*=v}if((f=u*u+p*p+m*m)>0){var _=1/Math.sqrt(f);u*=_,p*=_,m*=_}}this.center.set(a[12]+r*i.x+o*i.y+l*i.z,a[13]+h*i.x+c*i.y+d*i.z,a[14]+u*i.x+p*i.y+m*i.z),this.halfExtents.set(Math.abs(r)*n.x+Math.abs(o)*n.y+Math.abs(l)*n.z,Math.abs(h)*n.x+Math.abs(c)*n.y+Math.abs(d)*n.z,Math.abs(u)*n.x+Math.abs(p)*n.y+Math.abs(m)*n.z)}static computeMinMax(e,t,s,i){if(void 0===i&&(i=e.length/3),i>0){for(var n=e[0],a=e[1],r=e[2],o=n,l=a,h=r,c=3*i,d=3;d<c;d+=3){var u=e[d],p=e[d+1],m=e[d+2];u<n&&(n=u),p<a&&(a=p),m<r&&(r=m),u>o&&(o=u),p>l&&(l=p),m>h&&(h=m)}t.set(n,a,r),s.set(o,l,h)}}compute(e,t){Ft.computeMinMax(e,Mt,It,t),this.setMinMax(Mt,It)}intersectsBoundingSphere(e){return this._distanceToBoundingSphereSq(e)<=e.radius*e.radius}_distanceToBoundingSphereSq(e){for(var t=this.getMin(),s=this.getMax(),i=0,n=["x","y","z"],a=0;a<3;++a){var r=0,o=e.center[n[a]],l=t[n[a]],h=s[n[a]],c=0;o<l&&(r+=(c=l-o)*c),o>h&&(r+=(c=o-h)*c),i+=r}return i}_expand(e,t){Mt.add2(this.getMin(),e),It.add2(this.getMax(),t),this.setMinMax(Mt,It)}constructor(e,t){this.center=new yt,this.halfExtents=new yt(.5,.5,.5),this._min=new yt,this._max=new yt,e&&this.center.copy(e),t&&this.halfExtents.copy(t)}}var Bt=new yt,Ot=new yt;class zt{containsPoint(e){var t=Bt.sub2(e,this.center).lengthSq(),s=this.radius;return t<s*s}intersectsRay(e,t){var s=Bt.copy(e.origin).sub(this.center),i=s.dot(Ot.copy(e.direction).normalize()),n=s.dot(s)-this.radius*this.radius;if(n>0&&i>0)return!1;var a=i*i-n;if(a<0)return!1;var r=Math.abs(-i-Math.sqrt(a));return t&&t.copy(e.direction).mulScalar(r).add(e.origin),!0}intersectsBoundingSphere(e){Bt.sub2(e.center,this.center);var t=e.radius+this.radius;return Bt.lengthSq()<=t*t}constructor(e=new yt,t=.5){this.center=e,this.radius=t}}class Vt{clone(){return(new(0,this.constructor)).copy(this)}copy(e){return this.normal.copy(e.normal),this.distance=e.distance,this}intersectsLine(e,t,s){var i=this.distance,n=this.normal.dot(e)+i,a=n/(n-(this.normal.dot(t)+i)),r=a>=0&&a<=1;return r&&s&&s.lerp(e,t,a),r}intersectsRay(e,t){var s=this.normal.dot(e.direction);if(0===s)return!1;var i=-(this.normal.dot(e.origin)+this.distance)/s;return i>=0&&t&&t.copy(e.direction).mulScalar(i).add(e.origin),i>=0}normalize(){var e=1/this.normal.length();return this.normal.mulScalar(e),this.distance*=e,this}set(e,t,s,i){return this.normal.set(e,t,s),this.distance=i,this}setFromPointNormal(e,t){return this.normal.copy(t),this.distance=-this.normal.dot(e),this}constructor(e=yt.UP,t=0){this.normal=new yt,this.normal.copy(e),this.distance=t}}class Nt{clone(){return(new(0,this.constructor)).copy(this)}copy(e){for(var t=0;t<6;t++)this.planes[t].copy(e.planes[t]);return this}setFromMat4(e){var[t,s,i,n,a,r,o,l,h,c,d,u,p,m,f,g]=e.data,v=this.planes;v[0].set(n-t,l-a,u-h,g-p).normalize(),v[1].set(n+t,l+a,u+h,g+p).normalize(),v[2].set(n+s,l+r,u+c,g+m).normalize(),v[3].set(n-s,l-r,u-c,g-m).normalize(),v[4].set(n-i,l-o,u-d,g-f).normalize(),v[5].set(n+i,l+o,u+d,g+f).normalize()}containsPoint(e){for(var t=0;t<6;t++){var{normal:s,distance:i}=this.planes[t];if(s.dot(e)+i<=0)return!1}return!0}containsSphere(e){for(var{center:t,radius:s}=e,i=0,n=0;n<6;n++){var{normal:a,distance:r}=this.planes[n],o=a.dot(t)+r;if(o<=-s)return 0;o>s&&i++}return 6===i?2:1}constructor(){this.planes=[];for(var e=0;e<6;e++)this.planes[e]=new Vt}}class Ut{set(e,t){return this.origin.copy(e),this.direction.copy(t),this}copy(e){return this.set(e.origin,e.direction)}clone(){return new this.constructor(this.origin,this.direction)}constructor(e,t){this.origin=new yt,this.direction=yt.FORWARD.clone(),e&&this.origin.copy(e),t&&this.direction.copy(t)}}var Ht=new yt,Gt=new yt,Wt=new yt,jt=new yt,qt=new yt,Xt=1e-6;class Yt{set(e,t,s){return this.v0.copy(e),this.v1.copy(t),this.v2.copy(s),this}intersectsRay(e,t){Ht.sub2(this.v1,this.v0),Gt.sub2(this.v2,this.v0),Wt.cross(e.direction,Gt);var s=Ht.dot(Wt);if(s>-1e-6&&s<Xt)return!1;var i=1/s;jt.sub2(e.origin,this.v0);var n=i*jt.dot(Wt);if(n<0||n>1)return!1;qt.cross(jt,Ht);var a=i*e.direction.dot(qt);if(a<0||n+a>1)return!1;var r=i*Gt.dot(qt);return r>Xt&&(t instanceof yt&&t.copy(e.direction).mulScalar(r).add(e.origin),!0)}toString(){return"["+this.v0.toString()+", "+this.v1.toString()+", "+this.v2.toString()+"]"}constructor(e=yt.ZERO,t=yt.ZERO,s=yt.ZERO){this.v0=new yt,this.v1=new yt,this.v2=new yt,this.set(e,t,s)}}var $t=10,Kt=12,Zt=14,Jt=15,Qt=16,es=17,ts=18,ss=20,is=24,ns=25,as=37,rs=49,os=69,ls=new Map([[0,{name:"A8",size:1,ldr:!0}],[52,{name:"R8",size:1,ldr:!0}],[1,{name:"L8",size:1,ldr:!0}],[2,{name:"LA8",size:2,ldr:!0}],[53,{name:"RG8",size:2,ldr:!0}],[3,{name:"RGB565",size:2,ldr:!0}],[4,{name:"RGBA5551",size:2,ldr:!0}],[5,{name:"RGBA4",size:2,ldr:!0}],[6,{name:"RGB8",size:4,ldr:!0}],[7,{name:"RGBA8",size:4,ldr:!0,srgbFormat:ss}],[50,{name:"R16F",size:2}],[51,{name:"RG16F",size:4}],[11,{name:"RGB16F",size:8}],[Kt,{name:"RGBA16F",size:8}],[13,{name:"RGB32F",size:16}],[Zt,{name:"RGBA32F",size:16}],[Jt,{name:"R32F",size:4}],[Qt,{name:"DEPTH",size:4}],[os,{name:"DEPTH16",size:2}],[es,{name:"DEPTHSTENCIL",size:4}],[ts,{name:"111110F",size:4}],[19,{name:"SRGB8",size:4,ldr:!0,srgb:!0}],[ss,{name:"SRGBA8",size:4,ldr:!0,srgb:!0}],[31,{name:"BGRA8",size:4,ldr:!0}],[64,{name:"SBGRA8",size:4,ldr:!0,srgb:!0}],[8,{name:"DXT1",blockSize:8,ldr:!0,srgbFormat:54}],[9,{name:"DXT3",blockSize:16,ldr:!0,srgbFormat:55}],[$t,{name:"DXT5",blockSize:16,ldr:!0,srgbFormat:56}],[21,{name:"ETC1",blockSize:8,ldr:!0}],[22,{name:"ETC2_RGB",blockSize:8,ldr:!0,srgbFormat:61}],[23,{name:"ETC2_RGBA",blockSize:16,ldr:!0,srgbFormat:62}],[is,{name:"PVRTC_2BPP_RGB_1",ldr:!0,blockSize:8}],[ns,{name:"PVRTC_2BPP_RGBA_1",ldr:!0,blockSize:8}],[26,{name:"PVRTC_4BPP_RGB_1",ldr:!0,blockSize:8}],[27,{name:"PVRTC_4BPP_RGBA_1",ldr:!0,blockSize:8}],[28,{name:"ASTC_4x4",blockSize:16,ldr:!0,srgbFormat:63}],[29,{name:"ATC_RGB",blockSize:8,ldr:!0}],[30,{name:"ATC_RGBA",blockSize:16,ldr:!0}],[65,{name:"BC6H_RGBF",blockSize:16}],[66,{name:"BC6H_RGBUF",blockSize:16}],[67,{name:"BC7_RGBA",blockSize:16,ldr:!0,srgbFormat:68}],[54,{name:"DXT1_SRGB",blockSize:8,ldr:!0,srgb:!0}],[55,{name:"DXT3_SRGBA",blockSize:16,ldr:!0,srgb:!0}],[56,{name:"DXT5_SRGBA",blockSize:16,ldr:!0,srgb:!0}],[61,{name:"ETC2_SRGB",blockSize:8,ldr:!0,srgb:!0}],[62,{name:"ETC2_SRGBA",blockSize:16,ldr:!0,srgb:!0}],[63,{name:"ASTC_4x4_SRGB",blockSize:16,ldr:!0,srgb:!0}],[68,{name:"BC7_SRGBA",blockSize:16,ldr:!0,srgb:!0}],[32,{name:"R8I",size:1,isInt:!0}],[33,{name:"R8U",size:1,isInt:!0}],[34,{name:"R16I",size:2,isInt:!0}],[35,{name:"R16U",size:2,isInt:!0}],[36,{name:"R32I",size:4,isInt:!0}],[as,{name:"R32U",size:4,isInt:!0}],[38,{name:"RG8I",size:2,isInt:!0}],[39,{name:"RG8U",size:2,isInt:!0}],[40,{name:"RG16I",size:4,isInt:!0}],[41,{name:"RG16U",size:4,isInt:!0}],[42,{name:"RG32I",size:8,isInt:!0}],[43,{name:"RG32U",size:8,isInt:!0}],[44,{name:"RGBA8I",size:4,isInt:!0}],[45,{name:"RGBA8U",size:4,isInt:!0}],[46,{name:"RGBA16I",size:8,isInt:!0}],[47,{name:"RGBA16U",size:8,isInt:!0}],[48,{name:"RGBA32I",size:16,isInt:!0}],[rs,{name:"RGBA32U",size:16,isInt:!0}]]),hs=e=>{var t;return void 0!==(null==(t=ls.get(e))?void 0:t.blockSize)},cs=e=>{var t;return!0===(null==(t=ls.get(e))?void 0:t.srgb)},ds=e=>{var t;return!0===(null==(t=ls.get(e))?void 0:t.isInt)},us=e=>{var t;return(null==(t=ls.get(e))?void 0:t.srgbFormat)||e},ps=e=>{switch(e){case Jt:case 13:case Zt:return Float32Array;case 36:case 42:case 48:return Int32Array;case as:case 43:case rs:return Uint32Array;case 34:case 40:case 46:return Int16Array;case 53:case 35:case 41:case 47:case 3:case 4:case 5:case 50:case 51:case 11:case Kt:return Uint16Array;case 32:case 38:case 44:return Int8Array;default:return Uint8Array}},ms="POSITION",fs="NORMAL",gs="TANGENT",vs="BLENDWEIGHT",_s="BLENDINDICES",ys="COLOR",xs="TEXCOORD",ws="TEXCOORD0",bs="TEXCOORD1",Cs="TEXCOORD2",Ss="TEXCOORD3",As="TEXCOORD4",Ts="TEXCOORD5",Ps="TEXCOORD6",Es="TEXCOORD7",ks="ATTR8",Ms="ATTR9",Is="ATTR12",Ds="ATTR13",Rs="ATTR14",Ls="ATTR15",Fs="default",Bs="rgbm",Os="rgbe",zs="rgbp",Vs="swizzleGGGR",Ns="2d",Us="2d-array",Hs="cube",Gs="cube-array",Ws="3d",js="cube",qs="equirect",Xs="glsl",Ys="wgsl",$s=14,Ks=26,Zs=27,Js=28,Qs=29,ei=30,ti=33,si=36,ii=["bool","int","float","vec2","vec3","vec4","ivec2","ivec3","ivec4","bvec2","bvec3","bvec4","mat2","mat3","mat4","sampler2D","samplerCube","","sampler2DShadow","samplerCubeShadow","sampler3D","","","","","sampler2DArray","uint","uvec2","uvec3","uvec4","","","","","","","","","","","","","isampler2D","usampler2D","isamplerCube","usamplerCube","isampler3D","usampler3D","isampler2DArray","usampler2DArray"],ni=[["bool"],["i32"],["f32"],["vec2f","vec2<f32>"],["vec3f","vec3<f32>"],["vec4f","vec4<f32>"],["vec2i","vec2<i32>"],["vec3i","vec3<i32>"],["vec4i","vec4<i32>"],["vec2<bool>"],["vec3<bool>"],["vec4<bool>"],["mat2x2f","mat2x2<f32>"],["mat3x3f","mat3x3<f32>"],["mat4x4f","mat4x4<f32>"],["texture_2d<f32>"],["texture_cube<f32>"],["array<f32>"],["texture_depth_2d"],["texture_depth_cube"],["texture_3d<f32>"],["array<vec2<f32>>"],["array<vec3<f32>>"],["array<vec4<f32>>"],["array<mat4x4<f32>>"],["texture_2d_array<f32>"],["u32"],["vec2u","vec2<u32>"],["vec3u","vec3<u32>"],["vec4u","vec4<u32>"],["array<i32>"],["array<u32>"],["array<bool>"],["array<vec2i>","array<vec2<i32>>"],["array<vec2u>","array<vec2<u32>>"],["array<vec2b>","array<vec2<bool>>"],["array<vec3i>","array<vec3<i32>>"],["array<vec3u>","array<vec3<u32>>"],["array<vec3b>","array<vec3<bool>>"],["array<vec4i>","array<vec4<i32>>"],["array<vec4u>","array<vec4<u32>>"],["array<vec4b>","array<vec4<bool>>"],["texture_2d<i32>"],["texture_2d<u32>"],["texture_cube<i32>"],["texture_cube<u32>"],["texture_3d<i32>"],["texture_3d<u32>"],["texture_2d_array<i32>"],["texture_2d_array<u32>"]],ai=new Map;ni.forEach(((e,t)=>{e.forEach((e=>ai.set(e,t)))}));var ri="webgl2",oi="webgpu",li="null",hi="ldr_srgb",ci=["view","mesh","mesh_ub"],di="default",ui="_unused_float_uniform",pi=[Int8Array,Uint8Array,Int16Array,Uint16Array,Int32Array,Uint32Array,Float32Array,Uint16Array],mi=[1,1,2,2,4,4,4,2],fi=[Uint8Array,Uint16Array,Uint32Array],gi=[1,2,4],vi={};vi[ms]=0,vi[fs]=1,vi[vs]=2,vi[_s]=3,vi[ys]=4,vi[ws]=5,vi[bs]=6,vi[Cs]=7,vi[Ss]=8,vi[As]=9,vi[Ts]=10,vi[Ps]=11,vi[Es]=12,vi[gs]=13,vi.ATTR0=0,vi.ATTR1=1,vi.ATTR2=2,vi.ATTR3=3,vi.ATTR4=4,vi.ATTR5=5,vi.ATTR6=6,vi.ATTR7=7,vi[ks]=8,vi[Ms]=9,vi.ATTR10=10,vi.ATTR11=11,vi[Is]=12,vi[Ds]=13,vi[Rs]=14,vi[Ls]=15;var _i=0,yi={[Ns]:"texture2D",[Hs]:"textureCube",[Ws]:"texture3D",[Us]:"texture2DArray"};class xi{constructor(e,t){this.slot=-1,this.scopeId=null,this.name=e,this.visibility=t}}class wi extends xi{}class bi extends xi{constructor(e,t,s=!1){super(e,t),this.format="",this.readOnly=s}}class Ci extends xi{constructor(e,t,s=Ns,i=0,n=!0,a=null){super(e,t),this.textureDimension=s,this.sampleType=i,this.hasSampler=n,this.samplerName=null!=a?a:e+"_sampler"}}class Si extends xi{constructor(e,t=7,s=Ns,i=!0,n=!1){super(e,4),this.format=t,this.textureDimension=s,this.write=i,this.read=n}}class Ai{destroy(){this.impl.destroy()}getTexture(e){var t=this.textureFormatsMap.get(e);return void 0!==t?this.textureFormats[t]:null}getStorageTexture(e){var t=this.storageTextureFormatsMap.get(e);return void 0!==t?this.storageTextureFormats[t]:null}getShaderDeclarationTextures(e){var t="";return this.textureFormats.forEach((s=>{var i=yi[s.textureDimension],n="texture2DArray"===i,a=4===s.sampleType?"u":3===s.sampleType?"i":"";i=""+a+i;var r="",o="";n&&(r="_texture",o="#define "+s.name+" "+a+"sampler2DArray("+s.name+r+", "+s.name+"_sampler)\n"),t+="layout(set = "+e+", binding = "+s.slot+") uniform "+i+" "+s.name+r+";\n",s.hasSampler&&(t+="layout(set = "+e+", binding = "+(s.slot+1)+") uniform sampler "+s.name+"_sampler;\n"),t+=o})),t}loseContext(){}constructor(e,t){this.uniformBufferFormats=[],this.textureFormats=[],this.storageTextureFormats=[],this.storageBufferFormats=[],this.id=_i++;var s=0;t.forEach((e=>{e.slot=s++,e instanceof Ci&&e.hasSampler&&s++,e instanceof wi?this.uniformBufferFormats.push(e):e instanceof Ci?this.textureFormats.push(e):e instanceof Si?this.storageTextureFormats.push(e):e instanceof bi&&this.storageBufferFormats.push(e)})),this.device=e;var i=e.scope;this.bufferFormatsMap=new Map,this.uniformBufferFormats.forEach(((e,t)=>this.bufferFormatsMap.set(e.name,t))),this.textureFormatsMap=new Map,this.textureFormats.forEach(((e,t)=>{this.textureFormatsMap.set(e.name,t),e.scopeId=i.resolve(e.name)})),this.storageTextureFormatsMap=new Map,this.storageTextureFormats.forEach(((e,t)=>{this.storageTextureFormatsMap.set(e.name,t),e.scopeId=i.resolve(e.name)})),this.storageBufferFormatsMap=new Map,this.storageBufferFormats.forEach(((e,t)=>{this.storageBufferFormatsMap.set(e.name,t),e.scopeId=i.resolve(e.name)})),this.impl=e.createBindGroupFormatImpl(this)}}class Ti{get(e,t){return this._cache.has(e)||(this._cache.set(e,t()),e.on("destroy",(()=>{this.remove(e)})),e.on("devicelost",(()=>{var t,s;null==(s=this._cache.get(e))||null==(t=s.loseContext)||t.call(s,e)}))),this._cache.get(e)}remove(e){var t,s;null==(s=this._cache.get(e))||null==(t=s.destroy)||t.call(s,e),this._cache.delete(e)}constructor(){this._cache=new Map}}class Pi{static calcLevelDimension(e,t){return Math.max(e>>t,1)}static calcMipLevelsCount(e,t,s){return void 0===s&&(s=1),1+Math.floor(Math.log2(Math.max(e,t,s)))}static calcLevelGpuSize(e,t,s,i){var n,a,r,o=ls.get(i),l=null!=(a=null==(n=ls.get(i))?void 0:n.size)?a:0;if(l>0)return e*t*s*l;var h=null!=(r=o.blockSize)?r:0,c=Math.floor((e+3)/4),d=Math.floor((t+3)/4),u=Math.floor((s+3)/4);return i!==is&&i!==ns||(c=Math.max(Math.floor(c/2),1)),c*d*u*h}static calcGpuSize(e,t,s,i,n,a){for(var r=0;r+=Pi.calcLevelGpuSize(e,t,s,i),n&&(1!==e||1!==t||1!==s);)e=Math.max(e>>1,1),t=Math.max(t>>1,1),s=Math.max(s>>1,1);return r*(a?6:1)}}var Ei=0;class ki{destroy(){var e=this.device;if(e){var t=e.textures.indexOf(this);-1!==t&&e.textures.splice(t,1),e.scope.removeValue(this),this.impl.destroy(e),this.adjustVramSizeTracking(e._vram,-this._gpuSize),this._levels=null,this.device=null}}recreateImpl(e){var t;void 0===e&&(e=!0);var{device:s}=this;null==(t=this.impl)||t.destroy(s),this.impl=null,this.impl=s.createTextureImpl(this),this.dirtyAll(),e&&this.upload()}resize(e,t,s){void 0===s&&(s=1);var i=this.device;this.adjustVramSizeTracking(i._vram,-this._gpuSize),this.impl.destroy(i),this._width=Math.floor(e),this._height=Math.floor(t),this._depth=Math.floor(s),this._updateNumLevel(),this.impl=i.createTextureImpl(this),this.dirtyAll()}loseContext(){this.impl.loseContext(),this.dirtyAll()}adjustVramSizeTracking(e,t){e.tex+=t}propertyChanged(e){this.impl.propertyChanged(e),this.renderVersionDirty=this.device.renderVersion}_updateNumLevel(){var e=this.mipmaps?Pi.calcMipLevelsCount(this.width,this.height):1,t=this._numLevelsRequested;this._numLevels=Math.min(null!=t?t:e,e),this._mipmaps=this._numLevels>1}get lockedMode(){return this._lockedMode}set minFilter(e){this._minFilter!==e&&(ds(this._format)||(this._minFilter=e,this.propertyChanged(1)))}get minFilter(){return this._minFilter}set magFilter(e){this._magFilter!==e&&(ds(this._format)||(this._magFilter=e,this.propertyChanged(2)))}get magFilter(){return this._magFilter}set addressU(e){this._addressU!==e&&(this._addressU=e,this.propertyChanged(4))}get addressU(){return this._addressU}set addressV(e){this._addressV!==e&&(this._addressV=e,this.propertyChanged(8))}get addressV(){return this._addressV}set addressW(e){this._volume&&e!==this._addressW&&(this._addressW=e,this.propertyChanged(16))}get addressW(){return this._addressW}set compareOnRead(e){this._compareOnRead!==e&&(this._compareOnRead=e,this.propertyChanged(32))}get compareOnRead(){return this._compareOnRead}set compareFunc(e){this._compareFunc!==e&&(this._compareFunc=e,this.propertyChanged(64))}get compareFunc(){return this._compareFunc}set anisotropy(e){this._anisotropy!==e&&(this._anisotropy=e,this.propertyChanged(128))}get anisotropy(){return this._anisotropy}set mipmaps(e){this._mipmaps!==e&&(this.device.isWebGPU||ds(this._format)||(this._mipmaps=e),e&&(this._needsMipmapsUpload=!0))}get mipmaps(){return this._mipmaps}get numLevels(){return this._numLevels}get storage(){return this._storage}get width(){return this._width}get height(){return this._height}get depth(){return this._depth}get format(){return this._format}get cubemap(){return this._cubemap}get gpuSize(){var e=this.pot&&this._mipmaps&&!(this._compressed&&1===this._levels.length);return Pi.calcGpuSize(this._width,this._height,this._depth,this._format,e,this._cubemap)}get array(){return this._arrayLength>0}get arrayLength(){return this._arrayLength}get volume(){return this._volume}set srgb(e){if(e!==cs(this.format))if(e){var t=us(this.format);this._format!==t&&(this._format=t,this.recreateImpl(),this.device._shadersDirty=!0)}else{var s=(e=>{for(var[t,s]of ls)if(s.srgbFormat===e)return t;return e})(this.format);this._format!==s&&(this._format=s,this.recreateImpl(),this.device._shadersDirty=!0)}}get srgb(){return cs(this.format)}set flipY(e){this._flipY!==e&&(this._flipY=e,this._needsUpload=!0)}get flipY(){return this._flipY}set premultiplyAlpha(e){this._premultiplyAlpha!==e&&(this._premultiplyAlpha=e,this._needsUpload=!0)}get premultiplyAlpha(){return this._premultiplyAlpha}get pot(){return pt.powerOfTwo(this._width)&&pt.powerOfTwo(this._height)}get encoding(){switch(this.type){case Bs:return"rgbm";case Os:return"rgbe";case zs:return"rgbp"}return e=this.format,(null==(t=ls.get(e))?void 0:t.ldr)&&!(null==t?void 0:t.srgb)?"srgb":"linear";var e,t}dirtyAll(){this._levelsUpdated=this._cubemap?[[!0,!0,!0,!0,!0,!0]]:[!0],this._needsUpload=!0,this._needsMipmapsUpload=this._mipmaps,this._mipmapsUploaded=!1,this.propertyChanged(255)}lock(e){var t,s,i;void 0===e&&(e={}),null!=(t=e).level||(t.level=0),null!=(s=e).face||(s.face=0),null!=(i=e).mode||(i.mode=2),this._lockedMode=e.mode,this._lockedLevel=e.level;var n=this.cubemap?this._levels[e.face]:this._levels;if(null===n[e.level]){var a=Math.max(1,this._width>>e.level),r=Math.max(1,this._height>>e.level),o=Math.max(1,this._depth>>e.level),l=new ArrayBuffer(Pi.calcLevelGpuSize(a,r,o,this._format));n[e.level]=new(ps(this._format))(l)}return n[e.level]}setSource(e,t){void 0===t&&(t=0);var s,i,n=!1;if(this._cubemap){if(e[0]){s=e[0].width||0,i=e[0].height||0;for(var a=0;a<6;a++){var r=e[a];if(!r||r.width!==s||r.height!==i||!this.device._isBrowserInterface(r)){n=!0;break}}}else n=!0;if(!n)for(var o=0;o<6;o++)this._levels[t][o]!==e[o]&&(this._levelsUpdated[t][o]=!0)}else this.device._isBrowserInterface(e)||(n=!0),n||(e!==this._levels[t]&&(this._levelsUpdated[t]=!0),e instanceof HTMLVideoElement?(s=e.videoWidth,i=e.videoHeight):(s=e.width,i=e.height));if(n)if(this._width=4,this._height=4,this._cubemap)for(var l=0;l<6;l++)this._levels[t][l]=null,this._levelsUpdated[t][l]=!0;else this._levels[t]=null,this._levelsUpdated[t]=!0;else 0===t&&(this._width=s,this._height=i),this._levels[t]=e;this._invalid===n&&n||(this._invalid=n,this.upload())}getSource(e){return void 0===e&&(e=0),this._levels[e]}unlock(){2===this._lockedMode&&this.upload(),this._lockedLevel=-1,this._lockedMode=0}upload(){this._needsUpload=!0,this._needsMipmapsUpload=this._mipmaps,null==this.impl.uploadImmediate||this.impl.uploadImmediate.call(this.impl,this.device,this)}read(e,t,s,i,n){return void 0===n&&(n={}),null==this.impl.read?void 0:this.impl.read.call(this.impl,e,t,s,i,n)}constructor(e,t={}){var s,i,n,a,r,o,l,h,c,d,u,p,m,f,g,v,_,y,x,w;this._gpuSize=0,this.id=Ei++,this._invalid=!1,this._lockedLevel=-1,this._lockedMode=0,this.renderVersionDirty=0,this._storage=!1,this._numLevels=0,this.device=e,this.name=null!=(s=t.name)?s:"",this._width=Math.floor(null!=(i=t.width)?i:4),this._height=Math.floor(null!=(n=t.height)?n:4),this._format=null!=(a=t.format)?a:7,this._compressed=hs(this._format),this._integerFormat=ds(this._format),this._integerFormat&&(t.minFilter=0,t.magFilter=0),this._volume=null!=(r=t.volume)&&r,this._depth=Math.floor(null!=(o=t.depth)?o:1),this._arrayLength=Math.floor(null!=(l=t.arrayLength)?l:0),this._storage=null!=(h=t.storage)&&h,this._cubemap=null!=(c=t.cubemap)&&c,this._flipY=null!=(d=t.flipY)&&d,this._premultiplyAlpha=null!=(u=t.premultiplyAlpha)&&u,this._mipmaps=null==(p=t.mipmaps)||p,this._numLevelsRequested=t.numLevels,void 0!==t.numLevels&&(this._numLevels=t.numLevels),this._updateNumLevel(),this._minFilter=null!=(m=t.minFilter)?m:5,this._magFilter=null!=(f=t.magFilter)?f:1,this._anisotropy=null!=(g=t.anisotropy)?g:1,this._addressU=null!=(v=t.addressU)?v:0,this._addressV=null!=(_=t.addressV)?_:0,this._addressW=null!=(y=t.addressW)?y:0,this._compareOnRead=null!=(x=t.compareOnRead)&&x,this._compareFunc=null!=(w=t.compareFunc)?w:1,this.type=t.hasOwnProperty("type")?t.type:Fs,this.projection="none",this._cubemap?this.projection=js:t.projection&&t.projection!==js&&(this.projection=t.projection),this._levels=t.levels;var b=!!t.levels;this._levels||(this._levels=this._cubemap?[[null,null,null,null,null,null]]:[null]),this.recreateImpl(b),e.textures.push(this)}}var Mi={white:[255,255,255,255],gray:[128,128,128,255],black:[0,0,0,255],normal:[128,128,255,255],pink:[255,128,255,255]};class Ii{destroy(){this.map.forEach((e=>{e.destroy()}))}constructor(){this.map=new Map}}var Di=new Ti,Ri=(e,t)=>{var s=Di.get(e,(()=>new Ii));if(!s.map.has(t)){var i=new ki(e,{name:"built-in-texture-"+t,width:1,height:1,format:7}),n=i.lock(),a=Mi[t];n.set(a),i.unlock(),s.map.set(t,i)}return s.map.get(t)},Li=0;class Fi{constructor(){this.offsets=[]}}class Bi{destroy(){this.impl.destroy(),this.impl=null,this.format=null,this.defaultUniformBuffer=null}setUniformBuffer(e,t){var s=this.format.bufferFormatsMap.get(e);this.uniformBuffers[s]!==t&&(this.uniformBuffers[s]=t,this.dirty=!0)}setStorageBuffer(e,t){var s=this.format.storageBufferFormatsMap.get(e);this.storageBuffers[s]!==t&&(this.storageBuffers[s]=t,this.dirty=!0)}setTexture(e,t){var s=this.format.textureFormatsMap.get(e);this.textures[s]!==t?(this.textures[s]=t,this.dirty=!0):this.renderVersionUpdated<t.renderVersionDirty&&(this.dirty=!0)}setStorageTexture(e,t){var s=this.format.storageTextureFormatsMap.get(e);this.storageTextures[s]!==t?(this.storageTextures[s]=t,this.dirty=!0):this.renderVersionUpdated<t.renderVersionDirty&&(this.dirty=!0)}updateUniformBuffers(){for(var e=0;e<this.uniformBuffers.length;e++)this.uniformBuffers[e].update()}update(){for(var{textureFormats:e,storageTextureFormats:t,storageBufferFormats:s}=this.format,i=0;i<e.length;i++){var n=e[i],a=n.scopeId.value;a||("uSceneDepthMap"===n.name&&(a=Ri(this.device,"white")),"uSceneColorMap"===n.name&&(a=Ri(this.device,"pink")),a||(a=Ri(this.device,"pink"))),this.setTexture(n.name,a)}for(var r=0;r<t.length;r++){var o=t[r],l=o.scopeId.value;this.setStorageTexture(o.name,l)}for(var h=0;h<s.length;h++){var c=s[h],d=c.scopeId.value;this.setStorageBuffer(c.name,d)}this.uniformBufferOffsets.length=this.uniformBuffers.length;for(var u=0;u<this.uniformBuffers.length;u++){var p=this.uniformBuffers[u];this.uniformBufferOffsets[u]=p.offset,this.renderVersionUpdated<p.renderVersionDirty&&(this.dirty=!0)}this.dirty&&(this.dirty=!1,this.renderVersionUpdated=this.device.renderVersion,this.impl.update(this))}constructor(e,t,s){this.renderVersionUpdated=-1,this.uniformBufferOffsets=[],this.id=Li++,this.device=e,this.format=t,this.dirty=!0,this.impl=e.createBindGroupImpl(this),this.textures=[],this.storageTextures=[],this.storageBuffers=[],this.uniformBuffers=[],this.defaultUniformBuffer=s,s&&this.setUniformBuffer(di,s)}}var Oi={set:(e,t,s,i)=>(void 0===i&&(i=1),e&~(i<<s)|t<<s),get:(e,t,s)=>(void 0===s&&(s=1),e>>t&s),all(e,t,s){void 0===s&&(s=1);var i=s<<t;return(e&i)===i},any:(e,t,s)=>(void 0===s&&(s=1),!!(e&s<<t))},zi=15;class Vi{set blend(e){this.target0=Oi.set(this.target0,e?1:0,26)}get blend(){return Oi.all(this.target0,26)}setColorBlend(e,t,s){this.target0=Oi.set(this.target0,e,0,7),this.target0=Oi.set(this.target0,t,3,zi),this.target0=Oi.set(this.target0,s,7,zi)}setAlphaBlend(e,t,s){this.target0=Oi.set(this.target0,e,11,7),this.target0=Oi.set(this.target0,t,14,zi),this.target0=Oi.set(this.target0,s,18,zi)}setColorWrite(e,t,s,i){this.redWrite=e,this.greenWrite=t,this.blueWrite=s,this.alphaWrite=i}get colorOp(){return Oi.get(this.target0,0,7)}get colorSrcFactor(){return Oi.get(this.target0,3,zi)}get colorDstFactor(){return Oi.get(this.target0,7,zi)}get alphaOp(){return Oi.get(this.target0,11,7)}get alphaSrcFactor(){return Oi.get(this.target0,14,zi)}get alphaDstFactor(){return Oi.get(this.target0,18,zi)}set redWrite(e){this.target0=Oi.set(this.target0,e?1:0,22)}get redWrite(){return Oi.all(this.target0,22)}set greenWrite(e){this.target0=Oi.set(this.target0,e?1:0,23)}get greenWrite(){return Oi.all(this.target0,23)}set blueWrite(e){this.target0=Oi.set(this.target0,e?1:0,24)}get blueWrite(){return Oi.all(this.target0,24)}set alphaWrite(e){this.target0=Oi.set(this.target0,e?1:0,25)}get alphaWrite(){return Oi.all(this.target0,25)}get allWrite(){return Oi.get(this.target0,22,15)}copy(e){return this.target0=e.target0,this}clone(){return(new this.constructor).copy(this)}get key(){return this.target0}equals(e){return this.target0===e.target0}constructor(e=!1,t=0,s=1,i=0,n,a,r,o=!0,l=!0,h=!0,c=!0){this.target0=0,this.setColorBlend(t,s,i),this.setAlphaBlend(null!=n?n:t,null!=a?a:s,null!=r?r:i),this.setColorWrite(o,l,h,c),this.blend=e}}Vi.NOBLEND=Object.freeze(new Vi),Vi.NOWRITE=Object.freeze(new Vi(void 0,void 0,void 0,void 0,void 0,void 0,void 0,!1,!1,!1,!1)),Vi.ALPHABLEND=Object.freeze(new Vi(!0,0,6,8)),Vi.ADDBLEND=Object.freeze(new Vi(!0,0,1,1));class Ni{get(e){var t=this.map.get(e);return void 0===t&&(t=this.id++,this.map.set(e,t)),t}constructor(){this.map=new Map,this.id=0}}var Ui=new Ni;class Hi{set test(e){this.func=e?3:7,this.updateKey()}get test(){return 7!==this.func}set write(e){this.data=Oi.set(this.data,e?1:0,3),this.updateKey()}get write(){return Oi.all(this.data,3)}set func(e){this.data=Oi.set(this.data,e,0,7),this.updateKey()}get func(){return Oi.get(this.data,0,7)}set depthBias(e){this._depthBias=e,this.updateKey()}get depthBias(){return this._depthBias}set depthBiasSlope(e){this._depthBiasSlope=e,this.updateKey()}get depthBiasSlope(){return this._depthBiasSlope}copy(e){return this.data=e.data,this._depthBias=e._depthBias,this._depthBiasSlope=e._depthBiasSlope,this.key=e.key,this}clone(){return(new this.constructor).copy(this)}updateKey(){var{data:e,_depthBias:t,_depthBiasSlope:s}=this,i=e+"-"+t+"-"+s;this.key=Ui.get(i)}equals(e){return this.key===e.key}constructor(e=3,t=!0){this.data=0,this._depthBias=0,this._depthBiasSlope=0,this.key=0,this.func=e,this.write=t}}Hi.DEFAULT=Object.freeze(new Hi),Hi.NODEPTH=Object.freeze(new Hi(7,!1)),Hi.WRITEDEPTH=Object.freeze(new Hi(7,!0));class Gi{equals(e){return this.globalId===e.globalId&&this.revision===e.revision}copy(e){this.globalId=e.globalId,this.revision=e.revision}reset(){this.globalId=0,this.revision=0}constructor(){this.globalId=0,this.revision=0}}var Wi=0;class ji{increment(){this.version.revision++}constructor(){Wi++,this.version=new Gi,this.version.globalId=Wi}}class qi{toJSON(e){}setValue(e){this.value=e,this.versionObject.increment()}getValue(){return this.value}constructor(e){this.name=e,this.value=null,this.versionObject=new ji}}class Xi{resolve(e){return this.variables.has(e)||this.variables.set(e,new qi(e)),this.variables.get(e)}removeValue(e){for(var t in this.variables){var s=this.variables[t];s.value===e&&(s.value=null)}}constructor(e){this.name=e,this.variables=new Map}}var Yi=0;class $i{destroy(){var e=this.device,t=e.buffers.indexOf(this);-1!==t&&e.buffers.splice(t,1),this.impl.initialized&&(this.impl.destroy(e),this.adjustVramSizeTracking(e._vram,-this.storage.byteLength))}adjustVramSizeTracking(e,t){e.vb+=t}loseContext(){this.impl.loseContext()}getFormat(){return this.format}getUsage(){return this.usage}getNumVertices(){return this.numVertices}lock(){return this.storage}unlock(){this.impl.unlock(this)}setData(e){return e.byteLength===this.numBytes&&(this.storage=e,this.unlock(),!0)}constructor(e,t,s,i){var n;this.usage=0,this.usage=null!=(n=null==i?void 0:i.usage)?n:0,this.device=e,this.format=t,this.numVertices=s,this.id=Yi++,this.impl=e.createVertexBufferImpl(this,t,i),this.numBytes=t.verticesByteSize?t.verticesByteSize:t.size*s,this.adjustVramSizeTracking(e._vram,this.numBytes);var a=null==i?void 0:i.data;a?this.setData(a):this.storage=new ArrayBuffer(this.numBytes),this.device.buffers.push(this)}}function Ki(e){if(null==e)return 0;for(var t=0,s=0,i=e.length;s<i;s++)t=(t<<5)-t+e.charCodeAt(s),t|=0;return t}function Zi(e){for(var t=2166136261,s=0;s<e.length;s++)t^=e[s],t*=16777619;return t>>>0}var Ji=new Ni,Qi=[2,4,8,12,16],en=new Ti;class tn{get elements(){return this._elements}static getDefaultInstancingFormat(e){return en.get(e,(()=>new tn(e,[{semantic:Is,components:4,type:6},{semantic:Ds,components:4,type:6},{semantic:Rs,components:4,type:6},{semantic:Ls,components:4,type:6}])))}static isElementValid(e,t){var s=t.components*mi[t.type];return!(e.isWebGPU&&!Qi.includes(s))}update(){this._evaluateHash()}_evaluateHash(){for(var e=[],t=[],s=this._elements.length,i=0;i<s;i++){var{name:n,dataType:a,numComponents:r,normalize:o,offset:l,stride:h,size:c,asInt:d}=this._elements[i],u=n+a+r+o+d;e.push(u);var p=u+l+h+c;t.push(p)}e.sort();var m=e.join();this.batchingHash=Ki(m),this.shaderProcessingHashString=m,this.renderingHashString=t.join("_"),this.renderingHash=Ji.get(this.renderingHashString)}constructor(e,t,s){this.device=e,this._elements=[],this.hasUv0=!1,this.hasUv1=!1,this.hasColor=!1,this.hasTangents=!1,this.verticesByteSize=0,this.vertexCount=s,this.interleaved=void 0===s,this.instancing=!1,this.size=t.reduce(((e,t)=>e+4*Math.ceil(t.components*mi[t.type]/4)),0);for(var i,n=0,a=0,r=t.length;a<r;a++){var o,l=t[a];i=l.components*mi[l.type],s&&(n=pt.roundUp(n,i));var h,c=null!=(o=l.asInt)&&o,d=!c&&(null!=(h=l.normalize)&&h),u={name:l.semantic,offset:s?n:l.hasOwnProperty("offset")?l.offset:n,stride:s?i:l.hasOwnProperty("stride")?l.stride:this.size,dataType:l.type,numComponents:l.components,normalize:d,size:i,asInt:c};this._elements.push(u),n+=s?i*s:4*Math.ceil(i/4),l.semantic===ws?this.hasUv0=!0:l.semantic===bs?this.hasUv1=!0:l.semantic===ys?this.hasColor=!0:l.semantic===gs&&(this.hasTangents=!0)}s&&(this.verticesByteSize=n),this._evaluateHash()}}var sn=new Ni;class nn{set func(e){this._func=e,this._dirty=!0}get func(){return this._func}set ref(e){this._ref=e,this._dirty=!0}get ref(){return this._ref}set fail(e){this._fail=e,this._dirty=!0}get fail(){return this._fail}set zfail(e){this._zfail=e,this._dirty=!0}get zfail(){return this._zfail}set zpass(e){this._zpass=e,this._dirty=!0}get zpass(){return this._zpass}set readMask(e){this._readMask=e,this._dirty=!0}get readMask(){return this._readMask}set writeMask(e){this._writeMask=e,this._dirty=!0}get writeMask(){return this._writeMask}_evalKey(){var{_func:e,_ref:t,_fail:s,_zfail:i,_zpass:n,_readMask:a,_writeMask:r}=this,o=e+","+t+","+s+","+i+","+n+","+a+","+r;this._key=sn.get(o),this._dirty=!1}get key(){return this._dirty&&this._evalKey(),this._key}copy(e){return this._func=e._func,this._ref=e._ref,this._readMask=e._readMask,this._writeMask=e._writeMask,this._fail=e._fail,this._zfail=e._zfail,this._zpass=e._zpass,this._dirty=e._dirty,this._key=e._key,this}clone(){return(new this.constructor).copy(this)}constructor(e={}){var t,s,i,n,a,r,o;this._dirty=!0,this._func=null!=(t=e.func)?t:7,this._ref=null!=(s=e.ref)?s:0,this._readMask=null!=(i=e.readMask)?i:255,this._writeMask=null!=(n=e.writeMask)?n:255,this._fail=null!=(a=e.fail)?a:0,this._zfail=null!=(r=e.zfail)?r:0,this._zpass=null!=(o=e.zpass)?o:0,this._evalKey()}}function an(){return an=Object.assign||function(e){for(var t=1;t<arguments.length;t++){var s=arguments[t];for(var i in s)Object.prototype.hasOwnProperty.call(s,i)&&(e[i]=s[i])}return e},an.apply(this,arguments)}nn.DEFAULT=Object.freeze(new nn);class rn extends tt{postInit(){var e=new tn(this,[{semantic:ms,components:2,type:6}]),t=new Float32Array([-1,-1,1,-1,-1,1,1,1]);this.quadVertexBuffer=new $i(this,e,4,{data:t})}destroy(){var e,t,s;this.fire("destroy"),null==(e=this.quadVertexBuffer)||e.destroy(),this.quadVertexBuffer=null,null==(t=this.dynamicBuffers)||t.destroy(),this.dynamicBuffers=null,null==(s=this.gpuProfiler)||s.destroy(),this.gpuProfiler=null}onDestroyShader(e){this.fire("destroy:shader",e);var t=this.shaders.indexOf(e);-1!==t&&this.shaders.splice(t,1)}postDestroy(){this.scope=null,this.canvas=null}loseContext(){var e;for(var t of(this.contextLost=!0,this.backBufferSize.set(-1,-1),this.textures))t.loseContext();for(var s of this.buffers)s.loseContext();for(var i of this.targets)i.loseContext();null==(e=this.gpuProfiler)||e.loseContext()}restoreContext(){var e,t;for(var s of(this.contextLost=!1,this.initializeRenderState(),this.initializeContextCaches(),this.buffers))s.unlock();null==(t=this.gpuProfiler)||null==(e=t.restoreContext)||e.call(t)}toJSON(e){}initializeContextCaches(){this.indexBuffer=null,this.vertexBuffers=[],this.shader=null,this.shaderValid=void 0,this.shaderAsyncCompile=!1,this.renderTarget=null}initializeRenderState(){this.blendState=new Vi,this.depthState=new Hi,this.cullMode=1,this.vx=this.vy=this.vw=this.vh=0,this.sx=this.sy=this.sw=this.sh=0,this.blendColor=new mt(0,0,0,0)}setStencilState(e,t){}setBlendState(e){}setBlendColor(e,t,s,i){}setDepthState(e){}setCullMode(e){}setRenderTarget(e){this.renderTarget=e}setIndexBuffer(e){this.indexBuffer=e}setVertexBuffer(e){e&&this.vertexBuffers.push(e)}clearVertexBuffer(){this.vertexBuffers.length=0}getRenderTarget(){return this.renderTarget}initRenderTarget(e){e.initialized||(e.init(),this.targets.add(e))}_isBrowserInterface(e){return this._isImageBrowserInterface(e)||this._isImageCanvasInterface(e)||this._isImageVideoInterface(e)}_isImageBrowserInterface(e){return"undefined"!=typeof ImageBitmap&&e instanceof ImageBitmap||"undefined"!=typeof HTMLImageElement&&e instanceof HTMLImageElement}_isImageCanvasInterface(e){return"undefined"!=typeof HTMLCanvasElement&&e instanceof HTMLCanvasElement}_isImageVideoInterface(e){return"undefined"!=typeof HTMLVideoElement&&e instanceof HTMLVideoElement}resizeCanvas(e,t){var s=Math.min(this._maxPixelRatio,Qe.browser?window.devicePixelRatio:1),i=Math.floor(e*s),n=Math.floor(t*s);i===this.canvas.width&&n===this.canvas.height||this.setResolution(i,n)}setResolution(e,t){this.canvas.width=e,this.canvas.height=t,this.fire(rn.EVENT_RESIZE,e,t)}updateClientRect(){if(Qe.worker)this.clientRect.width=this.canvas.width,this.clientRect.height=this.canvas.height;else{var e=this.canvas.getBoundingClientRect();this.clientRect.width=e.width,this.clientRect.height=e.height}}get width(){return this.canvas.width}get height(){return this.canvas.height}set fullscreen(e){}get fullscreen(){return!1}set maxPixelRatio(e){this._maxPixelRatio=e}get maxPixelRatio(){return this._maxPixelRatio}get deviceType(){return this._deviceType}startRenderPass(e){}endRenderPass(e){}startComputePass(e){}endComputePass(){}frameStart(){this.renderPassIndex=0,this.renderVersion++}frameEnd(){}computeDispatch(e,t){}getRenderableHdrFormat(e,t,s){void 0===e&&(e=[ts,Kt,Zt]),void 0===t&&(t=!0),void 0===s&&(s=1);for(var i=0;i<e.length;i++){var n=e[i];switch(n){case ts:if(this.textureRG11B10Renderable)return n;break;case Kt:if(this.textureHalfFloatRenderable)return n;break;case Zt:if(this.isWebGPU&&s>1)continue;if(this.textureFloatRenderable&&(!t||this.textureFloatFilterable))return n}}}constructor(e,t){var s,i,n,a,r,o;super(),this.backBuffer=null,this.backBufferSize=new wt,this.backBufferAntialias=!1,this.isWebGPU=!1,this.isWebGL2=!1,this.isHdr=!1,this.maxColorAttachments=1,this.maxSamples=1,this.supportsCompute=!1,this.supportsStorageTextureRead=!1,this.renderTarget=null,this.shaders=[],this.textures=[],this.targets=new Set,this.renderVersion=0,this.insideRenderPass=!1,this.supportsUniformBuffers=!1,this.supportsClipDistances=!1,this.textureRG11B10Renderable=!1,this.textureFloatFilterable=!1,this.blendState=new Vi,this.depthState=new Hi,this.stencilEnabled=!1,this.stencilFront=new nn,this.stencilBack=new nn,this.defaultClearOptions={color:[0,0,0,1],depth:1,stencil:0,flags:3},this.clientRect={width:0,height:0},this._shadersDirty=!1,this.canvas=e,this.initOptions=an({},t),null!=(s=this.initOptions).alpha||(s.alpha=!0),null!=(i=this.initOptions).depth||(i.depth=!0),null!=(n=this.initOptions).stencil||(n.stencil=!0),null!=(a=this.initOptions).antialias||(a.antialias=!0),null!=(r=this.initOptions).powerPreference||(r.powerPreference="high-performance"),null!=(o=this.initOptions).displayFormat||(o.displayFormat="ldr"),this._maxPixelRatio=Qe.browser?Math.min(1,window.devicePixelRatio):1,this.buffers=[],this._vram={tex:0,vb:0,ib:0,ub:0,sb:0},this._shaderStats={vsCompiled:0,fsCompiled:0,linked:0,materialShaders:0,compileTime:0},this.initializeContextCaches(),this._drawCallsPerFrame=0,this._shaderSwitchesPerFrame=0,this._primsPerFrame=[];for(var l=0;l<=6;l++)this._primsPerFrame[l]=0;this._renderTargetCreationTime=0,this.scope=new Xi("Device"),this.textureBias=this.scope.resolve("textureBias"),this.textureBias.setValue(0)}}rn.EVENT_RESIZE="resizecanvas";var on=0;class ln{destroy(){var e=this._device;e&&(e.targets.delete(this),e.renderTarget===this&&e.setRenderTarget(null),this.destroyFrameBuffers())}destroyFrameBuffers(){var e=this._device;e&&this.impl.destroy(e)}destroyTextureBuffers(){var e,t;null==(e=this._depthBuffer)||e.destroy(),this._depthBuffer=null,null==(t=this._colorBuffers)||t.forEach((e=>{e.destroy()})),this._colorBuffers=null,this._colorBuffer=null}resize(e,t){if(this.width!==e||this.height!==t){var s,i;if(this.mipLevel>0)return;var n=this._device;this.destroyFrameBuffers(),n.renderTarget===this&&n.setRenderTarget(null),null==(s=this._depthBuffer)||s.resize(e,t),null==(i=this._colorBuffers)||i.forEach((s=>{s.resize(e,t)})),this.validateMrt(),this.impl=n.createRenderTargetImpl(this)}}validateMrt(){}init(){this.impl.init(this._device,this)}get initialized(){return this.impl.initialized}get device(){return this._device}loseContext(){this.impl.loseContext()}resolve(e,t){void 0===e&&(e=!0),void 0===t&&(t=!!this._depthBuffer),this._device&&this._samples>1&&this.impl.resolve(this._device,this,e,t)}copy(e,t,s){if(!this._device){if(!e._device)return!1;this._device=e._device}return this._device.copyRenderTarget(e,this,t,s)}get samples(){return this._samples}get depth(){return this._depth}get stencil(){return this._stencil}get colorBuffer(){return this._colorBuffer}getColorBuffer(e){var t;return null==(t=this._colorBuffers)?void 0:t[e]}get depthBuffer(){return this._depthBuffer}get face(){return this._face}get mipLevel(){return this._mipLevel}get mipmaps(){return this._mipmaps}get width(){var e,t,s=(null==(e=this._colorBuffer)?void 0:e.width)||(null==(t=this._depthBuffer)?void 0:t.width)||this._device.width;return this._mipLevel>0&&(s=Pi.calcLevelDimension(s,this._mipLevel)),s}get height(){var e,t,s=(null==(e=this._colorBuffer)?void 0:e.height)||(null==(t=this._depthBuffer)?void 0:t.height)||this._device.height;return this._mipLevel>0&&(s=Pi.calcLevelDimension(s,this._mipLevel)),s}isColorBufferSrgb(e){if(void 0===e&&(e=0),this.device.backBuffer===this)return cs(this.device.backBufferFormat);var t=this.getColorBuffer(e);return!!t&&cs(t.format)}constructor(e={}){var t,s,i,n,a,r;this.id=on++;var o=null!=(r=null!=(a=null!=(n=null==(t=e.colorBuffer)?void 0:t.device)?n:null==(s=e.colorBuffers)?void 0:s[0].device)?a:null==(i=e.depthBuffer)?void 0:i.device)?r:e.graphicsDevice;this._device=o;var l,h,c,d,u,p,m,{maxSamples:f}=this._device;if(this._samples=Math.min(null!=(l=e.samples)?l:1,f),o.isWebGPU&&(this._samples=this._samples>1?f:1),this._colorBuffer=e.colorBuffer,e.colorBuffer&&(this._colorBuffers=[e.colorBuffer]),this._depthBuffer=e.depthBuffer,this._face=null!=(h=e.face)?h:0,this._depthBuffer){var g=this._depthBuffer._format;g===Qt||g===os?(this._depth=!0,this._stencil=!1):g===es?(this._depth=!0,this._stencil=!0):g===Jt&&this._depthBuffer.device.isWebGPU&&this._samples>1?(this._depth=!0,this._stencil=!1):(this._depth=!1,this._stencil=!1)}else{var v,_;this._depth=null==(v=e.depth)||v,this._stencil=null!=(_=e.stencil)&&_}(e.colorBuffers&&(this._colorBuffers||(this._colorBuffers=[...e.colorBuffers],this._colorBuffer=e.colorBuffers[0])),this.autoResolve=null==(c=e.autoResolve)||c,this.name=e.name,this.name)||(this.name=null==(d=this._colorBuffer)?void 0:d.name);this.name||(this.name=null==(u=this._depthBuffer)?void 0:u.name);this.name||(this.name="Untitled"),this.flipY=null!=(p=e.flipY)&&p,this._mipLevel=null!=(m=e.mipLevel)?m:0,this._mipLevel>0&&this._depth&&(this._mipLevel=0),this._mipmaps=void 0===e.mipLevel,this.validateMrt(),this.impl=o.createRenderTargetImpl(this)}}class hn{update(e){this.destroy();var t=e.device,s=this.createDescriptor(t,e);this.bindGroup=t.wgpu.createBindGroup(s)}destroy(){this.bindGroup=null}createDescriptor(e,t){var s=[],i=t.format,n=t.format.uniformBufferFormats;t.uniformBuffers.forEach(((e,t)=>{var i=n[t].slot,a=e.persistent?e.impl.buffer:e.allocation.gpuBuffer.buffer;s.push({binding:i,resource:{buffer:a,offset:0,size:e.format.byteSize}})}));var a=t.format.textureFormats;t.textures.forEach(((t,n)=>{var r=t.impl,o=i.textureFormats[n],l=a[n].slot,h=r.getView(e);if(s.push({binding:l,resource:h}),o.hasSampler){var c=r.getSampler(e,o.sampleType);s.push({binding:l+1,resource:c})}}));var r=t.format.storageTextureFormats;t.storageTextures.forEach(((t,i)=>{var n=t.impl,a=r[i].slot,o=n.getView(e);s.push({binding:a,resource:o})}));var o=t.format.storageBufferFormats;return t.storageBuffers.forEach(((e,t)=>{var i=e.impl.buffer,n=o[t].slot;s.push({binding:n,resource:{buffer:i}})})),{layout:t.format.impl.bindGroupLayout,entries:s}}}class cn{static shaderStage(e){var t=0;return 1&e&&(t|=GPUShaderStage.VERTEX),2&e&&(t|=GPUShaderStage.FRAGMENT),4&e&&(t|=GPUShaderStage.COMPUTE),t}}var dn=[];dn[0]="",dn[1]="",dn[2]="",dn[52]="r8unorm",dn[53]="rg8unorm",dn[3]="",dn[4]="",dn[5]="",dn[6]="rgba8unorm",dn[7]="rgba8unorm",dn[8]="bc1-rgba-unorm",dn[9]="bc2-rgba-unorm",dn[10]="bc3-rgba-unorm",dn[11]="",dn[12]="rgba16float",dn[50]="r16float",dn[51]="rg16float",dn[13]="",dn[14]="rgba32float",dn[15]="r32float",dn[16]="depth32float",dn[69]="depth16unorm",dn[17]="depth24plus-stencil8",dn[18]="rg11b10ufloat",dn[19]="",dn[20]="rgba8unorm-srgb",dn[21]="",dn[22]="etc2-rgb8unorm",dn[23]="etc2-rgba8unorm",dn[24]="",dn[25]="",dn[26]="",dn[27]="",dn[28]="astc-4x4-unorm",dn[29]="",dn[30]="",dn[31]="bgra8unorm",dn[64]="bgra8unorm-srgb",dn[32]="r8sint",dn[33]="r8uint",dn[34]="r16sint",dn[35]="r16uint",dn[36]="r32sint",dn[37]="r32uint",dn[38]="rg8sint",dn[39]="rg8uint",dn[40]="rg16sint",dn[41]="rg16uint",dn[42]="rg32sint",dn[43]="rg32uint",dn[44]="rgba8sint",dn[45]="rgba8uint",dn[46]="rgba16sint",dn[47]="rgba16uint",dn[48]="rgba32sint",dn[49]="rgba32uint",dn[65]="bc6h-rgb-float",dn[66]="bc6h-rgb-ufloat",dn[67]="bc7-rgba-unorm",dn[54]="bc1-rgba-unorm-srgb",dn[55]="bc2-rgba-unorm-srgb",dn[56]="bc3-rgba-unorm-srgb",dn[61]="etc2-rgb8unorm-srgb",dn[62]="etc2-rgba8unorm-srgb",dn[68]="bc7-rgba-unorm-srgb",dn[63]="astc-4x4-unorm-srgb";var un=[];un[0]="filtering",un[1]="non-filtering",un[2]="comparison",un[3]="comparison",un[4]="comparison";var pn=[];pn[0]="float",pn[1]="unfilterable-float",pn[2]="depth",pn[3]="sint",pn[4]="uint";var mn=new Ni;class fn{destroy(){this.bindGroupLayout=null}loseContext(){}createDescriptor(e){var t=[],s="";return e.uniformBufferFormats.forEach((e=>{var i=cn.shaderStage(e.visibility);s+="#"+e.slot+"U:"+i,t.push({binding:e.slot,visibility:i,buffer:{type:"uniform",hasDynamicOffset:!0}})})),e.textureFormats.forEach((e=>{var i=cn.shaderStage(e.visibility),n=e.sampleType,a=e.textureDimension,r=!1,o=pn[n];if(s+="#"+e.slot+"T:"+i+"-"+o+"-"+a+"-"+r,t.push({binding:e.slot,visibility:i,texture:{sampleType:o,viewDimension:a,multisampled:r}}),e.hasSampler){var l=un[n];s+="#"+(e.slot+1)+"S:"+i+"-"+l,t.push({binding:e.slot+1,visibility:i,sampler:{type:l}})}})),e.storageTextureFormats.forEach((e=>{var{format:i,textureDimension:n}=e,{read:a,write:r}=e;s+="#"+e.slot+"ST:"+i+"-"+n+"-"+(a?"r1":"r0")+"-"+(r?"w1":"w0"),t.push({binding:e.slot,visibility:GPUShaderStage.COMPUTE,storageTexture:{access:a?r?"read-write":"read-only":"write-only",format:dn[i],viewDimension:n}})})),e.storageBufferFormats.forEach((e=>{var i=e.readOnly,n=cn.shaderStage(e.visibility);s+="#"+e.slot+"SB:"+n+"-"+(i?"ro":"rw"),t.push({binding:e.slot,visibility:n,buffer:{type:i?"read-only-storage":"storage"}})})),{key:s,desc:{entries:t}}}constructor(e){var t=e.device,{key:s,desc:i}=this.createDescriptor(e);this.key=mn.get(s),this.bindGroupLayout=t.wgpu.createBindGroupLayout(i)}}class gn{destroy(e){this.buffer&&(this.buffer.destroy(),this.buffer=null)}get initialized(){return!!this.buffer}loseContext(){}allocate(e,t){this.buffer=e.wgpu.createBuffer({size:t,usage:this.usageFlags})}unlock(e,t){var s,i=e.wgpu;if(!this.buffer){var n=t.byteLength+3&-4;this.usageFlags|=GPUBufferUsage.COPY_DST,this.allocate(e,n)}var a,r=null!=(s=t.byteOffset)?s:0,o=new Uint8Array(null!=(a=t.buffer)?a:t,r,t.byteLength),l=new Uint8Array(this.buffer.size);l.set(o),i.queue.writeBuffer(this.buffer,0,l,0,l.length)}read(e,t,s,i){return e.readStorageBuffer(this,t,s,i)}write(e,t,s,i,n){e.writeStorageBuffer(this,t,s,i,n)}clear(e,t,s){e.clearStorageBuffer(this,t,s)}constructor(e=0){this.buffer=null,this.usageFlags=0,this.usageFlags=e}}class vn extends gn{unlock(e){var t=e.device;super.unlock(t,e.storage)}constructor(e,t){super(16|((null==t?void 0:t.storage)?128:0)),this.format=null,this.format=1===e.format?"uint16":"uint32"}}var _n={equals(e,t){if(e.length!==t.length)return!1;for(var s=0;s<e.length;s++)if(e[s]!==t[s])return!1;return!0}},yn=[];yn[0]="sint8",yn[1]="uint8",yn[2]="sint16",yn[3]="uint16",yn[4]="sint32",yn[5]="uint32",yn[6]="float32",yn[7]="float16";var xn=[];xn[0]="snorm8",xn[1]="unorm8",xn[2]="snorm16",xn[3]="unorm16",xn[4]="sint32",xn[5]="uint32",xn[6]="float32",xn[7]="float16";class wn{get(e,t){void 0===t&&(t=null);var s=this.getKey(e,t),i=this.cache.get(s);return i||(i=this.create(e,t),this.cache.set(s,i)),i}getKey(e,t){return void 0===t&&(t=null),(null==e?void 0:e.renderingHashString)+"-"+(null==t?void 0:t.renderingHashString)}create(e,t){var s=[],i=e=>{for(var t=e.interleaved,i=e.instancing?"instance":"vertex",n=[],a=e.elements.length,r=0;r<a;r++){var o=e.elements[r],l=vi[o.name],h=o.normalize?xn:yn;n.push({shaderLocation:l,offset:t?o.offset:0,format:h[o.dataType]+(o.numComponents>1?"x"+o.numComponents:"")}),t&&r!==a-1||(s.push({attributes:n,arrayStride:o.stride,stepMode:i}),n=[])}};return e&&i(e),t&&i(t),s}constructor(){this.cache=new Map}}class bn{getPipelineLayout(e){var t=[];e.forEach((e=>{t.push(e.bindGroupLayout)}));var s={bindGroupLayouts:t};return this.device.wgpu.createPipelineLayout(s)}constructor(e){this.device=e}}var Cn=["point-list","line-list",void 0,"line-strip","triangle-list","triangle-strip",void 0],Sn=["add","subtract","reverse-subtract","min","max"],An=["zero","one","src","one-minus-src","dst","one-minus-dst","src-alpha","src-alpha-saturated","one-minus-src-alpha","dst-alpha","one-minus-dst-alpha","constant","one-minus-constant"],Tn=["never","less","equal","less-equal","greater","not-equal","greater-equal","always"],Pn=["none","back","front"],En=["keep","zero","replace","increment-clamp","increment-wrap","decrement-clamp","decrement-wrap","invert"];class kn{}class Mn extends bn{get(e,t,s,i,n,a,r,o,l,h,c,d){var u,p,m,f,g,v,_,y,x=this.lookupHashes;x[0]=e.type,x[1]=i.id,x[2]=l,x[3]=o.key,x[4]=r.key,x[5]=null!=(f=null==t?void 0:t.renderingHash)?f:0,x[6]=null!=(g=null==s?void 0:s.renderingHash)?g:0,x[7]=n.impl.key,x[8]=null!=(v=null==(u=a[0])?void 0:u.key)?v:0,x[9]=null!=(_=null==(p=a[1])?void 0:p.key)?_:0,x[10]=null!=(y=null==(m=a[2])?void 0:m.key)?y:0,x[11]=h?c.key:0,x[12]=h?d.key:0;var w=Zi(x),b=this.cache.get(w);if(b)for(var C=0;C<b.length;C++){var S=b[C];if(_n.equals(S.hashes,x))return S.pipeline}var A=Cn[e.type],T=this.getPipelineLayout(a),P=this.vertexBufferLayout.get(t,s),E=new kn;return E.hashes=new Uint32Array(x),E.pipeline=this.create(A,i,n,T,r,o,P,l,h,c,d),b?b.push(E):b=[E],this.cache.set(w,b),E.pipeline}getBlend(e){var t;return e.blend&&(t={color:{operation:Sn[e.colorOp],srcFactor:An[e.colorSrcFactor],dstFactor:An[e.colorDstFactor]},alpha:{operation:Sn[e.alphaOp],srcFactor:An[e.alphaSrcFactor],dstFactor:An[e.alphaDstFactor]}}),t}getDepthStencil(e,t,s,i,n){var a,{depth:r,stencil:o}=t;return(r||o)&&(a={format:t.impl.depthAttachment.format},r?(a.depthWriteEnabled=e.write,a.depthCompare=Tn[e.func],a.depthBias=e.depthBias,a.depthBiasSlopeScale=e.depthBiasSlope):(a.depthWriteEnabled=!1,a.depthCompare="always"),o&&s&&(a.stencilReadMas=i.readMask,a.stencilWriteMask=i.writeMask,a.stencilFront={compare:Tn[i.func],failOp:En[i.fail],passOp:En[i.zpass],depthFailOp:En[i.zfail]},a.stencilBack={compare:Tn[n.func],failOp:En[n.fail],passOp:En[n.zpass],depthFailOp:En[n.zfail]})),a}create(e,t,s,i,n,a,r,o,l,h,c){var d=this.device.wgpu,u=t.impl,p={vertex:{module:u.getVertexShaderModule(),entryPoint:u.vertexEntryPoint,buffers:r},primitive:{topology:e,frontFace:"ccw",cullMode:Pn[o]},depthStencil:this.getDepthStencil(a,s,l,h,c),multisample:{count:s.samples},layout:i};p.fragment={module:u.getFragmentShaderModule(),entryPoint:u.fragmentEntryPoint,targets:[]};var m=s.impl.colorAttachments;if(m.length>0){var f=0;n.redWrite&&(f|=GPUColorWrite.RED),n.greenWrite&&(f|=GPUColorWrite.GREEN),n.blueWrite&&(f|=GPUColorWrite.BLUE),n.alphaWrite&&(f|=GPUColorWrite.ALPHA);var g=this.getBlend(n);m.forEach((e=>{p.fragment.targets.push({format:e.format,writeMask:f,blend:g})}))}return d.createRenderPipeline(p)}constructor(e){super(e),this.lookupHashes=new Uint32Array(13),this.vertexBufferLayout=new wn,this.cache=new Map}}class In extends bn{get(e,t){var s=this.getPipelineLayout([t.impl]);return this.create(e,s)}create(e,t){var s=this.device.wgpu,i=e.impl,n={compute:{module:i.getComputeShaderModule(),entryPoint:i.computeEntryPoint},layout:t};return s.createComputePipeline(n)}}class Dn{incRefCount(){this._refCount++}decRefCount(){this._refCount--}get refCount(){return this._refCount}constructor(){this._refCount=0}}class Rn extends Dn{constructor(e){super(),this.object=e,this.incRefCount()}}class Ln{destroy(){this.cache.forEach((e=>{var t;null==(t=e.object)||t.destroy()})),this.cache.clear()}clear(){this.cache.clear()}get(e){var t=this.cache.get(e);return t?(t.incRefCount(),t.object):null}set(e,t){this.cache.set(e,new Rn(t))}release(e){var t,s=this.cache.get(e);s&&(s.decRefCount(),0===s.refCount&&(this.cache.delete(e),null==(t=s.object)||t.destroy()))}constructor(){this.cache=new Map}}class Fn extends Ln{loseContext(e){this.clear()}}var Bn=new Ti,On=e=>Bn.get(e,(()=>new Fn)),zn=new Ni;class Vn{destroy(){var e;null==(e=this.multisampledBuffer)||e.destroy(),this.multisampledBuffer=null}}class Nn{destroy(e){var t;this.depthTextureInternal&&(null==(t=this.depthTexture)||t.destroy(),this.depthTexture=null);this.multisampledDepthBuffer&&(this.multisampledDepthBuffer=null,On(e).release(this.multisampledDepthBufferKey))}constructor(e){this.depthTexture=null,this.depthTextureInternal=!1,this.multisampledDepthBuffer=null,this.format=e,this.hasStencil="depth24plus-stencil8"===e}}class Un{destroy(e){var t;this.initialized=!1,this.assignedColorTexture=null,this.colorAttachments.forEach((e=>{e.destroy()})),this.colorAttachments.length=0,null==(t=this.depthAttachment)||t.destroy(e),this.depthAttachment=null}updateKey(){var e=this.renderTarget.samples+":"+(this.depthAttachment?this.depthAttachment.format:"nodepth");this.colorAttachments.forEach((t=>{e+=":"+t.format})),this.key=zn.get(e)}assignColorTexture(e,t){this.assignedColorTexture=t;var s=t.createView({format:e.backBufferViewFormat}),i=this.renderPassDescriptor.colorAttachments[0];this.renderTarget.samples>1?i.resolveTarget=s:i.view=s,this.setColorAttachment(0,void 0,e.backBufferViewFormat),this.updateKey()}setColorAttachment(e,t,s){this.colorAttachments[e]||(this.colorAttachments[e]=new Vn),t&&(this.colorAttachments[e].multisampledBuffer=t),s&&(this.colorAttachments[e].format=s)}init(e,t){var s,i,n=e.wgpu;this.initDepthStencil(e,n,t),t._colorBuffers&&t._colorBuffers.forEach(((e,t)=>{this.setColorAttachment(t,void 0,e.impl.format)})),this.renderPassDescriptor.colorAttachments=[];for(var a=this.isBackbuffer?1:null!=(i=null==(s=t._colorBuffers)?void 0:s.length)?i:0,r=0;r<a;++r){var o,l=this.initColor(e,n,t,r),h=0===r&&(null==(o=this.colorAttachments[0])?void 0:o.format);(l.view||h)&&this.renderPassDescriptor.colorAttachments.push(l)}this.updateKey(),this.initialized=!0}initDepthStencil(e,t,s){var{samples:i,width:n,height:a,depth:r,depthBuffer:o}=s;if(r||o){var l;if(o)if(this.depthAttachment=new Nn(o.impl.format),i>1){var h="depth24plus-stencil8";this.depthAttachment.format=h,this.depthAttachment.hasStencil=!0;var c=o.id+":"+n+":"+a+":"+i+":"+h,d=On(e),u=d.get(c);if(!u){var p={size:[n,a,1],dimension:"2d",sampleCount:i,format:h,usage:GPUTextureUsage.RENDER_ATTACHMENT|(h!==o.impl.format?GPUTextureUsage.TEXTURE_BINDING:0)};u=t.createTexture(p),d.set(c,u)}this.depthAttachment.multisampledDepthBuffer=u,this.depthAttachment.multisampledDepthBufferKey=c,l=u.createView()}else{var m=o.impl.gpuTexture;this.depthAttachment.depthTexture=m,l=m.createView()}else{this.depthAttachment=new Nn("depth24plus-stencil8");var f={size:[n,a,1],dimension:"2d",sampleCount:i,format:this.depthAttachment.format,usage:GPUTextureUsage.RENDER_ATTACHMENT};f.usage|=i>1?GPUTextureUsage.TEXTURE_BINDING:GPUTextureUsage.COPY_SRC;var g=t.createTexture(f);this.depthAttachment.depthTexture=g,this.depthAttachment.depthTextureInternal=!0,l=g.createView()}this.renderPassDescriptor.depthStencilAttachment={view:l}}}initColor(e,t,s,i){var n={},{samples:a,width:r,height:o,mipLevel:l}=s,h=s.getColorBuffer(i),c=null;if(h){c=h.cubemap?h.impl.createView({dimension:"2d",baseArrayLayer:s.face,arrayLayerCount:1,mipLevelCount:1,baseMipLevel:l}):h.impl.createView({mipLevelCount:1,baseMipLevel:l})}if(a>1){var d={size:[r,o,1],dimension:"2d",sampleCount:a,format:this.isBackbuffer?e.backBufferViewFormat:h.impl.format,usage:GPUTextureUsage.RENDER_ATTACHMENT},u=t.createTexture(d);this.setColorAttachment(i,u,d.format),n.view=u.createView(),n.resolveTarget=c}else n.view=c;return n}setupForRenderPass(e,t){for(var s,i,n=null!=(i=null==(s=this.renderPassDescriptor.colorAttachments)?void 0:s.length)?i:0,a=0;a<n;++a){var r=this.renderPassDescriptor.colorAttachments[a],o=e.colorArrayOps[a],l=t.isColorBufferSrgb(a);r.clearValue=l?o.clearValueLinear:o.clearValue,r.loadOp=o.clear?"clear":"load",r.storeOp=o.store?"store":"discard"}var h=this.renderPassDescriptor.depthStencilAttachment;h&&(h.depthClearValue=e.depthStencilOps.clearDepthValue,h.depthLoadOp=e.depthStencilOps.clearDepth?"clear":"load",h.depthStoreOp=e.depthStencilOps.storeDepth?"store":"discard",h.depthReadOnly=!1,this.depthAttachment.hasStencil&&(h.stencilClearValue=e.depthStencilOps.clearStencilValue,h.stencilLoadOp=e.depthStencilOps.clearStencil?"clear":"load",h.stencilStoreOp=e.depthStencilOps.storeStencil?"store":"discard",h.stencilReadOnly=!1))}loseContext(){this.initialized=!1}resolve(e,t,s,i){}constructor(e){this.initialized=!1,this.colorAttachments=[],this.depthAttachment=null,this.assignedColorTexture=null,this.renderPassDescriptor={},this.isBackbuffer=!1,this.renderTarget=e}}var Hn=[];Hn[2]=1,Hn[3]=2,Hn[4]=3,Hn[5]=4,Hn[1]=1,Hn[6]=2,Hn[7]=3,Hn[8]=4,Hn[0]=1,Hn[9]=2,Hn[10]=3,Hn[11]=4,Hn[12]=8,Hn[13]=12,Hn[14]=16,Hn[26]=1,Hn[27]=2,Hn[28]=3,Hn[29]=4;class Gn{get isArrayType(){return this.count>0}calculateOffset(e){var t=this.byteSize<=8?this.byteSize:16;this.count&&(t=16),e=pt.roundUp(e,t),this.offset=e/4}constructor(e,t,s=0){if(this.shortName=e,this.name=s?e+"[0]":e,this.type=t,this.numComponents=Hn[t],this.updateType=t,s>0)switch(t){case 2:this.updateType=17;break;case 1:this.updateType=ei;break;case Ks:this.updateType=31;break;case 0:this.updateType=32;break;case 3:this.updateType=21;break;case 6:this.updateType=ti;break;case Zs:this.updateType=34;break;case 9:this.updateType=35;break;case 4:this.updateType=22;break;case 7:this.updateType=si;break;case Js:this.updateType=37;break;case 10:this.updateType=38;break;case 5:this.updateType=23;break;case 8:this.updateType=39;break;case Qs:this.updateType=40;break;case 11:this.updateType=41;break;case $s:this.updateType=24}this.count=s;var i=this.numComponents;s&&(i=pt.roundUp(i,4)),this.byteSize=4*i,s&&(this.byteSize*=s)}}class Wn{get(e){return this.map.get(e)}getShaderDeclaration(e,t){var s="layout(set = "+e+", binding = "+t+", std140) uniform ub_"+ci[e]+" {\n";return this.uniforms.forEach((e=>{var t=ii[e.type];s+="    "+t+" "+e.shortName+(e.count?"["+e.count+"]":"")+";\n"})),s+"};\n"}constructor(e,t){this.byteSize=0,this.map=new Map,this.scope=e.scope,this.uniforms=t;for(var s=0,i=0;i<t.length;i++){var n=t[i];n.calculateOffset(s),s=4*n.offset+n.byteSize,n.scopeId=this.scope.resolve(n.name),this.map.set(n.name,n)}this.byteSize=pt.roundUp(s,16)}}var jn=/[ \t]*(\battribute\b|\bvarying\b|\buniform\b)/g,qn=/(\battribute\b|\bvarying\b|\bout\b|\buniform\b)[ \t]*([^;]+)(;+)/g,Xn="@@@",Yn=/([\w-]+)\[(.*?)\]/,$n=new Set(["highp","mediump","lowp"]),Kn=new Set(["sampler2DShadow","samplerCubeShadow","sampler2DArrayShadow"]),Zn={sampler2D:Ns,sampler3D:Ws,samplerCube:Hs,samplerCubeShadow:Hs,sampler2DShadow:Ns,sampler2DArray:Us,sampler2DArrayShadow:Us,isampler2D:Ns,usampler2D:Ns,isampler3D:Ws,usampler3D:Ws,isamplerCube:Hs,usamplerCube:Hs,isampler2DArray:Us,usampler2DArray:Us};let Jn=class{constructor(e,t){this.line=e;var s=e.trim().split(/\s+/);if($n.has(s[0])&&(this.precision=s.shift()),this.type=s.shift(),e.includes(","),e.includes("[")){var i=s.join(" "),n=Yn.exec(i);this.name=n[1],this.arraySize=Number(n[2]),isNaN(this.arraySize)&&(t.failed=!0)}else this.name=s.shift(),this.arraySize=0;this.isSampler=-1!==this.type.indexOf("sampler"),this.isSignedInt=-1!==this.type.indexOf("isampler"),this.isUnsignedInt=-1!==this.type.indexOf("usampler")}};class Qn{static run(e,t,s){var i=new Map,n=Qn.extract(t.vshader),a=Qn.extract(t.fshader),r=Qn.processAttributes(n.attributes,t.attributes,t.processingOptions),o=Qn.processVaryings(n.varyings,i,!0),l=Qn.processVaryings(a.varyings,i,!1),h=Qn.processOuts(a.outs),c=n.uniforms.concat(a.uniforms),d=Array.from(new Set(c)).map((e=>new Jn(e,s))),u=Qn.processUniforms(e,d,t.processingOptions,s),p=r+"\n"+o+"\n"+u.code,m=n.src.replace(Xn,p),f=l+"\n"+h+"\n"+u.code;return{vshader:m,fshader:a.src.replace(Xn,f),meshUniformBufferFormat:u.meshUniformBufferFormat,meshBindGroupFormat:u.meshBindGroupFormat}}static extract(e){for(var t,s=[],i=[],n=[],a=[],r=Xn+"\n";null!==(t=jn.exec(e));){var o=t[1];switch(o){case"attribute":case"varying":case"uniform":case"out":qn.lastIndex=t.index;var l=qn.exec(e);"attribute"===o?s.push(l[2]):"varying"===o?i.push(l[2]):"out"===o?n.push(l[2]):"uniform"===o&&a.push(l[2]),e=Qn.cutOut(e,t.index,qn.lastIndex,r),jn.lastIndex=t.index+r.length,r=""}}return{src:e,attributes:s,varyings:i,outs:n,uniforms:a}}static processUniforms(e,t,s,i){var n=[],a=[];t.forEach((e=>{e.isSampler?n.push(e):a.push(e)}));var r=[];a.forEach((e=>{if(!s.hasUniform(e.name)){var t=ii.indexOf(e.type),i=new Gn(e.name,t,e.arraySize);r.push(i)}})),0===r.length&&r.push(new Gn(ui,2));var o=r.length?new Wn(e,r):null,l=[];n.forEach((e=>{if(!s.hasTexture(e.name)){var t=0;e.isSignedInt?t=3:e.isUnsignedInt?t=4:("highp"===e.precision&&(t=1),Kn.has(e.type)&&(t=2));var i=Zn[e.type];l.push(new Ci(e.name,3,i,t))}}));var h=new Ai(e,l),c="";return s.uniformFormats.forEach(((e,t)=>{e&&(c+=e.getShaderDeclaration(t,0))})),o&&(c+=o.getShaderDeclaration(2,0)),s.bindGroupFormats.forEach(((e,t)=>{e&&(c+=e.getShaderDeclarationTextures(t))})),{code:c+=h.getShaderDeclarationTextures(1),meshUniformBufferFormat:o,meshBindGroupFormat:h}}static processVaryings(e,t,s){var i="",n=s?"out":"in";return e.forEach(((e,a)=>{var r=Qn.splitToWords(e),o=r.slice(0,-1).join(" "),l=r[r.length-1];s?t.set(l,a):a=t.get(l),i+="layout(location = "+a+") "+n+" "+o+" "+l+";\n"})),i}static processOuts(e){var t="";return e.forEach(((e,s)=>{t+="layout(location = "+s+") out "+e+";\n"})),t}static getTypeCount(e){var t=e.substring(e.length-1),s=parseInt(t,10);return isNaN(s)?1:s}static processAttributes(e,t,s){var i="";return e.forEach((e=>{var n=Qn.splitToWords(e),a=n[0],r=n[1];if(t.hasOwnProperty(r)){var o,l=t[r],h=vi[l],c=s.getVertexElement(l);if(c){var d=c.dataType;if(6!==d&&7!==d&&!c.normalize&&!c.asInt){var u=Qn.getTypeCount(a),p="_private_"+r;o="vec"+u+" "+r+" = vec"+u+"("+p+");\n",r=p;var m=0===d||2===d||4===d;a=1===u?m?"int":"uint":m?"ivec"+u:"uvec"+u}}i+="layout(location = "+h+") in "+a+" "+r+";\n",o&&(i+=o)}})),i}static splitToWords(e){return(e=e.replace(/\s+/g," ").trim()).split(" ")}static cutOut(e,t,s,i){return e.substring(0,t)+i+e.substring(s)}}var ea=/^[ \t]*(attribute|varying|uniform)[\t ]+/gm,ta=/^[ \t]*(attribute|varying|uniform)[ \t]*([^;]+)(;+)/gm,sa=/^[ \t]*var\s*(<[^>]+>)?\s*[\w\d_]+\s*:\s*(texture_.*|storage_texture_.*|storage.*|external_texture|array<.*>|sampler|sampler_comparison).*;\s*$/gm,ia=/(?:@interpolate\([^)]*\)\s*)?([\w]+)\s*:/,na="@@@",aa={f32:0,i32:3,u32:4},ra=e=>(e=e.replace(/\s+/g," ").trim()).split(/[\s:]+/);class oa{constructor(e,t){this.ubName=null,this.line=e;var s=ra(e);s.length<2?t.failed=!0:(this.name=s[0],this.type=s.slice(1).join(" "))}}var la=/^\s*var\s+([\w\d_]+)\s*:\s*array<([\w\d_<>]+),\s*(\d+)>;\s*$/,ha=/^\s*var\s+([\w\d_]+)\s*:\s*texture_(\w+)<([a-zA-Z0-9_,<>]*)>;\s*$/,ca=/^\s*var\s+([\w\d_]+)\s*:\s*(texture_storage_2d|texture_storage_2d_array)<([\w\d_]+),\s*(\w+)>\s*;\s*$/,da=/^\s*var\s*<storage,\s*(read|write)?>\s*([\w\d_]+)\s*:\s*(.*)\s*;\s*$/,ua=/^\s*var\s+([\w\d_]+)\s*:\s*texture_external;\s*$/,pa=/^\s*var\s+([\w\d_]+)\s*:\s*(sampler|sampler_comparison)\s*;\s*$/;class ma{constructor(e,t){this.originalLine=e,this.line=e,this.isTexture=!1,this.isSampler=!1,this.isStorageTexture=!1,this.isStorageBuffer=!1,this.isExternalTexture=!1,this.arraySize=0,this.type="",this.matchedElements=[];var s=e.match(la);s&&(this.name=s[1],this.arraySize=parseInt(s[3],10),this.line="var "+this.name+" : "+s[2]+";",this.matchedElements.push(...s),isNaN(this.arraySize)&&(t.failed=!0));var i=this.line.match(ha);i&&(this.name=i[1],this.type=i[2],this.textureFormat=i[3],this.isTexture=!0,this.matchedElements.push(...i),this.textureDimension=((e,t)=>{if(t){if("2d"===e)return Us;if("cube"===e)return Gs}else switch(e){case"1d":return"1d";case"2d":return Ns;case"3d":return Ws;case"cube":return Hs}})(this.type,this.arraySize>0),this.sampleType=aa[this.textureFormat]);var n=this.line.match(ca);n&&(this.isStorageTexture=!0,this.name=n[1],this.textureType=n[2],this.format=n[3],this.access=n[4],this.matchedElements.push(...n));var a=this.line.match(da);a&&(this.isStorageBuffer=!0,this.accessMode=a[1]||"none",this.name=a[2],this.type=a[3],this.matchedElements.push(...a));var r=this.line.match(ua);r&&(this.name=r[1],this.isExternalTexture=!0,this.matchedElements.push(...a));var o=this.line.match(pa);o&&(this.name=o[1],this.samplerType=o[2],this.isSampler=!0,this.matchedElements.push(...o)),0===this.matchedElements.length&&(t.failed=!0)}}class fa{static run(e,t,s){var i=new Map,n=fa.extract(t.vshader),a=fa.extract(t.fshader),r=fa.processAttributes(n.attributes,t.attributes,t.processingOptions),o=fa.processVaryings(n.varyings,i,!0),l=fa.processVaryings(a.varyings,i,!1),h=n.uniforms.concat(a.uniforms),c=Array.from(new Set(h)).map((e=>new oa(e,s))),d=fa.processUniforms(e,c,t.processingOptions,s);n.src=fa.renameUniformAccess(n.src,c),a.src=fa.renameUniformAccess(a.src,c);var u=n.resources.concat(a.resources),p=Array.from(new Set(u)).map((e=>new ma(e,s))),m=fa.processResources(e,p,t.processingOptions,s),f=fa.generateFragmentOutputStruct(a.src,e.maxColorAttachments),g=r+"\n"+o+"\n"+d.code+"\n"+m.code+"\n",v=n.src.replace(na,g),_=l+"\n"+f+"\n"+d.code+"\n"+m.code+"\n";return{vshader:v,fshader:a.src.replace(na,_),meshUniformBufferFormat:d.meshUniformBufferFormat,meshBindGroupFormat:m.meshBindGroupFormat}}static extract(e){for(var t,s=[],i=[],n=[],a=[],r=na+"\n";null!==(t=ea.exec(e));){var o=t[1];ta.lastIndex=t.index;var l=ta.exec(e);"attribute"===o?s.push(l[2]):"varying"===o?i.push(l[2]):"uniform"===o&&n.push(l[2]),e=fa.cutOut(e,t.index,ta.lastIndex,r),ea.lastIndex=t.index+r.length,r=""}for(;null!==(t=sa.exec(e));)a.push(t[0]),e=fa.cutOut(e,t.index,sa.lastIndex,r),sa.lastIndex=t.index+r.length,r="";return{src:e,attributes:s,varyings:i,uniforms:n,resources:a}}static processUniforms(e,t,s,i){var n=[];t.forEach((e=>{if(s.hasUniform(e.name))e.ubName="ub_view";else{e.ubName="ub_mesh_ub";var t=ai.get(e.type),i=new Gn(e.name,t,e.arraySize);n.push(i)}})),0===n.length&&n.push(new Gn(ui,2));var a=new Wn(e,n),r="";return s.uniformFormats.forEach(((e,t)=>{e&&(r+=fa.getUniformShaderDeclaration(e,t,0))})),a&&(r+=fa.getUniformShaderDeclaration(a,2,0)),{code:r,meshUniformBufferFormat:a}}static renameUniformAccess(e,t){return t.forEach((t=>{var s="uniform."+t.name,i=t.ubName+"."+t.name,n=new RegExp("\\b"+s+"\\b","g");e=e.replace(n,i)})),e}static processResources(e,t,s,i){for(var n=[],a=0;a<t.length;a++){var r=t[a];if(r.isTexture){var o=t[a+1],l=null==o?void 0:o.isSampler,h=r.sampleType,c=r.textureDimension;n.push(new Ci(r.name,3,c,h,l,l?o.name:null)),l&&a++}if(r.isStorageBuffer){var d="read_write"!==r.accessMode,u=new bi(r.name,3,d);u.format=r.type,n.push(u)}}var p=new Ai(e,n),m="";return s.bindGroupFormats.forEach(((e,t)=>{e&&(m+=fa.getTextureShaderDeclaration(e,t,1))})),{code:m+=fa.getTextureShaderDeclaration(p,1,0),meshBindGroupFormat:p}}static getUniformShaderDeclaration(e,t,s){var i=ci[t],n="struct_ub_"+i,a="struct "+n+" {\n";return e.uniforms.forEach((e=>{var t=ni[e.type][0];a+="    "+e.name+": "+t+(e.count?"["+e.count+"]":"")+",\n"})),a+="};\n",a+="@group("+t+") @binding("+s+") var<uniform> ub_"+i+" : "+n+";\n\n"}static getTextureShaderDeclaration(e,t,s){var i="",n=s;return e.textureFormats.forEach((e=>{var s=((e,t)=>{var s=0===t?"f32":3===t?"i32":"u32";switch(e){case"1d":return"texture_1d<"+s+">";case Ns:return"texture_2d<"+s+">";case Ws:return"texture_3d<"+s+">";case Hs:return"texture_cube<"+s+">";case Us:return"texture_2d_array<"+s+">";case Gs:return"texture_cube_array<"+s+">"}})(e.textureDimension,e.sampleType);i+="@group("+t+") @binding("+n+") var "+e.name+": "+s+";\n",n++,e.hasSampler&&(i+="@group("+t+") @binding("+n+") var "+e.samplerName+": sampler;\n",n++)})),e.storageBufferFormats.forEach((e=>{var s=e.readOnly?"read":"read_write";i+="@group("+t+") @binding("+n+") var<storage, "+s+"> "+e.name+" : "+e.format+";\n",n++})),i}static processVaryings(e,t,s){var i="";return e.forEach(((e,n)=>{var a=e.match(ia);if(a){var r=a[1];s?t.set(r,n):n=t.get(r),i+="    @location("+n+") "+e+",\n"}})),s?i+="    @builtin(position) position : vec4f,\n":(i+="    @builtin(position) position : vec4f,\n",i+="    @builtin(front_facing) frontFacing : bool,\n",i+="    @builtin(sample_index) sampleIndex : u32\n"),"struct "+(s?"VertexOutput":"FragmentInput")+" {\n"+i+"};\n"}static generateFragmentOutputStruct(e,t){for(var s="struct FragmentOutput {\n",i=0;i<t;i++)s+="    @location("+i+") color"+(i>0?i:"")+" : vec4f,\n";return-1!==e.search(/\.fragDepth\s*=/)&&(s+="    @builtin(frag_depth) fragDepth : f32\n"),s+"};\n"}static processAttributes(e,t,s){var i="";return e.forEach((e=>{var s=ra(e)[0];if(t.hasOwnProperty(s)){var n=t[s],a=vi[n];i+="    @location("+a+") "+e+",\n"}})),i+="    @builtin(vertex_index) vertexIndex : u32,\n","struct VertexInput {\n"+(i+="    @builtin(instance_index) instanceIndex : u32\n")+"};\n"}static cutOut(e,t,s,i){return e.substring(0,t)+i+e.substring(s)}}class ga{destroy(e){this._vertexCode=null,this._fragmentCode=null}createShaderModule(e,t){return this.shader.device.wgpu.createShaderModule({code:e})}getVertexShaderModule(){return this.createShaderModule(this._vertexCode,"Vertex")}getFragmentShaderModule(){return this.createShaderModule(this._fragmentCode,"Fragment")}getComputeShaderModule(){return this.createShaderModule(this._computeCode,"Compute")}processGLSL(){var e=this.shader,t=Qn.run(e.device,e.definition,e);this._vertexCode=this.transpile(t.vshader,"vertex",e.definition.vshader),this._fragmentCode=this.transpile(t.fshader,"fragment",e.definition.fshader),this._vertexCode&&this._fragmentCode?e.ready=!0:e.failed=!0,e.meshUniformBufferFormat=t.meshUniformBufferFormat,e.meshBindGroupFormat=t.meshBindGroupFormat}processWGSL(){var e=this.shader,t=fa.run(e.device,e.definition,e);this._vertexCode=t.vshader,this._fragmentCode=t.fshader,e.meshUniformBufferFormat=t.meshUniformBufferFormat,e.meshBindGroupFormat=t.meshBindGroupFormat}transpile(e,t,s){try{var i=this.shader.device.glslang.compileGLSL(e,t);return this.shader.device.twgsl.convertSpirV2WGSL(i)}catch(i){console.error("Failed to transpile webgl "+t+" shader ["+this.shader.label+"] to WebGPU while rendering "+void 0+", error:\n ["+i.stack+"]",{processed:e,original:s,shader:this.shader,error:i,stack:i.stack})}}get vertexCode(){return this._vertexCode}get fragmentCode(){return this._fragmentCode}loseContext(){}restoreContext(e,t){}constructor(e){this._vertexCode=null,this._fragmentCode=null,this._computeCode=null,this.vertexEntryPoint="main",this.fragmentEntryPoint="main",this.computeEntryPoint="main",this.shader=e;var t=e.definition;if(t.shaderLanguage===Ys){var s,i,n;if(t.cshader)this._computeCode=null!=(s=t.cshader)?s:null,this.computeUniformBufferFormats=t.computeUniformBufferFormats,this.computeBindGroupFormat=t.computeBindGroupFormat;else if(this.vertexEntryPoint="vertexMain",this.fragmentEntryPoint="fragmentMain",t.processingOptions)this.processWGSL();else this._vertexCode=null!=(i=t.vshader)?i:null,this._fragmentCode=null!=(n=t.fshader)?n:null,e.meshUniformBufferFormat=t.meshUniformBufferFormat,e.meshBindGroupFormat=t.meshBindGroupFormat;e.ready=!0}else t.processingOptions&&this.processGLSL()}}var va=[];va[0]="repeat",va[1]="clamp-to-edge",va[2]="mirror-repeat";var _a=[];_a[0]={level:"nearest",mip:"nearest"},_a[1]={level:"linear",mip:"nearest"},_a[2]={level:"nearest",mip:"nearest"},_a[3]={level:"nearest",mip:"linear"},_a[4]={level:"linear",mip:"nearest"},_a[5]={level:"linear",mip:"linear"};class ya{create(e){var t,s=this.texture,i=e.wgpu,n=s.numLevels;this.desc={size:{width:s.width,height:s.height,depthOrArrayLayers:s.cubemap?6:s.array?s.arrayLength:1},format:this.format,mipLevelCount:n,sampleCount:1,dimension:s.volume?"3d":"2d",usage:GPUTextureUsage.TEXTURE_BINDING|GPUTextureUsage.COPY_DST|GPUTextureUsage.COPY_SRC|(hs(s.format)?0:GPUTextureUsage.RENDER_ATTACHMENT)|(s.storage?GPUTextureUsage.STORAGE_BINDING:0)},this.gpuTexture=i.createTexture(this.desc),this.texture.format===es&&(t={format:"depth24plus",aspect:"depth-only"}),this.view=this.createView(t)}destroy(e){}propertyChanged(e){this.samplers.length=0}getView(e){return this.uploadImmediate(e,this.texture),this.view}createView(e){var t,s,i,n,a,r,o,l=null!=e?e:{},h=this.desc,c=this.texture,d={format:null!=(t=l.format)?t:h.format,dimension:null!=(s=l.dimension)?s:c.cubemap?"cube":c.volume?"3d":c.array?"2d-array":"2d",aspect:null!=(i=l.aspect)?i:"all",baseMipLevel:null!=(n=l.baseMipLevel)?n:0,mipLevelCount:null!=(a=l.mipLevelCount)?a:h.mipLevelCount,baseArrayLayer:null!=(r=l.baseArrayLayer)?r:0,arrayLayerCount:null!=(o=l.arrayLayerCount)?o:h.depthOrArrayLayers};return this.gpuTexture.createView(d)}getSampler(e,t){var s=this.samplers[t];if(!s){var i=this.texture,n={addressModeU:va[i.addressU],addressModeV:va[i.addressV],addressModeW:va[i.addressW]};if(!t&&i.compareOnRead&&(t=2),2===t||3===t||4===t)n.compare="less",n.magFilter="linear",n.minFilter="linear";else if(1===t)n.magFilter="nearest",n.minFilter="nearest",n.mipmapFilter="nearest";else{!e.textureFloatFilterable&&(i.format===Zt||i.format===Kt)||this.texture.format===es||ds(this.texture.format)?(n.magFilter="nearest",n.minFilter="nearest",n.mipmapFilter="nearest"):(n.magFilter=_a[i.magFilter].level,n.minFilter=_a[i.minFilter].level,n.mipmapFilter=_a[i.minFilter].mip)}var a="linear"===n.minFilter&&"linear"===n.magFilter&&"linear"===n.mipmapFilter;n.maxAnisotropy=a?pt.clamp(Math.round(i._anisotropy),1,e.maxTextureAnisotropy):1,s=e.wgpu.createSampler(n),this.samplers[t]=s}return s}loseContext(){}uploadImmediate(e,t){(t._needsUpload||t._needsMipmapsUpload)&&(this.uploadData(e),t._needsUpload=!1,t._needsMipmapsUpload=!1)}uploadData(e){var t=this.texture;if(t._levels){for(var s=!1,i=!1,n=t.numLevels,a=0;a<n;a++){var r=t._levels[a];if(r)if(t.cubemap)for(var o=0;o<6;o++){var l=r[o];l?this.isExternalImage(l)?(this.uploadExternalImage(e,l,a,o),s=!0):ArrayBuffer.isView(l)&&(this.uploadTypedArrayData(e,l,a,o),s=!0):i=!0}else if(t._volume);else if(t.array)if(t.arrayLength===r.length)for(var h=0;h<t._arrayLength;h++){var c=r[h];this.isExternalImage(c)?(this.uploadExternalImage(e,c,a,h),s=!0):ArrayBuffer.isView(c)&&(this.uploadTypedArrayData(e,c,a,h),s=!0)}else i=!0;else this.isExternalImage(r)?(this.uploadExternalImage(e,r,a,0),s=!0):ArrayBuffer.isView(r)&&(this.uploadTypedArrayData(e,r,a,0),s=!0);else i=!0}s&&i&&t.mipmaps&&!hs(t.format)&&!ds(t.format)&&e.mipmapRenderer.generate(this),t._gpuSize&&t.adjustVramSizeTracking(e._vram,-t._gpuSize),t._gpuSize=t.gpuSize,t.adjustVramSizeTracking(e._vram,t._gpuSize)}}isExternalImage(e){return e instanceof ImageBitmap||e instanceof HTMLVideoElement||e instanceof HTMLCanvasElement||e instanceof OffscreenCanvas}uploadExternalImage(e,t,s,i){var n={source:t,origin:[0,0],flipY:!1},a={texture:this.gpuTexture,mipLevel:s,origin:[0,0,i],aspect:"all"},r={width:this.desc.size.width,height:this.desc.size.height,depthOrArrayLayers:1};e.submit(),t instanceof HTMLCanvasElement&&t.getContext("2d"),e.wgpu.queue.copyExternalImageToTexture(n,a,r)}uploadTypedArrayData(e,t,s,i){var n=this.texture,a=e.wgpu,r={texture:this.gpuTexture,origin:[0,0,i],mipLevel:s},o=Pi.calcLevelDimension(n.width,s),l=Pi.calcLevelDimension(n.height,s);Pi.calcLevelGpuSize(o,l,1,n.format);var h,c,d=ls.get(n.format);if(d.size)h={offset:0,bytesPerRow:d.size*o,rowsPerImage:l},c={width:o,height:l};else if(d.blockSize){var u=e=>Math.floor((e+3)/4);h={offset:0,bytesPerRow:d.blockSize*u(o),rowsPerImage:u(l)},c={width:Math.max(4,o),height:Math.max(4,l)}}e.submit(),a.queue.writeTexture(r,t,h,c)}read(e,t,s,i,n){var a,r,o,l,h=null!=(a=n.mipLevel)?a:0,c=null!=(r=n.face)?r:0,d=null!=(o=n.data)?o:null,u=null!=(l=n.immediate)&&l,p=this.texture,m=s*ls.get(p.format).size,f=pt.roundUp(m,256),g=f*i,v=p.device,_=v.createBufferImpl(9);_.allocate(v,g);var y={texture:this.gpuTexture,mipLevel:h,origin:[e,t,c]},x={buffer:_.buffer,offset:0,bytesPerRow:f},w={width:s,height:i,depthOrArrayLayers:1};return v.getCommandEncoder().copyTextureToBuffer(y,x,w),v.readBuffer(_,g,null,u).then((e=>{null!=d||(d=new Uint8Array(i*m));for(var t=0;t<i;t++){var s=t*f,n=t*m,a=e.subarray(s,s+m);d.set(a,n)}return d}))}constructor(e){this.samplers=[],this.texture=e,this.format=dn[e.format],this.create(e.device)}}class xa extends gn{unlock(e){var t=e.device;super.unlock(t,e.storageInt32.buffer)}constructor(e){super(64)}}class wa extends gn{unlock(e){var t=e.device;super.unlock(t,e.storage)}constructor(e,t,s){super(32|((null==s?void 0:s.storage)?128:0))}}var ba=/[ \t]*#(ifn?def|if|endif|else|elif|define|undef|extension|include)/g,Ca=/define[ \t]+([^\n]+)\r?(?:\n|$)/g,Sa=/extension[ \t]+([\w-]+)[ \t]*:[ \t]*(enable|require)/g,Aa=/undef[ \t]+([^\n]+)\r?(?:\n|$)/g,Ta=/(ifdef|ifndef|if)[ \t]*([^\r\n]+)\r?\n/g,Pa=/(endif|else|elif)([ \t][^\r\n]+)?\r?(?:\n|$)/g,Ea=/([\w-]+)/,ka=/(!|\s)?defined\(([\w-]+)\)/,Ma=/([a-z_]\w*)\s*(==|!=|<|<=|>|>=)\s*([\w"']+)/i,Ia=/[|&+-]/g,Da=/include[ \t]+"([\w-]+)"\r?(?:\n|$)/g;class Ra{static run(e,t,s){void 0===t&&(t=new Map),void 0===s&&(s={}),Ra.sourceName=s.sourceName,e=(e=this.stripComments(e)).split(/\r?\n/).map((e=>e.trimEnd())).join("\n");var i=new Map;if(s.stripUnusedColorAttachments){var n=new Map,a=e.match(/(pcFragColor[1-8])\b/g);null==a||a.forEach((e=>{var t,s=parseInt(e.charAt(e.length-1),10);n.set(s,(null!=(t=n.get(s))?t:0)+1)})),n.forEach(((e,t)=>{1===e&&i.set("REMOVE_COLOR_ATTACHMENT_"+t,"")}))}e=this._preprocess(e,i,t,s.stripDefines);var r=new Map;i.forEach(((e,t)=>{Number.isInteger(parseFloat(e))&&!e.includes(".")&&r.set(t,e)}));var o=new Map;return i.forEach(((e,t)=>{t.startsWith("__INJECT_")&&o.set(t,e)})),e=this.stripComments(e),e=this.RemoveEmptyLines(e),e=this.processArraySize(e,r),e=this.injectDefines(e,o)}static stripComments(e){return e.replace(/\/\*[\s\S]*?\*\/|([^\\:]|^)\/\/.*$/gm,"$1")}static processArraySize(e,t){return null!==e&&t.forEach(((t,s)=>{e=e.replace(new RegExp("\\["+s+"\\]","g"),"["+t+"]")})),e}static injectDefines(e,t){if(null!==e&&t.size>0){var s=e.split("\n");t.forEach(((e,t)=>{for(var i=new RegExp("\\b"+t+"\\b","g"),n=0;n<s.length;n++)s[n].includes("#")||(s[n]=s[n].replace(i,e))})),e=s.join("\n")}return e}static RemoveEmptyLines(e){return null!==e&&(e=(e=e.split(/\r?\n/).map((e=>""===e.trim()?"":e)).join("\n")).replace(/(\n\n){3,}/g,"\n\n")),e}static _preprocess(e,t,s,i){void 0===t&&(t=new Map);for(var n,a=e,r=[],o=!1;null!==(n=ba.exec(e));){var l=n[1];switch(l){case"define":Ca.lastIndex=n.index;var h=Ca.exec(e);o||(o=null===h);var c=h[1];Ea.lastIndex=h.index;var d=Ea.exec(c)[1],u=c.substring(d.length).trim();""===u&&(u="true"),Ra._keep(r)&&(t.set(d,u),i&&(e=e.substring(0,h.index-1)+e.substring(Ca.lastIndex),ba.lastIndex=h.index-1)),i||(ba.lastIndex=h.index+h[0].length);break;case"undef":Aa.lastIndex=n.index;var p=Aa.exec(e),m=p[1].trim();Ra._keep(r)&&(t.delete(m),i&&(e=e.substring(0,p.index-1)+e.substring(Aa.lastIndex),ba.lastIndex=p.index-1)),i||(ba.lastIndex=p.index+p[0].length);break;case"extension":Sa.lastIndex=n.index;var f=Sa.exec(e);if(o||(o=null===f),f){var g=f[1];Ra._keep(r)&&t.set(g,"true")}ba.lastIndex=f.index+f[0].length;break;case"ifdef":case"ifndef":case"if":Ta.lastIndex=n.index;var v=Ta.exec(e),_=v[2],y=Ra.evaluate(_,t);o||(o=y.error);var x=y.result;"ifndef"===l&&(x=!x),r.push({anyKeep:x,keep:x,start:n.index,end:Ta.lastIndex}),ba.lastIndex=v.index+v[0].length;break;case"endif":case"else":case"elif":Pa.lastIndex=n.index;var w=Pa.exec(e),b=r.pop(),C=b.keep?e.substring(b.end,n.index):"";e=e.substring(0,b.start)+C+e.substring(Pa.lastIndex),ba.lastIndex=b.start+C.length;var S=w[1];if("else"===S||"elif"===S){var A=!1;if(!b.anyKeep)if("else"===S)A=!b.keep;else{var T=Ra.evaluate(w[2],t);A=T.result,o||(o=T.error)}r.push({anyKeep:b.anyKeep||A,keep:A,start:ba.lastIndex,end:ba.lastIndex})}break;case"include":Da.lastIndex=n.index;var P=Da.exec(e);o||(o=null===P);var E=P[1].trim();if(Ra._keep(r)){var k=null==s?void 0:s.get(E);void 0!==k?(e=e.substring(0,P.index-1)+k+e.substring(Da.lastIndex),ba.lastIndex=P.index-1):(console.error('Include "'+E+'" not resolved while preprocessing '+Ra.sourceName,{source:a}),o=!0)}}}return o?(console.warn("Failed to preprocess shader: ",{source:a}),a):e}static _keep(e){for(var t=0;t<e.length;t++)if(!e[t].keep)return!1;return!0}static evaluate(e,t){var s=null===Ia.exec(e),i=!1,n=ka.exec(e);n&&(i="!"===n[1],e=n[2]);var a=Ma.exec(e);if(a){var r,o,l=null!=(r=t.get(a[1]))?r:a[1],h=null!=(o=t.get(a[3]))?o:a[3],c=!1;switch(a[2]){case"==":c=l===h;break;case"!=":c=l!==h;break;case"<":c=l<h;break;case"<=":c=l<=h;break;case">":c=l>h;break;case">=":c=l>=h}return{result:c,error:!s}}e=e.trim();var d=t.has(e);return i&&(d=!d),{result:d,error:!s}}}var La="\n#ifndef outType_0\n#define outType_0 vec4\n#endif\nlayout(location = 0) out highp outType_0 pc_fragColor;\n#ifndef REMOVE_COLOR_ATTACHMENT_1\n#if COLOR_ATTACHMENT_1\nlayout(location = 1) out highp outType_1 pc_fragColor1;\n#endif\n#endif\n#ifndef REMOVE_COLOR_ATTACHMENT_2\n#if COLOR_ATTACHMENT_2\nlayout(location = 2) out highp outType_2 pc_fragColor2;\n#endif\n#endif\n#ifndef REMOVE_COLOR_ATTACHMENT_3\n#if COLOR_ATTACHMENT_3\nlayout(location = 3) out highp outType_3 pc_fragColor3;\n#endif\n#endif\n#ifndef REMOVE_COLOR_ATTACHMENT_4\n#if COLOR_ATTACHMENT_4\nlayout(location = 4) out highp outType_4 pc_fragColor4;\n#endif\n#endif\n#ifndef REMOVE_COLOR_ATTACHMENT_5\n#if COLOR_ATTACHMENT_5\nlayout(location = 5) out highp outType_5 pc_fragColor5;\n#endif\n#endif\n#ifndef REMOVE_COLOR_ATTACHMENT_6\n#if COLOR_ATTACHMENT_6\nlayout(location = 6) out highp outType_6 pc_fragColor6;\n#endif\n#endif\n#ifndef REMOVE_COLOR_ATTACHMENT_7\n#if COLOR_ATTACHMENT_7\nlayout(location = 7) out highp outType_7 pc_fragColor7;\n#endif\n#endif\n#define gl_FragColor pc_fragColor\n#define pcFragColor0 pc_fragColor\n#define pcFragColor1 pc_fragColor1\n#define pcFragColor2 pc_fragColor2\n#define pcFragColor3 pc_fragColor3\n#define pcFragColor4 pc_fragColor4\n#define pcFragColor5 pc_fragColor5\n#define pcFragColor6 pc_fragColor6\n#define pcFragColor7 pc_fragColor7\n#define varying in\n#define texture2D texture\n#define texture2DBias texture\n#define textureCube texture\n#define texture2DProj textureProj\n#define texture2DLod textureLod\n#define texture2DProjLod textureProjLod\n#define textureCubeLod textureLod\n#define texture2DGrad textureGrad\n#define texture2DProjGrad textureProjGrad\n#define textureCubeGrad textureGrad\n#define utexture2D texture\n#define itexture2D texture\n#define texture2DLodEXT texture2DLodEXT_is_no_longer_supported_use_texture2DLod_instead\n#define texture2DProjLodEXT texture2DProjLodEXT_is_no_longer_supported_use_texture2DProjLod\n#define textureCubeLodEXT textureCubeLodEXT_is_no_longer_supported_use_textureCubeLod_instead\n#define texture2DGradEXT texture2DGradEXT_is_no_longer_supported_use_texture2DGrad_instead\n#define texture2DProjGradEXT texture2DProjGradEXT_is_no_longer_supported_use_texture2DProjGrad_instead\n#define textureCubeGradEXT textureCubeGradEXT_is_no_longer_supported_use_textureCubeGrad_instead\n#define textureShadow(res, uv) textureGrad(res, uv, vec2(1, 1), vec2(1, 1))\n#define SHADOWMAP_PASS(name) name\n#define SHADOWMAP_ACCEPT(name) sampler2DShadow name\n#define TEXTURE_PASS(name) name\n#define TEXTURE_ACCEPT(name) sampler2D name\n#define TEXTURE_ACCEPT_HIGHP(name) highp sampler2D name\n#define GL2\n",Fa="\n#define attribute in\n#define varying out\n#define texture2D texture\n#define utexture2D texture\n#define itexture2D texture\n#define GL2\n#define VERTEXSHADER\n#define TEXTURE_PASS(name) name\n#define TEXTURE_ACCEPT(name) sampler2D name\n#define TEXTURE_ACCEPT_HIGHP(name) highp sampler2D name\n",Ba="\n#extension GL_EXT_samplerless_texture_functions : require\n#ifndef outType_0\n#define outType_0 vec4\n#endif\n#ifndef outType_1\n#define outType_1 vec4\n#endif\n#ifndef outType_2\n#define outType_2 vec4\n#endif\n#ifndef outType_3\n#define outType_3 vec4\n#endif\n#ifndef outType_4\n#define outType_4 vec4\n#endif\n#ifndef outType_5\n#define outType_5 vec4\n#endif\n#ifndef outType_6\n#define outType_6 vec4\n#endif\n#ifndef outType_7\n#define outType_7 vec4\n#endif\nlayout(location = 0) out highp outType_0 pc_fragColor;\nlayout(location = 1) out highp outType_1 pc_fragColor1;\nlayout(location = 2) out highp outType_2 pc_fragColor2;\nlayout(location = 3) out highp outType_3 pc_fragColor3;\nlayout(location = 4) out highp outType_4 pc_fragColor4;\nlayout(location = 5) out highp outType_5 pc_fragColor5;\nlayout(location = 6) out highp outType_6 pc_fragColor6;\nlayout(location = 7) out highp outType_7 pc_fragColor7;\n#define gl_FragColor pc_fragColor\n#define pcFragColor0 pc_fragColor\n#define pcFragColor1 pc_fragColor1\n#define pcFragColor2 pc_fragColor2\n#define pcFragColor3 pc_fragColor3\n#define pcFragColor4 pc_fragColor4\n#define pcFragColor5 pc_fragColor5\n#define pcFragColor6 pc_fragColor6\n#define pcFragColor7 pc_fragColor7\n#define texture2D(res, uv) texture(sampler2D(res, res ## _sampler), uv)\n#define texture2DBias(res, uv, bias) texture(sampler2D(res, res ## _sampler), uv, bias)\n#define texture2DLod(res, uv, lod) textureLod(sampler2D(res, res ## _sampler), uv, lod)\n#define textureCube(res, uv) texture(samplerCube(res, res ## _sampler), uv)\n#define textureCubeLod(res, uv, lod) textureLod(samplerCube(res, res ## _sampler), uv, lod)\n#define textureShadow(res, uv) textureLod(sampler2DShadow(res, res ## _sampler), uv, 0.0)\n#define itexture2D(res, uv) texture(isampler2D(res, res ## _sampler), uv)\n#define utexture2D(res, uv) texture(usampler2D(res, res ## _sampler), uv)\n#define texture2DLodEXT texture2DLodEXT_is_no_longer_supported_use_texture2DLod_instead\n#define texture2DProjLodEXT texture2DProjLodEXT_is_no_longer_supported_use_texture2DProjLod\n#define textureCubeLodEXT textureCubeLodEXT_is_no_longer_supported_use_textureCubeLod_instead\n#define texture2DGradEXT texture2DGradEXT_is_no_longer_supported_use_texture2DGrad_instead\n#define texture2DProjGradEXT texture2DProjGradEXT_is_no_longer_supported_use_texture2DProjGrad_instead\n#define textureCubeGradEXT textureCubeGradEXT_is_no_longer_supported_use_textureCubeGrad_instead\n#define SHADOWMAP_PASS(name) name, name ## _sampler\n#define SHADOWMAP_ACCEPT(name) texture2D name, sampler name ## _sampler\n#define TEXTURE_PASS(name) name, name ## _sampler\n#define TEXTURE_ACCEPT(name) texture2D name, sampler name ## _sampler\n#define TEXTURE_ACCEPT_HIGHP TEXTURE_ACCEPT\n#define GL2\n#define WEBGPU\n",Oa="\n#extension GL_EXT_samplerless_texture_functions : require\n#define texture2D(res, uv) texture(sampler2D(res, res ## _sampler), uv)\n#define itexture2D(res, uv) texture(isampler2D(res, res ## _sampler), uv)\n#define utexture2D(res, uv) texture(usampler2D(res, res ## _sampler), uv)\n#define TEXTURE_PASS(name) name, name ## _sampler\n#define TEXTURE_ACCEPT(name) texture2D name, sampler name ## _sampler\n#define TEXTURE_ACCEPT_HIGHP TEXTURE_ACCEPT\n#define GL2\n#define WEBGPU\n#define VERTEXSHADER\n#define gl_VertexID gl_VertexIndex\n#define gl_InstanceID gl_InstanceIndex\n",za="\nvec2 getGrabScreenPos(vec4 clipPos) {\n\tvec2 uv = (clipPos.xy / clipPos.w) * 0.5 + 0.5;\n\t#ifdef WEBGPU\n\t\tuv.y = 1.0 - uv.y;\n\t#endif\n\treturn uv;\n}\nvec2 getImageEffectUV(vec2 uv) {\n\t#ifdef WEBGPU\n\t\tuv.y = 1.0 - uv.y;\n\t#endif\n\treturn uv;\n}\n",Va={vertex_position:ms,vertex_normal:fs,vertex_tangent:gs,vertex_texCoord0:ws,vertex_texCoord1:bs,vertex_texCoord2:Cs,vertex_texCoord3:Ss,vertex_texCoord4:As,vertex_texCoord5:Ts,vertex_texCoord6:Ps,vertex_texCoord7:Es,vertex_color:ys,vertex_boneIndices:_s,vertex_boneWeights:vs};class Na{static createDefinition(e,t){var s,i,n,a,r=(t,s,i,n)=>{var a=e.isWebGPU?t:s,r="";if(!i){var o,l=null!=(o=n.fragmentOutputTypes)?o:"vec4";Array.isArray(l)||(l=[l]);for(var h=0;h<e.maxColorAttachments;h++){var c;r+="#define COLOR_ATTACHMENT_"+h+"\n",r+="#define outType_"+h+" "+(null!=(c=l[h])?c:"vec4")+"\n"}}return r+a},o=null!=(s=t.name)?s:"Untitled";return t.shaderLanguage===Ys?(i=t.vertexCode,n=t.fragmentCode):(i=Na.versionCode(e)+r(Oa,Fa,!0,t)+Na.getDefinesCode(t.vertexDefines)+Na.precisionCode(e)+"\n"+za+Na.getShaderNameCode(o)+t.vertexCode,n=(t.fragmentPreamble||"")+Na.versionCode(e)+r(Ba,La,!1,t)+Na.getDefinesCode(t.fragmentDefines)+Na.precisionCode(e)+"\n"+za+Na.getShaderNameCode(o)+(t.fragmentCode||Na.dummyFragmentCode())),{name:o,shaderLanguage:null!=(a=t.shaderLanguage)?a:Xs,attributes:t.attributes,vshader:i,vincludes:t.vertexIncludes,fincludes:t.fragmentIncludes,fshader:n,useTransformFeedback:t.useTransformFeedback,meshUniformBufferFormat:t.meshUniformBufferFormat,meshBindGroupFormat:t.meshBindGroupFormat}}static getDefinesCode(e){var t="";return null==e||e.forEach(((e,s)=>{t+="#define "+s+" "+e+"\n"})),t}static getShaderNameCode(e){return"#define SHADER_NAME "+e+"\n"}static dummyFragmentCode(){return"void main(void) {gl_FragColor = vec4(0.0);}"}static versionCode(e){return e.isWebGPU?"#version 450\n":"#version 300 es\n"}static precisionCode(e,t){t&&"highp"!==t&&"mediump"!==t&&"lowp"!==t&&(t=null),t&&("highp"===t&&"highp"!==e.maxPrecision&&(t="mediump"),"mediump"===t&&"lowp"===e.maxPrecision&&(t="lowp"));var s=t||e.precision;return"\n            precision "+s+" float;\n            precision "+s+" int;\n            precision "+s+" usampler2D;\n            precision "+s+" isampler2D;\n            precision "+s+" sampler2DShadow;\n            precision "+s+" samplerCubeShadow;\n            precision "+s+" sampler2DArray;\n        "}static collectAttributes(e){for(var t={},s=0,i=e.indexOf("attribute");i>=0&&!(i>0&&"/"===e[i-1]);){var n=!1;if(i>0){var a=e.lastIndexOf("\n",i);a=-1!==a?a+1:0,e.substring(a,i).includes("#")&&(n=!0)}if(!n){var r=e.indexOf(";",i),o=e.lastIndexOf(" ",r),l=e.substring(o+1,r);if(t[l]);else{var h=Va[l];void 0!==h?t[l]=h:(t[l]="ATTR"+s,s++)}}i=e.indexOf("attribute",i+1)}return t}}var Ua=0;class Ha{init(){this.ready=!1,this.failed=!1}get label(){return"Shader Id "+this.id+" "+this.name}destroy(){this.device.onDestroyShader(this),this.impl.destroy(this)}loseContext(){this.init(),this.impl.loseContext()}restoreContext(){this.impl.restoreContext(this.device,this)}constructor(e,t){if(this.id=Ua++,this.device=e,this.definition=t,this.name=t.name||"Untitled",this.init(),t.cshader);else{var s;if(t.vshader=Ra.run(t.vshader,t.vincludes,{sourceName:"vertex shader for "+this.label}),t.shaderLanguage===Xs)null!=(s=t).attributes||(s.attributes=Na.collectAttributes(t.vshader));var i=e.isWebGL2&&("osx"===Qe.name||"ios"===Qe.name);t.fshader=Ra.run(t.fshader,t.fincludes,{stripUnusedColorAttachments:i,sourceName:"fragment shader for "+this.label})}this.impl=e.createShaderImpl(this)}}class Ga{}class Wa{}class ja{destroy(){this.gpuBuffers.forEach((e=>{e.destroy(this.device)})),this.gpuBuffers=null,this.stagingBuffers.forEach((e=>{e.destroy(this.device)})),this.stagingBuffers=null,this.usedBuffers=null,this.activeBuffer=null}alloc(e,t){if(this.activeBuffer){var s=pt.roundUp(this.activeBuffer.size,this.bufferAlignment);this.bufferSize-s<t&&this.scheduleSubmit()}if(!this.activeBuffer){var i=this.gpuBuffers.pop();i||(i=this.createBuffer(this.device,this.bufferSize,!1));var n=this.stagingBuffers.pop();n||(n=this.createBuffer(this.device,this.bufferSize,!0)),this.activeBuffer=new Ga,this.activeBuffer.stagingBuffer=n,this.activeBuffer.gpuBuffer=i,this.activeBuffer.offset=0,this.activeBuffer.size=0}var a=this.activeBuffer,r=pt.roundUp(a.size,this.bufferAlignment);e.gpuBuffer=a.gpuBuffer,e.offset=r,e.storage=a.stagingBuffer.alloc(r,t),a.size=r+t}scheduleSubmit(){this.activeBuffer&&(this.usedBuffers.push(this.activeBuffer),this.activeBuffer=null)}submit(){this.scheduleSubmit()}constructor(e,t,s){this.gpuBuffers=[],this.stagingBuffers=[],this.usedBuffers=[],this.activeBuffer=null,this.device=e,this.bufferSize=t,this.bufferAlignment=s}}var qa=[];qa[2]=function(e,t,s){e.storageFloat32[s]=t},qa[3]=(e,t,s)=>{var i=e.storageFloat32;i[s]=t[0],i[s+1]=t[1]},qa[4]=(e,t,s)=>{var i=e.storageFloat32;i[s]=t[0],i[s+1]=t[1],i[s+2]=t[2]},qa[5]=(e,t,s)=>{var i=e.storageFloat32;i[s]=t[0],i[s+1]=t[1],i[s+2]=t[2],i[s+3]=t[3]},qa[1]=function(e,t,s){e.storageInt32[s]=t},qa[6]=function(e,t,s){var i=e.storageInt32;i[s]=t[0],i[s+1]=t[1]},qa[7]=function(e,t,s){var i=e.storageInt32;i[s]=t[0],i[s+1]=t[1],i[s+2]=t[2]},qa[8]=function(e,t,s){var i=e.storageInt32;i[s]=t[0],i[s+1]=t[1],i[s+2]=t[2],i[s+3]=t[3]},qa[12]=(e,t,s)=>{var i=e.storageFloat32;i[s]=t[0],i[s+1]=t[1],i[s+4]=t[2],i[s+5]=t[3],i[s+8]=t[4],i[s+9]=t[5]},qa[13]=(e,t,s)=>{var i=e.storageFloat32;i[s]=t[0],i[s+1]=t[1],i[s+2]=t[2],i[s+4]=t[3],i[s+5]=t[4],i[s+6]=t[5],i[s+8]=t[6],i[s+9]=t[7],i[s+10]=t[8]},qa[17]=function(e,t,s,i){for(var n=e.storageFloat32,a=0;a<i;a++)n[s+4*a]=t[a]},qa[21]=(e,t,s,i)=>{for(var n=e.storageFloat32,a=0;a<i;a++)n[s+4*a]=t[2*a],n[s+4*a+1]=t[2*a+1]},qa[22]=(e,t,s,i)=>{for(var n=e.storageFloat32,a=0;a<i;a++)n[s+4*a]=t[3*a],n[s+4*a+1]=t[3*a+1],n[s+4*a+2]=t[3*a+2]},qa[26]=(e,t,s,i)=>{e.storageUint32[s]=t},qa[27]=(e,t,s,i)=>{var n=e.storageUint32;n[s]=t[0],n[s+1]=t[1]},qa[28]=(e,t,s,i)=>{var n=e.storageUint32;n[s]=t[0],n[s+1]=t[1],n[s+2]=t[2]},qa[29]=(e,t,s,i)=>{var n=e.storageUint32;n[s]=t[0],n[s+1]=t[1],n[s+2]=t[2],n[s+3]=t[3]},qa[30]=function(e,t,s,i){for(var n=e.storageInt32,a=0;a<i;a++)n[s+4*a]=t[a]},qa[32]=qa[30],qa[31]=function(e,t,s,i){for(var n=e.storageUint32,a=0;a<i;a++)n[s+4*a]=t[a]},qa[33]=(e,t,s,i)=>{for(var n=e.storageInt32,a=0;a<i;a++)n[s+4*a]=t[2*a],n[s+4*a+1]=t[2*a+1]},qa[35]=qa[33],qa[34]=(e,t,s,i)=>{for(var n=e.storageUint32,a=0;a<i;a++)n[s+4*a]=t[2*a],n[s+4*a+1]=t[2*a+1]},qa[36]=(e,t,s,i)=>{for(var n=e.storageInt32,a=0;a<i;a++)n[s+4*a]=t[3*a],n[s+4*a+1]=t[3*a+1],n[s+4*a+2]=t[3*a+2]},qa[38]=qa[36],qa[37]=(e,t,s,i)=>{for(var n=e.storageUint32,a=0;a<i;a++)n[s+4*a]=t[3*a],n[s+4*a+1]=t[3*a+1],n[s+4*a+2]=t[3*a+2]};class Xa{destroy(){if(this.persistent){var e=this.device;this.impl.destroy(e),e._vram.ub-=this.format.byteSize}}get offset(){return this.persistent?0:this.allocation.offset}assignStorage(e){this.storageInt32=e,this.storageUint32=new Uint32Array(e.buffer,e.byteOffset,e.byteLength/4),this.storageFloat32=new Float32Array(e.buffer,e.byteOffset,e.byteLength/4)}loseContext(){var e;null==(e=this.impl)||e.loseContext()}setUniform(e,t){var s=e.offset;if(null!=t){var i=qa[e.updateType];i?i(this,t,s,e.count):this.storageFloat32.set(t,s)}}set(e,t){var s=this.format.map.get(e);s&&this.setUniform(s,t)}startUpdate(e){if(!this.persistent){var t=this.allocation,s=t.gpuBuffer;this.device.dynamicBuffers.alloc(t,this.format.byteSize),this.assignStorage(t.storage),e&&(e.bindGroup=t.gpuBuffer.getBindGroup(this),e.offsets[0]=t.offset),s!==t.gpuBuffer&&(this.renderVersionDirty=this.device.renderVersion)}}endUpdate(){this.persistent?this.impl.unlock(this):(this.storageFloat32=null,this.storageInt32=null)}update(e){this.startUpdate(e);for(var t=this.format.uniforms,s=0;s<t.length;s++){var i=t[s].scopeId.value;this.setUniform(t[s],i)}this.endUpdate()}constructor(e,t,s=!0){if(this.renderVersionDirty=0,this.device=e,this.format=t,this.persistent=s,s){this.impl=e.createUniformBufferImpl(this);var i=new ArrayBuffer(t.byteSize);this.assignStorage(new Int32Array(i)),e._vram.ub+=this.format.byteSize}else this.allocation=new Wa}}var Ya={type:5,base:0,count:4,indexed:!1};class $a{destroy(){this.shader.destroy(),this.shader=null,this.uniformBuffer.destroy(),this.uniformBuffer=null}clear(e,t,s,i){var n,a=null!=(n=(s=s||i).flags)?n:i.flags;if(0!==a){var{uniformBuffer:r,dynamicBindGroup:o}=this;if(r.startUpdate(o),e.setBindGroup(2,o.bindGroup,o.offsets),e.setBindGroup(1,e.emptyBindGroup),1&a&&(t.colorBuffer||t.impl.assignedColorTexture)){var l,h=null!=(l=s.color)?l:i.color;this.colorData.set(h),e.setBlendState(Vi.NOBLEND)}else e.setBlendState(Vi.NOWRITE);if(r.set("color",this.colorData),2&a&&t.depth){var c,d=null!=(c=s.depth)?c:i.depth;r.set("depth",d),e.setDepthState(Hi.WRITEDEPTH)}else r.set("depth",1),e.setDepthState(Hi.NODEPTH);r.endUpdate(),e.setCullMode(0),e.setShader(this.shader),e.draw(Ya)}}constructor(e){var t="\n\n            struct ub_mesh {\n                color : vec4f,\n                depth: f32\n            }\n\n            @group(2) @binding(0) var<uniform> ubMesh : ub_mesh;\n\n            var<private> pos : array<vec2f, 4> = array<vec2f, 4>(\n                vec2(-1.0, 1.0), vec2(1.0, 1.0),\n                vec2(-1.0, -1.0), vec2(1.0, -1.0)\n            );\n\n            struct VertexOutput {\n                @builtin(position) position : vec4f\n            }\n\n            @vertex\n            fn vertexMain(@builtin(vertex_index) vertexIndex : u32) -> VertexOutput {\n                var output : VertexOutput;\n                output.position = vec4(pos[vertexIndex], ubMesh.depth, 1.0);\n                return output;\n            }\n\n            @fragment\n            fn fragmentMain() -> @location(0) vec4f {\n                return ubMesh.color;\n            }\n        ";this.shader=new Ha(e,{name:"WebGPUClearRendererShader",shaderLanguage:Ys,vshader:t,fshader:t}),this.uniformBuffer=new Xa(e,new Wn(e,[new Gn("color",5),new Gn("depth",2)]),!1),this.dynamicBindGroup=new Fi,this.colorData=new Float32Array(4)}}class Ka{destroy(){this.shader.destroy(),this.shader=null}generate(e){var t=e.desc;if(!(t.mipLevelCount<=1||e.texture.volume)){for(var s=this.device,i=s.wgpu,n=this.shader.impl,a=i.createRenderPipeline({layout:"auto",vertex:{module:n.getVertexShaderModule(),entryPoint:n.vertexEntryPoint},fragment:{module:n.getFragmentShaderModule(),entryPoint:n.fragmentEntryPoint,targets:[{format:t.format}]},primitive:{topology:"triangle-strip"}}),r=e.texture,o=r.cubemap?6:r.array?r.arrayLength:1,l=[],h=0;h<o;h++)l.push(e.createView({dimension:"2d",baseMipLevel:0,mipLevelCount:1,baseArrayLayer:h}));for(var c=s.getCommandEncoder(),d=1;d<t.mipLevelCount;d++)for(var u=0;u<o;u++){var p=e.createView({dimension:"2d",baseMipLevel:d,mipLevelCount:1,baseArrayLayer:u}),m=c.beginRenderPass({colorAttachments:[{view:p,loadOp:"clear",storeOp:"store"}]}),f=i.createBindGroup({layout:a.getBindGroupLayout(0),entries:[{binding:0,resource:this.minSampler},{binding:1,resource:l[u]}]});m.setPipeline(a),m.setBindGroup(0,f),m.draw(4),m.end(),l[u]=p}s.pipeline=null}}constructor(e){this.device=e;var t="\n \n            var<private> pos : array<vec2f, 4> = array<vec2f, 4>(\n                vec2(-1.0, 1.0), vec2(1.0, 1.0),\n                vec2(-1.0, -1.0), vec2(1.0, -1.0)\n            );\n\n            struct VertexOutput {\n                @builtin(position) position : vec4f,\n                @location(0) texCoord : vec2f\n            };\n\n            @vertex\n            fn vertexMain(@builtin(vertex_index) vertexIndex : u32) -> VertexOutput {\n              var output : VertexOutput;\n              output.texCoord = pos[vertexIndex] * vec2f(0.5, -0.5) + vec2f(0.5);\n              output.position = vec4f(pos[vertexIndex], 0, 1);\n              return output;\n            }\n\n            @group(0) @binding(0) var imgSampler : sampler;\n            @group(0) @binding(1) var img : texture_2d<f32>;\n\n            @fragment\n            fn fragmentMain(@location(0) texCoord : vec2f) -> @location(0) vec4f {\n              return textureSample(img, imgSampler, texCoord);\n            }\n        ";this.shader=new Ha(e,{name:"WebGPUMipmapRendererShader",shaderLanguage:Ys,vshader:t,fshader:t}),this.minSampler=e.wgpu.createSampler({minFilter:"linear"})}}class Za{getBindGroup(e){var t=e.format.byteSize,s=this.bindGroupCache.get(t);return s||((s=new Bi(this.device,this.bindGroupFormat,e)).update(),this.bindGroupCache.set(t,s)),s}constructor(e){this.bindGroupCache=new Map,this.device=e,this.bindGroupFormat=new Ai(this.device,[new wi(di,3)])}}class Ja extends Za{destroy(e){e._vram.ub-=this.buffer.size,this.buffer.destroy(),this.buffer=null}onAvailable(){this.mappedRange=this.buffer.getMappedRange()}alloc(e,t){return new Int32Array(this.mappedRange,e,t/4)}constructor(e,t,s){super(e),this.buffer=null,this.mappedRange=null,this.buffer=e.wgpu.createBuffer({size:t,usage:s?GPUBufferUsage.MAP_WRITE|GPUBufferUsage.COPY_SRC:GPUBufferUsage.UNIFORM|GPUBufferUsage.COPY_DST,mappedAtCreation:s}),s&&this.onAvailable(),e._vram.ub+=t}}class Qa extends ja{createBuffer(e,t,s){return new Ja(e,t,s)}submit(){super.submit();var e=this.usedBuffers.length;if(e){for(var t=this.device,s=this.gpuBuffers,i=t.wgpu.createCommandEncoder(),n=e-1;n>=0;n--){var a=this.usedBuffers[n],{stagingBuffer:r,gpuBuffer:o,offset:l,size:h}=a,c=r.buffer;c.unmap(),i.copyBufferToBuffer(c,l,o.buffer,l,h),s.push(o)}var d=i.finish();t.addCommandBuffer(d,!0);for(var u=0;u<e;u++){var p=this.usedBuffers[u].stagingBuffer;this.pendingStagingBuffers.push(p)}this.usedBuffers.length=0}}onCommandBuffersSubmitted(){var e=this.pendingStagingBuffers.length;if(e){for(var t,s=function(e){var s=t.pendingStagingBuffers[e];s.buffer.mapAsync(GPUMapMode.WRITE).then((()=>{t.stagingBuffers&&(s.onAvailable(),t.stagingBuffers.push(s))}))},i=0;i<e;i++)t=this,s(i);this.pendingStagingBuffers.length=0}}constructor(...e){super(...e),this.pendingStagingBuffers=[]}}class er{loseContext(){this.pastFrameAllocations.clear()}set enabled(e){this._enableRequest=e}get enabled(){return this._enableRequest}processEnableRequest(){this._enableRequest!==this._enabled&&(this._enabled=this._enableRequest,this._enabled||(this._frameTime=0))}request(e){this.pastFrameAllocations.set(e,this.frameAllocations),this.frameAllocations=[]}report(e,t){t&&(this.pastFrameAllocations.get(e),t.length>0&&(this._frameTime=t[0]),ut.get("GpuTimings")),this.pastFrameAllocations.delete(e)}getSlot(e){var t=this.frameAllocations.length;return this.frameAllocations.push(e),t}get slotCount(){return this.frameAllocations.length}constructor(){this.frameAllocations=[],this.pastFrameAllocations=new Map,this._enabled=!1,this._enableRequest=!1,this._frameTime=0}}class tr{destroy(){var e,t;null==(e=this.querySet)||e.destroy(),this.querySet=null,null==(t=this.queryBuffer)||t.destroy(),this.queryBuffer=null,this.activeStagingBuffer=null,this.stagingBuffers.forEach((e=>{e.destroy()})),this.stagingBuffers=null}getStagingBuffer(){var e=this.stagingBuffers.pop();return e||(e=this.device.wgpu.createBuffer({size:this.queryBuffer.size,usage:GPUBufferUsage.COPY_DST|GPUBufferUsage.MAP_READ})),e}resolve(e){var t=this.device.getCommandEncoder();t.resolveQuerySet(this.querySet,0,e,this.queryBuffer,0);var s=this.getStagingBuffer();this.activeStagingBuffer=s,t.copyBufferToBuffer(this.queryBuffer,0,s,0,this.bytesPerSlot*e)}request(e,t){var s=this.activeStagingBuffer;return this.activeStagingBuffer=null,s.mapAsync(GPUMapMode.READ).then((()=>{for(var i,n=new BigInt64Array(s.getMappedRange()),a=[],r=0;r<e;r++)a.push(1e-6*Number(n[2*r+1]-n[2*r]));return s.unmap(),null==(i=this.stagingBuffers)||i.push(s),{renderVersion:t,timings:a}}))}constructor(e,t,s){this.stagingBuffers=[],this.activeStagingBuffer=null,this.device=e,this.capacity=s,this.bytesPerSlot=t?8:4;var i=e.wgpu;this.querySet=i.createQuerySet({type:t?"timestamp":"occlusion",count:s}),this.queryBuffer=i.createBuffer({size:this.bytesPerSlot*s,usage:GPUBufferUsage.QUERY_RESOLVE|GPUBufferUsage.STORAGE|GPUBufferUsage.COPY_SRC|GPUBufferUsage.COPY_DST})}}class sr extends er{destroy(){var e;null==(e=this.timestampQueriesSet)||e.destroy(),this.timestampQueriesSet=null}frameStart(){this.processEnableRequest()}frameEnd(){var e;this._enabled&&(null==(e=this.timestampQueriesSet)||e.resolve(2*this.slotCount))}request(){if(this._enabled){var e,t=this.device.renderVersion;null==(e=this.timestampQueriesSet)||e.request(this.slotCount,t).then((e=>{this.report(e.renderVersion,e.timings)})),super.request(t)}}constructor(e){super(),this.device=e,this.timestampQueriesSet=e.supportsTimestampQuery?new tr(e,!0,512):null}}class ir{destroy(){this.shader.destroy(),this.shader=null,this.pipelineCache=null}getPipeline(e){var t=this.pipelineCache.get(e);return t||(t=this.createPipeline(e),this.pipelineCache.set(e,t)),t}createPipeline(e){var t=this.shader.impl;return this.device.wgpu.createRenderPipeline({layout:"auto",vertex:{module:t.getVertexShaderModule(),entryPoint:t.vertexEntryPoint},fragment:{module:t.getFragmentShaderModule(),entryPoint:t.fragmentEntryPoint,targets:[{format:e}]},primitive:{topology:"triangle-strip"}})}resolveDepth(e,t,s){for(var i=this.device,n=i.wgpu,a=this.getPipeline(s.format),r=t.depthOrArrayLayers,o=0;o<r;o++){var l=t.createView({dimension:"2d",aspect:"depth-only",baseMipLevel:0,mipLevelCount:1,baseArrayLayer:o}),h=s.createView({dimension:"2d",baseMipLevel:0,mipLevelCount:1,baseArrayLayer:o}),c=e.beginRenderPass({colorAttachments:[{view:h,loadOp:"clear",storeOp:"store"}]}),d=n.createBindGroup({layout:a.getBindGroupLayout(0),entries:[{binding:0,resource:l}]});c.setPipeline(a),c.setBindGroup(0,d),c.draw(4),c.end()}i.pipeline=null}constructor(e){this.pipelineCache=new Map,this.device=e;var t="\n \n            var<private> pos : array<vec2f, 4> = array<vec2f, 4>(\n                vec2(-1.0, 1.0), vec2(1.0, 1.0), vec2(-1.0, -1.0), vec2(1.0, -1.0)\n            );\n\n            struct VertexOutput {\n                @builtin(position) position : vec4f,\n            };\n\n            @vertex\n            fn vertexMain(@builtin(vertex_index) vertexIndex : u32) -> VertexOutput {\n              var output : VertexOutput;\n              output.position = vec4f(pos[vertexIndex], 0, 1);\n              return output;\n            }\n\n            @group(0) @binding(0) var img : texture_depth_multisampled_2d;\n\n            @fragment\n            fn fragmentMain(@builtin(position) fragColor: vec4f) -> @location(0) vec4f {\n                // load th depth value from sample index 0\n                var depth = textureLoad(img, vec2i(fragColor.xy), 0u);\n                return vec4f(depth, 0.0, 0.0, 0.0);\n            }\n        ";this.shader=new Ha(e,{name:"WebGPUResolverDepthShader",shaderLanguage:Ys,vshader:t,fshader:t})}}class nr{destroy(){this.uniformBuffers.forEach((e=>e.destroy())),this.uniformBuffers.length=0,this.bindGroup.destroy(),this.bindGroup=null}updateBindGroup(){var{bindGroup:e}=this;e.updateUniformBuffers(),e.update()}dispatch(e,t,s){var i=this.compute.device;i.setBindGroup(0,this.bindGroup);var n=i.passEncoder;n.setPipeline(this.pipeline),n.dispatchWorkgroups(e,t,s)}constructor(e){this.uniformBuffers=[],this.bindGroup=null,this.compute=e;var{device:t,shader:s}=e,{computeBindGroupFormat:i,computeUniformBufferFormats:n}=s.impl;if(this.bindGroup=new Bi(t,i),n)for(var a in n)if(n.hasOwnProperty(a)){var r=new Xa(t,n[a],!0);this.uniformBuffers.push(r),this.bindGroup.setUniformBuffer(a,r)}this.pipeline=t.computePipeline.get(s,i)}}function ar(e,t,s,i,n,a,r){try{var o=e[a](r),l=o.value}catch(e){return void s(e)}o.done?t(l):Promise.resolve(l).then(i,n)}function rr(e){return function(){var t=this,s=arguments;return new Promise((function(i,n){var a=e.apply(t,s);function r(e){ar(a,i,n,r,o,"next",e)}function o(e){ar(a,i,n,r,o,"throw",e)}r(void 0)}))}}var or=new Map;class lr extends rn{destroy(){this.clearRenderer.destroy(),this.clearRenderer=null,this.mipmapRenderer.destroy(),this.mipmapRenderer=null,this.resolver.destroy(),this.resolver=null,super.destroy()}initDeviceCaps(){var e,t=null==(e=this.wgpu)?void 0:e.limits;this.limits=t,this.precision="highp",this.maxPrecision="highp",this.maxSamples=4,this.maxTextures=16,this.maxTextureSize=t.maxTextureDimension2D,this.maxCubeMapSize=t.maxTextureDimension2D,this.maxVolumeSize=t.maxTextureDimension3D,this.maxColorAttachments=t.maxColorAttachments,this.maxPixelRatio=1,this.maxAnisotropy=16,this.fragmentUniformsCount=t.maxUniformBufferBindingSize/16,this.vertexUniformsCount=t.maxUniformBufferBindingSize/16,this.supportsUniformBuffers=!0,this.supportsAreaLights=!0,this.supportsGpuParticles=!0,this.supportsCompute=!0,this.textureFloatRenderable=!0,this.textureHalfFloatRenderable=!0,this.supportsImageBitmap=!0,this.samples=this.backBufferAntialias?4:1;var s=navigator.gpu.wgslLanguageFeatures;this.supportsStorageTextureRead=null==s?void 0:s.has("readonly_and_readwrite_storage_textures")}initWebGpu(e,t){var s=this;return rr((function*(){if(!window.navigator.gpu)throw new Error("Unable to retrieve GPU. Ensure you are using a browser that supports WebGPU rendering.");var i=e=>new URL(e,window.location.href).toString(),n=yield Promise.all([import(""+i(t)).then((e=>twgsl(t.replace(".js",".wasm")))),import(""+i(e)).then((e=>e.default()))]);return s.twgsl=n[0],s.glslang=n[1],s.createDevice()}))()}createDevice(){var e=this;return rr((function*(){var t,s,i={powerPreference:"default"!==e.initOptions.powerPreference?e.initOptions.powerPreference:void 0};e.gpuAdapter=yield window.navigator.gpu.requestAdapter(i);var n=[],a=t=>{var s=e.gpuAdapter.features.has(t);return s&&n.push(t),s};e.textureFloatFilterable=a("float32-filterable"),e.textureFloatBlendable=a("float32-blendable"),e.extCompressedTextureS3TC=a("texture-compression-bc"),e.extCompressedTextureETC=a("texture-compression-etc2"),e.extCompressedTextureASTC=a("texture-compression-astc"),e.supportsTimestampQuery=a("timestamp-query"),e.supportsDepthClip=a("depth-clip-control"),e.supportsDepth32Stencil=a("depth32float-stencil8"),e.supportsIndirectFirstInstance=a("indirect-first-instance"),e.supportsShaderF16=a("shader-f16"),e.supportsStorageRGBA8=a("bgra8unorm-storage"),e.textureRG11B10Renderable=a("rg11b10ufloat-renderable"),e.supportsClipDistances=a("clip-distances");var r=null==(t=e.gpuAdapter)?void 0:t.limits,o={};if(r)for(var l in r)"minSubgroupSize"!==l&&"maxSubgroupSize"!==l&&(o[l]=r[l]);var h={requiredFeatures:n,requiredLimits:o,defaultQueue:{label:"Default Queue"}};e.wgpu=yield e.gpuAdapter.requestDevice(h),null==(s=e.wgpu.lost)||s.then(e.handleDeviceLost.bind(e)),e.initDeviceCaps(),e.gpuContext=e.canvas.getContext("webgpu");var c="standard",d=navigator.gpu.getPreferredCanvasFormat(),u=e.initOptions.displayFormat;if(e.backBufferFormat="rgba8unorm"===d?u===hi?ss:7:u===hi?64:31,e.backBufferViewFormat=u===hi?d+"-srgb":d,"hdr"===u&&e.textureFloatFilterable){var p=window.matchMedia("(dynamic-range: high)");(null==p?void 0:p.matches)&&(e.backBufferFormat=Kt,e.backBufferViewFormat="rgba16float",d="rgba16float",e.isHdr=!0,c="extended")}return e.canvasConfig={device:e.wgpu,colorSpace:"srgb",alphaMode:e.initOptions.alpha?"premultiplied":"opaque",format:d,toneMapping:{mode:c},usage:GPUTextureUsage.RENDER_ATTACHMENT|GPUTextureUsage.COPY_SRC|GPUTextureUsage.COPY_DST,viewFormats:u===hi?[e.backBufferViewFormat]:[]},e.gpuContext.configure(e.canvasConfig),e.createBackbuffer(),e.clearRenderer=new $a(e),e.mipmapRenderer=new Ka(e),e.resolver=new ir(e),e.postInit(),e}))()}handleDeviceLost(e){var t=this,s=()=>super.loseContext,i=()=>super.restoreContext;return rr((function*(){"destroyed"!==e.reason&&(s().call(t),yield t.createDevice(),i().call(t))}))()}postInit(){super.postInit(),this.initializeRenderState(),this.setupPassEncoderDefaults(),this.gpuProfiler=new sr(this),this.dynamicBuffers=new Qa(this,102400,this.limits.minUniformBufferOffsetAlignment),this.emptyBindGroup=new Bi(this,new Ai(this,[])),this.emptyBindGroup.update()}createBackbuffer(){this.supportsStencil=this.initOptions.stencil,this.backBuffer=new ln({name:"WebgpuFramebuffer",graphicsDevice:this,depth:this.initOptions.depth,stencil:this.supportsStencil,samples:this.samples}),this.backBuffer.impl.isBackbuffer=!0}frameStart(){super.frameStart(),this.gpuProfiler.frameStart(),this.submit();var e=this.gpuContext.getCurrentTexture();this.backBufferSize.x===e.width&&this.backBufferSize.y===e.height||(this.backBufferSize.set(e.width,e.height),this.backBuffer.destroy(),this.backBuffer=null,this.createBackbuffer());var t=this.backBuffer,s=t.impl;s.setColorAttachment(0,void 0,this.backBufferViewFormat),this.initRenderTarget(t),s.assignColorTexture(this,e)}frameEnd(){super.frameEnd(),this.gpuProfiler.frameEnd(),this.submit(),this.contextLost||this.gpuProfiler.request()}createBufferImpl(e){return new gn(e)}createUniformBufferImpl(e){return new xa(e)}createVertexBufferImpl(e,t,s){return new wa(e,t,s)}createIndexBufferImpl(e,t){return new vn(e,t)}createShaderImpl(e){return new ga(e)}createTextureImpl(e){return new ya(e)}createRenderTargetImpl(e){return new Un(e)}createBindGroupFormatImpl(e){return new fn(e)}createBindGroupImpl(e){return new hn}createComputeImpl(e){return new nr(e)}setBindGroup(e,t,s){this.passEncoder&&(this.passEncoder.setBindGroup(e,t.impl.bindGroup,null!=s?s:t.uniformBufferOffsets),this.bindGroupFormats[e]=t.format.impl)}submitVertexBuffer(e,t){var s=e.format,{interleaved:i,elements:n}=s,a=n.length,r=e.impl.buffer;if(i)return this.passEncoder.setVertexBuffer(t,r),1;for(var o=0;o<a;o++)this.passEncoder.setVertexBuffer(t+o,r,n[o].offset);return a}validateVBLocations(e,t){var s=e=>{for(var{elements:t}=e.format,s=0;s<t.length;s++){var i=t[s].name,n=vi[i];or.has(n),or.set(n,i)}};s(e),s(t),or.clear()}draw(e,t,s){if(void 0===t&&(t=1),this.shader.ready&&!this.shader.failed){var i=this.passEncoder,n=this.vertexBuffers[0],a=this.vertexBuffers[1];if(this.vertexBuffers.length=0,n){var r=this.submitVertexBuffer(n,0);a&&this.submitVertexBuffer(a,r)}var o=this.renderPipeline.get(e,null==n?void 0:n.format,null==a?void 0:a.format,this.shader,this.renderTarget,this.bindGroupFormats,this.blendState,this.depthState,this.cullMode,this.stencilEnabled,this.stencilFront,this.stencilBack);this.pipeline!==o&&(this.pipeline=o,i.setPipeline(o));var l=this.indexBuffer;l?(this.indexBuffer=null,i.setIndexBuffer(l.impl.buffer,l.impl.format),i.drawIndexed(e.count,t,e.base,0,0)):i.draw(e.count,t,e.base,0)}}setShader(e,t){e!==this.shader&&(this.shader=e)}setBlendState(e){this.blendState.copy(e)}setDepthState(e){this.depthState.copy(e)}setStencilState(e,t){if(e||t){this.stencilEnabled=!0,this.stencilFront.copy(null!=e?e:nn.DEFAULT),this.stencilBack.copy(null!=t?t:nn.DEFAULT);var s=this.stencilFront.ref;this.stencilRef!==s&&(this.stencilRef=s,this.passEncoder.setStencilReference(s))}else this.stencilEnabled=!1}setBlendColor(e,t,s,i){var n=this.blendColor;e===n.r&&t===n.g&&s===n.b&&i===n.a||(n.set(e,t,s,i),this.passEncoder.setBlendConstant(n))}setCullMode(e){this.cullMode=e}setAlphaToCoverage(e){}initializeContextCaches(){super.initializeContextCaches()}setupPassEncoderDefaults(){this.pipeline=null,this.stencilRef=0,this.blendColor.set(0,0,0,0)}_uploadDirtyTextures(){this.textures.forEach((e=>{(e._needsUpload||e._needsMipmaps)&&e.upload()}))}setupTimeStampWrites(e,t){if(this.gpuProfiler._enabled&&this.gpuProfiler.timestampQueriesSet){var s=this.gpuProfiler.getSlot(t);(e=null!=e?e:{}).timestampWrites={querySet:this.gpuProfiler.timestampQueriesSet.querySet,beginningOfPassWriteIndex:2*s,endOfPassWriteIndex:2*s+1}}return e}startRenderPass(e){this._uploadDirtyTextures();var t=e.renderTarget||this.backBuffer;this.renderTarget=t;var s=t.impl;t!==this.backBuffer&&this.initRenderTarget(t),s.setupForRenderPass(e,t);var i=s.renderPassDescriptor;this.setupTimeStampWrites(i,e.name);var n=this.getCommandEncoder();this.passEncoder=n.beginRenderPass(i),this.passEncoder.label=e.name+"-PassEncoder RT:"+t.name,this.setupPassEncoderDefaults();var{width:a,height:r}=t;this.setViewport(0,0,a,r),this.setScissor(0,0,a,r),this.insideRenderPass=!0}endRenderPass(e){this.passEncoder.end(),this.passEncoder=null,this.insideRenderPass=!1,this.bindGroupFormats.length=0;var t=this.renderTarget;if(t&&t.depthBuffer&&e.depthStencilOps.resolveDepth&&e.samples>1&&t.autoResolve){var s=t.impl.depthAttachment,i=t.depthBuffer.impl.gpuTexture;s&&i&&this.resolver.resolveDepth(this.commandEncoder,s.multisampledDepthBuffer,i)}for(var n=0;n<e.colorArrayOps.length;n++){e.colorArrayOps[n].genMipmaps&&this.mipmapRenderer.generate(e.renderTarget._colorBuffers[n].impl)}}startComputePass(e){this.pipeline=null;var t=this.setupTimeStampWrites(void 0,e),s=this.getCommandEncoder();this.passEncoder=s.beginComputePass(t),this.insideRenderPass=!0}endComputePass(){this.passEncoder.end(),this.passEncoder=null,this.insideRenderPass=!1,this.bindGroupFormats.length=0}computeDispatch(e,t){void 0===t&&(t="Unnamed"),this.startComputePass(t);for(var s=0;s<e.length;s++){var i=e[s];i.applyParameters(),i.impl.updateBindGroup()}for(var n=0;n<e.length;n++){var a=e[n];a.impl.dispatch(a.countX,a.countY,a.countZ)}this.endComputePass()}getCommandEncoder(){var e=this.commandEncoder;return e||(e=this.wgpu.createCommandEncoder(),this.commandEncoder=e),e}endCommandEncoder(){var{commandEncoder:e}=this;if(e){var t=e.finish();this.addCommandBuffer(t),this.commandEncoder=null}}addCommandBuffer(e,t){void 0===t&&(t=!1),t?this.commandBuffers.unshift(e):this.commandBuffers.push(e)}submit(){this.endCommandEncoder(),this.commandBuffers.length>0&&(this.dynamicBuffers.submit(),this.wgpu.queue.submit(this.commandBuffers),this.commandBuffers.length=0,this.dynamicBuffers.onCommandBuffersSubmitted())}clear(e){e.flags&&this.clearRenderer.clear(this,this.renderTarget,e,this.defaultClearOptions)}setViewport(e,t,s,i){this.passEncoder&&(this.renderTarget.flipY||(t=this.renderTarget.height-t-i),this.vx=e,this.vy=t,this.vw=s,this.vh=i,this.passEncoder.setViewport(e,t,s,i,0,1))}setScissor(e,t,s,i){this.passEncoder&&(this.renderTarget.flipY||(t=this.renderTarget.height-t-i),this.sx=e,this.sy=t,this.sw=s,this.sh=i,this.passEncoder.setScissorRect(e,t,s,i))}clearStorageBuffer(e,t,s){void 0===t&&(t=0),void 0===s&&(s=e.byteSize),this.getCommandEncoder().clearBuffer(e.buffer,t,s)}readStorageBuffer(e,t,s,i,n){void 0===t&&(t=0),void 0===s&&(s=e.byteSize-t),void 0===i&&(i=null),void 0===n&&(n=!1);var a=this.createBufferImpl(9);a.allocate(this,s);var r=a.buffer;return this.getCommandEncoder().copyBufferToBuffer(e.buffer,t,r,0,s),this.readBuffer(a,s,i,n)}readBuffer(e,t,s,i){void 0===s&&(s=null),void 0===i&&(i=!1);var n=e.buffer;return new Promise(((a,r)=>{var o=()=>{null==n||n.mapAsync(GPUMapMode.READ).then((()=>{null!=s||(s=new Uint8Array(t));var i=n.getMappedRange(0,t),r=s.constructor;s.set(new r(i)),n.unmap(),e.destroy(this),a(s)}))};i?(this.submit(),o()):setTimeout((()=>{o()}))}))}writeStorageBuffer(e,t,s,i,n){void 0===t&&(t=0),void 0===i&&(i=0),this.wgpu.queue.writeBuffer(e.buffer,t,s,i,n)}copyRenderTarget(e,t,s,i){var n={width:e?e.width:t.width,height:e?e.height:t.height,depthOrArrayLayers:1},a=this.getCommandEncoder();if(s){var r={texture:e?e.colorBuffer.impl.gpuTexture:this.backBuffer.impl.assignedColorTexture,mipLevel:0},o={texture:t?t.colorBuffer.impl.gpuTexture:this.backBuffer.impl.assignedColorTexture,mipLevel:0};a.copyTextureToTexture(r,o,n)}if(i){var l=(e||this.renderTarget).impl.depthAttachment.depthTexture;if(e.samples>1){var h=t.colorBuffer.impl.gpuTexture;this.resolver.resolveDepth(a,l,h)}else{var c={texture:l,mipLevel:0},d={texture:t?t.depthBuffer.impl.gpuTexture:this.renderTarget.impl.depthAttachment.depthTexture,mipLevel:0};a.copyTextureToTexture(c,d,n)}}return!0}constructor(e,t={}){var s,i;super(e,t),this.renderPipeline=new Mn(this),this.computePipeline=new In(this),this.bindGroupFormats=[],this.commandEncoder=null,this.commandBuffers=[],(t=this.initOptions).alpha=null==(s=t.alpha)||s,this.backBufferAntialias=null!=(i=t.antialias)&&i,this.isWebGPU=!0,this._deviceType=oi,this.scope.resolve(ui).setValue(0)}}class hr{destroy(e){this.bufferId&&(e.gl.deleteBuffer(this.bufferId),this.bufferId=null)}get initialized(){return!!this.bufferId}loseContext(){this.bufferId=null}unlock(e,t,s,i){var n=e.gl;if(this.bufferId)n.bindBuffer(s,this.bufferId),n.bufferSubData(s,0,i);else{var a;switch(t){case 0:a=n.STATIC_DRAW;break;case 1:a=n.DYNAMIC_DRAW;break;case 2:a=n.STREAM_DRAW;break;case 3:a=n.DYNAMIC_COPY}this.bufferId=n.createBuffer(),n.bindBuffer(s,this.bufferId),n.bufferData(s,i,a)}}constructor(){this.bufferId=null}}class cr extends hr{destroy(e){super.destroy(e),e.unbindVertexArray()}loseContext(){super.loseContext(),this.vao=null}unlock(e){var t=e.device;super.unlock(t,e.usage,t.gl.ARRAY_BUFFER,e.storage)}constructor(...e){super(...e),this.vao=null}}class dr extends hr{unlock(e){var t=e.device;super.unlock(t,e.usage,t.gl.ELEMENT_ARRAY_BUFFER,e.storage)}constructor(e){super();var t=e.device.gl,s=e.format;0===s?this.glFormat=t.UNSIGNED_BYTE:1===s?this.glFormat=t.UNSIGNED_SHORT:2===s&&(this.glFormat=t.UNSIGNED_INT)}}class ur{constructor(e,t,s,i){if(this.locationId=i,this.scopeId=e.scope.resolve(t),this.version=new Gi,"[0]"===t.substring(t.length-3))switch(s){case 2:s=17;break;case 1:s=ei;break;case Ks:s=31;break;case 0:s=32;break;case 3:s=21;break;case 6:s=ti;break;case Zs:s=34;break;case 9:s=35;break;case 4:s=22;break;case 7:s=si;break;case Js:s=37;break;case 10:s=38;break;case 5:s=23;break;case 8:s=39;break;case Qs:s=40;break;case 11:s=41}this.dataType=s,this.value=[null,null,null,null],this.array=[]}}var pr=new Set(["gl_VertexID","gl_InstanceID","gl_DrawID","gl_BaseVertex","gl_BaseInstance"]);class mr{destroy(e){this.map.forEach((t=>{e.gl.deleteShader(t)}))}loseContext(e){this.map.clear()}constructor(){this.map=new Map}}var fr=new Ti,gr=new Ti;class vr{destroy(e){this.glProgram&&(e.device.gl.deleteProgram(this.glProgram),this.glProgram=null)}init(){this.uniforms=[],this.samplers=[],this.attributes=[],this.glProgram=null,this.glVertexShader=null,this.glFragmentShader=null}loseContext(){this.init()}restoreContext(e,t){this.compile(e,t),this.link(e,t)}compile(e,t){var s=t.definition;this.glVertexShader=this._compileShaderSource(e,s.vshader,!0),this.glFragmentShader=this._compileShaderSource(e,s.fshader,!1)}link(e,t){if(!this.glProgram){var s=e.gl;if(!s.isContextLost()){var i=s.createProgram();this.glProgram=i,s.attachShader(i,this.glVertexShader),s.attachShader(i,this.glFragmentShader);var n=t.definition,a=n.attributes;if(n.useTransformFeedback){var r=[];for(var o in a)a.hasOwnProperty(o)&&r.push("out_"+o);s.transformFeedbackVaryings(i,r,s.INTERLEAVED_ATTRIBS)}for(var l in a)if(a.hasOwnProperty(l)){var h=a[l],c=vi[h];s.bindAttribLocation(i,c,l)}s.linkProgram(i)}}}_compileShaderSource(e,t,s){var i=e.gl;if(i.isContextLost())return null;var n=(s?fr:gr).get(e,(()=>new mr)),a=n.map.get(t);return a||(a=i.createShader(s?i.VERTEX_SHADER:i.FRAGMENT_SHADER),i.shaderSource(a,t),i.compileShader(a),n.map.set(t,a)),a}finalize(e,t){var s=e.gl;if(s.isContextLost())return!0;var i=this.glProgram,n=t.definition;if(!s.getProgramParameter(i,s.LINK_STATUS)){if(!this._isCompiled(e,t,this.glVertexShader,n.vshader,"vertex"))return!1;if(!this._isCompiled(e,t,this.glFragmentShader,n.fshader,"fragment"))return!1;var a="Failed to link shader program. Error: "+s.getProgramInfoLog(i);return console.error(a),!1}for(var r=s.getProgramParameter(i,s.ACTIVE_ATTRIBUTES),o=0;o<r;o++){var l=s.getActiveAttrib(i,o),h=s.getAttribLocation(i,l.name);if(!pr.has(l.name))if(void 0===n.attributes[l.name])console.error('Vertex shader attribute "'+l.name+'" is not mapped to a semantic in shader definition, shader ['+t.label+"]",t),t.failed=!0;else{var c=new ur(e,n.attributes[l.name],e.pcUniformType[l.type],h);this.attributes.push(c)}}for(var d=e._samplerTypes,u=s.getProgramParameter(i,s.ACTIVE_UNIFORMS),p=0;p<u;p++){var m=s.getActiveUniform(i,p),f=s.getUniformLocation(i,m.name),g=new ur(e,m.name,e.pcUniformType[m.type],f);d.has(m.type)?this.samplers.push(g):this.uniforms.push(g)}return t.ready=!0,!0}_isCompiled(e,t,s,i,n){var a=e.gl;if(!a.getShaderParameter(s,a.COMPILE_STATUS)){var r=a.getShaderInfoLog(s),[o,l]=this._processError(i,r),h="Failed to compile "+n+" shader:\n\n"+r+"\n"+o+" while rendering "+void 0;return console.error(h),!1}return!0}isLinked(e){var{extParallelShaderCompile:t}=e;return!t||e.gl.getProgramParameter(this.glProgram,t.COMPLETION_STATUS_KHR)}_processError(e,t){var s={},i="";if(e){var n=e.split("\n"),a=0,r=n.length;if(t&&t.startsWith("ERROR:")){var o=t.match(/^ERROR:\s(\d+):(\d+):\s*(.+)/);o&&(s.message=o[3],s.line=parseInt(o[2],10),a=Math.max(0,s.line-6),r=Math.min(n.length,s.line+5))}for(var l=a;l<r;l++)i+=l+1+":\t"+n[l]+"\n";s.source=e}return[i,s]}constructor(e){this.compileDuration=0,this.init(),this.compile(e.device,e),this.link(e.device,e),e.device.shaders.push(e)}}function _r(e,t){var s=e.width,i=e.height;if(s>t||i>t){var n=t/Math.max(s,i),a=Math.floor(s*n),r=Math.floor(i*n),o=document.createElement("canvas");return o.width=a,o.height=r,o.getContext("2d").drawImage(e,0,0,s,i,0,0,a,r),o}return e}class yr{destroy(e){if(this._glTexture){for(var t=0;t<e.textureUnits.length;t++)for(var s=e.textureUnits[t],i=0;i<s.length;i++)s[i]===this._glTexture&&(s[i]=null);e.gl.deleteTexture(this._glTexture),this._glTexture=null}}loseContext(){this._glTexture=null}propertyChanged(e){this.dirtyParameterFlags|=e}initialize(e,t){var s=e.gl;switch(this._glTexture=s.createTexture(),this._glTarget=t._cubemap?s.TEXTURE_CUBE_MAP:t._volume?s.TEXTURE_3D:t.array?s.TEXTURE_2D_ARRAY:s.TEXTURE_2D,t._format){case 0:this._glFormat=s.ALPHA,this._glInternalFormat=s.ALPHA,this._glPixelType=s.UNSIGNED_BYTE;break;case 1:this._glFormat=s.LUMINANCE,this._glInternalFormat=s.LUMINANCE,this._glPixelType=s.UNSIGNED_BYTE;break;case 2:this._glFormat=s.LUMINANCE_ALPHA,this._glInternalFormat=s.LUMINANCE_ALPHA,this._glPixelType=s.UNSIGNED_BYTE;break;case 52:this._glFormat=s.RED,this._glInternalFormat=s.R8,this._glPixelType=s.UNSIGNED_BYTE;break;case 53:this._glFormat=s.RG,this._glInternalFormat=s.RG8,this._glPixelType=s.UNSIGNED_BYTE;break;case 3:this._glFormat=s.RGB,this._glInternalFormat=s.RGB,this._glPixelType=s.UNSIGNED_SHORT_5_6_5;break;case 4:this._glFormat=s.RGBA,this._glInternalFormat=s.RGBA,this._glPixelType=s.UNSIGNED_SHORT_5_5_5_1;break;case 5:this._glFormat=s.RGBA,this._glInternalFormat=s.RGBA,this._glPixelType=s.UNSIGNED_SHORT_4_4_4_4;break;case 6:this._glFormat=s.RGB,this._glInternalFormat=s.RGB8,this._glPixelType=s.UNSIGNED_BYTE;break;case 7:this._glFormat=s.RGBA,this._glInternalFormat=s.RGBA8,this._glPixelType=s.UNSIGNED_BYTE;break;case 31:case 64:break;case 8:this._glFormat=s.RGB,this._glInternalFormat=e.extCompressedTextureS3TC.COMPRESSED_RGB_S3TC_DXT1_EXT;break;case 9:this._glFormat=s.RGBA,this._glInternalFormat=e.extCompressedTextureS3TC.COMPRESSED_RGBA_S3TC_DXT3_EXT;break;case $t:this._glFormat=s.RGBA,this._glInternalFormat=e.extCompressedTextureS3TC.COMPRESSED_RGBA_S3TC_DXT5_EXT;break;case 21:this._glFormat=s.RGB,this._glInternalFormat=e.extCompressedTextureETC1.COMPRESSED_RGB_ETC1_WEBGL;break;case is:this._glFormat=s.RGB,this._glInternalFormat=e.extCompressedTexturePVRTC.COMPRESSED_RGB_PVRTC_2BPPV1_IMG;break;case ns:this._glFormat=s.RGBA,this._glInternalFormat=e.extCompressedTexturePVRTC.COMPRESSED_RGBA_PVRTC_2BPPV1_IMG;break;case 26:this._glFormat=s.RGB,this._glInternalFormat=e.extCompressedTexturePVRTC.COMPRESSED_RGB_PVRTC_4BPPV1_IMG;break;case 27:this._glFormat=s.RGBA,this._glInternalFormat=e.extCompressedTexturePVRTC.COMPRESSED_RGBA_PVRTC_4BPPV1_IMG;break;case 22:this._glFormat=s.RGB,this._glInternalFormat=e.extCompressedTextureETC.COMPRESSED_RGB8_ETC2;break;case 23:this._glFormat=s.RGBA,this._glInternalFormat=e.extCompressedTextureETC.COMPRESSED_RGBA8_ETC2_EAC;break;case 28:this._glFormat=s.RGBA,this._glInternalFormat=e.extCompressedTextureASTC.COMPRESSED_RGBA_ASTC_4x4_KHR;break;case 29:this._glFormat=s.RGB,this._glInternalFormat=e.extCompressedTextureATC.COMPRESSED_RGB_ATC_WEBGL;break;case 30:this._glFormat=s.RGBA,this._glInternalFormat=e.extCompressedTextureATC.COMPRESSED_RGBA_ATC_INTERPOLATED_ALPHA_WEBGL;break;case 65:this._glFormat=s.RGB,this._glInternalFormat=e.extTextureCompressionBPTC.COMPRESSED_RGB_BPTC_SIGNED_FLOAT_EXT;break;case 66:this._glFormat=s.RGB,this._glInternalFormat=e.extTextureCompressionBPTC.COMPRESSED_RGB_BPTC_UNSIGNED_FLOAT_EXT;break;case 67:this._glFormat=s.RGBA,this._glInternalFormat=e.extTextureCompressionBPTC.COMPRESSED_RGBA_BPTC_UNORM_EXT;break;case 54:this._glFormat=s.SRGB,this._glInternalFormat=e.extCompressedTextureS3TC_SRGB.COMPRESSED_SRGB_S3TC_DXT1_EXT;break;case 55:this._glFormat=s.SRGB_ALPHA,this._glInternalFormat=e.extCompressedTextureS3TC_SRGB.COMPRESSED_SRGB_ALPHA_S3TC_DXT3_EXT;break;case 56:this._glFormat=s.SRGB_ALPHA,this._glInternalFormat=e.extCompressedTextureS3TC_SRGB.COMPRESSED_SRGB_ALPHA_S3TC_DXT5_EXT;break;case 61:this._glFormat=s.SRGB,this._glInternalFormat=e.extCompressedTextureETC.COMPRESSED_SRGB8_ETC2;break;case 62:this._glFormat=s.SRGB_ALPHA,this._glInternalFormat=e.extCompressedTextureETC.COMPRESSED_SRGB8_ALPHA8_ETC2_EAC;break;case 63:this._glFormat=s.SRGB_ALPHA,this._glInternalFormat=e.extCompressedTextureASTC.COMPRESSED_SRGB8_ALPHA8_ASTC_4x4_KHR;break;case 68:this._glFormat=s.RGBA,this._glInternalFormat=e.extTextureCompressionBPTC.COMPRESSED_SRGB_ALPHA_BPTC_UNORM_EXT;break;case 50:this._glFormat=s.RED,this._glInternalFormat=s.R16F,this._glPixelType=s.HALF_FLOAT;break;case 51:this._glFormat=s.RG,this._glInternalFormat=s.RG16F,this._glPixelType=s.HALF_FLOAT;break;case 11:this._glFormat=s.RGB,this._glInternalFormat=s.RGB16F,this._glPixelType=s.HALF_FLOAT;break;case Kt:this._glFormat=s.RGBA,this._glInternalFormat=s.RGBA16F,this._glPixelType=s.HALF_FLOAT;break;case 13:this._glFormat=s.RGB,this._glInternalFormat=s.RGB32F,this._glPixelType=s.FLOAT;break;case Zt:this._glFormat=s.RGBA,this._glInternalFormat=s.RGBA32F,this._glPixelType=s.FLOAT;break;case Jt:this._glFormat=s.RED,this._glInternalFormat=s.R32F,this._glPixelType=s.FLOAT;break;case Qt:this._glFormat=s.DEPTH_COMPONENT,this._glInternalFormat=s.DEPTH_COMPONENT32F,this._glPixelType=s.FLOAT;break;case os:this._glFormat=s.DEPTH_COMPONENT,this._glInternalFormat=s.DEPTH_COMPONENT16,this._glPixelType=s.UNSIGNED_SHORT;break;case es:this._glFormat=s.DEPTH_STENCIL,this._glInternalFormat=s.DEPTH24_STENCIL8,this._glPixelType=s.UNSIGNED_INT_24_8;break;case ts:this._glFormat=s.RGB,this._glInternalFormat=s.R11F_G11F_B10F,this._glPixelType=s.UNSIGNED_INT_10F_11F_11F_REV;break;case 19:this._glFormat=s.RGB,this._glInternalFormat=s.SRGB8,this._glPixelType=s.UNSIGNED_BYTE;break;case ss:this._glFormat=s.RGBA,this._glInternalFormat=s.SRGB8_ALPHA8,this._glPixelType=s.UNSIGNED_BYTE;break;case 32:this._glFormat=s.RED_INTEGER,this._glInternalFormat=s.R8I,this._glPixelType=s.BYTE;break;case 33:this._glFormat=s.RED_INTEGER,this._glInternalFormat=s.R8UI,this._glPixelType=s.UNSIGNED_BYTE;break;case 34:this._glFormat=s.RED_INTEGER,this._glInternalFormat=s.R16I,this._glPixelType=s.SHORT;break;case 35:this._glFormat=s.RED_INTEGER,this._glInternalFormat=s.R16UI,this._glPixelType=s.UNSIGNED_SHORT;break;case 36:this._glFormat=s.RED_INTEGER,this._glInternalFormat=s.R32I,this._glPixelType=s.INT;break;case as:this._glFormat=s.RED_INTEGER,this._glInternalFormat=s.R32UI,this._glPixelType=s.UNSIGNED_INT;break;case 38:this._glFormat=s.RG_INTEGER,this._glInternalFormat=s.RG8I,this._glPixelType=s.BYTE;break;case 39:this._glFormat=s.RG_INTEGER,this._glInternalFormat=s.RG8UI,this._glPixelType=s.UNSIGNED_BYTE;break;case 40:this._glFormat=s.RG_INTEGER,this._glInternalFormat=s.RG16I,this._glPixelType=s.SHORT;break;case 41:this._glFormat=s.RG_INTEGER,this._glInternalFormat=s.RG16UI,this._glPixelType=s.UNSIGNED_SHORT;break;case 42:this._glFormat=s.RG_INTEGER,this._glInternalFormat=s.RG32I,this._glPixelType=s.INT;break;case 43:this._glFormat=s.RG_INTEGER,this._glInternalFormat=s.RG32UI,this._glPixelType=s.UNSIGNED_INT;break;case 44:this._glFormat=s.RGBA_INTEGER,this._glInternalFormat=s.RGBA8I,this._glPixelType=s.BYTE;break;case 45:this._glFormat=s.RGBA_INTEGER,this._glInternalFormat=s.RGBA8UI,this._glPixelType=s.UNSIGNED_BYTE;break;case 46:this._glFormat=s.RGBA_INTEGER,this._glInternalFormat=s.RGBA16I,this._glPixelType=s.SHORT;break;case 47:this._glFormat=s.RGBA_INTEGER,this._glInternalFormat=s.RGBA16UI,this._glPixelType=s.UNSIGNED_SHORT;break;case 48:this._glFormat=s.RGBA_INTEGER,this._glInternalFormat=s.RGBA32I,this._glPixelType=s.INT;break;case rs:this._glFormat=s.RGBA_INTEGER,this._glInternalFormat=s.RGBA32UI,this._glPixelType=s.UNSIGNED_INT}this._glCreated=!1}upload(e,t){var s=e.gl;if(t._needsUpload||!(t._needsMipmapsUpload&&t._mipmapsUploaded||!t.pot)){var i,n,a=0,r=t.numLevels;for(t.array&&s.texStorage3D(s.TEXTURE_2D_ARRAY,r,this._glInternalFormat,t._width,t._height,t._arrayLength);t._levels[a]||0===a;)if(t._needsUpload||0!==a){if(a&&(!t._needsMipmapsUpload||!t._mipmaps))break;if(i=t._levels[a],n=1/Math.pow(2,a),1===a&&!t._compressed&&!t._integerFormat&&t._levels.length<r&&(s.generateMipmap(this._glTarget),t._mipmapsUploaded=!0),t._cubemap){var o=void 0;if(e._isBrowserInterface(i[0])){for(o=0;o<6;o++)if(t._levelsUpdated[0][o]){var l=i[o];e._isImageBrowserInterface(l)&&(l.width>e.maxCubeMapSize||l.height>e.maxCubeMapSize)&&(l=_r(l,e.maxCubeMapSize),0===a&&(t._width=l.width,t._height=l.height)),e.setUnpackFlipY(!1),e.setUnpackPremultiplyAlpha(t._premultiplyAlpha),this._glCreated?s.texSubImage2D(s.TEXTURE_CUBE_MAP_POSITIVE_X+o,a,0,0,this._glFormat,this._glPixelType,l):s.texImage2D(s.TEXTURE_CUBE_MAP_POSITIVE_X+o,a,this._glInternalFormat,this._glFormat,this._glPixelType,l)}}else for(n=1/Math.pow(2,a),o=0;o<6;o++)if(t._levelsUpdated[0][o]){var h=i[o];t._compressed?this._glCreated&&h?s.compressedTexSubImage2D(s.TEXTURE_CUBE_MAP_POSITIVE_X+o,a,0,0,Math.max(t._width*n,1),Math.max(t._height*n,1),this._glInternalFormat,h):s.compressedTexImage2D(s.TEXTURE_CUBE_MAP_POSITIVE_X+o,a,this._glInternalFormat,Math.max(t._width*n,1),Math.max(t._height*n,1),0,h):(e.setUnpackFlipY(!1),e.setUnpackPremultiplyAlpha(t._premultiplyAlpha),this._glCreated&&h?s.texSubImage2D(s.TEXTURE_CUBE_MAP_POSITIVE_X+o,a,0,0,Math.max(t._width*n,1),Math.max(t._height*n,1),this._glFormat,this._glPixelType,h):s.texImage2D(s.TEXTURE_CUBE_MAP_POSITIVE_X+o,a,this._glInternalFormat,Math.max(t._width*n,1),Math.max(t._height*n,1),0,this._glFormat,this._glPixelType,h))}}else if(t._volume)t._compressed?s.compressedTexImage3D(s.TEXTURE_3D,a,this._glInternalFormat,Math.max(t._width*n,1),Math.max(t._height*n,1),Math.max(t._depth*n,1),0,i):(e.setUnpackFlipY(!1),e.setUnpackPremultiplyAlpha(t._premultiplyAlpha),s.texImage3D(s.TEXTURE_3D,a,this._glInternalFormat,Math.max(t._width*n,1),Math.max(t._height*n,1),Math.max(t._depth*n,1),0,this._glFormat,this._glPixelType,i));else if(t.array&&"object"==typeof i){if(t._arrayLength===i.length)if(t._compressed)for(var c=0;c<t._arrayLength;c++)s.compressedTexSubImage3D(s.TEXTURE_2D_ARRAY,a,0,0,c,Math.max(Math.floor(t._width*n),1),Math.max(Math.floor(t._height*n),1),1,this._glInternalFormat,i[c]);else for(var d=0;d<t._arrayLength;d++)s.texSubImage3D(s.TEXTURE_2D_ARRAY,a,0,0,d,Math.max(Math.floor(t._width*n),1),Math.max(Math.floor(t._height*n),1),1,this._glFormat,this._glPixelType,i[d])}else{if(e._isBrowserInterface(i)){e._isImageBrowserInterface(i)&&(i.width>e.maxTextureSize||i.height>e.maxTextureSize)&&(i=_r(i,e.maxTextureSize),0===a&&(t._width=i.width,t._height=i.height));var u=i.width||i.videoWidth,p=i.height||i.videoHeight;e.setUnpackFlipY(t._flipY),e.setUnpackPremultiplyAlpha(t._premultiplyAlpha),this._glCreated&&t._width===u&&t._height===p&&!e._isImageVideoInterface(i)?s.texSubImage2D(s.TEXTURE_2D,a,0,0,this._glFormat,this._glPixelType,i):(s.texImage2D(s.TEXTURE_2D,a,this._glInternalFormat,this._glFormat,this._glPixelType,i),0===a&&(t._width=u,t._height=p))}else n=1/Math.pow(2,a),t._compressed?this._glCreated&&i?s.compressedTexSubImage2D(s.TEXTURE_2D,a,0,0,Math.max(Math.floor(t._width*n),1),Math.max(Math.floor(t._height*n),1),this._glInternalFormat,i):s.compressedTexImage2D(s.TEXTURE_2D,a,this._glInternalFormat,Math.max(Math.floor(t._width*n),1),Math.max(Math.floor(t._height*n),1),0,i):(e.setUnpackFlipY(!1),e.setUnpackPremultiplyAlpha(t._premultiplyAlpha),this._glCreated&&i?s.texSubImage2D(s.TEXTURE_2D,a,0,0,Math.max(t._width*n,1),Math.max(t._height*n,1),this._glFormat,this._glPixelType,i):s.texImage2D(s.TEXTURE_2D,a,this._glInternalFormat,Math.max(t._width*n,1),Math.max(t._height*n,1),0,this._glFormat,this._glPixelType,i));t._mipmapsUploaded=0!==a}a++}else a++;if(t._needsUpload)if(t._cubemap)for(var m=0;m<6;m++)t._levelsUpdated[0][m]=!1;else t._levelsUpdated[0]=!1;!t._compressed&&!t._integerFormat&&t._mipmaps&&t._needsMipmapsUpload&&1===t._levels.length&&(s.generateMipmap(this._glTarget),t._mipmapsUploaded=!0),t._gpuSize&&t.adjustVramSizeTracking(e._vram,-t._gpuSize),t._gpuSize=t.gpuSize,t.adjustVramSizeTracking(e._vram,t._gpuSize),this._glCreated=!0}}read(e,t,s,i,n){var a=this.texture;return a.device.readTextureAsync(a,e,t,s,i,n)}constructor(e){this._glTexture=null,this.dirtyParameterFlags=0,this.texture=e}}class xr{destroy(e){this.msaaFB&&(e.deleteRenderbuffer(this.msaaFB),this.msaaFB=null),this.resolveFB&&(e.deleteRenderbuffer(this.resolveFB),this.resolveFB=null)}constructor(e,t){this.msaaFB=e,this.resolveFB=t}}class wr{destroy(e){var t,s=e.gl;this._isInitialized=!1,this._glFrameBuffer&&(this._glFrameBuffer!==this.suppliedColorFramebuffer&&s.deleteFramebuffer(this._glFrameBuffer),this._glFrameBuffer=null),this._glDepthBuffer&&(s.deleteRenderbuffer(this._glDepthBuffer),this._glDepthBuffer=null),this._glResolveFrameBuffer&&(this._glResolveFrameBuffer!==this.suppliedColorFramebuffer&&s.deleteFramebuffer(this._glResolveFrameBuffer),this._glResolveFrameBuffer=null),this._glMsaaColorBuffers.forEach((e=>{s.deleteRenderbuffer(e)})),this._glMsaaColorBuffers.length=0,null==(t=this.colorMrtFramebuffers)||t.forEach((e=>{e.destroy(s)})),this.colorMrtFramebuffers=null,this._glMsaaDepthBuffer&&(this._glMsaaDepthBuffer=null,this.msaaDepthBufferKey&&On(e).release(this.msaaDepthBufferKey)),this.suppliedColorFramebuffer=void 0}get initialized(){return this._isInitialized}init(e,t){var s=e.gl;this._isInitialized=!0;var i=[];if(void 0!==this.suppliedColorFramebuffer)this._glFrameBuffer=this.suppliedColorFramebuffer;else{var n,a;this._glFrameBuffer=s.createFramebuffer(),e.setFramebuffer(this._glFrameBuffer);for(var r=null!=(a=null==(n=t._colorBuffers)?void 0:n.length)?a:0,o=s.COLOR_ATTACHMENT0,l=0;l<r;++l){var h=t.getColorBuffer(l);h&&(h.impl._glTexture||(h._width=Math.min(h.width,e.maxRenderBufferSize),h._height=Math.min(h.height,e.maxRenderBufferSize),e.setTexture(h,0)),s.framebufferTexture2D(s.FRAMEBUFFER,o+l,h._cubemap?s.TEXTURE_CUBE_MAP_POSITIVE_X+t._face:s.TEXTURE_2D,h.impl._glTexture,t.mipLevel),i.push(o+l))}s.drawBuffers(i);var c=t._depthBuffer;if(c||t._depth){var d=t._stencil?s.DEPTH_STENCIL_ATTACHMENT:s.DEPTH_ATTACHMENT;if(c)c.impl._glTexture||(c._width=Math.min(c.width,e.maxRenderBufferSize),c._height=Math.min(c.height,e.maxRenderBufferSize),e.setTexture(c,0)),s.framebufferTexture2D(s.FRAMEBUFFER,d,c._cubemap?s.TEXTURE_CUBE_MAP_POSITIVE_X+t._face:s.TEXTURE_2D,t._depthBuffer.impl._glTexture,t.mipLevel);else if(!(t._samples>1)){this._glDepthBuffer||(this._glDepthBuffer=s.createRenderbuffer());var u=t._stencil?s.DEPTH24_STENCIL8:s.DEPTH_COMPONENT32F;s.bindRenderbuffer(s.RENDERBUFFER,this._glDepthBuffer),s.renderbufferStorage(s.RENDERBUFFER,u,t.width,t.height),s.framebufferRenderbuffer(s.FRAMEBUFFER,d,s.RENDERBUFFER,this._glDepthBuffer),s.bindRenderbuffer(s.RENDERBUFFER,null)}}}if(t._samples>1){var p,m;this._glResolveFrameBuffer=this._glFrameBuffer,this._glFrameBuffer=s.createFramebuffer(),e.setFramebuffer(this._glFrameBuffer);var f=null!=(m=null==(p=t._colorBuffers)?void 0:p.length)?m:0;if(void 0!==this.suppliedColorFramebuffer){var g=s.createRenderbuffer();this._glMsaaColorBuffers.push(g);var v=7===e.backBufferFormat?s.RGBA8:s.RGB8;s.bindRenderbuffer(s.RENDERBUFFER,g),s.renderbufferStorageMultisample(s.RENDERBUFFER,t._samples,v,t.width,t.height),s.framebufferRenderbuffer(s.FRAMEBUFFER,s.COLOR_ATTACHMENT0,s.RENDERBUFFER,g)}else for(var _=0;_<f;++_){var y=t.getColorBuffer(_);if(y){var x=s.createRenderbuffer();this._glMsaaColorBuffers.push(x),s.bindRenderbuffer(s.RENDERBUFFER,x),s.renderbufferStorageMultisample(s.RENDERBUFFER,t._samples,y.impl._glInternalFormat,t.width,t.height),s.framebufferRenderbuffer(s.FRAMEBUFFER,s.COLOR_ATTACHMENT0+_,s.RENDERBUFFER,x)}}if(t._depth){var w,b=t._stencil?s.DEPTH24_STENCIL8:s.DEPTH_COMPONENT32F,C=t._stencil?s.DEPTH_STENCIL_ATTACHMENT:s.DEPTH_ATTACHMENT,S=t._depthBuffer;S&&(w=S.id+":"+t.width+":"+t.height+":"+t._samples+":"+b+":"+C,this._glMsaaDepthBuffer=On(e).get(w)),this._glMsaaDepthBuffer||(this._glMsaaDepthBuffer=s.createRenderbuffer(),s.bindRenderbuffer(s.RENDERBUFFER,this._glMsaaDepthBuffer),s.renderbufferStorageMultisample(s.RENDERBUFFER,t._samples,b,t.width,t.height),this._glMsaaDepthBuffer.destroy=function(){s.deleteRenderbuffer(this)},S&&On(e).set(w,this._glMsaaDepthBuffer)),this.msaaDepthBufferKey=w,s.framebufferRenderbuffer(s.FRAMEBUFFER,C,s.RENDERBUFFER,this._glMsaaDepthBuffer)}f>1&&(this._createMsaaMrtFramebuffers(e,t,f),e.setFramebuffer(this._glFrameBuffer),s.drawBuffers(i))}}_createMsaaMrtFramebuffers(e,t,s){var i=e.gl;this.colorMrtFramebuffers=[];for(var n=0;n<s;++n){var a=t.getColorBuffer(n),r=i.createFramebuffer();e.setFramebuffer(r);var o=this._glMsaaColorBuffers[n];i.bindRenderbuffer(i.RENDERBUFFER,o),i.renderbufferStorageMultisample(i.RENDERBUFFER,t._samples,a.impl._glInternalFormat,t.width,t.height),i.framebufferRenderbuffer(i.FRAMEBUFFER,i.COLOR_ATTACHMENT0,i.RENDERBUFFER,o),i.drawBuffers([i.COLOR_ATTACHMENT0]);var l=i.createFramebuffer();e.setFramebuffer(l),i.framebufferTexture2D(i.FRAMEBUFFER,i.COLOR_ATTACHMENT0,a._cubemap?i.TEXTURE_CUBE_MAP_POSITIVE_X+t._face:i.TEXTURE_2D,a.impl._glTexture,0),this.colorMrtFramebuffers[n]=new xr(r,l)}}_checkFbo(e,t,s){var i=e.gl;i.checkFramebufferStatus(i.FRAMEBUFFER)}loseContext(){this._glFrameBuffer=null,this._glDepthBuffer=null,this._glResolveFrameBuffer=null,this._glMsaaColorBuffers.length=0,this._glMsaaDepthBuffer=null,this.msaaDepthBufferKey=void 0,this.colorMrtFramebuffers=null,this.suppliedColorFramebuffer=void 0,this._isInitialized=!1}internalResolve(e,t,s,i,n){e.setScissor(0,0,i.width,i.height);var a=e.gl;a.bindFramebuffer(a.READ_FRAMEBUFFER,t),a.bindFramebuffer(a.DRAW_FRAMEBUFFER,s),a.blitFramebuffer(0,0,i.width,i.height,0,0,i.width,i.height,n,a.NEAREST)}resolve(e,t,s,i){var n=e.gl;if(this.colorMrtFramebuffers){if(s)for(var a=0;a<this.colorMrtFramebuffers.length;a++){var r=this.colorMrtFramebuffers[a];this.internalResolve(e,r.msaaFB,r.resolveFB,t,n.COLOR_BUFFER_BIT)}i&&this.internalResolve(e,this._glFrameBuffer,this._glResolveFrameBuffer,t,n.DEPTH_BUFFER_BIT)}else this.internalResolve(e,this._glFrameBuffer,this._glResolveFrameBuffer,t,(s?n.COLOR_BUFFER_BIT:0)|(i?n.DEPTH_BUFFER_BIT:0));n.bindFramebuffer(n.FRAMEBUFFER,this._glFrameBuffer)}constructor(){this._glFrameBuffer=null,this._glDepthBuffer=null,this._glResolveFrameBuffer=null,this.colorMrtFramebuffers=null,this._glMsaaColorBuffers=[],this._glMsaaDepthBuffer=null,this._isInitialized=!1}}class br{destroy(e){this.queries.forEach((t=>e.deleteQuery(t))),this.queries=null}constructor(){this.queries=[]}}class Cr extends er{destroy(){this.freeQueries.forEach((e=>this.device.gl.deleteQuery(e))),this.frameQueries.forEach((e=>this.device.gl.deleteQuery(e))),this.previousFrameQueries.forEach((e=>e.destroy(this.device.gl))),this.freeQueries=null,this.frameQueries=null,this.previousFrameQueries=null}loseContext(){super.loseContext(),this.freeQueries=[],this.frameQueries=[],this.previousFrameQueries=[]}restoreContext(){this.ext=this.device.extDisjointTimerQuery}getQuery(){var e;return null!=(e=this.freeQueries.pop())?e:this.device.gl.createQuery()}start(e){if(this.ext){var t=this.getSlot(e),s=this.getQuery();return this.frameQueries[t]=s,this.device.gl.beginQuery(this.ext.TIME_ELAPSED_EXT,s),t}}end(e){void 0!==e&&this.device.gl.endQuery(this.ext.TIME_ELAPSED_EXT)}frameStart(){this.processEnableRequest(),this._enabled&&(this.frameGPUMarkerSlot=this.start("GpuFrame"))}frameEnd(){this._enabled&&this.end(this.frameGPUMarkerSlot)}request(){if(this._enabled){var e=this.ext,t=this.device.gl,s=this.device.renderVersion,i=this.frameQueries;if(i.length>0){this.frameQueries=[];var n=new br;n.queries=i,n.renderVersion=s,this.previousFrameQueries.push(n)}if(this.previousFrameQueries.length>0){var a=this.previousFrameQueries[0],r=a.queries,o=r[r.length-1],l=t.getQueryParameter(o,t.QUERY_RESULT_AVAILABLE),h=t.getParameter(e.GPU_DISJOINT_EXT);if(l&&!h){this.previousFrameQueries.shift();var c=this.timings;c.length=0;for(var d=0;d<r.length;d++){var u=r[d],p=t.getQueryParameter(u,t.QUERY_RESULT);c[d]=1e-6*p,this.freeQueries.push(u)}this.report(a.renderVersion,c)}h&&(this.previousFrameQueries.forEach((e=>{this.report(e.renderVersion,null),e.destroy(t)})),this.previousFrameQueries.length=0)}super.request(s)}}constructor(e){super(),this.freeQueries=[],this.frameQueries=[],this.previousFrameQueries=[],this.timings=[],this.device=e,this.ext=e.extDisjointTimerQuery}}function Sr(e,t,s,i,n,a,r){try{var o=e[a](r),l=o.value}catch(e){return void s(e)}o.done?t(l):Promise.resolve(l).then(i,n)}var Ar=[];class Tr extends rn{postInit(){super.postInit(),this.gpuProfiler=new Cr(this)}destroy(){super.destroy();var e=this.gl;this.feedback&&e.deleteTransformFeedback(this.feedback),this.clearVertexArrayObjectCache(),this.canvas.removeEventListener("webglcontextlost",this._contextLostHandler,!1),this.canvas.removeEventListener("webglcontextrestored",this._contextRestoredHandler,!1),this._contextLostHandler=null,this._contextRestoredHandler=null,this.gl=null,super.postDestroy()}createBackbuffer(e){this.supportsStencil=this.initOptions.stencil,this.backBuffer=new ln({name:"WebglFramebuffer",graphicsDevice:this,depth:this.initOptions.depth,stencil:this.supportsStencil,samples:this.samples}),this.backBuffer.impl.suppliedColorFramebuffer=e}updateBackbufferFormat(e){var t=this.gl;t.bindFramebuffer(t.FRAMEBUFFER,e);var s=this.gl.getParameter(this.gl.ALPHA_BITS);this.backBufferFormat=s?7:6}updateBackbuffer(){var e=this.canvas.width!==this.backBufferSize.x||this.canvas.height!==this.backBufferSize.y;(this._defaultFramebufferChanged||e)&&(this._defaultFramebufferChanged&&this.updateBackbufferFormat(this._defaultFramebuffer),this._defaultFramebufferChanged=!1,this.backBufferSize.set(this.canvas.width,this.canvas.height),this.backBuffer.destroy(),this.createBackbuffer(this._defaultFramebuffer))}createVertexBufferImpl(e,t){return new cr}createIndexBufferImpl(e){return new dr(e)}createShaderImpl(e){return new vr(e)}createTextureImpl(e){return new yr(e)}createRenderTargetImpl(e){return new wr}getPrecision(){var e=this.gl,t="highp";if(e.getShaderPrecisionFormat){var s=e.getShaderPrecisionFormat(e.VERTEX_SHADER,e.HIGH_FLOAT),i=e.getShaderPrecisionFormat(e.VERTEX_SHADER,e.MEDIUM_FLOAT),n=e.getShaderPrecisionFormat(e.FRAGMENT_SHADER,e.HIGH_FLOAT),a=e.getShaderPrecisionFormat(e.FRAGMENT_SHADER,e.MEDIUM_FLOAT);if(s&&i&&n&&a){var r=s.precision>0&&n.precision>0,o=i.precision>0&&a.precision>0;r||(t=o?"mediump":"lowp")}}return t}getExtension(){for(var e=0;e<arguments.length;e++)if(-1!==this.supportedExtensions.indexOf(arguments[e]))return this.gl.getExtension(arguments[e]);return null}get extDisjointTimerQuery(){return this._extDisjointTimerQuery||(this._extDisjointTimerQuery=this.getExtension("EXT_disjoint_timer_query_webgl2","EXT_disjoint_timer_query")),this._extDisjointTimerQuery}initializeExtensions(){var e,t=this.gl;this.supportedExtensions=null!=(e=t.getSupportedExtensions())?e:[],this._extDisjointTimerQuery=null,this.textureRG11B10Renderable=!0,this.extColorBufferFloat=this.getExtension("EXT_color_buffer_float"),this.extDebugRendererInfo=this.getExtension("WEBGL_debug_renderer_info"),this.extTextureFloatLinear=this.getExtension("OES_texture_float_linear"),this.textureFloatFilterable=!!this.extTextureFloatLinear,this.extFloatBlend=this.getExtension("EXT_float_blend"),this.extTextureFilterAnisotropic=this.getExtension("EXT_texture_filter_anisotropic","WEBKIT_EXT_texture_filter_anisotropic"),this.extParallelShaderCompile=this.getExtension("KHR_parallel_shader_compile"),this.extCompressedTextureETC1=this.getExtension("WEBGL_compressed_texture_etc1"),this.extCompressedTextureETC=this.getExtension("WEBGL_compressed_texture_etc"),this.extCompressedTexturePVRTC=this.getExtension("WEBGL_compressed_texture_pvrtc","WEBKIT_WEBGL_compressed_texture_pvrtc"),this.extCompressedTextureS3TC=this.getExtension("WEBGL_compressed_texture_s3tc","WEBKIT_WEBGL_compressed_texture_s3tc"),this.extCompressedTextureS3TC_SRGB=this.getExtension("WEBGL_compressed_texture_s3tc_srgb"),this.extCompressedTextureATC=this.getExtension("WEBGL_compressed_texture_atc"),this.extCompressedTextureASTC=this.getExtension("WEBGL_compressed_texture_astc"),this.extTextureCompressionBPTC=this.getExtension("EXT_texture_compression_bptc"),this.extColorBufferHalfFloat=this.getExtension("EXT_color_buffer_half_float")}initializeCapabilities(){var e,t=this.gl,s="undefined"!=typeof navigator?navigator.userAgent:"";this.maxPrecision=this.precision=this.getPrecision();var i,n,a=t.getContextAttributes();this.supportsMsaa=null!=(i=null==a?void 0:a.antialias)&&i,this.supportsStencil=null!=(n=null==a?void 0:a.stencil)&&n,this.maxTextureSize=t.getParameter(t.MAX_TEXTURE_SIZE),this.maxCubeMapSize=t.getParameter(t.MAX_CUBE_MAP_TEXTURE_SIZE),this.maxRenderBufferSize=t.getParameter(t.MAX_RENDERBUFFER_SIZE),this.maxTextures=t.getParameter(t.MAX_TEXTURE_IMAGE_UNITS),this.maxCombinedTextures=t.getParameter(t.MAX_COMBINED_TEXTURE_IMAGE_UNITS),this.maxVertexTextures=t.getParameter(t.MAX_VERTEX_TEXTURE_IMAGE_UNITS),this.vertexUniformsCount=t.getParameter(t.MAX_VERTEX_UNIFORM_VECTORS),this.fragmentUniformsCount=t.getParameter(t.MAX_FRAGMENT_UNIFORM_VECTORS),this.maxColorAttachments=t.getParameter(t.MAX_COLOR_ATTACHMENTS),this.maxVolumeSize=t.getParameter(t.MAX_3D_TEXTURE_SIZE),e=this.extDebugRendererInfo,this.unmaskedRenderer=e?t.getParameter(e.UNMASKED_RENDERER_WEBGL):"",this.unmaskedVendor=e?t.getParameter(e.UNMASKED_VENDOR_WEBGL):"";this.supportsGpuParticles=!("ARM"===this.unmaskedVendor&&s.match(/SM-[a-zA-Z0-9]+/)||this.unmaskedRenderer.match(/\bMali-G52+/)),e=this.extTextureFilterAnisotropic,this.maxAnisotropy=e?t.getParameter(e.MAX_TEXTURE_MAX_ANISOTROPY_EXT):1;var r=!this.forceDisableMultisampling;this.maxSamples=r?t.getParameter(t.MAX_SAMPLES):1,this.maxSamples=Math.min(this.maxSamples,4),this.samples=r&&this.backBufferAntialias?this.maxSamples:1,this.supportsAreaLights=!Qe.android,this.maxTextures<=8&&(this.supportsAreaLights=!1)}initializeRenderState(){super.initializeRenderState();var e=this.gl;e.disable(e.BLEND),e.blendFunc(e.ONE,e.ZERO),e.blendEquation(e.FUNC_ADD),e.colorMask(!0,!0,!0,!0),e.blendColor(0,0,0,0),e.enable(e.CULL_FACE),this.cullFace=e.BACK,e.cullFace(e.BACK),e.enable(e.DEPTH_TEST),e.depthFunc(e.LEQUAL),e.depthMask(!0),this.stencil=!1,e.disable(e.STENCIL_TEST),this.stencilFuncFront=this.stencilFuncBack=7,this.stencilRefFront=this.stencilRefBack=0,this.stencilMaskFront=this.stencilMaskBack=255,e.stencilFunc(e.ALWAYS,0,255),this.stencilFailFront=this.stencilFailBack=0,this.stencilZfailFront=this.stencilZfailBack=0,this.stencilZpassFront=this.stencilZpassBack=0,this.stencilWriteMaskFront=255,this.stencilWriteMaskBack=255,e.stencilOp(e.KEEP,e.KEEP,e.KEEP),e.stencilMask(255),this.alphaToCoverage=!1,this.raster=!0,e.disable(e.SAMPLE_ALPHA_TO_COVERAGE),e.disable(e.RASTERIZER_DISCARD),this.depthBiasEnabled=!1,e.disable(e.POLYGON_OFFSET_FILL),this.clearDepth=1,e.clearDepth(1),this.clearColor=new mt(0,0,0,0),e.clearColor(0,0,0,0),this.clearStencil=0,e.clearStencil(0),e.hint(e.FRAGMENT_SHADER_DERIVATIVE_HINT,e.NICEST),e.enable(e.SCISSOR_TEST),e.pixelStorei(e.UNPACK_COLORSPACE_CONVERSION_WEBGL,e.NONE),this.unpackFlipY=!1,e.pixelStorei(e.UNPACK_FLIP_Y_WEBGL,!1),this.unpackPremultiplyAlpha=!1,e.pixelStorei(e.UNPACK_PREMULTIPLY_ALPHA_WEBGL,!1),e.pixelStorei(e.UNPACK_ALIGNMENT,1)}initTextureUnits(e){void 0===e&&(e=16),this.textureUnits=[];for(var t=0;t<e;t++)this.textureUnits.push([null,null,null])}initializeContextCaches(){super.initializeContextCaches(),this._vaoMap=new Map,this.boundVao=null,this.activeFramebuffer=null,this.feedback=null,this.transformFeedbackBuffer=null,this.textureUnit=0,this.initTextureUnits(this.maxCombinedTextures)}loseContext(){for(var e of(super.loseContext(),this.shaders))e.loseContext()}restoreContext(){for(var e of(this.initializeExtensions(),this.initializeCapabilities(),super.restoreContext(),this.shaders))e.restoreContext()}setViewport(e,t,s,i){this.vx===e&&this.vy===t&&this.vw===s&&this.vh===i||(this.gl.viewport(e,t,s,i),this.vx=e,this.vy=t,this.vw=s,this.vh=i)}setScissor(e,t,s,i){this.sx===e&&this.sy===t&&this.sw===s&&this.sh===i||(this.gl.scissor(e,t,s,i),this.sx=e,this.sy=t,this.sw=s,this.sh=i)}setFramebuffer(e){if(this.activeFramebuffer!==e){var t=this.gl;t.bindFramebuffer(t.FRAMEBUFFER,e),this.activeFramebuffer=e}}copyRenderTarget(e,t,s,i){var n,a,r=this.gl;if(e===this.backBuffer&&(e=null),s)if(t){if(e){if(!e._colorBuffer||!t._colorBuffer)return!1;if(e._colorBuffer._format!==t._colorBuffer._format)return!1}}else if(!e._colorBuffer)return!1;if(i&&e&&!e._depth){if(!e._depthBuffer||!t._depthBuffer)return!1;if(e._depthBuffer._format!==t._depthBuffer._format)return!1}var o=this.renderTarget;this.renderTarget=t,this.updateBegin();var l=e?e.impl._glFrameBuffer:null==(n=this.backBuffer)?void 0:n.impl._glFrameBuffer,h=t?t.impl._glFrameBuffer:null==(a=this.backBuffer)?void 0:a.impl._glFrameBuffer;r.bindFramebuffer(r.READ_FRAMEBUFFER,l),r.bindFramebuffer(r.DRAW_FRAMEBUFFER,h);var c=e?e.width:t?t.width:this.width,d=e?e.height:t?t.height:this.height;return r.blitFramebuffer(0,0,c,d,0,0,c,d,(s?r.COLOR_BUFFER_BIT:0)|(i?r.DEPTH_BUFFER_BIT:0),r.NEAREST),this.renderTarget=o,r.bindFramebuffer(r.FRAMEBUFFER,o?o.impl._glFrameBuffer:null),!0}frameStart(){super.frameStart(),this.updateBackbuffer(),this.gpuProfiler.frameStart()}frameEnd(){super.frameEnd(),this.gpuProfiler.frameEnd(),this.gpuProfiler.request()}startRenderPass(e){var t,s=null!=(t=e.renderTarget)?t:this.backBuffer;this.renderTarget=s,this.updateBegin();var{width:i,height:n}=s;this.setViewport(0,0,i,n),this.setScissor(0,0,i,n);var a=e.colorOps,r=e.depthStencilOps;if((null==a?void 0:a.clear)||r.clearDepth||r.clearStencil){var o=0,l={};(null==a?void 0:a.clear)&&(o|=1,l.color=[a.clearValue.r,a.clearValue.g,a.clearValue.b,a.clearValue.a]),r.clearDepth&&(o|=2,l.depth=r.clearDepthValue),r.clearStencil&&(o|=4,l.stencil=r.clearStencilValue),l.flags=o,this.clear(l)}this.insideRenderPass=!0}endRenderPass(e){this.unbindVertexArray();var t=this.renderTarget,s=e.colorArrayOps.length;if(t){var i;Ar.length=0;for(var n=this.gl,a=0;a<s;a++){var r=e.colorArrayOps[a];r.store||r.resolve||Ar.push(n.COLOR_ATTACHMENT0+a)}t!==this.backBuffer&&(e.depthStencilOps.storeDepth||Ar.push(n.DEPTH_ATTACHMENT),e.depthStencilOps.storeStencil||Ar.push(n.STENCIL_ATTACHMENT)),Ar.length>0&&e.fullSizeClearRect&&n.invalidateFramebuffer(n.DRAW_FRAMEBUFFER,Ar),s&&(null==(i=e.colorOps)?void 0:i.resolve)&&e.samples>1&&t.autoResolve&&t.resolve(!0,!1),t.depthBuffer&&e.depthStencilOps.resolveDepth&&e.samples>1&&t.autoResolve&&t.resolve(!1,!0);for(var o=0;o<s;o++){if(e.colorArrayOps[o].genMipmaps){var l=t._colorBuffers[o];l&&l.impl._glTexture&&l.mipmaps&&(this.activeTexture(this.maxCombinedTextures-1),this.bindTexture(l),this.gl.generateMipmap(l.impl._glTarget))}}}this.insideRenderPass=!1}set defaultFramebuffer(e){this._defaultFramebuffer!==e&&(this._defaultFramebuffer=e,this._defaultFramebufferChanged=!0)}get defaultFramebuffer(){return this._defaultFramebuffer}updateBegin(){if(this.boundVao=null,this._tempEnableSafariTextureUnitWorkaround)for(var e=0;e<this.textureUnits.length;++e)for(var t=0;t<3;++t)this.textureUnits[e][t]=null;var s,i=null!=(s=this.renderTarget)?s:this.backBuffer,n=i.impl;n.initialized||this.initRenderTarget(i),this.setFramebuffer(n._glFrameBuffer)}updateEnd(){this.unbindVertexArray();var e=this.renderTarget;if(e&&e!==this.backBuffer){e._samples>1&&e.autoResolve&&e.resolve();var t=e._colorBuffer;t&&t.impl._glTexture&&t.mipmaps&&(this.activeTexture(this.maxCombinedTextures-1),this.bindTexture(t),this.gl.generateMipmap(t.impl._glTarget))}}setUnpackFlipY(e){if(this.unpackFlipY!==e){this.unpackFlipY=e;var t=this.gl;t.pixelStorei(t.UNPACK_FLIP_Y_WEBGL,e)}}setUnpackPremultiplyAlpha(e){if(this.unpackPremultiplyAlpha!==e){this.unpackPremultiplyAlpha=e;var t=this.gl;t.pixelStorei(t.UNPACK_PREMULTIPLY_ALPHA_WEBGL,e)}}activeTexture(e){this.textureUnit!==e&&(this.gl.activeTexture(this.gl.TEXTURE0+e),this.textureUnit=e)}bindTexture(e){var t=e.impl,s=t._glTarget,i=t._glTexture,n=this.textureUnit,a=this.targetToSlot[s];this.textureUnits[n][a]!==i&&(this.gl.bindTexture(s,i),this.textureUnits[n][a]=i)}bindTextureOnUnit(e,t){var s=e.impl,i=s._glTarget,n=s._glTexture,a=this.targetToSlot[i];this.textureUnits[t][a]!==n&&(this.activeTexture(t),this.gl.bindTexture(i,n),this.textureUnits[t][a]=n)}setTextureParameters(e){var t=this.gl,s=e.impl.dirtyParameterFlags,i=e.impl._glTarget;if(1&s){var n=e._minFilter;(!e._mipmaps||e._compressed&&1===e._levels.length)&&(2===n||3===n?n=0:4!==n&&5!==n||(n=1)),t.texParameteri(i,t.TEXTURE_MIN_FILTER,this.glFilter[n])}if(2&s&&t.texParameteri(i,t.TEXTURE_MAG_FILTER,this.glFilter[e._magFilter]),4&s&&t.texParameteri(i,t.TEXTURE_WRAP_S,this.glAddress[e._addressU]),8&s&&t.texParameteri(i,t.TEXTURE_WRAP_T,this.glAddress[e._addressV]),16&s&&t.texParameteri(i,t.TEXTURE_WRAP_R,this.glAddress[e._addressW]),32&s&&t.texParameteri(i,t.TEXTURE_COMPARE_MODE,e._compareOnRead?t.COMPARE_REF_TO_TEXTURE:t.NONE),64&s&&t.texParameteri(i,t.TEXTURE_COMPARE_FUNC,this.glComparison[e._compareFunc]),128&s){var a=this.extTextureFilterAnisotropic;a&&t.texParameterf(i,a.TEXTURE_MAX_ANISOTROPY_EXT,pt.clamp(Math.round(e._anisotropy),1,this.maxAnisotropy))}}setTexture(e,t){var s=e.impl;s._glTexture||s.initialize(this,e),s.dirtyParameterFlags>0||e._needsUpload||e._needsMipmapsUpload?(this.activeTexture(t),this.bindTexture(e),s.dirtyParameterFlags&&(this.setTextureParameters(e),s.dirtyParameterFlags=0),(e._needsUpload||e._needsMipmapsUpload)&&(s.upload(this,e),e._needsUpload=!1,e._needsMipmapsUpload=!1)):this.bindTextureOnUnit(e,t)}createVertexArray(e){var t,s,i=e.length>1;if(i){t="";for(var n=0;n<e.length;n++){var a=e[n];t+=a.id+a.format.renderingHash}s=this._vaoMap.get(t)}if(!s){var r=this.gl;s=r.createVertexArray(),r.bindVertexArray(s),r.bindBuffer(r.ELEMENT_ARRAY_BUFFER,null);for(var o=0;o<e.length;o++){var l=e[o];r.bindBuffer(r.ARRAY_BUFFER,l.impl.bufferId);for(var h=l.format.elements,c=0;c<h.length;c++){var d=h[c],u=vi[d.name];d.asInt?r.vertexAttribIPointer(u,d.numComponents,this.glType[d.dataType],d.stride,d.offset):r.vertexAttribPointer(u,d.numComponents,this.glType[d.dataType],d.normalize,d.stride,d.offset),r.enableVertexAttribArray(u),l.format.instancing&&r.vertexAttribDivisor(u,1)}}r.bindVertexArray(null),r.bindBuffer(r.ARRAY_BUFFER,null),i&&this._vaoMap.set(t,s)}return s}unbindVertexArray(){this.boundVao&&(this.boundVao=null,this.gl.bindVertexArray(null))}setBuffers(){var e,t=this.gl;if(1===this.vertexBuffers.length){var s=this.vertexBuffers[0];s.impl.vao||(s.impl.vao=this.createVertexArray(this.vertexBuffers)),e=s.impl.vao}else e=this.createVertexArray(this.vertexBuffers);this.boundVao!==e&&(this.boundVao=e,t.bindVertexArray(e)),this.clearVertexBuffer();var i=this.indexBuffer?this.indexBuffer.impl.bufferId:null;t.bindBuffer(t.ELEMENT_ARRAY_BUFFER,i)}draw(e,t,s){var i=this.gl;if(this.activateShader(this),this.shaderValid){var n,a,r,o,l,h,c,d,u=this.shader;if(u){var p=u.impl.samplers,m=u.impl.uniforms;s||this.setBuffers();for(var f=0,g=0,v=p.length;g<v;g++){if(!(a=(n=p[g]).scopeId.value)){var _=n.scopeId.name;"uSceneDepthMap"===_&&(a=Ri(this,"white")),"uSceneColorMap"===_&&(a=Ri(this,"pink")),a||(a=Ri(this,"pink"))}if(a instanceof ki)r=a,this.setTexture(r,f),n.slot!==f&&(i.uniform1i(n.locationId,f),n.slot=f),f++;else{n.array.length=0,o=a.length;for(var y=0;y<o;y++)r=a[y],this.setTexture(r,f),n.array[y]=f,f++;i.uniform1iv(n.locationId,n.array)}}for(var x=0,w=m.length;x<w;x++)h=(l=m[x]).scopeId,c=l.version,d=h.versionObject.version,c.globalId===d.globalId&&c.revision===d.revision||(c.globalId=d.globalId,c.revision=d.revision,null!==h.value&&this.commitFunction[l.dataType](l,h.value));this.transformFeedbackBuffer&&(i.bindBufferBase(i.TRANSFORM_FEEDBACK_BUFFER,0,this.transformFeedbackBuffer.impl.bufferId),i.beginTransformFeedback(i.POINTS));var b=this.glPrimitive[e.type],C=e.count;if(e.indexed){var S=this.indexBuffer,A=S.impl.glFormat,T=e.base*S.bytesPerIndex;t>0?i.drawElementsInstanced(b,C,A,T,t):i.drawElements(b,C,A,T)}else{var P=e.base;t>0?i.drawArraysInstanced(b,P,C,t):i.drawArrays(b,P,C)}this.transformFeedbackBuffer&&(i.endTransformFeedback(),i.bindBufferBase(i.TRANSFORM_FEEDBACK_BUFFER,0,null)),this._drawCallsPerFrame++}}}clear(e){var t,s=this.defaultClearOptions,i=null!=(t=(e=e||s).flags)?t:s.flags;if(0!==i){var n=this.gl;if(1&i){var a,r=null!=(a=e.color)?a:s.color,o=r[0],l=r[1],h=r[2],c=r[3],d=this.clearColor;o===d.r&&l===d.g&&h===d.b&&c===d.a||(this.gl.clearColor(o,l,h,c),this.clearColor.set(o,l,h,c)),this.setBlendState(Vi.NOBLEND)}if(2&i){var u,p=null!=(u=e.depth)?u:s.depth;p!==this.clearDepth&&(this.gl.clearDepth(p),this.clearDepth=p),this.setDepthState(Hi.WRITEDEPTH)}if(4&i){var m,f=null!=(m=e.stencil)?m:s.stencil;f!==this.clearStencil&&(this.gl.clearStencil(f),this.clearStencil=f),n.stencilMask(255),this.stencilWriteMaskFront=255,this.stencilWriteMaskBack=255}n.clear(this.glClearFlag[i])}}submit(){this.gl.flush()}readPixels(e,t,s,i,n){var a=this.gl;a.readPixels(e,t,s,i,a.RGBA,a.UNSIGNED_BYTE,n)}readPixelsAsync(e,t,s,i,n){var a,r=this;return(a=function*(){var a,o,l,h,c,d,u=r.gl,p=null==(a=r.renderTarget.colorBuffer)?void 0:a.impl,m=null!=(o=null==p?void 0:p._glFormat)?o:u.RGBA,f=null!=(l=null==p?void 0:p._glPixelType)?l:u.UNSIGNED_BYTE,g=u.createBuffer();return u.bindBuffer(u.PIXEL_PACK_BUFFER,g),u.bufferData(u.PIXEL_PACK_BUFFER,n.byteLength,u.STREAM_READ),u.readPixels(e,t,s,i,m,f,0),u.bindBuffer(u.PIXEL_PACK_BUFFER,null),yield(h=0,c=20,d=u.fenceSync(u.SYNC_GPU_COMMANDS_COMPLETE,0),r.submit(),new Promise(((e,t)=>{!function s(){var i=u.clientWaitSync(d,h,0);i===u.WAIT_FAILED?(u.deleteSync(d),t(new Error("webgl clientWaitSync sync failed"))):i===u.TIMEOUT_EXPIRED?setTimeout(s,c):(u.deleteSync(d),e())}()}))),u.bindBuffer(u.PIXEL_PACK_BUFFER,g),u.getBufferSubData(u.PIXEL_PACK_BUFFER,0,n),u.bindBuffer(u.PIXEL_PACK_BUFFER,null),u.deleteBuffer(g),n},function(){var e=this,t=arguments;return new Promise((function(s,i){var n=a.apply(e,t);function r(e){Sr(n,s,i,r,o,"next",e)}function o(e){Sr(n,s,i,r,o,"throw",e)}r(void 0)}))})()}readTextureAsync(e,t,s,i,n,a){var r,o,l,h=null!=(r=a.face)?r:0,c=null!=(o=a.renderTarget)?o:new ln({colorBuffer:e,depth:!1,face:h}),d=new ArrayBuffer(Pi.calcLevelGpuSize(i,n,1,e._format)),u=null!=(l=a.data)?l:new(ps(e._format))(d);return this.setRenderTarget(c),this.initRenderTarget(c),new Promise(((e,r)=>{this.readPixelsAsync(t,s,i,n,u).then((t=>{a.renderTarget||c.destroy(),e(t)})).catch(r)}))}setAlphaToCoverage(e){this.alphaToCoverage!==e&&(this.alphaToCoverage=e,e?this.gl.enable(this.gl.SAMPLE_ALPHA_TO_COVERAGE):this.gl.disable(this.gl.SAMPLE_ALPHA_TO_COVERAGE))}setTransformFeedbackBuffer(e){if(this.transformFeedbackBuffer!==e){this.transformFeedbackBuffer=e;var t=this.gl;e?(this.feedback||(this.feedback=t.createTransformFeedback()),t.bindTransformFeedback(t.TRANSFORM_FEEDBACK,this.feedback)):t.bindTransformFeedback(t.TRANSFORM_FEEDBACK,null)}}setRaster(e){this.raster!==e&&(this.raster=e,e?this.gl.disable(this.gl.RASTERIZER_DISCARD):this.gl.enable(this.gl.RASTERIZER_DISCARD))}setStencilTest(e){if(this.stencil!==e){var t=this.gl;e?t.enable(t.STENCIL_TEST):t.disable(t.STENCIL_TEST),this.stencil=e}}setStencilFunc(e,t,s){this.stencilFuncFront===e&&this.stencilRefFront===t&&this.stencilMaskFront===s&&this.stencilFuncBack===e&&this.stencilRefBack===t&&this.stencilMaskBack===s||(this.gl.stencilFunc(this.glComparison[e],t,s),this.stencilFuncFront=this.stencilFuncBack=e,this.stencilRefFront=this.stencilRefBack=t,this.stencilMaskFront=this.stencilMaskBack=s)}setStencilFuncFront(e,t,s){if(this.stencilFuncFront!==e||this.stencilRefFront!==t||this.stencilMaskFront!==s){var i=this.gl;i.stencilFuncSeparate(i.FRONT,this.glComparison[e],t,s),this.stencilFuncFront=e,this.stencilRefFront=t,this.stencilMaskFront=s}}setStencilFuncBack(e,t,s){if(this.stencilFuncBack!==e||this.stencilRefBack!==t||this.stencilMaskBack!==s){var i=this.gl;i.stencilFuncSeparate(i.BACK,this.glComparison[e],t,s),this.stencilFuncBack=e,this.stencilRefBack=t,this.stencilMaskBack=s}}setStencilOperation(e,t,s,i){this.stencilFailFront===e&&this.stencilZfailFront===t&&this.stencilZpassFront===s&&this.stencilFailBack===e&&this.stencilZfailBack===t&&this.stencilZpassBack===s||(this.gl.stencilOp(this.glStencilOp[e],this.glStencilOp[t],this.glStencilOp[s]),this.stencilFailFront=this.stencilFailBack=e,this.stencilZfailFront=this.stencilZfailBack=t,this.stencilZpassFront=this.stencilZpassBack=s),this.stencilWriteMaskFront===i&&this.stencilWriteMaskBack===i||(this.gl.stencilMask(i),this.stencilWriteMaskFront=i,this.stencilWriteMaskBack=i)}setStencilOperationFront(e,t,s,i){this.stencilFailFront===e&&this.stencilZfailFront===t&&this.stencilZpassFront===s||(this.gl.stencilOpSeparate(this.gl.FRONT,this.glStencilOp[e],this.glStencilOp[t],this.glStencilOp[s]),this.stencilFailFront=e,this.stencilZfailFront=t,this.stencilZpassFront=s),this.stencilWriteMaskFront!==i&&(this.gl.stencilMaskSeparate(this.gl.FRONT,i),this.stencilWriteMaskFront=i)}setStencilOperationBack(e,t,s,i){this.stencilFailBack===e&&this.stencilZfailBack===t&&this.stencilZpassBack===s||(this.gl.stencilOpSeparate(this.gl.BACK,this.glStencilOp[e],this.glStencilOp[t],this.glStencilOp[s]),this.stencilFailBack=e,this.stencilZfailBack=t,this.stencilZpassBack=s),this.stencilWriteMaskBack!==i&&(this.gl.stencilMaskSeparate(this.gl.BACK,i),this.stencilWriteMaskBack=i)}setBlendState(e){var t=this.blendState;if(!t.equals(e)){var s=this.gl,{blend:i,colorOp:n,alphaOp:a,colorSrcFactor:r,colorDstFactor:o,alphaSrcFactor:l,alphaDstFactor:h}=e;if(t.blend!==i&&(i?s.enable(s.BLEND):s.disable(s.BLEND)),t.colorOp!==n||t.alphaOp!==a){var c=this.glBlendEquation;s.blendEquationSeparate(c[n],c[a])}t.colorSrcFactor===r&&t.colorDstFactor===o&&t.alphaSrcFactor===l&&t.alphaDstFactor===h||s.blendFuncSeparate(this.glBlendFunctionColor[r],this.glBlendFunctionColor[o],this.glBlendFunctionAlpha[l],this.glBlendFunctionAlpha[h]),t.allWrite!==e.allWrite&&this.gl.colorMask(e.redWrite,e.greenWrite,e.blueWrite,e.alphaWrite),t.copy(e)}}setBlendColor(e,t,s,i){var n=this.blendColor;e===n.r&&t===n.g&&s===n.b&&i===n.a||(this.gl.blendColor(e,t,s,i),n.set(e,t,s,i))}setStencilState(e,t){e||t?(this.setStencilTest(!0),e===t?(this.setStencilFunc(e.func,e.ref,e.readMask),this.setStencilOperation(e.fail,e.zfail,e.zpass,e.writeMask)):(null!=e||(e=nn.DEFAULT),this.setStencilFuncFront(e.func,e.ref,e.readMask),this.setStencilOperationFront(e.fail,e.zfail,e.zpass,e.writeMask),null!=t||(t=nn.DEFAULT),this.setStencilFuncBack(t.func,t.ref,t.readMask),this.setStencilOperationBack(t.fail,t.zfail,t.zpass,t.writeMask))):this.setStencilTest(!1)}setDepthState(e){var t=this.depthState;if(!t.equals(e)){var s=this.gl,i=e.write;t.write!==i&&s.depthMask(i);var{func:n,test:a}=e;!a&&i&&(a=!0,n=7),t.func!==n&&s.depthFunc(this.glComparison[n]),t.test!==a&&(a?s.enable(s.DEPTH_TEST):s.disable(s.DEPTH_TEST));var{depthBias:r,depthBiasSlope:o}=e;r||o?(this.depthBiasEnabled||(this.depthBiasEnabled=!0,this.gl.enable(this.gl.POLYGON_OFFSET_FILL)),s.polygonOffset(o,r)):this.depthBiasEnabled&&(this.depthBiasEnabled=!1,this.gl.disable(this.gl.POLYGON_OFFSET_FILL)),t.copy(e)}}setCullMode(e){if(this.cullMode!==e){if(0===e)this.gl.disable(this.gl.CULL_FACE);else{0===this.cullMode&&this.gl.enable(this.gl.CULL_FACE);var t=this.glCull[e];this.cullFace!==t&&(this.gl.cullFace(t),this.cullFace=t)}this.cullMode=e}}setShader(e,t){void 0===t&&(t=!1),e!==this.shader&&(this.shader=e,this.shaderAsyncCompile=t,this.shaderValid=void 0)}activateShader(e){var{shader:t}=this,{impl:s}=t;void 0===this.shaderValid&&(t.failed?this.shaderValid=!1:t.ready||(this.shaderAsyncCompile?s.isLinked(e)?s.finalize(this,t)||(t.failed=!0,this.shaderValid=!1):this.shaderValid=!1:s.finalize(this,t)||(t.failed=!0,this.shaderValid=!1))),void 0===this.shaderValid&&(this.gl.useProgram(s.glProgram),this.shaderValid=!0)}clearVertexArrayObjectCache(){var e=this.gl;this._vaoMap.forEach(((t,s,i)=>{e.deleteVertexArray(t)})),this._vaoMap.clear()}set fullscreen(e){e?this.gl.canvas.requestFullscreen():document.exitFullscreen()}get fullscreen(){return!!document.fullscreenElement}constructor(e,t={}){super(e,t),this._defaultFramebuffer=null,this._defaultFramebufferChanged=!1,t=this.initOptions,this.updateClientRect(),this.initTextureUnits(),this.contextLost=!1,this._contextLostHandler=e=>{e.preventDefault(),this.loseContext(),this.fire("devicelost")},this._contextRestoredHandler=()=>{this.restoreContext(),this.fire("devicerestored")};var s,i,n="undefined"!=typeof navigator&&navigator.userAgent;if(this.forceDisableMultisampling=n&&n.includes("AppleWebKit")&&(n.includes("15.4")||n.includes("15_4")),this.forceDisableMultisampling&&(t.antialias=!1),"firefox"===Qe.browserName){var a=("undefined"!=typeof navigator?navigator.userAgent:"").match(/Firefox\/(\d+(\.\d+)*)/),r=a?a[1]:null;if(r){var o=parseFloat(r);("windows"===Qe.name&&(o>=120||115===o)||"android"===Qe.name&&o>=132)&&(t.antialias=!1)}}this.backBufferAntialias=null!=(s=t.antialias)&&s,t.antialias=!1;var l=null!=(i=t.gl)?i:e.getContext("webgl2",t);if(!l)throw new Error("WebGL not supported");this.gl=l,this.isWebGL2=!0,this._deviceType=ri,this.updateBackbufferFormat(null);var h,c,d,u,p,m="chrome"===Qe.browserName,f="safari"===Qe.browserName,g=Qe.browser&&-1!==navigator.appVersion.indexOf("Mac");this._tempEnableSafariTextureUnitWorkaround=f,this._tempMacChromeBlitFramebufferWorkaround=g&&m&&!t.alpha,e.addEventListener("webglcontextlost",this._contextLostHandler,!1),e.addEventListener("webglcontextrestored",this._contextRestoredHandler,!1),this.initializeExtensions(),this.initializeCapabilities(),this.initializeRenderState(),this.initializeContextCaches(),this.createBackbuffer(null),this.supportsImageBitmap=!f&&"undefined"!=typeof ImageBitmap,this._samplerTypes=new Set([l.SAMPLER_2D,l.SAMPLER_CUBE,l.UNSIGNED_INT_SAMPLER_2D,l.INT_SAMPLER_2D,l.SAMPLER_2D_SHADOW,l.SAMPLER_CUBE_SHADOW,l.SAMPLER_3D,l.INT_SAMPLER_3D,l.UNSIGNED_INT_SAMPLER_3D,l.SAMPLER_2D_ARRAY,l.INT_SAMPLER_2D_ARRAY,l.UNSIGNED_INT_SAMPLER_2D_ARRAY]),this.glAddress=[l.REPEAT,l.CLAMP_TO_EDGE,l.MIRRORED_REPEAT],this.glBlendEquation=[l.FUNC_ADD,l.FUNC_SUBTRACT,l.FUNC_REVERSE_SUBTRACT,l.MIN,l.MAX],this.glBlendFunctionColor=[l.ZERO,l.ONE,l.SRC_COLOR,l.ONE_MINUS_SRC_COLOR,l.DST_COLOR,l.ONE_MINUS_DST_COLOR,l.SRC_ALPHA,l.SRC_ALPHA_SATURATE,l.ONE_MINUS_SRC_ALPHA,l.DST_ALPHA,l.ONE_MINUS_DST_ALPHA,l.CONSTANT_COLOR,l.ONE_MINUS_CONSTANT_COLOR],this.glBlendFunctionAlpha=[l.ZERO,l.ONE,l.SRC_COLOR,l.ONE_MINUS_SRC_COLOR,l.DST_COLOR,l.ONE_MINUS_DST_COLOR,l.SRC_ALPHA,l.SRC_ALPHA_SATURATE,l.ONE_MINUS_SRC_ALPHA,l.DST_ALPHA,l.ONE_MINUS_DST_ALPHA,l.CONSTANT_ALPHA,l.ONE_MINUS_CONSTANT_ALPHA],this.glComparison=[l.NEVER,l.LESS,l.EQUAL,l.LEQUAL,l.GREATER,l.NOTEQUAL,l.GEQUAL,l.ALWAYS],this.glStencilOp=[l.KEEP,l.ZERO,l.REPLACE,l.INCR,l.INCR_WRAP,l.DECR,l.DECR_WRAP,l.INVERT],this.glClearFlag=[0,l.COLOR_BUFFER_BIT,l.DEPTH_BUFFER_BIT,l.COLOR_BUFFER_BIT|l.DEPTH_BUFFER_BIT,l.STENCIL_BUFFER_BIT,l.STENCIL_BUFFER_BIT|l.COLOR_BUFFER_BIT,l.STENCIL_BUFFER_BIT|l.DEPTH_BUFFER_BIT,l.STENCIL_BUFFER_BIT|l.COLOR_BUFFER_BIT|l.DEPTH_BUFFER_BIT],this.glCull=[0,l.BACK,l.FRONT,l.FRONT_AND_BACK],this.glFilter=[l.NEAREST,l.LINEAR,l.NEAREST_MIPMAP_NEAREST,l.NEAREST_MIPMAP_LINEAR,l.LINEAR_MIPMAP_NEAREST,l.LINEAR_MIPMAP_LINEAR],this.glPrimitive=[l.POINTS,l.LINES,l.LINE_LOOP,l.LINE_STRIP,l.TRIANGLES,l.TRIANGLE_STRIP,l.TRIANGLE_FAN],this.glType=[l.BYTE,l.UNSIGNED_BYTE,l.SHORT,l.UNSIGNED_SHORT,l.INT,l.UNSIGNED_INT,l.FLOAT,l.HALF_FLOAT],this.pcUniformType={},this.pcUniformType[l.BOOL]=0,this.pcUniformType[l.INT]=1,this.pcUniformType[l.FLOAT]=2,this.pcUniformType[l.FLOAT_VEC2]=3,this.pcUniformType[l.FLOAT_VEC3]=4,this.pcUniformType[l.FLOAT_VEC4]=5,this.pcUniformType[l.INT_VEC2]=6,this.pcUniformType[l.INT_VEC3]=7,this.pcUniformType[l.INT_VEC4]=8,this.pcUniformType[l.BOOL_VEC2]=9,this.pcUniformType[l.BOOL_VEC3]=10,this.pcUniformType[l.BOOL_VEC4]=11,this.pcUniformType[l.FLOAT_MAT2]=12,this.pcUniformType[l.FLOAT_MAT3]=13,this.pcUniformType[l.FLOAT_MAT4]=$s,this.pcUniformType[l.SAMPLER_2D]=15,this.pcUniformType[l.SAMPLER_CUBE]=16,this.pcUniformType[l.UNSIGNED_INT]=Ks,this.pcUniformType[l.UNSIGNED_INT_VEC2]=Zs,this.pcUniformType[l.UNSIGNED_INT_VEC3]=Js,this.pcUniformType[l.UNSIGNED_INT_VEC4]=Qs,this.pcUniformType[l.SAMPLER_2D_SHADOW]=18,this.pcUniformType[l.SAMPLER_CUBE_SHADOW]=19,this.pcUniformType[l.SAMPLER_2D_ARRAY]=25,this.pcUniformType[l.SAMPLER_3D]=20,this.pcUniformType[l.INT_SAMPLER_2D]=42,this.pcUniformType[l.UNSIGNED_INT_SAMPLER_2D]=43,this.pcUniformType[l.INT_SAMPLER_CUBE]=44,this.pcUniformType[l.UNSIGNED_INT_SAMPLER_2D]=45,this.pcUniformType[l.INT_SAMPLER_3D]=46,this.pcUniformType[l.UNSIGNED_INT_SAMPLER_3D]=47,this.pcUniformType[l.INT_SAMPLER_2D_ARRAY]=48,this.pcUniformType[l.UNSIGNED_INT_SAMPLER_2D_ARRAY]=49,this.targetToSlot={},this.targetToSlot[l.TEXTURE_2D]=0,this.targetToSlot[l.TEXTURE_CUBE_MAP]=1,this.targetToSlot[l.TEXTURE_3D]=2,this.commitFunction=[],this.commitFunction[0]=function(e,t){e.value!==t&&(l.uniform1i(e.locationId,t),e.value=t)},this.commitFunction[1]=this.commitFunction[0],this.commitFunction[2]=function(e,t){e.value!==t&&(l.uniform1f(e.locationId,t),e.value=t)},this.commitFunction[3]=function(e,t){p=e.value,h=t[0],c=t[1],p[0]===h&&p[1]===c||(l.uniform2fv(e.locationId,t),p[0]=h,p[1]=c)},this.commitFunction[4]=function(e,t){p=e.value,h=t[0],c=t[1],d=t[2],p[0]===h&&p[1]===c&&p[2]===d||(l.uniform3fv(e.locationId,t),p[0]=h,p[1]=c,p[2]=d)},this.commitFunction[5]=function(e,t){p=e.value,h=t[0],c=t[1],d=t[2],u=t[3],p[0]===h&&p[1]===c&&p[2]===d&&p[3]===u||(l.uniform4fv(e.locationId,t),p[0]=h,p[1]=c,p[2]=d,p[3]=u)},this.commitFunction[6]=function(e,t){p=e.value,h=t[0],c=t[1],p[0]===h&&p[1]===c||(l.uniform2iv(e.locationId,t),p[0]=h,p[1]=c)},this.commitFunction[9]=this.commitFunction[6],this.commitFunction[7]=function(e,t){p=e.value,h=t[0],c=t[1],d=t[2],p[0]===h&&p[1]===c&&p[2]===d||(l.uniform3iv(e.locationId,t),p[0]=h,p[1]=c,p[2]=d)},this.commitFunction[10]=this.commitFunction[7],this.commitFunction[8]=function(e,t){p=e.value,h=t[0],c=t[1],d=t[2],u=t[3],p[0]===h&&p[1]===c&&p[2]===d&&p[3]===u||(l.uniform4iv(e.locationId,t),p[0]=h,p[1]=c,p[2]=d,p[3]=u)},this.commitFunction[11]=this.commitFunction[8],this.commitFunction[12]=function(e,t){l.uniformMatrix2fv(e.locationId,!1,t)},this.commitFunction[13]=function(e,t){l.uniformMatrix3fv(e.locationId,!1,t)},this.commitFunction[14]=function(e,t){l.uniformMatrix4fv(e.locationId,!1,t)},this.commitFunction[17]=function(e,t){l.uniform1fv(e.locationId,t)},this.commitFunction[21]=function(e,t){l.uniform2fv(e.locationId,t)},this.commitFunction[22]=function(e,t){l.uniform3fv(e.locationId,t)},this.commitFunction[23]=function(e,t){l.uniform4fv(e.locationId,t)},this.commitFunction[26]=function(e,t){e.value!==t&&(l.uniform1ui(e.locationId,t),e.value=t)},this.commitFunction[27]=function(e,t){p=e.value,h=t[0],c=t[1],p[0]===h&&p[1]===c||(l.uniform2uiv(e.locationId,t),p[0]=h,p[1]=c)},this.commitFunction[28]=function(e,t){p=e.value,h=t[0],c=t[1],d=t[2],p[0]===h&&p[1]===c&&p[2]===d||(l.uniform3uiv(e.locationId,t),p[0]=h,p[1]=c,p[2]=d)},this.commitFunction[29]=function(e,t){p=e.value,h=t[0],c=t[1],d=t[2],u=t[3],p[0]===h&&p[1]===c&&p[2]===d&&p[3]===u||(l.uniform4uiv(e.locationId,t),p[0]=h,p[1]=c,p[2]=d,p[3]=u)},this.commitFunction[30]=function(e,t){l.uniform1iv(e.locationId,t)},this.commitFunction[31]=function(e,t){l.uniform1uiv(e.locationId,t)},this.commitFunction[32]=this.commitFunction[30],this.commitFunction[33]=function(e,t){l.uniform2iv(e.locationId,t)},this.commitFunction[34]=function(e,t){l.uniform2uiv(e.locationId,t)},this.commitFunction[35]=this.commitFunction[33],this.commitFunction[36]=function(e,t){l.uniform3iv(e.locationId,t)},this.commitFunction[37]=function(e,t){l.uniform3uiv(e.locationId,t)},this.commitFunction[38]=this.commitFunction[36],this.commitFunction[39]=function(e,t){l.uniform4iv(e.locationId,t)},this.commitFunction[40]=function(e,t){l.uniform4uiv(e.locationId,t)},this.commitFunction[41]=this.commitFunction[39],this.commitFunction[24]=function(e,t){l.uniformMatrix4fv(e.locationId,!1,t)},this.constantTexSource=this.scope.resolve("source"),this.textureFloatRenderable=!!this.extColorBufferFloat,this.textureHalfFloatRenderable=!!this.extColorBufferHalfFloat||!!this.extColorBufferFloat,this.postInit()}}class Pr{unlock(e){}}class Er{destroy(e){}init(e,t){}loseContext(){}resolve(e,t,s,i){}}class kr{destroy(e){}loseContext(){}restoreContext(e,t){}}class Mr{destroy(e){}propertyChanged(e){}loseContext(){}}class Ir{destroy(e){}unlock(e){}}class Dr extends rn{destroy(){super.destroy()}initDeviceCaps(){this.disableParticleSystem=!0,this.precision="highp",this.maxPrecision="highp",this.maxSamples=4,this.maxTextures=16,this.maxTextureSize=4096,this.maxCubeMapSize=4096,this.maxVolumeSize=4096,this.maxColorAttachments=8,this.maxPixelRatio=1,this.maxAnisotropy=16,this.supportsUniformBuffers=!1,this.supportsAreaLights=!0,this.supportsGpuParticles=!1,this.textureFloatRenderable=!0,this.textureHalfFloatRenderable=!0,this.supportsImageBitmap=!0}postInit(){super.postInit()}frameStart(){super.frameStart()}frameEnd(){super.frameEnd()}updateBegin(){}updateEnd(){}readPixels(e,t,s,i,n){}createVertexBufferImpl(e,t){return new Ir(e,t)}createIndexBufferImpl(e){return new Pr(e)}createShaderImpl(e){return new kr(e)}createTextureImpl(e){return new Mr(e)}createRenderTargetImpl(e){return new Er(e)}draw(e,t,s){}setShader(e,t){}setBlendState(e){}setDepthState(e){}setStencilState(e,t){}setBlendColor(e,t,s,i){}setCullMode(e){}setAlphaToCoverage(e){}initializeContextCaches(){super.initializeContextCaches()}clear(e){}setViewport(e,t,s,i){}setScissor(e,t,s,i){}copyRenderTarget(e,t,s,i){return!0}constructor(e,t={}){super(e,t),t=this.initOptions,this.isNull=!0,this._deviceType=li,this.samples=1}}var Rr=0;class Lr{destroy(){var e=this.device,t=e.buffers.indexOf(this);-1!==t&&e.buffers.splice(t,1),this.device.indexBuffer===this&&(this.device.indexBuffer=null),this.impl.initialized&&(this.impl.destroy(e),this.adjustVramSizeTracking(e._vram,-this.storage.byteLength))}adjustVramSizeTracking(e,t){e.ib+=t}loseContext(){this.impl.loseContext()}getFormat(){return this.format}getNumIndices(){return this.numIndices}lock(){return this.storage}unlock(){this.impl.unlock(this)}setData(e){return e.byteLength===this.numBytes&&(this.storage=e,this.unlock(),!0)}_lockTypedArray(){var e=this.lock();return 2===this.format?new Uint32Array(e):1===this.format?new Uint16Array(e):new Uint8Array(e)}writeData(e,t){var s=this._lockTypedArray();if(e.length>t)if(ArrayBuffer.isView(e))e=e.subarray(0,t),s.set(e);else for(var i=0;i<t;i++)s[i]=e[i];else s.set(e);this.unlock()}readData(e){var t=this._lockTypedArray(),s=this.numIndices;if(ArrayBuffer.isView(e))e.set(t);else{e.length=0;for(var i=0;i<s;i++)e[i]=t[i]}return s}constructor(e,t,s,i=0,n,a){this.device=e,this.format=t,this.numIndices=s,this.usage=i,this.id=Rr++,this.impl=e.createIndexBufferImpl(this,a);var r=gi[t];this.bytesPerIndex=r,this.numBytes=this.numIndices*r,n?this.setData(n):this.storage=new ArrayBuffer(this.numBytes),this.adjustVramSizeTracking(e._vram,this.numBytes),this.device.buffers.push(this)}}class Fr{constructor(){this.clearValue=new mt(0,0,0,1),this.clearValueLinear=new mt(0,0,0,1),this.clear=!1,this.store=!1,this.resolve=!0,this.genMipmaps=!1}}class Br{constructor(){this.clearDepthValue=1,this.clearStencilValue=0,this.clearDepth=!1,this.clearStencil=!1,this.storeDepth=!1,this.resolveDepth=!1,this.storeStencil=!1}}class Or{get colorOps(){return this.colorArrayOps[0]}set name(e){this._name=e}get name(){return this._name||(this._name=this.constructor.name),this._name}set scaleX(e){this._options.scaleX=e}get scaleX(){return this._options.scaleX}set scaleY(e){this._options.scaleY=e}get scaleY(){return this._options.scaleY}set options(e){var t,s;(this._options=e,e)&&(this.scaleX=null!=(t=this.scaleX)?t:1,this.scaleY=null!=(s=this.scaleY)?s:1)}get options(){return this._options}init(e,t){void 0===e&&(e=null),this.options=t,this.renderTarget=e,this.samples=Math.max(this.renderTarget?this.renderTarget.samples:this.device.samples,1),this.allocateAttachments(),this.postInit()}allocateAttachments(){var e,t,s=this.renderTarget;this.depthStencilOps=new Br,(null==s?void 0:s.depthBuffer)&&(this.depthStencilOps.storeDepth=!0);var i=s?null!=(t=null==(e=s._colorBuffers)?void 0:e.length)?t:0:1;this.colorArrayOps.length=0;for(var n=0;n<i;n++){var a,r,o,l=new Fr;this.colorArrayOps[n]=l,1===this.samples&&(l.store=!0,l.resolve=!1);var h=null==(r=this.renderTarget)||null==(a=r._colorBuffers)?void 0:a[n];if((null==(o=this.renderTarget)?void 0:o.mipmaps)&&(null==h?void 0:h.mipmaps)){var c=ds(h._format);l.genMipmaps=!c}}}destroy(){}postInit(){}frameUpdate(){if(this._options&&this.renderTarget){var e,t=null!=(e=this._options.resizeSource)?e:this.device.backBuffer,s=Math.floor(t.width*this.scaleX),i=Math.floor(t.height*this.scaleY);this.renderTarget.resize(s,i)}}before(){}execute(){}after(){}onEnable(){}onDisable(){}set enabled(e){this._enabled!==e&&(this._enabled=e,e?this.onEnable():this.onDisable())}get enabled(){return this._enabled}setClearColor(e){for(var t=this.colorArrayOps.length,s=0;s<t;s++){var i=this.colorArrayOps[s];e&&(i.clearValue.copy(e),i.clearValueLinear.linear(e)),i.clear=!!e}}setClearDepth(e){e&&(this.depthStencilOps.clearDepthValue=e),this.depthStencilOps.clearDepth=void 0!==e}setClearStencil(e){e&&(this.depthStencilOps.clearStencilValue=e),this.depthStencilOps.clearStencil=void 0!==e}render(){if(this.enabled){var e=this.device,t=void 0!==this.renderTarget;this.before(),this.executeEnabled&&(t&&!this._skipStart&&e.startRenderPass(this),this.execute(),t&&!this._skipEnd&&e.endRenderPass(this)),this.after(),e.renderPassIndex++}}constructor(e){this._enabled=!0,this._skipStart=!1,this._skipEnd=!1,this.executeEnabled=!0,this.samples=0,this.colorArrayOps=[],this.requiresCubemaps=!0,this.fullSizeClearRect=!0,this.beforePasses=[],this.afterPasses=[],this.device=e}}function zr(e){this.array[this.index]=e}function Vr(e,t){this.array[this.index]=e,this.array[this.index+1]=t}function Nr(e,t,s){this.array[this.index]=e,this.array[this.index+1]=t,this.array[this.index+2]=s}function Ur(e,t,s,i){this.array[this.index]=e,this.array[this.index+1]=t,this.array[this.index+2]=s,this.array[this.index+3]=i}function Hr(e,t,s){this.array[e]=t[s]}function Gr(e,t,s){this.array[e]=t[s],this.array[e+1]=t[s+1]}function Wr(e,t,s){this.array[e]=t[s],this.array[e+1]=t[s+1],this.array[e+2]=t[s+2]}function jr(e,t,s){this.array[e]=t[s],this.array[e+1]=t[s+1],this.array[e+2]=t[s+2],this.array[e+3]=t[s+3]}function qr(e,t,s){t[s]=this.array[e]}function Xr(e,t,s){t[s]=this.array[e],t[s+1]=this.array[e+1]}function Yr(e,t,s){t[s]=this.array[e],t[s+1]=this.array[e+1],t[s+2]=this.array[e+2]}function $r(e,t,s){t[s]=this.array[e],t[s+1]=this.array[e+1],t[s+2]=this.array[e+2],t[s+3]=this.array[e+3]}class Kr{get(e){return this.array[this.index+e]}set(e,t,s,i){}getToArray(e,t,s){}setFromArray(e,t,s){}constructor(e,t,s){switch(this.index=0,this.numComponents=t.numComponents,s.interleaved?this.array=new pi[t.dataType](e,t.offset):this.array=new pi[t.dataType](e,t.offset,s.vertexCount*t.numComponents),this.stride=t.stride/this.array.constructor.BYTES_PER_ELEMENT,t.numComponents){case 1:this.set=zr,this.getToArray=qr,this.setFromArray=Hr;break;case 2:this.set=Vr,this.getToArray=Xr,this.setFromArray=Gr;break;case 3:this.set=Nr,this.getToArray=Yr,this.setFromArray=Wr;break;case 4:this.set=Ur,this.getToArray=$r,this.setFromArray=jr}}}class Zr{next(e){void 0===e&&(e=1);for(var t=0,s=this.accessors,i=this.accessors.length;t<i;){var n=s[t++];n.index+=e*n.stride}}end(){this.vertexBuffer.unlock()}writeData(e,t,s){var i=this.element[e];if(i){s>this.vertexBuffer.numVertices&&(s=this.vertexBuffer.numVertices);var n=i.numComponents;if(this.vertexBuffer.getFormat().interleaved)for(var a=0,r=0;r<s;r++)i.setFromArray(a,t,r*n),a+=i.stride;else if(t.length>s*n){var o=s*n;if(ArrayBuffer.isView(t))t=t.subarray(0,o),i.array.set(t);else for(var l=0;l<o;l++)i.array[l]=t[l]}else i.array.set(t)}}readData(e,t){var s=this.element[e],i=0;if(s){var n;i=this.vertexBuffer.numVertices;var a=s.numComponents;if(this.vertexBuffer.getFormat().interleaved){Array.isArray(t)&&(t.length=0),s.index=0;var r=0;for(n=0;n<i;n++)s.getToArray(r,t,n*a),r+=s.stride}else if(ArrayBuffer.isView(t))t.set(s.array);else{t.length=0;var o=i*a;for(n=0;n<o;n++)t[n]=s.array[n]}}return i}constructor(e){this.vertexBuffer=e,this.vertexFormatSize=e.getFormat().size,this.buffer=this.vertexBuffer.lock(),this.accessors=[],this.element={};for(var t=this.vertexBuffer.getFormat(),s=0;s<t.elements.length;s++){var i=t.elements[s];this.accessors[s]=new Kr(this.buffer,i,t),this.element[i.name]=this.accessors[s]}}}class Jr{get(e,t,s){return"function"==typeof t&&(s=t,t={}),this.request("GET",e,t,s)}post(e,t,s,i){return"function"==typeof s&&(i=s,s={}),s.postdata=t,this.request("POST",e,s,i)}put(e,t,s,i){return"function"==typeof s&&(i=s,s={}),s.postdata=t,this.request("PUT",e,s,i)}del(e,t,s){return"function"==typeof t&&(s=t,t={}),this.request("DELETE",e,t,s)}request(e,t,s,i){var n,a,r,o=!1;if("function"==typeof s&&(i=s,s={}),s.retry&&(s=Object.assign({retries:0,maxRetries:5},s)),s.callback=i,null==s.async&&(s.async=!0),null==s.headers&&(s.headers={}),null!=s.postdata)if(s.postdata instanceof Document)r=s.postdata;else if(s.postdata instanceof FormData)r=s.postdata;else if(s.postdata instanceof Object){var l=s.headers["Content-Type"];switch(void 0===l&&(s.headers["Content-Type"]=Jr.ContentType.FORM_URLENCODED,l=s.headers["Content-Type"]),l){case Jr.ContentType.FORM_URLENCODED:r="";var h=!0;for(var c in s.postdata){if(s.postdata.hasOwnProperty(c))h?h=!1:r+="&",r+=encodeURIComponent(c)+"="+encodeURIComponent(s.postdata[c])}break;default:case Jr.ContentType.JSON:null==l&&(s.headers["Content-Type"]=Jr.ContentType.JSON),r=JSON.stringify(s.postdata)}}else r=s.postdata;if(!1===s.cache){var d=ht();(n=new dt(t)).query?n.query=n.query+"&ts="+d:n.query="ts="+d,t=n.toString()}s.query&&(a=qe((n=new dt(t)).getQuery(),s.query),n.setQuery(a),t=n.toString());var u=new XMLHttpRequest;for(var p in u.open(e,t,s.async),u.withCredentials=void 0!==s.withCredentials&&s.withCredentials,u.responseType=s.responseType||this._guessResponseType(t),s.headers)s.headers.hasOwnProperty(p)&&u.setRequestHeader(p,s.headers[p]);u.onreadystatechange=()=>{this._onReadyStateChange(e,t,s,u)},u.onerror=()=>{this._onError(e,t,s,u),o=!0};try{u.send(r)}catch(e){o||s.error(u.status,u,e)}return u}_guessResponseType(e){var t=new dt(e),s=Ye.getExtension(t.path).toLowerCase();return Jr.binaryExtensions.indexOf(s)>=0?Jr.ResponseType.ARRAY_BUFFER:".json"===s?Jr.ResponseType.JSON:".xml"===s?Jr.ResponseType.DOCUMENT:Jr.ResponseType.TEXT}_isBinaryContentType(e){return[Jr.ContentType.BASIS,Jr.ContentType.BIN,Jr.ContentType.DDS,Jr.ContentType.GLB,Jr.ContentType.MP3,Jr.ContentType.MP4,Jr.ContentType.OGG,Jr.ContentType.OPUS,Jr.ContentType.WAV].indexOf(e)>=0}_isBinaryResponseType(e){return e===Jr.ResponseType.ARRAY_BUFFER||e===Jr.ResponseType.BLOB||e===Jr.ResponseType.JSON}_onReadyStateChange(e,t,s,i){if(4===i.readyState)switch(i.status){case 0:i.responseURL&&i.responseURL.startsWith("file:///")?this._onSuccess(e,t,s,i):this._onError(e,t,s,i);break;case 200:case 201:case 206:case 304:this._onSuccess(e,t,s,i);break;default:this._onError(e,t,s,i)}}_onSuccess(e,t,s,i){var n,a,r=i.getResponseHeader("Content-Type");r&&(a=r.split(";")[0].trim());try{n=this._isBinaryContentType(a)||this._isBinaryResponseType(i.responseType)?i.response:a===Jr.ContentType.JSON||t.split("?")[0].endsWith(".json")?JSON.parse(i.responseText):i.responseType===Jr.ResponseType.DOCUMENT||a===Jr.ContentType.XML?i.responseXML:i.responseText,s.callback(null,n)}catch(e){s.callback(e)}}_onError(e,t,s,i){if(!s.retrying)if(s.retry&&s.retries<s.maxRetries){s.retries++,s.retrying=!0;var n=pt.clamp(Math.pow(2,s.retries)*Jr.retryDelay,0,s.maxRetryDelay||5e3);console.log(e+": "+t+" - Error "+i.status+". Retrying in "+n+" ms"),setTimeout((()=>{s.retrying=!1,this.request(e,t,s,s.callback)}),n)}else s.callback(0===i.status?"Network error":i.status,null)}}Jr.ContentType={AAC:"audio/aac",BASIS:"image/basis",BIN:"application/octet-stream",DDS:"image/dds",FORM_URLENCODED:"application/x-www-form-urlencoded",GIF:"image/gif",GLB:"model/gltf-binary",JPEG:"image/jpeg",JSON:"application/json",MP3:"audio/mpeg",MP4:"audio/mp4",OGG:"audio/ogg",OPUS:'audio/ogg; codecs="opus"',PNG:"image/png",TEXT:"text/plain",WAV:"audio/x-wav",XML:"application/xml"},Jr.ResponseType={TEXT:"text",ARRAY_BUFFER:"arraybuffer",BLOB:"blob",DOCUMENT:"document",JSON:"json"},Jr.binaryExtensions=[".model",".wav",".ogg",".mp3",".mp4",".m4a",".aac",".dds",".basis",".glb",".opus"],Jr.retryDelay=100;var Qr=new Jr,eo="none",to=new Map([[5,{name:"PCF1_32F",format:Qt,pcf:!0}],[0,{name:"PCF3_32F",format:Qt,pcf:!0}],[4,{name:"PCF5_32F",format:Qt,pcf:!0}],[7,{name:"PCF1_16F",format:os,pcf:!0}],[8,{name:"PCF3_16F",format:os,pcf:!0}],[9,{name:"PCF5_16F",format:os,pcf:!0}],[2,{name:"VSM_16F",format:Kt,vsm:!0}],[3,{name:"VSM_32F",format:Zt,vsm:!0}],[6,{name:"PCSS_32F",format:Jt,pcss:!0}]]),so=0,io=1,no={[so]:"NONE",[io]:"SRGB"},ao=["LINEAR","FILMIC","HEJL","ACES","ACES2","NEUTRAL","NONE"],ro=1024,oo=2048,lo=8192,ho=16384,co="infinite",uo="none",po="bayer8",mo="prerender:layer",fo="postrender:layer";class go{hasUniform(e){for(var t=0;t<this.uniformFormats.length;t++){var s=this.uniformFormats[t];if(null==s?void 0:s.get(e))return!0}return!1}hasTexture(e){for(var t=0;t<this.bindGroupFormats.length;t++){var s=this.bindGroupFormats[t];if(null==s?void 0:s.getTexture(e))return!0}return!1}getVertexElement(e){var t;return null==(t=this.vertexFormat)?void 0:t.elements.find((t=>t.name===e))}generateKey(e){var t,s=JSON.stringify(this.uniformFormats)+JSON.stringify(this.bindGroupFormats);e.isWebGPU&&(s+=null==(t=this.vertexFormat)?void 0:t.shaderProcessingHashString);return s}constructor(e,t,s){this.uniformFormats=[],this.bindGroupFormats=[],this.uniformFormats[0]=e,this.bindGroupFormats[0]=t,this.vertexFormat=s}}var vo="\n#ifndef _DECODE_INCLUDED_\n#define _DECODE_INCLUDED_\nvec3 decodeLinear(vec4 raw) {\n\treturn raw.rgb;\n}\nfloat decodeGamma(float raw) {\n\treturn pow(raw, 2.2);\n}\nvec3 decodeGamma(vec3 raw) {\n\treturn pow(raw, vec3(2.2));\n}\nvec3 decodeGamma(vec4 raw) {\n\treturn pow(raw.xyz, vec3(2.2));\n}\nvec3 decodeRGBM(vec4 raw) {\n\tvec3 color = (8.0 * raw.a) * raw.rgb;\n\treturn color * color;\n}\nvec3 decodeRGBP(vec4 raw) {\n\tvec3 color = raw.rgb * (-raw.a * 7.0 + 8.0);\n\treturn color * color;\n}\nvec3 decodeRGBE(vec4 raw) {\n\tif (raw.a == 0.0) {\n\t\treturn vec3(0.0, 0.0, 0.0);\n\t} else {\n\t\treturn raw.xyz * pow(2.0, raw.w * 255.0 - 128.0);\n\t}\n}\nvec4 passThrough(vec4 raw) {\n\treturn raw;\n}\n#endif\n",_o="\nvec4 encodeLinear(vec3 source) {\n\treturn vec4(source, 1.0);\n}\nvec4 encodeGamma(vec3 source) {\n\treturn vec4(pow(source + 0.0000001, vec3(1.0 / 2.2)), 1.0);\n}\nvec4 encodeRGBM(vec3 source) {\n\tvec4 result;\n\tresult.rgb = pow(source.rgb, vec3(0.5));\n\tresult.rgb *= 1.0 / 8.0;\n\tresult.a = saturate( max( max( result.r, result.g ), max( result.b, 1.0 / 255.0 ) ) );\n\tresult.a = ceil(result.a * 255.0) / 255.0;\n\tresult.rgb /= result.a;\n\treturn result;\n}\nvec4 encodeRGBP(vec3 source) {\n\tvec3 gamma = pow(source, vec3(0.5));\n\tfloat maxVal = min(8.0, max(1.0, max(gamma.x, max(gamma.y, gamma.z))));\n\tfloat v = 1.0 - ((maxVal - 1.0) / 7.0);\n\tv = ceil(v * 255.0) / 255.0;\n\treturn vec4(gamma / (-v * 7.0 + 8.0), v);\t\n}\nvec4 encodeRGBE(vec3 source) {\n\tfloat maxVal = max(source.x, max(source.y, source.z));\n\tif (maxVal < 1e-32) {\n\t\treturn vec4(0, 0, 0, 0);\n\t} else {\n\t\tfloat e = ceil(log2(maxVal));\n\t\treturn vec4(source / pow(2.0, e), (e + 128.0) / 255.0);\n\t}\n}\n",yo={alphaTestPS:"\nuniform float alpha_ref;\nvoid alphaTest(float a) {\n\tif (a < alpha_ref) discard;\n}\n",ambientConstantPS:"\nvoid addAmbient(vec3 worldNormal) {\n\tdDiffuseLight += light_globalAmbient;\n}\n",ambientEnvPS:"\n#ifndef ENV_ATLAS\n#define ENV_ATLAS\nuniform sampler2D texture_envAtlas;\n#endif\nvoid addAmbient(vec3 worldNormal) {\n\tvec3 dir = normalize(cubeMapRotate(worldNormal) * vec3(-1.0, 1.0, 1.0));\n\tvec2 uv = mapUv(toSphericalUv(dir), vec4(128.0, 256.0 + 128.0, 64.0, 32.0) / atlasSize);\n\tvec4 raw = texture2D(texture_envAtlas, uv);\n\tvec3 linear = $DECODE(raw);\n\tdDiffuseLight += processEnvironment(linear);\n}\n",ambientSHPS:"\nuniform vec3 ambientSH[9];\nvoid addAmbient(vec3 worldNormal) {\n\tvec3 n = cubeMapRotate(worldNormal);\n\tvec3 color =\n\t\tambientSH[0] +\n\t\tambientSH[1] * n.x +\n\t\tambientSH[2] * n.y +\n\t\tambientSH[3] * n.z +\n\t\tambientSH[4] * n.x * n.z +\n\t\tambientSH[5] * n.z * n.y +\n\t\tambientSH[6] * n.y * n.x +\n\t\tambientSH[7] * (3.0 * n.z * n.z - 1.0) +\n\t\tambientSH[8] * (n.x * n.x - n.y * n.y);\n\tdDiffuseLight += processEnvironment(max(color, vec3(0.0)));\n}\n",aoPS:"\n#ifdef MAPTEXTURE\n\t#define AO_INTENSITY\n#endif\n#ifdef MAPVERTEX\n\t#define AO_INTENSITY\n#endif\n#ifdef AO_INTENSITY\n\tuniform float material_aoIntensity;\n#endif\nvoid getAO() {\n\tdAo = 1.0;\n\t#ifdef MAPTEXTURE\n\t\tfloat aoBase = texture2DBias($SAMPLER, $UV, textureBias).$CH;\n\t\tdAo *= addAoDetail(aoBase);\n\t#endif\n\t#ifdef MAPVERTEX\n\t\tdAo *= saturate(vVertexColor.$VC);\n\t#endif\n\t#ifdef AO_INTENSITY\n\t\tdAo = mix(1.0, dAo, material_aoIntensity);\n\t#endif\n}\n",aoDetailMapPS:"\nfloat addAoDetail(float ao) {\n#ifdef MAPTEXTURE\n\tfloat aoDetail = texture2DBias($SAMPLER, $UV, textureBias).$CH;\n\treturn detailMode_$DETAILMODE(vec3(ao), vec3(aoDetail)).r;\n#else\n\treturn ao;\n#endif\n}\n",aoDiffuseOccPS:"\nvoid occludeDiffuse(float ao) {\n\tdDiffuseLight *= ao;\n}\n",aoSpecOccPS:"\nuniform float material_occludeSpecularIntensity;\nvoid occludeSpecular(float gloss, float ao, vec3 worldNormal, vec3 viewDir) {\n\tfloat specPow = exp2(gloss * 11.0);\n\tfloat specOcc = saturate(pow(dot(worldNormal, viewDir) + ao, 0.01*specPow) - 1.0 + ao);\n\tspecOcc = mix(1.0, specOcc, material_occludeSpecularIntensity);\n\tdSpecularLight *= specOcc;\n\tdReflection *= specOcc;\n\t\n#ifdef LIT_SHEEN\n\tsSpecularLight *= specOcc;\n\tsReflection *= specOcc;\n#endif\n}\n",aoSpecOccConstPS:"\nvoid occludeSpecular(float gloss, float ao, vec3 worldNormal, vec3 viewDir) {\n\tfloat specPow = exp2(gloss * 11.0);\n\tfloat specOcc = saturate(pow(dot(worldNormal, viewDir) + ao, 0.01*specPow) - 1.0 + ao);\n\tdSpecularLight *= specOcc;\n\tdReflection *= specOcc;\n\t\n#ifdef LIT_SHEEN\n\tsSpecularLight *= specOcc;\n\tsReflection *= specOcc;\n#endif\n}\n",aoSpecOccConstSimplePS:"\nvoid occludeSpecular(float gloss, float ao, vec3 worldNormal, vec3 viewDir) {\n\tdSpecularLight *= ao;\n\tdReflection *= ao;\n#ifdef LIT_SHEEN\n\tsSpecularLight *= ao;\n\tsReflection *= ao;\n#endif\n}\n",aoSpecOccSimplePS:"\nuniform float material_occludeSpecularIntensity;\nvoid occludeSpecular(float gloss, float ao, vec3 worldNormal, vec3 viewDir) {\n\tfloat specOcc = mix(1.0, ao, material_occludeSpecularIntensity);\n\tdSpecularLight *= specOcc;\n\tdReflection *= specOcc;\n#ifdef LIT_SHEEN\n\tsSpecularLight *= specOcc;\n\tsReflection *= specOcc;\n#endif\n}\n",basePS:"\nuniform vec3 view_position;\nuniform vec3 light_globalAmbient;\nfloat square(float x) {\n\treturn x*x;\n}\nfloat saturate(float x) {\n\treturn clamp(x, 0.0, 1.0);\n}\nvec3 saturate(vec3 x) {\n\treturn clamp(x, vec3(0.0), vec3(1.0));\n}\n",baseVS:'\nattribute vec4 vertex_tangent;\nattribute vec2 vertex_texCoord0;\nattribute vec2 vertex_texCoord1;\nattribute vec4 vertex_color;\nvec3 dPositionW;\nmat4 dModelMatrix;\n#include "transformCoreVS"\n',baseNineSlicedPS:"\n#define NINESLICED\nvarying vec2 vMask;\nvarying vec2 vTiledUv;\nuniform mediump vec4 innerOffset;\nuniform mediump vec2 outerScale;\nuniform mediump vec4 atlasRect;\nvec2 nineSlicedUv;\n",baseNineSlicedVS:"\n#define NINESLICED\nvarying vec2 vMask;\nvarying vec2 vTiledUv;\nuniform mediump vec4 innerOffset;\nuniform mediump vec2 outerScale;\nuniform mediump vec4 atlasRect;\n",baseNineSlicedTiledPS:"\n#define NINESLICED\n#define NINESLICETILED\nvarying vec2 vMask;\nvarying vec2 vTiledUv;\nuniform mediump vec4 innerOffset;\nuniform mediump vec2 outerScale;\nuniform mediump vec4 atlasRect;\nvec2 nineSlicedUv;\n",bayerPS:"\nfloat bayer2(vec2 p) {\n\treturn mod(2.0 * p.y + p.x + 1.0, 4.0);\n}\nfloat bayer4(vec2 p) {\n\tvec2 p1 = mod(p, 2.0);\n\tvec2 p2 = floor(0.5 * mod(p, 4.0));\n\treturn 4.0 * bayer2(p1) + bayer2(p2);\n}\nfloat bayer8(vec2 p) {\n\tvec2 p1 = mod(p, 2.0);\n\tvec2 p2 = floor(0.5 * mod(p, 4.0));\n\tvec2 p4 = floor(0.25 * mod(p, 8.0));\n\treturn 4.0 * (4.0 * bayer2(p1) + bayer2(p2)) + bayer2(p4);\n}\n",blurVSMPS:"\nvarying vec2 vUv0;\nuniform sampler2D source;\nuniform vec2 pixelOffset;\n#ifdef GAUSS\nuniform float weight[SAMPLES];\n#endif\nvoid main(void) {\n\tvec3 moments = vec3(0.0);\n\tvec2 uv = vUv0 - pixelOffset * (float(SAMPLES) * 0.5);\n\tfor (int i=0; i<SAMPLES; i++) {\n\t\tvec4 c = texture2D(source, uv + pixelOffset * float(i));\n\t\t#ifdef GAUSS\n\t\tmoments += c.xyz * weight[i];\n\t\t#else\n\t\tmoments += c.xyz;\n\t\t#endif\n\t}\n\t#ifndef GAUSS\n\tmoments /= float(SAMPLES);\n\t#endif\n\tgl_FragColor = vec4(moments.x, moments.y, moments.z, 1.0);\n}\n",clearCoatPS:"\n#ifdef MAPFLOAT\nuniform float material_clearCoat;\n#endif\nvoid getClearCoat() {\n\tccSpecularity = 1.0;\n\t#ifdef MAPFLOAT\n\tccSpecularity *= material_clearCoat;\n\t#endif\n\t#ifdef MAPTEXTURE\n\tccSpecularity *= texture2DBias($SAMPLER, $UV, textureBias).$CH;\n\t#endif\n\t#ifdef MAPVERTEX\n\tccSpecularity *= saturate(vVertexColor.$VC);\n\t#endif\n}\n",clearCoatGlossPS:"\n#ifdef MAPFLOAT\nuniform float material_clearCoatGloss;\n#endif\nvoid getClearCoatGlossiness() {\n\tccGlossiness = 1.0;\n\t#ifdef MAPFLOAT\n\tccGlossiness *= material_clearCoatGloss;\n\t#endif\n\t#ifdef MAPTEXTURE\n\tccGlossiness *= texture2DBias($SAMPLER, $UV, textureBias).$CH;\n\t#endif\n\t#ifdef MAPVERTEX\n\tccGlossiness *= saturate(vVertexColor.$VC);\n\t#endif\n\t#ifdef MAPINVERT\n\tccGlossiness = 1.0 - ccGlossiness;\n\t#endif\n\tccGlossiness += 0.0000001;\n}\n",clearCoatNormalPS:"\n#ifdef MAPTEXTURE\nuniform float material_clearCoatBumpiness;\n#endif\nvoid getClearCoatNormal() {\n#ifdef MAPTEXTURE\n\tvec3 normalMap = unpackNormal(texture2DBias($SAMPLER, $UV, textureBias));\n\tnormalMap = mix(vec3(0.0, 0.0, 1.0), normalMap, material_clearCoatBumpiness);\n\tccNormalW = normalize(dTBN * normalMap);\n#else\n\tccNormalW = dVertexNormalW;\n#endif\n}\n",clusteredLightCookiesPS:"\nvec3 _getCookieClustered(TEXTURE_ACCEPT(tex), vec2 uv, float intensity, bool isRgb, vec4 cookieChannel) {\n\tvec4 pixel = mix(vec4(1.0), texture2DLod(tex, uv, 0.0), intensity);\n\treturn isRgb == true ? pixel.rgb : vec3(dot(pixel, cookieChannel));\n}\nvec3 getCookie2DClustered(TEXTURE_ACCEPT(tex), mat4 transform, vec3 worldPosition, float intensity, bool isRgb, vec4 cookieChannel) {\n\tvec4 projPos = transform * vec4(worldPosition, 1.0);\n\treturn _getCookieClustered(TEXTURE_PASS(tex), projPos.xy / projPos.w, intensity, isRgb, cookieChannel);\n}\nvec3 getCookieCubeClustered(TEXTURE_ACCEPT(tex), vec3 dir, float intensity, bool isRgb, vec4 cookieChannel, float shadowTextureResolution, float shadowEdgePixels, vec3 omniAtlasViewport) {\n\tvec2 uv = getCubemapAtlasCoordinates(omniAtlasViewport, shadowEdgePixels, shadowTextureResolution, dir);\n\treturn _getCookieClustered(TEXTURE_PASS(tex), uv, intensity, isRgb, cookieChannel);\n}\n",clusteredLightShadowsPS:"\nvoid _getShadowCoordPerspZbuffer(mat4 shadowMatrix, vec4 shadowParams, vec3 wPos) {\n\tvec4 projPos = shadowMatrix * vec4(wPos, 1.0);\n\tprojPos.xyz /= projPos.w;\n\tdShadowCoord = projPos.xyz;\n}\nvoid getShadowCoordPerspZbufferNormalOffset(mat4 shadowMatrix, vec4 shadowParams, vec3 normal) {\n\tvec3 wPos = vPositionW + normal * shadowParams.y;\n\t_getShadowCoordPerspZbuffer(shadowMatrix, shadowParams, wPos);\n}\nvec3 normalOffsetPointShadow(vec4 shadowParams, vec3 lightPos, inout vec3 lightDir, vec3 lightDirNorm, vec3 normal) {\n\tfloat distScale = length(lightDir);\n\tvec3 wPos = vPositionW + normal * shadowParams.y * clamp(1.0 - dot(normal, -lightDirNorm), 0.0, 1.0) * distScale;\n\tvec3 dir = wPos - lightPos;\n\treturn dir;\n}\n#if defined(CLUSTER_SHADOW_TYPE_PCF1)\nfloat getShadowOmniClusteredPCF1(SHADOWMAP_ACCEPT(shadowMap), vec4 shadowParams, vec3 omniAtlasViewport, float shadowEdgePixels, vec3 lightDir) {\n\tfloat shadowTextureResolution = shadowParams.x;\n\tvec2 uv = getCubemapAtlasCoordinates(omniAtlasViewport, shadowEdgePixels, shadowTextureResolution, lightDir);\n\tfloat shadowZ = length(lightDir) * shadowParams.w + shadowParams.z;\n\treturn textureShadow(shadowMap, vec3(uv, shadowZ));\n}\n#endif\n#if defined(CLUSTER_SHADOW_TYPE_PCF3)\nfloat getShadowOmniClusteredPCF3(SHADOWMAP_ACCEPT(shadowMap), vec4 shadowParams, vec3 omniAtlasViewport, float shadowEdgePixels, vec3 lightDir) {\n\tfloat shadowTextureResolution = shadowParams.x;\n\tvec2 uv = getCubemapAtlasCoordinates(omniAtlasViewport, shadowEdgePixels, shadowTextureResolution, lightDir);\n\tfloat shadowZ = length(lightDir) * shadowParams.w + shadowParams.z;\n\tvec3 shadowCoord = vec3(uv, shadowZ);\n\treturn getShadowPCF3x3(SHADOWMAP_PASS(shadowMap), shadowCoord, shadowParams);\n}\n#endif\n#if defined(CLUSTER_SHADOW_TYPE_PCF5)\nfloat getShadowOmniClusteredPCF5(SHADOWMAP_ACCEPT(shadowMap), vec4 shadowParams, vec3 omniAtlasViewport, float shadowEdgePixels, vec3 lightDir) {\n\tfloat shadowTextureResolution = shadowParams.x;\n\tvec2 uv = getCubemapAtlasCoordinates(omniAtlasViewport, shadowEdgePixels, shadowTextureResolution, lightDir);\n\tfloat shadowZ = length(lightDir) * shadowParams.w + shadowParams.z;\n\tvec3 shadowCoord = vec3(uv, shadowZ);\n\treturn getShadowPCF5x5(SHADOWMAP_PASS(shadowMap), shadowCoord, shadowParams);\n}\n#endif\n#if defined(CLUSTER_SHADOW_TYPE_PCF1)\nfloat getShadowSpotClusteredPCF1(SHADOWMAP_ACCEPT(shadowMap), vec3 shadowCoord, vec4 shadowParams) {\n\treturn textureShadow(shadowMap, shadowCoord);\n}\n#endif\n#if defined(CLUSTER_SHADOW_TYPE_PCF3)\nfloat getShadowSpotClusteredPCF3(SHADOWMAP_ACCEPT(shadowMap), vec3 shadowCoord, vec4 shadowParams) {\n\treturn getShadowSpotPCF3x3(SHADOWMAP_PASS(shadowMap), shadowCoord, shadowParams);\n}\n#endif\n#if defined(CLUSTER_SHADOW_TYPE_PCF5)\nfloat getShadowSpotClusteredPCF5(SHADOWMAP_ACCEPT(shadowMap), vec3 shadowCoord, vec4 shadowParams) {\n\treturn getShadowPCF5x5(SHADOWMAP_PASS(shadowMap), shadowCoord, shadowParams);\n}\n#endif\n",clusteredLightUtilsPS:"\nvec2 getCubemapFaceCoordinates(const vec3 dir, out float faceIndex, out vec2 tileOffset)\n{\n\tvec3 vAbs = abs(dir);\n\tfloat ma;\n\tvec2 uv;\n\tif (vAbs.z >= vAbs.x && vAbs.z >= vAbs.y) {\n\t\tfaceIndex = dir.z < 0.0 ? 5.0 : 4.0;\n\t\tma = 0.5 / vAbs.z;\n\t\tuv = vec2(dir.z < 0.0 ? -dir.x : dir.x, -dir.y);\n\t\ttileOffset.x = 2.0;\n\t\ttileOffset.y = dir.z < 0.0 ? 1.0 : 0.0;\n\t} else if(vAbs.y >= vAbs.x) {\n\t\tfaceIndex = dir.y < 0.0 ? 3.0 : 2.0;\n\t\tma = 0.5 / vAbs.y;\n\t\tuv = vec2(dir.x, dir.y < 0.0 ? -dir.z : dir.z);\n\t\ttileOffset.x = 1.0;\n\t\ttileOffset.y = dir.y < 0.0 ? 1.0 : 0.0;\n\t} else {\n\t\tfaceIndex = dir.x < 0.0 ? 1.0 : 0.0;\n\t\tma = 0.5 / vAbs.x;\n\t\tuv = vec2(dir.x < 0.0 ? dir.z : -dir.z, -dir.y);\n\t\ttileOffset.x = 0.0;\n\t\ttileOffset.y = dir.x < 0.0 ? 1.0 : 0.0;\n\t}\n\treturn uv * ma + 0.5;\n}\nvec2 getCubemapAtlasCoordinates(const vec3 omniAtlasViewport, float shadowEdgePixels, float shadowTextureResolution, const vec3 dir) {\n\tfloat faceIndex;\n\tvec2 tileOffset;\n\tvec2 uv = getCubemapFaceCoordinates(dir, faceIndex, tileOffset);\n\tfloat atlasFaceSize = omniAtlasViewport.z;\n\tfloat tileSize = shadowTextureResolution * atlasFaceSize;\n\tfloat offset = shadowEdgePixels / tileSize;\n\tuv = uv * vec2(1.0 - offset * 2.0) + vec2(offset * 1.0);\n\tuv *= atlasFaceSize;\n\tuv += tileOffset * atlasFaceSize;\n\tuv += omniAtlasViewport.xy;\n\treturn uv;\n}\n",clusteredLightPS:"\nuniform highp sampler2D clusterWorldTexture;\nuniform highp sampler2D lightsTexture8;\nuniform highp sampler2D lightsTextureFloat;\n#if defined(CLUSTER_COOKIES)\n\t#define CLUSTER_COOKIES_OR_SHADOWS\n#endif\n#if defined(CLUSTER_SHADOWS)\n\t#define CLUSTER_COOKIES_OR_SHADOWS\n#endif\n#ifdef CLUSTER_SHADOWS\n\tuniform sampler2DShadow shadowAtlasTexture;\n#endif\n#ifdef CLUSTER_COOKIES\n\tuniform sampler2D cookieAtlasTexture;\n#endif\nuniform int clusterMaxCells;\nuniform float clusterSkip;\nuniform vec3 clusterCellsCountByBoundsSize;\nuniform vec3 clusterTextureSize;\nuniform vec3 clusterBoundsMin;\nuniform vec3 clusterBoundsDelta;\nuniform vec3 clusterCellsDot;\nuniform vec3 clusterCellsMax;\nuniform vec2 clusterCompressionLimit0;\nuniform vec2 shadowAtlasParams;\nstruct ClusterLightData {\n\tvec3 halfWidth;\n\tfloat lightType;\n\tvec3 halfHeight;\n\tint lightIndex;\n\tvec3 position;\n\tfloat shape;\n\tvec3 direction;\n\tfloat falloffMode;\n\tvec3 color;\n\tfloat shadowIntensity;\n\tvec3 omniAtlasViewport;\n\tfloat range;\n\tvec4 cookieChannelMask;\n\tfloat shadowBias;\n\tfloat shadowNormalBias;\n\tfloat innerConeAngleCos;\n\tfloat outerConeAngleCos;\n\tfloat cookie;\n\tfloat cookieRgb;\n\tfloat cookieIntensity;\n\tfloat mask;\n};\nmat4 lightProjectionMatrix;\n#define isClusteredLightCastShadow(light) ( light.shadowIntensity > 0.0 )\n#define isClusteredLightCookie(light) (light.cookie > 0.5 )\n#define isClusteredLightCookieRgb(light) (light.cookieRgb > 0.5 )\n#define isClusteredLightSpot(light) ( light.lightType > 0.5 )\n#define isClusteredLightFalloffLinear(light) ( light.falloffMode < 0.5 )\n#define isClusteredLightArea(light) ( light.shape > 0.1 )\n#define isClusteredLightRect(light) ( light.shape < 0.3 )\n#define isClusteredLightDisk(light) ( light.shape < 0.6 )\n#ifdef CLUSTER_MESH_DYNAMIC_LIGHTS\n\t#define acceptLightMask(light) ( light.mask < 0.75)\n#else\n\t#define acceptLightMask(light) ( light.mask > 0.25)\n#endif\nvec4 decodeClusterLowRange4Vec4(vec4 d0, vec4 d1, vec4 d2, vec4 d3) {\n\treturn vec4(\n\t\tbytes2floatRange4(d0, -2.0, 2.0),\n\t\tbytes2floatRange4(d1, -2.0, 2.0),\n\t\tbytes2floatRange4(d2, -2.0, 2.0),\n\t\tbytes2floatRange4(d3, -2.0, 2.0)\n\t);\n}\nvec4 sampleLightsTexture8(const ClusterLightData clusterLightData, int index) {\n\treturn texelFetch(lightsTexture8, ivec2(index, clusterLightData.lightIndex), 0);\n}\nvec4 sampleLightTextureF(const ClusterLightData clusterLightData, int index) {\n\treturn texelFetch(lightsTextureFloat, ivec2(index, clusterLightData.lightIndex), 0);\n}\nvoid decodeClusterLightCore(inout ClusterLightData clusterLightData, float lightIndex) {\n\tclusterLightData.lightIndex = int(lightIndex);\n\tvec4 lightInfo = sampleLightsTexture8(clusterLightData, CLUSTER_TEXTURE_8_FLAGS);\n\tclusterLightData.lightType = lightInfo.x;\n\tclusterLightData.shape = lightInfo.y;\n\tclusterLightData.falloffMode = lightInfo.z;\n\tclusterLightData.shadowIntensity = lightInfo.w;\n\tvec4 colorA = sampleLightsTexture8(clusterLightData, CLUSTER_TEXTURE_8_COLOR_A);\n\tvec4 colorB = sampleLightsTexture8(clusterLightData, CLUSTER_TEXTURE_8_COLOR_B);\n\tclusterLightData.color = vec3(bytes2float2(colorA.xy), bytes2float2(colorA.zw), bytes2float2(colorB.xy)) * clusterCompressionLimit0.y;\n\tclusterLightData.cookie = colorB.z;\n\tclusterLightData.mask = colorB.w;\n\tvec4 lightPosRange = sampleLightTextureF(clusterLightData, CLUSTER_TEXTURE_F_POSITION_RANGE);\n\tclusterLightData.position = lightPosRange.xyz;\n\tclusterLightData.range = lightPosRange.w;\n\tvec4 lightDir_Unused = sampleLightTextureF(clusterLightData, CLUSTER_TEXTURE_F_SPOT_DIRECTION);\n\tclusterLightData.direction = lightDir_Unused.xyz;\n}\nvoid decodeClusterLightSpot(inout ClusterLightData clusterLightData) {\n\tvec4 coneAngle = sampleLightsTexture8(clusterLightData, CLUSTER_TEXTURE_8_SPOT_ANGLES);\n\tclusterLightData.innerConeAngleCos = bytes2float2(coneAngle.xy) * 2.0 - 1.0;\n\tclusterLightData.outerConeAngleCos = bytes2float2(coneAngle.zw) * 2.0 - 1.0;\n}\nvoid decodeClusterLightOmniAtlasViewport(inout ClusterLightData clusterLightData) {\n\tclusterLightData.omniAtlasViewport = sampleLightTextureF(clusterLightData, CLUSTER_TEXTURE_F_PROJ_MAT_0).xyz;\n}\nvoid decodeClusterLightAreaData(inout ClusterLightData clusterLightData) {\n\tclusterLightData.halfWidth = sampleLightTextureF(clusterLightData, CLUSTER_TEXTURE_F_AREA_DATA_WIDTH).xyz;\n\tclusterLightData.halfHeight = sampleLightTextureF(clusterLightData, CLUSTER_TEXTURE_F_AREA_DATA_HEIGHT).xyz;\n}\nvoid decodeClusterLightProjectionMatrixData(inout ClusterLightData clusterLightData) {\n\t\n\tvec4 m0 = sampleLightTextureF(clusterLightData, CLUSTER_TEXTURE_F_PROJ_MAT_0);\n\tvec4 m1 = sampleLightTextureF(clusterLightData, CLUSTER_TEXTURE_F_PROJ_MAT_1);\n\tvec4 m2 = sampleLightTextureF(clusterLightData, CLUSTER_TEXTURE_F_PROJ_MAT_2);\n\tvec4 m3 = sampleLightTextureF(clusterLightData, CLUSTER_TEXTURE_F_PROJ_MAT_3);\n\tlightProjectionMatrix = mat4(m0, m1, m2, m3);\n}\nvoid decodeClusterLightShadowData(inout ClusterLightData clusterLightData) {\n\t\n\tvec4 biases = sampleLightsTexture8(clusterLightData, CLUSTER_TEXTURE_8_SHADOW_BIAS);\n\tclusterLightData.shadowBias = bytes2floatRange2(biases.xy, -1.0, 20.0),\n\tclusterLightData.shadowNormalBias = bytes2float2(biases.zw);\n}\nvoid decodeClusterLightCookieData(inout ClusterLightData clusterLightData) {\n\tvec4 cookieA = sampleLightsTexture8(clusterLightData, CLUSTER_TEXTURE_8_COOKIE_A);\n\tclusterLightData.cookieIntensity = cookieA.x;\n\tclusterLightData.cookieRgb = cookieA.y;\n\tclusterLightData.cookieChannelMask = sampleLightsTexture8(clusterLightData, CLUSTER_TEXTURE_8_COOKIE_B);\n}\nvoid evaluateLight(\n\tClusterLightData light, \n\tvec3 worldNormal, \n\tvec3 viewDir, \n\tvec3 reflectionDir,\n#if defined(LIT_CLEARCOAT)\n\tvec3 clearcoatReflectionDir,\n#endif\n\tfloat gloss, \n\tvec3 specularity, \n\tvec3 geometricNormal, \n\tmat3 tbn, \n#if defined(LIT_IRIDESCENCE)\n\tvec3 iridescenceFresnel,\n#endif\n\tvec3 clearcoat_worldNormal,\n\tfloat clearcoat_gloss,\n\tfloat sheen_gloss,\n\tfloat iridescence_intensity\n) {\n\tvec3 cookieAttenuation = vec3(1.0);\n\tfloat diffuseAttenuation = 1.0;\n\tfloat falloffAttenuation = 1.0;\n\tgetLightDirPoint(light.position);\n\t#ifdef CLUSTER_AREALIGHTS\n\tif (isClusteredLightArea(light)) {\n\t\tdecodeClusterLightAreaData(light);\n\t\tif (isClusteredLightRect(light)) {\n\t\t\tcalcRectLightValues(light.position, light.halfWidth, light.halfHeight);\n\t\t} else if (isClusteredLightDisk(light)) {\n\t\t\tcalcDiskLightValues(light.position, light.halfWidth, light.halfHeight);\n\t\t} else {\n\t\t\tcalcSphereLightValues(light.position, light.halfWidth, light.halfHeight);\n\t\t}\n\t\tfalloffAttenuation = getFalloffWindow(light.range, dLightDirW);\n\t} else\n\t#endif\n\t{\n\t\tif (isClusteredLightFalloffLinear(light))\n\t\t\tfalloffAttenuation = getFalloffLinear(light.range, dLightDirW);\n\t\telse\n\t\t\tfalloffAttenuation = getFalloffInvSquared(light.range, dLightDirW);\n\t}\n\tif (falloffAttenuation > 0.00001) {\n\t\t#ifdef CLUSTER_AREALIGHTS\n\t\tif (isClusteredLightArea(light)) {\n\t\t\tif (isClusteredLightRect(light)) {\n\t\t\t\tdiffuseAttenuation = getRectLightDiffuse(worldNormal, viewDir, dLightDirW, dLightDirNormW) * 16.0;\n\t\t\t} else if (isClusteredLightDisk(light)) {\n\t\t\t\tdiffuseAttenuation = getDiskLightDiffuse(worldNormal, viewDir, dLightDirW, dLightDirNormW) * 16.0;\n\t\t\t} else {\n\t\t\t\tdiffuseAttenuation = getSphereLightDiffuse(worldNormal, viewDir, dLightDirW, dLightDirNormW) * 16.0;\n\t\t\t}\n\t\t} else\n\t\t#endif\n\t\t{\n\t\t\tfalloffAttenuation *= getLightDiffuse(worldNormal, viewDir, dLightDirW, dLightDirNormW); \n\t\t}\n\t\tif (isClusteredLightSpot(light)) {\n\t\t\tdecodeClusterLightSpot(light);\n\t\t\tfalloffAttenuation *= getSpotEffect(light.direction, light.innerConeAngleCos, light.outerConeAngleCos, dLightDirNormW);\n\t\t}\n\t\t#if defined(CLUSTER_COOKIES_OR_SHADOWS)\n\t\tif (falloffAttenuation > 0.00001) {\n\t\t\tif (isClusteredLightCastShadow(light) || isClusteredLightCookie(light)) {\n\t\t\t\tif (isClusteredLightSpot(light)) {\n\t\t\t\t\tdecodeClusterLightProjectionMatrixData(light);\n\t\t\t\t} else {\n\t\t\t\t\tdecodeClusterLightOmniAtlasViewport(light);\n\t\t\t\t}\n\t\t\t\tfloat shadowTextureResolution = shadowAtlasParams.x;\n\t\t\t\tfloat shadowEdgePixels = shadowAtlasParams.y;\n\t\t\t\t#ifdef CLUSTER_COOKIES\n\t\t\t\tif (isClusteredLightCookie(light)) {\n\t\t\t\t\tdecodeClusterLightCookieData(light);\n\t\t\t\t\tif (isClusteredLightSpot(light)) {\n\t\t\t\t\t\tcookieAttenuation = getCookie2DClustered(TEXTURE_PASS(cookieAtlasTexture), lightProjectionMatrix, vPositionW, light.cookieIntensity, isClusteredLightCookieRgb(light), light.cookieChannelMask);\n\t\t\t\t\t} else {\n\t\t\t\t\t\tcookieAttenuation = getCookieCubeClustered(TEXTURE_PASS(cookieAtlasTexture), dLightDirW, light.cookieIntensity, isClusteredLightCookieRgb(light), light.cookieChannelMask, shadowTextureResolution, shadowEdgePixels, light.omniAtlasViewport);\n\t\t\t\t\t}\n\t\t\t\t}\n\t\t\t\t#endif\n\t\t\t\t#ifdef CLUSTER_SHADOWS\n\t\t\t\tif (isClusteredLightCastShadow(light)) {\n\t\t\t\t\tdecodeClusterLightShadowData(light);\n\t\t\t\t\tvec4 shadowParams = vec4(shadowTextureResolution, light.shadowNormalBias, light.shadowBias, 1.0 / light.range);\n\t\t\t\t\tif (isClusteredLightSpot(light)) {\n\t\t\t\t\t\tgetShadowCoordPerspZbufferNormalOffset(lightProjectionMatrix, shadowParams, geometricNormal);\n\t\t\t\t\t\t\n\t\t\t\t\t\t#if defined(CLUSTER_SHADOW_TYPE_PCF1)\n\t\t\t\t\t\t\tfloat shadow = getShadowSpotClusteredPCF1(SHADOWMAP_PASS(shadowAtlasTexture), dShadowCoord, shadowParams);\n\t\t\t\t\t\t#elif defined(CLUSTER_SHADOW_TYPE_PCF3)\n\t\t\t\t\t\t\tfloat shadow = getShadowSpotClusteredPCF3(SHADOWMAP_PASS(shadowAtlasTexture), dShadowCoord, shadowParams);\n\t\t\t\t\t\t#elif defined(CLUSTER_SHADOW_TYPE_PCF5)\n\t\t\t\t\t\t\tfloat shadow = getShadowSpotClusteredPCF5(SHADOWMAP_PASS(shadowAtlasTexture), dShadowCoord, shadowParams);\n\t\t\t\t\t\t#elif defined(CLUSTER_SHADOW_TYPE_PCSS)\n\t\t\t\t\t\t\tfloat shadow = getShadowSpotClusteredPCSS(SHADOWMAP_PASS(shadowAtlasTexture), dShadowCoord, shadowParams);\n\t\t\t\t\t\t#endif\n\t\t\t\t\t\tfalloffAttenuation *= mix(1.0, shadow, light.shadowIntensity);\n\t\t\t\t\t} else {\n\t\t\t\t\t\tvec3 dir = normalOffsetPointShadow(shadowParams, dLightPosW, dLightDirW, dLightDirNormW, geometricNormal);\n\t\t\t\t\t\t#if defined(CLUSTER_SHADOW_TYPE_PCF1)\n\t\t\t\t\t\t\tfloat shadow = getShadowOmniClusteredPCF1(SHADOWMAP_PASS(shadowAtlasTexture), shadowParams, light.omniAtlasViewport, shadowEdgePixels, dir);\n\t\t\t\t\t\t#elif defined(CLUSTER_SHADOW_TYPE_PCF3)\n\t\t\t\t\t\t\tfloat shadow = getShadowOmniClusteredPCF3(SHADOWMAP_PASS(shadowAtlasTexture), shadowParams, light.omniAtlasViewport, shadowEdgePixels, dir);\n\t\t\t\t\t\t#elif defined(CLUSTER_SHADOW_TYPE_PCF5)\n\t\t\t\t\t\t\tfloat shadow = getShadowOmniClusteredPCF5(SHADOWMAP_PASS(shadowAtlasTexture), shadowParams, light.omniAtlasViewport, shadowEdgePixels, dir);\n\t\t\t\t\t\t#endif\n\t\t\t\t\t\tfalloffAttenuation *= mix(1.0, shadow, light.shadowIntensity);\n\t\t\t\t\t}\n\t\t\t\t}\n\t\t\t\t#endif\n\t\t\t}\n\t\t}\n\t\t#endif\n\t\t#ifdef CLUSTER_AREALIGHTS\n\t\tif (isClusteredLightArea(light)) {\n\t\t\t{\n\t\t\t\tvec3 areaDiffuse = (diffuseAttenuation * falloffAttenuation) * light.color * cookieAttenuation;\n\t\t\t\t#if defined(LIT_SPECULAR)\n\t\t\t\t\tareaDiffuse = mix(areaDiffuse, vec3(0), dLTCSpecFres);\n\t\t\t\t#endif\n\t\t\t\tdDiffuseLight += areaDiffuse;\n\t\t\t}\n\t\t\t#ifdef LIT_SPECULAR\n\t\t\t\tfloat areaLightSpecular;\n\t\t\t\tif (isClusteredLightRect(light)) {\n\t\t\t\t\tareaLightSpecular = getRectLightSpecular(worldNormal, viewDir);\n\t\t\t\t} else if (isClusteredLightDisk(light)) {\n\t\t\t\t\tareaLightSpecular = getDiskLightSpecular(worldNormal, viewDir);\n\t\t\t\t} else {\n\t\t\t\t\tareaLightSpecular = getSphereLightSpecular(worldNormal, viewDir);\n\t\t\t\t}\n\t\t\t\tdSpecularLight += dLTCSpecFres * areaLightSpecular * falloffAttenuation * light.color * cookieAttenuation;\n\t\t\t\t#ifdef LIT_CLEARCOAT\n\t\t\t\t\tfloat areaLightSpecularCC;\n\t\t\t\t\tif (isClusteredLightRect(light)) {\n\t\t\t\t\t\tareaLightSpecularCC = getRectLightSpecular(clearcoat_worldNormal, viewDir);\n\t\t\t\t\t} else if (isClusteredLightDisk(light)) {\n\t\t\t\t\t\tareaLightSpecularCC = getDiskLightSpecular(clearcoat_worldNormal, viewDir);\n\t\t\t\t\t} else {\n\t\t\t\t\t\tareaLightSpecularCC = getSphereLightSpecular(clearcoat_worldNormal, viewDir);\n\t\t\t\t\t}\n\t\t\t\t\tccSpecularLight += ccLTCSpecFres * areaLightSpecularCC * falloffAttenuation * light.color  * cookieAttenuation;\n\t\t\t\t#endif\n\t\t\t#endif\n\t\t} else\n\t\t#endif\n\t\t{\n\t\t\t{\n\t\t\t\tvec3 punctualDiffuse = falloffAttenuation * light.color * cookieAttenuation;\n\t\t\t\t#if defined(CLUSTER_AREALIGHTS)\n\t\t\t\t#if defined(LIT_SPECULAR)\n\t\t\t\t\tpunctualDiffuse = mix(punctualDiffuse, vec3(0), specularity);\n\t\t\t\t#endif\n\t\t\t\t#endif\n\t\t\t\tdDiffuseLight += punctualDiffuse;\n\t\t\t}\n   \n\t\t\t#ifdef LIT_SPECULAR\n\t\t\t\tvec3 halfDir = normalize(-dLightDirNormW + viewDir);\n\t\t\t\t\n\t\t\t\t#ifdef LIT_SPECULAR_FRESNEL\n\t\t\t\t\tdSpecularLight += \n\t\t\t\t\t\tgetLightSpecular(halfDir, reflectionDir, worldNormal, viewDir, dLightDirNormW, gloss, tbn) * falloffAttenuation * light.color * cookieAttenuation * \n\t\t\t\t\t\tgetFresnel(\n\t\t\t\t\t\t\tdot(viewDir, halfDir), \n\t\t\t\t\t\t\tgloss, \n\t\t\t\t\t\t\tspecularity\n\t\t\t\t\t\t#if defined(LIT_IRIDESCENCE)\n\t\t\t\t\t\t\t, iridescenceFresnel,\n\t\t\t\t\t\t\tiridescence_intensity\n\t\t\t\t\t\t#endif\n\t\t\t\t\t\t\t);\n\t\t\t\t#else\n\t\t\t\t\tdSpecularLight += getLightSpecular(halfDir, reflectionDir, worldNormal, viewDir, dLightDirNormW, gloss, tbn) * falloffAttenuation * light.color * cookieAttenuation * specularity;\n\t\t\t\t#endif\n\t\t\t\t#ifdef LIT_CLEARCOAT\n\t\t\t\t\t#ifdef LIT_SPECULAR_FRESNEL\n\t\t\t\t\t\tccSpecularLight += getLightSpecular(halfDir, clearcoatReflectionDir, clearcoat_worldNormal, viewDir, dLightDirNormW, clearcoat_gloss, tbn) * falloffAttenuation * light.color * cookieAttenuation * getFresnelCC(dot(viewDir, halfDir));\n\t\t\t\t\t#else\n\t\t\t\t\t\tccSpecularLight += getLightSpecular(halfDir, clearcoatReflectionDir, clearcoat_worldNormal, viewDir, dLightDirNormW, clearcoat_gloss, tbn) * falloffAttenuation * light.color * cookieAttenuation; \n\t\t\t\t\t#endif\n\t\t\t\t#endif\n\t\t\t\t#ifdef LIT_SHEEN\n\t\t\t\t\tsSpecularLight += getLightSpecularSheen(halfDir, worldNormal, viewDir, dLightDirNormW, sheen_gloss) * falloffAttenuation * light.color * cookieAttenuation;\n\t\t\t\t#endif\n\t\t\t#endif\n\t\t}\n\t}\n\tdAtten = falloffAttenuation;\n\tdAttenD = diffuseAttenuation;\n\tdAtten3 = cookieAttenuation;\n}\nvoid evaluateClusterLight(\n\tfloat lightIndex, \n\tvec3 worldNormal, \n\tvec3 viewDir, \n\tvec3 reflectionDir, \n#if defined(LIT_CLEARCOAT)\n\tvec3 clearcoatReflectionDir,\n#endif\n\tfloat gloss, \n\tvec3 specularity, \n\tvec3 geometricNormal, \n\tmat3 tbn, \n#if defined(LIT_IRIDESCENCE)\n\tvec3 iridescenceFresnel,\n#endif\n\tvec3 clearcoat_worldNormal,\n\tfloat clearcoat_gloss,\n\tfloat sheen_gloss,\n\tfloat iridescence_intensity\n) {\n\tClusterLightData clusterLightData;\n\tdecodeClusterLightCore(clusterLightData, lightIndex);\n\tif (acceptLightMask(clusterLightData))\n\t\tevaluateLight(\n\t\t\tclusterLightData, \n\t\t\tworldNormal, \n\t\t\tviewDir, \n\t\t\treflectionDir, \n#if defined(LIT_CLEARCOAT)\n\t\t\tclearcoatReflectionDir, \n#endif\n\t\t\tgloss, \n\t\t\tspecularity, \n\t\t\tgeometricNormal, \n\t\t\ttbn, \n#if defined(LIT_IRIDESCENCE)\n\t\t\tiridescenceFresnel,\n#endif\n\t\t\tclearcoat_worldNormal,\n\t\t\tclearcoat_gloss,\n\t\t\tsheen_gloss,\n\t\t\tiridescence_intensity\n\t\t);\n}\nvoid addClusteredLights(\n\tvec3 worldNormal, \n\tvec3 viewDir, \n\tvec3 reflectionDir, \n#if defined(LIT_CLEARCOAT)\n\tvec3 clearcoatReflectionDir,\n#endif\n\tfloat gloss, \n\tvec3 specularity, \n\tvec3 geometricNormal, \n\tmat3 tbn, \n#if defined(LIT_IRIDESCENCE)\n\tvec3 iridescenceFresnel,\n#endif\n\tvec3 clearcoat_worldNormal,\n\tfloat clearcoat_gloss,\n\tfloat sheen_gloss,\n\tfloat iridescence_intensity\n) {\n\tif (clusterSkip > 0.5)\n\t\treturn;\n\tvec3 cellCoords = floor((vPositionW - clusterBoundsMin) * clusterCellsCountByBoundsSize);\n\tif (!(any(lessThan(cellCoords, vec3(0.0))) || any(greaterThanEqual(cellCoords, clusterCellsMax)))) {\n\t\tfloat cellIndex = dot(clusterCellsDot, cellCoords);\n\t\tfloat clusterV = floor(cellIndex * clusterTextureSize.y);\n\t\tfloat clusterU = cellIndex - (clusterV * clusterTextureSize.x);\n\t\tfor (int lightCellIndex = 0; lightCellIndex < clusterMaxCells; lightCellIndex++) {\n\t\t\tfloat lightIndex = texelFetch(clusterWorldTexture, ivec2(int(clusterU) + lightCellIndex, clusterV), 0).x;\n\t\t\tif (lightIndex <= 0.0)\n\t\t\t\t\treturn;\n\t\t\tevaluateClusterLight(\n\t\t\t\tlightIndex * 255.0, \n\t\t\t\tworldNormal, \n\t\t\t\tviewDir, \n\t\t\t\treflectionDir,\n#if defined(LIT_CLEARCOAT)\n\t\t\t\tclearcoatReflectionDir,\n#endif\n\t\t\t\tgloss, \n\t\t\t\tspecularity, \n\t\t\t\tgeometricNormal, \n\t\t\t\ttbn, \n#if defined(LIT_IRIDESCENCE)\n\t\t\t\tiridescenceFresnel,\n#endif\n\t\t\t\tclearcoat_worldNormal,\n\t\t\t\tclearcoat_gloss,\n\t\t\t\tsheen_gloss,\n\t\t\t\tiridescence_intensity\n\t\t\t); \n\t\t}\n\t}\n}\n",combinePS:"\nvec3 combineColor(vec3 albedo, vec3 sheenSpecularity, float clearcoatSpecularity) {\n\tvec3 ret = vec3(0);\n#ifdef LIT_OLD_AMBIENT\n\tret += (dDiffuseLight - light_globalAmbient) * albedo + material_ambient * light_globalAmbient;\n#else\n\tret += albedo * dDiffuseLight;\n#endif\n#ifdef LIT_SPECULAR\n\tret += dSpecularLight;\n#endif\n#ifdef LIT_REFLECTIONS\n\tret += dReflection.rgb * dReflection.a;\n#endif\n#ifdef LIT_SHEEN\n\tfloat sheenScaling = 1.0 - max(max(sheenSpecularity.r, sheenSpecularity.g), sheenSpecularity.b) * 0.157;\n\tret = ret * sheenScaling + (sSpecularLight + sReflection.rgb) * sheenSpecularity;\n#endif\n#ifdef LIT_CLEARCOAT\n\tfloat clearCoatScaling = 1.0 - ccFresnel * clearcoatSpecularity;\n\tret = ret * clearCoatScaling + (ccSpecularLight + ccReflection.rgb) * clearcoatSpecularity;\n#endif\n\treturn ret;\n}\n",cookiePS:"\nvec4 getCookie2D(sampler2D tex, mat4 transform, float intensity) {\n\tvec4 projPos = transform * vec4(vPositionW, 1.0);\n\tprojPos.xy /= projPos.w;\n\treturn mix(vec4(1.0), texture2D(tex, projPos.xy), intensity);\n}\nvec4 getCookie2DClip(sampler2D tex, mat4 transform, float intensity) {\n\tvec4 projPos = transform * vec4(vPositionW, 1.0);\n\tprojPos.xy /= projPos.w;\n\tif (projPos.x < 0.0 || projPos.x > 1.0 || projPos.y < 0.0 || projPos.y > 1.0 || projPos.z < 0.0) return vec4(0.0);\n\treturn mix(vec4(1.0), texture2D(tex, projPos.xy), intensity);\n}\nvec4 getCookie2DXform(sampler2D tex, mat4 transform, float intensity, vec4 cookieMatrix, vec2 cookieOffset) {\n\tvec4 projPos = transform * vec4(vPositionW, 1.0);\n\tprojPos.xy /= projPos.w;\n\tprojPos.xy += cookieOffset;\n\tvec2 uv = mat2(cookieMatrix) * (projPos.xy-vec2(0.5)) + vec2(0.5);\n\treturn mix(vec4(1.0), texture2D(tex, uv), intensity);\n}\nvec4 getCookie2DClipXform(sampler2D tex, mat4 transform, float intensity, vec4 cookieMatrix, vec2 cookieOffset) {\n\tvec4 projPos = transform * vec4(vPositionW, 1.0);\n\tprojPos.xy /= projPos.w;\n\tprojPos.xy += cookieOffset;\n\tif (projPos.x < 0.0 || projPos.x > 1.0 || projPos.y < 0.0 || projPos.y > 1.0 || projPos.z < 0.0) return vec4(0.0);\n\tvec2 uv = mat2(cookieMatrix) * (projPos.xy-vec2(0.5)) + vec2(0.5);\n\treturn mix(vec4(1.0), texture2D(tex, uv), intensity);\n}\nvec4 getCookieCube(samplerCube tex, mat4 transform, float intensity) {\n\treturn mix(vec4(1.0), textureCube(tex, dLightDirNormW * mat3(transform)), intensity);\n}\n",cubeMapProjectBoxPS:"\nuniform vec3 envBoxMin;\nuniform vec3 envBoxMax;\nvec3 cubeMapProject(vec3 nrdir) {\n\tnrdir = cubeMapRotate(nrdir);\n\tvec3 rbmax = (envBoxMax - vPositionW) / nrdir;\n\tvec3 rbmin = (envBoxMin - vPositionW) / nrdir;\n\tvec3 rbminmax;\n\trbminmax.x = nrdir.x>0.0? rbmax.x : rbmin.x;\n\trbminmax.y = nrdir.y>0.0? rbmax.y : rbmin.y;\n\trbminmax.z = nrdir.z>0.0? rbmax.z : rbmin.z;\n\tfloat fa = min(min(rbminmax.x, rbminmax.y), rbminmax.z);\n\tvec3 posonbox = vPositionW + nrdir * fa;\n\tvec3 envBoxPos = (envBoxMin + envBoxMax) * 0.5;\n\treturn normalize(posonbox - envBoxPos);\n}\n",cubeMapProjectNonePS:"\nvec3 cubeMapProject(vec3 dir) {\n\treturn cubeMapRotate(dir);\n}\n",cubeMapRotatePS:"\n#ifdef CUBEMAP_ROTATION\nuniform mat3 cubeMapRotationMatrix;\n#endif\nvec3 cubeMapRotate(vec3 refDir) {\n#ifdef CUBEMAP_ROTATION\n\treturn refDir * cubeMapRotationMatrix;\n#else\n\treturn refDir;\n#endif\n}\n",debugOutputPS:"\n#ifdef DEBUG_ALBEDO_PASS\ngl_FragColor = vec4(gammaCorrectOutput(dAlbedo), 1.0);\n#endif\n#ifdef DEBUG_UV0_PASS\ngl_FragColor = vec4(litArgs_albedo , 1.0);\n#endif\n#ifdef DEBUG_WORLD_NORMAL_PASS\ngl_FragColor = vec4(litArgs_worldNormal * 0.5 + 0.5, 1.0);\n#endif\n#ifdef DEBUG_OPACITY_PASS\ngl_FragColor = vec4(vec3(litArgs_opacity) , 1.0);\n#endif\n#ifdef DEBUG_SPECULARITY_PASS\ngl_FragColor = vec4(litArgs_specularity, 1.0);\n#endif\n#ifdef DEBUG_GLOSS_PASS\ngl_FragColor = vec4(vec3(litArgs_gloss) , 1.0);\n#endif\n#ifdef DEBUG_METALNESS_PASS\ngl_FragColor = vec4(vec3(litArgs_metalness) , 1.0);\n#endif\n#ifdef DEBUG_AO_PASS\ngl_FragColor = vec4(vec3(litArgs_ao) , 1.0);\n#endif\n#ifdef DEBUG_EMISSION_PASS\ngl_FragColor = vec4(gammaCorrectOutput(litArgs_emission), 1.0);\n#endif\n",debugProcessFrontendPS:"\n#ifdef DEBUG_LIGHTING_PASS\nlitArgs_albedo = vec3(0.5);\n#endif\n#ifdef DEBUG_UV0_PASS\n#ifdef VARYING_VUV0\nlitArgs_albedo = vec3(vUv0, 0);\n#else\nlitArgs_albedo = vec3(0);\n#endif\n#endif\n",detailModesPS:"\nvec3 detailMode_mul(vec3 c1, vec3 c2) {\n\treturn c1 * c2;\n}\nvec3 detailMode_add(vec3 c1, vec3 c2) {\n\treturn c1 + c2;\n}\nvec3 detailMode_screen(vec3 c1, vec3 c2) {\n\treturn 1.0 - (1.0 - c1)*(1.0 - c2);\n}\nvec3 detailMode_overlay(vec3 c1, vec3 c2) {\n\treturn mix(1.0 - 2.0*(1.0 - c1)*(1.0 - c2), 2.0*c1*c2, step(c1, vec3(0.5)));\n}\nvec3 detailMode_min(vec3 c1, vec3 c2) {\n\treturn min(c1, c2);\n}\nvec3 detailMode_max(vec3 c1, vec3 c2) {\n\treturn max(c1, c2);\n}\n",diffusePS:"\nuniform vec3 material_diffuse;\nvoid getAlbedo() {\n\tdAlbedo = material_diffuse.rgb;\n#ifdef MAPTEXTURE\n\tvec3 albedoBase = $DECODE(texture2DBias($SAMPLER, $UV, textureBias)).$CH;\n\tdAlbedo *= addAlbedoDetail(albedoBase);\n#endif\n#ifdef MAPVERTEX\n\tdAlbedo *= gammaCorrectInput(saturate(vVertexColor.$VC));\n#endif\n}\n",diffuseDetailMapPS:"\nvec3 addAlbedoDetail(vec3 albedo) {\n#ifdef MAPTEXTURE\n\tvec3 albedoDetail = $DECODE(texture2DBias($SAMPLER, $UV, textureBias)).$CH;\n\treturn detailMode_$DETAILMODE(albedo, albedoDetail);\n#else\n\treturn albedo;\n#endif\n}\n",decodePS:vo,emissivePS:"\nuniform vec3 material_emissive;\nuniform float material_emissiveIntensity;\nvoid getEmission() {\n\tdEmission = material_emissive * material_emissiveIntensity;\n\t#ifdef MAPTEXTURE\n\tdEmission *= $DECODE(texture2DBias($SAMPLER, $UV, textureBias)).$CH;\n\t#endif\n\t#ifdef MAPVERTEX\n\tdEmission *= gammaCorrectInput(saturate(vVertexColor.$VC));\n\t#endif\n}\n",encodePS:_o,endPS:"\n\tgl_FragColor.rgb = combineColor(litArgs_albedo, litArgs_sheen_specularity, litArgs_clearcoat_specularity);\n\tgl_FragColor.rgb += litArgs_emission;\n\tgl_FragColor.rgb = addFog(gl_FragColor.rgb);\n\tgl_FragColor.rgb = toneMap(gl_FragColor.rgb);\n\tgl_FragColor.rgb = gammaCorrectOutput(gl_FragColor.rgb);\n",endVS:"\n",envAtlasPS:"\nconst float atlasSize = 512.0;\nconst float seamSize = 1.0 / atlasSize;\nvec2 mapUv(vec2 uv, vec4 rect) {\n\treturn vec2(mix(rect.x + seamSize, rect.x + rect.z - seamSize, uv.x),\n\t\t\t\tmix(rect.y + seamSize, rect.y + rect.w - seamSize, uv.y));\n}\nvec2 mapRoughnessUv(vec2 uv, float level) {\n\tfloat t = 1.0 / exp2(level);\n\treturn mapUv(uv, vec4(0, 1.0 - t, t, t * 0.5));\n}\nvec2 mapShinyUv(vec2 uv, float level) {\n\tfloat t = 1.0 / exp2(level);\n\treturn mapUv(uv, vec4(1.0 - t, 1.0 - t, t, t * 0.5));\n}\n",envConstPS:"\nvec3 processEnvironment(vec3 color) {\n\treturn color;\n}\n",envMultiplyPS:"\nuniform float skyboxIntensity;\nvec3 processEnvironment(vec3 color) {\n\treturn color * skyboxIntensity;\n}\n",falloffInvSquaredPS:"\nfloat getFalloffWindow(float lightRadius, vec3 lightDir) {\n\tfloat sqrDist = dot(lightDir, lightDir);\n\tfloat invRadius = 1.0 / lightRadius;\n\treturn square( saturate( 1.0 - square( sqrDist * square(invRadius) ) ) );\n}\nfloat getFalloffInvSquared(float lightRadius, vec3 lightDir) {\n\tfloat sqrDist = dot(lightDir, lightDir);\n\tfloat falloff = 1.0 / (sqrDist + 1.0);\n\tfloat invRadius = 1.0 / lightRadius;\n\tfalloff *= 16.0;\n\tfalloff *= square( saturate( 1.0 - square( sqrDist * square(invRadius) ) ) );\n\treturn falloff;\n}\n",falloffLinearPS:"\nfloat getFalloffLinear(float lightRadius, vec3 lightDir) {\n\tfloat d = length(lightDir);\n\treturn max(((lightRadius - d) / lightRadius), 0.0);\n}\n",floatUnpackingPS:"\nfloat bytes2float2(vec2 data) {\n\treturn dot(data, vec2(1.0, 1.0 / 255.0));\n}\nfloat bytes2float3(vec3 data) {\n\treturn dot(data, vec3(1.0, 1.0 / 255.0, 1.0 / 65025.0));\n}\nfloat bytes2float4(vec4 data) {\n\treturn dot(data, vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 16581375.0));\n}\nfloat bytes2floatRange2(vec2 data, float min, float max) {\n\treturn mix(min, max, bytes2float2(data));\n}\nfloat bytes2floatRange3(vec3 data, float min, float max) {\n\treturn mix(min, max, bytes2float3(data));\n}\nfloat bytes2floatRange4(vec4 data, float min, float max) {\n\treturn mix(min, max, bytes2float4(data));\n}\nfloat mantissaExponent2Float(vec4 pack)\n{\n\tfloat value = bytes2floatRange3(pack.xyz, -1.0, 1.0);\n\tfloat exponent = floor(pack.w * 255.0 - 127.0);\n\treturn value * exp2(exponent);\n}\n",floatAsUintPS:"\n#ifndef FLOAT_AS_UINT\n#define FLOAT_AS_UINT\nvec4 float2uint(float value) {\n\tuint intBits = floatBitsToUint(value);\n\treturn vec4(\n\t\tfloat((intBits >> 24u) & 0xFFu) / 255.0,\n\t\tfloat((intBits >> 16u) & 0xFFu) / 255.0,\n\t\tfloat((intBits >> 8u) & 0xFFu) / 255.0,\n\t\tfloat(intBits & 0xFFu) / 255.0\n\t);\n}\nfloat uint2float(vec4 value) {\n\tuint intBits = \n\t\t(uint(value.r * 255.0) << 24u) |\n\t\t(uint(value.g * 255.0) << 16u) |\n\t\t(uint(value.b * 255.0) << 8u) |\n\t\tuint(value.a * 255.0);\n\treturn uintBitsToFloat(intBits);\n}\n#endif\n",fogPS:"\nfloat dBlendModeFogFactor = 1.0;\n#if (FOG != NONE)\n\tuniform vec3 fog_color;\n\t#if (FOG == LINEAR)\n\t\tuniform float fog_start;\n\t\tuniform float fog_end;\n\t#else\n\t\tuniform float fog_density;\n\t#endif\n#endif\nfloat getFogFactor() {\n\tfloat depth = gl_FragCoord.z / gl_FragCoord.w;\n\tfloat fogFactor = 0.0;\n\t#if (FOG == LINEAR)\n\t\tfogFactor = (fog_end - depth) / (fog_end - fog_start);\n\t#elif (FOG == EXP)\n\t\tfogFactor = exp(-depth * fog_density);\n\t#elif (FOG == EXP2)\n\t\tfogFactor = exp(-depth * depth * fog_density * fog_density);\n\t#endif\n\treturn clamp(fogFactor, 0.0, 1.0);\n}\nvec3 addFog(vec3 color) {\n\t#if (FOG != NONE)\n\t\treturn mix(fog_color * dBlendModeFogFactor, color, getFogFactor());\n\t#endif\n\treturn color;\n}\n",fresnelSchlickPS:"\nvec3 getFresnel(\n\t\tfloat cosTheta, \n\t\tfloat gloss, \n\t\tvec3 specularity\n#if defined(LIT_IRIDESCENCE)\n\t\t, vec3 iridescenceFresnel, \n\t\tfloat iridescenceIntensity\n#endif\n\t) {\n\tfloat fresnel = pow(1.0 - max(cosTheta, 0.0), 5.0);\n\tfloat glossSq = gloss * gloss;\n\tvec3 ret = specularity + (max(vec3(glossSq), specularity) - specularity) * fresnel;\n#if defined(LIT_IRIDESCENCE)\n\treturn mix(ret, iridescenceFresnel, iridescenceIntensity);\n#else\n\treturn ret;\n#endif\t\n}\nfloat getFresnelCC(float cosTheta) {\n\tfloat fresnel = pow(1.0 - max(cosTheta, 0.0), 5.0);\n\treturn 0.04 + (1.0 - 0.04) * fresnel;\n}\n",fullscreenQuadPS:"\nvarying vec2 vUv0;\nuniform sampler2D source;\nvoid main(void) {\n\tgl_FragColor = texture2D(source, vUv0);\n}\n",fullscreenQuadVS:"\nattribute vec2 vertex_position;\nvarying vec2 vUv0;\nvoid main(void)\n{\n\tgl_Position = vec4(vertex_position, 0.5, 1.0);\n\tvUv0 = vertex_position.xy*0.5+0.5;\n}\n",gammaPS:'\n#include "decodePS"\n#if (GAMMA == SRGB)\n\tfloat gammaCorrectInput(float color) {\n\t\treturn decodeGamma(color);\n\t}\n\tvec3 gammaCorrectInput(vec3 color) {\n\t\treturn decodeGamma(color);\n\t}\n\tvec4 gammaCorrectInput(vec4 color) {\n\t\treturn vec4(decodeGamma(color.xyz), color.w);\n\t}\n\tvec3 gammaCorrectOutput(vec3 color) {\n\t\treturn pow(color + 0.0000001, vec3(1.0 / 2.2));\n\t}\n#else\n\tfloat gammaCorrectInput(float color) {\n\t\treturn color;\n\t}\n\tvec3 gammaCorrectInput(vec3 color) {\n\t\treturn color;\n\t}\n\tvec4 gammaCorrectInput(vec4 color) {\n\t\treturn color;\n\t}\n\tvec3 gammaCorrectOutput(vec3 color) {\n\t\treturn color;\n\t}\n#endif\n',gles3PS:La,gles3VS:Fa,glossPS:"\n#ifdef MAPFLOAT\nuniform float material_gloss;\n#endif\nvoid getGlossiness() {\n\tdGlossiness = 1.0;\n\t#ifdef MAPFLOAT\n\tdGlossiness *= material_gloss;\n\t#endif\n\t#ifdef MAPTEXTURE\n\tdGlossiness *= texture2DBias($SAMPLER, $UV, textureBias).$CH;\n\t#endif\n\t#ifdef MAPVERTEX\n\tdGlossiness *= saturate(vVertexColor.$VC);\n\t#endif\n\t#ifdef MAPINVERT\n\tdGlossiness = 1.0 - dGlossiness;\n\t#endif\n\tdGlossiness += 0.0000001;\n}\n",gsplatCenterVS:"\nuniform mat4 matrix_model;\nuniform mat4 matrix_view;\nuniform mat4 matrix_projection;\nbool initCenter(vec3 modelCenter, out SplatCenter center) {\n\tmat4 modelView = matrix_view * matrix_model;\n\tvec4 centerView = modelView * vec4(modelCenter, 1.0);\n\tif (centerView.z > 0.0) {\n\t\treturn false;\n\t}\n\tvec4 centerProj = matrix_projection * centerView;\n\tcenterProj.z = clamp(centerProj.z, -abs(centerProj.w), abs(centerProj.w));\n\tcenter.view = centerView.xyz / centerView.w;\n\tcenter.proj = centerProj;\n\tcenter.projMat00 = matrix_projection[0][0];\n\tcenter.modelView = modelView;\n\treturn true;\n}\n",gsplatCornerVS:"\nuniform vec2 viewport;\nuniform vec4 camera_params;\nbool initCorner(SplatSource source, SplatCenter center, out SplatCorner corner) {\n\tvec3 covA, covB;\n\treadCovariance(source, covA, covB);\n\tmat3 Vrk = mat3(\n\t\tcovA.x, covA.y, covA.z, \n\t\tcovA.y, covB.x, covB.y,\n\t\tcovA.z, covB.y, covB.z\n\t);\n\tfloat focal = viewport.x * center.projMat00;\n\tvec3 v = camera_params.w == 1.0 ? vec3(0.0, 0.0, 1.0) : center.view.xyz;\n\tfloat J1 = focal / v.z;\n\tvec2 J2 = -J1 / v.z * v.xy;\n\tmat3 J = mat3(\n\t\tJ1, 0.0, J2.x, \n\t\t0.0, J1, J2.y, \n\t\t0.0, 0.0, 0.0\n\t);\n\tmat3 W = transpose(mat3(center.modelView));\n\tmat3 T = W * J;\n\tmat3 cov = transpose(T) * Vrk * T;\n\tfloat diagonal1 = cov[0][0] + 0.3;\n\tfloat offDiagonal = cov[0][1];\n\tfloat diagonal2 = cov[1][1] + 0.3;\n\tfloat mid = 0.5 * (diagonal1 + diagonal2);\n\tfloat radius = length(vec2((diagonal1 - diagonal2) / 2.0, offDiagonal));\n\tfloat lambda1 = mid + radius;\n\tfloat lambda2 = max(mid - radius, 0.1);\n\tfloat l1 = 2.0 * min(sqrt(2.0 * lambda1), 1024.0);\n\tfloat l2 = 2.0 * min(sqrt(2.0 * lambda2), 1024.0);\n\tif (l1 < 2.0 && l2 < 2.0) {\n\t\treturn false;\n\t}\n\tif (any(greaterThan(abs(center.proj.xy) - vec2(l1, l2) / viewport * center.proj.w, center.proj.ww))) {\n\t\treturn false;\n\t}\n\tvec2 diagonalVector = normalize(vec2(offDiagonal, lambda1 - diagonal1));\n\tvec2 v1 = l1 * diagonalVector;\n\tvec2 v2 = l2 * vec2(diagonalVector.y, -diagonalVector.x);\n\tcorner.offset = (source.cornerUV.x * v1 + source.cornerUV.y * v2) / viewport * center.proj.w;\n\tcorner.uv = source.cornerUV;\n\treturn true;\n}\n",gsplatColorVS:"\nuniform mediump sampler2D splatColor;\nvec4 readColor(in SplatSource source) {\n\treturn texelFetch(splatColor, source.uv, 0);\n}\n",gsplatCommonVS:'\nstruct SplatSource {\n\tuint order;\n\tuint id;\n\tivec2 uv;\n\tvec2 cornerUV;\n};\nstruct SplatCenter {\n\tvec3 view;\n\tvec4 proj;\n\tmat4 modelView;\n\tfloat projMat00;\n};\nstruct SplatCorner {\n\tvec2 offset;\n\tvec2 uv;\n};\n#if SH_BANDS > 0\n\t#if SH_BANDS == 1\n\t\t#define SH_COEFFS 3\n\t#elif SH_BANDS == 2\n\t\t#define SH_COEFFS 8\n\t#elif SH_BANDS == 3\n\t\t#define SH_COEFFS 15\n\t#endif\n#endif\n#if GSPLAT_COMPRESSED_DATA == true\n\t#include "gsplatCompressedDataVS"\n\t#include "gsplatCompressedSHVS"\n#else\n\t#include "gsplatDataVS"\n\t#include "gsplatColorVS"\n\t#include "gsplatSHVS"\n#endif\n#include "gsplatSourceVS"\n#include "gsplatCenterVS"\n#include "gsplatCornerVS"\n#include "gsplatOutputVS"\nvoid clipCorner(inout SplatCorner corner, float alpha) {\n\tfloat clip = min(1.0, sqrt(-log(1.0 / 255.0 / alpha)) / 2.0);\n\tcorner.offset *= clip;\n\tcorner.uv *= clip;\n}\n#if SH_BANDS > 0\n#define SH_C1 0.4886025119029199f\n#if SH_BANDS > 1\n\t#define SH_C2_0 1.0925484305920792f\n\t#define SH_C2_1 -1.0925484305920792f\n\t#define SH_C2_2 0.31539156525252005f\n\t#define SH_C2_3 -1.0925484305920792f\n\t#define SH_C2_4 0.5462742152960396f\n#endif\n#if SH_BANDS > 2\n\t#define SH_C3_0 -0.5900435899266435f\n\t#define SH_C3_1 2.890611442640554f\n\t#define SH_C3_2 -0.4570457994644658f\n\t#define SH_C3_3 0.3731763325901154f\n\t#define SH_C3_4 -0.4570457994644658f\n\t#define SH_C3_5 1.445305721320277f\n\t#define SH_C3_6 -0.5900435899266435f\n#endif\nvec3 evalSH(in SplatSource source, in vec3 dir) {\n\tvec3 sh[SH_COEFFS];\n\tfloat scale;\n\treadSHData(source, sh, scale);\n\tfloat x = dir.x;\n\tfloat y = dir.y;\n\tfloat z = dir.z;\n\tvec3 result = SH_C1 * (-sh[0] * y + sh[1] * z - sh[2] * x);\n#if SH_BANDS > 1\n\tfloat xx = x * x;\n\tfloat yy = y * y;\n\tfloat zz = z * z;\n\tfloat xy = x * y;\n\tfloat yz = y * z;\n\tfloat xz = x * z;\n\tresult +=\n\t\tsh[3] * (SH_C2_0 * xy) *  +\n\t\tsh[4] * (SH_C2_1 * yz) +\n\t\tsh[5] * (SH_C2_2 * (2.0 * zz - xx - yy)) +\n\t\tsh[6] * (SH_C2_3 * xz) +\n\t\tsh[7] * (SH_C2_4 * (xx - yy));\n#endif\n#if SH_BANDS > 2\n\tresult +=\n\t\tsh[8]  * (SH_C3_0 * y * (3.0 * xx - yy)) +\n\t\tsh[9]  * (SH_C3_1 * xy * z) +\n\t\tsh[10] * (SH_C3_2 * y * (4.0 * zz - xx - yy)) +\n\t\tsh[11] * (SH_C3_3 * z * (2.0 * zz - 3.0 * xx - 3.0 * yy)) +\n\t\tsh[12] * (SH_C3_4 * x * (4.0 * zz - xx - yy)) +\n\t\tsh[13] * (SH_C3_5 * z * (xx - yy)) +\n\t\tsh[14] * (SH_C3_6 * x * (xx - 3.0 * yy));\n#endif\n\treturn result * scale;\n}\n#endif\n',gsplatCompressedDataVS:"\nuniform highp usampler2D packedTexture;\nuniform highp sampler2D chunkTexture;\nvec4 chunkDataA;\nvec4 chunkDataB;\nvec4 chunkDataC;\nvec4 chunkDataD;\nvec4 chunkDataE;\nuvec4 packedData;\nvec3 unpack111011(uint bits) {\n\treturn vec3(\n\t\tfloat(bits >> 21u) / 2047.0,\n\t\tfloat((bits >> 11u) & 0x3ffu) / 1023.0,\n\t\tfloat(bits & 0x7ffu) / 2047.0\n\t);\n}\nvec4 unpack8888(uint bits) {\n\treturn vec4(\n\t\tfloat(bits >> 24u) / 255.0,\n\t\tfloat((bits >> 16u) & 0xffu) / 255.0,\n\t\tfloat((bits >> 8u) & 0xffu) / 255.0,\n\t\tfloat(bits & 0xffu) / 255.0\n\t);\n}\nconst float norm = 1.0 / (sqrt(2.0) * 0.5);\nvec4 unpackRotation(uint bits) {\n\tfloat a = (float((bits >> 20u) & 0x3ffu) / 1023.0 - 0.5) * norm;\n\tfloat b = (float((bits >> 10u) & 0x3ffu) / 1023.0 - 0.5) * norm;\n\tfloat c = (float(bits & 0x3ffu) / 1023.0 - 0.5) * norm;\n\tfloat m = sqrt(1.0 - (a * a + b * b + c * c));\n\tuint mode = bits >> 30u;\n\tif (mode == 0u) return vec4(m, a, b, c);\n\tif (mode == 1u) return vec4(a, m, b, c);\n\tif (mode == 2u) return vec4(a, b, m, c);\n\treturn vec4(a, b, c, m);\n}\nmat3 quatToMat3(vec4 R) {\n\tfloat x = R.x;\n\tfloat y = R.y;\n\tfloat z = R.z;\n\tfloat w = R.w;\n\treturn mat3(\n\t\t1.0 - 2.0 * (z * z + w * w),\n\t\t\t  2.0 * (y * z + x * w),\n\t\t\t  2.0 * (y * w - x * z),\n\t\t\t  2.0 * (y * z - x * w),\n\t\t1.0 - 2.0 * (y * y + w * w),\n\t\t\t  2.0 * (z * w + x * y),\n\t\t\t  2.0 * (y * w + x * z),\n\t\t\t  2.0 * (z * w - x * y),\n\t\t1.0 - 2.0 * (y * y + z * z)\n\t);\n}\nvec3 readCenter(SplatSource source) {\n\tuint w = uint(textureSize(chunkTexture, 0).x) / 5u;\n\tuint chunkId = source.id / 256u;\n\tivec2 chunkUV = ivec2((chunkId % w) * 5u, chunkId / w);\n\tchunkDataA = texelFetch(chunkTexture, chunkUV, 0);\n\tchunkDataB = texelFetch(chunkTexture, chunkUV + ivec2(1, 0), 0);\n\tchunkDataC = texelFetch(chunkTexture, chunkUV + ivec2(2, 0), 0);\n\tchunkDataD = texelFetch(chunkTexture, chunkUV + ivec2(3, 0), 0);\n\tchunkDataE = texelFetch(chunkTexture, chunkUV + ivec2(4, 0), 0);\n\tpackedData = texelFetch(packedTexture, source.uv, 0);\n\treturn mix(chunkDataA.xyz, vec3(chunkDataA.w, chunkDataB.xy), unpack111011(packedData.x));\n}\nvec4 readColor(in SplatSource source) {\n\tvec4 r = unpack8888(packedData.w);\n\treturn vec4(mix(chunkDataD.xyz, vec3(chunkDataD.w, chunkDataE.xy), r.rgb), r.w);\n}\nvec4 getRotation() {\n\treturn unpackRotation(packedData.y);\n}\nvec3 getScale() {\n\treturn exp(mix(vec3(chunkDataB.zw, chunkDataC.x), chunkDataC.yzw, unpack111011(packedData.z)));\n}\nvoid readCovariance(in SplatSource source, out vec3 covA, out vec3 covB) {\n\tmat3 rot = quatToMat3(getRotation());\n\tvec3 scale = getScale();\n\tmat3 M = transpose(mat3(\n\t\tscale.x * rot[0],\n\t\tscale.y * rot[1],\n\t\tscale.z * rot[2]\n\t));\n\tcovA = vec3(dot(M[0], M[0]), dot(M[0], M[1]), dot(M[0], M[2]));\n\tcovB = vec3(dot(M[1], M[1]), dot(M[1], M[2]), dot(M[2], M[2]));\n}\n",gsplatCompressedSHVS:"\n#if SH_BANDS > 0\nuniform highp usampler2D shTexture0;\nuniform highp usampler2D shTexture1;\nuniform highp usampler2D shTexture2;\nvec4 unpack8888s(in uint bits) {\n\treturn vec4((uvec4(bits) >> uvec4(0u, 8u, 16u, 24u)) & 0xffu) * (8.0 / 255.0) - 4.0;\n}\nvoid readSHData(in SplatSource source, out vec3 sh[15], out float scale) {\n\tuvec4 shData0 = texelFetch(shTexture0, source.uv, 0);\n\tuvec4 shData1 = texelFetch(shTexture1, source.uv, 0);\n\tuvec4 shData2 = texelFetch(shTexture2, source.uv, 0);\n\tvec4 r0 = unpack8888s(shData0.x);\n\tvec4 r1 = unpack8888s(shData0.y);\n\tvec4 r2 = unpack8888s(shData0.z);\n\tvec4 r3 = unpack8888s(shData0.w);\n\tvec4 g0 = unpack8888s(shData1.x);\n\tvec4 g1 = unpack8888s(shData1.y);\n\tvec4 g2 = unpack8888s(shData1.z);\n\tvec4 g3 = unpack8888s(shData1.w);\n\tvec4 b0 = unpack8888s(shData2.x);\n\tvec4 b1 = unpack8888s(shData2.y);\n\tvec4 b2 = unpack8888s(shData2.z);\n\tvec4 b3 = unpack8888s(shData2.w);\n\tsh[0] =  vec3(r0.x, g0.x, b0.x);\n\tsh[1] =  vec3(r0.y, g0.y, b0.y);\n\tsh[2] =  vec3(r0.z, g0.z, b0.z);\n\tsh[3] =  vec3(r0.w, g0.w, b0.w);\n\tsh[4] =  vec3(r1.x, g1.x, b1.x);\n\tsh[5] =  vec3(r1.y, g1.y, b1.y);\n\tsh[6] =  vec3(r1.z, g1.z, b1.z);\n\tsh[7] =  vec3(r1.w, g1.w, b1.w);\n\tsh[8] =  vec3(r2.x, g2.x, b2.x);\n\tsh[9] =  vec3(r2.y, g2.y, b2.y);\n\tsh[10] = vec3(r2.z, g2.z, b2.z);\n\tsh[11] = vec3(r2.w, g2.w, b2.w);\n\tsh[12] = vec3(r3.x, g3.x, b3.x);\n\tsh[13] = vec3(r3.y, g3.y, b3.y);\n\tsh[14] = vec3(r3.z, g3.z, b3.z);\n\tscale = 1.0;\n}\n#endif\n",gsplatDataVS:"\nuniform highp usampler2D transformA;\nuniform highp sampler2D transformB;\nuint tAw;\nvec3 readCenter(SplatSource source) {\n\tuvec4 tA = texelFetch(transformA, source.uv, 0);\n\ttAw = tA.w;\n\treturn uintBitsToFloat(tA.xyz);\n}\nmat3 quatToMat3(vec4 R) {\n\tfloat x = R.w;\n\tfloat y = R.x;\n\tfloat z = R.y;\n\tfloat w = R.z;\n\treturn mat3(\n\t\t1.0 - 2.0 * (z * z + w * w),\n\t\t\t  2.0 * (y * z + x * w),\n\t\t\t  2.0 * (y * w - x * z),\n\t\t\t  2.0 * (y * z - x * w),\n\t\t1.0 - 2.0 * (y * y + w * w),\n\t\t\t  2.0 * (z * w + x * y),\n\t\t\t  2.0 * (y * w + x * z),\n\t\t\t  2.0 * (z * w - x * y),\n\t\t1.0 - 2.0 * (y * y + z * z)\n\t);\n}\nvec4 unpackRotation(vec3 packed) {\n\treturn vec4(packed.xyz, sqrt(1.0 - dot(packed, packed)));\n}\nvoid readCovariance(in SplatSource source, out vec3 covA, out vec3 covB) {\n\tvec4 tB = texelFetch(transformB, source.uv, 0);\n\tmat3 rot = quatToMat3(unpackRotation(vec3(unpackHalf2x16(tAw), tB.w)));\n\tvec3 scale = tB.xyz;\n\t\n\tmat3 M = transpose(mat3(\n\t\tscale.x * rot[0],\n\t\tscale.y * rot[1],\n\t\tscale.z * rot[2]\n\t));\n\tcovA = vec3(dot(M[0], M[0]), dot(M[0], M[1]), dot(M[0], M[2]));\n\tcovB = vec3(dot(M[1], M[1]), dot(M[1], M[2]), dot(M[2], M[2]));\n}\n",gsplatOutputVS:'\n#include "tonemappingPS"\n#include "decodePS"\n#include "gammaPS"\nvec3 prepareOutputFromGamma(vec3 gammaColor) {\n\t#if TONEMAP == NONE\n\t\t#if GAMMA == NONE\n\t\t\treturn decodeGamma(gammaColor);\n\t\t#else\n\t\t\treturn gammaColor;\n\t\t#endif\n\t#else\n\t\treturn gammaCorrectOutput(toneMap(decodeGamma(gammaColor)));\n\t#endif\n}\n',gsplatPS:'\n#ifndef DITHER_NONE\n\t#include "bayerPS"\n\t#include "opacityDitherPS"\n\tvarying float id;\n#endif\n#ifdef PICK_PASS\n\tuniform vec4 uColor;\n#endif\nvarying mediump vec2 gaussianUV;\nvarying mediump vec4 gaussianColor;\nvoid main(void) {\n\tmediump float A = dot(gaussianUV, gaussianUV);\n\tif (A > 1.0) {\n\t\tdiscard;\n\t}\n\tmediump float alpha = exp(-A * 4.0) * gaussianColor.a;\n\t#ifdef PICK_PASS\n\t\tif (alpha < 0.3) {\n\t\t\tdiscard;\n\t\t}\n\t\tgl_FragColor = uColor;\n\t#else\n\t\tif (alpha < 1.0 / 255.0) {\n\t\t\tdiscard;\n\t\t}\n\t\t#ifndef DITHER_NONE\n\t\t\topacityDither(alpha, id * 0.013);\n\t\t#endif\n\t\tgl_FragColor = vec4(gaussianColor.xyz * alpha, alpha);\n\t#endif\n}\n',gsplatSHVS:"\n#if SH_BANDS > 0\nvec3 unpack111011s(uint bits) {\n\treturn vec3((uvec3(bits) >> uvec3(21u, 11u, 0u)) & uvec3(0x7ffu, 0x3ffu, 0x7ffu)) / vec3(2047.0, 1023.0, 2047.0) * 2.0 - 1.0;\n}\nvoid fetchScale(in uvec4 t, out float scale, out vec3 a, out vec3 b, out vec3 c) {\n\tscale = uintBitsToFloat(t.x);\n\ta = unpack111011s(t.y);\n\tb = unpack111011s(t.z);\n\tc = unpack111011s(t.w);\n}\nvoid fetch(in uvec4 t, out vec3 a, out vec3 b, out vec3 c, out vec3 d) {\n\ta = unpack111011s(t.x);\n\tb = unpack111011s(t.y);\n\tc = unpack111011s(t.z);\n\td = unpack111011s(t.w);\n}\nvoid fetch(in uint t, out vec3 a) {\n\ta = unpack111011s(t);\n}\n#if SH_BANDS == 1\n\tuniform highp usampler2D splatSH_1to3;\n\tvoid readSHData(in SplatSource source, out vec3 sh[3], out float scale) {\n\t\tfetchScale(texelFetch(splatSH_1to3, source.uv, 0), scale, sh[0], sh[1], sh[2]);\n\t}\n#elif SH_BANDS == 2\n\tuniform highp usampler2D splatSH_1to3;\n\tuniform highp usampler2D splatSH_4to7;\n\tuniform highp usampler2D splatSH_8to11;\n\tvoid readSHData(in SplatSource source, out vec3 sh[8], out float scale) {\n\t\tfetchScale(texelFetch(splatSH_1to3, source.uv, 0), scale, sh[0], sh[1], sh[2]);\n\t\tfetch(texelFetch(splatSH_4to7, source.uv, 0), sh[3], sh[4], sh[5], sh[6]);\n\t\tfetch(texelFetch(splatSH_8to11, source.uv, 0).x, sh[7]);\n\t}\n#else\n\tuniform highp usampler2D splatSH_1to3;\n\tuniform highp usampler2D splatSH_4to7;\n\tuniform highp usampler2D splatSH_8to11;\n\tuniform highp usampler2D splatSH_12to15;\n\tvoid readSHData(in SplatSource source, out vec3 sh[15], out float scale) {\n\t\tfetchScale(texelFetch(splatSH_1to3, source.uv, 0), scale, sh[0], sh[1], sh[2]);\n\t\tfetch(texelFetch(splatSH_4to7, source.uv, 0), sh[3], sh[4], sh[5], sh[6]);\n\t\tfetch(texelFetch(splatSH_8to11, source.uv, 0), sh[7], sh[8], sh[9], sh[10]);\n\t\tfetch(texelFetch(splatSH_12to15, source.uv, 0), sh[11], sh[12], sh[13], sh[14]);\n\t}\n#endif\n#endif\n",gsplatSourceVS:"\nattribute vec3 vertex_position;\nattribute uint vertex_id_attrib;\nuniform uint numSplats;\nuniform highp usampler2D splatOrder;\nbool initSource(out SplatSource source) {\n\tuint w = uint(textureSize(splatOrder, 0).x);\n\tsource.order = vertex_id_attrib + uint(vertex_position.z);\n\tif (source.order >= numSplats) {\n\t\treturn false;\n\t}\n\tivec2 orderUV = ivec2(source.order % w, source.order / w);\n\tsource.id = texelFetch(splatOrder, orderUV, 0).r;\n\tsource.uv = ivec2(source.id % w, source.id / w);\n\tsource.cornerUV = vertex_position.xy;\n\treturn true;\n}\n",gsplatVS:'\n#include "gsplatCommonVS"\nvarying mediump vec2 gaussianUV;\nvarying mediump vec4 gaussianColor;\n#ifndef DITHER_NONE\n\tvarying float id;\n#endif\nmediump vec4 discardVec = vec4(0.0, 0.0, 2.0, 1.0);\nvoid main(void) {\n\tSplatSource source;\n\tif (!initSource(source)) {\n\t\tgl_Position = discardVec;\n\t\treturn;\n\t}\n\tvec3 modelCenter = readCenter(source);\n\tSplatCenter center;\n\tif (!initCenter(modelCenter, center)) {\n\t\tgl_Position = discardVec;\n\t\treturn;\n\t}\n\tSplatCorner corner;\n\tif (!initCorner(source, center, corner)) {\n\t\tgl_Position = discardVec;\n\t\treturn;\n\t}\n\tvec4 clr = readColor(source);\n\t#if SH_BANDS > 0\n\t\tvec3 dir = normalize(center.view * mat3(center.modelView));\n\t\tclr.xyz += evalSH(source, dir);\n\t#endif\n\tclipCorner(corner, clr.w);\n\tgl_Position = center.proj + vec4(corner.offset, 0, 0);\n\tgaussianUV = corner.uv;\n\tgaussianColor = vec4(prepareOutputFromGamma(max(clr.xyz, 0.0)), clr.w);\n\t#ifndef DITHER_NONE\n\t\tid = float(source.id);\n\t#endif\n}\n',iridescenceDiffractionPS:"\nuniform float material_iridescenceRefractionIndex;\n#ifndef PI\n#define PI 3.14159265\n#endif\nfloat iridescence_iorToFresnel(float transmittedIor, float incidentIor) {\n\treturn pow((transmittedIor - incidentIor) / (transmittedIor + incidentIor), 2.0);\n}\nvec3 iridescence_iorToFresnel(vec3 transmittedIor, float incidentIor) {\n\treturn pow((transmittedIor - vec3(incidentIor)) / (transmittedIor + vec3(incidentIor)), vec3(2.0));\n}\nvec3 iridescence_fresnelToIor(vec3 f0) {\n\tvec3 sqrtF0 = sqrt(f0);\n\treturn (vec3(1.0) + sqrtF0) / (vec3(1.0) - sqrtF0);\n}\nvec3 iridescence_sensitivity(float opd, vec3 shift) {\n\tfloat phase = 2.0 * PI * opd * 1.0e-9;\n\tconst vec3 val = vec3(5.4856e-13, 4.4201e-13, 5.2481e-13);\n\tconst vec3 pos = vec3(1.6810e+06, 1.7953e+06, 2.2084e+06);\n\tconst vec3 var = vec3(4.3278e+09, 9.3046e+09, 6.6121e+09);\n\tvec3 xyz = val * sqrt(2.0 * PI * var) * cos(pos * phase + shift) * exp(-pow(phase, 2.0) * var);\n\txyz.x += 9.7470e-14 * sqrt(2.0 * PI * 4.5282e+09) * cos(2.2399e+06 * phase + shift[0]) * exp(-4.5282e+09 * pow(phase, 2.0));\n\txyz /= vec3(1.0685e-07);\n\tconst mat3 XYZ_TO_REC709 = mat3(\n\t\t3.2404542, -0.9692660,  0.0556434,\n\t   -1.5371385,  1.8760108, -0.2040259,\n\t   -0.4985314,  0.0415560,  1.0572252\n\t);\n\treturn XYZ_TO_REC709 * xyz;\n}\nfloat iridescence_fresnel(float cosTheta, float f0) {\n\tfloat x = clamp(1.0 - cosTheta, 0.0, 1.0);\n\tfloat x2 = x * x;\n\tfloat x5 = x * x2 * x2;\n\treturn f0 + (1.0 - f0) * x5;\n} \nvec3 iridescence_fresnel(float cosTheta, vec3 f0) {\n\tfloat x = clamp(1.0 - cosTheta, 0.0, 1.0);\n\tfloat x2 = x * x;\n\tfloat x5 = x * x2 * x2; \n\treturn f0 + (vec3(1.0) - f0) * x5;\n}\nvec3 calcIridescence(float outsideIor, float cosTheta, vec3 base_f0, float iridescenceThickness) {\n\tfloat iridescenceIor = mix(outsideIor, material_iridescenceRefractionIndex, smoothstep(0.0, 0.03, iridescenceThickness));\n\tfloat sinTheta2Sq = pow(outsideIor / iridescenceIor, 2.0) * (1.0 - pow(cosTheta, 2.0));\n\tfloat cosTheta2Sq = 1.0 - sinTheta2Sq;\n\tif (cosTheta2Sq < 0.0) {\n\t\treturn vec3(1.0);\n\t}\n\tfloat cosTheta2 = sqrt(cosTheta2Sq);\n\tfloat r0 = iridescence_iorToFresnel(iridescenceIor, outsideIor);\n\tfloat r12 = iridescence_fresnel(cosTheta, r0);\n\tfloat r21 = r12;\n\tfloat t121 = 1.0 - r12;\n\tfloat phi12 = iridescenceIor < outsideIor ? PI : 0.0;\n\tfloat phi21 = PI - phi12;\n\tvec3 baseIor = iridescence_fresnelToIor(base_f0 + vec3(0.0001));\n\tvec3 r1 = iridescence_iorToFresnel(baseIor, iridescenceIor);\n\tvec3 r23 = iridescence_fresnel(cosTheta2, r1);\n\tvec3 phi23 = vec3(0.0);\n\tif (baseIor[0] < iridescenceIor) phi23[0] = PI;\n\tif (baseIor[1] < iridescenceIor) phi23[1] = PI;\n\tif (baseIor[2] < iridescenceIor) phi23[2] = PI;\n\tfloat opd = 2.0 * iridescenceIor * iridescenceThickness * cosTheta2;\n\tvec3 phi = vec3(phi21) + phi23; \n\tvec3 r123Sq = clamp(r12 * r23, 1e-5, 0.9999);\n\tvec3 r123 = sqrt(r123Sq);\n\tvec3 rs = pow(t121, 2.0) * r23 / (1.0 - r123Sq);\n\tvec3 c0 = r12 + rs;\n\tvec3 i = c0;\n\tvec3 cm = rs - t121;\n\tfor (int m = 1; m <= 2; m++) {\n\t\tcm *= r123;\n\t\tvec3 sm = 2.0 * iridescence_sensitivity(float(m) * opd, float(m) * phi);\n\t\ti += cm * sm;\n\t}\n\treturn max(i, vec3(0.0));\n}\nvec3 getIridescence(float cosTheta, vec3 specularity, float iridescenceThickness) {\n\treturn calcIridescence(1.0, cosTheta, specularity, iridescenceThickness);\n}\n",iridescencePS:"\n#ifdef MAPFLOAT\nuniform float material_iridescence;\n#endif\nvoid getIridescence() {\n\tfloat iridescence = 1.0;\n\t#ifdef MAPFLOAT\n\tiridescence *= material_iridescence;\n\t#endif\n\t#ifdef MAPTEXTURE\n\tiridescence *= texture2DBias($SAMPLER, $UV, textureBias).$CH;\n\t#endif\n\tdIridescence = iridescence; \n}\n",iridescenceThicknessPS:"\nuniform float material_iridescenceThicknessMax;\n#ifdef MAPTEXTURE\nuniform float material_iridescenceThicknessMin;\n#endif\nvoid getIridescenceThickness() {\n\t#ifdef MAPTEXTURE\n\tfloat blend = texture2DBias($SAMPLER, $UV, textureBias).$CH;\n\tfloat iridescenceThickness = mix(material_iridescenceThicknessMin, material_iridescenceThicknessMax, blend);\n\t#else\n\tfloat iridescenceThickness = material_iridescenceThicknessMax;\n\t#endif\n\tdIridescenceThickness = iridescenceThickness; \n}\n",iorPS:"\n#ifdef MAPFLOAT\nuniform float material_refractionIndex;\n#endif\nvoid getIor() {\n#ifdef MAPFLOAT\n\tdIor = material_refractionIndex;\n#else\n\tdIor = 1.0 / 1.5;\n#endif\n}\n",lightDiffuseLambertPS:"\nfloat getLightDiffuse(vec3 worldNormal, vec3 viewDir, vec3 lightDir, vec3 lightDirNorm) {\n\treturn max(dot(worldNormal, -lightDirNorm), 0.0);\n}\n",lightDirPointPS:"\nvoid getLightDirPoint(vec3 lightPosW) {\n\tdLightDirW = vPositionW - lightPosW;\n\tdLightDirNormW = normalize(dLightDirW);\n\tdLightPosW = lightPosW;\n}\n",lightmapAddPS:"\nvoid addLightMap(\n\tvec3 lightmap, \n\tvec3 dir, \n\tvec3 worldNormal, \n\tvec3 viewDir, \n\tvec3 reflectionDir, \n\tfloat gloss, \n\tvec3 specularity, \n\tvec3 vertexNormal, \n\tmat3 tbn\n#if defined(LIT_IRIDESCENCE)\n\tvec3 iridescenceFresnel, \n\tfloat iridescenceIntensity\n#endif\n) {\n\tdDiffuseLight += lightmap;\n}\n",lightmapDirAddPS:"\nvoid addLightMap(\n\tvec3 lightmap, \n\tvec3 dir, \n\tvec3 worldNormal, \n\tvec3 viewDir, \n\tvec3 reflectionDir, \n\tfloat gloss, \n\tvec3 specularity, \n\tvec3 vertexNormal, \n\tmat3 tbn\n#if defined(LIT_IRIDESCENCE)\n\tvec3 iridescenceFresnel, \n\tfloat iridescenceIntensity\n#endif\n) {\n\tif (dot(dir, dir) < 0.0001) {\n\t\tdDiffuseLight += lightmap;\n\t} else {\n\t\tfloat vlight = saturate(dot(dir, -vertexNormal));\n\t\tfloat flight = saturate(dot(dir, -worldNormal));\n\t\tfloat nlight = (flight / max(vlight, 0.01)) * 0.5;\n\t\tdDiffuseLight += lightmap * nlight * 2.0;\n\t\tvec3 halfDir = normalize(-dir + viewDir);\n\t\tvec3 specularLight = lightmap * getLightSpecular(halfDir, reflectionDir, worldNormal, viewDir, dir, gloss, tbn);\n#ifdef LIT_SPECULAR_FRESNEL\n\t\tspecularLight *= \n\t\t\tgetFresnel(dot(viewDir, halfDir), \n\t\t\tgloss, \n\t\t\tspecularity\n\t\t#if defined(LIT_IRIDESCENCE)\n\t\t\t, iridescenceFresnel,\n\t\t\tiridescenceIntensity\n\t\t#endif\n\t\t\t);\n#endif\n\t\tdSpecularLight += specularLight;\n\t}\n}\n",lightmapDirPS:"\nuniform sampler2D texture_lightMap;\nuniform sampler2D texture_dirLightMap;\nvoid getLightMap() {\n\tdLightmap = $DECODE(texture2DBias(texture_lightMap, $UV, textureBias)).$CH;\n\tvec3 dir = texture2DBias(texture_dirLightMap, $UV, textureBias).xyz * 2.0 - 1.0;\n\tfloat dirDot = dot(dir, dir);\n\tdLightmapDir = (dirDot > 0.001) ? dir / sqrt(dirDot) : vec3(0.0);\n}\n",lightmapSinglePS:"\nvoid getLightMap() {\n\tdLightmap = vec3(1.0);\n\t#ifdef MAPTEXTURE\n\tdLightmap *= $DECODE(texture2DBias($SAMPLER, $UV, textureBias)).$CH;\n\t#endif\n\t#ifdef MAPVERTEX\n\tdLightmap *= saturate(vVertexColor.$VC);\n\t#endif\n}\n",lightSpecularAnisoGGXPS:"\nfloat calcLightSpecular(float gloss, vec3 worldNormal, vec3 viewDir, vec3 h, vec3 lightDirNorm, mat3 tbn) {\n\tfloat PI = 3.141592653589793;\n\tfloat roughness = max((1.0 - gloss) * (1.0 - gloss), 0.001);\n\tfloat anisotropy = material_anisotropy * roughness;\n \n\tfloat at = max((roughness + anisotropy), roughness / 4.0);\n\tfloat ab = max((roughness - anisotropy), roughness / 4.0);\n\tfloat NoH = dot(worldNormal, h);\n\tfloat ToH = dot(tbn[0], h);\n\tfloat BoH = dot(tbn[1], h);\n\tfloat a2 = at * ab;\n\tvec3 v = vec3(ab * ToH, at * BoH, a2 * NoH);\n\tfloat v2 = dot(v, v);\n\tfloat w2 = a2 / v2;\n\tfloat D = a2 * w2 * w2 * (1.0 / PI);\n\tfloat ToV = dot(tbn[0], viewDir);\n\tfloat BoV = dot(tbn[1], viewDir);\n\tfloat ToL = dot(tbn[0], -lightDirNorm);\n\tfloat BoL = dot(tbn[1], -lightDirNorm);\n\tfloat NoV = dot(worldNormal, viewDir);\n\tfloat NoL = dot(worldNormal, -lightDirNorm);\n\tfloat lambdaV = NoL * length(vec3(at * ToV, ab * BoV, NoV));\n\tfloat lambdaL = NoV * length(vec3(at * ToL, ab * BoL, NoL));\n\tfloat G = 0.5 / (lambdaV + lambdaL);\n\treturn D * G;\n}\nfloat getLightSpecular(vec3 h, vec3 reflDir, vec3 worldNormal, vec3 viewDir, vec3 lightDirNorm, float gloss, mat3 tbn) {\n\treturn calcLightSpecular(gloss, worldNormal, viewDir, h, lightDirNorm, tbn);\n}\n",lightSpecularBlinnPS:"\nfloat calcLightSpecular(float gloss, vec3 worldNormal, vec3 h) {\n\tfloat nh = max( dot( h, worldNormal ), 0.0 );\n\tfloat specPow = exp2(gloss * 11.0);\n\tspecPow = max(specPow, 0.0001);\n\treturn pow(nh, specPow) * (specPow + 2.0) / 8.0;\n}\nfloat getLightSpecular(vec3 h, vec3 reflDir, vec3 worldNormal, vec3 viewDir, vec3 lightDirNorm, float gloss, mat3 tbn) {\n\treturn calcLightSpecular(gloss, worldNormal, h);\n}\n",lightSheenPS:"\nfloat sheenD(vec3 normal, vec3 h, float roughness) {\n\tfloat invR = 1.0 / (roughness * roughness);\n\tfloat cos2h = max(dot(normal, h), 0.0);\n\tcos2h *= cos2h;\n\tfloat sin2h = max(1.0 - cos2h, 0.0078125);\n\treturn (2.0 + invR) * pow(sin2h, invR * 0.5) / (2.0 * PI);\n}\nfloat sheenV(vec3 normal, vec3 viewDir, vec3 light) {\n\tfloat NoV = max(dot(normal, viewDir), 0.000001);\n\tfloat NoL = max(dot(normal, light), 0.000001);\n\treturn 1.0 / (4.0 * (NoL + NoV - NoL * NoV));\n}\nfloat getLightSpecularSheen(vec3 h, vec3 worldNormal, vec3 viewDir, vec3 lightDirNorm, float sheenGloss) {\n\tfloat D = sheenD(worldNormal, h, sheenGloss);\n\tfloat V = sheenV(worldNormal, viewDir, -lightDirNorm);\n\treturn D * V;\n}\n",linearizeDepthPS:"\n#ifndef LINEARIZE_DEPTH\n#define LINEARIZE_DEPTH\nfloat linearizeDepth(float z, vec4 cameraParams) {\n\tif (cameraParams.w == 0.0)\n\t\treturn (cameraParams.z * cameraParams.y) / (cameraParams.y + z * (cameraParams.z - cameraParams.y));\n\telse\n\t\treturn cameraParams.z + z * (cameraParams.y - cameraParams.z);\n}\n#ifndef CAMERAPLANES\n#define CAMERAPLANES\nuniform vec4 camera_params;\n#endif\nfloat linearizeDepth(float z) {\n\treturn linearizeDepth(z, camera_params);\n}\n#endif\n",litShaderArgsPS:"\nvec3 litArgs_albedo;\nfloat litArgs_opacity;\nvec3 litArgs_emission;\nvec3 litArgs_worldNormal;\nfloat litArgs_ao;\nvec3 litArgs_lightmap;\nvec3 litArgs_lightmapDir;\nfloat litArgs_metalness;\nvec3 litArgs_specularity;\nfloat litArgs_specularityFactor;\nfloat litArgs_gloss;\nfloat litArgs_sheen_gloss;\nvec3 litArgs_sheen_specularity;\nfloat litArgs_transmission;\nfloat litArgs_thickness;\nfloat litArgs_ior;\nfloat litArgs_dispersion;\nfloat litArgs_iridescence_intensity;\nfloat litArgs_iridescence_thickness;\nvec3 litArgs_clearcoat_worldNormal;\nfloat litArgs_clearcoat_specularity;\nfloat litArgs_clearcoat_gloss;\n",ltcPS:"\nmat3 transposeMat3( const in mat3 m ) {\n\tmat3 tmp;\n\ttmp[ 0 ] = vec3( m[ 0 ].x, m[ 1 ].x, m[ 2 ].x );\n\ttmp[ 1 ] = vec3( m[ 0 ].y, m[ 1 ].y, m[ 2 ].y );\n\ttmp[ 2 ] = vec3( m[ 0 ].z, m[ 1 ].z, m[ 2 ].z );\n\treturn tmp;\n}\nvec2 LTC_Uv( const in vec3 N, const in vec3 V, const in float roughness ) {\n\tconst float LUT_SIZE = 64.0;\n\tconst float LUT_SCALE = ( LUT_SIZE - 1.0 ) / LUT_SIZE;\n\tconst float LUT_BIAS = 0.5 / LUT_SIZE;\n\tfloat dotNV = saturate( dot( N, V ) );\n\tvec2 uv = vec2( roughness, sqrt( 1.0 - dotNV ) );\n\tuv = uv * LUT_SCALE + LUT_BIAS;\n\treturn uv;\n}\nfloat LTC_ClippedSphereFormFactor( const in vec3 f ) {\n\tfloat l = length( f );\n\treturn max( ( l * l + f.z ) / ( l + 1.0 ), 0.0 );\n}\nvec3 LTC_EdgeVectorFormFactor( const in vec3 v1, const in vec3 v2 ) {\n\tfloat x = dot( v1, v2 );\n\tfloat y = abs( x );\n\tfloat a = 0.8543985 + ( 0.4965155 + 0.0145206 * y ) * y;\n\tfloat b = 3.4175940 + ( 4.1616724 + y ) * y;\n\tfloat v = a / b;\n\tfloat theta_sintheta = ( x > 0.0 ) ? v : 0.5 * inversesqrt( max( 1.0 - x * x, 1e-7 ) ) - v;\n\treturn cross( v1, v2 ) * theta_sintheta;\n}\nstruct Coords {\n\tvec3 coord0;\n\tvec3 coord1;\n\tvec3 coord2;\n\tvec3 coord3;\n};\nfloat LTC_EvaluateRect( const in vec3 N, const in vec3 V, const in vec3 P, const in mat3 mInv, const in Coords rectCoords) {\n\tvec3 v1 = rectCoords.coord1 - rectCoords.coord0;\n\tvec3 v2 = rectCoords.coord3 - rectCoords.coord0;\n\t\n\tvec3 lightNormal = cross( v1, v2 );\n\tfloat factor = sign(-dot( lightNormal, P - rectCoords.coord0 ));\n\tvec3 T1, T2;\n\tT1 = normalize( V - N * dot( V, N ) );\n\tT2 =  factor * cross( N, T1 );\n\tmat3 mat = mInv * transposeMat3( mat3( T1, T2, N ) );\n\tvec3 coords[ 4 ];\n\tcoords[ 0 ] = mat * ( rectCoords.coord0 - P );\n\tcoords[ 1 ] = mat * ( rectCoords.coord1 - P );\n\tcoords[ 2 ] = mat * ( rectCoords.coord2 - P );\n\tcoords[ 3 ] = mat * ( rectCoords.coord3 - P );\n\tcoords[ 0 ] = normalize( coords[ 0 ] );\n\tcoords[ 1 ] = normalize( coords[ 1 ] );\n\tcoords[ 2 ] = normalize( coords[ 2 ] );\n\tcoords[ 3 ] = normalize( coords[ 3 ] );\n\tvec3 vectorFormFactor = vec3( 0.0 );\n\tvectorFormFactor += LTC_EdgeVectorFormFactor( coords[ 0 ], coords[ 1 ] );\n\tvectorFormFactor += LTC_EdgeVectorFormFactor( coords[ 1 ], coords[ 2 ] );\n\tvectorFormFactor += LTC_EdgeVectorFormFactor( coords[ 2 ], coords[ 3 ] );\n\tvectorFormFactor += LTC_EdgeVectorFormFactor( coords[ 3 ], coords[ 0 ] );\n\tfloat result = LTC_ClippedSphereFormFactor( vectorFormFactor );\n\treturn result;\n}\nCoords dLTCCoords;\nCoords getLTCLightCoords(vec3 lightPos, vec3 halfWidth, vec3 halfHeight){\n\tCoords coords;\n\tcoords.coord0 = lightPos + halfWidth - halfHeight;\n\tcoords.coord1 = lightPos - halfWidth - halfHeight;\n\tcoords.coord2 = lightPos - halfWidth + halfHeight;\n\tcoords.coord3 = lightPos + halfWidth + halfHeight;\n\treturn coords;\n}\nfloat dSphereRadius;\nCoords getSphereLightCoords(vec3 lightPos, vec3 halfWidth, vec3 halfHeight){\n\tdSphereRadius = max(length(halfWidth), length(halfHeight));\n\tvec3 f = reflect(normalize(lightPos - view_position), vNormalW);\n\tvec3 w = normalize(cross(f, halfHeight));\n\tvec3 h = normalize(cross(f, w));\n\treturn getLTCLightCoords(lightPos, w * dSphereRadius, h * dSphereRadius);\n}\nvec2 dLTCUV;\n#ifdef LIT_CLEARCOAT\nvec2 ccLTCUV;\n#endif\nvec2 getLTCLightUV(float gloss, vec3 worldNormal, vec3 viewDir)\n{\n\tfloat roughness = max((1.0 - gloss) * (1.0 - gloss), 0.001);\n\treturn LTC_Uv( worldNormal, viewDir, roughness );\n}\nvec3 dLTCSpecFres;\n#ifdef LIT_CLEARCOAT\nvec3 ccLTCSpecFres;\n#endif\nvec3 getLTCLightSpecFres(vec2 uv, vec3 specularity)\n{\n\tvec4 t2 = texture2DLod(areaLightsLutTex2, uv, 0.0);\n\treturn specularity * t2.x + ( vec3( 1.0 ) - specularity) * t2.y;\n}\nvoid calcLTCLightValues(float gloss, vec3 worldNormal, vec3 viewDir, vec3 specularity, float clearcoatGloss, vec3 clearcoatWorldNormal, float clearcoatSpecularity)\n{\n\tdLTCUV = getLTCLightUV(gloss, worldNormal, viewDir);\n\tdLTCSpecFres = getLTCLightSpecFres(dLTCUV, specularity); \n#ifdef LIT_CLEARCOAT\n\tccLTCUV = getLTCLightUV(clearcoatGloss, clearcoatWorldNormal, viewDir);\n\tccLTCSpecFres = getLTCLightSpecFres(ccLTCUV, vec3(clearcoatSpecularity));\n#endif\n}\nvoid calcRectLightValues(vec3 lightPos, vec3 halfWidth, vec3 halfHeight)\n{\n\tdLTCCoords = getLTCLightCoords(lightPos, halfWidth, halfHeight);\n}\nvoid calcDiskLightValues(vec3 lightPos, vec3 halfWidth, vec3 halfHeight)\n{\n\tcalcRectLightValues(lightPos, halfWidth, halfHeight);\n}\nvoid calcSphereLightValues(vec3 lightPos, vec3 halfWidth, vec3 halfHeight)\n{\n\tdLTCCoords = getSphereLightCoords(lightPos, halfWidth, halfHeight);\n}\nvec3 SolveCubic(vec4 Coefficient)\n{\n\tfloat pi = 3.14159;\n\tCoefficient.xyz /= Coefficient.w;\n\tCoefficient.yz /= 3.0;\n\tfloat A = Coefficient.w;\n\tfloat B = Coefficient.z;\n\tfloat C = Coefficient.y;\n\tfloat D = Coefficient.x;\n\tvec3 Delta = vec3(\n\t\t-Coefficient.z * Coefficient.z + Coefficient.y,\n\t\t-Coefficient.y * Coefficient.z + Coefficient.x,\n\t\tdot(vec2(Coefficient.z, -Coefficient.y), Coefficient.xy)\n\t);\n\tfloat Discriminant = dot(vec2(4.0 * Delta.x, -Delta.y), Delta.zy);\n\tvec3 RootsA, RootsD;\n\tvec2 xlc, xsc;\n\t{\n\t\tfloat A_a = 1.0;\n\t\tfloat C_a = Delta.x;\n\t\tfloat D_a = -2.0 * B * Delta.x + Delta.y;\n\t\tfloat Theta = atan(sqrt(Discriminant), -D_a) / 3.0;\n\t\tfloat x_1a = 2.0 * sqrt(-C_a) * cos(Theta);\n\t\tfloat x_3a = 2.0 * sqrt(-C_a) * cos(Theta + (2.0 / 3.0) * pi);\n\t\tfloat xl;\n\t\tif ((x_1a + x_3a) > 2.0 * B)\n\t\t\txl = x_1a;\n\t\telse\n\t\t\txl = x_3a;\n\t\txlc = vec2(xl - B, A);\n\t}\n\t{\n\t\tfloat A_d = D;\n\t\tfloat C_d = Delta.z;\n\t\tfloat D_d = -D * Delta.y + 2.0 * C * Delta.z;\n\t\tfloat Theta = atan(D * sqrt(Discriminant), -D_d) / 3.0;\n\t\tfloat x_1d = 2.0 * sqrt(-C_d) * cos(Theta);\n\t\tfloat x_3d = 2.0 * sqrt(-C_d) * cos(Theta + (2.0 / 3.0) * pi);\n\t\tfloat xs;\n\t\tif (x_1d + x_3d < 2.0 * C)\n\t\t\txs = x_1d;\n\t\telse\n\t\t\txs = x_3d;\n\t\txsc = vec2(-D, xs + C);\n\t}\n\tfloat E =  xlc.y * xsc.y;\n\tfloat F = -xlc.x * xsc.y - xlc.y * xsc.x;\n\tfloat G =  xlc.x * xsc.x;\n\tvec2 xmc = vec2(C * F - B * G, -B * F + C * E);\n\tvec3 Root = vec3(xsc.x / xsc.y, xmc.x / xmc.y, xlc.x / xlc.y);\n\tif (Root.x < Root.y && Root.x < Root.z)\n\t\tRoot.xyz = Root.yxz;\n\telse if (Root.z < Root.x && Root.z < Root.y)\n\t\tRoot.xyz = Root.xzy;\n\treturn Root;\n}\nfloat LTC_EvaluateDisk(vec3 N, vec3 V, vec3 P, mat3 Minv, Coords points)\n{\n\tvec3 T1, T2;\n\tT1 = normalize(V - N * dot(V, N));\n\tT2 = cross(N, T1);\n\tmat3 R = transposeMat3( mat3( T1, T2, N ) );\n\tvec3 L_[ 3 ];\n\tL_[ 0 ] = R * ( points.coord0 - P );\n\tL_[ 1 ] = R * ( points.coord1 - P );\n\tL_[ 2 ] = R * ( points.coord2 - P );\n\tvec3 Lo_i = vec3(0);\n\tvec3 C  = 0.5 * (L_[0] + L_[2]);\n\tvec3 V1 = 0.5 * (L_[1] - L_[2]);\n\tvec3 V2 = 0.5 * (L_[1] - L_[0]);\n\tC  = Minv * C;\n\tV1 = Minv * V1;\n\tV2 = Minv * V2;\n\tfloat a, b;\n\tfloat d11 = dot(V1, V1);\n\tfloat d22 = dot(V2, V2);\n\tfloat d12 = dot(V1, V2);\n\tif (abs(d12) / sqrt(d11 * d22) > 0.0001)\n\t{\n\t\tfloat tr = d11 + d22;\n\t\tfloat det = -d12 * d12 + d11 * d22;\n\t\tdet = sqrt(det);\n\t\tfloat u = 0.5 * sqrt(tr - 2.0 * det);\n\t\tfloat v = 0.5 * sqrt(tr + 2.0 * det);\n\t\tfloat e_max = (u + v) * (u + v);\n\t\tfloat e_min = (u - v) * (u - v);\n\t\tvec3 V1_, V2_;\n\t\tif (d11 > d22)\n\t\t{\n\t\t\tV1_ = d12 * V1 + (e_max - d11) * V2;\n\t\t\tV2_ = d12 * V1 + (e_min - d11) * V2;\n\t\t}\n\t\telse\n\t\t{\n\t\t\tV1_ = d12*V2 + (e_max - d22)*V1;\n\t\t\tV2_ = d12*V2 + (e_min - d22)*V1;\n\t\t}\n\t\ta = 1.0 / e_max;\n\t\tb = 1.0 / e_min;\n\t\tV1 = normalize(V1_);\n\t\tV2 = normalize(V2_);\n\t}\n\telse\n\t{\n\t\ta = 1.0 / dot(V1, V1);\n\t\tb = 1.0 / dot(V2, V2);\n\t\tV1 *= sqrt(a);\n\t\tV2 *= sqrt(b);\n\t}\n\tvec3 V3 = normalize(cross(V1, V2));\n\tif (dot(C, V3) < 0.0)\n\t\tV3 *= -1.0;\n\tfloat L  = dot(V3, C);\n\tfloat x0 = dot(V1, C) / L;\n\tfloat y0 = dot(V2, C) / L;\n\tfloat E1 = inversesqrt(a);\n\tfloat E2 = inversesqrt(b);\n\ta *= L * L;\n\tb *= L * L;\n\tfloat c0 = a * b;\n\tfloat c1 = a * b * (1.0 + x0 * x0 + y0 * y0) - a - b;\n\tfloat c2 = 1.0 - a * (1.0 + x0 * x0) - b * (1.0 + y0 * y0);\n\tfloat c3 = 1.0;\n\tvec3 roots = SolveCubic(vec4(c0, c1, c2, c3));\n\tfloat e1 = roots.x;\n\tfloat e2 = roots.y;\n\tfloat e3 = roots.z;\n\tvec3 avgDir = vec3(a * x0 / (a - e2), b * y0 / (b - e2), 1.0);\n\tmat3 rotate = mat3(V1, V2, V3);\n\tavgDir = rotate * avgDir;\n\tavgDir = normalize(avgDir);\n\tfloat L1 = sqrt(-e2 / e3);\n\tfloat L2 = sqrt(-e2 / e1);\n\tfloat formFactor = max(0.0, L1 * L2 * inversesqrt((1.0 + L1 * L1) * (1.0 + L2 * L2)));\n\t\n\tconst float LUT_SIZE = 64.0;\n\tconst float LUT_SCALE = ( LUT_SIZE - 1.0 ) / LUT_SIZE;\n\tconst float LUT_BIAS = 0.5 / LUT_SIZE;\n\tvec2 uv = vec2(avgDir.z * 0.5 + 0.5, formFactor);\n\tuv = uv*LUT_SCALE + LUT_BIAS;\n\tfloat scale = texture2DLod(areaLightsLutTex2, uv, 0.0).w;\n\treturn formFactor*scale;\n}\nfloat getRectLightDiffuse(vec3 worldNormal, vec3 viewDir, vec3 lightDir, vec3 lightDirNorm) {\n\treturn LTC_EvaluateRect( worldNormal, viewDir, vPositionW, mat3( 1.0 ), dLTCCoords );\n}\nfloat getDiskLightDiffuse(vec3 worldNormal, vec3 viewDir, vec3 lightDir, vec3 lightDirNorm) {\n\treturn LTC_EvaluateDisk( worldNormal, viewDir, vPositionW, mat3( 1.0 ), dLTCCoords );\n}\nfloat getSphereLightDiffuse(vec3 worldNormal, vec3 viewDir, vec3 lightDir, vec3 lightDirNorm) {\n\tfloat falloff = dSphereRadius / (dot(lightDir, lightDir) + dSphereRadius);\n\treturn getLightDiffuse(worldNormal, viewDir, lightDir, lightDirNorm) * falloff;\n}\nmat3 getLTCLightInvMat(vec2 uv)\n{\n\tvec4 t1 = texture2DLod(areaLightsLutTex1, uv, 0.0);\n\treturn mat3(\n\t\tvec3( t1.x, 0, t1.y ),\n\t\tvec3(\t0, 1,\t0 ),\n\t\tvec3( t1.z, 0, t1.w )\n\t);\n}\nfloat calcRectLightSpecular(vec3 worldNormal, vec3 viewDir, vec2 uv) {\n\tmat3 mInv = getLTCLightInvMat(uv);\n\treturn LTC_EvaluateRect( worldNormal, viewDir, vPositionW, mInv, dLTCCoords );\n}\nfloat getRectLightSpecular(vec3 worldNormal, vec3 viewDir) {\n\treturn calcRectLightSpecular(worldNormal, viewDir, dLTCUV);\n}\nfloat calcDiskLightSpecular(vec3 worldNormal, vec3 viewDir, vec2 uv) {\n\tmat3 mInv = getLTCLightInvMat(uv);\n\treturn LTC_EvaluateDisk( worldNormal, viewDir, vPositionW, mInv, dLTCCoords );\n}\nfloat getDiskLightSpecular(vec3 worldNormal, vec3 viewDir) {\n\treturn calcDiskLightSpecular(worldNormal, viewDir, dLTCUV);\n}\nfloat getSphereLightSpecular(vec3 worldNormal, vec3 viewDir) {\n\treturn calcDiskLightSpecular(worldNormal, viewDir, dLTCUV);\n}\n",metalnessPS:"\n#ifdef MAPFLOAT\nuniform float material_metalness;\n#endif\nvoid getMetalness() {\n\tfloat metalness = 1.0;\n\t#ifdef MAPFLOAT\n\tmetalness *= material_metalness;\n\t#endif\n\t#ifdef MAPTEXTURE\n\tmetalness *= texture2DBias($SAMPLER, $UV, textureBias).$CH;\n\t#endif\n\t#ifdef MAPVERTEX\n\tmetalness *= saturate(vVertexColor.$VC);\n\t#endif\n\tdMetalness = metalness;\n}\n",metalnessModulatePS:"\nvec3 getSpecularModulate(in vec3 specularity, in vec3 albedo, in float metalness, in float f0) {\n\tvec3 dielectricF0 = f0 * specularity;\n\treturn mix(dielectricF0, albedo, metalness);\n}\nvec3 getAlbedoModulate(in vec3 albedo, in float metalness) {\n\treturn albedo * (1.0 - metalness);\n}\n",msdfPS:"\nuniform sampler2D texture_msdfMap;\nfloat median(float r, float g, float b) {\n\treturn max(min(r, g), min(max(r, g), b));\n}\nfloat map (float min, float max, float v) {\n\treturn (v - min) / (max - min);\n}\nuniform float font_sdfIntensity;\nuniform float font_pxrange;\nuniform float font_textureWidth;\n#ifdef UNIFORM_TEXT_PARAMETERS\nuniform vec4 outline_color;\nuniform float outline_thickness;\nuniform vec4 shadow_color;\nuniform vec2 shadow_offset;\n#else\nvarying vec4 outline_color;\nvarying float outline_thickness;\nvarying vec4 shadow_color;\nvarying vec2 shadow_offset;\n#endif\nvec4 applyMsdf(vec4 color) {\n\tcolor.rgb = gammaCorrectInput(color.rgb);\n\tvec3 tsample = texture2D(texture_msdfMap, vUv0).rgb;\n\tvec2 uvShdw = vUv0 - shadow_offset;\n\tvec3 ssample = texture2D(texture_msdfMap, uvShdw).rgb;\n\tfloat sigDist = median(tsample.r, tsample.g, tsample.b);\n\tfloat sigDistShdw = median(ssample.r, ssample.g, ssample.b);\n\tfloat smoothingMax = 0.2;\n\tvec2 w = fwidth(vUv0);\n\tfloat smoothing = clamp(w.x * font_textureWidth / font_pxrange, 0.0, smoothingMax);\n\tfloat mapMin = 0.05;\n\tfloat mapMax = clamp(1.0 - font_sdfIntensity, mapMin, 1.0);\n\tfloat sigDistInner = map(mapMin, mapMax, sigDist);\n\tfloat sigDistOutline = map(mapMin, mapMax, sigDist + outline_thickness);\n\tsigDistShdw = map(mapMin, mapMax, sigDistShdw + outline_thickness);\n\tfloat center = 0.5;\n\tfloat inside = smoothstep(center-smoothing, center+smoothing, sigDistInner);\n\tfloat outline = smoothstep(center-smoothing, center+smoothing, sigDistOutline);\n\tfloat shadow = smoothstep(center-smoothing, center+smoothing, sigDistShdw);\n\tvec4 tcolor = (outline > inside) ? outline * vec4(outline_color.a * outline_color.rgb, outline_color.a) : vec4(0.0);\n\ttcolor = mix(tcolor, color, inside);\n\tvec4 scolor = (shadow > outline) ? shadow * vec4(shadow_color.a * shadow_color.rgb, shadow_color.a) : tcolor;\n\ttcolor = mix(scolor, tcolor, outline);\n\ttcolor.rgb = gammaCorrectOutput(tcolor.rgb);\n\t\n\treturn tcolor;\n}\n",msdfVS:"\nattribute vec3 vertex_outlineParameters;\nattribute vec3 vertex_shadowParameters;\nvarying vec4 outline_color;\nvarying float outline_thickness;\nvarying vec4 shadow_color;\nvarying vec2 shadow_offset;\nvoid unpackMsdfParams() {\n\tvec3 little = mod(vertex_outlineParameters, 256.);\n\tvec3 big = (vertex_outlineParameters - little) / 256.;\n\toutline_color.rb = little.xy / 255.;\n\toutline_color.ga = big.xy / 255.;\n\toutline_thickness = little.z / 255. * 0.2;\n\tlittle = mod(vertex_shadowParameters, 256.);\n\tbig = (vertex_shadowParameters - little) / 256.;\n\tshadow_color.rb = little.xy / 255.;\n\tshadow_color.ga = big.xy / 255.;\n\tshadow_offset = (vec2(little.z, big.z) / 127. - 1.) * 0.005;\n}\n",normalVS:"\nmat3 dNormalMatrix;\nvec3 getNormal() {\n\tdNormalMatrix = getNormalMatrix(dModelMatrix);\n\tvec3 localNormal = getLocalNormal(vertex_normal);\n\treturn normalize(dNormalMatrix * localNormal);\n}\n",normalCoreVS:"\nattribute vec3 vertex_normal;\n#ifdef MORPHING_NORMAL\n\t#ifdef MORPHING_INT\n\t\tuniform highp usampler2D morphNormalTex;\n\t#else\n\t\tuniform highp sampler2D morphNormalTex;\n\t#endif\n#endif\nvec3 getLocalNormal(vec3 vertexNormal) {\n\tvec3 localNormal = vertex_normal;\n\t#ifdef MORPHING_NORMAL\n\t\tivec2 morphUV = getTextureMorphCoords();\n\t\t#ifdef MORPHING_INT\n\t\t\tvec3 morphNormal = vec3(texelFetch(morphNormalTex, ivec2(morphUV), 0).xyz) / 65535.0 * 2.0 - 1.0;\n\t\t#else\n\t\t\tvec3 morphNormal = texelFetch(morphNormalTex, ivec2(morphUV), 0).xyz;\n\t\t#endif\n\t\tlocalNormal += morphNormal;\n\t#endif\n\treturn localNormal;\n}\n#ifdef SKIN\n\tmat3 getNormalMatrix(mat4 modelMatrix) {\n\t\treturn mat3(modelMatrix[0].xyz, modelMatrix[1].xyz, modelMatrix[2].xyz);\n\t}\n#elif defined(INSTANCING)\n\tmat3 getNormalMatrix(mat4 modelMatrix) {\n\t\treturn mat3(modelMatrix[0].xyz, modelMatrix[1].xyz, modelMatrix[2].xyz);\n\t}\n#else\n\tmat3 getNormalMatrix(mat4 modelMatrix) {\n\t\treturn matrix_normal;\n\t}\n#endif\n",normalDetailMapPS:"\n#ifdef MAPTEXTURE\nuniform float material_normalDetailMapBumpiness;\nvec3 blendNormals(vec3 n1, vec3 n2) {\n\tn1 += vec3(0, 0, 1);\n\tn2 *= vec3(-1, -1, 1);\n\treturn n1 * dot(n1, n2) / n1.z - n2;\n}\n#endif\nvec3 addNormalDetail(vec3 normalMap) {\n#ifdef MAPTEXTURE\n\tvec3 normalDetailMap = unpackNormal(texture2DBias($SAMPLER, $UV, textureBias));\n\tnormalDetailMap = mix(vec3(0.0, 0.0, 1.0), normalDetailMap, material_normalDetailMapBumpiness);\n\treturn blendNormals(normalMap, normalDetailMap);\n#else\n\treturn normalMap;\n#endif\n}\n",normalMapPS:"\n#ifdef MAPTEXTURE\nuniform float material_bumpiness;\n#endif\nvoid getNormal() {\n#ifdef MAPTEXTURE\n\tvec3 normalMap = unpackNormal(texture2DBias($SAMPLER, $UV, textureBias));\n\tnormalMap = mix(vec3(0.0, 0.0, 1.0), normalMap, material_bumpiness);\n\tdNormalW = normalize(dTBN * addNormalDetail(normalMap));\n#else\n\tdNormalW = dVertexNormalW;\n#endif\n}\n",normalXYPS:"\nvec3 unpackNormal(vec4 nmap) {\n\tvec3 normal;\n\tnormal.xy = nmap.wy * 2.0 - 1.0;\n\tnormal.z = sqrt(1.0 - saturate(dot(normal.xy, normal.xy)));\n\treturn normal;\n}\n",normalXYZPS:"\nvec3 unpackNormal(vec4 nmap) {\n\treturn nmap.xyz * 2.0 - 1.0;\n}\n",opacityPS:"\nuniform float material_opacity;\nvoid getOpacity() {\n\tdAlpha = material_opacity;\n\t#ifdef MAPTEXTURE\n\tdAlpha *= texture2DBias($SAMPLER, $UV, textureBias).$CH;\n\t#endif\n\t#ifdef MAPVERTEX\n\tdAlpha *= clamp(vVertexColor.$VC, 0.0, 1.0);\n\t#endif\n}\n",opacityDitherPS:"\nuniform vec4 blueNoiseJitter;\n#ifdef DITHER_BLUENOISE\n\tuniform sampler2D blueNoiseTex32;\n#endif\nvoid opacityDither(float alpha, float id) {\n\t#ifdef DITHER_BAYER8\n\t\tfloat noise = bayer8(floor(mod(gl_FragCoord.xy + blueNoiseJitter.xy + id, 8.0))) / 64.0;\n\t#else\n\t\t#ifdef DITHER_BLUENOISE\n\t\t\tvec2 uv = fract(gl_FragCoord.xy / 32.0 + blueNoiseJitter.xy + id);\n\t\t\tfloat noise = texture2DLod(blueNoiseTex32, uv, 0.0).y;\n\t\t#endif\n\t\t#ifdef DITHER_IGNNOISE\n\t\t\tvec3 magic = vec3(0.06711056, 0.00583715, 52.9829189);\n\t\t\tfloat noise = fract(magic.z * fract(dot(gl_FragCoord.xy + blueNoiseJitter.xy + id, magic.xy)));\n\t\t#endif\n\t#endif\n\tnoise = pow(noise, 2.2);\n\tif (alpha < noise)\n\t\tdiscard;\n}\n",outputPS:"\n",outputAlphaPS:"\ngl_FragColor.a = litArgs_opacity;\n",outputAlphaOpaquePS:"\n\tgl_FragColor.a = 1.0;\n",outputAlphaPremulPS:"\ngl_FragColor.rgb *= litArgs_opacity;\ngl_FragColor.a = litArgs_opacity;\n",outputTex2DPS:"\nvarying vec2 vUv0;\nuniform sampler2D source;\nvoid main(void) {\n\tgl_FragColor = texture2D(source, vUv0);\n}\n",sheenPS:"\nuniform vec3 material_sheen;\nvoid getSheen() {\n\tvec3 sheenColor = material_sheen;\n\t#ifdef MAPTEXTURE\n\tsheenColor *= $DECODE(texture2DBias($SAMPLER, $UV, textureBias)).$CH;\n\t#endif\n\t#ifdef MAPVERTEX\n\tsheenColor *= saturate(vVertexColor.$VC);\n\t#endif\n\tsSpecularity = sheenColor;\n}\n",sheenGlossPS:"\nuniform float material_sheenGloss;\nvoid getSheenGlossiness() {\n\tfloat sheenGlossiness = material_sheenGloss;\n\t#ifdef MAPTEXTURE\n\tsheenGlossiness *= texture2DBias($SAMPLER, $UV, textureBias).$CH;\n\t#endif\n\t#ifdef MAPVERTEX\n\tsheenGlossiness *= saturate(vVertexColor.$VC);\n\t#endif\n\t#ifdef MAPINVERT\n\tsheenGlossiness = 1.0 - sheenGlossiness;\n\t#endif\n\tsheenGlossiness += 0.0000001;\n\tsGlossiness = sheenGlossiness;\n}\n",parallaxPS:"\nuniform float material_heightMapFactor;\nvoid getParallax() {\n\tfloat parallaxScale = material_heightMapFactor;\n\tfloat height = texture2DBias($SAMPLER, $UV, textureBias).$CH;\n\theight = height * parallaxScale - parallaxScale*0.5;\n\tvec3 viewDirT = dViewDirW * dTBN;\n\tviewDirT.z += 0.42;\n\tdUvOffset = height * (viewDirT.xy / viewDirT.z);\n}\n",particlePS:"\nvarying vec4 texCoordsAlphaLife;\nuniform sampler2D colorMap;\nuniform sampler2D colorParam;\nuniform float graphSampleSize;\nuniform float graphNumSamples;\n#ifndef CAMERAPLANES\n#define CAMERAPLANES\nuniform vec4 camera_params;\n#endif\nuniform float softening;\nuniform float colorMult;\nfloat saturate(float x) {\n\treturn clamp(x, 0.0, 1.0);\n}\nvoid main(void) {\n\tvec4 tex  = texture2D(colorMap, vec2(texCoordsAlphaLife.x, 1.0 - texCoordsAlphaLife.y));\n\tvec4 ramp = texture2D(colorParam, vec2(texCoordsAlphaLife.w, 0.0));\n\tramp.rgb *= colorMult;\n\tramp.a += texCoordsAlphaLife.z;\n\tvec3 rgb = tex.rgb * ramp.rgb;\n\tfloat a  = tex.a * ramp.a;\n",particleVS:"\nvec3 unpack3NFloats(float src) {\n\tfloat r = fract(src);\n\tfloat g = fract(src * 256.0);\n\tfloat b = fract(src * 65536.0);\n\treturn vec3(r, g, b);\n}\nfloat saturate(float x) {\n\treturn clamp(x, 0.0, 1.0);\n}\nvec4 tex1Dlod_lerp(TEXTURE_ACCEPT_HIGHP(tex), vec2 tc) {\n\treturn mix( texture2D(tex,tc), texture2D(tex,tc + graphSampleSize), fract(tc.x*graphNumSamples) );\n}\nvec4 tex1Dlod_lerp(TEXTURE_ACCEPT_HIGHP(tex), vec2 tc, out vec3 w) {\n\tvec4 a = texture2D(tex,tc);\n\tvec4 b = texture2D(tex,tc + graphSampleSize);\n\tfloat c = fract(tc.x*graphNumSamples);\n\tvec3 unpackedA = unpack3NFloats(a.w);\n\tvec3 unpackedB = unpack3NFloats(b.w);\n\tw = mix(unpackedA, unpackedB, c);\n\treturn mix(a, b, c);\n}\nvec2 rotate(vec2 quadXY, float pRotation, out mat2 rotMatrix) {\n\tfloat c = cos(pRotation);\n\tfloat s = sin(pRotation);\n\tmat2 m = mat2(c, -s, s, c);\n\trotMatrix = m;\n\treturn m * quadXY;\n}\nvec3 billboard(vec3 InstanceCoords, vec2 quadXY) {\n\t#ifdef SCREEN_SPACE\n\t\tvec3 pos = vec3(-1, 0, 0) * quadXY.x + vec3(0, -1, 0) * quadXY.y;\n\t#else\n\t\tvec3 pos = -matrix_viewInverse[0].xyz * quadXY.x + -matrix_viewInverse[1].xyz * quadXY.y;\n\t#endif\n\treturn pos;\n}\nvec3 customFace(vec3 InstanceCoords, vec2 quadXY) {\n\tvec3 pos = faceTangent * quadXY.x + faceBinorm * quadXY.y;\n\treturn pos;\n}\nvec2 safeNormalize(vec2 v) {\n\tfloat l = length(v);\n\treturn (l > 1e-06) ? v / l : v;\n}\nvoid main(void) {\n\tvec3 meshLocalPos = particle_vertexData.xyz;\n\tfloat id = floor(particle_vertexData.w);\n\tfloat rndFactor = fract(sin(id + 1.0 + seed));\n\tvec3 rndFactor3 = vec3(rndFactor, fract(rndFactor*10.0), fract(rndFactor*100.0));\n\tfloat uv = id / numParticlesPot;\n\treadInput(uv);\n#ifdef LOCAL_SPACE\n\tinVel = mat3(matrix_model) * inVel;\n#endif\n\tvec2 velocityV = safeNormalize((mat3(matrix_view) * inVel).xy);\n\tfloat particleLifetime = lifetime;\n\tif (inLife <= 0.0 || inLife > particleLifetime || !inShow) meshLocalPos = vec3(0.0);\n\tvec2 quadXY = meshLocalPos.xy;\n\tfloat nlife = clamp(inLife / particleLifetime, 0.0, 1.0);\n\tvec3 paramDiv;\n\tvec4 params = tex1Dlod_lerp(TEXTURE_PASS(internalTex2), vec2(nlife, 0), paramDiv);\n\tfloat scale = params.y;\n\tfloat scaleDiv = paramDiv.x;\n\tfloat alphaDiv = paramDiv.z;\n\tscale += (scaleDiv * 2.0 - 1.0) * scaleDivMult * fract(rndFactor*10000.0);\n#ifndef USE_MESH\n\ttexCoordsAlphaLife = vec4(quadXY * -0.5 + 0.5, (alphaDiv * 2.0 - 1.0) * alphaDivMult * fract(rndFactor*1000.0), nlife);\n#else\n\ttexCoordsAlphaLife = vec4(particle_uv, (alphaDiv * 2.0 - 1.0) * alphaDivMult * fract(rndFactor*1000.0), nlife);\n#endif\n\tvec3 particlePos = inPos;\n\tvec3 particlePosMoved = vec3(0.0);\n\tmat2 rotMatrix;\n",particleAnimFrameClampVS:"\n\tfloat animFrame = min(floor(texCoordsAlphaLife.w * animTexParams.y) + animTexParams.x, animTexParams.z);\n",particleAnimFrameLoopVS:"\n\tfloat animFrame = floor(mod(texCoordsAlphaLife.w * animTexParams.y + animTexParams.x, animTexParams.z + 1.0));\n",particleAnimTexVS:"\n\tfloat animationIndex;\n\tif (animTexIndexParams.y == 1.0) {\n\t\tanimationIndex = floor((animTexParams.w + 1.0) * rndFactor3.z) * (animTexParams.z + 1.0);\n\t} else {\n\t\tanimationIndex = animTexIndexParams.x * (animTexParams.z + 1.0);\n\t}\n\tfloat atlasX = (animationIndex + animFrame) * animTexTilesParams.x;\n\tfloat atlasY = 1.0 - floor(atlasX + 1.0) * animTexTilesParams.y;\n\tatlasX = fract(atlasX);\n\ttexCoordsAlphaLife.xy *= animTexTilesParams.xy;\n\ttexCoordsAlphaLife.xy += vec2(atlasX, atlasY);\n",particleInputFloatPS:"\nvoid readInput(float uv) {\n\tvec4 tex = texture2D(particleTexIN, vec2(uv, 0.25));\n\tvec4 tex2 = texture2D(particleTexIN, vec2(uv, 0.75));\n\tinPos = tex.xyz;\n\tinVel = tex2.xyz;\n\tinAngle = (tex.w < 0.0? -tex.w : tex.w) - 1000.0;\n\tinShow = tex.w >= 0.0;\n\tinLife = tex2.w;\n}\n",particleInputRgba8PS:"\n#define PI2 6.283185307179586\nuniform vec3 inBoundsSize;\nuniform vec3 inBoundsCenter;\nuniform float maxVel;\nfloat decodeFloatRG(vec2 rg) {\n\treturn rg.y*(1.0/255.0) + rg.x;\n}\nfloat decodeFloatRGBA( vec4 rgba ) {\n  return dot( rgba, vec4(1.0, 1.0/255.0, 1.0/65025.0, 1.0/160581375.0) );\n}\nvoid readInput(float uv) {\n\tvec4 tex0 = texture2D(particleTexIN, vec2(uv, 0.125));\n\tvec4 tex1 = texture2D(particleTexIN, vec2(uv, 0.375));\n\tvec4 tex2 = texture2D(particleTexIN, vec2(uv, 0.625));\n\tvec4 tex3 = texture2D(particleTexIN, vec2(uv, 0.875));\n\tinPos = vec3(decodeFloatRG(tex0.rg), decodeFloatRG(tex0.ba), decodeFloatRG(tex1.rg));\n\tinPos = (inPos - vec3(0.5)) * inBoundsSize + inBoundsCenter;\n\tinVel = tex2.xyz;\n\tinVel = (inVel - vec3(0.5)) * maxVel;\n\tinAngle = decodeFloatRG(tex1.ba) * PI2;\n\tinShow = tex2.a > 0.5;\n\tinLife = decodeFloatRGBA(tex3);\n\tfloat maxNegLife = max(lifetime, (numParticles - 1.0) * (rate+rateDiv));\n\tfloat maxPosLife = lifetime+1.0;\n\tinLife = inLife * (maxNegLife + maxPosLife) - maxNegLife;\n}\n",particleOutputFloatPS:"\nvoid writeOutput() {\n\tif (gl_FragCoord.y<1.0) {\n\t\tgl_FragColor = vec4(outPos, (outAngle + 1000.0) * visMode);\n\t} else {\n\t\tgl_FragColor = vec4(outVel, outLife);\n\t}\n}\n",particleOutputRgba8PS:"\nuniform vec3 outBoundsMul;\nuniform vec3 outBoundsAdd;\nvec2 encodeFloatRG( float v ) {\n\tvec2 enc = vec2(1.0, 255.0) * v;\n\tenc = fract(enc);\n\tenc -= enc.yy * vec2(1.0/255.0, 1.0/255.0);\n\treturn enc;\n}\nvec4 encodeFloatRGBA( float v ) {\n\tvec4 enc = vec4(1.0, 255.0, 65025.0, 160581375.0) * v;\n\tenc = fract(enc);\n\tenc -= enc.yzww * vec4(1.0/255.0,1.0/255.0,1.0/255.0,0.0);\n\treturn enc;\n}\nvoid writeOutput() {\n\toutPos = outPos * outBoundsMul + outBoundsAdd;\n\toutAngle = fract(outAngle / PI2);\n\toutVel = (outVel / maxVel) + vec3(0.5);\n\tfloat maxNegLife = max(lifetime, (numParticles - 1.0) * (rate+rateDiv));\n\tfloat maxPosLife = lifetime+1.0;\n\toutLife = (outLife + maxNegLife) / (maxNegLife + maxPosLife);\n\tif (gl_FragCoord.y < 1.0) {\n\t\tgl_FragColor = vec4(encodeFloatRG(outPos.x), encodeFloatRG(outPos.y));\n\t} else if (gl_FragCoord.y < 2.0) {\n\t\tgl_FragColor = vec4(encodeFloatRG(outPos.z), encodeFloatRG(outAngle));\n\t} else if (gl_FragCoord.y < 3.0) {\n\t\tgl_FragColor = vec4(outVel, visMode*0.5+0.5);\n\t} else {\n\t\tgl_FragColor = encodeFloatRGBA(outLife);\n\t}\n}\n",particleUpdaterAABBPS:"\nuniform mat3 spawnBounds;\nuniform vec3 spawnPosInnerRatio;\nvec3 calcSpawnPosition(vec3 inBounds, float rndFactor) {\n\tvec3 pos = inBounds - vec3(0.5);\n\tvec3 posAbs = abs(pos);\n\tvec3 maxPos = vec3(max(posAbs.x, max(posAbs.y, posAbs.z)));\n\tvec3 edge = maxPos + (vec3(0.5) - maxPos) * spawnPosInnerRatio;\n\tpos.x = edge.x * (maxPos.x == posAbs.x ? sign(pos.x) : 2.0 * pos.x);\n\tpos.y = edge.y * (maxPos.y == posAbs.y ? sign(pos.y) : 2.0 * pos.y);\n\tpos.z = edge.z * (maxPos.z == posAbs.z ? sign(pos.z) : 2.0 * pos.z);\n#ifndef LOCAL_SPACE\n\treturn emitterPos + spawnBounds * pos;\n#else\n\treturn spawnBounds * pos;\n#endif\n}\nvoid addInitialVelocity(inout vec3 localVelocity, vec3 inBounds) {\n\tlocalVelocity -= vec3(0, 0, initialVelocity);\n}\n",particleUpdaterEndPS:"\n\twriteOutput();\n}\n",particleUpdaterInitPS:"\nvarying vec2 vUv0;\nuniform highp sampler2D particleTexIN;\nuniform highp sampler2D internalTex0;\nuniform highp sampler2D internalTex1;\nuniform highp sampler2D internalTex2;\nuniform highp sampler2D internalTex3;\nuniform mat3 emitterMatrix;\nuniform mat3 emitterMatrixInv;\nuniform vec3 emitterScale;\nuniform vec3 emitterPos;\nuniform vec3 frameRandom;\nuniform vec3 localVelocityDivMult;\nuniform vec3 velocityDivMult;\nuniform float delta;\nuniform float rate;\nuniform float rateDiv;\nuniform float lifetime;\nuniform float numParticles;\nuniform float rotSpeedDivMult;\nuniform float radialSpeedDivMult;\nuniform float seed;\nuniform float startAngle;\nuniform float startAngle2;\nuniform float initialVelocity;\nuniform float graphSampleSize;\nuniform float graphNumSamples;\nvec3 inPos;\nvec3 inVel;\nfloat inAngle;\nbool inShow;\nfloat inLife;\nfloat visMode;\nvec3 outPos;\nvec3 outVel;\nfloat outAngle;\nbool outShow;\nfloat outLife;\n",particleUpdaterNoRespawnPS:"\n\tif (outLife >= lifetime) {\n\t\toutLife -= max(lifetime, (numParticles - 1.0) * particleRate);\n\t\tvisMode = -1.0;\n\t}\n",particleUpdaterOnStopPS:"\n\tvisMode = outLife < 0.0? -1.0: visMode;\n",particleUpdaterRespawnPS:"\n\tif (outLife >= lifetime) {\n\t\toutLife -= max(lifetime, (numParticles - 1.0) * particleRate);\n\t\tvisMode = 1.0;\n\t}\n\tvisMode = outLife < 0.0? 1.0: visMode;\n",particleUpdaterSpherePS:"\nuniform float spawnBoundsSphere;\nuniform float spawnBoundsSphereInnerRatio;\nvec3 calcSpawnPosition(vec3 inBounds, float rndFactor) {\n\tfloat rnd4 = fract(rndFactor * 1000.0);\n\tvec3 norm = normalize(inBounds.xyz - vec3(0.5));\n\tfloat r = rnd4 * (1.0 - spawnBoundsSphereInnerRatio) + spawnBoundsSphereInnerRatio;\n#ifndef LOCAL_SPACE\n\treturn emitterPos + norm * r * spawnBoundsSphere;\n#else\n\treturn norm * r * spawnBoundsSphere;\n#endif\n}\nvoid addInitialVelocity(inout vec3 localVelocity, vec3 inBounds) {\n\tlocalVelocity += normalize(inBounds - vec3(0.5)) * initialVelocity;\n}\n",particleUpdaterStartPS:"\nfloat saturate(float x) {\n\treturn clamp(x, 0.0, 1.0);\n}\nvec3 unpack3NFloats(float src) {\n\tfloat r = fract(src);\n\tfloat g = fract(src * 256.0);\n\tfloat b = fract(src * 65536.0);\n\treturn vec3(r, g, b);\n}\nvec3 tex1Dlod_lerp(TEXTURE_ACCEPT_HIGHP(tex), vec2 tc, out vec3 w) {\n\tvec4 a = texture2D(tex, tc);\n\tvec4 b = texture2D(tex, tc + graphSampleSize);\n\tfloat c = fract(tc.x * graphNumSamples);\n\tvec3 unpackedA = unpack3NFloats(a.w);\n\tvec3 unpackedB = unpack3NFloats(b.w);\n\tw = mix(unpackedA, unpackedB, c);\n\treturn mix(a.xyz, b.xyz, c);\n}\n#define HASHSCALE4 vec4(1031, .1030, .0973, .1099)\nvec4 hash41(float p) {\n\tvec4 p4 = fract(vec4(p) * HASHSCALE4);\n\tp4 += dot(p4, p4.wzxy+19.19);\n\treturn fract(vec4((p4.x + p4.y)*p4.z, (p4.x + p4.z)*p4.y, (p4.y + p4.z)*p4.w, (p4.z + p4.w)*p4.x));\n}\nvoid main(void) {\n\tif (gl_FragCoord.x > numParticles) discard;\n\treadInput(vUv0.x);\n\tvisMode = inShow? 1.0 : -1.0;\n\tvec4 rndFactor = hash41(gl_FragCoord.x + seed);\n\tfloat particleRate = rate + rateDiv * rndFactor.x;\n\toutLife = inLife + delta;\n\tfloat nlife = clamp(outLife / lifetime, 0.0, 1.0);\n\tvec3 localVelocityDiv;\n\tvec3 velocityDiv;\n\tvec3 paramDiv;\n\tvec3 localVelocity = tex1Dlod_lerp(TEXTURE_PASS(internalTex0), vec2(nlife, 0), localVelocityDiv);\n\tvec3 velocity =\t  tex1Dlod_lerp(TEXTURE_PASS(internalTex1), vec2(nlife, 0), velocityDiv);\n\tvec3 params =\t\ttex1Dlod_lerp(TEXTURE_PASS(internalTex2), vec2(nlife, 0), paramDiv);\n\tfloat rotSpeed = params.x;\n\tfloat rotSpeedDiv = paramDiv.y;\n\tvec3 radialParams = tex1Dlod_lerp(TEXTURE_PASS(internalTex3), vec2(nlife, 0), paramDiv);\n\tfloat radialSpeed = radialParams.x;\n\tfloat radialSpeedDiv = radialParams.y;\n\tbool respawn = inLife <= 0.0 || outLife >= lifetime;\n\tinPos = respawn ? calcSpawnPosition(rndFactor.xyz, rndFactor.x) : inPos;\n\tinAngle = respawn ? mix(startAngle, startAngle2, rndFactor.x) : inAngle;\n#ifndef LOCAL_SPACE\n\tvec3 radialVel = inPos - emitterPos;\n#else\n\tvec3 radialVel = inPos;\n#endif\n\tradialVel = (dot(radialVel, radialVel) > 1.0E-8) ? radialSpeed * normalize(radialVel) : vec3(0.0);\n\tradialVel += (radialSpeedDiv * vec3(2.0) - vec3(1.0)) * radialSpeedDivMult * rndFactor.xyz;\n\tlocalVelocity +=\t(localVelocityDiv * vec3(2.0) - vec3(1.0)) * localVelocityDivMult * rndFactor.xyz;\n\tvelocity +=\t\t (velocityDiv * vec3(2.0) - vec3(1.0)) * velocityDivMult * rndFactor.xyz;\n\trotSpeed +=\t\t (rotSpeedDiv * 2.0 - 1.0) * rotSpeedDivMult * rndFactor.y;\n\taddInitialVelocity(localVelocity, rndFactor.xyz);\n#ifndef LOCAL_SPACE\n\toutVel = emitterMatrix * localVelocity + (radialVel + velocity) * emitterScale;\n#else\n\toutVel = (localVelocity + radialVel) / emitterScale + emitterMatrixInv * velocity;\n#endif\n\toutPos = inPos + outVel * delta;\n\toutAngle = inAngle + rotSpeed * delta;\n",particle_billboardVS:"\n\tquadXY = rotate(quadXY, inAngle, rotMatrix);\n\tvec3 localPos = billboard(particlePos, quadXY);\n",particle_blendAddPS:"\n\tdBlendModeFogFactor = 0.0;\n\trgb *= saturate(gammaCorrectInput(max(a, 0.0)));\n\tif ((rgb.r + rgb.g + rgb.b) < 0.000001) discard;\n",particle_blendMultiplyPS:"\n\trgb = mix(vec3(1.0), rgb, vec3(a));\n\tif (rgb.r + rgb.g + rgb.b > 2.99) discard;\n",particle_blendNormalPS:"\n\tif (a < 0.01) discard;\n",particle_cpuVS:"\nattribute vec4 particle_vertexData;\nattribute vec4 particle_vertexData2;\nattribute vec4 particle_vertexData3;\nattribute float particle_vertexData4;\n#ifndef USE_MESH\nattribute vec2 particle_vertexData5;\n#else\nattribute vec4 particle_vertexData5;\n#endif\nuniform mat4 matrix_viewProjection;\nuniform mat4 matrix_model;\n#ifndef VIEWMATRIX\n#define VIEWMATRIX\nuniform mat4 matrix_view;\n#endif\nuniform mat3 matrix_normal;\nuniform mat4 matrix_viewInverse;\nuniform float numParticles;\nuniform float lifetime;\nuniform float stretch;\nuniform float seed;\nuniform vec3 wrapBounds;\nuniform vec3 emitterScale;\nuniform vec3 faceTangent;\nuniform vec3 faceBinorm;\n#ifdef PARTICLE_GPU\n\tuniform highp sampler2D internalTex0;\n\tuniform highp sampler2D internalTex1;\n\tuniform highp sampler2D internalTex2;\n#endif\nuniform vec3 emitterPos;\nvarying vec4 texCoordsAlphaLife;\nvec2 rotate(vec2 quadXY, float pRotation, out mat2 rotMatrix)\n{\n\tfloat c = cos(pRotation);\n\tfloat s = sin(pRotation);\n\tmat2 m = mat2(c, -s, s, c);\n\trotMatrix = m;\n\treturn m * quadXY;\n}\nvec3 billboard(vec3 InstanceCoords, vec2 quadXY)\n{\n\tvec3 pos = -matrix_viewInverse[0].xyz * quadXY.x + -matrix_viewInverse[1].xyz * quadXY.y;\n\treturn pos;\n}\nvec3 customFace(vec3 InstanceCoords, vec2 quadXY)\n{\n\tvec3 pos = faceTangent * quadXY.x + faceBinorm * quadXY.y;\n\treturn pos;\n}\nvoid main(void)\n{\n\tvec3 particlePos = particle_vertexData.xyz;\n\tvec3 inPos = particlePos;\n\tvec3 vertPos = particle_vertexData3.xyz;\n\tvec3 inVel = vec3(particle_vertexData2.w, particle_vertexData3.w, particle_vertexData5.x);\n\tfloat id = floor(particle_vertexData4);\n\tfloat rndFactor = fract(sin(id + 1.0 + seed));\n\tvec3 rndFactor3 = vec3(rndFactor, fract(rndFactor*10.0), fract(rndFactor*100.0));\n#ifdef LOCAL_SPACE\n\tinVel = mat3(matrix_model) * inVel;\n#endif\n\tvec2 velocityV = normalize((mat3(matrix_view) * inVel).xy);\n\tvec2 quadXY = vertPos.xy;\n#ifdef USE_MESH\n\ttexCoordsAlphaLife = vec4(particle_vertexData5.zw, particle_vertexData2.z, particle_vertexData.w);\n#else\n\ttexCoordsAlphaLife = vec4(quadXY * -0.5 + 0.5, particle_vertexData2.z, particle_vertexData.w);\n#endif\n\tmat2 rotMatrix;\n\tfloat inAngle = particle_vertexData2.x;\n\tvec3 particlePosMoved = vec3(0.0);\n\tvec3 meshLocalPos = particle_vertexData3.xyz;\n",particle_cpu_endVS:"\n\tlocalPos *= particle_vertexData2.y * emitterScale;\n\tlocalPos += particlePos;\n\tgl_Position = matrix_viewProjection * vec4(localPos, 1.0);\n",particle_customFaceVS:"\n\tquadXY = rotate(quadXY, inAngle, rotMatrix);\n\tvec3 localPos = customFace(particlePos, quadXY);\n",particle_endPS:"\n\trgb = addFog(rgb);\n\trgb = toneMap(rgb);\n\trgb = gammaCorrectOutput(rgb);\n\tgl_FragColor = vec4(rgb, a);\n}\n",particle_endVS:"\n\tlocalPos *= scale * emitterScale;\n\tlocalPos += particlePos;\n\t#ifdef SCREEN_SPACE\n\tgl_Position = vec4(localPos.x, localPos.y, 0.0, 1.0);\n\t#else\n\tgl_Position = matrix_viewProjection * vec4(localPos.xyz, 1.0);\n\t#endif\n",particle_halflambertPS:"\n\tvec3 negNormal = normal*0.5+0.5;\n\tvec3 posNormal = -normal*0.5+0.5;\n\tnegNormal *= negNormal;\n\tposNormal *= posNormal;\n",particle_initVS:"\nattribute vec4 particle_vertexData;\n#ifdef USE_MESH\nattribute vec2 particle_uv;\n#endif\nuniform mat4 matrix_viewProjection;\nuniform mat4 matrix_model;\nuniform mat3 matrix_normal;\nuniform mat4 matrix_viewInverse;\n#ifndef VIEWMATRIX\n#define VIEWMATRIX\nuniform mat4 matrix_view;\n#endif\nuniform float numParticles;\nuniform float numParticlesPot;\nuniform float graphSampleSize;\nuniform float graphNumSamples;\nuniform float stretch;\nuniform vec3 wrapBounds;\nuniform vec3 emitterScale;\nuniform vec3 emitterPos;\nuniform vec3 faceTangent;\nuniform vec3 faceBinorm;\nuniform float rate;\nuniform float rateDiv;\nuniform float lifetime;\nuniform float deltaRandomnessStatic;\nuniform float scaleDivMult;\nuniform float alphaDivMult;\nuniform float seed;\nuniform float delta;\nuniform sampler2D particleTexOUT;\nuniform sampler2D particleTexIN;\n#ifdef PARTICLE_GPU\n\tuniform highp sampler2D internalTex0;\n\tuniform highp sampler2D internalTex1;\n\tuniform highp sampler2D internalTex2;\n#endif\n#ifndef CAMERAPLANES\n#define CAMERAPLANES\nuniform vec4 camera_params;\n#endif\nvarying vec4 texCoordsAlphaLife;\nvec3 inPos;\nvec3 inVel;\nfloat inAngle;\nbool inShow;\nfloat inLife;\n",particle_lambertPS:"\n\tvec3 negNormal = max(normal, vec3(0.0));\n\tvec3 posNormal = max(-normal, vec3(0.0));\n",particle_lightingPS:"\n\tvec3 light = negNormal.x*lightCube[0] + posNormal.x*lightCube[1] +\n\t\t\t\t\t\tnegNormal.y*lightCube[2] + posNormal.y*lightCube[3] +\n\t\t\t\t\t\tnegNormal.z*lightCube[4] + posNormal.z*lightCube[5];\n\trgb *= light;\n",particle_localShiftVS:"\n\tparticlePos = (matrix_model * vec4(particlePos, 1.0)).xyz;\n",particle_meshVS:"\n\tvec3 localPos = meshLocalPos;\n\tlocalPos.xy = rotate(localPos.xy, inAngle, rotMatrix);\n\tlocalPos.yz = rotate(localPos.yz, inAngle, rotMatrix);\n\tbillboard(particlePos, quadXY);\n",particle_normalVS:"\n\tNormal = normalize(localPos + matrix_viewInverse[2].xyz);\n",particle_normalMapPS:"\n\tvec3 normalMap = normalize(texture2D(normalMap, vec2(texCoordsAlphaLife.x, 1.0 - texCoordsAlphaLife.y)).xyz * 2.0 - 1.0);\n\tvec3 normal = ParticleMat * normalMap;\n",particle_pointAlongVS:"\n\tinAngle = atan(velocityV.x, velocityV.y);\n",particle_softPS:"\n\tfloat depth = getLinearScreenDepth();\n\tfloat particleDepth = vDepth;\n\tfloat depthDiff = saturate(abs(particleDepth - depth) * softening);\n\ta *= depthDiff;\n",particle_softVS:"\n\tvDepth = getLinearDepth(localPos);\n",particle_stretchVS:"\n\tvec3 moveDir = inVel * stretch;\n\tvec3 posPrev = particlePos - moveDir;\n\tposPrev += particlePosMoved;\n\tvec2 centerToVertexV = normalize((mat3(matrix_view) * localPos).xy);\n\tfloat interpolation = dot(-velocityV, centerToVertexV) * 0.5 + 0.5;\n\tparticlePos = mix(particlePos, posPrev, interpolation);\n",particle_TBNVS:"\n\tmat3 rot3 = mat3(rotMatrix[0][0], rotMatrix[0][1], 0.0, rotMatrix[1][0], rotMatrix[1][1], 0.0, 0.0, 0.0, 1.0);\n\tParticleMat = mat3(-matrix_viewInverse[0].xyz, -matrix_viewInverse[1].xyz, matrix_viewInverse[2].xyz) * rot3;\n",particle_wrapVS:"\n\tvec3 origParticlePos = particlePos;\n\tparticlePos -= matrix_model[3].xyz;\n\tparticlePos = mod(particlePos, wrapBounds) - wrapBounds * 0.5;\n\tparticlePos += matrix_model[3].xyz;\n\tparticlePosMoved = particlePos - origParticlePos;\n",pickPS:"\nuniform uint meshInstanceId;\nvec4 getPickOutput() {\n\tconst vec4 inv = vec4(1.0 / 255.0, 1.0 / 255.0, 1.0 / 255.0, 1.0 / 255.0);\n\tconst uvec4 shifts = uvec4(16, 8, 0, 24);\n\tuvec4 col = (uvec4(meshInstanceId) >> shifts) & uvec4(0xff);\n\treturn vec4(col) * inv;\n}\n",reflDirPS:"\nvoid getReflDir(vec3 worldNormal, vec3 viewDir, float gloss, mat3 tbn) {\n\tdReflDirW = normalize(-reflect(viewDir, worldNormal));\n}\n",reflDirAnisoPS:"\nvoid getReflDir(vec3 worldNormal, vec3 viewDir, float gloss, mat3 tbn) {\n\tfloat roughness = sqrt(1.0 - min(gloss, 1.0));\n\tfloat anisotropy = material_anisotropy * roughness;\n\tvec3 anisotropicDirection = anisotropy >= 0.0 ? tbn[1] : tbn[0];\n\tvec3 anisotropicTangent = cross(anisotropicDirection, viewDir);\n\tvec3 anisotropicNormal = cross(anisotropicTangent, anisotropicDirection);\n\tvec3 bentNormal = normalize(mix(normalize(worldNormal), normalize(anisotropicNormal), anisotropy));\n\tdReflDirW = reflect(-viewDir, bentNormal);\n}\n",reflectionCCPS:"\n#ifdef LIT_CLEARCOAT\nvoid addReflectionCC(vec3 reflDir, float gloss) {\n\tccReflection += calcReflection(reflDir, gloss);\n}\n#endif\n",reflectionCubePS:"\nuniform samplerCube texture_cubeMap;\nuniform float material_reflectivity;\nvec3 calcReflection(vec3 reflDir, float gloss) {\n\tvec3 lookupVec = cubeMapProject(reflDir);\n\tlookupVec.x *= -1.0;\n\treturn $DECODE(textureCube(texture_cubeMap, lookupVec));\n}\nvoid addReflection(vec3 reflDir, float gloss) {   \n\tdReflection += vec4(calcReflection(reflDir, gloss), material_reflectivity);\n}\n",reflectionEnvHQPS:"\n#ifndef ENV_ATLAS\n#define ENV_ATLAS\nuniform sampler2D texture_envAtlas;\n#endif\nuniform samplerCube texture_cubeMap;\nuniform float material_reflectivity;\nvec3 calcReflection(vec3 reflDir, float gloss) {\n\tvec3 dir = cubeMapProject(reflDir) * vec3(-1.0, 1.0, 1.0);\n\tvec2 uv = toSphericalUv(dir);\n\tfloat level = saturate(1.0 - gloss) * 5.0;\n\tfloat ilevel = floor(level);\n\tfloat flevel = level - ilevel;\n\tvec3 sharp = $DECODE_CUBEMAP(textureCube(texture_cubeMap, dir));\n\tvec3 roughA = $DECODE(texture2D(texture_envAtlas, mapRoughnessUv(uv, ilevel)));\n\tvec3 roughB = $DECODE(texture2D(texture_envAtlas, mapRoughnessUv(uv, ilevel + 1.0)));\n\treturn processEnvironment(mix(sharp, mix(roughA, roughB, flevel), min(level, 1.0)));\n}\nvoid addReflection(vec3 reflDir, float gloss) {   \n\tdReflection += vec4(calcReflection(reflDir, gloss), material_reflectivity);\n}\n",reflectionEnvPS:"\n#ifndef ENV_ATLAS\n#define ENV_ATLAS\nuniform sampler2D texture_envAtlas;\n#endif\nuniform float material_reflectivity;\nfloat shinyMipLevel(vec2 uv) {\n\tvec2 dx = dFdx(uv);\n\tvec2 dy = dFdy(uv);\n\tvec2 uv2 = vec2(fract(uv.x + 0.5), uv.y);\n\tvec2 dx2 = dFdx(uv2);\n\tvec2 dy2 = dFdy(uv2);\n\tfloat maxd = min(max(dot(dx, dx), dot(dy, dy)), max(dot(dx2, dx2), dot(dy2, dy2)));\n\treturn clamp(0.5 * log2(maxd) - 1.0 + textureBias, 0.0, 5.0);\n}\nvec3 calcReflection(vec3 reflDir, float gloss) {\n\tvec3 dir = cubeMapProject(reflDir) * vec3(-1.0, 1.0, 1.0);\n\tvec2 uv = toSphericalUv(dir);\n\tfloat level = saturate(1.0 - gloss) * 5.0;\n\tfloat ilevel = floor(level);\n\tfloat level2 = shinyMipLevel(uv * atlasSize);\n\tfloat ilevel2 = floor(level2);\n\tvec2 uv0, uv1;\n\tfloat weight;\n\tif (ilevel == 0.0) {\n\t\tuv0 = mapShinyUv(uv, ilevel2);\n\t\tuv1 = mapShinyUv(uv, ilevel2 + 1.0);\n\t\tweight = level2 - ilevel2;\n\t} else {\n\t\tuv0 = uv1 = mapRoughnessUv(uv, ilevel);\n\t\tweight = 0.0;\n\t}\n\tvec3 linearA = $DECODE(texture2D(texture_envAtlas, uv0));\n\tvec3 linearB = $DECODE(texture2D(texture_envAtlas, uv1));\n\tvec3 linear0 = mix(linearA, linearB, weight);\n\tvec3 linear1 = $DECODE(texture2D(texture_envAtlas, mapRoughnessUv(uv, ilevel + 1.0)));\n\treturn processEnvironment(mix(linear0, linear1, level - ilevel));\n}\nvoid addReflection(vec3 reflDir, float gloss) {   \n\tdReflection += vec4(calcReflection(reflDir, gloss), material_reflectivity);\n}\n",reflectionSpherePS:"\n#ifndef VIEWMATRIX\n#define VIEWMATRIX\nuniform mat4 matrix_view;\n#endif\nuniform sampler2D texture_sphereMap;\nuniform float material_reflectivity;\nvec3 calcReflection(vec3 reflDir, float gloss) {\n\tvec3 reflDirV = (mat3(matrix_view) * reflDir).xyz;\n\tfloat m = 2.0 * sqrt( dot(reflDirV.xy, reflDirV.xy) + (reflDirV.z+1.0)*(reflDirV.z+1.0) );\n\tvec2 sphereMapUv = reflDirV.xy / m + 0.5;\n\treturn $DECODE(texture2D(texture_sphereMap, sphereMapUv));\n}\nvoid addReflection(vec3 reflDir, float gloss) {   \n\tdReflection += vec4(calcReflection(reflDir, gloss), material_reflectivity);\n}\n",reflectionSheenPS:"\nvoid addReflectionSheen(vec3 worldNormal, vec3 viewDir, float gloss) {\n\tfloat NoV = dot(worldNormal, viewDir);\n\tfloat alphaG = gloss * gloss;\n\tfloat a = gloss < 0.25 ? -339.2 * alphaG + 161.4 * gloss - 25.9 : -8.48 * alphaG + 14.3 * gloss - 9.95;\n\tfloat b = gloss < 0.25 ? 44.0 * alphaG - 23.7 * gloss + 3.26 : 1.97 * alphaG - 3.27 * gloss + 0.72;\n\tfloat DG = exp( a * NoV + b ) + ( gloss < 0.25 ? 0.0 : 0.1 * ( gloss - 0.25 ) );\n\tsReflection += calcReflection(worldNormal, 0.0) * saturate(DG);\n}\n",refractionCubePS:"\nvec3 refract2(vec3 viewVec, vec3 normal, float IOR) {\n\tfloat vn = dot(viewVec, normal);\n\tfloat k = 1.0 - IOR * IOR * (1.0 - vn * vn);\n\tvec3 refrVec = IOR * viewVec - (IOR * vn + sqrt(k)) * normal;\n\treturn refrVec;\n}\nvoid addRefraction(\n\tvec3 worldNormal, \n\tvec3 viewDir, \n\tfloat thickness, \n\tfloat gloss, \n\tvec3 specularity, \n\tvec3 albedo, \n\tfloat transmission,\n\tfloat refractionIndex,\n\tfloat dispersion\n#if defined(LIT_IRIDESCENCE)\n\t, vec3 iridescenceFresnel,\n\tfloat iridescenceIntensity\n#endif \n) {\n\tvec4 tmpRefl = dReflection;\n\tvec3 reflectionDir = refract2(-viewDir, worldNormal, refractionIndex);\n\tdReflection = vec4(0);\n\taddReflection(reflectionDir, gloss);\n\tdDiffuseLight = mix(dDiffuseLight, dReflection.rgb * albedo, transmission);\n\tdReflection = tmpRefl;\n}\n",refractionDynamicPS:"\nuniform float material_invAttenuationDistance;\nuniform vec3 material_attenuation;\nvec3 evalRefractionColor(vec3 refractionVector, float gloss, float refractionIndex) {\n\tvec4 pointOfRefraction = vec4(vPositionW + refractionVector, 1.0);\n\tvec4 projectionPoint = matrix_viewProjection * pointOfRefraction;\n\tvec2 uv = getGrabScreenPos(projectionPoint);\n\tfloat iorToRoughness = (1.0 - gloss) * clamp((1.0 / refractionIndex) * 2.0 - 2.0, 0.0, 1.0);\n\tfloat refractionLod = log2(uScreenSize.x) * iorToRoughness;\n\tvec3 refraction = texture2DLod(uSceneColorMap, uv, refractionLod).rgb;\n\treturn refraction;\n}\nvoid addRefraction(\n\tvec3 worldNormal, \n\tvec3 viewDir, \n\tfloat thickness, \n\tfloat gloss, \n\tvec3 specularity, \n\tvec3 albedo, \n\tfloat transmission,\n\tfloat refractionIndex,\n\tfloat dispersion\n#if defined(LIT_IRIDESCENCE)\n\t, vec3 iridescenceFresnel,\n\tfloat iridescenceIntensity\n#endif\n) {\n\tvec3 modelScale;\n\tmodelScale.x = length(vec3(matrix_model[0].xyz));\n\tmodelScale.y = length(vec3(matrix_model[1].xyz));\n\tmodelScale.z = length(vec3(matrix_model[2].xyz));\n\tvec3 scale = thickness * modelScale;\n\tvec3 refractionVector = normalize(refract(-viewDir, worldNormal, refractionIndex)) * scale;\n\tvec3 refraction = evalRefractionColor(refractionVector, gloss, refractionIndex);\n\t#ifdef DISPERSION\n\t\tfloat halfSpread = (1.0 / refractionIndex - 1.0) * 0.025 * dispersion;\n\t\tfloat refractionIndexR = refractionIndex - halfSpread;\n\t\trefractionVector = normalize(refract(-viewDir, worldNormal, refractionIndexR)) * scale;\n\t\trefraction.r = evalRefractionColor(refractionVector, gloss, refractionIndexR).r;\n\t\tfloat refractionIndexB = refractionIndex + halfSpread;\n\t\trefractionVector = normalize(refract(-viewDir, worldNormal, refractionIndexB)) * scale;\n\t\trefraction.b = evalRefractionColor(refractionVector, gloss, refractionIndexB).b;\n\t#endif\n\tvec3 transmittance;\n\tif (material_invAttenuationDistance != 0.0)\n\t{\n\t\tvec3 attenuation = -log(material_attenuation) * material_invAttenuationDistance;\n\t\ttransmittance = exp(-attenuation * length(refractionVector));\n\t}\n\telse\n\t{\n\t\ttransmittance = refraction;\n\t}\n\tvec3 fresnel = vec3(1.0) - \n\t\tgetFresnel(\n\t\t\tdot(viewDir, worldNormal), \n\t\t\tgloss, \n\t\t\tspecularity\n\t\t#if defined(LIT_IRIDESCENCE)\n\t\t\t, iridescenceFresnel,\n\t\t\tiridescenceIntensity\n\t\t#endif\n\t\t);\n\tdDiffuseLight = mix(dDiffuseLight, refraction * transmittance * fresnel, transmission);\n}\n",reprojectPS:"\nvarying vec2 vUv0;\n#ifdef CUBEMAP_SOURCE\n\tuniform samplerCube sourceCube;\n#else\n\tuniform sampler2D sourceTex;\n#endif\n#ifdef USE_SAMPLES_TEX\n\tuniform sampler2D samplesTex;\n\tuniform vec2 samplesTexInverseSize;\n#endif\nuniform vec3 params;\nfloat targetFace() { return params.x; }\nfloat targetTotalPixels() { return params.y; }\nfloat sourceTotalPixels() { return params.z; }\nfloat PI = 3.141592653589793;\nfloat saturate(float x) {\n\treturn clamp(x, 0.0, 1.0);\n}\n"+vo+"\n"+_o+"\nvec3 modifySeams(vec3 dir, float scale) {\n\tvec3 adir = abs(dir);\n\tfloat M = max(max(adir.x, adir.y), adir.z);\n\treturn dir / M * vec3(\n\t\tadir.x == M ? 1.0 : scale,\n\t\tadir.y == M ? 1.0 : scale,\n\t\tadir.z == M ? 1.0 : scale\n\t);\n}\nvec2 toSpherical(vec3 dir) {\n\treturn vec2(dir.xz == vec2(0.0) ? 0.0 : atan(dir.x, dir.z), asin(dir.y));\n}\nvec3 fromSpherical(vec2 uv) {\n\treturn vec3(cos(uv.y) * sin(uv.x),\n\t\t\t\tsin(uv.y),\n\t\t\t\tcos(uv.y) * cos(uv.x));\n}\nvec3 getDirectionEquirect() {\n\treturn fromSpherical((vec2(vUv0.x, 1.0 - vUv0.y) * 2.0 - 1.0) * vec2(PI, PI * 0.5));\n}\nfloat signNotZero(float k){\n\treturn(k >= 0.0) ? 1.0 : -1.0;\n}\nvec2 signNotZero(vec2 v) {\n\treturn vec2(signNotZero(v.x), signNotZero(v.y));\n}\nvec3 octDecode(vec2 o) {\n\tvec3 v = vec3(o.x, 1.0 - abs(o.x) - abs(o.y), o.y);\n\tif (v.y < 0.0) {\n\t\tv.xz = (1.0 - abs(v.zx)) * signNotZero(v.xz);\n\t}\n\treturn normalize(v);\n}\nvec3 getDirectionOctahedral() {\n\treturn octDecode(vec2(vUv0.x, 1.0 - vUv0.y) * 2.0 - 1.0);\n}\nvec2 octEncode(in vec3 v) {\n\tfloat l1norm = abs(v.x) + abs(v.y) + abs(v.z);\n\tvec2 result = v.xz * (1.0 / l1norm);\n\tif (v.y < 0.0) {\n\t\tresult = (1.0 - abs(result.yx)) * signNotZero(result.xy);\n\t}\n\treturn result;\n}\n#ifdef CUBEMAP_SOURCE\n\tvec4 sampleCubemap(vec3 dir) {\n\t\treturn textureCube(sourceCube, modifySeams(dir, 1.0));\n\t}\n\tvec4 sampleCubemap(vec2 sph) {\n\treturn sampleCubemap(fromSpherical(sph));\n}\n\tvec4 sampleCubemap(vec3 dir, float mipLevel) {\n\t\treturn textureCubeLod(sourceCube, modifySeams(dir, 1.0), mipLevel);\n\t}\n\tvec4 sampleCubemap(vec2 sph, float mipLevel) {\n\t\treturn sampleCubemap(fromSpherical(sph), mipLevel);\n\t}\n#else\n\tvec4 sampleEquirect(vec2 sph) {\n\t\tvec2 uv = sph / vec2(PI * 2.0, PI) + 0.5;\n\t\treturn texture2D(sourceTex, vec2(uv.x, 1.0 - uv.y));\n\t}\n\tvec4 sampleEquirect(vec3 dir) {\n\t\treturn sampleEquirect(toSpherical(dir));\n\t}\n\tvec4 sampleEquirect(vec2 sph, float mipLevel) {\n\t\tvec2 uv = sph / vec2(PI * 2.0, PI) + 0.5;\n\t\treturn texture2DLod(sourceTex, vec2(uv.x, 1.0 - uv.y), mipLevel);\n\t}\n\tvec4 sampleEquirect(vec3 dir, float mipLevel) {\n\t\treturn sampleEquirect(toSpherical(dir), mipLevel);\n\t}\n\tvec4 sampleOctahedral(vec3 dir) {\n\t\tvec2 uv = octEncode(dir) * 0.5 + 0.5;\n\t\treturn texture2D(sourceTex, vec2(uv.x, 1.0 - uv.y));\n\t}\n\tvec4 sampleOctahedral(vec2 sph) {\n\t\treturn sampleOctahedral(fromSpherical(sph));\n\t}\n\tvec4 sampleOctahedral(vec3 dir, float mipLevel) {\n\t\tvec2 uv = octEncode(dir) * 0.5 + 0.5;\n\t\treturn texture2DLod(sourceTex, vec2(uv.x, 1.0 - uv.y), mipLevel);\n\t}\n\tvec4 sampleOctahedral(vec2 sph, float mipLevel) {\n\t\treturn sampleOctahedral(fromSpherical(sph), mipLevel);\n\t}\n#endif\nvec3 getDirectionCubemap() {\n\tvec2 st = vUv0 * 2.0 - 1.0;\n\tfloat face = targetFace();\n\tvec3 vec;\n\tif (face == 0.0) {\n\t\tvec = vec3(1, -st.y, -st.x);\n\t} else if (face == 1.0) {\n\t\tvec = vec3(-1, -st.y, st.x);\n\t} else if (face == 2.0) {\n\t\tvec = vec3(st.x, 1, st.y);\n\t} else if (face == 3.0) {\n\t\tvec = vec3(st.x, -1, -st.y);\n\t} else if (face == 4.0) {\n\t\tvec = vec3(st.x, -st.y, 1);\n\t} else {\n\t\tvec = vec3(-st.x, -st.y, -1);\n\t}\n\treturn normalize(modifySeams(vec, 1.0));\n}\nmat3 matrixFromVector(vec3 n) {\n\tfloat a = 1.0 / (1.0 + n.z);\n\tfloat b = -n.x * n.y * a;\n\tvec3 b1 = vec3(1.0 - n.x * n.x * a, b, -n.x);\n\tvec3 b2 = vec3(b, 1.0 - n.y * n.y * a, -n.y);\n\treturn mat3(b1, b2, n);\n}\nmat3 matrixFromVectorSlow(vec3 n) {\n\tvec3 up = (1.0 - abs(n.y) <= 0.0000001) ? vec3(0.0, 0.0, n.y > 0.0 ? 1.0 : -1.0) : vec3(0.0, 1.0, 0.0);\n\tvec3 x = normalize(cross(up, n));\n\tvec3 y = cross(n, x);\n\treturn mat3(x, y, n);\n}\nvec4 reproject() {\n\tif (NUM_SAMPLES <= 1) {\n\t\treturn ENCODE_FUNC(DECODE_FUNC(SOURCE_FUNC(TARGET_FUNC())));\n\t} else {\n\t\tvec3 t = TARGET_FUNC();\n\t\tvec3 tu = dFdx(t);\n\t\tvec3 tv = dFdy(t);\n\t\tvec3 result = vec3(0.0);\n\t\tfor (float u = 0.0; u < NUM_SAMPLES_SQRT; ++u) {\n\t\t\tfor (float v = 0.0; v < NUM_SAMPLES_SQRT; ++v) {\n\t\t\t\tresult += DECODE_FUNC(SOURCE_FUNC(normalize(t +\n\t\t\t\t\t\t\t\t\t\t\t\t\t\t\ttu * (u / NUM_SAMPLES_SQRT - 0.5) +\n\t\t\t\t\t\t\t\t\t\t\t\t\t\t\ttv * (v / NUM_SAMPLES_SQRT - 0.5))));\n\t\t\t}\n\t\t}\n\t\treturn ENCODE_FUNC(result / (NUM_SAMPLES_SQRT * NUM_SAMPLES_SQRT));\n\t}\n}\nvec4 unpackFloat = vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 16581375.0);\n#ifdef USE_SAMPLES_TEX\n\tvoid unpackSample(int i, out vec3 L, out float mipLevel) {\n\t\tfloat u = (float(i * 4) + 0.5) * samplesTexInverseSize.x;\n\t\tfloat v = (floor(u) + 0.5) * samplesTexInverseSize.y;\n\t\tvec4 raw;\n\t\traw.x = dot(texture2D(samplesTex, vec2(u, v)), unpackFloat); u += samplesTexInverseSize.x;\n\t\traw.y = dot(texture2D(samplesTex, vec2(u, v)), unpackFloat); u += samplesTexInverseSize.x;\n\t\traw.z = dot(texture2D(samplesTex, vec2(u, v)), unpackFloat); u += samplesTexInverseSize.x;\n\t\traw.w = dot(texture2D(samplesTex, vec2(u, v)), unpackFloat);\n\t\tL.xyz = raw.xyz * 2.0 - 1.0;\n\t\tmipLevel = raw.w * 8.0;\n\t}\n\tvec4 prefilterSamples() {\n\t\tmat3 vecSpace = matrixFromVectorSlow(TARGET_FUNC());\n\t\tvec3 L;\n\t\tfloat mipLevel;\n\t\tvec3 result = vec3(0.0);\n\t\tfloat totalWeight = 0.0;\n\t\tfor (int i = 0; i < NUM_SAMPLES; ++i) {\n\t\t\tunpackSample(i, L, mipLevel);\n\t\t\tresult += DECODE_FUNC(SOURCE_FUNC(vecSpace * L, mipLevel)) * L.z;\n\t\t\ttotalWeight += L.z;\n\t\t}\n\t\treturn ENCODE_FUNC(result / totalWeight);\n\t}\n\tvec4 prefilterSamplesUnweighted() {\n\t\tmat3 vecSpace = matrixFromVectorSlow(TARGET_FUNC());\n\t\tvec3 L;\n\t\tfloat mipLevel;\n\t\tvec3 result = vec3(0.0);\n\t\tfloat totalWeight = 0.0;\n\t\tfor (int i = 0; i < NUM_SAMPLES; ++i) {\n\t\t\tunpackSample(i, L, mipLevel);\n\t\t\tresult += DECODE_FUNC(SOURCE_FUNC(vecSpace * L, mipLevel));\n\t\t}\n\t\treturn ENCODE_FUNC(result / float(NUM_SAMPLES));\n\t}\n#endif\nvoid main(void) {\n\tgl_FragColor = PROCESS_FUNC();\n}\n",sampleCatmullRomPS:"\nvec4 SampleTextureCatmullRom(TEXTURE_ACCEPT(tex), vec2 uv, vec2 texSize) {\n\tvec2 samplePos = uv * texSize;\n\tvec2 texPos1 = floor(samplePos - 0.5) + 0.5;\n\tvec2 f = samplePos - texPos1;\n\tvec2 w0 = f * (-0.5 + f * (1.0 - 0.5 * f));\n\tvec2 w1 = 1.0 + f * f * (-2.5 + 1.5 * f);\n\tvec2 w2 = f * (0.5 + f * (2.0 - 1.5 * f));\n\tvec2 w3 = f * f * (-0.5 + 0.5 * f);\n\tvec2 w12 = w1 + w2;\n\tvec2 offset12 = w2 / (w1 + w2);\n\tvec2 texPos0 = (texPos1 - 1.0) / texSize;\n\tvec2 texPos3 = (texPos1 + 2.0) / texSize;\n\tvec2 texPos12 = (texPos1 + offset12) / texSize;\n\tvec4 result = vec4(0.0);\n\tresult += texture2DLod(tex, vec2(texPos0.x, texPos0.y), 0.0) * w0.x * w0.y;\n\tresult += texture2DLod(tex, vec2(texPos12.x, texPos0.y), 0.0) * w12.x * w0.y;\n\tresult += texture2DLod(tex, vec2(texPos3.x, texPos0.y), 0.0) * w3.x * w0.y;\n\tresult += texture2DLod(tex, vec2(texPos0.x, texPos12.y), 0.0) * w0.x * w12.y;\n\tresult += texture2DLod(tex, vec2(texPos12.x, texPos12.y), 0.0) * w12.x * w12.y;\n\tresult += texture2DLod(tex, vec2(texPos3.x, texPos12.y), 0.0) * w3.x * w12.y;\n\tresult += texture2DLod(tex, vec2(texPos0.x, texPos3.y), 0.0) * w0.x * w3.y;\n\tresult += texture2DLod(tex, vec2(texPos12.x, texPos3.y), 0.0) * w12.x * w3.y;\n\tresult += texture2DLod(tex, vec2(texPos3.x, texPos3.y), 0.0) * w3.x * w3.y;\n\treturn result;\n}\n",screenDepthPS:"\nuniform highp sampler2D uSceneDepthMap;\n#ifndef SCREENSIZE\n#define SCREENSIZE\nuniform vec4 uScreenSize;\n#endif\n#ifndef VIEWMATRIX\n#define VIEWMATRIX\nuniform mat4 matrix_view;\n#endif\n#ifndef LINEARIZE_DEPTH\n#ifndef CAMERAPLANES\n#define CAMERAPLANES\nuniform vec4 camera_params;\n#endif\n#define LINEARIZE_DEPTH\nfloat linearizeDepth(float z) {\n\tif (camera_params.w == 0.0)\n\t\treturn (camera_params.z * camera_params.y) / (camera_params.y + z * (camera_params.z - camera_params.y));\n\telse\n\t\treturn camera_params.z + z * (camera_params.y - camera_params.z);\n}\n#endif\nfloat delinearizeDepth(float linearDepth) {\n\tif (camera_params.w == 0.0) {\n\t\treturn (camera_params.y * (camera_params.z - linearDepth)) / (linearDepth * (camera_params.z - camera_params.y));\n\t} else {\n\t\treturn (linearDepth - camera_params.z) / (camera_params.y - camera_params.z);\n\t}\n}\nfloat getLinearScreenDepth(vec2 uv) {\n\t#ifdef SCENE_DEPTHMAP_LINEAR\n\t\t#ifdef SCENE_DEPTHMAP_FLOAT\n\t\t\treturn texture2D(uSceneDepthMap, uv).r;\n\t\t#else\n\t\t\tivec2 textureSize = textureSize(uSceneDepthMap, 0);\n\t\t\tivec2 texel = ivec2(uv * vec2(textureSize));\n\t\t\tvec4 data = texelFetch(uSceneDepthMap, texel, 0);\n\t\t\tuint intBits = \n\t\t\t\t(uint(data.r * 255.0) << 24u) |\n\t\t\t\t(uint(data.g * 255.0) << 16u) |\n\t\t\t\t(uint(data.b * 255.0) << 8u) |\n\t\t\t\tuint(data.a * 255.0);\n\t\t\treturn uintBitsToFloat(intBits);\n\t\t#endif\n\t#else\n\t\treturn linearizeDepth(texture2D(uSceneDepthMap, uv).r);\n\t#endif\n}\n#ifndef VERTEXSHADER\nfloat getLinearScreenDepth() {\n\tvec2 uv = gl_FragCoord.xy * uScreenSize.zw;\n\treturn getLinearScreenDepth(uv);\n}\n#endif\nfloat getLinearDepth(vec3 pos) {\n\treturn -(matrix_view * vec4(pos, 1.0)).z;\n}\n",shadowCascadesPS:"\nint getShadowCascadeIndex(vec4 shadowCascadeDistances, int shadowCascadeCount) {\n\tfloat depth = 1.0 / gl_FragCoord.w;\n\tvec4 comparisons = step(shadowCascadeDistances, vec4(depth));\n\tint cascadeIndex = int(dot(comparisons, vec4(1.0)));\n\treturn min(cascadeIndex, shadowCascadeCount - 1);\n}\nint ditherShadowCascadeIndex(int cascadeIndex, vec4 shadowCascadeDistances, int shadowCascadeCount, float blendFactor) {\n \n\tif (cascadeIndex < shadowCascadeCount - 1) {\n\t\tfloat currentRangeEnd = shadowCascadeDistances[cascadeIndex];\n\t\tfloat transitionStart = blendFactor * currentRangeEnd;\n\t\tfloat depth = 1.0 / gl_FragCoord.w;\n\t\tif (depth > transitionStart) {\n\t\t\tfloat transitionFactor = smoothstep(transitionStart, currentRangeEnd, depth);\n\t\t\tfloat dither = fract(sin(dot(gl_FragCoord.xy, vec2(12.9898, 78.233))) * 43758.5453);\n\t\t\tif (dither < transitionFactor) {\n\t\t\t\tcascadeIndex += 1;\n\t\t\t}\n\t\t}\n\t}\n\treturn cascadeIndex;\n}\nvoid fadeShadow(vec4 shadowCascadeDistances) {\t\t\t\t  \n\tfloat depth = 1.0 / gl_FragCoord.w;\n\tif (depth > shadowCascadeDistances.w) {\n\t\tdShadowCoord.z = -9999999.0;\n\t}\n}\n",shadowEVSMPS:"\nfloat VSM$(TEXTURE_ACCEPT(tex), vec2 texCoords, float resolution, float Z, float vsmBias, float exponent) {\n\tvec3 moments = texture2D(tex, texCoords).xyz;\n\treturn calculateEVSM(moments, Z, vsmBias, exponent);\n}\nfloat getShadowVSM$(TEXTURE_ACCEPT(shadowMap), vec3 shadowCoord, vec4 shadowParams, float exponent, vec3 lightDir) {\n\treturn VSM$(TEXTURE_PASS(shadowMap), shadowCoord.xy, shadowParams.x, shadowCoord.z, shadowParams.y, exponent);\n}\nfloat getShadowSpotVSM$(TEXTURE_ACCEPT(shadowMap), vec3 shadowCoord, vec4 shadowParams, float exponent, vec3 lightDir) {\n\treturn VSM$(TEXTURE_PASS(shadowMap), shadowCoord.xy, shadowParams.x, length(lightDir) * shadowParams.w + shadowParams.z, shadowParams.y, exponent);\n}\n",shadowEVSMnPS:"\nfloat VSM$(TEXTURE_ACCEPT(tex), vec2 texCoords, float resolution, float Z, float vsmBias, float exponent) {\n\tfloat pixelSize = 1.0 / resolution;\n\ttexCoords -= vec2(pixelSize);\n\tvec3 s00 = texture2D(tex, texCoords).xyz;\n\tvec3 s10 = texture2D(tex, texCoords + vec2(pixelSize, 0)).xyz;\n\tvec3 s01 = texture2D(tex, texCoords + vec2(0, pixelSize)).xyz;\n\tvec3 s11 = texture2D(tex, texCoords + vec2(pixelSize)).xyz;\n\tvec2 fr = fract(texCoords * resolution);\n\tvec3 h0 = mix(s00, s10, fr.x);\n\tvec3 h1 = mix(s01, s11, fr.x);\n\tvec3 moments = mix(h0, h1, fr.y);\n\treturn calculateEVSM(moments, Z, vsmBias, exponent);\n}\nfloat getShadowVSM$(TEXTURE_ACCEPT(shadowMap), vec3 shadowCoord, vec4 shadowParams, float exponent, vec3 lightDir) {\n\treturn VSM$(TEXTURE_PASS(shadowMap), shadowCoord.xy, shadowParams.x, shadowCoord.z, shadowParams.y, exponent);\n}\nfloat getShadowSpotVSM$(TEXTURE_ACCEPT(shadowMap), vec3 shadowCoord, vec4 shadowParams, float exponent, vec3 lightDir) {\n\treturn VSM$(TEXTURE_PASS(shadowMap), shadowCoord.xy, shadowParams.x, length(lightDir) * shadowParams.w + shadowParams.z, shadowParams.y, exponent);\n}\n",shadowPCSSPS:"\n#define PCSS_SAMPLE_COUNT 16\nuniform float pcssDiskSamples[PCSS_SAMPLE_COUNT];\nuniform float pcssSphereSamples[PCSS_SAMPLE_COUNT];\nvec2 vogelDisk(int sampleIndex, float count, float phi, float r) {\n\tconst float GoldenAngle = 2.4;\n\tfloat theta = float(sampleIndex) * GoldenAngle + phi;\n\tfloat sine = sin(theta);\n\tfloat cosine = cos(theta);\n\treturn vec2(r * cosine, r * sine);\n}\nvec3 vogelSphere(int sampleIndex, float count, float phi, float r) {\n\tconst float GoldenAngle = 2.4;\n\tfloat theta = float(sampleIndex) * GoldenAngle + phi;\n\tfloat weight = float(sampleIndex) / count;\n\treturn vec3(cos(theta) * r, weight, sin(theta) * r);\n}\nfloat noise(vec2 screenPos) {\n\tconst float PHI = 1.61803398874989484820459;\n\treturn fract(sin(dot(screenPos * PHI, screenPos)) * screenPos.x);\n}\nfloat viewSpaceDepth(float depth, mat4 invProjection) {\n\tfloat z = depth * 2.0 - 1.0;\n\tvec4 clipSpace = vec4(0.0, 0.0, z, 1.0);\n\tvec4 viewSpace = invProjection * clipSpace;\n\treturn viewSpace.z;\n}\nfloat PCSSBlockerDistance(TEXTURE_ACCEPT(shadowMap), vec2 sampleCoords[PCSS_SAMPLE_COUNT], vec2 shadowCoords, vec2 searchSize, float z, vec4 cameraParams) {\n\tfloat blockers = 0.0;\n\tfloat averageBlocker = 0.0;\n\tfor (int i = 0; i < PCSS_SAMPLE_COUNT; i++) {\n\t\tvec2 offset = sampleCoords[i] * searchSize;\n\t\tvec2 sampleUV = shadowCoords + offset;\n\t\tfloat blocker = texture2DLod(shadowMap, sampleUV, 0.0).r;\n\t\tfloat isBlocking = step(blocker, z);\n\t\tblockers += isBlocking;\n\t\taverageBlocker += blocker * isBlocking;\n\t}\n\tif (blockers > 0.0)\n\t\treturn averageBlocker / blockers;\n\treturn -1.0;\n}\nfloat PCSS(TEXTURE_ACCEPT(shadowMap), vec3 shadowCoords, vec4 cameraParams, vec2 shadowSearchArea) {\n\tfloat receiverDepth = linearizeDepth(shadowCoords.z, cameraParams);\n\tvec2 samplePoints[PCSS_SAMPLE_COUNT];\n\tfloat noise = noise( gl_FragCoord.xy ) * 2.0 * PI;\n\tfor (int i = 0; i < PCSS_SAMPLE_COUNT; i++) {\n\t\tfloat pcssPresample = pcssDiskSamples[i];\n\t\tsamplePoints[i] = vogelDisk(i, float(PCSS_SAMPLE_COUNT), noise, pcssPresample);\n\t}\n\tfloat averageBlocker = PCSSBlockerDistance(TEXTURE_PASS(shadowMap), samplePoints, shadowCoords.xy, shadowSearchArea, receiverDepth, cameraParams);\n\tif (averageBlocker == -1.0) {\n\t\treturn 1.0;\n\t} else {\n\t\tfloat depthDifference = (receiverDepth - averageBlocker) / 3.0;\n\t\tvec2 filterRadius = depthDifference * shadowSearchArea;\n\t\tfloat shadow = 0.0;\n\t\tfor (int i = 0; i < PCSS_SAMPLE_COUNT; i ++)\n\t\t{\n\t\t\tvec2 sampleUV = samplePoints[i] * filterRadius;\n\t\t\tsampleUV = shadowCoords.xy + sampleUV;\n\t\t\tfloat depth = texture2DLod(shadowMap, sampleUV, 0.0).r;\n\t\t\tshadow += step(receiverDepth, depth);\n\t\t}\n\t\treturn shadow / float(PCSS_SAMPLE_COUNT);\n\t} \n}\n#ifndef WEBGPU\nfloat PCSSCubeBlockerDistance(samplerCube shadowMap, vec3 lightDirNorm, vec3 samplePoints[PCSS_SAMPLE_COUNT], float z, float shadowSearchArea) {\n\tfloat blockers = 0.0;\n\tfloat averageBlocker = 0.0;\n\tfor (int i = 0; i < PCSS_SAMPLE_COUNT; i++) {\n\t\tvec3 sampleDir = lightDirNorm + samplePoints[i] * shadowSearchArea;\n\t\tsampleDir = normalize(sampleDir);\n\t\tfloat blocker = textureCubeLod(shadowMap, sampleDir, 0.0).r;\n\t\tfloat isBlocking = step(blocker, z);\n\t\tblockers += isBlocking;\n\t\taverageBlocker += blocker * isBlocking;\n\t}\n\tif (blockers > 0.0)\n\t\treturn averageBlocker / blockers;\n\treturn -1.0;\n}\nfloat PCSSCube(samplerCube shadowMap, vec4 shadowParams, vec3 shadowCoords, vec4 cameraParams, float shadowSearchArea, vec3 lightDir) {\n\t\n\tvec3 samplePoints[PCSS_SAMPLE_COUNT];\n\tfloat noise = noise( gl_FragCoord.xy ) * 2.0 * PI;\n\tfor (int i = 0; i < PCSS_SAMPLE_COUNT; i++) {\n\t\tfloat r = pcssSphereSamples[i];\n\t\tsamplePoints[i] = vogelSphere(i, float(PCSS_SAMPLE_COUNT), noise, r);\n\t}\n\tfloat receiverDepth = length(lightDir) * shadowParams.w + shadowParams.z;\n\tvec3 lightDirNorm = normalize(lightDir);\n\t\n\tfloat averageBlocker = PCSSCubeBlockerDistance(shadowMap, lightDirNorm, samplePoints, receiverDepth, shadowSearchArea);\n\tif (averageBlocker == -1.0) {\n\t\treturn 1.0;\n\t} else {\n\t\tfloat filterRadius = ((receiverDepth - averageBlocker) / averageBlocker) * shadowSearchArea;\n\t\tfloat shadow = 0.0;\n\t\tfor (int i = 0; i < PCSS_SAMPLE_COUNT; i++)\n\t\t{\n\t\t\tvec3 offset = samplePoints[i] * filterRadius;\n\t\t\tvec3 sampleDir = lightDirNorm + offset;\n\t\t\tsampleDir = normalize(sampleDir);\n\t\t\tfloat depth = textureCubeLod(shadowMap, sampleDir, 0.0).r;\n\t\t\tshadow += step(receiverDepth, depth);\n\t\t}\n\t\treturn shadow / float(PCSS_SAMPLE_COUNT);\n\t}\n}\nfloat getShadowPointPCSS(samplerCube shadowMap, vec3 shadowCoord, vec4 shadowParams, vec4 cameraParams, vec2 shadowSearchArea, vec3 lightDir) {\n\treturn PCSSCube(shadowMap, shadowParams, shadowCoord, cameraParams, shadowSearchArea.x, lightDir);\n}\n#endif\nfloat getShadowSpotPCSS(TEXTURE_ACCEPT(shadowMap), vec3 shadowCoord, vec4 shadowParams, vec4 cameraParams, vec2 shadowSearchArea, vec3 lightDir) {\n\treturn PCSS(TEXTURE_PASS(shadowMap), shadowCoord, cameraParams, shadowSearchArea);\n}\n",shadowSampleCoordPS:"\nvec3 getShadowSampleCoord$LIGHT(mat4 shadowTransform, vec4 shadowParams, vec3 worldPosition, vec3 lightPos, inout vec3 lightDir, vec3 lightDirNorm, vec3 normal) {\n\tvec3 surfacePosition = worldPosition;\n#ifdef SHADOW_SAMPLE_POINT\n\t#ifdef SHADOW_SAMPLE_NORMAL_OFFSET\n\t\tfloat distScale = length(lightDir);\n\t\tsurfacePosition = surfacePosition + normal * shadowParams.y * clamp(1.0 - dot(normal, -lightDirNorm), 0.0, 1.0) * distScale;\n\t\tlightDir = surfacePosition - lightPos;\n\t\treturn lightDir;\n\t#endif\n#else\n\t#ifdef SHADOW_SAMPLE_SOURCE_ZBUFFER\n\t\t#ifdef SHADOW_SAMPLE_NORMAL_OFFSET\n\t\t\tsurfacePosition = surfacePosition + normal * shadowParams.y;\n\t\t#endif\n\t#else\n\t\t#ifdef SHADOW_SAMPLE_NORMAL_OFFSET\n\t\t\t#ifdef SHADOW_SAMPLE_ORTHO\n\t\t\t\tfloat distScale = 1.0;\n\t\t\t#else\n\t\t\t\tfloat distScale = abs(dot(vPositionW - lightPos, lightDirNorm));\n\t\t\t#endif\n\t\t\tsurfacePosition = surfacePosition + normal * shadowParams.y * clamp(1.0 - dot(normal, -lightDirNorm), 0.0, 1.0) * distScale;\n\t\t#endif\n\t#endif\n\tvec4 positionInShadowSpace = shadowTransform * vec4(surfacePosition, 1.0);\n\t#ifdef SHADOW_SAMPLE_ORTHO\n\t\tpositionInShadowSpace.z = saturate(positionInShadowSpace.z) - 0.0001;\n\t#else\n\t\t#ifdef SHADOW_SAMPLE_SOURCE_ZBUFFER\n\t\t\tpositionInShadowSpace.xyz /= positionInShadowSpace.w;\n\t\t#else\n\t\t\tpositionInShadowSpace.xy /= positionInShadowSpace.w;\n\t\t\tpositionInShadowSpace.z = length(lightDir) * shadowParams.w;\n\t\t#endif\n\t#endif\n\t#ifdef SHADOW_SAMPLE_Z_BIAS\n\t\tpositionInShadowSpace.z += getShadowBias(shadowParams.x, shadowParams.z);\n\t#endif\n\tsurfacePosition = positionInShadowSpace.xyz;\n#endif\n\treturn surfacePosition;\n}\n",shadowSoftPS:"\nhighp float fractSinRand( const in vec2 uv ) {\n\tconst highp float a = 12.9898, b = 78.233, c = 43758.5453;\n\thighp float dt = dot(uv.xy, vec2(a, b)), sn = mod(dt, PI);\n\treturn fract(sin(sn) * c);\n}\nstruct PoissonDiskData {\n\tfloat invNumSamples;\n\tfloat angleStep;\n\tfloat initialAngle;\n\tfloat currentRadius;\n\tfloat currentAngle;\n};\nvoid preparePoissonConstants(out PoissonDiskData data, int sampleCount, int numRings, float randomSeed) {\n\tconst float pi2 = 6.28318530718;\n\tdata.invNumSamples = 1.0 / float(sampleCount);\n\tdata.angleStep = pi2 * float(numRings) * data.invNumSamples;\n\tdata.initialAngle = randomSeed * pi2;\n\tdata.currentRadius = data.invNumSamples;\n\tdata.currentAngle = data.initialAngle;\n}\nvec2 generatePoissonSample(inout PoissonDiskData data) {\n\tvec2 offset = vec2(cos(data.currentAngle), sin(data.currentAngle)) * pow(data.currentRadius, 0.75);\n\tdata.currentRadius += data.invNumSamples;\n\tdata.currentAngle += data.angleStep;\n\treturn offset;\n}\nvoid PCSSFindBlocker(TEXTURE_ACCEPT(shadowMap), out float avgBlockerDepth, out int numBlockers,\n\tvec2 shadowCoords, float z, int shadowBlockerSamples, float penumbraSize, float invShadowMapSize, float randomSeed) {\n\tPoissonDiskData poissonData;\n\tpreparePoissonConstants(poissonData, shadowBlockerSamples, 11, randomSeed);\n\tfloat searchWidth = penumbraSize * invShadowMapSize;\n\tfloat blockerSum = 0.0;\n\tnumBlockers = 0;\n\tfor( int i = 0; i < shadowBlockerSamples; ++i ) {\n\t\tvec2 poissonUV = generatePoissonSample(poissonData);\n\t\tvec2 sampleUV = shadowCoords + poissonUV * searchWidth;\n\t\tfloat shadowMapDepth = texture2DLod(shadowMap, sampleUV, 0.0).r;\n\t\tif ( shadowMapDepth < z ) {\n\t\t\tblockerSum += shadowMapDepth;\n\t\t\tnumBlockers++;\n\t\t}\n\t}\n\tavgBlockerDepth = blockerSum / float(numBlockers);\n}\nfloat PCSSFilter(TEXTURE_ACCEPT(shadowMap), vec2 uv, float receiverDepth, int shadowSamples, float filterRadius, float randomSeed) {\n \n\tPoissonDiskData poissonData;\n\tpreparePoissonConstants(poissonData, shadowSamples, 11, randomSeed);\n\tfloat sum = 0.0f;\n\tfor ( int i = 0; i < shadowSamples; ++i )\n\t{\n\t\tvec2 poissonUV = generatePoissonSample(poissonData);\n\t\tvec2 sampleUV = uv + poissonUV * filterRadius;\n\t\tfloat depth = texture2DLod(shadowMap, sampleUV, 0.0).r;\n\t\tsum += step(receiverDepth, depth);\n\t}\n\treturn sum / float(shadowSamples);\n} \nfloat getPenumbra(float dblocker, float dreceiver, float penumbraSize, float penumbraFalloff) {\n\tfloat dist = dreceiver - dblocker;\n\tfloat penumbra = 1.0 - pow(1.0 - dist, penumbraFalloff);\n\treturn penumbra * penumbraSize;\n}\nfloat PCSSDirectional(TEXTURE_ACCEPT(shadowMap), vec3 shadowCoords, vec4 cameraParams, vec4 softShadowParams) {\n\tfloat receiverDepth = shadowCoords.z;\n\tfloat randomSeed = fractSinRand(gl_FragCoord.xy);\n\tint shadowSamples = int(softShadowParams.x);\n\tint shadowBlockerSamples = int(softShadowParams.y);\n\tfloat penumbraSize = softShadowParams.z;\n\tfloat penumbraFalloff = softShadowParams.w;\n\tint shadowMapSize = textureSize(shadowMap, 0).x;\n\tfloat invShadowMapSize = 1.0 / float(shadowMapSize);\n\tinvShadowMapSize *= float(shadowMapSize) / 2048.0;\n\tfloat penumbra;\n\tif (shadowBlockerSamples > 0) {\n\t\tfloat avgBlockerDepth = 0.0;\n\t\tint numBlockers = 0;\n\t\tPCSSFindBlocker(TEXTURE_PASS(shadowMap), avgBlockerDepth, numBlockers, shadowCoords.xy, receiverDepth, shadowBlockerSamples, penumbraSize, invShadowMapSize, randomSeed);\n\t\tif (numBlockers < 1)\n\t\t\treturn 1.0f;\n\t\tpenumbra = getPenumbra(avgBlockerDepth, shadowCoords.z, penumbraSize, penumbraFalloff);\n\t} else {\n\t\tpenumbra = penumbraSize;\n\t}\n\tfloat filterRadius = penumbra * invShadowMapSize;\n\treturn PCSSFilter(TEXTURE_PASS(shadowMap), shadowCoords.xy, receiverDepth, shadowSamples, filterRadius, randomSeed);\n}\nfloat getShadowPCSS(TEXTURE_ACCEPT(shadowMap), vec3 shadowCoord, vec4 shadowParams, vec4 cameraParams, vec4 softShadowParams, vec3 lightDir) {\n\treturn PCSSDirectional(TEXTURE_PASS(shadowMap), shadowCoord, cameraParams, softShadowParams);\n}\n",shadowStandardPS:"\nfloat _getShadowPCF3x3(SHADOWMAP_ACCEPT(shadowMap), vec3 shadowCoord, vec3 shadowParams) {\n\tfloat z = shadowCoord.z;\n\tvec2 uv = shadowCoord.xy * shadowParams.x;\n\tfloat shadowMapSizeInv = 1.0 / shadowParams.x;\n\tvec2 base_uv = floor(uv + 0.5);\n\tfloat s = (uv.x + 0.5 - base_uv.x);\n\tfloat t = (uv.y + 0.5 - base_uv.y);\n\tbase_uv -= vec2(0.5);\n\tbase_uv *= shadowMapSizeInv;\n\tfloat sum = 0.0;\n\tfloat uw0 = (3.0 - 2.0 * s);\n\tfloat uw1 = (1.0 + 2.0 * s);\n\tfloat u0 = (2.0 - s) / uw0 - 1.0;\n\tfloat u1 = s / uw1 + 1.0;\n\tfloat vw0 = (3.0 - 2.0 * t);\n\tfloat vw1 = (1.0 + 2.0 * t);\n\tfloat v0 = (2.0 - t) / vw0 - 1.0;\n\tfloat v1 = t / vw1 + 1.0;\n\tu0 = u0 * shadowMapSizeInv + base_uv.x;\n\tv0 = v0 * shadowMapSizeInv + base_uv.y;\n\tu1 = u1 * shadowMapSizeInv + base_uv.x;\n\tv1 = v1 * shadowMapSizeInv + base_uv.y;\n\tsum += uw0 * vw0 * textureShadow(shadowMap, vec3(u0, v0, z));\n\tsum += uw1 * vw0 * textureShadow(shadowMap, vec3(u1, v0, z));\n\tsum += uw0 * vw1 * textureShadow(shadowMap, vec3(u0, v1, z));\n\tsum += uw1 * vw1 * textureShadow(shadowMap, vec3(u1, v1, z));\n\tsum *= 1.0f / 16.0;\n\treturn sum;\n}\nfloat getShadowPCF3x3(SHADOWMAP_ACCEPT(shadowMap), vec3 shadowCoord, vec4 shadowParams) {\n\treturn _getShadowPCF3x3(SHADOWMAP_PASS(shadowMap), shadowCoord, shadowParams.xyz);\n}\nfloat getShadowSpotPCF3x3(SHADOWMAP_ACCEPT(shadowMap), vec3 shadowCoord, vec4 shadowParams) {\n\treturn _getShadowPCF3x3(SHADOWMAP_PASS(shadowMap), shadowCoord, shadowParams.xyz);\n}\nfloat getShadowPCF1x1(SHADOWMAP_ACCEPT(shadowMap), vec3 shadowCoord, vec4 shadowParams) {\n\treturn textureShadow(shadowMap, shadowCoord);\n}\nfloat getShadowSpotPCF1x1(SHADOWMAP_ACCEPT(shadowMap), vec3 shadowCoord, vec4 shadowParams) {\n\treturn textureShadow(shadowMap, shadowCoord);\n}\n#ifndef WEBGPU\nfloat getShadowPointPCF3x3(samplerCubeShadow shadowMap, vec4 shadowParams, vec3 dir) {\n\t\n\tfloat shadowZ = length(dir) * shadowParams.w + shadowParams.z;\n\tfloat z = 1.0 / float(textureSize(shadowMap, 0));\n\tvec3 tc = normalize(dir);\n\tmediump vec4 shadows;\n\tshadows.x = texture(shadowMap, vec4(tc + vec3( z, z, z), shadowZ));\n\tshadows.y = texture(shadowMap, vec4(tc + vec3(-z,-z, z), shadowZ));\n\tshadows.z = texture(shadowMap, vec4(tc + vec3(-z, z,-z), shadowZ));\n\tshadows.w = texture(shadowMap, vec4(tc + vec3( z,-z,-z), shadowZ));\n\treturn dot(shadows, vec4(0.25));\n}\nfloat getShadowPointPCF1x1(samplerCubeShadow shadowMap, vec3 shadowCoord, vec4 shadowParams, vec3 lightDir) {\n\tfloat shadowZ = length(lightDir) * shadowParams.w + shadowParams.z;\n\treturn texture(shadowMap, vec4(lightDir, shadowZ));\n}\nfloat getShadowPointPCF3x3(samplerCubeShadow shadowMap, vec3 shadowCoord, vec4 shadowParams, vec3 lightDir) {\n\treturn getShadowPointPCF3x3(shadowMap, shadowParams, lightDir);\n}\n#endif\n",shadowStandardGL2PS:"\nfloat _getShadowPCF5x5(SHADOWMAP_ACCEPT(shadowMap), vec3 shadowCoord, vec3 shadowParams) {\n\tfloat z = shadowCoord.z;\n\tvec2 uv = shadowCoord.xy * shadowParams.x;\n\tfloat shadowMapSizeInv = 1.0 / shadowParams.x;\n\tvec2 base_uv = floor(uv + 0.5);\n\tfloat s = (uv.x + 0.5 - base_uv.x);\n\tfloat t = (uv.y + 0.5 - base_uv.y);\n\tbase_uv -= vec2(0.5);\n\tbase_uv *= shadowMapSizeInv;\n\tfloat uw0 = (4.0 - 3.0 * s);\n\tfloat uw1 = 7.0;\n\tfloat uw2 = (1.0 + 3.0 * s);\n\tfloat u0 = (3.0 - 2.0 * s) / uw0 - 2.0;\n\tfloat u1 = (3.0 + s) / uw1;\n\tfloat u2 = s / uw2 + 2.0;\n\tfloat vw0 = (4.0 - 3.0 * t);\n\tfloat vw1 = 7.0;\n\tfloat vw2 = (1.0 + 3.0 * t);\n\tfloat v0 = (3.0 - 2.0 * t) / vw0 - 2.0;\n\tfloat v1 = (3.0 + t) / vw1;\n\tfloat v2 = t / vw2 + 2.0;\n\tfloat sum = 0.0;\n\tu0 = u0 * shadowMapSizeInv + base_uv.x;\n\tv0 = v0 * shadowMapSizeInv + base_uv.y;\n\tu1 = u1 * shadowMapSizeInv + base_uv.x;\n\tv1 = v1 * shadowMapSizeInv + base_uv.y;\n\tu2 = u2 * shadowMapSizeInv + base_uv.x;\n\tv2 = v2 * shadowMapSizeInv + base_uv.y;\n\tsum += uw0 * vw0 * textureShadow(shadowMap, vec3(u0, v0, z));\n\tsum += uw1 * vw0 * textureShadow(shadowMap, vec3(u1, v0, z));\n\tsum += uw2 * vw0 * textureShadow(shadowMap, vec3(u2, v0, z));\n\tsum += uw0 * vw1 * textureShadow(shadowMap, vec3(u0, v1, z));\n\tsum += uw1 * vw1 * textureShadow(shadowMap, vec3(u1, v1, z));\n\tsum += uw2 * vw1 * textureShadow(shadowMap, vec3(u2, v1, z));\n\tsum += uw0 * vw2 * textureShadow(shadowMap, vec3(u0, v2, z));\n\tsum += uw1 * vw2 * textureShadow(shadowMap, vec3(u1, v2, z));\n\tsum += uw2 * vw2 * textureShadow(shadowMap, vec3(u2, v2, z));\n\tsum *= 1.0f / 144.0;\n\tsum = saturate(sum);\n\treturn sum;\n}\nfloat getShadowPCF5x5(SHADOWMAP_ACCEPT(shadowMap), vec3 shadowCoord, vec4 shadowParams) {\n\treturn _getShadowPCF5x5(SHADOWMAP_PASS(shadowMap), shadowCoord, shadowParams.xyz);\n}\nfloat getShadowSpotPCF5x5(SHADOWMAP_ACCEPT(shadowMap), vec3 shadowCoord, vec4 shadowParams) {\n\treturn _getShadowPCF5x5(SHADOWMAP_PASS(shadowMap), shadowCoord, shadowParams.xyz);\n}\n",shadowVSM_commonPS:"\nfloat linstep(float a, float b, float v) {\n\treturn saturate((v - a) / (b - a));\n}\nfloat reduceLightBleeding(float pMax, float amount) {\n   return linstep(amount, 1.0, pMax);\n}\nfloat chebyshevUpperBound(vec2 moments, float mean, float minVariance, float lightBleedingReduction) {\n\tfloat variance = moments.y - (moments.x * moments.x);\n\tvariance = max(variance, minVariance);\n\tfloat d = mean - moments.x;\n\tfloat pMax = variance / (variance + (d * d));\n\tpMax = reduceLightBleeding(pMax, lightBleedingReduction);\n\treturn (mean <= moments.x ? 1.0 : pMax);\n}\nfloat calculateEVSM(vec3 moments, float Z, float vsmBias, float exponent) {\n\tZ = 2.0 * Z - 1.0;\n\tfloat warpedDepth = exp(exponent * Z);\n\tmoments.xy += vec2(warpedDepth, warpedDepth*warpedDepth) * (1.0 - moments.z);\n\tfloat VSMBias = vsmBias;\n\tfloat depthScale = VSMBias * exponent * warpedDepth;\n\tfloat minVariance1 = depthScale * depthScale;\n\treturn chebyshevUpperBound(moments.xy, warpedDepth, minVariance1, 0.1);\n}\n",skinBatchVS:"\nattribute float vertex_boneIndices;\nuniform highp sampler2D texture_poseMap;\nuniform vec4 texture_poseMapSize;\nmat4 getBoneMatrix(const in float i) {\n\tfloat j = i * 3.0;\n\tfloat dx = texture_poseMapSize.z;\n\tfloat dy = texture_poseMapSize.w;\n\tfloat y = floor(j * dx);\n\tfloat x = j - (y * texture_poseMapSize.x);\n\ty = dy * (y + 0.5);\n\tvec4 v1 = texture2D(texture_poseMap, vec2(dx * (x + 0.5), y));\n\tvec4 v2 = texture2D(texture_poseMap, vec2(dx * (x + 1.5), y));\n\tvec4 v3 = texture2D(texture_poseMap, vec2(dx * (x + 2.5), y));\n\treturn mat4(\n\t\tv1.x, v2.x, v3.x, 0,\n\t\tv1.y, v2.y, v3.y, 0,\n\t\tv1.z, v2.z, v3.z, 0,\n\t\tv1.w, v2.w, v3.w, 1\n\t);\n}\n",skinVS:"\nattribute vec4 vertex_boneWeights;\nattribute vec4 vertex_boneIndices;\nuniform highp sampler2D texture_poseMap;\nuniform vec4 texture_poseMapSize;\nvoid getBoneMatrix(const in float index, out vec4 v1, out vec4 v2, out vec4 v3) {\n\tfloat i = float(index);\n\tfloat j = i * 3.0;\n\tfloat dx = texture_poseMapSize.z;\n\tfloat dy = texture_poseMapSize.w;\n\t\n\tfloat y = floor(j * dx);\n\tfloat x = j - (y * texture_poseMapSize.x);\n\ty = dy * (y + 0.5);\n\tv1 = texture2D(texture_poseMap, vec2(dx * (x + 0.5), y));\n\tv2 = texture2D(texture_poseMap, vec2(dx * (x + 1.5), y));\n\tv3 = texture2D(texture_poseMap, vec2(dx * (x + 2.5), y));\n}\nmat4 getSkinMatrix(const in vec4 indices, const in vec4 weights) {\n\tvec4 a1, a2, a3;\n\tgetBoneMatrix(indices.x, a1, a2, a3);\n\tvec4 b1, b2, b3;\n\tgetBoneMatrix(indices.y, b1, b2, b3);\n\tvec4 c1, c2, c3;\n\tgetBoneMatrix(indices.z, c1, c2, c3);\n\tvec4 d1, d2, d3;\n\tgetBoneMatrix(indices.w, d1, d2, d3);\n\tvec4 v1 = a1 * weights.x + b1 * weights.y + c1 * weights.z + d1 * weights.w;\n\tvec4 v2 = a2 * weights.x + b2 * weights.y + c2 * weights.z + d2 * weights.w;\n\tvec4 v3 = a3 * weights.x + b3 * weights.y + c3 * weights.z + d3 * weights.w;\n\tfloat one = dot(weights, vec4(1.0));\n\treturn mat4(\n\t\tv1.x, v2.x, v3.x, 0,\n\t\tv1.y, v2.y, v3.y, 0,\n\t\tv1.z, v2.z, v3.z, 0,\n\t\tv1.w, v2.w, v3.w, one\n\t);\n}\n",skyboxPS:'\n\t#include "envMultiplyPS"\n\t#include "gammaPS"\n\t#include "tonemappingPS"\n\tvarying vec3 vViewDir;\n\tuniform float skyboxHighlightMultiplier;\n\t#ifdef SKY_CUBEMAP\n\t\tuniform samplerCube texture_cubeMap;\n\t\t#ifdef SKYMESH\n\t\t\tvarying vec3 vWorldPos;\n\t\t\tuniform mat3 cubeMapRotationMatrix;\n\t\t\tuniform vec3 projectedSkydomeCenter;\n\t\t#endif\n\t#else\n\t\t#include "sphericalPS"\n\t\t#include "envAtlasPS"\n\t\tuniform sampler2D texture_envAtlas;\n\t\tuniform float mipLevel;\n\t#endif\n\tvoid main(void) {\n\t\t#ifdef SKY_CUBEMAP\n\t\t\t#ifdef SKYMESH\n\t\t\t\tvec3 envDir = normalize(vWorldPos - projectedSkydomeCenter);\n\t\t\t\tvec3 dir = envDir * cubeMapRotationMatrix;\n\t\t\t#else\n\t\t\t\tvec3 dir = vViewDir;\n\t\t\t#endif\n\t\t\tdir.x *= -1.0;\n\t\t\tvec3 linear = __INJECT_SKYBOX_DECODE_FNC(textureCube(texture_cubeMap, dir));\n\t\t#else\n\t\t\tvec3 dir = vViewDir * vec3(-1.0, 1.0, 1.0);\n\t\t\tvec2 uv = toSphericalUv(normalize(dir));\n\t\t\tvec3 linear = __INJECT_SKYBOX_DECODE_FNC(texture2D(texture_envAtlas, mapRoughnessUv(uv, mipLevel)));\n\t\t#endif\n\t\tif (any(greaterThanEqual(linear, vec3(64.0)))) {\n\t\t\tlinear *= skyboxHighlightMultiplier;\n\t\t}\n\t\tgl_FragColor = vec4(gammaCorrectOutput(toneMap(processEnvironment(linear))), 1.0);\n\t}\n',skyboxVS:"\nattribute vec3 aPosition;\n#ifndef VIEWMATRIX\n#define VIEWMATRIX\nuniform mat4 matrix_view;\n#endif\nuniform mat4 matrix_projectionSkybox;\nuniform mat3 cubeMapRotationMatrix;\nvarying vec3 vViewDir;\n#ifdef SKYMESH\n\tuniform mat4 matrix_model;\n\tvarying vec3 vWorldPos;\n#endif\nvoid main(void) {\n\tmat4 view = matrix_view;\n\t#ifdef SKYMESH\n\t\tvec4 worldPos = matrix_model * vec4(aPosition, 1.0);\n\t\tvWorldPos = worldPos.xyz;\n\t\tgl_Position = matrix_projectionSkybox * view * worldPos;\n\t#else\n\t\tview[3][0] = view[3][1] = view[3][2] = 0.0;\n\t\tgl_Position = matrix_projectionSkybox * view * vec4(aPosition, 1.0);\n\t\tvViewDir = aPosition * cubeMapRotationMatrix;\n\t#endif\n\tgl_Position.z = gl_Position.w - 1.0e-7;\n}\n",specularPS:"\n#ifdef MAPCOLOR\nuniform vec3 material_specular;\n#endif\nvoid getSpecularity() {\n\tvec3 specularColor = vec3(1,1,1);\n\t#ifdef MAPCOLOR\n\tspecularColor *= material_specular;\n\t#endif\n\t#ifdef MAPTEXTURE\n\tspecularColor *= $DECODE(texture2DBias($SAMPLER, $UV, textureBias)).$CH;\n\t#endif\n\t#ifdef MAPVERTEX\n\tspecularColor *= saturate(vVertexColor.$VC);\n\t#endif\n\tdSpecularity = specularColor;\n}\n",sphericalPS:"\nconst float PI = 3.141592653589793;\nvec2 toSpherical(vec3 dir) {\n\treturn vec2(dir.xz == vec2(0.0) ? 0.0 : atan(dir.x, dir.z), asin(dir.y));\n}\nvec2 toSphericalUv(vec3 dir) {\n\tvec2 uv = toSpherical(dir) / vec2(PI * 2.0, PI) + 0.5;\n\treturn vec2(uv.x, 1.0 - uv.y);\n}\n",specularityFactorPS:"\n#ifdef MAPFLOAT\nuniform float material_specularityFactor;\n#endif\nvoid getSpecularityFactor() {\n\tfloat specularityFactor = 1.0;\n\t#ifdef MAPFLOAT\n\tspecularityFactor *= material_specularityFactor;\n\t#endif\n\t#ifdef MAPTEXTURE\n\tspecularityFactor *= texture2DBias($SAMPLER, $UV, textureBias).$CH;\n\t#endif\n\t#ifdef MAPVERTEX\n\tspecularityFactor *= saturate(vVertexColor.$VC);\n\t#endif\n\tdSpecularityFactor = specularityFactor;\n}\n",spotPS:"\nfloat getSpotEffect(vec3 lightSpotDir, float lightInnerConeAngle, float lightOuterConeAngle, vec3 lightDirNorm) {\n\tfloat cosAngle = dot(lightDirNorm, lightSpotDir);\n\treturn smoothstep(lightOuterConeAngle, lightInnerConeAngle, cosAngle);\n}\n",startPS:"\nvoid main(void) {\n\tdReflection = vec4(0);\n\t#ifdef LIT_CLEARCOAT\n\tccSpecularLight = vec3(0);\n\tccReflection = vec3(0);\n\t#endif\n",startVS:"\nvoid main(void) {\n\tgl_Position = getPosition();\n",startNineSlicedPS:"\n\tnineSlicedUv = vUv0;\n\tnineSlicedUv.y = 1.0 - nineSlicedUv.y;\n",startNineSlicedTiledPS:"\n\tvec2 tileMask = step(vMask, vec2(0.99999));\n\tvec2 tileSize = 0.5 * (innerOffset.xy + innerOffset.zw);\n\tvec2 tileScale = vec2(1.0) / (vec2(1.0) - tileSize);\n\tvec2 clampedUv = mix(innerOffset.xy * 0.5, vec2(1.0) - innerOffset.zw * 0.5, fract((vTiledUv - tileSize) * tileScale));\n\tclampedUv = clampedUv * atlasRect.zw + atlasRect.xy;\n\tnineSlicedUv = vUv0 * tileMask + clampedUv * (vec2(1.0) - tileMask);\n\tnineSlicedUv.y = 1.0 - nineSlicedUv.y;\n\t\n",storeEVSMPS:"\nfloat exponent = VSM_EXPONENT;\ndepth = 2.0 * depth - 1.0;\ndepth =  exp(exponent * depth);\ngl_FragColor = vec4(depth, depth*depth, 1.0, 1.0);\n",tangentBinormalVS:"\nvec3 getTangent() {\n\treturn normalize(dNormalMatrix * vertex_tangent.xyz);\n}\nvec3 getBinormal() {\n\treturn cross(vNormalW, vTangentW) * vertex_tangent.w;\n}\n",TBNPS:"\nvoid getTBN(vec3 tangent, vec3 binormal, vec3 normal) {\n\tdTBN = mat3(normalize(tangent), normalize(binormal), normalize(normal));\n}\n",TBNderivativePS:"\nuniform float tbnBasis;\nvoid getTBN(vec3 tangent, vec3 binormal, vec3 normal) {\n\tvec2 uv = $UV;\n\tvec3 dp1 = dFdx( vPositionW );\n\tvec3 dp2 = dFdy( vPositionW );\n\tvec2 duv1 = dFdx( uv );\n\tvec2 duv2 = dFdy( uv );\n\tvec3 dp2perp = cross( dp2, normal );\n\tvec3 dp1perp = cross( normal, dp1 );\n\tvec3 T = dp2perp * duv1.x + dp1perp * duv2.x;\n\tvec3 B = dp2perp * duv1.y + dp1perp * duv2.y;\n\tfloat denom = max( dot(T,T), dot(B,B) );\n\tfloat invmax = (denom == 0.0) ? 0.0 : tbnBasis / sqrt( denom );\n\tdTBN = mat3(T * invmax, -B * invmax, normal );\n}\n",TBNObjectSpacePS:"\nvoid getTBN(vec3 tangent, vec3 binormal, vec3 normal) {\n\tvec3 B = cross(normal, vObjectSpaceUpW);\n\tvec3 T = cross(normal, B);\n\tif (dot(B,B)==0.0)\n\t{\n\t\tfloat major=max(max(normal.x, normal.y), normal.z);\n\t\tif (normal.x == major)\n\t\t{\n\t\t\tB=cross(normal, vec3(0,1,0));\n\t\t\tT=cross(normal, B);\n\t\t}\n\t\telse if (normal.y == major)\n\t\t{\n\t\t\tB=cross(normal, vec3(0,0,1));\n\t\t\tT=cross(normal, B);\n\t\t}\n\t\telse if (normal.z == major)\n\t\t{\n\t\t\tB=cross(normal, vec3(1,0,0));\n\t\t\tT=cross(normal, B);\n\t\t}\n\t}\n\tdTBN = mat3(normalize(T), normalize(B), normalize(normal));\n}\n",thicknessPS:"\n#ifdef MAPFLOAT\nuniform float material_thickness;\n#endif\nvoid getThickness() {\n\tdThickness = 1.0;\n\t#ifdef MAPFLOAT\n\tdThickness *= material_thickness;\n\t#endif\n\t#ifdef MAPTEXTURE\n\tdThickness *= texture2DBias($SAMPLER, $UV, textureBias).$CH;\n\t#endif\n\t#ifdef MAPVERTEX\n\tdThickness *= saturate(vVertexColor.$VC);\n\t#endif\n}\n",tonemappingPS:'\n#if (TONEMAP == NONE)\n\t#include "tonemappingNonePS"\n#elif TONEMAP == FILMIC\n\t#include "tonemappingFilmicPS"\n#elif TONEMAP == LINEAR\n\t#include "tonemappingLinearPS"\n#elif TONEMAP == HEJL\n\t#include "tonemappingHejlPS"\n#elif TONEMAP == ACES\n\t#include "tonemappingAcesPS"\n#elif TONEMAP == ACES2\n\t#include "tonemappingAces2PS"\n#elif TONEMAP == NEUTRAL\n\t#include "tonemappingNeutralPS"\n#endif\n',tonemappingAcesPS:"\nuniform float exposure;\nvec3 toneMap(vec3 color) {\n\tfloat tA = 2.51;\n\tfloat tB = 0.03;\n\tfloat tC = 2.43;\n\tfloat tD = 0.59;\n\tfloat tE = 0.14;\n\tvec3 x = color * exposure;\n\treturn (x*(tA*x+tB))/(x*(tC*x+tD)+tE);\n}\n",tonemappingAces2PS:"\nuniform float exposure;\nconst mat3 ACESInputMat = mat3(\n\t0.59719, 0.35458, 0.04823,\n\t0.07600, 0.90834, 0.01566,\n\t0.02840, 0.13383, 0.83777\n);\nconst mat3 ACESOutputMat = mat3(\n\t 1.60475, -0.53108, -0.07367,\n\t-0.10208,  1.10813, -0.00605,\n\t-0.00327, -0.07276,  1.07602\n);\nvec3 RRTAndODTFit(vec3 v) {\n\tvec3 a = v * (v + 0.0245786) - 0.000090537;\n\tvec3 b = v * (0.983729 * v + 0.4329510) + 0.238081;\n\treturn a / b;\n}\nvec3 toneMap(vec3 color) {\n\tcolor *= exposure / 0.6;\n\tcolor = color * ACESInputMat;\n\tcolor = RRTAndODTFit(color);\n\tcolor = color * ACESOutputMat;\n\tcolor = clamp(color, 0.0, 1.0);\n\treturn color;\n}\n",tonemappingFilmicPS:"\nconst float A =  0.15;\nconst float B =  0.50;\nconst float C =  0.10;\nconst float D =  0.20;\nconst float E =  0.02;\nconst float F =  0.30;\nconst float W =  11.2;\nuniform float exposure;\nvec3 uncharted2Tonemap(vec3 x) {\n   return ((x*(A*x+C*B)+D*E)/(x*(A*x+B)+D*F))-E/F;\n}\nvec3 toneMap(vec3 color) {\n\tcolor = uncharted2Tonemap(color * exposure);\n\tvec3 whiteScale = 1.0 / uncharted2Tonemap(vec3(W,W,W));\n\tcolor = color * whiteScale;\n\treturn color;\n}\n",tonemappingHejlPS:"\nuniform float exposure;\nvec3 toneMap(vec3 color) {\n\tcolor *= exposure;\n\tconst float  A = 0.22, B = 0.3, C = .1, D = 0.2, E = .01, F = 0.3;\n\tconst float Scl = 1.25;\n\tvec3 h = max( vec3(0.0), color - vec3(0.004) );\n\treturn (h*((Scl*A)*h+Scl*vec3(C*B,C*B,C*B))+Scl*vec3(D*E,D*E,D*E)) / (h*(A*h+vec3(B,B,B))+vec3(D*F,D*F,D*F)) - Scl*vec3(E/F,E/F,E/F);\n}\n",tonemappingLinearPS:"\nuniform float exposure;\nvec3 toneMap(vec3 color) {\n\treturn color * exposure;\n}\n",tonemappingNeutralPS:"\nuniform float exposure;\nvec3 toneMap(vec3 color) {\n\tcolor *= exposure;\n\tfloat startCompression = 0.8 - 0.04;\n\tfloat desaturation = 0.15;\n\tfloat x = min(color.r, min(color.g, color.b));\n\tfloat offset = x < 0.08 ? x - 6.25 * x * x : 0.04;\n\tcolor -= offset;\n\tfloat peak = max(color.r, max(color.g, color.b));\n\tif (peak < startCompression) return color;\n\tfloat d = 1. - startCompression;\n\tfloat newPeak = 1. - d * d / (peak + d - startCompression);\n\tcolor *= newPeak / peak;\n\tfloat g = 1. - 1. / (desaturation * (peak - newPeak) + 1.);\n\treturn mix(color, newPeak * vec3(1, 1, 1), g);\n}\n",tonemappingNonePS:"\nvec3 toneMap(vec3 color) {\n\treturn color;\n}\n",transformVS:"\n#ifdef PIXELSNAP\nuniform vec4 uScreenSize;\n#endif\n#ifdef SCREENSPACE\nuniform float projectionFlipY;\n#endif\nvec4 evalWorldPosition(vec3 vertexPosition, mat4 modelMatrix) {\n\tvec3 localPos = getLocalPosition(vertexPosition);\n\t#ifdef NINESLICED\n\t\tlocalPos.xz *= outerScale;\n\t\tvec2 positiveUnitOffset = clamp(vertexPosition.xz, vec2(0.0), vec2(1.0));\n\t\tvec2 negativeUnitOffset = clamp(-vertexPosition.xz, vec2(0.0), vec2(1.0));\n\t\tlocalPos.xz += (-positiveUnitOffset * innerOffset.xy + negativeUnitOffset * innerOffset.zw) * vertex_texCoord0.xy;\n\t\tvTiledUv = (localPos.xz - outerScale + innerOffset.xy) * -0.5 + 1.0;\n\t\tlocalPos.xz *= -0.5;\n\t\tlocalPos = localPos.xzy;\n\t#endif\n\tvec4 posW = modelMatrix * vec4(localPos, 1.0);\n\t#ifdef SCREENSPACE\n\t\tposW.zw = vec2(0.0, 1.0);\n\t#endif\n\treturn posW;\n}\nvec4 getPosition() {\n\tdModelMatrix = getModelMatrix();\n\tvec4 posW = evalWorldPosition(vertex_position.xyz, dModelMatrix);\n\tdPositionW = posW.xyz;\n\tvec4 screenPos;\n\t#ifdef UV1LAYOUT\n\tscreenPos = vec4(vertex_texCoord1.xy * 2.0 - 1.0, 0.5, 1);\n\t\t#ifdef WEBGPU\n\t\tscreenPos.y *= -1.0;\n\t\t#endif\n\t#else\n\t#ifdef SCREENSPACE\n\tscreenPos = posW;\n\tscreenPos.y *= projectionFlipY;\n\t#else\n\tscreenPos = matrix_viewProjection * posW;\n\t#endif\n\t#ifdef PIXELSNAP\n\tscreenPos.xy = (screenPos.xy * 0.5) + 0.5;\n\tscreenPos.xy *= uScreenSize.xy;\n\tscreenPos.xy = floor(screenPos.xy);\n\tscreenPos.xy *= uScreenSize.zw;\n\tscreenPos.xy = (screenPos.xy * 2.0) - 1.0;\n\t#endif\n\t#endif\n\treturn screenPos;\n}\nvec3 getWorldPosition() {\n\treturn dPositionW;\n}\n",transformCoreVS:'\nattribute vec4 vertex_position;\nuniform mat4 matrix_viewProjection;\nuniform mat4 matrix_model;\nuniform mat3 matrix_normal;\n#ifdef MORPHING\n\tuniform vec2 morph_tex_params;\n\tattribute uint morph_vertex_id;\n\tivec2 getTextureMorphCoords() {\n\t\tivec2 textureSize = ivec2(morph_tex_params);\n\t\tint morphGridV = int(morph_vertex_id) / textureSize.x;\n\t\tint morphGridU = int(morph_vertex_id) - (morphGridV * textureSize.x);\n\t\t#ifdef WEBGPU\n\t\t\tmorphGridV = textureSize.y - morphGridV - 1;\n\t\t#endif\n\t\treturn ivec2(morphGridU, morphGridV);\n\t}\n\t#ifdef MORPHING_POSITION\n\t\t#ifdef MORPHING_INT\n\t\t\tuniform vec3 aabbSize;\n\t\t\tuniform vec3 aabbMin;\n\t\t\tuniform usampler2D morphPositionTex;\n\t\t#else\n\t\t\tuniform highp sampler2D morphPositionTex;\n\t\t#endif\n\t#endif\n#endif\n#ifdef defined(BATCH)\n\t#include "skinBatchVS"\n\tmat4 getModelMatrix() {\n\t\treturn getBoneMatrix(vertex_boneIndices);\n\t}\n#elif defined(SKIN)\n\t#include "skinVS"\n\tmat4 getModelMatrix() {\n\t\treturn matrix_model * getSkinMatrix(vertex_boneIndices, vertex_boneWeights);\n\t}\n#elif defined(INSTANCING)\n\t#include "transformInstancingVS"\n#else\n\tmat4 getModelMatrix() {\n\t\treturn matrix_model;\n\t}\n#endif\nvec3 getLocalPosition(vec3 vertexPosition) {\n\tvec3 localPos = vertexPosition;\n\t#ifdef MORPHING_POSITION\n\t\tivec2 morphUV = getTextureMorphCoords();\n\t\t#ifdef MORPHING_INT\n\t\t\tvec3 morphPos = vec3(texelFetch(morphPositionTex, ivec2(morphUV), 0).xyz) / 65535.0 * aabbSize + aabbMin;\n\t\t#else\n\t\t\tvec3 morphPos = texelFetch(morphPositionTex, ivec2(morphUV), 0).xyz;\n\t\t#endif\n\t\tlocalPos += morphPos;\n\t#endif\n\treturn localPos;\n}\n',transformInstancingVS:"\nattribute vec4 instance_line1;\nattribute vec4 instance_line2;\nattribute vec4 instance_line3;\nattribute vec4 instance_line4;\nmat4 getModelMatrix() {\n\treturn matrix_model * mat4(instance_line1, instance_line2, instance_line3, instance_line4);\n}\n",transmissionPS:"\n#ifdef MAPFLOAT\nuniform float material_refraction;\n#endif\nvoid getRefraction() {\n\tfloat refraction = 1.0;\n\t#ifdef MAPFLOAT\n\trefraction = material_refraction;\n\t#endif\n\t#ifdef MAPTEXTURE\n\trefraction *= texture2DBias($SAMPLER, $UV, textureBias).$CH;\n\t#endif\n\t#ifdef MAPVERTEX\n\trefraction *= saturate(vVertexColor.$VC);\n\t#endif\n\tdTransmission = refraction;\n}\n",twoSidedLightingPS:"\nuniform float twoSidedLightingNegScaleFactor;\nvoid handleTwoSidedLighting() {\n\tdTBN[2] *= gl_FrontFacing ? twoSidedLightingNegScaleFactor : -twoSidedLightingNegScaleFactor;\n}\n",uv0VS:"\n#ifdef NINESLICED\nvec2 getUv0() {\n\tvec2 uv = vertex_position.xz;\n\tvec2 positiveUnitOffset = clamp(vertex_position.xz, vec2(0.0), vec2(1.0));\n\tvec2 negativeUnitOffset = clamp(-vertex_position.xz, vec2(0.0), vec2(1.0));\n\tuv += (-positiveUnitOffset * innerOffset.xy + negativeUnitOffset * innerOffset.zw) * vertex_texCoord0.xy;\n\tuv = uv * -0.5 + 0.5;\n\tuv = uv * atlasRect.zw + atlasRect.xy;\n\tvMask = vertex_texCoord0.xy;\n\treturn uv;\n}\n#else\nvec2 getUv0() {\n\treturn vertex_texCoord0;\n}\n#endif\n",uv1VS:"\nvec2 getUv1() {\n\treturn vertex_texCoord1;\n}\n",viewDirPS:"\nvoid getViewDir() {\n\tdViewDirW = normalize(view_position - vPositionW);\n}\n",viewNormalVS:"\n#ifndef VIEWMATRIX\n#define VIEWMATRIX\nuniform mat4 matrix_view;\n#endif\nvec3 getViewNormal() {\n\treturn mat3(matrix_view) * vNormalW;\n}\n",webgpuPS:Ba,webgpuVS:Oa},xo=new Ti;function wo(e){return xo.get(e)}class bo{static begin(){return"void main(void)\n{\n"}static end(){return"}\n"}static definesHash(e){var t=Array.from(e).sort(((e,t)=>e[0]>t[0]?1:-1));return Ki(JSON.stringify(t))}}var Co=new Ti;class So{buildShaderDefines(){var e;this.isShadow?e="SHADOW":this.isForward?e="FORWARD":2===this.index?e="DEPTH":3===this.index&&(e="PICK"),this.defines.set(e+"_PASS",""),this.defines.set(this.name.toUpperCase()+"_PASS","")}constructor(e,t,s={}){this.defines=new Map,this.name=e,this.index=t,Object.assign(this,s),this.buildShaderDefines()}}class Ao{static get(e){return Co.get(e,(()=>new Ao))}allocate(e,t){var s=this.passesNamed.get(e);return void 0===s&&(s=new So(e,this.nextIndex,t),this.passesNamed.set(s.name,s),this.passesIndexed[s.index]=s,this.nextIndex++),s}getByIndex(e){return this.passesIndexed[e]}getByName(e){return this.passesNamed.get(e)}constructor(){this.passesNamed=new Map,this.passesIndexed=[],this.nextIndex=0;var e=(e,t,s)=>{this.allocate(e,s)};e("forward",0,{isForward:!0}),e("prepass"),e("depth"),e("pick"),e("shadow")}}function To(){return To=Object.assign||function(e){for(var t=1;t<arguments.length;t++){var s=arguments[t];for(var i in s)Object.prototype.hasOwnProperty.call(s,i)&&(e[i]=s[i])}return e},To.apply(this,arguments)}function Po(e,t,s,i,n,a,r){void 0===a&&(a=!1),void 0===r&&(r={}),"boolean"==typeof a?r.useTransformFeedback=a:"object"==typeof a&&(r=To({},r,a));var o=wo(e),l=o.getCachedShader(i);return l||(l=new Ha(e,Na.createDefinition(e,To({},r,{name:i,vertexCode:t,fragmentCode:s,attributes:n}))),o.setCachedShader(i,l)),l}class Eo extends bo{generateKey(e){return this.key}createShaderDefinition(e,t){return this.shaderDefinition}constructor(e,t){super(),this.key=e,this.shaderDefinition=t}}var ko=(e,t)=>{var s=new Map(e.defines);return t.cameraShaderParams.defines.forEach(((e,t)=>s.set(t,e))),Ao.get(t.device).getByIndex(t.pass).defines.forEach(((e,t)=>s.set(t,e))),s},Mo={type:5,base:0,count:4,indexed:!1},Io=new bt,Do=new bt,Ro=new Fi;class Lo{destroy(){var e,t;null==(e=this.uniformBuffer)||e.destroy(),this.uniformBuffer=null,null==(t=this.bindGroup)||t.destroy(),this.bindGroup=null}render(e,t){var s=this.shader.device;e&&(Io.set(s.vx,s.vy,s.vw,s.vh),Do.set(s.sx,s.sy,s.sw,s.sh),t=null!=t?t:e,s.setViewport(e.x,e.y,e.z,e.w),s.setScissor(t.x,t.y,t.z,t.w)),s.setVertexBuffer(s.quadVertexBuffer,0);var i=this.shader;if(s.setShader(i),s.supportsUniformBuffers){s.setBindGroup(0,s.emptyBindGroup);var n=this.bindGroup;n.update(),s.setBindGroup(1,n);var a=this.uniformBuffer;a?(a.update(Ro),s.setBindGroup(2,Ro.bindGroup,Ro.offsets)):s.setBindGroup(2,s.emptyBindGroup)}s.draw(Mo),e&&(s.setViewport(Io.x,Io.y,Io.z,Io.w),s.setScissor(Do.x,Do.y,Do.z,Do.w))}constructor(e){var t=e.device;if(this.shader=e,t.supportsUniformBuffers){var s=new go;this.shader=function(e,t){var s,i=e.definition,n=(null!=(s=i.name)?s:"shader")+"-id-"+e.id,a=new Eo(n,i),r="shader",o=wo(e.device);o.register(r,a);var l=o.getProgram(r,{},t);return e.definition.shaderLanguage===Ys&&(l.meshUniformBufferFormat=i.meshUniformBufferFormat,l.meshBindGroupFormat=i.meshBindGroupFormat),o.unregister(r),l}(e,s);var i=this.shader.meshUniformBufferFormat;i&&(this.uniformBuffer=new Xa(t,i,!1));var n=this.shader.meshBindGroupFormat;this.bindGroup=new Bi(t,n)}}}class Fo extends Or{execute(){var{device:e}=this;e.setCullMode(0),e.setDepthState(Hi.NODEPTH),e.setStencilState(null,null),this.quad.render(this.rect,this.scissorRect)}constructor(e,t,s,i){super(e),this.quad=t,this.rect=s,this.scissorRect=i}}var Bo=new bt;function Oo(e,t,s,i,n){var a=new Lo(s);i||((i=Bo).x=0,i.y=0,i.z=t?t.width:e.width,i.w=t?t.height:e.height);var r=new Fo(e,a,i,n);r.init(t),r.colorOps.clear=!1,r.depthStencilOps.clearDepth=!1,e.isWebGPU&&null===t&&e.samples>1&&(r.colorOps.store=!0),r.render(),a.destroy()}class zo{constructor(e,t,s,i,n=[0]){this._ui=!1,this._sprite=!1,this._obj={model:[],element:[],sprite:[],render:[]},this.id=e,this.name=t,this.dynamic=s,this.maxAabbSize=i,this.layers=n}}zo.MODEL="model",zo.ELEMENT="element",zo.SPRITE="sprite",zo.RENDER="render";var Vo=new Et;class No{set rootBone(e){this._rootBone=e}get rootBone(){return this._rootBone}init(e,t){var s=3*t,i=Math.ceil(Math.sqrt(s));i=pt.roundUp(i,3);var n=Math.ceil(s/i);this.boneTexture=new ki(e,{width:i,height:n,format:Zt,mipmaps:!1,minFilter:0,magFilter:0,name:"skin"}),this.boneTextureSize=[i,n,1/i,1/n],this.matrixPalette=this.boneTexture.lock({mode:1}),this.boneTexture.unlock()}destroy(){this.boneTexture&&(this.boneTexture.destroy(),this.boneTexture=null)}resolve(e,t){this.rootBone=e;for(var s=this.skin,i=[],n=0;n<s.boneNames.length;n++){var a=s.boneNames[n],r=e.findByName(a);r||(r=t),i.push(r)}this.bones=i}initSkin(e){this.skin=e,this.bones=[];var t=e.inverseBindPose.length;this.init(e.device,t),this.matrices=[];for(var s=0;s<t;s++)this.matrices[s]=new Et}uploadBones(e){this.boneTexture.upload()}_updateMatrices(e,t){if(this._skinUpdateIndex!==t){this._skinUpdateIndex=t,Vo.copy(e.getWorldTransform()).invert();for(var s=this.bones.length-1;s>=0;s--)this.matrices[s].mulAffine2(Vo,this.bones[s].getWorldTransform()),this.matrices[s].mulAffine2(this.matrices[s],this.skin.inverseBindPose[s])}}updateMatrices(e,t){this._updateBeforeCull&&this._updateMatrices(e,t)}updateMatrixPalette(e,t){this._updateMatrices(e,t);for(var s=this.matrixPalette,i=this.bones.length,n=0;n<i;n++){var a=this.matrices[n].data,r=12*n;s[r]=a[0],s[r+1]=a[4],s[r+2]=a[8],s[r+3]=a[12],s[r+4]=a[1],s[r+5]=a[5],s[r+6]=a[9],s[r+7]=a[13],s[r+8]=a[2],s[r+9]=a[6],s[r+10]=a[10],s[r+11]=a[14]}this.uploadBones(this.skin.device)}constructor(e){this._dirty=!0,this._rootBone=null,this._skinUpdateIndex=-1,this._updateBeforeCull=!0,e&&this.initSkin(e)}}var Uo=0;class Ho{initDefaults(){this.recreate=!1,this.verticesUsage=0,this.indicesUsage=0,this.maxVertices=0,this.maxIndices=0,this.vertexCount=0,this.indexCount=0,this.vertexStreamsUpdated=!1,this.indexStreamUpdated=!1,this.vertexStreamDictionary={},this.indices=null}_changeVertexCount(e,t){this.vertexCount||(this.vertexCount=e)}constructor(){this.initDefaults()}}Ho.DEFAULT_COMPONENTS_POSITION=3,Ho.DEFAULT_COMPONENTS_NORMAL=3,Ho.DEFAULT_COMPONENTS_UV=2,Ho.DEFAULT_COMPONENTS_COLORS=4;class Go{constructor(e,t,s,i,n){this.data=e,this.componentCount=t,this.dataType=s,this.dataTypeNormalize=i,this.asInt=n}}class Wo extends Dn{static fromGeometry(e,t,s){void 0===s&&(s={});var i=new Wo(e,s),{positions:n,normals:a,tangents:r,colors:o,uvs:l,uvs1:h,blendIndices:c,blendWeights:d,indices:u}=t;return n&&i.setPositions(n),a&&i.setNormals(a),r&&i.setVertexStream(gs,r,4),o&&i.setColors32(o),l&&i.setUvs(0,l),h&&i.setUvs(1,h),c&&i.setVertexStream(_s,c,4,c.length/4,1),d&&i.setVertexStream(vs,d,4),u&&i.setIndices(u),i.update(),i}set morph(e){e!==this._morph&&(this._morph&&this._morph.decRefCount(),this._morph=e,e&&e.incRefCount())}get morph(){return this._morph}set aabb(e){this._aabb=e,this._aabbVer++}get aabb(){return this._aabb}destroy(){var e=this.morph;e&&(this.morph=null,e.refCount<1&&e.destroy()),this.vertexBuffer&&(this.vertexBuffer.destroy(),this.vertexBuffer=null);for(var t=0;t<this.indexBuffer.length;t++)this._destroyIndexBuffer(t);this.indexBuffer.length=0,this._geometryData=null}_destroyIndexBuffer(e){this.indexBuffer[e]&&(this.indexBuffer[e].destroy(),this.indexBuffer[e]=null)}_initBoneAabbs(e){var t,s,i,n,a;this.boneAabb=[],this.boneUsed=[];for(var r,o,l,h=[],c=[],d=this.boneUsed,u=this.skin.boneNames.length,p=0;p<u;p++)h[p]=new yt(Number.MAX_VALUE,Number.MAX_VALUE,Number.MAX_VALUE),c[p]=new yt(-Number.MAX_VALUE,-Number.MAX_VALUE,-Number.MAX_VALUE);for(var m=new Zr(this.vertexBuffer),f=m.element[ms],g=m.element[vs],v=m.element[_s],_=this.vertexBuffer.numVertices,y=0;y<_;y++){for(var x=0;x<4;x++){if(g.array[g.index+x]>0){var w=v.array[v.index+x];if(d[w]=!0,t=f.array[f.index],s=f.array[f.index+1],i=f.array[f.index+2],n=c[w],(a=h[w]).x>t&&(a.x=t),a.y>s&&(a.y=s),a.z>i&&(a.z=i),n.x<t&&(n.x=t),n.y<s&&(n.y=s),n.z<i&&(n.z=i),e){for(var b=r=t,C=o=s,S=l=i,A=0;A<e.length;A++){var T=e[A],P=T.deltaPositions[3*y],E=T.deltaPositions[3*y+1],k=T.deltaPositions[3*y+2];P<0?b+=P:r+=P,E<0?C+=E:o+=E,k<0?S+=k:l+=k}a.x>b&&(a.x=b),a.y>C&&(a.y=C),a.z>S&&(a.z=S),n.x<r&&(n.x=r),n.y<o&&(n.y=o),n.z<l&&(n.z=l)}}}m.next()}var M=this.vertexBuffer.getFormat().elements.find((e=>e.name===ms));if(M&&M.normalize)for(var I=(()=>{switch(M.dataType){case 0:return e=>Math.max(e/127,-1);case 1:return e=>e/255;case 2:return e=>Math.max(e/32767,-1);case 3:return e=>e/65535;default:return e=>e}})(),D=0;D<u;D++)if(d[D]){var R=h[D],L=c[D];R.set(I(R.x),I(R.y),I(R.z)),L.set(I(L.x),I(L.y),I(L.z))}for(var F=0;F<u;F++){var B=new Ft;B.setMinMax(h[F],c[F]),this.boneAabb.push(B)}}_initGeometryData(){this._geometryData||(this._geometryData=new Ho,this.vertexBuffer&&(this._geometryData.vertexCount=this.vertexBuffer.numVertices,this._geometryData.maxVertices=this.vertexBuffer.numVertices),this.indexBuffer.length>0&&this.indexBuffer[0]&&(this._geometryData.indexCount=this.indexBuffer[0].numIndices,this._geometryData.maxIndices=this.indexBuffer[0].numIndices))}clear(e,t,s,i){void 0===s&&(s=0),void 0===i&&(i=0),this._initGeometryData(),this._geometryData.initDefaults(),this._geometryData.recreate=!0,this._geometryData.maxVertices=s,this._geometryData.maxIndices=i,this._geometryData.verticesUsage=e?0:1,this._geometryData.indicesUsage=t?0:1}setVertexStream(e,t,s,i,n,a,r){void 0===n&&(n=6),void 0===a&&(a=!1),void 0===r&&(r=!1),this._initGeometryData();var o=i||t.length/s;this._geometryData._changeVertexCount(o,e),this._geometryData.vertexStreamsUpdated=!0,this._geometryData.vertexStreamDictionary[e]=new Go(t,s,n,a,r)}getVertexStream(e,t){var s=0,i=!1;if(this._geometryData){var n=this._geometryData.vertexStreamDictionary[e];n&&(i=!0,s=this._geometryData.vertexCount,ArrayBuffer.isView(t)?t.set(n.data):(t.length=0,t.push(n.data)))}i||this.vertexBuffer&&(s=new Zr(this.vertexBuffer).readData(e,t));return s}setPositions(e,t,s){void 0===t&&(t=Ho.DEFAULT_COMPONENTS_POSITION),this.setVertexStream(ms,e,t,s,6,!1)}setNormals(e,t,s){void 0===t&&(t=Ho.DEFAULT_COMPONENTS_NORMAL),this.setVertexStream(fs,e,t,s,6,!1)}setUvs(e,t,s,i){void 0===s&&(s=Ho.DEFAULT_COMPONENTS_UV),this.setVertexStream(xs+e,t,s,i,6,!1)}setColors(e,t,s){void 0===t&&(t=Ho.DEFAULT_COMPONENTS_COLORS),this.setVertexStream(ys,e,t,s,6,!1)}setColors32(e,t){this.setVertexStream(ys,e,Ho.DEFAULT_COMPONENTS_COLORS,t,1,!0)}setIndices(e,t){this._initGeometryData(),this._geometryData.indexStreamUpdated=!0,this._geometryData.indices=e,this._geometryData.indexCount=t||e.length}getPositions(e){return this.getVertexStream(ms,e)}getNormals(e){return this.getVertexStream(fs,e)}getUvs(e,t){return this.getVertexStream(xs+e,t)}getColors(e){return this.getVertexStream(ys,e)}getIndices(e){var t=0;if(this._geometryData&&this._geometryData.indices){var s=this._geometryData.indices;if(t=this._geometryData.indexCount,ArrayBuffer.isView(e))e.set(s);else{e.length=0;for(var i=0,n=s.length;i<n;i++)e.push(s[i])}}else{if(this.indexBuffer.length>0&&this.indexBuffer[0])t=this.indexBuffer[0].readData(e)}return t}update(e,t){if(void 0===e&&(e=4),void 0===t&&(t=!0),this._geometryData){if(t){var s=this._geometryData.vertexStreamDictionary[ms];s&&3===s.componentCount&&(this._aabb.compute(s.data,this._geometryData.vertexCount),this._aabbVer++)}var i=this._geometryData.recreate;this._geometryData.vertexCount>this._geometryData.maxVertices&&(i=!0,this._geometryData.maxVertices=this._geometryData.vertexCount),i&&this.vertexBuffer&&(this.vertexBuffer.destroy(),this.vertexBuffer=null);var n=this._geometryData.recreate;this._geometryData.indexCount>this._geometryData.maxIndices&&(n=!0,this._geometryData.maxIndices=this._geometryData.indexCount),n&&this.indexBuffer.length>0&&this.indexBuffer[0]&&(this.indexBuffer[0].destroy(),this.indexBuffer[0]=null),this._geometryData.vertexStreamsUpdated&&this._updateVertexBuffer(),this._geometryData.indexStreamUpdated&&this._updateIndexBuffer(),this.primitive[0].type=e,this.indexBuffer.length>0&&this.indexBuffer[0]?this._geometryData.indexStreamUpdated&&(this.primitive[0].count=this._geometryData.indexCount,this.primitive[0].indexed=!0):this._geometryData.vertexStreamsUpdated&&(this.primitive[0].count=this._geometryData.vertexCount,this.primitive[0].indexed=!1),this._geometryData.vertexCount=0,this._geometryData.indexCount=0,this._geometryData.vertexStreamsUpdated=!1,this._geometryData.indexStreamUpdated=!1,this._geometryData.recreate=!1,this.updateRenderStates()}}_buildVertexFormat(e){var t=[];for(var s in this._geometryData.vertexStreamDictionary){var i=this._geometryData.vertexStreamDictionary[s];t.push({semantic:s,components:i.componentCount,type:i.dataType,normalize:i.dataTypeNormalize,asInt:i.asInt})}return new tn(this.device,t,e)}_updateVertexBuffer(){if(!this.vertexBuffer){var e=this._geometryData.maxVertices,t=this._buildVertexFormat(e);this.vertexBuffer=new $i(this.device,t,e,{usage:this._geometryData.verticesUsage,storage:this._storageVertex})}var s=new Zr(this.vertexBuffer),i=this._geometryData.vertexCount;for(var n in this._geometryData.vertexStreamDictionary){var a=this._geometryData.vertexStreamDictionary[n];s.writeData(n,a.data,i),delete this._geometryData.vertexStreamDictionary[n]}s.end()}_updateIndexBuffer(){if(this.indexBuffer.length<=0||!this.indexBuffer[0]){var e=this._geometryData.maxVertices,t=e>65535||0===e?2:1,s=this._storageIndex?{storage:!0}:void 0;this.indexBuffer[0]=new Lr(this.device,t,this._geometryData.maxIndices,this._geometryData.indicesUsage,void 0,s)}var i=this._geometryData.indices;i&&(this.indexBuffer[0].writeData(i,this._geometryData.indexCount),this._geometryData.indices=null)}prepareRenderState(e){1===e?this.generateWireframe():2===e&&(this.primitive[2]={type:0,base:0,count:this.vertexBuffer?this.vertexBuffer.numVertices:0,indexed:!1})}updateRenderStates(){this.primitive[2]&&this.prepareRenderState(2),this.primitive[1]&&this.prepareRenderState(1)}generateWireframe(){this._destroyIndexBuffer(1);var e,t=this.vertexBuffer.numVertices,s=[];if(this.indexBuffer.length>0&&this.indexBuffer[0]){for(var i=[[0,1],[1,2],[2,0]],n=this.primitive[0].base,a=this.primitive[0].count,r=this.indexBuffer[0],o=new fi[r.format](r.storage),l=new Set,h=n;h<n+a;h+=3)for(var c=0;c<3;c++){var d=o[h+i[c][0]],u=o[h+i[c][1]],p=d>u?u*t+d:d*t+u;l.has(p)||(l.add(p),s.push(d,u))}e=r.format}else{for(var m=0;m<t;m+=3)s.push(m,m+1,m+1,m+2,m+2,m);e=s.length>65535?2:1}var f=new Lr(this.vertexBuffer.device,e,s.length);new fi[f.format](f.storage).set(s),f.unlock(),this.primitive[1]={type:1,base:0,count:s.length,indexed:!0},this.indexBuffer[1]=f}constructor(e,t){super(),this.indexBuffer=[null],this.vertexBuffer=null,this.primitive=[{type:0,base:0,count:0}],this.skin=null,this.boneAabb=null,this._aabbVer=0,this._aabb=new Ft,this._geometryData=null,this._morph=null,this._storageIndex=!1,this._storageVertex=!1,this.id=Uo++,this.device=e,this._storageIndex=(null==t?void 0:t.storageIndex)||!1,this._storageVertex=(null==t?void 0:t.storageVertex)||!1}}var jo=new Ti;function qo(e){return jo.get(e)}class Xo{static incRef(e){this.cache.incRef(e)}static decRef(e){this.cache.decRef(e)}static destroy(){this.cache.destroy()}}Xo.cache=new class{destroy(){this.cache.forEach(((e,t)=>{t.destroy()})),this.cache.clear()}incRef(e){var t=(this.cache.get(e)||0)+1;this.cache.set(e,t)}decRef(e){if(e){var t=this.cache.get(e);t&&(0===--t?(this.cache.delete(e),e.destroy()):this.cache.set(e,t))}}constructor(){this.cache=new Map}};var Yo=0,$o=new Ft,Ko=new Ft,Zo=new zt,Jo=new Set,Qo=new Uint32Array(4);class el{destroy(){var e;this._destroyVertexBuffer&&(null==(e=this.vertexBuffer)||e.destroy());this.vertexBuffer=null}constructor(e){this.vertexBuffer=null,this._destroyVertexBuffer=!1,this.count=e}}class tl{getBindGroup(e){if(!this.bindGroup){var t=this.shader.meshBindGroupFormat;this.bindGroup=new Bi(e,t)}return this.bindGroup}getUniformBuffer(e){if(!this.uniformBuffer){var t=this.shader.meshUniformBufferFormat;this.uniformBuffer=new Xa(e,t,!1)}return this.uniformBuffer}destroy(){var e,t;null==(e=this.bindGroup)||e.destroy(),this.bindGroup=null,null==(t=this.uniformBuffer)||t.destroy(),this.uniformBuffer=null}constructor(){this.bindGroup=null,this.uniformBuffer=null}}class sl{set renderStyle(e){this._renderStyle=e,this.mesh.prepareRenderState(e)}get renderStyle(){return this._renderStyle}set mesh(e){e!==this._mesh&&(this._mesh&&this._mesh.decRefCount(),this._mesh=e,e&&e.incRefCount())}get mesh(){return this._mesh}set aabb(e){this._aabb=e}get aabb(){if(!this._updateAabb)return this._aabb;if(this._updateAabbFunc)return this._updateAabbFunc(this._aabb);var e=this._customAabb,t=!!e;if(!e)if(e=$o,this.skinInstance){if(!this.mesh.boneAabb){var s=this._morphInstance?this._morphInstance.morph._targets:null;this.mesh._initBoneAabbs(s)}for(var i=this.mesh.boneUsed,n=!0,a=0;a<this.mesh.boneAabb.length;a++)i[a]&&(Ko.setFromTransformedAabb(this.mesh.boneAabb[a],this.skinInstance.matrices[a]),n?(n=!1,e.center.copy(Ko.center),e.halfExtents.copy(Ko.halfExtents)):e.add(Ko));t=!0}else if(this.node._aabbVer!==this._aabbVer||this.mesh._aabbVer!==this._aabbMeshVer){if(this.mesh?(e.center.copy(this.mesh.aabb.center),e.halfExtents.copy(this.mesh.aabb.halfExtents)):(e.center.set(0,0,0),e.halfExtents.set(0,0,0)),this.mesh&&this.mesh.morph){var r=this.mesh.morph.aabb;e._expand(r.getMin(),r.getMax())}t=!0,this._aabbVer=this.node._aabbVer,this._aabbMeshVer=this.mesh._aabbVer}return t&&this._aabb.setFromTransformedAabb(e,this.node.getWorldTransform()),this._aabb}clearShaders(){this._shaderCache.forEach((e=>{e.destroy()})),this._shaderCache.clear()}getShaderInstance(e,t,s,i,n,a,r){var o=this._shaderDefs;Qo[0]=e,Qo[1]=t,Qo[2]=o,Qo[3]=i.hash;var l=Zi(Qo),h=this._shaderCache.get(l);if(!h){var c=this._material;if((h=new tl).shader=c.variants.get(l),h.hashes=new Uint32Array(Qo),!h.shader){var d,u=c.getShaderVariant({device:this.mesh.device,scene:s,objDefs:o,cameraShaderParams:i,pass:e,sortedLights:r,viewUniformFormat:n,viewBindGroupFormat:a,vertexFormat:null==(d=this.mesh.vertexBuffer)?void 0:d.format});c.variants.set(l,u),h.shader=u}this._shaderCache.set(l,h)}return h}set material(e){this.clearShaders();var t=this._material;t&&t.removeMeshInstanceRef(this),this._material=e,e&&(e.addMeshInstanceRef(this),this.transparent=e.transparent,this.updateKey())}get material(){return this._material}set layer(e){this._layer=e,this.updateKey()}get layer(){return this._layer}_updateShaderDefs(e){e!==this._shaderDefs&&(this._shaderDefs=e,this.clearShaders())}set calculateSortDistance(e){this._calculateSortDistance=e}get calculateSortDistance(){return this._calculateSortDistance}set receiveShadow(e){this._receiveShadow!==e&&(this._receiveShadow=e,this._updateShaderDefs(e?-2&this._shaderDefs:1|this._shaderDefs))}get receiveShadow(){return this._receiveShadow}set batching(e){this._updateShaderDefs(e?this._shaderDefs|ho:-16385&this._shaderDefs)}get batching(){return!!(this._shaderDefs&ho)}set skinInstance(e){this._skinInstance=e,this._updateShaderDefs(e?2|this._shaderDefs:-3&this._shaderDefs),this._setupSkinUpdate()}get skinInstance(){return this._skinInstance}set morphInstance(e){var t;null==(t=this._morphInstance)||t.destroy(),this._morphInstance=e;var s=this._shaderDefs;s=e&&e.morph.morphPositions?s|ro:-1025&s,s=e&&e.morph.morphNormals?s|oo:-2049&s,s=e&&e.morph.intRenderFormat?s|lo:-8193&s,this._updateShaderDefs(s)}get morphInstance(){return this._morphInstance}set screenSpace(e){this._screenSpace!==e&&(this._screenSpace=e,this._updateShaderDefs(e?256|this._shaderDefs:-257&this._shaderDefs))}get screenSpace(){return this._screenSpace}set key(e){this._key[0]=e}get key(){return this._key[0]}set mask(e){var t=65535&this._shaderDefs;this._updateShaderDefs(t|e<<16)}get mask(){return this._shaderDefs>>16}set instancingCount(e){this.instancingData&&(this.instancingData.count=e)}get instancingCount(){return this.instancingData?this.instancingData.count:0}destroy(){var e,t,s,i=this.mesh;i&&(this.mesh=null,i.refCount<1&&i.destroy()),this.setRealtimeLightmap(sl.lightmapParamNames[0],null),this.setRealtimeLightmap(sl.lightmapParamNames[1],null),null==(e=this._skinInstance)||e.destroy(),this._skinInstance=null,null==(t=this.morphInstance)||t.destroy(),this.morphInstance=null,this.clearShaders(),this.material=null,null==(s=this.instancingData)||s.destroy()}static _prepareRenderStyleForArray(e,t){if(e){for(var s=0;s<e.length;s++){e[s]._renderStyle=t;var i=e[s].mesh;Jo.has(i)||(Jo.add(i),i.prepareRenderState(t))}Jo.clear()}}_isVisible(e){return!!this.visible&&(this.isVisibleFunc?this.isVisibleFunc(e):(Zo.center=this.aabb.center,Zo.radius=this._aabb.halfExtents.length(),e.frustum.containsSphere(Zo)>0))}updateKey(){var e=this.material,t=e.alphaToCoverage||e.alphaTest?2:e.blendType;this._key[0]=(15&this.layer)<<27|(3===t?1:0)<<26|33554431&e.id}setInstancing(e,t){void 0===t&&(t=!1),e?(this.instancingData=new el(e.numVertices),this.instancingData.vertexBuffer=e,e.format.instancing=!0,this.cull=t):(this.instancingData=null,this.cull=!0),this._updateShaderDefs(e?32|this._shaderDefs:-33&this._shaderDefs)}ensureMaterial(e){this.material||(this.material=qo(e))}clearParameters(){this.parameters={}}getParameters(){return this.parameters}getParameter(e){return this.parameters[e]}setParameter(e,t,s){void 0===s&&(s=4294967295);var i=this.parameters[e];i?(i.data=t,i.passFlags=s):this.parameters[e]={scopeId:null,data:t,passFlags:s}}setRealtimeLightmap(e,t){var s=this.getParameter(e);s!==t&&(s&&Xo.decRef(s.data),t?(Xo.incRef(t),this.setParameter(e,t)):this.deleteParameter(e))}deleteParameter(e){this.parameters[e]&&delete this.parameters[e]}setParameters(e,t){var s=this.parameters;for(var i in s){var n=s[i];n.passFlags&t&&(n.scopeId||(n.scopeId=e.scope.resolve(i)),n.scopeId.setValue(n.data))}}setLightmapped(e){e?this.mask=-6&this.mask|2:(this.setRealtimeLightmap(sl.lightmapParamNames[0],null),this.setRealtimeLightmap(sl.lightmapParamNames[1],null),this._shaderDefs&=-4289,this.mask=-7&this.mask|1)}setCustomAabb(e){e?this._customAabb?this._customAabb.copy(e):this._customAabb=e.clone():(this._customAabb=null,this._aabbVer=-1),this._setupSkinUpdate()}_setupSkinUpdate(){this._skinInstance&&(this._skinInstance._updateBeforeCull=!this._customAabb)}constructor(e,t,s=null){if(this.castShadow=!1,this.cull=!0,this.drawOrder=0,this.visible=!0,this.visibleThisFrame=!1,this.flipFacesFactor=1,this.gsplatInstance=null,this.id=Yo++,this.isVisibleFunc=null,this.instancingData=null,this.parameters={},this.pick=!0,this.stencilFront=null,this.stencilBack=null,this.transparent=!1,this._aabb=new Ft,this._aabbVer=-1,this._aabbMeshVer=-1,this._customAabb=null,this._updateAabb=!0,this._updateAabbFunc=null,this._key=[0,0],this._layer=15,this._material=null,this._skinInstance=null,this._morphInstance=null,this._receiveShadow=!0,this._renderStyle=0,this._screenSpace=!1,this._shaderCache=new Map,this._shaderDefs=65536,this._calculateSortDistance=null,this.node=s,this._mesh=e,e.incRefCount(),this.material=t,e.vertexBuffer){var i=e.vertexBuffer.format;this._shaderDefs|=i.hasUv0?4:0,this._shaderDefs|=i.hasUv1?8:0,this._shaderDefs|=i.hasColor?16:0,this._shaderDefs|=i.hasTangents?512:0}this.updateKey()}}sl.lightmapParamNames=["texture_lightMap","texture_dirLightMap"];var il="uSceneColorMap";class nl extends Or{destroy(){super.destroy(),this.releaseRenderTarget(this.colorRenderTarget)}shouldReallocate(e,t,s){if((null==e?void 0:e.colorBuffer.format)!==s)return!0;var i=(null==t?void 0:t.width)||this.device.width,n=(null==t?void 0:t.height)||this.device.height;return!e||i!==e.width||n!==e.height}allocateRenderTarget(e,t,s,i){var n=new ki(s,{name:il,format:i,width:t?t.colorBuffer.width:s.width,height:t?t.colorBuffer.height:s.height,mipmaps:!0,minFilter:5,magFilter:1,addressU:1,addressV:1});return e?(e.destroyFrameBuffers(),e._colorBuffer=n,e._colorBuffers=[n]):e=new ln({name:"ColorGrabRT",colorBuffer:n,depth:!1,stencil:!1,autoResolve:!1}),e}releaseRenderTarget(e){e&&(e.destroyTextureBuffers(),e.destroy())}frameUpdate(){var e,t=this.device,s=this.source,i=null!=(e=null==s?void 0:s.colorBuffer.format)?e:this.device.backBufferFormat;this.shouldReallocate(this.colorRenderTarget,null==s?void 0:s.colorBuffer,i)&&(this.releaseRenderTarget(this.colorRenderTarget),this.colorRenderTarget=this.allocateRenderTarget(this.colorRenderTarget,s,t,i));var n=this.colorRenderTarget.colorBuffer;t.scope.resolve(il).setValue(n)}execute(){var e=this.device,t=this.source,s=this.colorRenderTarget.colorBuffer;e.isWebGPU?(e.copyRenderTarget(t,this.colorRenderTarget,!0,!1),e.mipmapRenderer.generate(this.colorRenderTarget.colorBuffer.impl)):(e.copyRenderTarget(t,this.colorRenderTarget,!0,!1),e.activeTexture(e.maxCombinedTextures-1),e.bindTexture(s),e.gl.generateMipmap(s.impl._glTarget))}constructor(...e){super(...e),this.colorRenderTarget=null,this.source=null}}var al="uSceneDepthMap";class rl extends Or{destroy(){super.destroy(),this.releaseRenderTarget(this.depthRenderTarget)}shouldReallocate(e,t){var s=(null==t?void 0:t.width)||this.device.width,i=(null==t?void 0:t.height)||this.device.height;return!e||s!==e.width||i!==e.height}allocateRenderTarget(e,t,s,i,n){var a=new ki(s,{name:al,format:i,width:t?t.colorBuffer.width:s.width,height:t?t.colorBuffer.height:s.height,mipmaps:!1,minFilter:0,magFilter:0,addressU:1,addressV:1});return e?(e.destroyFrameBuffers(),n?e._depthBuffer=a:(e._colorBuffer=a,e._colorBuffers=[a])):e=new ln({name:"DepthGrabRT",colorBuffer:n?null:a,depthBuffer:n?a:null,depth:!n,stencil:s.supportsStencil,autoResolve:!1}),e}releaseRenderTarget(e){e&&(e.destroyTextureBuffers(),e.destroy())}before(){var e,t,s,i,n=this.camera,a=this.device,r=null!=(s=null==n?void 0:n.renderTarget)?s:a.backBuffer,o=!0,l=r.stencil?es:Qt;a.isWebGPU&&(r.samples>1&&(l=Jt,o=!1));var h=null!=(i=null==(e=n.renderTarget)?void 0:e.depthBuffer)?i:null==(t=n.renderTarget)?void 0:t.colorBuffer;this.shouldReallocate(this.depthRenderTarget,h)&&(this.releaseRenderTarget(this.depthRenderTarget),this.depthRenderTarget=this.allocateRenderTarget(this.depthRenderTarget,n.renderTarget,a,l,o));var c=o?this.depthRenderTarget.depthBuffer:this.depthRenderTarget.colorBuffer;a.scope.resolve(al).setValue(c)}execute(){var e=this.device;if(e.isWebGL2&&e.renderTarget.samples>1){var t=e.renderTarget.impl._glFrameBuffer,s=this.depthRenderTarget;e.renderTarget=s,e.updateBegin(),this.depthRenderTarget.impl.internalResolve(e,t,s.impl._glFrameBuffer,this.depthRenderTarget,e.gl.DEPTH_BUFFER_BIT)}else e.copyRenderTarget(e.renderTarget,this.depthRenderTarget,!1,!0)}constructor(e,t){super(e),this.depthRenderTarget=null,this.camera=null,this.camera=t}}class ol{get hash(){if(void 0===this._hash){var e=this.gammaCorrection+"_"+this.toneMapping+"_"+this.srgbRenderTarget+"_"+this.fog+"_"+this.ssaoEnabled+"_"+this.sceneDepthMapLinear;this._hash=Ki(e)}return this._hash}get defines(){var e=this._defines;return this._definesDirty&&(this._definesDirty=!1,e.clear(),this._sceneDepthMapLinear&&e.set("SCENE_DEPTHMAP_LINEAR",!0),e.set("FOG",this._fog.toUpperCase()),e.set("TONEMAP",ao[this._toneMapping]),e.set("GAMMA",no[this.shaderOutputGamma])),e}markDirty(){this._hash=void 0,this._definesDirty=!0}set fog(e){this._fog!==e&&(this._fog=e,this.markDirty())}get fog(){return this._fog}set ssaoEnabled(e){this._ssaoEnabled!==e&&(this._ssaoEnabled=e,this.markDirty())}get ssaoEnabled(){return this._ssaoEnabled}set gammaCorrection(e){this._gammaCorrectionAssigned=!0,this._gammaCorrection!==e&&(this._gammaCorrection=e,this.markDirty())}get gammaCorrection(){return this._gammaCorrection}set toneMapping(e){this._toneMapping!==e&&(this._toneMapping=e,this.markDirty())}get toneMapping(){return this._toneMapping}set srgbRenderTarget(e){this._srgbRenderTarget!==e&&(this._srgbRenderTarget=e,this.markDirty())}get srgbRenderTarget(){return this._srgbRenderTarget}set sceneDepthMapLinear(e){this._sceneDepthMapLinear!==e&&(this._sceneDepthMapLinear=e,this.markDirty())}get sceneDepthMapLinear(){return this._sceneDepthMapLinear}get shaderOutputGamma(){return 1===this._gammaCorrection&&!this._srgbRenderTarget?1:0}constructor(){this._gammaCorrection=1,this._toneMapping=0,this._srgbRenderTarget=!1,this._ssaoEnabled=!1,this._fog=eo,this._sceneDepthMapLinear=!1,this._defines=new Map,this._definesDirty=!0}}var ll=new yt,hl=new yt,cl=new yt,dl=new Et,ul=[new yt,new yt,new yt,new yt,new yt,new yt,new yt,new yt];let pl=class e{destroy(){var e,t;null==(e=this.renderPassColorGrab)||e.destroy(),this.renderPassColorGrab=null,null==(t=this.renderPassDepthGrab)||t.destroy(),this.renderPassDepthGrab=null,this.renderPasses.length=0}_storeShaderMatrices(e,t,s,i){var n;this._shaderMatricesVersion!==i&&(this._shaderMatricesVersion=i,this._viewProjPrevious.copy(null!=(n=this._viewProjCurrent)?n:e),null!=this._viewProjCurrent||(this._viewProjCurrent=new Et),this._viewProjCurrent.copy(e),this._viewProjInverse.invert(e),this._jitters[2]=this._jitters[0],this._jitters[3]=this._jitters[1],this._jitters[0]=t,this._jitters[1]=s)}get fullSizeClearRect(){var e=this._scissorRectClear?this.scissorRect:this._rect;return 0===e.x&&0===e.y&&1===e.z&&1===e.w}set aspectRatio(e){this._aspectRatio!==e&&(this._aspectRatio=e,this._projMatDirty=!0)}get aspectRatio(){var e;return(null==(e=this.xr)?void 0:e.active)?this._xrProperties.aspectRatio:this._aspectRatio}set aspectRatioMode(e){this._aspectRatioMode!==e&&(this._aspectRatioMode=e,this._projMatDirty=!0)}get aspectRatioMode(){return this._aspectRatioMode}set calculateProjection(e){this._calculateProjection=e,this._projMatDirty=!0}get calculateProjection(){return this._calculateProjection}set calculateTransform(e){this._calculateTransform=e}get calculateTransform(){return this._calculateTransform}set clearColor(e){this._clearColor.copy(e)}get clearColor(){return this._clearColor}set clearColorBuffer(e){this._clearColorBuffer=e}get clearColorBuffer(){return this._clearColorBuffer}set clearDepth(e){this._clearDepth=e}get clearDepth(){return this._clearDepth}set clearDepthBuffer(e){this._clearDepthBuffer=e}get clearDepthBuffer(){return this._clearDepthBuffer}set clearStencil(e){this._clearStencil=e}get clearStencil(){return this._clearStencil}set clearStencilBuffer(e){this._clearStencilBuffer=e}get clearStencilBuffer(){return this._clearStencilBuffer}set cullFaces(e){this._cullFaces=e}get cullFaces(){return this._cullFaces}set farClip(e){this._farClip!==e&&(this._farClip=e,this._projMatDirty=!0)}get farClip(){var e;return(null==(e=this.xr)?void 0:e.active)?this._xrProperties.farClip:this._farClip}set flipFaces(e){this._flipFaces=e}get flipFaces(){return this._flipFaces}set fov(e){this._fov!==e&&(this._fov=e,this._projMatDirty=!0)}get fov(){var e;return(null==(e=this.xr)?void 0:e.active)?this._xrProperties.fov:this._fov}set frustumCulling(e){this._frustumCulling=e}get frustumCulling(){return this._frustumCulling}set horizontalFov(e){this._horizontalFov!==e&&(this._horizontalFov=e,this._projMatDirty=!0)}get horizontalFov(){var e;return(null==(e=this.xr)?void 0:e.active)?this._xrProperties.horizontalFov:this._horizontalFov}set layers(e){this._layers=e.slice(0),this._layersSet=new Set(this._layers)}get layers(){return this._layers}get layersSet(){return this._layersSet}set nearClip(e){this._nearClip!==e&&(this._nearClip=e,this._projMatDirty=!0)}get nearClip(){var e;return(null==(e=this.xr)?void 0:e.active)?this._xrProperties.nearClip:this._nearClip}set node(e){this._node=e}get node(){return this._node}set orthoHeight(e){this._orthoHeight!==e&&(this._orthoHeight=e,this._projMatDirty=!0)}get orthoHeight(){return this._orthoHeight}set projection(e){this._projection!==e&&(this._projection=e,this._projMatDirty=!0)}get projection(){return this._projection}get projectionMatrix(){return this._evaluateProjectionMatrix(),this._projMat}set rect(e){this._rect.copy(e)}get rect(){return this._rect}set renderTarget(e){this._renderTarget=e}get renderTarget(){return this._renderTarget}set scissorRect(e){this._scissorRect.copy(e)}get scissorRect(){return this._scissorRect}get viewMatrix(){if(this._viewMatDirty){var e=this._node.getWorldTransform();this._viewMat.copy(e).invert(),this._viewMatDirty=!1}return this._viewMat}set aperture(e){this._aperture=e}get aperture(){return this._aperture}set sensitivity(e){this._sensitivity=e}get sensitivity(){return this._sensitivity}set shutter(e){this._shutter=e}get shutter(){return this._shutter}set xr(e){this._xr!==e&&(this._xr=e,this._projMatDirty=!0)}get xr(){return this._xr}clone(){return(new e).copy(this)}copy(e){return this._aspectRatio=e._aspectRatio,this._farClip=e._farClip,this._fov=e._fov,this._horizontalFov=e._horizontalFov,this._nearClip=e._nearClip,this._xrProperties.aspectRatio=e._xrProperties.aspectRatio,this._xrProperties.farClip=e._xrProperties.farClip,this._xrProperties.fov=e._xrProperties.fov,this._xrProperties.horizontalFov=e._xrProperties.horizontalFov,this._xrProperties.nearClip=e._xrProperties.nearClip,this.aspectRatioMode=e.aspectRatioMode,this.calculateProjection=e.calculateProjection,this.calculateTransform=e.calculateTransform,this.clearColor=e.clearColor,this.clearColorBuffer=e.clearColorBuffer,this.clearDepth=e.clearDepth,this.clearDepthBuffer=e.clearDepthBuffer,this.clearStencil=e.clearStencil,this.clearStencilBuffer=e.clearStencilBuffer,this.cullFaces=e.cullFaces,this.flipFaces=e.flipFaces,this.frustumCulling=e.frustumCulling,this.layers=e.layers,this.orthoHeight=e.orthoHeight,this.projection=e.projection,this.rect=e.rect,this.renderTarget=e.renderTarget,this.scissorRect=e.scissorRect,this.aperture=e.aperture,this.shutter=e.shutter,this.sensitivity=e.sensitivity,this.shaderPassInfo=e.shaderPassInfo,this.jitter=e.jitter,this._projMatDirty=!0,this}_enableRenderPassColorGrab(e,t){var s;t?this.renderPassColorGrab||(this.renderPassColorGrab=new nl(e)):(null==(s=this.renderPassColorGrab)||s.destroy(),this.renderPassColorGrab=null)}_enableRenderPassDepthGrab(e,t,s){var i;s?this.renderPassDepthGrab||(this.renderPassDepthGrab=new rl(e,this)):(null==(i=this.renderPassDepthGrab)||i.destroy(),this.renderPassDepthGrab=null)}_updateViewProjMat(){(this._projMatDirty||this._viewMatDirty||this._viewProjMatDirty)&&(this._viewProjMat.mul2(this.projectionMatrix,this.viewMatrix),this._viewProjMatDirty=!1)}worldToScreen(e,t,s,i){void 0===i&&(i=new yt),this._updateViewProjMat(),this._viewProjMat.transformPoint(e,i);var n=this._viewProjMat.data,a=e.x*n[3]+e.y*n[7]+e.z*n[11]+1*n[15];return i.x=.5*(i.x/a+1)*t,i.y=.5*(1-i.y/a)*s,i}screenToWorld(e,t,s,i,n,a){void 0===a&&(a=new yt);var r=this.farClip-this.nearClip;if(ll.set(e/i,(n-t)/n,s/r),ll.mulScalar(2),ll.sub(yt.ONE),0===this._projection){Et._getPerspectiveHalfSize(hl,this.fov,this.aspectRatio,this.nearClip,this.horizontalFov),hl.x*=ll.x,hl.y*=ll.y;var o=this._node.getWorldTransform();hl.z=-this.nearClip,o.transformPoint(hl,cl);var l=this._node.getPosition();a.sub2(cl,l),a.normalize(),a.mulScalar(s),a.add(l)}else this._updateViewProjMat(),dl.copy(this._viewProjMat).invert(),dl.transformPoint(ll,a);return a}_evaluateProjectionMatrix(){if(this._projMatDirty){if(0===this._projection)this._projMat.setPerspective(this.fov,this.aspectRatio,this.nearClip,this.farClip,this.horizontalFov),this._projMatSkybox.copy(this._projMat);else{var e=this._orthoHeight,t=e*this.aspectRatio;this._projMat.setOrtho(-t,t,-e,e,this.nearClip,this.farClip),this._projMatSkybox.setPerspective(this.fov,this.aspectRatio,this.nearClip,this.farClip)}this._projMatDirty=!1}}getProjectionMatrixSkybox(){return this._evaluateProjectionMatrix(),this._projMatSkybox}getExposure(){var e=Math.log2(this._aperture*this._aperture/this._shutter*100/this._sensitivity);return 1/(1.2*Math.pow(2,e))}getScreenSize(e){if(0===this._projection){var t=this._node.getPosition().distance(e.center);if(t<e.radius)return 1;var s=Math.asin(e.radius/t),i=Math.tan(s),n=Math.tan(this.fov/2*pt.DEG_TO_RAD);return Math.min(i/n,1)}return pt.clamp(e.radius/this._orthoHeight,0,1)}getFrustumCorners(e,t){void 0===e&&(e=this.nearClip),void 0===t&&(t=this.farClip);var s,i,n=this.fov*Math.PI/180;0===this.projection?this.horizontalFov?i=(s=e*Math.tan(n/2))/this.aspectRatio:s=(i=e*Math.tan(n/2))*this.aspectRatio:s=(i=this._orthoHeight)*this.aspectRatio;var a=ul;return a[0].x=s,a[0].y=-i,a[0].z=-e,a[1].x=s,a[1].y=i,a[1].z=-e,a[2].x=-s,a[2].y=i,a[2].z=-e,a[3].x=-s,a[3].y=-i,a[3].z=-e,0===this._projection&&(this.horizontalFov?i=(s=t*Math.tan(n/2))/this.aspectRatio:s=(i=t*Math.tan(n/2))*this.aspectRatio),a[4].x=s,a[4].y=-i,a[4].z=-t,a[5].x=s,a[5].y=i,a[5].z=-t,a[6].x=-s,a[6].y=i,a[6].z=-t,a[7].x=-s,a[7].y=-i,a[7].z=-t,a}setXrProperties(e){Object.assign(this._xrProperties,e),this._projMatDirty=!0}constructor(){this.shaderPassInfo=null,this.renderPassColorGrab=null,this.renderPassDepthGrab=null,this.fogParams=null,this.shaderParams=new ol,this.renderPasses=[],this.jitter=0,this._aspectRatio=16/9,this._aspectRatioMode=0,this._calculateProjection=null,this._calculateTransform=null,this._clearColor=new mt(.75,.75,.75,1),this._clearColorBuffer=!0,this._clearDepth=1,this._clearDepthBuffer=!0,this._clearStencil=0,this._clearStencilBuffer=!0,this._cullFaces=!0,this._farClip=1e3,this._flipFaces=!1,this._fov=45,this._frustumCulling=!0,this._horizontalFov=!1,this._layers=[0,1,2,4,3],this._layersSet=new Set(this._layers),this._nearClip=.1,this._node=null,this._orthoHeight=10,this._projection=0,this._rect=new bt(0,0,1,1),this._renderTarget=null,this._scissorRect=new bt(0,0,1,1),this._scissorRectClear=!1,this._aperture=16,this._shutter=.001,this._sensitivity=1e3,this._projMat=new Et,this._projMatDirty=!0,this._projMatSkybox=new Et,this._viewMat=new Et,this._viewMatDirty=!0,this._viewProjMat=new Et,this._viewProjMatDirty=!0,this._shaderMatricesVersion=0,this._viewProjInverse=new Et,this._viewProjCurrent=null,this._viewProjPrevious=new Et,this._jitters=[0,0,0,0],this.frustum=new Nt,this._xr=null,this._xrProperties={horizontalFov:this._horizontalFov,fov:this._fov,aspectRatio:this._aspectRatio,farClip:this._farClip,nearClip:this._nearClip}}};var ml=new Et,fl=new yt,gl=new kt,vl=new kt,_l=new yt,yl=new yt,xl=new Et,wl=new kt,bl=new yt,Cl=new Et,Sl=new kt,Al=new kt,Tl=new Et,Pl=new yt,El=new yt;function kl(e,t){return e instanceof Function?e:s=>{var i=s[e];return i instanceof Function&&(i=i()),i===t}}function Ml(e,t){if(t(e))return e;for(var s=e._children,i=s.length,n=0;n<i;++n){var a=Ml(s[n],t);if(a)return a}return null}class Il extends tt{get right(){return this._right||(this._right=new yt),this.getWorldTransform().getX(this._right).normalize()}get up(){return this._up||(this._up=new yt),this.getWorldTransform().getY(this._up).normalize()}get forward(){return this._forward||(this._forward=new yt),this.getWorldTransform().getZ(this._forward).normalize().mulScalar(-1)}get normalMatrix(){var e=this._normalMatrix;return this._dirtyNormal&&(e.invertMat4(this.getWorldTransform()).transpose(),this._dirtyNormal=!1),e}set enabled(e){var t;this._enabled!==e&&(this._enabled=e,(e&&(null==(t=this._parent)?void 0:t.enabled)||!e)&&this._notifyHierarchyStateChanged(this,e))}get enabled(){return this._enabled&&this._enabledInHierarchy}get parent(){return this._parent}get path(){var e=this._parent;if(!e)return"";for(var t=this.name;e&&e._parent;)t=e.name+"/"+t,e=e._parent;return t}get root(){for(var e=this;e._parent;)e=e._parent;return e}get children(){return this._children}get graphDepth(){return this._graphDepth}_notifyHierarchyStateChanged(e,t){e._onHierarchyStateChanged(t);for(var s=e._children,i=0,n=s.length;i<n;i++)s[i]._enabled&&this._notifyHierarchyStateChanged(s[i],t)}_onHierarchyStateChanged(e){this._enabledInHierarchy=e,e&&!this._frozen&&this._unfreezeParentToRoot()}_cloneInternal(e){e.name=this.name;var t=this.tags._list;e.tags.clear();for(var s=0;s<t.length;s++)e.tags.add(t[s]);e.localPosition.copy(this.localPosition),e.localRotation.copy(this.localRotation),e.localScale.copy(this.localScale),e.localEulerAngles.copy(this.localEulerAngles),e.position.copy(this.position),e.rotation.copy(this.rotation),e.eulerAngles.copy(this.eulerAngles),e.localTransform.copy(this.localTransform),e._dirtyLocal=this._dirtyLocal,e.worldTransform.copy(this.worldTransform),e._dirtyWorld=this._dirtyWorld,e._dirtyNormal=this._dirtyNormal,e._aabbVer=this._aabbVer+1,e._enabled=this._enabled,e.scaleCompensation=this.scaleCompensation,e._enabledInHierarchy=!1}clone(){var e=new this.constructor;return this._cloneInternal(e),e}copy(e){return e._cloneInternal(this),this}destroy(){this.remove();for(var e=this._children;e.length;){var t=e.pop();t._parent=null,t.destroy()}this.fire("destroy",this),this.off()}find(e,t){var s=[],i=kl(e,t);return this.forEach((e=>{i(e)&&s.push(e)})),s}findOne(e,t){return Ml(this,kl(e,t))}findByTag(){var e=arguments,t=[],s=(i,n)=>{n&&i.tags.has(...e)&&t.push(i);for(var a=0;a<i._children.length;a++)s(i._children[a],!0)};return s(this,!1),t}findByName(e){return this.findOne("name",e)}findByPath(e){for(var t,s=function(e,t){if(n=n.children.find((t=>t.name===i[e])),!n)return{v:null}},i=Array.isArray(e)?e:e.split("/"),n=this,a=0,r=i.length;a<r;++a){var o=s(a);if("object"==((t=o)&&"undefined"!=typeof Symbol&&t.constructor===Symbol?"symbol":typeof t))return o.v}return n}forEach(e,t){e.call(t,this);for(var s=this._children,i=s.length,n=0;n<i;++n)s[n].forEach(e,t)}isDescendantOf(e){for(var t=this._parent;t;){if(t===e)return!0;t=t._parent}return!1}isAncestorOf(e){return e.isDescendantOf(this)}getEulerAngles(){return this.getWorldTransform().getEulerAngles(this.eulerAngles),this.eulerAngles}getLocalEulerAngles(){return this.localRotation.getEulerAngles(this.localEulerAngles),this.localEulerAngles}getLocalPosition(){return this.localPosition}getLocalRotation(){return this.localRotation}getLocalScale(){return this.localScale}getLocalTransform(){return this._dirtyLocal&&(this.localTransform.setTRS(this.localPosition,this.localRotation,this.localScale),this._dirtyLocal=!1),this.localTransform}getPosition(){return this.getWorldTransform().getTranslation(this.position),this.position}getRotation(){return this.rotation.setFromMat4(this.getWorldTransform()),this.rotation}getScale(){return this._scale||(this._scale=new yt),this.getWorldTransform().getScale(this._scale)}getWorldTransform(){return this._dirtyLocal||this._dirtyWorld?(this._parent&&this._parent.getWorldTransform(),this._sync(),this.worldTransform):this.worldTransform}get worldScaleSign(){return 0===this._worldScaleSign&&(this._worldScaleSign=this.getWorldTransform().scaleSign),this._worldScaleSign}remove(){var e;null==(e=this._parent)||e.removeChild(this)}reparent(e,t){this.remove(),e&&(t>=0?e.insertChild(this,t):e.addChild(this))}setLocalEulerAngles(e,t,s){this.localRotation.setFromEulerAngles(e,t,s),this._dirtyLocal||this._dirtifyLocal()}setLocalPosition(e,t,s){e instanceof yt?this.localPosition.copy(e):this.localPosition.set(e,t,s),this._dirtyLocal||this._dirtifyLocal()}setLocalRotation(e,t,s,i){e instanceof kt?this.localRotation.copy(e):this.localRotation.set(e,t,s,i),this._dirtyLocal||this._dirtifyLocal()}setLocalScale(e,t,s){e instanceof yt?this.localScale.copy(e):this.localScale.set(e,t,s),this._dirtyLocal||this._dirtifyLocal()}_dirtifyLocal(){this._dirtyLocal||(this._dirtyLocal=!0,this._dirtyWorld||this._dirtifyWorld())}_unfreezeParentToRoot(){for(var e=this._parent;e;)e._frozen=!1,e=e._parent}_dirtifyWorld(){this._dirtyWorld||this._unfreezeParentToRoot(),this._dirtifyWorldInternal()}_dirtifyWorldInternal(){if(!this._dirtyWorld){this._frozen=!1,this._dirtyWorld=!0;for(var e=0;e<this._children.length;e++)this._children[e]._dirtyWorld||this._children[e]._dirtifyWorldInternal()}this._dirtyNormal=!0,this._worldScaleSign=0,this._aabbVer++}setPosition(e,t,s){e instanceof yt?bl.copy(e):bl.set(e,t,s),null===this._parent?this.localPosition.copy(bl):(Cl.copy(this._parent.getWorldTransform()).invert(),Cl.transformPoint(bl,this.localPosition)),this._dirtyLocal||this._dirtifyLocal()}setRotation(e,t,s,i){if(e instanceof kt?Sl.copy(e):Sl.set(e,t,s,i),null===this._parent)this.localRotation.copy(Sl);else{var n=this._parent.getRotation();Al.copy(n).invert(),this.localRotation.copy(Al).mul(Sl)}this._dirtyLocal||this._dirtifyLocal()}setPositionAndRotation(e,t){if(null===this._parent)this.localPosition.copy(e),this.localRotation.copy(t);else{var s=this._parent.getWorldTransform();Cl.copy(s).invert(),Cl.transformPoint(e,this.localPosition),this.localRotation.setFromMat4(Cl).mul(t)}this._dirtyLocal||this._dirtifyLocal()}setEulerAngles(e,t,s){if(this.localRotation.setFromEulerAngles(e,t,s),null!==this._parent){var i=this._parent.getRotation();Al.copy(i).invert(),this.localRotation.mul2(Al,this.localRotation)}this._dirtyLocal||this._dirtifyLocal()}addChild(e){this._prepareInsertChild(e),this._children.push(e),this._onInsertChild(e)}addChildAndSaveTransform(e){var t=e.getPosition(),s=e.getRotation();this._prepareInsertChild(e),e.setPosition(xl.copy(this.worldTransform).invert().transformPoint(t)),e.setRotation(wl.copy(this.getRotation()).invert().mul(s)),this._children.push(e),this._onInsertChild(e)}insertChild(e,t){this._prepareInsertChild(e),this._children.splice(t,0,e),this._onInsertChild(e)}_prepareInsertChild(e){e.remove()}_fireOnHierarchy(e,t,s){this.fire(e,s);for(var i=0;i<this._children.length;i++)this._children[i]._fireOnHierarchy(t,t,s)}_onInsertChild(e){e._parent=this;var t=e._enabled&&this.enabled;e._enabledInHierarchy!==t&&(e._enabledInHierarchy=t,e._notifyHierarchyStateChanged(e,t)),e._updateGraphDepth(),e._dirtifyWorld(),this._frozen&&e._unfreezeParentToRoot(),e._fireOnHierarchy("insert","inserthierarchy",this),this.fire&&this.fire("childinsert",e)}_updateGraphDepth(){this._graphDepth=this._parent?this._parent._graphDepth+1:0;for(var e=0,t=this._children.length;e<t;e++)this._children[e]._updateGraphDepth()}removeChild(e){var t=this._children.indexOf(e);-1!==t&&(this._children.splice(t,1),e._parent=null,e._fireOnHierarchy("remove","removehierarchy",this),this.fire("childremove",e))}_sync(){if(this._dirtyLocal&&(this.localTransform.setTRS(this.localPosition,this.localRotation,this.localScale),this._dirtyLocal=!1),this._dirtyWorld){if(null===this._parent)this.worldTransform.copy(this.localTransform);else if(this.scaleCompensation){var e,t=this._parent,s=this.localScale,i=t;if(i){for(;i&&i.scaleCompensation;)i=i._parent;i&&(i=i._parent)&&(e=i.worldTransform.getScale(),_l.mul2(e,this.localScale),s=_l)}vl.setFromMat4(t.worldTransform),gl.mul2(vl,this.localRotation);var n=t.worldTransform;t.scaleCompensation&&(yl.mul2(e,t.getLocalScale()),ml.setTRS(t.worldTransform.getTranslation(fl),vl,yl),n=ml),n.transformPoint(this.localPosition,fl),this.worldTransform.setTRS(fl,gl,s)}else this.worldTransform.mulAffine2(this._parent.worldTransform,this.localTransform);this._dirtyWorld=!1}}syncHierarchy(){if(this._enabled&&!this._frozen){this._frozen=!0,(this._dirtyLocal||this._dirtyWorld)&&this._sync();for(var e=this._children,t=0,s=e.length;t<s;t++)e[t].syncHierarchy()}}lookAt(e,t,s,i,n,a){if(void 0===i&&(i=0),void 0===n&&(n=1),void 0===a&&(a=0),e instanceof yt)Pl.copy(e),t instanceof yt?El.copy(t):El.copy(yt.UP);else{if(void 0===s)return;Pl.set(e,t,s),El.set(i,n,a)}Tl.setLookAt(this.getPosition(),Pl,El),Sl.setFromMat4(Tl),this.setRotation(Sl)}translate(e,t,s){e instanceof yt?bl.copy(e):bl.set(e,t,s),bl.add(this.getPosition()),this.setPosition(bl)}translateLocal(e,t,s){e instanceof yt?bl.copy(e):bl.set(e,t,s),this.localRotation.transformVector(bl,bl),this.localPosition.add(bl),this._dirtyLocal||this._dirtifyLocal()}rotate(e,t,s){if(Sl.setFromEulerAngles(e,t,s),null===this._parent)this.localRotation.mul2(Sl,this.localRotation);else{var i=this.getRotation(),n=this._parent.getRotation();Al.copy(n).invert(),Sl.mul2(Al,Sl),this.localRotation.mul2(Sl,i)}this._dirtyLocal||this._dirtifyLocal()}rotateLocal(e,t,s){Sl.setFromEulerAngles(e,t,s),this.localRotation.mul(Sl),this._dirtyLocal||this._dirtifyLocal()}constructor(e="Untitled"){super(),this.tags=new lt(this),this.localPosition=new yt,this.localRotation=new kt,this.localScale=new yt(1,1,1),this.localEulerAngles=new yt,this.position=new yt,this.rotation=new kt,this.eulerAngles=new yt,this._scale=null,this.localTransform=new Et,this._dirtyLocal=!1,this._aabbVer=0,this._frozen=!1,this.worldTransform=new Et,this._dirtyWorld=!1,this._worldScaleSign=0,this._normalMatrix=new xt,this._dirtyNormal=!0,this._right=null,this._up=null,this._forward=null,this._parent=null,this._children=[],this._graphDepth=0,this._enabled=!0,this._enabledInHierarchy=!1,this.scaleCompensation=!1,this.name=e}}var Dl=new Et,Rl=new Et,Ll=new Et;class Fl{static create(e,t,s){var i=new pl;switch(i.node=new Il(e),i.aspectRatio=1,i.aspectRatioMode=1,i._scissorRectClear=!0,t){case 1:i.node.setRotation(Fl.pointLightRotations[s]),i.fov=90,i.projection=0;break;case 2:i.projection=0;break;case 0:i.projection=1}return i}static evalSpotCookieMatrix(e){var t=Fl._spotCookieCamera;t||(t=Fl.create("SpotCookieCamera",2),Fl._spotCookieCamera=t),t.fov=2*e._outerConeAngle;var s=t._node;s.setPosition(e._node.getPosition()),s.setRotation(e._node.getRotation()),s.rotateLocal(-90,0,0),Dl.setTRS(s.getPosition(),s.getRotation(),yt.ONE).invert(),Rl.mul2(t.projectionMatrix,Dl);var i=e.cookieMatrix,n=e.atlasViewport;return Ll.setViewport(n.x,n.y,n.z,n.w),i.mul2(Ll,Rl),i}}Fl.pointLightRotations=[(new kt).setFromEulerAngles(0,90,180),(new kt).setFromEulerAngles(0,-90,180),(new kt).setFromEulerAngles(90,0,0),(new kt).setFromEulerAngles(-90,0,0),(new kt).setFromEulerAngles(0,180,180),(new kt).setFromEulerAngles(0,0,180)],Fl._spotCookieCamera=null;var Bl,Ol=new yt,zl=new Float32Array(6),Vl=new yt(-.5,0,0),Nl=new yt(0,0,.5),Ul={FLAGS:0,COLOR_A:1,COLOR_B:2,SPOT_ANGLES:3,SHADOW_BIAS:4,COOKIE_A:5,COOKIE_B:6,COUNT:7},Hl={POSITION_RANGE:0,SPOT_DIRECTION:1,PROJ_MAT_0:2,ATLAS_VIEWPORT:2,PROJ_MAT_1:3,PROJ_MAT_2:4,PROJ_MAT_3:5,AREA_DATA_WIDTH:6,AREA_DATA_HEIGHT:7,COUNT:8};class Gl{static getShaderDefines(){var e=(e,t)=>Object.keys(e).map((s=>"#define "+t+s+" "+e[s])).join("\n");return Bl||(Bl="\n\n                "+e(Ul,"CLUSTER_TEXTURE_8_")+"\n                "+e(Hl,"CLUSTER_TEXTURE_F_")+"\n            "),Bl}destroy(){var e,t;null==(e=this.lightsTexture8)||e.destroy(),this.lightsTexture8=null,null==(t=this.lightsTextureFloat)||t.destroy(),this.lightsTextureFloat=null}createTexture(e,t,s,i,n){return new ki(e,{name:n,width:t,height:s,mipmaps:!1,format:i,addressU:1,addressV:1,type:Fs,magFilter:0,minFilter:0,anisotropy:1})}setCompressionRanges(e,t){this.invMaxColorValue=1/t,this.invMaxAttenuation=1/e}setBounds(e,t){this.boundsMin.copy(e),this.boundsDelta.copy(t)}uploadTextures(){this.lightsTextureFloat.lock().set(this.lightsFloat),this.lightsTextureFloat.unlock(),this.lightsTexture8.lock().set(this.lights8),this.lightsTexture8.unlock()}updateUniforms(){this._lightsTexture8Id.setValue(this.lightsTexture8),this._lightsTextureFloatId.setValue(this.lightsTextureFloat)}getSpotDirection(e,t){t._node.getWorldTransform().getY(e).mulScalar(-1),e.normalize()}getLightAreaSizes(e){var t=e._node.getWorldTransform();return t.transformVector(Vl,Ol),zl[0]=Ol.x,zl[1]=Ol.y,zl[2]=Ol.z,t.transformVector(Nl,Ol),zl[3]=Ol.x,zl[4]=Ol.y,zl[5]=Ol.z,zl}addLightDataFlags(e,t,s,i,n,a){e[t+0]=i?255:0,e[t+1]=this.areaLightsEnabled?64*s._shape:0,e[t+2]=255*s._falloffMode,e[t+3]=n?255*a:0}addLightDataColor(e,t,s,i){var n=this.invMaxColorValue,a=s._colorLinear;_t.float2Bytes(a[0]*n,e,t+0,2),_t.float2Bytes(a[1]*n,e,t+2,2),_t.float2Bytes(a[2]*n,e,t+4,2),e[t+6]=i?255:0;var r=!!(1&s.mask),o=!!(2&s.mask);e[t+7]=r&&o?127:o?255:0}addLightDataSpotAngles(e,t,s){_t.float2Bytes(.499999*s._innerConeAngleCos+.5,e,t+0,2),_t.float2Bytes(.499999*s._outerConeAngleCos+.5,e,t+2,2)}addLightDataShadowBias(e,t,s){var i=s.getRenderData(null,0),n=s._getUniformBiasValues(i);_t.float2BytesRange(n.bias,e,t,-1,20,2),_t.float2Bytes(n.normalBias,e,t+2,2)}addLightDataCookies(e,t,s){var i="rgb"===s._cookieChannel;if(e[t+0]=Math.floor(255*s.cookieIntensity),e[t+1]=i?255:0,!i){var n=s._cookieChannel;e[t+4]="rrr"===n?255:0,e[t+5]="ggg"===n?255:0,e[t+6]="bbb"===n?255:0,e[t+7]="aaa"===n?255:0}}addLightData(e,t){var s=2===e._type,i=e.atlasViewportAllocated,n=this.cookiesEnabled&&!!e._cookie&&i,a=this.areaLightsEnabled&&0!==e.shape,r=this.shadowsEnabled&&e.castShadows&&i,o=e._node.getPosition(),l=null,h=null;s?r?l=e.getRenderData(null,0).shadowMatrix:n&&(l=Fl.evalSpotCookieMatrix(e)):(r||n)&&(h=e.atlasViewport);var c=this.lights8,d=t*this.lightsTexture8.width*4;this.addLightDataFlags(c,d+4*Ul.FLAGS,e,s,r,e.shadowIntensity),this.addLightDataColor(c,d+4*Ul.COLOR_A,e,n),s&&this.addLightDataSpotAngles(c,d+4*Ul.SPOT_ANGLES,e),e.castShadows&&this.addLightDataShadowBias(c,d+4*Ul.SHADOW_BIAS,e),n&&this.addLightDataCookies(c,d+4*Ul.COOKIE_A,e);var u=this.lightsFloat,p=t*this.lightsTextureFloat.width*4;if(u[p+4*Hl.POSITION_RANGE+0]=o.x,u[p+4*Hl.POSITION_RANGE+1]=o.y,u[p+4*Hl.POSITION_RANGE+2]=o.z,u[p+4*Hl.POSITION_RANGE+3]=e.attenuationEnd,s&&(this.getSpotDirection(Ol,e),u[p+4*Hl.SPOT_DIRECTION+0]=Ol.x,u[p+4*Hl.SPOT_DIRECTION+1]=Ol.y,u[p+4*Hl.SPOT_DIRECTION+2]=Ol.z),l)for(var m=l.data,f=0;f<16;f++)u[p+4*Hl.PROJ_MAT_0+f]=m[f];if(h&&(u[p+4*Hl.ATLAS_VIEWPORT+0]=h.x,u[p+4*Hl.ATLAS_VIEWPORT+1]=h.y,u[p+4*Hl.ATLAS_VIEWPORT+2]=h.z/3),a){var g=this.getLightAreaSizes(e);u[p+4*Hl.AREA_DATA_WIDTH+0]=g[0],u[p+4*Hl.AREA_DATA_WIDTH+1]=g[1],u[p+4*Hl.AREA_DATA_WIDTH+2]=g[2],u[p+4*Hl.AREA_DATA_HEIGHT+0]=g[3],u[p+4*Hl.AREA_DATA_HEIGHT+1]=g[4],u[p+4*Hl.AREA_DATA_HEIGHT+2]=g[5]}}constructor(e){this.areaLightsEnabled=!1,this.device=e,this.cookiesEnabled=!1,this.shadowsEnabled=!1,this.areaLightsEnabled=!1,this.maxLights=255;var t=Ul.COUNT;this.lights8=new Uint8ClampedArray(4*t*this.maxLights),this.lightsTexture8=this.createTexture(this.device,t,this.maxLights,7,"LightsTexture8"),this._lightsTexture8Id=this.device.scope.resolve("lightsTexture8");var s=Hl.COUNT;this.lightsFloat=new Float32Array(4*s*this.maxLights),this.lightsTextureFloat=this.createTexture(this.device,s,this.maxLights,Zt,"LightsTextureFloat"),this._lightsTextureFloatId=this.device.scope.resolve("lightsTextureFloat"),this.invMaxColorValue=0,this.invMaxAttenuation=0,this.boundsMin=new yt,this.boundsDelta=new yt}}var Wl=new yt,jl=new yt,ql=new yt,Xl=new Ft,Yl=1e-6;class $l{constructor(){this.light=null,this.min=new yt,this.max=new yt}}class Kl{set maxCellLightCount(e){e!==this._maxCellLightCount&&(this._maxCellLightCount=e,this._cellsDirty=!0)}get maxCellLightCount(){return this._maxCellLightCount}set cells(e){Wl.copy(e).floor(),this._cells.equals(Wl)||(this._cells.copy(Wl),this._cellsLimit.copy(Wl).sub(yt.ONE),this._cellsDirty=!0)}get cells(){return this._cells}destroy(){this.lightsBuffer.destroy(),this.releaseClusterTexture()}releaseClusterTexture(){this.clusterTexture&&(this.clusterTexture.destroy(),this.clusterTexture=null)}registerUniforms(e){this._clusterSkipId=e.scope.resolve("clusterSkip"),this._clusterMaxCellsId=e.scope.resolve("clusterMaxCells"),this._clusterWorldTextureId=e.scope.resolve("clusterWorldTexture"),this._clusterTextureSizeId=e.scope.resolve("clusterTextureSize"),this._clusterTextureSizeData=new Float32Array(3),this._clusterBoundsMinId=e.scope.resolve("clusterBoundsMin"),this._clusterBoundsMinData=new Float32Array(3),this._clusterBoundsDeltaId=e.scope.resolve("clusterBoundsDelta"),this._clusterBoundsDeltaData=new Float32Array(3),this._clusterCellsCountByBoundsSizeId=e.scope.resolve("clusterCellsCountByBoundsSize"),this._clusterCellsCountByBoundsSizeData=new Float32Array(3),this._clusterCellsDotId=e.scope.resolve("clusterCellsDot"),this._clusterCellsDotData=new Float32Array(3),this._clusterCellsMaxId=e.scope.resolve("clusterCellsMax"),this._clusterCellsMaxData=new Float32Array(3),this._clusterCompressionLimit0Id=e.scope.resolve("clusterCompressionLimit0"),this._clusterCompressionLimit0Data=new Float32Array(2)}updateParams(e){e&&(this.cells=e.cells,this.maxCellLightCount=e.maxLightsPerCell,this.lightsBuffer.cookiesEnabled=e.cookiesEnabled,this.lightsBuffer.shadowsEnabled=e.shadowsEnabled,this.lightsBuffer.areaLightsEnabled=e.areaLightsEnabled)}updateCells(){if(this._cellsDirty){this._cellsDirty=!1;var e=this._cells.x,t=this._cells.y,s=this._cells.z,i=e*t*s,n=this.maxCellLightCount*i,a=Math.ceil(Math.sqrt(n));a=pt.roundUp(a,this.maxCellLightCount);var r=Math.ceil(n/a);this._clusterCellsMaxData[0]=e,this._clusterCellsMaxData[1]=t,this._clusterCellsMaxData[2]=s,this._clusterCellsDotData[0]=this.maxCellLightCount,this._clusterCellsDotData[1]=e*s*this.maxCellLightCount,this._clusterCellsDotData[2]=e*this.maxCellLightCount,this.clusters=new Uint8ClampedArray(n),this.counts=new Int32Array(i),this._clusterTextureSizeData[0]=a,this._clusterTextureSizeData[1]=1/a,this._clusterTextureSizeData[2]=1/r,this.releaseClusterTexture(),this.clusterTexture=this.lightsBuffer.createTexture(this.device,a,r,52,"ClusterTexture")}}uploadTextures(){this.clusterTexture.lock().set(this.clusters),this.clusterTexture.unlock(),this.lightsBuffer.uploadTextures()}updateUniforms(){this._clusterSkipId.setValue(this._usedLights.length>1?0:1),this.lightsBuffer.updateUniforms(),this._clusterWorldTextureId.setValue(this.clusterTexture),this._clusterMaxCellsId.setValue(this.maxCellLightCount);var e=this.boundsDelta;this._clusterCellsCountByBoundsSizeData[0]=this._cells.x/e.x,this._clusterCellsCountByBoundsSizeData[1]=this._cells.y/e.y,this._clusterCellsCountByBoundsSizeData[2]=this._cells.z/e.z,this._clusterCellsCountByBoundsSizeId.setValue(this._clusterCellsCountByBoundsSizeData),this._clusterBoundsMinData[0]=this.boundsMin.x,this._clusterBoundsMinData[1]=this.boundsMin.y,this._clusterBoundsMinData[2]=this.boundsMin.z,this._clusterBoundsDeltaData[0]=e.x,this._clusterBoundsDeltaData[1]=e.y,this._clusterBoundsDeltaData[2]=e.z,this._clusterCompressionLimit0Data[0]=this._maxAttenuation,this._clusterCompressionLimit0Data[1]=this._maxColorValue,this._clusterTextureSizeId.setValue(this._clusterTextureSizeData),this._clusterBoundsMinId.setValue(this._clusterBoundsMinData),this._clusterBoundsDeltaId.setValue(this._clusterBoundsDeltaData),this._clusterCellsDotId.setValue(this._clusterCellsDotData),this._clusterCellsMaxId.setValue(this._clusterCellsMaxData),this._clusterCompressionLimit0Id.setValue(this._clusterCompressionLimit0Data)}evalLightCellMinMax(e,t,s){t.copy(e.min),t.sub(this.boundsMin),t.div(this.boundsDelta),t.mul2(t,this.cells),t.floor(),s.copy(e.max),s.sub(this.boundsMin),s.div(this.boundsDelta),s.mul2(s,this.cells),s.ceil(),t.max(yt.ZERO),s.min(this._cellsLimit)}collectLights(e){var t=this.lightsBuffer.maxLights,s=this._usedLights,i=1;e.forEach((e=>{var n,a=!!(3&e.mask),r=2===e.type&&0===e._outerConeAngle;e.enabled&&0!==e.type&&e.visibleThisFrame&&e.intensity>0&&a&&!r&&(i<t&&(i<s.length?n=s[i]:(n=new $l,s.push(n)),n.light=e,e.getBoundingBox(Xl),n.min.copy(Xl.getMin()),n.max.copy(Xl.getMax()),i++))})),s.length=i}evaluateBounds(){var e=this._usedLights,t=this.boundsMin,s=this.boundsMax;if(e.length>1){t.copy(e[1].min),s.copy(e[1].max);for(var i=2;i<e.length;i++)t.min(e[i].min),s.max(e[i].max)}else t.set(0,0,0),s.set(1,1,1);this.boundsDelta.sub2(s,t),this.lightsBuffer.setBounds(t,this.boundsDelta)}evaluateCompressionLimits(){for(var e=0,t=0,s=this._usedLights,i=1;i<s.length;i++){var n=s[i].light;e=Math.max(n.attenuationEnd,e);var a=n._colorLinear;t=Math.max(a[0],t),t=Math.max(a[1],t),t=Math.max(a[2],t)}this._maxAttenuation=e+Yl,this._maxColorValue=t+Yl,this.lightsBuffer.setCompressionRanges(this._maxAttenuation,this._maxColorValue)}updateClusters(e){this.counts.fill(0),this.clusters.fill(0),this.lightsBuffer.areaLightsEnabled=!!e&&e.areaLightsEnabled;for(var t=this._cells.x,s=this._cells.z,i=this.counts,n=this._maxCellLightCount,a=this.clusters,r=this.maxCellLightCount,o=this._usedLights,l=1;l<o.length;l++){var h=o[l],c=h.light;this.lightsBuffer.addLightData(c,l),this.evalLightCellMinMax(h,jl,ql);for(var d=jl.x,u=ql.x,p=jl.y,m=ql.y,f=jl.z,g=ql.z,v=d;v<=u;v++)for(var _=f;_<=g;_++)for(var y=p;y<=m;y++){var x=v+t*(_+y*s),w=i[x];w<n&&(a[r*x+w]=l,i[x]=w+1)}}}update(e,t){void 0===t&&(t=null),this.updateParams(t),this.updateCells(),this.collectLights(e),this.evaluateBounds(),this.evaluateCompressionLimits(),this.updateClusters(t),this.uploadTextures()}activate(){this.updateUniforms()}constructor(e){this.device=e,this.name="Untitled",this.reportCount=0,this.boundsMin=new yt,this.boundsMax=new yt,this.boundsDelta=new yt,this._cells=new yt(1,1,1),this._cellsLimit=new yt,this.cells=this._cells,this.maxCellLightCount=4,this._maxAttenuation=0,this._maxColorValue=0,this._usedLights=[],this._usedLights.push(new $l),this.lightsBuffer=new Gl(e),this.registerUniforms(e)}}var Zl=null,Jl=()=>{if(!Zl){var e=atob("muPIHORMLNDCz4DxVR/ZvYfAUVEFR47KRIC4nwAAAAAP7WxlhD6Ci+2HCe7BF8jRAPZwdH2UPpI5PdLCJdkvG4UTaNDJ/0crAzne71GCrb4kbdMjjCEGzdX6fNxDMLJq5xkeoIVTdfiZkodEeArmZmp/FQzFjD4x8iOW7Dg64n+3mWqyEwLxXT8zoJXfbw8QJKDCaarUYyTlMzNFHbgUe9IQV7g4YOgtSKpIFZJ0qERm7u4PpmiF89ktHWCywaGmD6h+hfh2/Zd8KYlKqqo4Cem4T42bT/Z9FpCQF1hhSjfBzZ5XFn/y3jegWC6u86KuELRundQS/1Rp+XuKKGIgRv3CvP5y749yqLlFO495JOT3+f2CXgd71npU0/KjjpkZucbJ5m78IVyuSrSozc9jgBUhDrz0hFsyb7LFUH9//wJbBgLdNWJZObfKxrNt8TliLA9w9sXFv6g26iXpf6r/BqcAusj/QzGBZuoUGeEtw8BCXCZ3jUiw4hvM18ZVqlUD3C40LAFXW6FRjuAZGRNstb0/qVk4skwyT+MHrvRorI4rKHVMWZmKyAkzL/78u/9pMQuX14pZN50b2PHn6fRxeaCQLsfT4dpvIkWWFuFVENZIh+8xgR6lU+85W0PPdAu1j99kcCG40JBQa4JMyRzq6qriOBLtqF87vpCJan0WEduVr/mOYkS00urVA0mA6M3031+GmGmW48PaJDYOEIb3bIXWPaLoAOEinX1TN3+/vwhG6nqJu0TdHpedS7QsGZIoxH3nQYYjQP1jmbahlbNngw5ogsGk1y50XZyUmQBY+/JBJ3Unu4dApm+WmPwHPU9gLb+4mHh4BiY6M86pq+WeTyWdI3s0CXPEtHGXZ8zMZgUoyRomBi1VdazzuN+WOmQ9Pa0Z0tlNopUi8AJ4x2Xn4mmOKEbXLxlbVsWu8XhuDGYFOGCRVdSqDPXrHU5SDdUlti3k5///SBwzTMwK3L4a1H7w4lnpEas6////AfX8asyIBfeFXVJ3tgvxQ/blZuUKyIODIfr/UzdWNu7pciLBpdZRZ4pIfZ1R6szq+XNxkGG///8EZFpu7VHAhFWqHEOrB9unw+YQa5o8/9IR/V5/zq+986rJSyfgJKt2u9hxU1wzyQWPjJGvzG9+eWWxGFOHVKqI4jBQALwZZswesnvZ2UmmkEXdiRpz8B+oWE7PY70ZTMndisYSXg2TqoI+3y9BxbnY2Y4EfbdcRhAvG59NqDENNYbxKvK5HJfPG5M+Wi2AcpLVJrD6caiEOzgSoVNSgQK8fm2M3zGcF4xtClv/8Hs9oD7C3jitTATYNQxmKqKf1LhIxzf1bmfiNn7UKFmcJu4sLqVLwxGSue3taBEyknkw5hXTsUCvqmmL/f8n/w0giR7Hu/9EHvpkz3yuu64TioMkzdTJ30i0+hFnQqW1+v9mMwq+z9qGX0UFu9MomvVG2xod6vc12AAAAACq7sGa5qptFR0jF3nQt/D+7PibKYahaxP3hEixPbGi9nwNf2LAa7LkEZRKxzXeCD64Xpii5n+8Kpg8eHIv7AWXZltgMoGltmoJ0XGdOCL8WkzphvR9N2o3ARSZ42l5e5Pe4B58MCRlP3EKv+mcloknH+fto5BWsmEutW6KvjOVsznFCktkSczVk4aGvj9VXlRcLeDoKG8RkBgdcNG2bf8HUL4MT2DM+ar7NImJhKpxakX4Vk0CnP+/XNhl5UsP0lXgeZXPoDBMSW5An+DXlTCO5FQGwSPYwHLKYVIimEdAoVe49rQLaaNcye5LxU2/c5TijTgJtD5eQQIe1snxauj5jZsxJBUJdoP/zqpjqv8qBruoPsVsP8N44PCUW5Dd0DzqjSS/Dl5mI9cn1w2ndN/0KAEm1QAAAACwu6KM/083IBbH5bPa/9oHUwcU8I9v3j6/v18QYammrf+P6VL///8BrpuM3fOLCxaLNOFNF1zPbPYTP65ni6njft4eVcyrVXRQFrs52tr35StiSp55edVDCBC0H5rIfac6nzUwxQSt7y15QoKb+5zebEQUmVbrPjXuUa19Ey7sqXMiSUKHaw72PJKDdrutJoQr3u6lEYJ8K0MakWKj9zjTFi4X94TsKYco0GrLeB60M6D8M/80rhXUW8iMequg8y5F838WI0+gp3GBN5Kj/xIOxTWQuUaPV/LwvARr1VH93BFgGZR1MFW0Ua30GbYmdnAgo9VWy8SQtpDUgGE2r2zq2eTEMCL7sMKmE1hchVhuF/TCq9iXKEm86kzOf3Rp9ZnCxbpDUj+FKNxVyXe6pVZkRXv/m95SnB/EB8aME29N85MtAcDoXWlor8De2Q5Dg1tar+8wgiZufbMam81j//ASUohoR/zSh2KG4bvT6mkIPz6C5/98DC3LaWlaEZ1zA5JORZRu6J/a0GY285sEYzw71YqOT1ihAG0z5SDt1xNiDQWZdFpndArp6xWhqSDkRb4kSJEHb9liPvw7uLV/6i5MVf//A9Qjr8xkAEUh+KDI+zdtJ68d6MBOktg1iyp/SCq8O9f5pbamn1VVVQPRTWqNBvhQKa07s6P0lc9Luu/3gw4HeyOUfz8MxMwV4UQhua+t9cr4bz/nIB2wnDSK1K7I94M+s6C84htaX/CNlMQUSs2KJO+yaebfTbkNX5yWcqEJevo0vbKUiETuFXiL019A3E+lmsyZMwXrXLLiQAZ5t9+jI3JobhJTMiDH5ZOQ+8Jau5555NMjHSscP9qCVaa40doh+1a3Ukf6jqBmLddgh79/fwTfCyqiuldNkUoy+nUp+4nerwg0OjtGv2x485PJOJvUEokNhYIdWjpx7BWk0VZGWOp3jSFTJ2bnu6KCduZtG/UcBC9RZ3W/jMSfSMw4Etr/DoD/XYP2V5Ovw+YoM3F5g2dGLdvuG6ZkVGLE6Dk5Zr+sdSyGliJP1y2OFf/KFO0RWO+3gsGhesTnfZVpTd8/HwgO216gwaqo+vY3TljfJWowY+i0p0Os4SLn/1wLqDHMlszggmT/D8MRFzs+pLv6LNJSsNZ/r41mWi/rF6ZcKp/yzJdK0VU44hskq3RGpgO6mIpJDsf/mZkFrz0yYOMLbuaj/wp1v7JMFM5eqvBhmTd7U8frQAtHtys4zgpjZmzUhOVTfNNLifElGXADlqHGKrkBT/nYwX8ZRm3RjvyPvjKyEqEGKUpVnvOGx+NKPHiWM//ZDpDVGvvrjmk8RPF/wiYZD3+Us8YCXjrVOfjdd1UPAfjLp8jgSn4me7DPTpz1Ggy9XL80guFO7ECT10AvILKfD18Qx+KY/f8aRqu0oOO8hfKRFZa9PUJwCsp6VdZz6LFkm2b9Pl2LIifCwzRy7TpdG2uAtOxP2OemY26bJMa9ZGSLIRlMsgpDpnDJwd0oa5pQ13x1hrHf52HpulUWonGWsfXZbSQYKu9bnEN76ciQih0opN3deDVrbrxorfVlnCmL1R9zq3ePGWIv21c7pW8kEiFTM5JX8dAw867s/60cf79/BH+MDFCZBHlz1L+qGOJf/1txhhmrf3//As+RIJwevDb+fgNXVeHw67QptZegayhrEwr5Gy+EPo1RLaMtPbqOZYoVzXzwzjMFWZxyUG9YUIf6////AQWy84iAygLk9COtXt92+0mT/xg0zMzMBeLkb8y9SL2TDXgSX422hDgpGNLJyuPioA+YJ91G8znrpNqHkwYyscaJDEc9Vc+j4cXle3hvcd2JqDQH2lBZxDn6mUTs0b75raMvbs727codX01Anj8f3wir9P2xQaQ22v/TxCMglKDFoTjaP01XTLgxnTvPv02JgEUrW6UDgOnobFpLdvKdlypgIzPcq14fgXU5tvVW0FEs7VRlsG1IyA69fN4n+awHhT34cE+xUvdj86C8LgAsFheTjI9Ht9EyYAAAAAAVBVKRx2wLgUTI0/2QfyJo2riRw3JDqzEShmx/Lifo6mRkQVbS7X53t+EvKxcXogtdts31e9MRHdcHgsA8rt4/mt2unlzQ/wsU8Gu7+W6Oj7eD8EQdDp5XlCsVaS/AV/t5ZpPOHR3rGpyAJe9IPV+xMrBL1Oz/8MQhFs31h0N1cVnq371uqIJYHyafKH1jteAK3VpMXBcuC+yt0ZeKyRUY4QhdrJJ4tJ1wg3Hu6kDsbovxupTMkGdRrm8oZSoYPbJ+PwH/xotgTdkA1205vUEfnqkI04T/fnnd1fiZW5AwNcggd7fi4j5zasmcntZexIxqFZQMzMJpfndmI5jn17cgn5EV5t9XN0C///8Q9wlJpMGXdoiaMTG2sVyHQsn8mWRISCLNG777S0OuDRP2GlLcJ2UeOg7Fo8hTNPeJ//iTJhyqxhKRUntdXOihq2wfKfH///8B0GGrwT+fSOQRdctKxjjGCSS11d6BlQ9BDfE0J6Z25FaNTKGpFKNCMr2G/041KpWwBLVe1k08vncseQbKZdXi8x1t9XA45U/Wd43D9wAh3Tal0aiLVzGPusOZ1F+W3TWoqlX/A95+dNef11TsuGful+ctGssldk3fqpfqh+43XTxL42+leSHoF/dWHYGX6maqUEuLX7UB+r/6Llr4LKocbVIeu+hB9QTPfz9fCP8RyWmX4SmbhMFsNtCijV7lVcwejLKlvl0GfCndnWV7/39VBrtTRuUx92oke3GBgKkC5fdGK0YvNK+xenKaDmsHDjNFUM3NMz3ZiXXFuLgojosPVCDEl2W5BjX3Ms+j0GSqACHmh0+RPWyuNm/Qe8vFf9AW7N1uRaxWirrUytqEJnJ4/Flm8hSoiZ2NQBsS6w/yQlC4gCaFo8q4nyY6AFdo4hiwhBXzbNKKvZvktCjSCukRR/BbYVbNwZi2Yh3hGodEacLW8qijiWJODf0P2bhfaiPspPT4lYJBgi/KfcFwCfvyUIgkJOv///8CG/JEepRBLaMFE+2TgrqsJXOVOWHt6g/bFwVLLMVBsMR50dis/39/AlBX+/rMTJkUQrnlxpR2iu0Tp8tATkRYGmDIrcAiRP8PjoWIlb7/0ecTdSCE9Y58+a+n/FovJQTVF4F2jAxMZhTgrM/KVS5BQu6bVbkWY5HXnxRshks3urDdW4RkWp4M4TeLmFK5KF/uHkkiO5Kv96RioH984v/CSDBnG+BwlnU9B+o7Y+0X0Nob+0pLsStxjvPXMy2eCpzhOWV4XbObBHN4UE2sLQ/DIqXhOzxVf38GlTi6aG7EnePO7TRJm9yOfUUcqq1I2iQHrVDqn3TUNRi/lMw8KbMW/3/nqCz/Ef8PoW5Qxcz2yHR/f78EPB2Stbd+ZFmfNTUYILzsb9YNhpaHcaymYrBiNHmFE3Y4ccYJ25Prqm7zHobGHED8/93ZNlWro9vcKivGZs31UiK1k5zjUhexUgbqJb+fUTjxce/7Zly8a5KMC1fX5nfjPgibdvzbXV1jRT2asXvmSAusaLdq1TSIJ8fXINk5AtT34EWPAsfP9IFQqM5K11O6saoHJA==");Zl=Uint8Array.from(e,(e=>e.charCodeAt(0)))}},Ql=()=>(Jl(),Zl);class eh{_next(){this.seed=(this.seed+4)%Zl.length}value(){return this._next(),Zl[this.seed]/255}vec4(e){return void 0===e&&(e=new bt),this._next(),e.set(Zl[this.seed],Zl[this.seed+1],Zl[this.seed+2],Zl[this.seed+3]).mulScalar(1/255)}constructor(e=0){this.seed=0,this.seed=4*e,Jl()}}var th=[new yt(-1,0,0),new yt(1,0,0),new yt(0,-1,0),new yt(0,1,0),new yt(0,0,-1),new yt(0,0,1)];class sh{update(e,t){for(var s=this.colors,{r:i,g:n,b:a}=e,r=0;r<6;r++)s[3*r]=i,s[3*r+1]=n,s[3*r+2]=a;for(var o=0;o<t.length;o++){var l=t[o];if(0===l._type)for(var h=0;h<6;h++){var c=Math.max(th[h].dot(l._direction),0)*l._intensity,d=l._color;s[3*h]+=d.r*c,s[3*h+1]+=d.g*c,s[3*h+2]+=d.b*c}}}constructor(){this.colors=new Float32Array(18)}}var ih=new Ti,nh=e=>ih.get(e,(()=>{var t=Ql(),s=Math.sqrt(t.length/4);return((e,t,s,i)=>{var n=new ki(e,{name:""+t+s,width:s,height:s,format:7,addressU:0,addressV:0,type:Fs,magFilter:0,minFilter:0,anisotropy:1,mipmaps:!1});return n.lock().set(i),n.unlock(),n})(e,"BlueNoise",s,t)}));class ah{destroy(){this.texture&&(this.texture.destroy(),this.texture=null);for(var e=this.renderTargets,t=0;t<e.length;t++)e[t].destroy();this.renderTargets.length=0}static getShadowFiltering(e,t){return 3===t?e.extTextureFloatLinear?1:0:1}static create(e,t){return 1===t._type?this.createCubemap(e,t._shadowResolution,t._shadowType):this.create2dMap(e,t._shadowResolution,t._shadowType)}static createAtlas(e,t,s){for(var i=this.create2dMap(e,t,s),n=i.renderTargets,a=n[0],r=0;r<5;r++)n.push(a);return i}static create2dMap(e,t,s){var i,n=to.get(s),a=n.format;a===Jt&&!e.textureFloatRenderable&&e.textureHalfFloatRenderable&&(a=50);var r=null==(i=ls.get(a))?void 0:i.name,o=this.getShadowFiltering(e,s),l=new ki(e,{format:a,width:t,height:t,mipmaps:!1,minFilter:o,magFilter:o,addressU:1,addressV:1,name:"ShadowMap2D_"+r}),h=null;return(null==n?void 0:n.pcf)?(l.compareOnRead=!0,l.compareFunc=1,h=new ln({depthBuffer:l})):h=new ln({colorBuffer:l,depth:!0}),e.isWebGPU&&(h.flipY=!0),new ah(l,[h])}static createCubemap(e,t,s){var i,n=to.get(s),a=null==(i=ls.get(n.format))?void 0:i.name,r=6===s,o=r?0:1,l=new ki(e,{format:null==n?void 0:n.format,width:t,height:t,cubemap:!0,mipmaps:!1,minFilter:o,magFilter:o,addressU:1,addressV:1,name:"ShadowMapCube_"+a});r||(l.compareOnRead=!0,l.compareFunc=1);for(var h=[],c=0;c<6;c++)r?h.push(new ln({colorBuffer:l,face:c,depth:!0})):h.push(new ln({depthBuffer:l,face:c}));return new ah(l,h)}constructor(e,t){this.texture=e,this.cached=!1,this.renderTargets=t}}var rh=[],oh=[],lh=new bt,hh=new bt;class ch{constructor(e){this.size=Math.floor(1024*e.w),this.used=!1,this.lightId=-1,this.rect=e}}class dh{destroy(){this.destroyShadowAtlas(),this.destroyCookieAtlas()}destroyShadowAtlas(){var e;null==(e=this.shadowAtlas)||e.destroy(),this.shadowAtlas=null}destroyCookieAtlas(){var e,t;null==(e=this.cookieAtlas)||e.destroy(),this.cookieAtlas=null,null==(t=this.cookieRenderTarget)||t.destroy(),this.cookieRenderTarget=null}allocateShadowAtlas(e,t){var s;void 0===t&&(t=0);var i=null==(s=this.shadowAtlas)?void 0:s.texture.format,n=to.get(t).format;if(!this.shadowAtlas||this.shadowAtlas.texture.width!==e||i!==n){this.version++,this.destroyShadowAtlas(),this.shadowAtlas=ah.createAtlas(this.device,e,t),this.shadowAtlas.cached=!0;var a=4/this.shadowAtlasResolution;this.scissorVec.set(a,a,-2*a,-2*a)}}allocateCookieAtlas(e){this.cookieAtlas.width!==e&&(this.cookieRenderTarget.resize(e,e),this.version++)}allocateUniforms(){this._shadowAtlasTextureId=this.device.scope.resolve("shadowAtlasTexture"),this._shadowAtlasParamsId=this.device.scope.resolve("shadowAtlasParams"),this._shadowAtlasParams=new Float32Array(2),this._cookieAtlasTextureId=this.device.scope.resolve("cookieAtlasTexture")}updateUniforms(){var e=this.shadowAtlas.renderTargets[0].depthBuffer;this._shadowAtlasTextureId.setValue(e),this._shadowAtlasParams[0]=this.shadowAtlasResolution,this._shadowAtlasParams[1]=this.shadowEdgePixels,this._shadowAtlasParamsId.setValue(this._shadowAtlasParams),this._cookieAtlasTextureId.setValue(this.cookieAtlas)}subdivide(e,t){var s=t.atlasSplit;if(!s){var i=Math.ceil(Math.sqrt(e));(s=oh)[0]=i,s.length=1}var n,a;if(n=s,a=this.atlasSplit,n.length!==a.length||!n.every(((e,t)=>e===a[t]))){this.version++,this.slots.length=0,this.atlasSplit.length=0,this.atlasSplit.push(...s);var r=this.atlasSplit[0];if(r>1)for(var o=1/r,l=0;l<r;l++)for(var h=0;h<r;h++){var c=new bt(l*o,h*o,o,o),d=this.atlasSplit[1+l*r+h];if(d>1)for(var u=0;u<d;u++)for(var p=0;p<d;p++){var m=o/d,f=new bt(c.x+u*m,c.y+p*m,m,m);this.slots.push(new ch(f))}else this.slots.push(new ch(c))}else this.slots.push(new ch(new bt(0,0,1,1)));this.slots.sort(((e,t)=>t.size-e.size))}}collectLights(e,t){var s=t.cookiesEnabled,i=t.shadowsEnabled,n=!1,a=!1,r=rh;r.length=0;return(s||i)&&(e=>{for(var t=0;t<e.length;t++){var o=e[t];if(o.visibleThisFrame){var l=i&&o.castShadows,h=s&&!!o.cookie;n||(n=l),a||(a=h),(l||h)&&r.push(o)}}})(e),r.sort(((e,t)=>t.maxScreenSize-e.maxScreenSize)),n&&this.allocateShadowAtlas(this.shadowAtlasResolution,t.shadowType),a&&this.allocateCookieAtlas(this.cookieAtlasResolution),(n||a)&&this.subdivide(r.length,t),r}setupSlot(e,t){e.atlasViewport.copy(t);for(var s=e.numShadowFaces,i=0;i<s;i++)if(e.castShadows||e._cookie){if(lh.copy(t),hh.copy(t),2===e._type&&lh.add(this.scissorVec),1===e._type){var n=lh.z/3,a=this.cubeSlotsOffsets[i];lh.x+=n*a.x,lh.y+=n*a.y,lh.z=n,lh.w=n,hh.copy(lh)}if(e.castShadows){var r=e.getRenderData(null,i);r.shadowViewport.copy(lh),r.shadowScissor.copy(hh)}}}assignSlot(e,t,s){e.atlasViewportAllocated=!0;var i=this.slots[t];i.lightId=e.id,i.used=!0,s&&(e.atlasSlotUpdated=!0,e.atlasVersion=this.version,e.atlasSlotIndex=t)}update(e,t){this.shadowAtlasResolution=t.shadowAtlasResolution,this.cookieAtlasResolution=t.cookieAtlasResolution;var s=this.collectLights(e,t);if(s.length>0){for(var i=this.slots,n=0;n<i.length;n++)i[n].used=!1;for(var a=Math.min(s.length,i.length),r=0;r<a;r++){var o=s[r];o.castShadows&&(o._shadowMap=this.shadowAtlas);var l=i[o.atlasSlotIndex];if(o.atlasVersion===this.version&&o.id===(null==l?void 0:l.lightId)){var h=i[o.atlasSlotIndex];h.size!==i[r].size||h.used||this.assignSlot(o,o.atlasSlotIndex,!1)}}for(var c=0,d=0;d<a;d++){for(;c<i.length&&i[c].used;)c++;var u=s[d];u.atlasViewportAllocated||this.assignSlot(u,c,!0);var p=i[u.atlasSlotIndex];this.setupSlot(u,p.rect)}}this.updateUniforms()}constructor(e){this.device=e,this.version=1,this.shadowAtlasResolution=2048,this.shadowAtlas=null,this.shadowEdgePixels=3,this.cookieAtlasResolution=4,this.cookieAtlas=new ki(this.device,{name:"CookieAtlas",width:this.cookieAtlasResolution,height:this.cookieAtlasResolution,format:ss,cubemap:!1,mipmaps:!1,minFilter:0,magFilter:0,addressU:1,addressV:1}),this.cookieRenderTarget=new ln({colorBuffer:this.cookieAtlas,depth:!1,flipY:!0}),this.slots=[],this.atlasSplit=[],this.cubeSlotsOffsets=[new wt(0,0),new wt(0,1),new wt(1,0),new wt(1,1),new wt(2,0),new wt(2,1)],this.scissorVec=new bt,this.allocateShadowAtlas(1),this.allocateCookieAtlas(1),this.allocateUniforms()}}var uh=[];uh[0]={src:1,dst:1,op:2},uh[3]={src:1,dst:0,op:0},uh[2]={src:6,dst:8,op:0,alphaSrc:1},uh[4]={src:1,dst:8,op:0},uh[1]={src:1,dst:1,op:0},uh[6]={src:6,dst:1,op:0},uh[7]={src:4,dst:2,op:0},uh[8]={src:5,dst:1,op:0},uh[5]={src:4,dst:0,op:0},uh[9]={src:1,dst:1,op:3},uh[10]={src:1,dst:1,op:4};var ph=0;class mh{set chunks(e){this._dirtyShader=!0,this._chunks=e}get chunks(){return this._dirtyShader=!0,this._chunks}set depthBias(e){this._depthState.depthBias=e}get depthBias(){return this._depthState.depthBias}set slopeDepthBias(e){this._depthState.depthBiasSlope=e}get slopeDepthBias(){return this._depthState.depthBiasSlope}set redWrite(e){this._blendState.redWrite=e}get redWrite(){return this._blendState.redWrite}set greenWrite(e){this._blendState.greenWrite=e}get greenWrite(){return this._blendState.greenWrite}set blueWrite(e){this._blendState.blueWrite=e}get blueWrite(){return this._blendState.blueWrite}set alphaWrite(e){this._blendState.alphaWrite=e}get alphaWrite(){return this._blendState.alphaWrite}get transparent(){return this._blendState.blend}_updateTransparency(){for(var e=this.transparent,t=this.meshInstances,s=0;s<t.length;s++)t[s].transparent=e}set blendState(e){this._blendState.copy(e),this._updateTransparency()}get blendState(){return this._blendState}set blendType(e){var t,s,i,n=uh[e];this._blendState.setColorBlend(n.op,n.src,n.dst),this._blendState.setAlphaBlend(null!=(t=n.alphaOp)?t:n.op,null!=(s=n.alphaSrc)?s:n.src,null!=(i=n.alphaDst)?i:n.dst);var a=3!==e;this._blendState.blend!==a&&(this._blendState.blend=a,this._updateTransparency()),this._updateMeshInstanceKeys()}get blendType(){if(!this.transparent)return 3;for(var{colorOp:e,colorSrcFactor:t,colorDstFactor:s,alphaOp:i,alphaSrcFactor:n,alphaDstFactor:a}=this._blendState,r=0;r<uh.length;r++){var o=uh[r];if(o.src===t&&o.dst===s&&o.op===e&&o.src===n&&o.dst===a&&o.op===i)return r}return 2}set depthState(e){this._depthState.copy(e)}get depthState(){return this._depthState}set depthTest(e){this._depthState.test=e}get depthTest(){return this._depthState.test}set depthFunc(e){this._depthState.func=e}get depthFunc(){return this._depthState.func}set depthWrite(e){this._depthState.write=e}get depthWrite(){return this._depthState.write}copy(e){var t;for(var s in this.name=e.name,this.alphaTest=e.alphaTest,this.alphaToCoverage=e.alphaToCoverage,this._blendState.copy(e._blendState),this._depthState.copy(e._depthState),this.cull=e.cull,this.stencilFront=null==(t=e.stencilFront)?void 0:t.clone(),e.stencilBack&&(this.stencilBack=e.stencilFront===e.stencilBack?this.stencilFront:e.stencilBack.clone()),this.clearParameters(),e.parameters)e.parameters.hasOwnProperty(s)&&this._setParameterSimple(s,e.parameters[s].data);this.defines.clear(),e.defines.forEach(((e,t)=>this.defines.set(t,e)));var i=e._chunks;for(var n in i)i.hasOwnProperty(n)&&(this._chunks[n]=i[n]);return this}clone(){return(new this.constructor).copy(this)}_updateMeshInstanceKeys(){for(var e=this.meshInstances,t=0;t<e.length;t++)e[t].updateKey()}updateUniforms(e,t){this._dirtyShader&&this.clearVariants()}getShaderVariant(e){}update(){this._definesDirty&&(this._definesDirty=!1,this.clearVariants()),this.dirty=!0}clearParameters(){this.parameters={}}getParameters(){return this.parameters}clearVariants(){this.variants.clear();for(var e=this.meshInstances,t=e.length,s=0;s<t;s++)e[s].clearShaders()}getParameter(e){return this.parameters[e]}_setParameterSimple(e,t){var s=this.parameters[e];s?s.data=t:this.parameters[e]={scopeId:null,data:t}}setParameter(e,t){if(void 0===t&&"object"==typeof e){var s=e;if(s.length){for(var i=0;i<s.length;i++)this.setParameter(s[i]);return}e=s.name,t=s.value}this._setParameterSimple(e,t)}deleteParameter(e){this.parameters[e]&&delete this.parameters[e]}setParameters(e,t){var s=this.parameters;for(var i in void 0===t&&(t=s),t){var n=s[i];n&&(n.scopeId||(n.scopeId=e.scope.resolve(i)),n.scopeId.setValue(n.data))}}setDefine(e,t){var s=!1,{defines:i}=this;void 0!==t&&!1!==t?(s=!i.has(e)||i.get(e)!==t,i.set(e,t)):(s=i.has(e),i.delete(e)),this._definesDirty||(this._definesDirty=s)}getDefine(e){return this.defines.has(e)}destroy(){this.variants.clear();for(var e=0;e<this.meshInstances.length;e++){var t=this.meshInstances[e];if(t.clearShaders(),t._material=null,t.mesh){var s=qo(t.mesh.device);this!==s&&(t.material=s)}}this.meshInstances.length=0}addMeshInstanceRef(e){this.meshInstances.push(e)}removeMeshInstanceRef(e){var t=this.meshInstances,s=t.indexOf(e);-1!==s&&t.splice(s,1)}constructor(){this.meshInstances=[],this.name="Untitled",this.userId="",this.id=ph++,this.variants=new Map,this.defines=new Map,this._definesDirty=!1,this.parameters={},this.alphaTest=0,this.alphaToCoverage=!1,this._blendState=new Vi,this._depthState=new Hi,this.cull=1,this.stencilFront=null,this.stencilBack=null,this._chunks={},this._dirtyShader=!0,this._shaderVersion=0,this._scene=null,this.dirty=!0}}class fh{destroy(){this.clear(),this.cache=null}clear(){this.cache.forEach((e=>{e.forEach((e=>{e.destroy()}))})),this.cache.clear()}getKey(e){return(1===e._type)+"-"+e._shadowType+"-"+e._shadowResolution}get(e,t){var s=this.getKey(t),i=this.cache.get(s);if(i&&i.length)return i.pop();var n=ah.create(e,t);return n.cached=!0,n}add(e,t){var s=this.getKey(e),i=this.cache.get(s);i?i.push(t):this.cache.set(s,[t])}constructor(){this.cache=new Map}}class gh extends Or{execute(){this.shadowRenderer.renderFace(this.light,null,this.face,!1)}after(){this.applyVsm&&this.shadowRenderer.renderVsm(this.light,this.shadowCamera)}constructor(e,t,s,i,n){super(e),this.requiresCubemaps=!1,this.shadowRenderer=t,this.light=s,this.face=i,this.applyVsm=n,this.shadowCamera=t.prepareFace(s,null,i),t.setupRenderPass(this,this.shadowCamera,!0)}}class vh{cull(e,t,s){void 0===s&&(s=null);var i=this.renderer.scene.clusteredLightingEnabled;e.visibleThisFrame=!0,i||e._shadowMap||(e._shadowMap=ah.create(this.device,e));for(var n=e._type,a=2===n?1:6,r=0;r<a;r++){var o=e.getRenderData(null,r),l=o.shadowCamera;l.nearClip=e.attenuationEnd/1e3,l.farClip=e.attenuationEnd;var h=l._node,c=e._node;if(h.setPosition(c.getPosition()),2===n)l.fov=2*e._outerConeAngle,h.setRotation(c.getRotation()),h.rotateLocal(-90,0,0);else if(1===n)if(i){var d=2/(this.shadowRenderer.lightTextureAtlas.shadowAtlasResolution*e.atlasViewport.z/3)*this.shadowRenderer.lightTextureAtlas.shadowEdgePixels;l.fov=Math.atan(1+d)*pt.RAD_TO_DEG*2}else l.fov=90;this.renderer.updateCameraFrustum(l),this.shadowRenderer.cullShadowCasters(t,e,o.visibleCasters,l,s)}}prepareLights(e,t){for(var s,i=0;i<t.length;i++){var n=t[i];if(this.shadowRenderer.needsShadowRendering(n)&&n.atlasViewportAllocated){e.push(n);for(var a=0;a<n.numShadowFaces;a++)s=this.shadowRenderer.prepareFace(n,null,a)}}return s}buildNonClusteredRenderPasses(e,t){for(var s=0;s<t.length;s++){var i=t[s];if(this.shadowRenderer.needsShadowRendering(i))for(var n=2===i._type,a=i.numShadowFaces,r=0;r<a;r++){var o=new gh(this.device,this.shadowRenderer,i,r,n);e.addRenderPass(o)}}}constructor(e,t){this.shadowLights=[],this.renderer=e,this.shadowRenderer=t,this.device=e.device}}class _h extends Or{execute(){for(var{light:e,camera:t,shadowRenderer:s,allCascadesRendering:i}=this,n=e.numShadowFaces,a=e.shadowUpdateOverrides,r=0;r<n;r++)0!==(null==a?void 0:a[r])&&s.renderFace(e,t,r,!i),1===(null==a?void 0:a[r])&&(a[r]=0)}after(){this.shadowRenderer.renderVsm(this.light,this.camera)}constructor(e,t,s,i,n){super(e),this.shadowRenderer=t,this.light=s,this.camera=i,this.allCascadesRendering=n}}var yh=new Ft,xh=new yt,wh=new Et,bh=[new yt,new yt,new yt,new yt,new yt,new yt,new yt,new yt],Ch={min:0,max:0};function Sh(e,t,s){bh[0].x=bh[1].x=bh[2].x=bh[3].x=t.x,bh[1].y=bh[3].y=bh[7].y=bh[5].y=t.y,bh[2].z=bh[3].z=bh[6].z=bh[7].z=t.z,bh[4].x=bh[5].x=bh[6].x=bh[7].x=s.x,bh[0].y=bh[2].y=bh[4].y=bh[6].y=s.y,bh[0].z=bh[1].z=bh[4].z=bh[5].z=s.z;for(var i=9999999999,n=-9999999999,a=0;a<8;++a){e.transformPoint(bh[a],bh[a]);var r=bh[a].z;r<i&&(i=r),r>n&&(n=r)}return Ch.min=i,Ch.max=n,Ch}class Ah{cull(e,t,s,i){void 0===i&&(i=null),e.visibleThisFrame=!0,e._shadowMap||(e._shadowMap=ah.create(this.device,e));var n=s._nearClip;this.generateSplitDistances(e,n,Math.min(s._farClip,e.shadowDistance));for(var a=e.shadowUpdateOverrides,r=0;r<e.numCascades&&0!==(null==a?void 0:a[r]);r++){var o=e.getRenderData(s,r),l=o.shadowCamera;l.renderTarget=e._shadowMap.renderTargets[0],o.shadowViewport.copy(e.cascades[r]),o.shadowScissor.copy(e.cascades[r]);var h=l._node,c=e._node;h.setPosition(c.getPosition()),h.setRotation(c.getRotation()),h.rotateLocal(-90,0,0);var d=0===r?n:e._shadowCascadeDistances[r-1],u=e._shadowCascadeDistances[r],p=s.getFrustumCorners(d,u);xh.set(0,0,0);for(var m=s.node.getWorldTransform(),f=0;f<8;f++)m.transformPoint(p[f],p[f]),xh.add(p[f]);xh.mulScalar(1/8);for(var g=0,v=0;v<8;v++){var _=p[v].sub(xh).length();_>g&&(g=_)}var y=h.right,x=h.up,w=h.forward,b=.25*e._shadowResolution/g,C=Math.ceil(xh.dot(x)*b)/b,S=Math.ceil(xh.dot(y)*b)/b,A=x.mulScalar(C),T=y.mulScalar(S),P=xh.dot(w),E=w.mulScalar(P);xh.add2(A,T).add(E),h.setPosition(xh),h.translateLocal(0,0,1e6),l.nearClip=.01,l.farClip=2e6,l.orthoHeight=g,this.renderer.updateCameraFrustum(l),this.shadowRenderer.cullShadowCasters(t,e,o.visibleCasters,l,i);for(var k=!0,M=o.visibleCasters,I=0;I<M.length;I++){var D=M[I];k?(k=!1,yh.copy(D.aabb)):yh.add(D.aabb)}wh.copy(h.getWorldTransform()).invert();var R=Sh(wh,yh.getMin(),yh.getMax());h.translateLocal(0,0,R.max+.1),l.farClip=R.max-R.min+.2,o.projectionCompensation=g}}generateSplitDistances(e,t,s){e._shadowCascadeDistances.fill(s);for(var i=1;i<e.numCascades;i++){var n=i/e.numCascades,a=t+(s-t)*n,r=t*(s/t)**n,o=pt.lerp(a,r,e.cascadeDistribution);e._shadowCascadeDistances[i-1]=o}}getLightRenderPass(e,t){var s=null;if(this.shadowRenderer.needsShadowRendering(e)){for(var i,n=e.numShadowFaces,a=e.shadowUpdateOverrides,r=!0,o=0;o<n;o++)0===(null==a?void 0:a[o])&&(r=!1),i=this.shadowRenderer.prepareFace(e,t,o);s=new _h(this.device,this.shadowRenderer,e,t,r),this.shadowRenderer.setupRenderPass(s,i,r)}return s}constructor(e,t){this.renderer=e,this.shadowRenderer=t,this.device=e.device}}var Th=new Set,Ph=new Et,Eh=new Et,kh=new Float32Array(2),Mh=new bt(1,1,0,0),Ih=new Et;function Dh(e,t){return Math.exp(-e*e/(2*t*t))}class Rh{static createShadowCamera(e,t,s){var i,n,a=Fl.create("ShadowCamera",t,s),r=to.get(e),o=null!=(i=null==r?void 0:r.vsm)&&i,l=null!=(n=null==r?void 0:r.pcf)&&n;return a.clearColor=o?new mt(0,0,0,0):new mt(1,1,1,1),a.clearDepthBuffer=!0,a.clearStencilBuffer=!1,a.clearColorBuffer=!l,a}_cullShadowCastersInternal(e,t,s){for(var i=e.length,n=0;n<i;n++){var a=e[n];a.castShadow&&(a.cull&&!a._isVisible(s)||(a.visibleThisFrame=!0,t.push(a)))}}cullShadowCasters(e,t,s,i,n){if(s.length=0,n)this._cullShadowCastersInternal(n,s,i);else{for(var a=e.layerList,r=a.length,o=0;o<r;o++){var l=a[o];l._lightsSet.has(t)&&(Th.has(l)||(Th.add(l),this._cullShadowCastersInternal(l.shadowCasters,s,i)))}Th.clear()}s.sort(this.renderer.sortCompareDepth)}setupRenderState(e,t){var s=this.renderer.scene.clusteredLightingEnabled?t._isPcf:t._isPcf&&1!==t._type;e.setBlendState(s?this.blendStateNoWrite:this.blendStateWrite),e.setDepthState(t.shadowDepthState),e.setStencilState(null,null)}dispatchUniforms(e,t,s,i){var n=t._node;0!==e._type&&(this.renderer.dispatchViewPos(n.getPosition()),this.shadowMapLightRadiusId.setValue(e.attenuationEnd)),Ph.setTRS(n.getPosition(),n.getRotation(),yt.ONE).invert(),Eh.mul2(t.projectionMatrix,Ph);var a=s.shadowViewport;t.rect=a,t.scissorRect=s.shadowScissor,Ih.setViewport(a.x,a.y,a.z,a.w),s.shadowMatrix.mul2(Ih,Eh),0===e._type&&e._shadowMatrixPalette.set(s.shadowMatrix.data,16*i)}getShadowPass(e){var t,s=e._type,i=e._shadowType,n=null==(t=this.shadowPassCache[s])?void 0:t[i];if(!n){var a="ShadowPass_"+s+"_"+i;n=Ao.get(this.device).allocate(a,{isShadow:!0,lightType:s,shadowType:i}),this.shadowPassCache[s]||(this.shadowPassCache[s]=[]),this.shadowPassCache[s][i]=n}return n.index}submitCasters(e,t,s){for(var i=this.device,n=this.renderer,a=n.scene,r=this.getShadowPass(t),o=s.shaderParams,l=e.length,h=0;h<l;h++){var c=e[h],d=c.mesh;c.ensureMaterial(i);var u=c.material;n.setBaseConstants(i,u),n.setSkinning(i,c),u.dirty&&(u.updateUniforms(i,a),u.dirty=!1),n.setupCullMode(!0,1,c),u.setParameters(i),c.setParameters(i,16);var p=c.getShaderInstance(r,0,a,o,this.viewUniformFormat,this.viewBindGroupFormat),m=p.shader;c._key[1]=m.id,i.setShader(m),n.setVertexBuffers(i,d),n.setMorphing(i,c.morphInstance),this.renderer.setupMeshUniformBuffers(p,c);var f=c.renderStyle;i.setIndexBuffer(d.indexBuffer[f]),n.drawInstance(i,c,d,f),n._shadowDrawCalls++}}needsShadowRendering(e){var t=e.enabled&&e.castShadows&&0!==e.shadowUpdateMode&&e.visibleThisFrame;return 1===e.shadowUpdateMode&&(e.shadowUpdateMode=0),t&&(this.renderer._shadowMapUpdates+=e.numShadowFaces),t}getLightRenderData(e,t,s){return e.getRenderData(0===e._type?t:null,s)}setupRenderPass(e,t,s){var i=t.renderTarget;e.init(i),e.depthStencilOps.clearDepthValue=1,e.depthStencilOps.clearDepth=s,i.depthBuffer?e.depthStencilOps.storeDepth=!0:(e.colorOps.clearValue.copy(t.clearColor),e.colorOps.clear=s,e.depthStencilOps.storeDepth=!1),e.requiresCubemaps=!1}prepareFace(e,t,s){var i=e._type,n=this.getLightRenderData(e,t,s).shadowCamera,a=0===i?0:s;return n.renderTarget=e._shadowMap.renderTargets[a],n}renderFace(e,t,s,i,n){void 0===n&&(n=!0);var a=this.device,r=this.getLightRenderData(e,t,s),o=r.shadowCamera;this.dispatchUniforms(e,o,r,s);var l=o.renderTarget,h=this.renderer;h.setCameraUniforms(o,l),a.supportsUniformBuffers&&h.setupViewUniformBuffers(r.viewBindGroups,this.viewUniformFormat,this.viewBindGroupFormat,1),n?(h.setupViewport(o,l),i&&h.clear(o)):h.clearView(o,l,!0,!1),this.setupRenderState(a,e),this.submitCasters(r.visibleCasters,e,o)}render(e,t,s){if(void 0===s&&(s=!0),this.needsShadowRendering(e)){for(var i=e.numShadowFaces,n=0;n<i;n++)this.prepareFace(e,t,n),this.renderFace(e,t,n,!0,s);this.renderVsm(e,t)}}renderVsm(e,t){e._isVsm&&e._vsmBlurSize>1&&(this.renderer.scene.clusteredLightingEnabled&&0!==e._type||this.applyVsmBlur(e,t))}getVsmBlurShader(e,t){var s=this.blurVsmShader,i=s[e][t];if(!i){this.blurVsmWeights[t]=function(e){for(var t=(e-1)/6,s=.5*(e-1),i=new Array(e),n=0,a=0;a<e;++a)i[a]=Dh(a-s,t),n+=i[a];for(var r=0;r<e;++r)i[r]/=n;return i}(t);var n=yo.fullscreenQuadVS,a="#define SAMPLES "+t+"\n";a+=this.blurVsmShaderCode[e];var r="blurVsm"+e+t;i=Po(this.device,n,a,r),s[e][t]=i}return i}applyVsmBlur(e,t){var s=this.device;s.setBlendState(Vi.NOBLEND);var i=e.getRenderData(0===e._type?t:null,0).shadowCamera.renderTarget,n=this.renderer.shadowMapCache.get(s,e),a=n.renderTargets[0],r=e.vsmBlurMode,o=e._vsmBlurSize,l=this.getVsmBlurShader(r,o);Mh.z=e._shadowResolution-2,Mh.w=Mh.z,this.sourceId.setValue(i.colorBuffer),kh[0]=1/e._shadowResolution,kh[1]=0,this.pixelOffsetId.setValue(kh),1===r&&this.weightId.setValue(this.blurVsmWeights[o]),Oo(s,a,l,null,Mh),this.sourceId.setValue(a.colorBuffer),kh[1]=kh[0],kh[0]=0,this.pixelOffsetId.setValue(kh),Oo(s,i,l,null,Mh),this.renderer.shadowMapCache.add(e,n)}initViewBindGroupFormat(){this.device.supportsUniformBuffers&&!this.viewUniformFormat&&(this.viewUniformFormat=new Wn(this.device,[new Gn("matrix_viewProjection",$s)]),this.viewBindGroupFormat=new Ai(this.device,[new wi(di,3)]))}frameUpdate(){this.initViewBindGroupFormat()}constructor(e,t){this.shadowPassCache=[],this.device=e.device,this.renderer=e,this.lightTextureAtlas=t;var s=this.device.scope;this.sourceId=s.resolve("source"),this.pixelOffsetId=s.resolve("pixelOffset"),this.weightId=s.resolve("weight[0]"),this.blurVsmShaderCode=[yo.blurVSMPS,"#define GAUSS\n"+yo.blurVSMPS],this.blurVsmShader=[{},{}],this.blurVsmWeights={},this.shadowMapLightRadiusId=s.resolve("light_radius"),this.viewUniformFormat=null,this.viewBindGroupFormat=null,this.blendStateWrite=new Vi,this.blendStateNoWrite=new Vi,this.blendStateNoWrite.setColorWrite(!1,!1,!1,!1)}}var Lh=[];class Fh{destroy(){this._empty&&(this._empty.destroy(),this._empty=null),this._allocated.forEach((e=>{e.destroy()})),this._allocated.length=0}get count(){return this._allocated.length}get empty(){if(!this._empty){var e=new Kl(this.device);e.name="ClusterEmpty",e.update([]),this._empty=e}return this._empty}assign(e){var t=this.empty;Lh.push(...this._allocated),this._allocated.length=0,this._clusters.clear();for(var s=e.length,i=0;i<s;i++){var n=e[i].renderActions;if(n)for(var a=n.length,r=0;r<a;r++){var o=n[r];o.lightClusters=null;var l=o.layer;if(l.hasClusteredLights&&l.meshInstances.length){var h,c=l.getLightIdHash(),d=this._clusters.get(c),u=null==d?void 0:d.lightClusters;if(!u)u=null!=(h=Lh.pop())?h:new Kl(this.device),this._allocated.push(u),this._clusters.set(c,o);o.lightClusters=u}o.lightClusters||(o.lightClusters=t)}}Lh.forEach((e=>e.destroy())),Lh.length=0}update(e,t){this.assign(e),this._clusters.forEach((e=>{var s=e.layer;e.lightClusters.update(s.clusteredLightsSet,t)}))}constructor(e){this._empty=null,this._allocated=[],this._clusters=new Map,this.device=e}}var Bh="\n\tattribute vec2 vertex_position;\n\tvarying vec2 uv0;\n\tvoid main(void) {\n\t\tgl_Position = vec4(vertex_position, 0.5, 1.0);\n\t\tuv0 = vertex_position.xy * 0.5 + 0.5;\n\t\t#ifndef WEBGPU\n\t\t\tuv0.y = 1.0 - uv0.y;\n\t\t#endif\n\t}",Oh=new bt,zh=[];class Vh extends Or{destroy(){var e,t;null==(e=this._quadRenderer2D)||e.destroy(),this._quadRenderer2D=null,null==(t=this._quadRendererCube)||t.destroy(),this._quadRendererCube=null}static create(e,t){var s=new Vh(e.device,t);return s.init(e),s.colorOps.clear=!1,s.depthStencilOps.clearDepth=!1,s}update(e){var t=this._filteredLights;this.filter(e,t),this.executeEnabled=t.length>0}filter(e,t){for(var s=0;s<e.length;s++){var i=e[s];0!==i._type&&(i.atlasViewportAllocated&&i.atlasSlotUpdated&&i.enabled&&i.cookie&&i.visibleThisFrame&&t.push(i))}}initInvViewProjMatrices(){if(!zh.length)for(var e=0;e<6;e++){var t=Fl.create(null,1,e),s=t.projectionMatrix,i=t.node.getLocalTransform().clone().invert();zh[e]=(new Et).mul2(s,i).invert()}}get quadRenderer2D(){if(!this._quadRenderer2D){var e=Po(this.device,Bh,"\n\tvarying vec2 uv0;\n\tuniform sampler2D blitTexture;\n\tvoid main(void) {\n\t\tgl_FragColor = texture2D(blitTexture, uv0);\n\t}","cookieRenderer2d");this._quadRenderer2D=new Lo(e)}return this._quadRenderer2D}get quadRendererCube(){if(!this._quadRendererCube){var e=Po(this.device,Bh,"\n\tvarying vec2 uv0;\n\tuniform samplerCube blitTexture;\n\tuniform mat4 invViewProj;\n\tvoid main(void) {\n\t\tvec4 projPos = vec4(uv0 * 2.0 - 1.0, 0.5, 1.0);\n\t\tvec4 worldPos = invViewProj * projPos;\n\t\tgl_FragColor = textureCube(blitTexture, worldPos.xyz);\n\t}","cookieRendererCube");this._quadRendererCube=new Lo(e)}return this._quadRendererCube}execute(){var e=this.device;e.setBlendState(Vi.NOBLEND),e.setCullMode(0),e.setDepthState(Hi.NODEPTH),e.setStencilState();for(var t=this.renderTarget.colorBuffer.width,s=this._cubeSlotsOffsets,i=this._filteredLights,n=0;n<i.length;n++){var a=i[n],r=a.numShadowFaces,o=r>1?this.quadRendererCube:this.quadRenderer2D;r>1&&this.initInvViewProjMatrices(),this.blitTextureId.setValue(a.cookie);for(var l=0;l<r;l++){if(Oh.copy(a.atlasViewport),r>1){var h=Oh.z/3,c=s[l];Oh.x+=h*c.x,Oh.y+=h*c.y,Oh.z=h,Oh.w=h,this.invViewProjId.setValue(zh[l].data)}Oh.mulScalar(t),o.render(Oh)}}i.length=0}constructor(e,t){super(e),this._quadRenderer2D=null,this._quadRendererCube=null,this._filteredLights=[],this._cubeSlotsOffsets=t,this.requiresCubemaps=!1,this.blitTextureId=e.scope.resolve("blitTexture"),this.invViewProjId=e.scope.resolve("invViewProj")}}class Nh extends Or{update(e){var t=this.shadowRendererLocal.shadowLights,s=this.shadowRendererLocal.prepareLights(t,e),i=t.length;this.enabled=i>0,i&&this.shadowRenderer.setupRenderPass(this,s,!1)}execute(){for(var e=this.shadowRendererLocal.shadowLights,t=e.length,s=0;s<t;s++)for(var i=e[s],n=0;n<i.numShadowFaces;n++)this.shadowRenderer.renderFace(i,null,n,!0);e.length=0}constructor(e,t,s){super(e),this.requiresCubemaps=!1,this.shadowRenderer=t,this.shadowRendererLocal=s}}class Uh extends Or{update(e,t,s,i,n){this.frameGraph=e,this.cookiesRenderPass.enabled=s,s&&this.cookiesRenderPass.update(i),this.shadowRenderPass.enabled=t,t&&this.shadowRenderPass.update(n)}destroy(){this.cookiesRenderPass.destroy(),this.cookiesRenderPass=null}execute(){var{renderer:e}=this,{scene:t}=e;e.worldClustersAllocator.update(this.frameGraph.renderPasses,t.lighting)}constructor(e,t,s,i,n){super(e),this.renderer=t,this.frameGraph=null,this.cookiesRenderPass=Vh.create(n.cookieRenderTarget,n.cubeSlotsOffsets),this.beforePasses.push(this.cookiesRenderPass),this.shadowRenderPass=new Nh(e,s,i),this.beforePasses.push(this.shadowRenderPass)}}var Hh=0,Gh=new Et,Wh=new Et,jh=new Et,qh=new xt,Xh=new zt,Yh=(new Et).setScale(1,-1,1),$h=new Set,Kh=new Set,Zh=new Fi,Jh=(new Et).set([1,0,0,0,0,1,0,0,0,0,.5,0,0,0,.5,1]),Qh=[new wt(.5,.333333),new wt(.25,.666667),new wt(.75,.111111),new wt(.125,.444444),new wt(.625,.777778),new wt(.375,.222222),new wt(.875,.555556),new wt(.0625,.888889),new wt(.5625,.037037),new wt(.3125,.37037),new wt(.8125,.703704),new wt(.1875,.148148),new wt(.6875,.481481),new wt(.4375,.814815),new wt(.9375,.259259),new wt(.03125,.592593)],ec=new Et,tc=new Et,sc=new Et,ic=new Et,nc=new Et,ac=new Et,rc=new Set,oc=[],lc=[];class hc{destroy(){this.shadowRenderer=null,this._shadowRendererLocal=null,this._shadowRendererDirectional=null,this.shadowMapCache.destroy(),this.shadowMapCache=null,this._renderPassUpdateClustered.destroy(),this._renderPassUpdateClustered=null,this.lightTextureAtlas.destroy(),this.lightTextureAtlas=null}sortCompare(e,t){if(e.layer===t.layer){if(e.drawOrder&&t.drawOrder)return e.drawOrder-t.drawOrder;if(e.zdist&&t.zdist)return t.zdist-e.zdist;if(e.zdist2&&t.zdist2)return e.zdist2-t.zdist2}return t._key[0]-e._key[0]}sortCompareMesh(e,t){if(e.layer===t.layer){if(e.drawOrder&&t.drawOrder)return e.drawOrder-t.drawOrder;if(e.zdist&&t.zdist)return t.zdist-e.zdist}var s=e._key[0],i=t._key[0];return s===i&&e.mesh&&t.mesh?t.mesh.id-e.mesh.id:i-s}sortCompareDepth(e,t){var s=e._key[1],i=t._key[1];return s===i&&e.mesh&&t.mesh?t.mesh.id-e.mesh.id:i-s}setupViewport(e,t){var s=this.device,i=t?t.width:s.width,n=t?t.height:s.height,a=e.rect,r=Math.floor(a.x*i),o=Math.floor(a.y*n),l=Math.floor(a.z*i),h=Math.floor(a.w*n);if(s.setViewport(r,o,l,h),e._scissorRectClear){var c=e.scissorRect;r=Math.floor(c.x*i),o=Math.floor(c.y*n),l=Math.floor(c.z*i),h=Math.floor(c.w*n)}s.setScissor(r,o,l,h)}setCameraUniforms(e,t){var s=null==t?void 0:t.flipY,i=1;if(e.xr&&e.xr.session){var n,a,r=(null==(a=e._node)||null==(n=a.parent)?void 0:n.getWorldTransform())||null,o=e.xr.views;i=o.list.length;for(var l=0;l<i;l++){var h=o.list[l];h.updateTransforms(r),e.frustum.setFromMat4(h.projViewOffMat)}}else{var c=e.projectionMatrix;e.calculateProjection&&e.calculateProjection(c,0);var d=e.getProjectionMatrixSkybox();s&&(c=ec.mul2(Yh,c),d=tc.mul2(Yh,d)),this.device.isWebGPU&&(c=sc.mul2(Jh,c),d=ic.mul2(Jh,d));var{jitter:u}=e,p=0,m=0;if(u>0){var f=t?t.width:this.device.width,g=t?t.height:this.device.height,v=Qh[this.device.renderVersion%Qh.length];p=u*(2*v.x-1)/f,m=u*(2*v.y-1)/g,(c=nc.copy(c)).data[8]=p,c.data[9]=m,(d=ac.copy(d)).data[8]=p,d.data[9]=m,this.blueNoiseJitterVersion!==this.device.renderVersion&&(this.blueNoiseJitterVersion=this.device.renderVersion,this.blueNoise.vec4(this.blueNoiseJitterVec))}var _=u>0?this.blueNoiseJitterVec:bt.ZERO;if(this.blueNoiseJitterData[0]=_.x,this.blueNoiseJitterData[1]=_.y,this.blueNoiseJitterData[2]=_.z,this.blueNoiseJitterData[3]=_.w,this.blueNoiseJitterId.setValue(this.blueNoiseJitterData),this.projId.setValue(c.data),this.projSkyboxId.setValue(d.data),e.calculateTransform)e.calculateTransform(Wh,0);else{var y=e._node.getPosition(),x=e._node.getRotation();Wh.setTRS(y,x,yt.ONE)}this.viewInvId.setValue(Wh.data),jh.copy(Wh).invert(),this.viewId.setValue(jh.data),qh.setFromMat4(jh),this.viewId3.setValue(qh.data),Gh.mul2(c,jh),this.viewProjId.setValue(Gh.data),e._storeShaderMatrices(Gh,p,m,this.device.renderVersion),this.flipYId.setValue(s?-1:1),this.dispatchViewPos(e._node.getPosition()),e.frustum.setFromMat4(Gh)}this.tbnBasis.setValue(s?-1:1);var w=e._nearClip,b=e._farClip;return this.nearClipId.setValue(w),this.farClipId.setValue(b),this.cameraParams[0]=1/b,this.cameraParams[1]=b,this.cameraParams[2]=w,this.cameraParams[3]=1===e.projection?1:0,this.cameraParamsId.setValue(this.cameraParams),this.exposureId.setValue(this.scene.physicalUnits?e.getExposure():this.scene.exposure),i}clear(e,t,s,i){var n=((null!=t?t:e._clearColorBuffer)?1:0)|((null!=s?s:e._clearDepthBuffer)?2:0)|((null!=i?i:e._clearStencilBuffer)?4:0);n&&this.device.clear({color:[e._clearColor.r,e._clearColor.g,e._clearColor.b,e._clearColor.a],depth:e._clearDepth,stencil:e._clearStencil,flags:n})}setCamera(e,t,s,i){this.setCameraUniforms(e,t),this.clearView(e,t,s,!1)}clearView(e,t,s,i){var n=this.device;if(n.setRenderTarget(t),n.updateBegin(),i&&(n.setColorWrite(!0,!0,!0,!0),n.setDepthWrite(!0)),this.setupViewport(e,t),s){var a=e._clearOptions;n.clear(a||{color:[e._clearColor.r,e._clearColor.g,e._clearColor.b,e._clearColor.a],depth:e._clearDepth,flags:(e._clearColorBuffer?1:0)|(e._clearDepthBuffer?2:0)|(e._clearStencilBuffer?4:0),stencil:e._clearStencil})}}setupCullMode(e,t,s){var i=s.material,n=0;if(e){var a=1;2!==i.cull&&1!==i.cull||(a=t*s.flipFacesFactor*s.node.worldScaleSign),n=a<0?2===i.cull?1:2:i.cull}this.device.setCullMode(n),0===n&&0===i.cull&&this.twoSidedLightingNegScaleFactorId.setValue(s.node.worldScaleSign)}updateCameraFrustum(e){if(e.xr&&e.xr.views.list.length){var t=e.xr.views.list[0];return Gh.mul2(t.projMat,t.viewOffMat),void e.frustum.setFromMat4(Gh)}var s=e.projectionMatrix;if(e.calculateProjection&&e.calculateProjection(s,0),e.calculateTransform)e.calculateTransform(Wh,0);else{var i=e._node.getPosition(),n=e._node.getRotation();Wh.setTRS(i,n,yt.ONE),this.viewInvId.setValue(Wh.data)}jh.copy(Wh).invert(),Gh.mul2(s,jh),e.frustum.setFromMat4(Gh)}setBaseConstants(e,t){e.setCullMode(t.cull),t.opacityMap&&this.opacityMapId.setValue(t.opacityMap),(t.opacityMap||t.alphaTest>0)&&this.alphaTestId.setValue(t.alphaTest)}updateCpuSkinMatrices(e){Hh++;var t=e.length;if(0!==t)for(var s=0;s<t;s++){var i=e[s].skinInstance;i&&(i.updateMatrices(e[s].node,Hh),i._dirty=!0)}}updateGpuSkinMatrices(e){for(var t of e){var s=t.skinInstance;s&&s._dirty&&(s.updateMatrixPalette(t.node,Hh),s._dirty=!1)}}updateMorphing(e){for(var t of e){var s=t.morphInstance;s&&s._dirty&&s.update()}}updateGSplats(e){for(var t of e){var s;null==(s=t.gsplatInstance)||s.update()}}gpuUpdate(e){this.updateGpuSkinMatrices(e),this.updateMorphing(e),this.updateGSplats(e)}setVertexBuffers(e,t){e.setVertexBuffer(t.vertexBuffer)}setMorphing(e,t){t&&(t.prepareRendering(e),e.setVertexBuffer(t.morph.vertexBufferIds),this.morphPositionTex.setValue(t.texturePositions),this.morphNormalTex.setValue(t.textureNormals),this.morphTexParams.setValue(t._textureParams))}setSkinning(e,t){var s=t.skinInstance;if(s){this._skinDrawCalls++;var i=s.boneTexture;this.boneTextureId.setValue(i),this.boneTextureSizeId.setValue(s.boneTextureSize)}}dispatchViewPos(e){var t=this.viewPos;t[0]=e.x,t[1]=e.y,t[2]=e.z,this.viewPosId.setValue(t)}initViewBindGroupFormat(e){if(this.device.supportsUniformBuffers&&!this.viewUniformFormat){var t=[new Gn("matrix_viewProjection",$s),new Gn("cubeMapRotationMatrix",13),new Gn("view_position",4),new Gn("skyboxIntensity",2),new Gn("exposure",2),new Gn("textureBias",2)];e&&t.push(new Gn("clusterCellsCountByBoundsSize",4),new Gn("clusterTextureSize",4),new Gn("clusterBoundsMin",4),new Gn("clusterBoundsDelta",4),new Gn("clusterCellsDot",4),new Gn("clusterCellsMax",4),new Gn("clusterCompressionLimit0",3),new Gn("shadowAtlasParams",3),new Gn("clusterMaxCells",1),new Gn("clusterSkip",2)),this.viewUniformFormat=new Wn(this.device,t);var s=[new wi(di,3),new Ci("lightsTextureFloat",2,Ns,1),new Ci("lightsTexture8",2,Ns,1),new Ci("shadowAtlasTexture",2,Ns,2),new Ci("cookieAtlasTexture",2,Ns,0),new Ci("areaLightsLutTex1",2,Ns,0),new Ci("areaLightsLutTex2",2,Ns,0)];e&&s.push(new Ci("clusterWorldTexture",2,Ns,1)),this.viewBindGroupFormat=new Ai(this.device,s)}}setupViewUniformBuffers(e,t,s,i){for(var n=this.device;e.length<i;){var a=new Xa(n,t,!1),r=new Bi(n,s,a);e.push(r)}var o=e[0];o.defaultUniformBuffer.update(),o.update(),n.setBindGroup(0,o)}setupMeshUniformBuffers(e,t){var s=this.device;if(s.supportsUniformBuffers){this.modelMatrixId.setValue(t.node.worldTransform.data),this.normalMatrixId.setValue(t.node.normalMatrix.data);var i=e.getBindGroup(s);i.update(),s.setBindGroup(1,i),e.getUniformBuffer(s).update(Zh),s.setBindGroup(2,Zh.bindGroup,Zh.offsets)}}drawInstance(e,t,s,i,n){var a=t.node.worldTransform;this.modelMatrixId.setValue(a.data),n&&this.normalMatrixId.setValue(t.node.normalMatrix.data);var r=t.instancingData;r?r.count>0?(this._instancedDrawCalls++,e.setVertexBuffer(r.vertexBuffer),e.draw(s.primitive[i],r.count)):e.clearVertexBuffer():e.draw(s.primitive[i])}drawInstance2(e,t,s,i){var n=t.instancingData;n?n.count>0?(this._instancedDrawCalls++,e.draw(s.primitive[i],n.count,!0)):e.clearVertexBuffer():e.draw(s.primitive[i],void 0,!0)}cull(e,t,s){var i=s.opaque;i.length=0;var n=s.transparent;n.length=0;for(var a=e.frustumCulling,r=t.length,o=0;o<r;o++){var l=t[o];if(l.visible)if(!a||!l.cull||l._isVisible(e))l.visibleThisFrame=!0,(l.transparent?n:i).push(l),(l.skinInstance||l.morphInstance||l.gsplatInstance)&&(this.processingMeshInstances.add(l),l.gsplatInstance&&l.gsplatInstance.cameras.push(e))}}collectLights(e){this.lights.length=0,this.localLights.length=0;for(var t=this.scene._stats,s=e.layerList.length,i=0;i<s;i++){var n=e.layerList[i];if(!Kh.has(n)){Kh.add(n);for(var a=n._lights,r=0;r<a.length;r++){var o=a[r];$h.has(o)||($h.add(o),this.lights.push(o),0!==o._type&&this.localLights.push(o))}}}t.lights=this.lights.length,$h.clear(),Kh.clear()}cullLights(e,t){for(var s=this.scene.clusteredLightingEnabled,i=this.scene.physicalUnits,n=0;n<t.length;n++){var a=t[n];if(a.enabled)if(0!==a._type)if(a.getBoundingSphere(Xh),e.frustum.containsSphere(Xh)){a.visibleThisFrame=!0,a.usePhysicalUnits=i;var r=e.getScreenSize(Xh);a.maxScreenSize=Math.max(a.maxScreenSize,r)}else s||a.castShadows&&!a.shadowMap&&(a.visibleThisFrame=!0);else a.usePhysicalUnits=this.scene.physicalUnits}}cullShadowmaps(e){for(var t=this.scene.clusteredLightingEnabled,s=0;s<this.localLights.length;s++){var i=this.localLights[s];0!==i._type&&(t?i.atlasSlotUpdated&&0===i.shadowUpdateMode&&(i.shadowUpdateMode=1):0===i.shadowUpdateMode&&i.castShadows&&(i.getRenderData(null,0).shadowCamera.renderTarget||(i.shadowUpdateMode=1)),i.visibleThisFrame&&i.castShadows&&0!==i.shadowUpdateMode&&this._shadowRendererLocal.cull(i,e))}this.cameraDirShadowLights.clear();for(var n=e.cameras,a=0;a<n.length;a++){var r=n[a];if(r.enabled){for(var o=r.camera,l=void 0,h=o.layers,c=0;c<h.length;c++){var d=e.getLayerById(h[c]);if(d)for(var u=d.splitLights[0],p=0;p<u.length;p++){var m=u[p];m.castShadows&&!rc.has(m)&&(rc.add(m),(l=null!=l?l:[]).push(m),this._shadowRendererDirectional.cull(m,e,o))}}l&&this.cameraDirShadowLights.set(o,l),rc.clear()}}}cullComposition(e){var{scene:t}=this;this.processingMeshInstances.clear();var s=e.cameras.length;this._camerasRendered+=s;for(var i=0;i<s;i++){var n=e.cameras[i];null==t||t.fire("precull",n);var a=n.renderTarget;n.frameUpdate(a),this.updateCameraFrustum(n.camera);for(var r=n.layers,o=0;o<r.length;o++){var l=e.getLayerById(r[o]);if(l&&l.enabled){this.cullLights(n.camera,l._lights);var h=l.getCulledInstances(n.camera);this.cull(n.camera,l.meshInstances,h)}}null==t||t.fire("postcull",n)}t.clusteredLightingEnabled&&this.updateLightTextureAtlas(),this.cullShadowmaps(e)}updateShaders(e,t){for(var s=e.length,i=0;i<s;i++){var n=e[i].material;if(n&&!rc.has(n)&&(rc.add(n),n.getShaderVariant!==mh.prototype.getShaderVariant)){if(t&&(!n.useLighting||n.emitter&&!n.emitter.lighting))continue;n.clearVariants()}}rc.clear()}updateFrameUniforms(){this.blueNoiseTextureId.setValue(nh(this.device))}beginFrame(e){for(var t=this.scene,s=t.updateShaders||this.device._shadersDirty,i=e.layerList,n=i.length,a=0;a<n;a++)for(var r=i[a].meshInstances,o=r.length,l=0;l<o;l++){var h=r[l];h.visibleThisFrame=!1,s&&oc.push(h),h.skinInstance&&lc.push(h)}if(s){var c=!t.updateShaders||!this.device._shadersDirty;this.updateShaders(oc,c),t.updateShaders=!1,this.device._shadersDirty=!1,t._shaderVersion++}this.updateFrameUniforms(),this.updateCpuSkinMatrices(lc),oc.length=0,lc.length=0;for(var d=this.lights,u=d.length,p=0;p<u;p++)d[p].beginFrame()}updateLightTextureAtlas(){this.lightTextureAtlas.update(this.localLights,this.scene.lighting)}updateLayerComposition(e){for(var t=e.layerList.length,s=this.scene._shaderVersion,i=0;i<t;i++){e.layerList[i]._shaderVersion=s}e._update()}frameUpdate(){this.clustersDebugRendered=!1,this.initViewBindGroupFormat(this.scene.clusteredLightingEnabled),this.dirLightShadows.clear()}constructor(e){this.clustersDebugRendered=!1,this.processingMeshInstances=new Set,this.lights=[],this.localLights=[],this.cameraDirShadowLights=new Map,this.dirLightShadows=new Map,this.blueNoise=new eh(123),this.device=e,this.scene=null,this.worldClustersAllocator=new Fh(e),this.lightTextureAtlas=new dh(e),this.shadowMapCache=new fh,this.shadowRenderer=new Rh(this,this.lightTextureAtlas),this._shadowRendererLocal=new vh(this,this.shadowRenderer),this._shadowRendererDirectional=new Ah(this,this.shadowRenderer),this._renderPassUpdateClustered=new Uh(this.device,this,this.shadowRenderer,this._shadowRendererLocal,this.lightTextureAtlas),this.viewUniformFormat=null,this.viewBindGroupFormat=null,this._skinTime=0,this._morphTime=0,this._cullTime=0,this._shadowMapTime=0,this._lightClustersTime=0,this._layerCompositionUpdateTime=0,this._shadowDrawCalls=0,this._skinDrawCalls=0,this._instancedDrawCalls=0,this._shadowMapUpdates=0,this._numDrawCallsCulled=0,this._camerasRendered=0,this._lightClusters=0;var t=e.scope;this.boneTextureId=t.resolve("texture_poseMap"),this.boneTextureSizeId=t.resolve("texture_poseMapSize"),this.modelMatrixId=t.resolve("matrix_model"),this.normalMatrixId=t.resolve("matrix_normal"),this.viewInvId=t.resolve("matrix_viewInverse"),this.viewPos=new Float32Array(3),this.viewPosId=t.resolve("view_position"),this.projId=t.resolve("matrix_projection"),this.projSkyboxId=t.resolve("matrix_projectionSkybox"),this.viewId=t.resolve("matrix_view"),this.viewId3=t.resolve("matrix_view3"),this.viewProjId=t.resolve("matrix_viewProjection"),this.flipYId=t.resolve("projectionFlipY"),this.tbnBasis=t.resolve("tbnBasis"),this.nearClipId=t.resolve("camera_near"),this.farClipId=t.resolve("camera_far"),this.cameraParams=new Float32Array(4),this.cameraParamsId=t.resolve("camera_params"),this.viewIndexId=t.resolve("view_index"),this.blueNoiseJitterVersion=0,this.blueNoiseJitterVec=new bt,this.blueNoiseJitterData=new Float32Array(4),this.blueNoiseJitterId=t.resolve("blueNoiseJitter"),this.blueNoiseTextureId=t.resolve("blueNoiseTex32"),this.alphaTestId=t.resolve("alpha_ref"),this.opacityMapId=t.resolve("texture_opacityMap"),this.exposureId=t.resolve("exposure"),this.twoSidedLightingNegScaleFactorId=t.resolve("twoSidedLightingNegScaleFactor"),this.twoSidedLightingNegScaleFactorId.setValue(0),this.morphPositionTex=t.resolve("morphPositionTex"),this.morphNormalTex=t.resolve("morphNormalTex"),this.morphTexParams=t.resolve("morph_tex_params"),this.lightCube=new sh,this.constantLightCube=t.resolve("lightCube[0]")}}class cc{destroy(){this.viewBindGroups.forEach((e=>{e.defaultUniformBuffer.destroy(),e.destroy()})),this.viewBindGroups.length=0}setupClears(e,t){this.clearColor=(null==e?void 0:e.clearColorBuffer)||t.clearColorBuffer,this.clearDepth=(null==e?void 0:e.clearDepthBuffer)||t.clearDepthBuffer,this.clearStencil=(null==e?void 0:e.clearStencilBuffer)||t.clearStencilBuffer}constructor(){this.camera=null,this.layer=null,this.transparent=!1,this.renderTarget=null,this.lightClusters=null,this.clearColor=!1,this.clearDepth=!1,this.clearStencil=!1,this.triggerPostprocess=!1,this.firstCameraUse=!1,this.lastCameraUse=!1,this.viewBindGroups=[],this.useCameraPasses=!1}}class dc extends Or{get rendersAnything(){return this.renderActions.length>0}addRenderAction(e){this.renderActions.push(e)}addLayer(e,t,s,i){void 0===i&&(i=!0);var n=new cc;if(n.renderTarget=this.renderTarget,n.camera=e,n.layer=t,n.transparent=s,i){var a=0===this.renderActions.length;n.setupClears(a?e:void 0,t)}this.addRenderAction(n)}addLayers(e,t,s,i,n,a){void 0===a&&(a=!0);for(var{layerList:r,subLayerList:o}=e,l=i,h=s;h<r.length;){var c=r[h],d=o[h];if(t.camera.layersSet.has(c.id)&&(this.addLayer(t,c,d,l),l=!1),h++,c.id===n&&d===a)break}return h}updateDirectionalShadows(){for(var{renderer:e,renderActions:t}=this,s=0;s<t.length;s++){var i=t[s].camera.camera,n=this.renderer.cameraDirShadowLights.get(i);if(n)for(var a=0;a<n.length;a++){var r=n[a];if(e.dirLightShadows.get(r)!==i){e.dirLightShadows.set(r,i);var o=e._shadowRendererDirectional.getLightRenderPass(r,i);o&&this.beforePasses.push(o)}}}}updateClears(){var e=this.renderActions[0];if(e){var t=e.camera.camera,s=t.fullSizeClearRect;this.setClearColor(s&&e.clearColor?t.clearColor:void 0),this.setClearDepth(s&&e.clearDepth&&!this.noDepthClear?t.clearDepth:void 0),this.setClearStencil(s&&e.clearStencil?t.clearStencil:void 0)}}frameUpdate(){super.frameUpdate(),this.updateDirectionalShadows(),this.updateClears()}before(){for(var{renderActions:e}=this,t=0;t<e.length;t++){var s=e[t];s.firstCameraUse&&this.scene.fire("prerender",s.camera)}}execute(){for(var{layerComposition:e,renderActions:t}=this,s=0;s<t.length;s++){var i=t[s],n=i.layer;e.isEnabled(n,i.transparent)&&this.renderRenderAction(i,0===s)}}after(){for(var e=0;e<this.renderActions.length;e++){var t=this.renderActions[e];t.lastCameraUse&&this.scene.fire("postrender",t.camera)}this.beforePasses.length=0}renderRenderAction(e,t){var{renderer:s,scene:i}=this,n=s.device,{layer:a,transparent:r,camera:o}=e;if(o){var l,h=o.gammaCorrection,c=o.toneMapping;void 0!==this.gammaCorrection&&(o.gammaCorrection=this.gammaCorrection),void 0!==this.toneMapping&&(o.toneMapping=this.toneMapping),i.fire(mo,o,a,r);var d,u,p={lightClusters:e.lightClusters},m=null!=(d=null==(l=o.camera.shaderPassInfo)?void 0:l.index)?d:0;t&&o.camera.fullSizeClearRect||(p.clearColor=e.clearColor,p.clearDepth=e.clearDepth,p.clearStencil=e.clearStencil);var f=null!=(u=e.renderTarget)?u:n.backBuffer;s.renderForwardLayer(o.camera,f,a,r,m,e.viewBindGroups,p),n.setBlendState(Vi.NOBLEND),n.setStencilState(null,null),n.setAlphaToCoverage(!1),i.fire(fo,o,a,r),void 0!==this.gammaCorrection&&(o.gammaCorrection=h),void 0!==this.toneMapping&&(o.toneMapping=c)}}constructor(e,t,s,i){super(e),this.renderActions=[],this.noDepthClear=!1,this.layerComposition=t,this.scene=s,this.renderer=i}}class uc extends Or{execute(){this.renderAction.camera.onPostprocessing()}constructor(e,t,s){super(e),this.renderer=t,this.renderAction=s,this.requiresCubemaps=!1}}var pc=[[],[],[]],mc=new mt,fc={drawCalls:[],shaderInstances:[],isNewMaterial:[],lightMaskChanged:[],clear:function(){this.drawCalls.length=0,this.shaderInstances.length=0,this.isNewMaterial.length=0,this.lightMaskChanged.length=0}};class gc extends hc{destroy(){super.destroy()}dispatchGlobalLights(e){var t=this.ambientColor;if(mc.linear(e.ambientLight),t[0]=mc.r,t[1]=mc.g,t[2]=mc.b,e.physicalUnits)for(var s=0;s<3;s++)t[s]*=e.ambientLuminance;this.ambientId.setValue(t),this.skyboxIntensityId.setValue(e.physicalUnits?e.skyboxLuminance:e.skyboxIntensity),this.cubeMapRotationMatrixId.setValue(e._skyboxRotationMat3.data)}_resolveLight(e,t){var s="light"+t;this.lightColorId[t]=e.resolve(s+"_color"),this.lightDir[t]=new Float32Array(3),this.lightDirId[t]=e.resolve(s+"_direction"),this.lightShadowMapId[t]=e.resolve(s+"_shadowMap"),this.lightShadowMatrixId[t]=e.resolve(s+"_shadowMatrix"),this.lightShadowParamsId[t]=e.resolve(s+"_shadowParams"),this.lightShadowIntensity[t]=e.resolve(s+"_shadowIntensity"),this.lightShadowSearchAreaId[t]=e.resolve(s+"_shadowSearchArea"),this.lightRadiusId[t]=e.resolve(s+"_radius"),this.lightPos[t]=new Float32Array(3),this.lightPosId[t]=e.resolve(s+"_position"),this.lightWidth[t]=new Float32Array(3),this.lightWidthId[t]=e.resolve(s+"_halfWidth"),this.lightHeight[t]=new Float32Array(3),this.lightHeightId[t]=e.resolve(s+"_halfHeight"),this.lightInAngleId[t]=e.resolve(s+"_innerConeAngle"),this.lightOutAngleId[t]=e.resolve(s+"_outerConeAngle"),this.lightCookieId[t]=e.resolve(s+"_cookie"),this.lightCookieIntId[t]=e.resolve(s+"_cookieIntensity"),this.lightCookieMatrixId[t]=e.resolve(s+"_cookieMatrix"),this.lightCookieOffsetId[t]=e.resolve(s+"_cookieOffset"),this.lightCameraParamsId[t]=e.resolve(s+"_cameraParams"),this.lightSoftShadowParamsId[t]=e.resolve(s+"_softShadowParams"),this.shadowMatrixPaletteId[t]=e.resolve(s+"_shadowMatrixPalette[0]"),this.shadowCascadeDistancesId[t]=e.resolve(s+"_shadowCascadeDistances"),this.shadowCascadeCountId[t]=e.resolve(s+"_shadowCascadeCount"),this.shadowCascadeBlendId[t]=e.resolve(s+"_shadowCascadeBlend")}setLTCDirectionalLight(e,t,s,i,n){this.lightPos[t][0]=i.x-s.x*n,this.lightPos[t][1]=i.y-s.y*n,this.lightPos[t][2]=i.z-s.z*n,this.lightPosId[t].setValue(this.lightPos[t]);var a=e.transformVector(new yt(-.5,0,0));this.lightWidth[t][0]=a.x*n,this.lightWidth[t][1]=a.y*n,this.lightWidth[t][2]=a.z*n,this.lightWidthId[t].setValue(this.lightWidth[t]);var r=e.transformVector(new yt(0,0,.5));this.lightHeight[t][0]=r.x*n,this.lightHeight[t][1]=r.y*n,this.lightHeight[t][2]=r.z*n,this.lightHeightId[t].setValue(this.lightHeight[t])}dispatchDirectLights(e,t,s){for(var i=0,n=this.device.scope,a=0;a<e.length;a++)if(e[a].mask&t){var r=e[a],o=r._node.getWorldTransform();if(this.lightColorId[i]||this._resolveLight(n,i),this.lightColorId[i].setValue(r._colorLinear),o.getY(r._direction).mulScalar(-1),r._direction.normalize(),this.lightDir[i][0]=r._direction.x,this.lightDir[i][1]=r._direction.y,this.lightDir[i][2]=r._direction.z,this.lightDirId[i].setValue(this.lightDir[i]),0!==r.shape&&this.setLTCDirectionalLight(o,i,r._direction,s._node.getPosition(),s.farClip),r.castShadows){var l=r.getRenderData(s,0),h=r._getUniformBiasValues(l);this.lightShadowMapId[i].setValue(l.shadowBuffer),this.lightShadowMatrixId[i].setValue(l.shadowMatrix.data),this.shadowMatrixPaletteId[i].setValue(r._shadowMatrixPalette),this.shadowCascadeDistancesId[i].setValue(r._shadowCascadeDistances),this.shadowCascadeCountId[i].setValue(r.numCascades),this.shadowCascadeBlendId[i].setValue(1-r.cascadeBlend),this.lightShadowIntensity[i].setValue(r.shadowIntensity),this.lightSoftShadowParamsId[i].setValue(r._softShadowParams),l.shadowCamera.renderTarget&&this.lightShadowSearchAreaId[i].setValue(r.penumbraSize/l.shadowCamera.renderTarget.width*l.projectionCompensation);var c=r._shadowCameraParams;c.length=4,c[0]=0,c[1]=l.shadowCamera._farClip,c[2]=l.shadowCamera._nearClip,c[3]=1,this.lightCameraParamsId[i].setValue(c);var d=r._shadowRenderParams;d.length=4,d[0]=r._shadowResolution,d[1]=h.normalBias,d[2]=h.bias,d[3]=0,this.lightShadowParamsId[i].setValue(d)}i++}return i}setLTCPositionalLight(e,t){var s=e.transformVector(new yt(-.5,0,0));this.lightWidth[t][0]=s.x,this.lightWidth[t][1]=s.y,this.lightWidth[t][2]=s.z,this.lightWidthId[t].setValue(this.lightWidth[t]);var i=e.transformVector(new yt(0,0,.5));this.lightHeight[t][0]=i.x,this.lightHeight[t][1]=i.y,this.lightHeight[t][2]=i.z,this.lightHeightId[t].setValue(this.lightHeight[t])}dispatchOmniLight(e,t,s){var i=t._node.getWorldTransform();if(this.lightColorId[s]||this._resolveLight(e,s),this.lightRadiusId[s].setValue(t.attenuationEnd),this.lightColorId[s].setValue(t._colorLinear),i.getTranslation(t._position),this.lightPos[s][0]=t._position.x,this.lightPos[s][1]=t._position.y,this.lightPos[s][2]=t._position.z,this.lightPosId[s].setValue(this.lightPos[s]),0!==t.shape&&this.setLTCPositionalLight(i,s),t.castShadows){var n=t.getRenderData(null,0);this.lightShadowMapId[s].setValue(n.shadowBuffer);var a=t._getUniformBiasValues(n),r=t._shadowRenderParams;r.length=4,r[0]=t._shadowResolution,r[1]=a.normalBias,r[2]=a.bias,r[3]=1/t.attenuationEnd,this.lightShadowParamsId[s].setValue(r),this.lightShadowIntensity[s].setValue(t.shadowIntensity);var o=t.penumbraSize/n.shadowCamera.renderTarget.width;this.lightShadowSearchAreaId[s].setValue(o);var l=t._shadowCameraParams;l.length=4,l[0]=0,l[1]=n.shadowCamera._farClip,l[2]=n.shadowCamera._nearClip,l[3]=0,this.lightCameraParamsId[s].setValue(l)}t._cookie&&(this.lightCookieId[s].setValue(t._cookie),this.lightShadowMatrixId[s].setValue(i.data),this.lightCookieIntId[s].setValue(t.cookieIntensity))}dispatchSpotLight(e,t,s){var i=t._node.getWorldTransform();if(this.lightColorId[s]||this._resolveLight(e,s),this.lightInAngleId[s].setValue(t._innerConeAngleCos),this.lightOutAngleId[s].setValue(t._outerConeAngleCos),this.lightRadiusId[s].setValue(t.attenuationEnd),this.lightColorId[s].setValue(t._colorLinear),i.getTranslation(t._position),this.lightPos[s][0]=t._position.x,this.lightPos[s][1]=t._position.y,this.lightPos[s][2]=t._position.z,this.lightPosId[s].setValue(this.lightPos[s]),0!==t.shape&&this.setLTCPositionalLight(i,s),i.getY(t._direction).mulScalar(-1),t._direction.normalize(),this.lightDir[s][0]=t._direction.x,this.lightDir[s][1]=t._direction.y,this.lightDir[s][2]=t._direction.z,this.lightDirId[s].setValue(this.lightDir[s]),t.castShadows){var n=t.getRenderData(null,0);this.lightShadowMapId[s].setValue(n.shadowBuffer),this.lightShadowMatrixId[s].setValue(n.shadowMatrix.data);var a=t._getUniformBiasValues(n),r=t._shadowRenderParams;r.length=4,r[0]=t._shadowResolution,r[1]=a.normalBias,r[2]=a.bias,r[3]=1/t.attenuationEnd,this.lightShadowParamsId[s].setValue(r),this.lightShadowIntensity[s].setValue(t.shadowIntensity);var o=t.penumbraSize/n.shadowCamera.renderTarget.width,l=n.shadowCamera._fov*Math.PI/180,h=1/Math.tan(l/2);this.lightShadowSearchAreaId[s].setValue(o*h);var c=t._shadowCameraParams;c.length=4,c[0]=0,c[1]=n.shadowCamera._farClip,c[2]=n.shadowCamera._nearClip,c[3]=0,this.lightCameraParamsId[s].setValue(c)}if(t._cookie){if(!t.castShadows){var d=Fl.evalSpotCookieMatrix(t);this.lightShadowMatrixId[s].setValue(d.data)}this.lightCookieId[s].setValue(t._cookie),this.lightCookieIntId[s].setValue(t.cookieIntensity),t._cookieTransform&&(t._cookieTransformUniform[0]=t._cookieTransform.x,t._cookieTransformUniform[1]=t._cookieTransform.y,t._cookieTransformUniform[2]=t._cookieTransform.z,t._cookieTransformUniform[3]=t._cookieTransform.w,this.lightCookieMatrixId[s].setValue(t._cookieTransformUniform),t._cookieOffsetUniform[0]=t._cookieOffset.x,t._cookieOffsetUniform[1]=t._cookieOffset.y,this.lightCookieOffsetId[s].setValue(t._cookieOffsetUniform))}}dispatchLocalLights(e,t,s){for(var i=s,n=this.device.scope,a=e[1],r=a.length,o=0;o<r;o++){var l=a[o];l.mask&t&&(this.dispatchOmniLight(n,l,i),i++)}for(var h=e[2],c=h.length,d=0;d<c;d++){var u=h[d];u.mask&t&&(this.dispatchSpotLight(n,u,i),i++)}}renderForwardPrepareMaterials(e,t,s,i,n,a){var r,o,l=null!=(r=e.fog)?r:this.scene.fog,h=e.shaderParams;h.fog=l.type,h.srgbRenderTarget=null!=(o=null==t?void 0:t.isColorBufferSrgb(0))&&o;var c=(e,t,s,i)=>{fc.drawCalls.push(e),fc.shaderInstances.push(t),fc.isNewMaterial.push(s),fc.lightMaskChanged.push(i)};fc.clear();for(var d,u,p,m=this.device,f=this.scene,g=f.clusteredLightingEnabled,v=null!=(d=null==n?void 0:n.getLightHash(g))?d:0,_=null,y=s.length,x=0;x<y;x++){var w=s[x];w.ensureMaterial(m);var b=w.material,C=w._shaderDefs,S=w.mask;b&&b===_&&C!==u&&(_=null),b!==_&&(this._materialSwitches++,b._scene=f,b.dirty&&(b.updateUniforms(m,f),b.dirty=!1));var A=w.getShaderInstance(a,v,f,h,this.viewUniformFormat,this.viewBindGroupFormat,i);c(w,A,b!==_,!_||S!==p),_=b,u=C,p=S}return fc}renderForwardInternal(e,t,s,i,n,a){for(var r=this.device,o=1<<i,l=a?-1:1,h=this.scene.clusteredLightingEnabled,c=t.drawCalls.length,d=0;d<c;d++){var u,p=t.drawCalls[d],m=t.isNewMaterial[d],f=t.lightMaskChanged[d],g=t.shaderInstances[d],v=p.material,_=p.mask;if(m){if(r.setShader(g.shader,!1),v.setParameters(r),f){var y=this.dispatchDirectLights(s[0],_,e);h||this.dispatchLocalLights(s,_,y)}this.alphaTestId.setValue(v.alphaTest),r.setBlendState(v.blendState),r.setDepthState(v.depthState),r.setAlphaToCoverage(v.alphaToCoverage)}this.setupCullMode(e._cullFaces,l,p);var x,w=null!=(u=p.stencilFront)?u:v.stencilFront,b=null!=(x=p.stencilBack)?x:v.stencilBack;r.setStencilState(w,b),p.setParameters(r,o),r.scope.resolve("meshInstanceId").setValue(p.id);var C=p.mesh;this.setVertexBuffers(r,C),this.setMorphing(r,p.morphInstance),this.setSkinning(r,p),this.setupMeshUniformBuffers(g,p);var S=p.renderStyle;if(r.setIndexBuffer(C.indexBuffer[S]),null==n||n(p,d),e.xr&&e.xr.session&&e.xr.views.list.length)for(var A=e.xr.views,T=0;T<A.list.length;T++){var P=A.list[T];r.setViewport(P.viewport.x,P.viewport.y,P.viewport.z,P.viewport.w),this.projId.setValue(P.projMat.data),this.projSkyboxId.setValue(P.projMat.data),this.viewId.setValue(P.viewOffMat.data),this.viewInvId.setValue(P.viewInvOffMat.data),this.viewId3.setValue(P.viewMat3.data),this.viewProjId.setValue(P.projViewOffMat.data),this.viewPosId.setValue(P.positionData),this.viewIndexId.setValue(T),0===T?this.drawInstance(r,p,C,S,!0):this.drawInstance2(r,p,C,S),this._forwardDrawCalls++}else this.drawInstance(r,p,C,S,!0),this._forwardDrawCalls++;d<c-1&&!t.isNewMaterial[d+1]&&v.setParameters(r,p.parameters)}}renderForward(e,t,s,i,n,a,r,o){var l=this.renderForwardPrepareMaterials(e,t,s,i,r,n);this.renderForwardInternal(e,l,i,n,a,o),fc.clear()}renderForwardLayer(e,t,s,i,n,a,r){void 0===r&&(r={});var o,l,h,c,{scene:d,device:u}=this,p=d.clusteredLightingEnabled;if(this.setupViewport(e,t),s){s.sortVisible(e,i);var m=s.getCulledInstances(e);o=i?m.transparent:m.opaque,d.immediate.onPreRenderLayer(s,o,i),s.requiresLightCube&&(this.lightCube.update(d.ambientLight,s._lights),this.constantLightCube.setValue(this.lightCube.colors)),l=s.splitLights}else{var f;o=r.meshInstances,l=null!=(f=r.splitLights)?f:pc}p&&((null!=(h=r.lightClusters)?h:this.worldClustersAllocator.empty).activate(),s&&(this.clustersDebugRendered||d.lighting.debugLayer!==s.id||(this.clustersDebugRendered=!0)));d._activeCamera=e;var g=null!=(c=e.fog)?c:this.scene.fog;this.setFogConstants(g);var v,_=this.setCameraUniforms(e,t);u.supportsUniformBuffers&&this.setupViewUniformBuffers(a,this.viewUniformFormat,this.viewBindGroupFormat,_);var y,x,w=null!=(v=r.clearColor)&&v,b=null!=(y=r.clearDepth)&&y,C=null!=(x=r.clearStencil)&&x;(w||b||C)&&this.clear(e,w,b,C);var S=!!(e._flipFaces^(null==t?void 0:t.flipY)),A=this._forwardDrawCalls;this.renderForward(e,t,o,l,n,null,s,S),s&&(s._forwardDrawCalls+=this._forwardDrawCalls-A)}setFogConstants(e){if(e.type!==eo){mc.linear(e.color);var t=this.fogColor;t[0]=mc.r,t[1]=mc.g,t[2]=mc.b,this.fogColorId.setValue(t),"linear"===e.type?(this.fogStartId.setValue(e.start),this.fogEndId.setValue(e.end)):this.fogDensityId.setValue(e.density)}}setSceneConstants(){var e=this.scene;this.dispatchGlobalLights(e);var t=this.device;this._screenSize[0]=t.width,this._screenSize[1]=t.height,this._screenSize[2]=1/t.width,this._screenSize[3]=1/t.height,this.screenSizeId.setValue(this._screenSize),this.pcssDiskSamplesId.setValue(this.pcssDiskSamples),this.pcssSphereSamplesId.setValue(this.pcssSphereSamples)}buildFrameGraph(e,t){var s=this.scene;if(e.reset(),s.clusteredLightingEnabled){var{shadowsEnabled:i,cookiesEnabled:n}=s.lighting;this._renderPassUpdateClustered.update(e,i,n,this.lights,this.localLights),e.addRenderPass(this._renderPassUpdateClustered)}else this._shadowRendererLocal.buildNonClusteredRenderPasses(e,this.localLights);for(var a=0,r=!0,o=null,l=t._renderActions,h=a;h<l.length;h++){var c=l[h],{layer:d,camera:u}=c;if(c.useCameraPasses)u.camera.renderPasses.forEach((t=>{e.addRenderPass(t)}));else{var p=1===d.id,m=p&&(u.renderSceneColorMap||u.renderSceneDepthMap);r&&(r=!1,a=h,o=c.renderTarget);var f=l[h+1],g=!!f&&(!f.useCameraPasses&&1===f.layer.id)&&(u.renderSceneColorMap||u.renderSceneDepthMap),v=!!f&&(f.firstCameraUse&&this.cameraDirShadowLights.has(f.camera.camera));if(!f||f.renderTarget!==o||v||g||m){if(p&&a===h||this.addMainRenderPass(e,t,o,a,h),p){if(u.renderSceneColorMap){var _=u.camera.renderPassColorGrab;_.source=u.renderTarget,e.addRenderPass(_)}u.renderSceneDepthMap&&e.addRenderPass(u.camera.renderPassDepthGrab)}if(c.triggerPostprocess&&(null==u?void 0:u.onPostprocessing)){var y=new uc(this.device,this,c);e.addRenderPass(y)}r=!0}}}}addMainRenderPass(e,t,s,i,n){var a=new dc(this.device,t,this.scene,this);a.init(s);for(var r=t._renderActions,o=i;o<=n;o++)a.addRenderAction(r[o]);e.addRenderPass(a)}update(e){this.frameUpdate(),this.shadowRenderer.frameUpdate(),this.scene._updateSkyMesh(),this.updateLayerComposition(e),this.collectLights(e),this.beginFrame(e),this.setSceneConstants(),this.cullComposition(e),this.gpuUpdate(this.processingMeshInstances)}constructor(e){super(e);var t=this.device;this._forwardDrawCalls=0,this._materialSwitches=0,this._depthMapTime=0,this._forwardTime=0,this._sortTime=0;var s=t.scope;this.fogColorId=s.resolve("fog_color"),this.fogStartId=s.resolve("fog_start"),this.fogEndId=s.resolve("fog_end"),this.fogDensityId=s.resolve("fog_density"),this.ambientId=s.resolve("light_globalAmbient"),this.skyboxIntensityId=s.resolve("skyboxIntensity"),this.cubeMapRotationMatrixId=s.resolve("cubeMapRotationMatrix"),this.pcssDiskSamplesId=s.resolve("pcssDiskSamples[0]"),this.pcssSphereSamplesId=s.resolve("pcssSphereSamples[0]"),this.lightColorId=[],this.lightDir=[],this.lightDirId=[],this.lightShadowMapId=[],this.lightShadowMatrixId=[],this.lightShadowParamsId=[],this.lightShadowIntensity=[],this.lightRadiusId=[],this.lightPos=[],this.lightPosId=[],this.lightWidth=[],this.lightWidthId=[],this.lightHeight=[],this.lightHeightId=[],this.lightInAngleId=[],this.lightOutAngleId=[],this.lightCookieId=[],this.lightCookieIntId=[],this.lightCookieMatrixId=[],this.lightCookieOffsetId=[],this.lightShadowSearchAreaId=[],this.lightCameraParamsId=[],this.lightSoftShadowParamsId=[],this.shadowMatrixPaletteId=[],this.shadowCascadeDistancesId=[],this.shadowCascadeCountId=[],this.shadowCascadeBlendId=[],this.screenSizeId=s.resolve("uScreenSize"),this._screenSize=new Float32Array(4),this.fogColor=new Float32Array(3),this.ambientColor=new Float32Array(3),this.pcssDiskSamples=function(e){for(var t=[],s=0;s<e;++s){var i=Math.sqrt(s+.5)/Math.sqrt(e);t.push(i)}return t}(16),this.pcssSphereSamples=function(e){for(var t=[],s=0;s<e;s++){var i=s/e,n=Math.sqrt(i*i);t.push(n)}return t}(16)}}var vc=0,_c=[],yc=new Set;var xc=[null,function(e,t){return e.drawOrder-t.drawOrder},function(e,t){var s=e._key[0],i=t._key[0];return s===i&&e.mesh&&t.mesh?t.mesh.id-e.mesh.id:i-s},function(e,t){return t.zdist-e.zdist},function(e,t){return e.zdist-t.zdist}];class wc{constructor(){this.opaque=[],this.transparent=[]}}class bc{set enabled(e){e!==this._enabled&&(this._dirtyComposition=!0,this._enabled=e,e?(this.incrementCounter(),this.onEnable&&this.onEnable()):(this.decrementCounter(),this.onDisable&&this.onDisable()))}get enabled(){return this._enabled}set clearColorBuffer(e){this._clearColorBuffer=e,this._dirtyComposition=!0}get clearColorBuffer(){return this._clearColorBuffer}set clearDepthBuffer(e){this._clearDepthBuffer=e,this._dirtyComposition=!0}get clearDepthBuffer(){return this._clearDepthBuffer}set clearStencilBuffer(e){this._clearStencilBuffer=e,this._dirtyComposition=!0}get clearStencilBuffer(){return this._clearStencilBuffer}get hasClusteredLights(){return this._clusteredLightsSet.size>0}get clusteredLightsSet(){return this._clusteredLightsSet}incrementCounter(){0===this._refCounter&&(this._enabled=!0,this.onEnable&&this.onEnable()),this._refCounter++}decrementCounter(){if(1===this._refCounter)this._enabled=!1,this.onDisable&&this.onDisable();else if(0===this._refCounter)return;this._refCounter--}addMeshInstances(e,t){for(var s=this.meshInstances,i=this.meshInstancesSet,n=0;n<e.length;n++){var a=e[n];i.has(a)||(s.push(a),i.add(a),yc.add(a.material))}if(t||this.addShadowCasters(e),yc.size>0){var r=this._shaderVersion;yc.forEach((e=>{r>=0&&e._shaderVersion!==r&&(e.getShaderVariant!==mh.prototype.getShaderVariant&&e.clearVariants(),e._shaderVersion=r)})),yc.clear()}}removeMeshInstances(e,t){for(var s=this.meshInstances,i=this.meshInstancesSet,n=0;n<e.length;n++){var a=e[n];if(i.has(a)){i.delete(a);var r=s.indexOf(a);r>=0&&s.splice(r,1)}}t||this.removeShadowCasters(e)}addShadowCasters(e){for(var t=this.shadowCasters,s=this.shadowCastersSet,i=0;i<e.length;i++){var n=e[i];n.castShadow&&!s.has(n)&&(s.add(n),t.push(n))}}removeShadowCasters(e){for(var t=this.shadowCasters,s=this.shadowCastersSet,i=0;i<e.length;i++){var n=e[i];if(s.has(n)){s.delete(n);var a=t.indexOf(n);a>=0&&t.splice(a,1)}}}clearMeshInstances(e){void 0===e&&(e=!1),this.meshInstances.length=0,this.meshInstancesSet.clear(),e||(this.shadowCasters.length=0,this.shadowCastersSet.clear())}markLightsDirty(){this._lightHashDirty=!0,this._lightIdHashDirty=!0,this._splitLightsDirty=!0}hasLight(e){return this._lightsSet.has(e)}addLight(e){var t=e.light;this._lightsSet.has(t)||(this._lightsSet.add(t),this._lights.push(t),this.markLightsDirty()),0!==t.type&&this._clusteredLightsSet.add(t)}removeLight(e){var t=e.light;this._lightsSet.has(t)&&(this._lightsSet.delete(t),this._lights.splice(this._lights.indexOf(t),1),this.markLightsDirty()),0!==t.type&&this._clusteredLightsSet.delete(t)}clearLights(){this._lightsSet.forEach((e=>e.removeLayer(this))),this._lightsSet.clear(),this._clusteredLightsSet.clear(),this._lights.length=0,this.markLightsDirty()}get splitLights(){if(this._splitLightsDirty){this._splitLightsDirty=!1;for(var e=this._splitLights,t=0;t<e.length;t++)e[t].length=0;for(var s=this._lights,i=0;i<s.length;i++){var n=s[i];n.enabled&&e[n._type].push(n)}for(var a=0;a<e.length;a++)e[a].sort(((e,t)=>e.key-t.key))}return this._splitLights}evaluateLightHash(e,t,s){for(var i=0,n=this._lights,a=0;a<n.length;a++){var r=0!==n[a].type;(e&&r||t&&!r)&&_c.push(s?n[a].id:n[a].key)}return _c.length>0&&(_c.sort(),i=Zi(_c),_c.length=0),i}getLightHash(e){return this._lightHashDirty&&(this._lightHashDirty=!1,this._lightHash=this.evaluateLightHash(!e,!0,!1)),this._lightHash}getLightIdHash(){return this._lightIdHashDirty&&(this._lightIdHashDirty=!1,this._lightIdHash=this.evaluateLightHash(!0,!1,!0)),this._lightIdHash}addCamera(e){this.camerasSet.has(e.camera)||(this.camerasSet.add(e.camera),this.cameras.push(e),this._dirtyComposition=!0)}removeCamera(e){if(this.camerasSet.has(e.camera)){this.camerasSet.delete(e.camera);var t=this.cameras.indexOf(e);this.cameras.splice(t,1),this._dirtyComposition=!0}}clearCameras(){this.cameras.length=0,this.camerasSet.clear(),this._dirtyComposition=!0}_calculateSortDistances(e,t,s,i){for(var n=0;n<t;n++){var a=e[n];if(!(a.layer<=2))if(a.calculateSortDistance)a.zdist=a.calculateSortDistance(a,s,i);else{var r=a.aabb.center,o=r.x-s.x,l=r.y-s.y,h=r.z-s.z;a.zdist=o*i.x+l*i.y+h*i.z}}}getCulledInstances(e){var t=this._visibleInstances.get(e);return t||(t=new wc,this._visibleInstances.set(e,t)),t}sortVisible(e,t){var s=t?this.transparentSortMode:this.opaqueSortMode;if(0!==s){var i=this.getCulledInstances(e),n=t?i.transparent:i.opaque,a=e.node;if(5===s){var r=a.getPosition(),o=a.forward;this.customCalculateSortValues&&this.customCalculateSortValues(n,n.length,r,o),this.customSortCallback&&n.sort(this.customSortCallback)}else{if(3===s||4===s){var l=a.getPosition(),h=a.forward;this._calculateSortDistances(n,n.length,l,h)}n.sort(xc[s])}}}constructor(e={}){var t,s,i;this.meshInstances=[],this.meshInstancesSet=new Set,this.shadowCasters=[],this.shadowCastersSet=new Set,this._visibleInstances=new WeakMap,this._lights=[],this._lightsSet=new Set,this._clusteredLightsSet=new Set,this._splitLights=[[],[],[]],this._splitLightsDirty=!0,this.requiresLightCube=!1,this.cameras=[],this.camerasSet=new Set,this._dirtyComposition=!1,void 0!==e.id?(this.id=e.id,vc=Math.max(this.id+1,vc)):this.id=vc++,this.name=e.name,this._enabled=null==(t=e.enabled)||t,this._refCounter=this._enabled?1:0,this.opaqueSortMode=null!=(s=e.opaqueSortMode)?s:2,this.transparentSortMode=null!=(i=e.transparentSortMode)?i:3,e.renderTarget&&(this.renderTarget=e.renderTarget),this._clearColorBuffer=!!e.clearColorBuffer,this._clearDepthBuffer=!!e.clearDepthBuffer,this._clearStencilBuffer=!!e.clearStencilBuffer,this.onEnable=e.onEnable,this.onDisable=e.onDisable,this._enabled&&this.onEnable&&this.onEnable(),this.customSortCallback=null,this.customCalculateSortValues=null,this._lightHash=0,this._lightHashDirty=!1,this._lightIdHash=0,this._lightIdHashDirty=!1,this._shaderVersion=-1}}var Cc=(e,t)=>e.priority-t.priority,Sc=e=>e.sort(Cc);class Ac extends tt{destroy(){this.destroyRenderActions()}destroyRenderActions(){this._renderActions.forEach((e=>e.destroy())),this._renderActions.length=0}_update(){var e=this.layerList.length;if(!this._dirty)for(var t=0;t<e;t++)if(this.layerList[t]._dirtyComposition){this._dirty=!0;break}if(this._dirty){this._dirty=!1,this.cameras.length=0;for(var s=0;s<e;s++){var i=this.layerList[s];i._dirtyComposition=!1;for(var n=0;n<i.cameras.length;n++){var a=i.cameras[n];this.cameras.indexOf(a)<0&&this.cameras.push(a)}}this.cameras.length>1&&Sc(this.cameras);var r=[],o=0;this.destroyRenderActions();for(var l=0;l<this.cameras.length;l++){var h=this.cameras[l];if(r.length=0,h.camera.renderPasses.length>0)this.addDummyRenderAction(o,h),o++;else{for(var c=!0,d=o,u=null,p=!1,m=0;m<e;m++){var f=this.layerList[m];if(f.enabled&&this.subLayerEnabled[m]&&f.cameras.length>0&&h.layers.indexOf(f.id)>=0){r.push(f),p||f.id!==h.disablePostEffectsLayer||(p=!0,u&&(u.triggerPostprocess=!0));var g=this.subLayerList[m];u=this.addRenderAction(o,f,g,h,c,p),o++,c=!1}}d<o&&(u.lastCameraUse=!0),!p&&u&&(u.triggerPostprocess=!0),h.renderTarget&&h.postEffectsEnabled&&this.propagateRenderTarget(d-1,h)}}this._logRenderActions()}}getNextRenderAction(e){var t=new cc;return this._renderActions.push(t),t}addDummyRenderAction(e,t){var s=this.getNextRenderAction(e);s.camera=t,s.useCameraPasses=!0}addRenderAction(e,t,s,i,n,a){for(var r=1!==t.id?i.renderTarget:null,o=!1,l=this._renderActions,h=e-1;h>=0;h--)if(l[h].camera===i&&l[h].renderTarget===r){o=!0;break}a&&i.postEffectsEnabled&&(r=null);var c=this.getNextRenderAction(e);c.triggerPostprocess=!1,c.layer=t,c.transparent=s,c.camera=i,c.renderTarget=r,c.firstCameraUse=n,c.lastCameraUse=!1;var d=n||!o,u=t.clearColorBuffer||t.clearDepthBuffer||t.clearStencilBuffer;return(d||u)&&c.setupClears(d?i:void 0,t),c}propagateRenderTarget(e,t){for(var s=e;s>=0;s--){var i=this._renderActions[s],n=i.layer;if(i.renderTarget&&1!==n.id)break;if(1!==n.id){if(i.useCameraPasses)break;var a=null==i?void 0:i.camera.camera;if(a&&(!t.camera.rect.equals(a.rect)||!t.camera.scissorRect.equals(a.scissorRect)))break;i.renderTarget=t.renderTarget}}}_logRenderActions(){}_isLayerAdded(e){return this.layerIdMap.get(e.id)===e}_isSublayerAdded(e,t){return void 0!==(t?this.layerTransparentIndexMap:this.layerOpaqueIndexMap).get(e)}push(e){this._isLayerAdded(e)||(this.layerList.push(e),this.layerList.push(e),this._opaqueOrder[e.id]=this.subLayerList.push(!1)-1,this._transparentOrder[e.id]=this.subLayerList.push(!0)-1,this.subLayerEnabled.push(!0),this.subLayerEnabled.push(!0),this._updateLayerMaps(),this._dirty=!0,this.fire("add",e))}insert(e,t){if(!this._isLayerAdded(e)){this.layerList.splice(t,0,e,e),this.subLayerList.splice(t,0,!1,!0);var s=this.layerList.length;this._updateOpaqueOrder(t,s-1),this._updateTransparentOrder(t,s-1),this.subLayerEnabled.splice(t,0,!0,!0),this._updateLayerMaps(),this._dirty=!0,this.fire("add",e)}}remove(e){var t=this.layerList.indexOf(e);for(delete this._opaqueOrder[t],delete this._transparentOrder[t];t>=0;)this.layerList.splice(t,1),this.subLayerList.splice(t,1),this.subLayerEnabled.splice(t,1),t=this.layerList.indexOf(e),this._dirty=!0,this.fire("remove",e);var s=this.layerList.length;this._updateOpaqueOrder(0,s-1),this._updateTransparentOrder(0,s-1),this._updateLayerMaps()}pushOpaque(e){this._isSublayerAdded(e,!1)||(this.layerList.push(e),this._opaqueOrder[e.id]=this.subLayerList.push(!1)-1,this.subLayerEnabled.push(!0),this._updateLayerMaps(),this._dirty=!0,this.fire("add",e))}insertOpaque(e,t){if(!this._isSublayerAdded(e,!1)){this.layerList.splice(t,0,e),this.subLayerList.splice(t,0,!1);var s=this.subLayerList.length;this._updateOpaqueOrder(t,s-1),this.subLayerEnabled.splice(t,0,!0),this._updateLayerMaps(),this._dirty=!0,this.fire("add",e)}}removeOpaque(e){for(var t=0,s=this.layerList.length;t<s;t++)if(this.layerList[t]===e&&!this.subLayerList[t]){this.layerList.splice(t,1),this.subLayerList.splice(t,1),s--,this._updateOpaqueOrder(t,s-1),this.subLayerEnabled.splice(t,1),this._dirty=!0,this.layerList.indexOf(e)<0&&this.fire("remove",e);break}this._updateLayerMaps()}pushTransparent(e){this._isSublayerAdded(e,!0)||(this.layerList.push(e),this._transparentOrder[e.id]=this.subLayerList.push(!0)-1,this.subLayerEnabled.push(!0),this._updateLayerMaps(),this._dirty=!0,this.fire("add",e))}insertTransparent(e,t){if(!this._isSublayerAdded(e,!0)){this.layerList.splice(t,0,e),this.subLayerList.splice(t,0,!0);var s=this.subLayerList.length;this._updateTransparentOrder(t,s-1),this.subLayerEnabled.splice(t,0,!0),this._updateLayerMaps(),this._dirty=!0,this.fire("add",e)}}removeTransparent(e){for(var t=0,s=this.layerList.length;t<s;t++)if(this.layerList[t]===e&&this.subLayerList[t]){this.layerList.splice(t,1),this.subLayerList.splice(t,1),s--,this._updateTransparentOrder(t,s-1),this.subLayerEnabled.splice(t,1),this._dirty=!0,this.layerList.indexOf(e)<0&&this.fire("remove",e);break}this._updateLayerMaps()}getOpaqueIndex(e){var t;return null!=(t=this.layerOpaqueIndexMap.get(e))?t:-1}getTransparentIndex(e){var t;return null!=(t=this.layerTransparentIndexMap.get(e))?t:-1}isEnabled(e,t){if(e.enabled){var s=t?this.getTransparentIndex(e):this.getOpaqueIndex(e);if(s>=0)return this.subLayerEnabled[s]}return!1}_updateLayerMaps(){this.layerIdMap.clear(),this.layerNameMap.clear(),this.layerOpaqueIndexMap.clear(),this.layerTransparentIndexMap.clear();for(var e=0;e<this.layerList.length;e++){var t=this.layerList[e];this.layerIdMap.set(t.id,t),this.layerNameMap.set(t.name,t),(this.subLayerList[e]?this.layerTransparentIndexMap:this.layerOpaqueIndexMap).set(t,e)}}getLayerById(e){var t;return null!=(t=this.layerIdMap.get(e))?t:null}getLayerByName(e){var t;return null!=(t=this.layerNameMap.get(e))?t:null}_updateOpaqueOrder(e,t){for(var s=e;s<=t;s++)!1===this.subLayerList[s]&&(this._opaqueOrder[this.layerList[s].id]=s)}_updateTransparentOrder(e,t){for(var s=e;s<=t;s++)!0===this.subLayerList[s]&&(this._transparentOrder[this.layerList[s].id]=s)}_sortLayersDescending(e,t,s){for(var i=-1,n=-1,a=0,r=e.length;a<r;a++){var o=e[a];s.hasOwnProperty(o)&&(i=Math.max(i,s[o]))}for(var l=0,h=t.length;l<h;l++){var c=t[l];s.hasOwnProperty(c)&&(n=Math.max(n,s[c]))}return-1===i&&-1!==n?1:-1===n&&-1!==i?-1:n-i}sortTransparentLayers(e,t){return this._sortLayersDescending(e,t,this._transparentOrder)}sortOpaqueLayers(e,t){return this._sortLayersDescending(e,t,this._opaqueOrder)}constructor(e="Untitled"){super(),this.layerList=[],this.layerIdMap=new Map,this.layerNameMap=new Map,this.layerOpaqueIndexMap=new Map,this.layerTransparentIndexMap=new Map,this.subLayerList=[],this.subLayerEnabled=[],this.cameras=[],this._renderActions=[],this._dirty=!1,this.name=e,this._opaqueOrder={},this._transparentOrder={}}}var Tc=new yt,Pc={bias:0,normalBias:0},Ec=new mt,kc={r:0,g:1,b:2,a:3},Mc={directional:0,omni:1,point:1,spot:2},Ic=[[new bt(0,0,1,1)],[new bt(0,0,.5,.5),new bt(0,.5,.5,.5)],[new bt(0,0,.5,.5),new bt(0,.5,.5,.5),new bt(.5,0,.5,.5)],[new bt(0,0,.5,.5),new bt(0,.5,.5,.5),new bt(.5,0,.5,.5),new bt(.5,.5,.5,.5)]],Dc=0;class Rc{destroy(){this.viewBindGroups.forEach((e=>{e.defaultUniformBuffer.destroy(),e.destroy()})),this.viewBindGroups.length=0}get shadowBuffer(){var e=this.shadowCamera.renderTarget;return e?this.light._isPcf?e.depthBuffer:e.colorBuffer:null}constructor(e,t,s){this.light=s,this.camera=e,this.shadowCamera=Rh.createShadowCamera(s._shadowType,s._type,t),this.shadowMatrix=new Et,this.shadowViewport=new bt(0,0,1,1),this.shadowScissor=new bt(0,0,1,1),this.projectionCompensation=0,this.face=t,this.visibleCasters=[],this.viewBindGroups=[]}}class Lc{destroy(){this._destroyShadowMap(),this.releaseRenderData(),this._renderData=null}releaseRenderData(){if(this._renderData){for(var e=0;e<this._renderData.length;e++)this._renderData[e].destroy();this._renderData.length=0}}addLayer(e){this.layers.add(e)}removeLayer(e){this.layers.delete(e)}set shadowSamples(e){this._softShadowParams[0]=e}get shadowSamples(){return this._softShadowParams[0]}set shadowBlockerSamples(e){this._softShadowParams[1]=e}get shadowBlockerSamples(){return this._softShadowParams[1]}set shadowBias(e){this._shadowBias!==e&&(this._shadowBias=e,this._updateShadowBias())}get shadowBias(){return this._shadowBias}set numCascades(e){this.cascades&&this.numCascades===e||(this.cascades=Ic[e-1],this._shadowMatrixPalette=new Float32Array(64),this._shadowCascadeDistances=new Float32Array(4),this._destroyShadowMap(),this.updateKey())}get numCascades(){return this.cascades.length}set cascadeBlend(e){this._cascadeBlend!==e&&(this._cascadeBlend=e,this.updateKey())}get cascadeBlend(){return this._cascadeBlend}set shadowMap(e){this._shadowMap!==e&&(this._destroyShadowMap(),this._shadowMap=e)}get shadowMap(){return this._shadowMap}set mask(e){this._mask!==e&&(this._mask=e,this.updateKey())}get mask(){return this._mask}get numShadowFaces(){var e=this._type;return 0===e?this.numCascades:1===e?6:1}set type(e){if(this._type!==e){this._type=e,this._destroyShadowMap(),this._updateShadowBias(),this.updateKey();var t=this._shadowType;this._shadowType=null,this.shadowUpdateOverrides=null,this.shadowType=t}}get type(){return this._type}set shape(e){if(this._shape!==e){this._shape=e,this._destroyShadowMap(),this.updateKey();var t=this._shadowType;this._shadowType=null,this.shadowType=t}}get shape(){return this._shape}set usePhysicalUnits(e){this._usePhysicalUnits!==e&&(this._usePhysicalUnits=e,this._updateLinearColor())}get usePhysicalUnits(){return this._usePhysicalUnits}set shadowType(e){if(this._shadowType!==e){var t=this.device;6!==e||t.textureFloatRenderable||t.textureHalfFloatRenderable||(e=0),1===this._type&&5!==e&&0!==e&&7!==e&&8!==e&&6!==e&&(e=0),3!==e||t.textureFloatRenderable&&t.textureFloatFilterable||(e=2),2!==e||t.textureHalfFloatRenderable||(e=0);var s,i,n=to.get(e);this._isVsm=null!=(s=null==n?void 0:n.vsm)&&s,this._isPcf=null!=(i=null==n?void 0:n.pcf)&&i,this._shadowType=e,this._destroyShadowMap(),this.updateKey()}}get shadowType(){return this._shadowType}set enabled(e){this._enabled!==e&&(this._enabled=e,this.layersDirty())}get enabled(){return this._enabled}set castShadows(e){this._castShadows!==e&&(this._castShadows=e,this._destroyShadowMap(),this.layersDirty(),this.updateKey())}get castShadows(){return this._castShadows&&4!==this._mask&&0!==this._mask}get bakeShadows(){return this._castShadows&&4===this._mask}set shadowResolution(e){this._shadowResolution!==e&&(e=1===this._type?Math.min(e,this.device.maxCubeMapSize):Math.min(e,this.device.maxTextureSize),this._shadowResolution=e,this._destroyShadowMap())}get shadowResolution(){return this._shadowResolution}set vsmBlurSize(e){this._vsmBlurSize!==e&&(e%2==0&&e++,this._vsmBlurSize=e)}get vsmBlurSize(){return this._vsmBlurSize}set normalOffsetBias(e){if(this._normalOffsetBias!==e){var t=!this._normalOffsetBias&&e||this._normalOffsetBias&&!e;this._normalOffsetBias=e,t&&this.updateKey()}}get normalOffsetBias(){return this._normalOffsetBias}set falloffMode(e){this._falloffMode!==e&&(this._falloffMode=e,this.updateKey())}get falloffMode(){return this._falloffMode}set innerConeAngle(e){this._innerConeAngle!==e&&(this._innerConeAngle=e,this._innerConeAngleCos=Math.cos(e*Math.PI/180),this._usePhysicalUnits&&this._updateLinearColor())}get innerConeAngle(){return this._innerConeAngle}set outerConeAngle(e){this._outerConeAngle!==e&&(this._outerConeAngle=e,this._updateOuterAngle(e),this._usePhysicalUnits&&this._updateLinearColor())}get outerConeAngle(){return this._outerConeAngle}set penumbraSize(e){this._penumbraSize=e,this._softShadowParams[2]=e}get penumbraSize(){return this._penumbraSize}set penumbraFalloff(e){this._softShadowParams[3]=e}get penumbraFalloff(){return this._softShadowParams[3]}_updateOuterAngle(e){var t=e*Math.PI/180;this._outerConeAngleCos=Math.cos(t),this._outerConeAngleSin=Math.sin(t)}set intensity(e){this._intensity!==e&&(this._intensity=e,this._updateLinearColor())}get intensity(){return this._intensity}set affectSpecularity(e){0===this._type&&(this._affectSpecularity=e,this.updateKey())}get affectSpecularity(){return this._affectSpecularity}set luminance(e){this._luminance!==e&&(this._luminance=e,this._updateLinearColor())}get luminance(){return this._luminance}get cookieMatrix(){return this._cookieMatrix||(this._cookieMatrix=new Et),this._cookieMatrix}get atlasViewport(){return this._atlasViewport||(this._atlasViewport=new bt(0,0,1,1)),this._atlasViewport}set cookie(e){this._cookie!==e&&(this._cookie=e,this.updateKey())}get cookie(){return this._cookie}set cookieFalloff(e){this._cookieFalloff!==e&&(this._cookieFalloff=e,this.updateKey())}get cookieFalloff(){return this._cookieFalloff}set cookieChannel(e){if(this._cookieChannel!==e){if(e.length<3)for(var t=e.charAt(e.length-1),s=3-e.length,i=0;i<s;i++)e+=t;this._cookieChannel=e,this.updateKey()}}get cookieChannel(){return this._cookieChannel}set cookieTransform(e){this._cookieTransform!==e&&(this._cookieTransform=e,this._cookieTransformSet=!!e,e&&!this._cookieOffset&&(this.cookieOffset=new wt,this._cookieOffsetSet=!1),this.updateKey())}get cookieTransform(){return this._cookieTransform}set cookieOffset(e){this._cookieOffset!==e&&(!(!this._cookieTransformSet&&!e)&&!e&&this._cookieOffset?this._cookieOffset.set(0,0):this._cookieOffset=e,this._cookieOffsetSet=!!e,e&&!this._cookieTransform&&(this.cookieTransform=new bt(1,1,0,0),this._cookieTransformSet=!1),this.updateKey())}get cookieOffset(){return this._cookieOffset}beginFrame(){this.visibleThisFrame=0===this._type&&this._enabled,this.maxScreenSize=0,this.atlasViewportAllocated=!1,this.atlasSlotUpdated=!1}_destroyShadowMap(){if(this.releaseRenderData(),this._shadowMap&&(this._shadowMap.cached||this._shadowMap.destroy(),this._shadowMap=null),0===this.shadowUpdateMode&&(this.shadowUpdateMode=1),this.shadowUpdateOverrides)for(var e=0;e<this.shadowUpdateOverrides.length;e++)0===this.shadowUpdateOverrides[e]&&(this.shadowUpdateOverrides[e]=1)}getRenderData(e,t){for(var s=0;s<this._renderData.length;s++){var i=this._renderData[s];if(i.camera===e&&i.face===t)return i}var n=new Rc(e,t,this);return this._renderData.push(n),n}clone(){var e=new Lc(this.device,this.clusteredLighting);return e.type=this._type,e.setColor(this._color),e.intensity=this._intensity,e.affectSpecularity=this._affectSpecularity,e.luminance=this._luminance,e.castShadows=this.castShadows,e._enabled=this._enabled,e.attenuationStart=this.attenuationStart,e.attenuationEnd=this.attenuationEnd,e.falloffMode=this._falloffMode,e.shadowType=this._shadowType,e.vsmBlurSize=this._vsmBlurSize,e.vsmBlurMode=this.vsmBlurMode,e.vsmBias=this.vsmBias,e.shadowUpdateMode=this.shadowUpdateMode,e.mask=this.mask,this.shadowUpdateOverrides&&(e.shadowUpdateOverrides=this.shadowUpdateOverrides.slice()),e.innerConeAngle=this._innerConeAngle,e.outerConeAngle=this._outerConeAngle,e.numCascades=this.numCascades,e.cascadeDistribution=this.cascadeDistribution,e.cascadeBlend=this._cascadeBlend,e.shape=this._shape,e.shadowDepthState.copy(this.shadowDepthState),e.shadowBias=this.shadowBias,e.normalOffsetBias=this._normalOffsetBias,e.shadowResolution=this._shadowResolution,e.shadowDistance=this.shadowDistance,e.shadowIntensity=this.shadowIntensity,e.shadowSamples=this.shadowSamples,e.shadowBlockerSamples=this.shadowBlockerSamples,e.penumbraSize=this.penumbraSize,e.penumbraFalloff=this.penumbraFalloff,e}static getLightUnitConversion(e,t,s){switch(void 0===t&&(t=Math.PI/4),void 0===s&&(s=0),e){case 2:var i=Math.cos(t),n=Math.cos(s);return 2*Math.PI*(1-n+(n-i)/2);case 1:return 4*Math.PI;case 0:return 1}}_getUniformBiasValues(e){var t=e.shadowCamera._farClip;switch(this._type){case 1:Pc.bias=this.shadowBias,Pc.normalBias=this._normalOffsetBias;break;case 2:this._isVsm?Pc.bias=-2e-4:Pc.bias=20*this.shadowBias,Pc.normalBias=this._isVsm?this.vsmBias/(this.attenuationEnd/7):this._normalOffsetBias;break;case 0:this._isVsm?Pc.bias=-2e-4:Pc.bias=this.shadowBias/t*100,Pc.normalBias=this._isVsm?this.vsmBias/(t/7):this._normalOffsetBias}return Pc}getColor(){return this._color}getBoundingSphere(e){if(2===this._type){var t=this.attenuationEnd,s=this._outerConeAngle,i=this._outerConeAngleCos,n=this._node;Tc.copy(n.up),s>45?(e.radius=t*this._outerConeAngleSin,Tc.mulScalar(-t*i)):(e.radius=t/(2*i),Tc.mulScalar(-e.radius)),e.center.add2(n.getPosition(),Tc)}else 1===this._type&&(e.center=this._node.getPosition(),e.radius=this.attenuationEnd)}getBoundingBox(e){if(2===this._type){var t=this.attenuationEnd,s=this._outerConeAngle,i=this._node,n=Math.abs(Math.sin(s*pt.DEG_TO_RAD)*t);e.center.set(0,.5*-t,0),e.halfExtents.set(n,.5*t,n),e.setFromTransformedAabb(e,i.getWorldTransform(),!0)}else 1===this._type&&(e.center.copy(this._node.getPosition()),e.halfExtents.set(this.attenuationEnd,this.attenuationEnd,this.attenuationEnd))}_updateShadowBias(){if(1!==this._type||this.clusteredLighting){var e=-1e3*this.shadowBias;this.shadowDepthState.depthBias=e,this.shadowDepthState.depthBiasSlope=e}else this.shadowDepthState.depthBias=0,this.shadowDepthState.depthBiasSlope=0}_updateLinearColor(){var e=this._intensity;this._usePhysicalUnits&&(e=this._luminance/Lc.getLightUnitConversion(this._type,this._outerConeAngle*pt.DEG_TO_RAD,this._innerConeAngle*pt.DEG_TO_RAD));var t=this._color,s=this._colorLinear;e>=1?Ec.linear(t).mulScalar(e):Ec.copy(t).mulScalar(e).linear(),s[0]=Ec.r,s[1]=Ec.g,s[2]=Ec.b}setColor(){1===arguments.length?this._color.set(arguments[0].r,arguments[0].g,arguments[0].b):3===arguments.length&&this._color.set(arguments[0],arguments[1],arguments[2]),this._updateLinearColor()}layersDirty(){this.layers.forEach((e=>{e.hasLight(this)&&e.markLightsDirty()}))}updateKey(){var e=this._type<<29|this._shadowType<<25|this._falloffMode<<23|(0!==this._normalOffsetBias?1:0)<<22|(this._cookie?1:0)<<21|(this._cookieFalloff?1:0)<<20|kc[this._cookieChannel.charAt(0)]<<18|(this._cookieTransform?1:0)<<12|this._shape<<10|(this.numCascades>0?1:0)<<9|(this._cascadeBlend>0?1:0)<<8|(this.affectSpecularity?1:0)<<7|this.mask<<6|(this._castShadows?1:0)<<3;3===this._cookieChannel.length&&(e|=kc[this._cookieChannel.charAt(1)]<<16,e|=kc[this._cookieChannel.charAt(2)]<<14),e!==this.key&&this.layersDirty(),this.key=e}constructor(e,t){this.layers=new Set,this.shadowDepthState=Hi.DEFAULT.clone(),this.device=e,this.clusteredLighting=t,this.id=Dc++,this._type=0,this._color=new mt(.8,.8,.8),this._intensity=1,this._affectSpecularity=!0,this._luminance=0,this._castShadows=!1,this._enabled=!1,this._mask=1,this.isStatic=!1,this.key=0,this.bakeDir=!0,this.bakeNumSamples=1,this.bakeArea=0,this.attenuationStart=10,this.attenuationEnd=10,this._falloffMode=0,this._shadowType=0,this._vsmBlurSize=11,this.vsmBlurMode=1,this.vsmBias=.0025,this._cookie=null,this.cookieIntensity=1,this._cookieFalloff=!0,this._cookieChannel="rgb",this._cookieTransform=null,this._cookieTransformUniform=new Float32Array(4),this._cookieOffset=null,this._cookieOffsetUniform=new Float32Array(2),this._cookieTransformSet=!1,this._cookieOffsetSet=!1,this._innerConeAngle=40,this._outerConeAngle=45,this.cascades=null,this._shadowMatrixPalette=null,this._shadowCascadeDistances=null,this.numCascades=1,this._cascadeBlend=0,this.cascadeDistribution=.5,this._shape=0,this._colorLinear=new Float32Array(3),this._updateLinearColor(),this._position=new yt(0,0,0),this._direction=new yt(0,0,0),this._innerConeAngleCos=Math.cos(this._innerConeAngle*Math.PI/180),this._updateOuterAngle(this._outerConeAngle),this._usePhysicalUnits=void 0,this._shadowMap=null,this._shadowRenderParams=[],this._shadowCameraParams=[],this.shadowDistance=40,this._shadowResolution=1024,this._shadowBias=-5e-4,this.shadowIntensity=1,this._normalOffsetBias=0,this.shadowUpdateMode=2,this.shadowUpdateOverrides=null,this._isVsm=!1,this._isPcf=!0,this._softShadowParams=new Float32Array(4),this.shadowSamples=16,this.shadowBlockerSamples=16,this.penumbraSize=1,this.penumbraFalloff=1,this._cookieMatrix=null,this._atlasViewport=null,this.atlasViewportAllocated=!1,this.atlasVersion=0,this.atlasSlotIndex=0,this.atlasSlotUpdated=!1,this._node=null,this._renderData=[],this.visibleThisFrame=!1,this.maxScreenSize=0,this._updateShadowBias()}}class Fc{applySettings(e){var t,s,i,n,a,r,o;this.shadowsEnabled=null!=(t=e.lightingShadowsEnabled)?t:this.shadowsEnabled,this.cookiesEnabled=null!=(s=e.lightingCookiesEnabled)?s:this.cookiesEnabled,this.areaLightsEnabled=null!=(i=e.lightingAreaLightsEnabled)?i:this.areaLightsEnabled,this.shadowAtlasResolution=null!=(n=e.lightingShadowAtlasResolution)?n:this.shadowAtlasResolution,this.cookieAtlasResolution=null!=(a=e.lightingCookieAtlasResolution)?a:this.cookieAtlasResolution,this.maxLightsPerCell=null!=(r=e.lightingMaxLightsPerCell)?r:this.maxLightsPerCell,this.shadowType=null!=(o=e.lightingShadowType)?o:this.shadowType,e.lightingCells&&(this.cell=new yt(e.lightingCells))}set cells(e){this._cells.copy(e)}get cells(){return this._cells}set maxLightsPerCell(e){this._maxLightsPerCell=pt.clamp(e,1,255)}get maxLightsPerCell(){return this._maxLightsPerCell}set cookieAtlasResolution(e){this._cookieAtlasResolution=pt.clamp(e,32,this._maxTextureSize)}get cookieAtlasResolution(){return this._cookieAtlasResolution}set shadowAtlasResolution(e){this._shadowAtlasResolution=pt.clamp(e,32,this._maxTextureSize)}get shadowAtlasResolution(){return this._shadowAtlasResolution}set shadowType(e){this._shadowType!==e&&(this._shadowType=e,this._dirtyLightsFnc())}get shadowType(){return this._shadowType}set cookiesEnabled(e){this._cookiesEnabled!==e&&(this._cookiesEnabled=e,this._dirtyLightsFnc())}get cookiesEnabled(){return this._cookiesEnabled}set areaLightsEnabled(e){this._supportsAreaLights&&this._areaLightsEnabled!==e&&(this._areaLightsEnabled=e,this._dirtyLightsFnc())}get areaLightsEnabled(){return this._areaLightsEnabled}set shadowsEnabled(e){this._shadowsEnabled!==e&&(this._shadowsEnabled=e,this._dirtyLightsFnc())}get shadowsEnabled(){return this._shadowsEnabled}constructor(e,t,s){this._areaLightsEnabled=!1,this._cells=new yt(10,3,10),this._maxLightsPerCell=255,this._shadowsEnabled=!0,this._shadowType=0,this._shadowAtlasResolution=2048,this._cookiesEnabled=!1,this._cookieAtlasResolution=2048,this.atlasSplit=null,this._supportsAreaLights=e,this._maxTextureSize=t,this._dirtyLightsFnc=s}}var Bc=new Vi(!0,0,1,1);class Oc{destroy(){this.shader=null;var e=this.morph;e&&(this.morph=null,e.decRefCount(),e.refCount<1&&e.destroy()),this.rtPositions&&(this.rtPositions.destroy(),this.rtPositions=null),this.texturePositions&&(this.texturePositions.destroy(),this.texturePositions=null),this.rtNormals&&(this.rtNormals.destroy(),this.rtNormals=null),this.textureNormals&&(this.textureNormals.destroy(),this.textureNormals=null)}clone(){return new Oc(this.morph)}_getWeightIndex(e){return"string"==typeof e?this._weightMap.get(e):e}getWeight(e){var t=this._getWeightIndex(e);return this._weights[t]}setWeight(e,t){var s=this._getWeightIndex(e);this._weights[s]=t,this._dirty=!0}_getFragmentShader(e){for(var t="",s="",i=0;i<e;i++)t+="uniform highp sampler2D morphBlendTex"+i+";",s+="color.xyz += morphFactor["+i+"] * texture2D(morphBlendTex"+i+", uv0).xyz;";return"\n\n            varying vec2 uv0;\n            "+(this.morph.intRenderFormat?"#define MORPH_INT":"")+"\n            "+(e>0?"uniform highp float morphFactor["+e+"];":"")+"\n            "+t+"\n\n            #ifdef MORPH_INT\n                uniform vec3 aabbSize;\n                uniform vec3 aabbMin;\n            #endif\n\n            void main (void) {\n                highp vec4 color = vec4(0, 0, 0, 1);\n\n                "+s+"\n\n                #ifdef MORPH_INT\n                    color.xyz = (color.xyz - aabbMin) / aabbSize * 65535.0;\n                    gl_FragColor = uvec4(color);\n                #else\n                    gl_FragColor = color;\n                #endif\n            }\n        "}_getShader(e){var t=this.shaderCache[e];if(!t){var s=this._getFragmentShader(e),i=this.morph.intRenderFormat?"uvec4":"vec4";t=Po(this.device,"\n\tattribute vec2 vertex_position;\n\tvarying vec2 uv0;\n\tvoid main(void) {\n\t\tgl_Position = vec4(vertex_position, 0.5, 1.0);\n\t\tuv0 = vertex_position.xy * 0.5 + 0.5;\n\t}\n\t",s,"textureMorph"+e,void 0,{fragmentOutputTypes:[i]}),this.shaderCache[e]=t}return t}_updateTextureRenderTarget(e,t,s){var i=this.device,n=(t,s)=>{this.morphFactor.setValue(this._shaderMorphWeights),i.setBlendState(s?Bc:Vi.NOBLEND);var n=this._getShader(t);Oo(i,e,n)};this.setAabbUniforms(s);for(var a=0,r=!1,o=this._activeTargets.length,l=0;l<o;l++){var h=this._activeTargets[l],c=h.target[t];c&&(this["morphBlendTex"+a].setValue(c),this._shaderMorphWeights[a]=h.weight,++a>=this.maxSubmitCount&&(n(a,r),a=0,r=!0))}(a>0||0===o&&!this.zeroTextures)&&n(a,r)}_updateTextureMorph(){(this._activeTargets.length>0||!this.zeroTextures)&&(this.rtPositions&&this._updateTextureRenderTarget(this.rtPositions,"texturePositions",!0),this.rtNormals&&this._updateTextureRenderTarget(this.rtNormals,"textureNormals",!1),this.zeroTextures=0===this._activeTargets.length)}setAabbUniforms(e){void 0===e&&(e=!0),this.aabbSizeId.setValue(e?this._aabbSize:this._aabbNrmSize),this.aabbMinId.setValue(e?this._aabbMin:this._aabbNrmMin)}prepareRendering(e){this.setAabbUniforms()}update(){this._dirty=!1;for(var e=this.morph._targets,t=0,s=0;s<e.length;s++){var i=Math.abs(this.getWeight(s));if(i>1e-5){this._activeTargets.length<=t&&(this._activeTargets[t]={});var n=this._activeTargets[t++];n.absWeight=i,n.weight=this.getWeight(s),n.target=e[s]}}this._activeTargets.length=t,this.morph.intRenderFormat&&this._activeTargets.length>this.maxSubmitCount&&(this._activeTargets.sort(((e,t)=>e.absWeight<t.absWeight?1:t.absWeight<e.absWeight?-1:0)),this._activeTargets.length=this.maxSubmitCount),this._updateTextureMorph()}constructor(e){this.shaderCache=[],this.morph=e,e.incRefCount(),this.device=e.device,this._weights=[],this._weightMap=new Map;for(var t=0;t<e._targets.length;t++){var s=e._targets[t];s.name&&this._weightMap.set(s.name,t),this.setWeight(t,s.defaultWeight)}this._activeTargets=[],this.maxSubmitCount=this.device.maxTextures,this._shaderMorphWeights=new Float32Array(this.maxSubmitCount);var i=(t,s)=>(this[s]=e._createTexture(t,e._renderTextureFormat),new ln({colorBuffer:this[s],depth:!1}));e.morphPositions&&(this.rtPositions=i("MorphRTPos","texturePositions")),e.morphNormals&&(this.rtNormals=i("MorphRTNrm","textureNormals")),this._textureParams=new Float32Array([e.morphTextureWidth,e.morphTextureHeight]);var n=e.aabb.halfExtents;this._aabbSize=new Float32Array([4*n.x,4*n.y,4*n.z]);var a=e.aabb.getMin();this._aabbMin=new Float32Array([2*a.x,2*a.y,2*a.z]),this._aabbNrmSize=new Float32Array([2,2,2]),this._aabbNrmMin=new Float32Array([-1,-1,-1]),this.aabbSizeId=this.device.scope.resolve("aabbSize"),this.aabbMinId=this.device.scope.resolve("aabbMin");for(var r=0;r<this.maxSubmitCount;r++)this["morphBlendTex"+r]=this.device.scope.resolve("morphBlendTex"+r);this.morphFactor=this.device.scope.resolve("morphFactor[0]"),this.zeroTextures=!1}}class zc{getGraph(){return this.graph}setGraph(e){this.graph=e}getCameras(){return this.cameras}setCameras(e){this.cameras=e}getLights(){return this.lights}setLights(e){this.lights=e}getMaterials(){for(var e=[],t=0;t<this.meshInstances.length;t++){var s=this.meshInstances[t];-1===e.indexOf(s.material)&&e.push(s.material)}return e}clone(){for(var e=[],t=[],s=function(i){var n=i.clone();e.push(i),t.push(n);for(var a=0;a<i._children.length;a++)n.addChild(s(i._children[a]));return n},i=s(this.graph),n=[],a=[],r=[],o=0;o<this.skinInstances.length;o++){for(var l=this.skinInstances[o].skin,h=new No(l),c=[],d=0;d<l.boneNames.length;d++){var u=l.boneNames[d],p=i.findByName(u);c.push(p)}h.bones=c,a.push(h)}for(var m=0;m<this.morphInstances.length;m++){var f=this.morphInstances[m].morph,g=new Oc(f);r.push(g)}for(var v=0;v<this.meshInstances.length;v++){var _=this.meshInstances[v],y=e.indexOf(_.node),x=new sl(_.mesh,_.material,t[y]);if(_.skinInstance){var w=this.skinInstances.indexOf(_.skinInstance);x.skinInstance=a[w]}if(_.morphInstance){var b=this.morphInstances.indexOf(_.morphInstance);x.morphInstance=r[b]}n.push(x)}var C=new zc;return C.graph=i,C.meshInstances=n,C.skinInstances=a,C.morphInstances=r,C.getGraph().syncHierarchy(),C}destroy(){for(var e=this.meshInstances,t=0;t<e.length;t++)e[t].destroy();this.meshInstances.length=0}generateWireframe(){sl._prepareRenderStyleForArray(this.meshInstances,1)}constructor(){this.graph=null,this.meshInstances=[],this.skinInstances=[],this.morphInstances=[],this.cameras=[],this.lights=[],this._shadersVersion=0,this._immutable=!1}}class Vc extends Dn{get aabb(){if(!this._aabb){for(var e=new yt,t=new yt,s=0;s<this._targets.length;s++){var i=this._targets[s].aabb;e.min(i.getMin()),t.max(i.getMax())}this._aabb=new Ft,this._aabb.setMinMax(e,t)}return this._aabb}get morphPositions(){return this._morphPositions}get morphNormals(){return this._morphNormals}_init(){this._initTextureBased();for(var e=0;e<this._targets.length;e++)this._targets[e]._postInit()}_findSparseSet(e,t,s){for(var i=1,n=e[0].length,a=0;a<n;a+=3){for(var r=!1,o=0;o<e.length;o++){var l=e[o];if(0!==l[a]||0!==l[a+1]||0!==l[a+2]){r=!0;break}}r?(t.push(i),s.push(a/3),i++):t.push(0)}return i}_initTextureBased(){for(var e=[],t=[],s=0;s<this._targets.length;s++){var i=this._targets[s];i.options.deltaPositions&&(e.push(i.options.deltaPositions),t.push({target:i,name:"texturePositions"})),i.options.deltaNormals&&(e.push(i.options.deltaNormals),t.push({target:i,name:"textureNormals"}))}var n=[],a=[],r=this._findSparseSet(e,n,a),o=this.device.maxTextureSize,l=Math.ceil(Math.sqrt(r));l=Math.min(l,o);var h=Math.ceil(r/l);if(h>o)return!1;this.morphTextureWidth=l,this.morphTextureHeight=h;var c=!1,d=3,u=_t.float2Half;this._textureFormat===Kt&&(c=!0,d=4);for(var p=[],m=0;m<e.length;m++)p.push(this._createTexture("MorphTarget",this._textureFormat));for(var f=0;f<e.length;f++){var g=e[f],v=p[f],_=v.lock();if(c)for(var y=0;y<a.length;y++){var x=3*a[y],w=y*d+d;_[w]=u(g[x]),_[w+1]=u(g[x+1]),_[w+2]=u(g[x+2])}else for(var b=0;b<a.length;b++){var C=3*a[b],S=b*d+d;_[S]=g[C],_[S+1]=g[C+1],_[S+2]=g[C+2]}v.unlock(),t[f].target._setTexture(t[f].name,v)}var A=[{semantic:Ls,components:1,type:5,asInt:!0}];return this.vertexBufferIds=new $i(this.device,new tn(this.device,A,n.length),n.length,{data:new Uint32Array(n)}),!0}destroy(){var e;null==(e=this.vertexBufferIds)||e.destroy(),this.vertexBufferIds=null;for(var t=0;t<this._targets.length;t++)this._targets[t].destroy();this._targets.length=0}get targets(){return this._targets}_updateMorphFlags(){this._morphPositions=!1,this._morphNormals=!1;for(var e=0;e<this._targets.length;e++){var t=this._targets[e];t.morphPositions&&(this._morphPositions=!0),t.morphNormals&&(this._morphNormals=!0)}}_createTexture(e,t){return new ki(this.device,{width:this.morphTextureWidth,height:this.morphTextureHeight,format:t,cubemap:!1,mipmaps:!1,minFilter:0,magFilter:0,addressU:1,addressV:1,name:e})}constructor(e,t,{preferHighPrecision:s=!1}={}){super(),this.device=t,this.preferHighPrecision=s,this._targets=e.slice();var i,n=this.device,a=n.textureHalfFloatRenderable?Kt:void 0,r=n.textureFloatRenderable?Zt:void 0;this._renderTextureFormat=this.preferHighPrecision?null!=r?r:a:null!=a?a:r,this._renderTextureFormat=null!=(i=this._renderTextureFormat)?i:47,this.intRenderFormat=ds(this._renderTextureFormat),this._textureFormat=this.preferHighPrecision?13:Kt,this._init(),this._updateMorphFlags()}}class Nc{destroy(){var e,t;null==(e=this.texturePositions)||e.destroy(),this.texturePositions=null,null==(t=this.textureNormals)||t.destroy(),this.textureNormals=null}get name(){return this._name}get defaultWeight(){return this._defaultWeight}get aabb(){return this._aabb||(this._aabb=new Ft,this.deltaPositions&&this._aabb.compute(this.deltaPositions)),this._aabb}get morphPositions(){return!!this.texturePositions}get morphNormals(){return!!this.textureNormals}clone(){return new Nc(this.options)}_postInit(){this.options.preserveData||(this.options=null),this.used=!0}_setTexture(e,t){this[e]=t}constructor(e){this.used=!1,this.options=e,this._name=e.name,this._defaultWeight=e.defaultWeight||0,this._aabb=e.aabb,this.deltaPositions=e.deltaPositions}}function Uc(){return Uc=Object.assign||function(e){for(var t=1;t<arguments.length;t++){var s=arguments[t];for(var i in s)Object.prototype.hasOwnProperty.call(s,i)&&(e[i]=s[i])}return e},Uc.apply(this,arguments)}var Hc=new class extends bo{generateKey(e){var t=e.shaderDesc,s=t.vertexCode?Ki(t.vertexCode):0,i=t.fragmentCode?Ki(t.fragmentCode):0,n=bo.definesHash(e.defines),a=t.uniqueName+"_"+s+"_"+i+"_"+n;return e.skin&&(a+="_skin"),e.useInstancing&&(a+="_inst"),e.useMorphPosition&&(a+="_morphp"),e.useMorphNormal&&(a+="_morphn"),e.useMorphTextureBasedInt&&(a+="_morphi"),a}createAttributesDefinition(e,t){var s=t.shaderDesc.attributes,i=s?Uc({},s):void 0;t.skin&&(i.vertex_boneWeights=vs,i.vertex_boneIndices=_s),(t.useMorphPosition||t.useMorphNormal)&&(i.morph_vertex_id=Ls),e.attributes=i}createVertexDefinition(e,t,s){var i=t.shaderDesc;if(e.shaderLanguage===Ys)e.vertexCode=i.vertexCode;else{var n=new Map(s),a=new Map(t.defines);n.set("transformInstancingVS",""),t.skin&&a.set("SKIN",!0),t.useInstancing&&a.set("INSTANCING",!0),(t.useMorphPosition||t.useMorphNormal)&&(a.set("MORPHING",!0),t.useMorphTextureBasedInt&&a.set("MORPHING_INT",!0),t.useMorphPosition&&a.set("MORPHING_POSITION",!0),t.useMorphNormal&&a.set("MORPHING_NORMAL",!0)),e.vertexCode=i.vertexCode,e.vertexIncludes=n,e.vertexDefines=a}}createFragmentDefinition(e,t,s){var i=t.shaderDesc;if(e.shaderLanguage===Ys)e.fragmentCode=i.fragmentCode;else{var n=new Map(s),a=new Map(t.defines);e.fragmentCode=i.fragmentCode,e.fragmentIncludes=n,e.fragmentDefines=a}}createShaderDefinition(e,t){var s=t.shaderDesc,i={name:"ShaderMaterial-"+s.uniqueName,shaderLanguage:s.shaderLanguage,fragmentOutputTypes:s.fragmentOutputTypes,meshUniformBufferFormat:s.meshUniformBufferFormat,meshBindGroupFormat:s.meshBindGroupFormat},n=new Map(Object.entries(Uc({},yo,t.chunks)));return this.createAttributesDefinition(i,t),this.createVertexDefinition(i,t,n),this.createFragmentDefinition(i,t,n),Na.createDefinition(e,i)}};function Gc(){return Gc=Object.assign||function(e){for(var t=1;t<arguments.length;t++){var s=arguments[t];for(var i in s)Object.prototype.hasOwnProperty.call(s,i)&&(e[i]=s[i])}return e},Gc.apply(this,arguments)}class Wc extends mh{set shaderDesc(e){this._shaderDesc=e?Gc({},e):void 0,this.clearVariants()}get shaderDesc(){return this._shaderDesc}copy(e){return super.copy(e),this.shaderDesc=e.shaderDesc,this}getShaderVariant(e){var t,{objDefs:s}=e,i={defines:ko(this,e),skin:!!(2&s),useInstancing:!!(32&s),useMorphPosition:!!(s&ro),useMorphNormal:!!(s&oo),useMorphTextureBasedInt:!!(s&lo),pass:e.pass,gamma:e.cameraShaderParams.shaderOutputGamma,toneMapping:e.cameraShaderParams.toneMapping,fog:e.cameraShaderParams.fog,shaderDesc:this.shaderDesc,chunks:null!=(t=this.chunks)?t:{}},n=new go(e.viewUniformFormat,e.viewBindGroupFormat,e.vertexFormat),a=wo(e.device);return a.register("shader-material",Hc),a.getProgram("shader-material",i,n,this.userId)}constructor(e){super(),this.shaderDesc=e}}var jc={linear:"decodeLinear",srgb:"decodeGamma",rgbm:"decodeRGBM",rgbe:"decodeRGBE",rgbp:"decodeRGBP"},qc={linear:"encodeLinear",srgb:"encodeGamma",rgbm:"encodeRGBM",rgbe:"encodeRGBE",rgbp:"encodeRGBP"};class Xc{static decodeFunc(e){return jc[e]||"decodeGamma"}static encodeFunc(e){return qc[e]||"encodeGamma"}static getScreenDepthChunk(e,t){return"\n            "+(t.sceneDepthMapLinear?"#define SCENE_DEPTHMAP_LINEAR":"")+"\n            "+(e.textureFloatRenderable?"#define SCENE_DEPTHMAP_FLOAT":"")+"\n            "+yo.screenDepthPS+"\n        "}}var Yc=(e,t)=>{for(var s=t.length/3,i=e.length/3,n=new yt,a=new yt,r=new yt,o=new yt,l=new yt,h=new yt,c=[],d=0;d<e.length;d++)c[d]=0;for(var u=0;u<s;u++){var p=t[3*u],m=t[3*u+1],f=t[3*u+2];n.set(e[3*p],e[3*p+1],e[3*p+2]),a.set(e[3*m],e[3*m+1],e[3*m+2]),r.set(e[3*f],e[3*f+1],e[3*f+2]),o.sub2(a,n),l.sub2(r,n),h.cross(o,l).normalize(),c[3*p]+=h.x,c[3*p+1]+=h.y,c[3*p+2]+=h.z,c[3*m]+=h.x,c[3*m+1]+=h.y,c[3*m+2]+=h.z,c[3*f]+=h.x,c[3*f+1]+=h.y,c[3*f+2]+=h.z}for(var g=0;g<i;g++){var v=c[3*g],_=c[3*g+1],y=c[3*g+2],x=1/Math.sqrt(v*v+_*_+y*y);c[3*g]*=x,c[3*g+1]*=x,c[3*g+2]*=x}return c},$c=(e,t,s,i)=>{for(var n=i.length/3,a=e.length/3,r=new yt,o=new yt,l=new yt,h=new wt,c=new wt,d=new wt,u=new yt,p=new yt,m=new Float32Array(3*a),f=new Float32Array(3*a),g=[],v=0;v<n;v++){var _=i[3*v],y=i[3*v+1],x=i[3*v+2];r.set(e[3*_],e[3*_+1],e[3*_+2]),o.set(e[3*y],e[3*y+1],e[3*y+2]),l.set(e[3*x],e[3*x+1],e[3*x+2]),h.set(s[2*_],s[2*_+1]),c.set(s[2*y],s[2*y+1]),d.set(s[2*x],s[2*x+1]);var w=o.x-r.x,b=l.x-r.x,C=o.y-r.y,S=l.y-r.y,A=o.z-r.z,T=l.z-r.z,P=c.x-h.x,E=d.x-h.x,k=c.y-h.y,M=d.y-h.y,I=P*M-E*k;if(0===I)u.set(0,1,0),p.set(1,0,0);else{var D=1/I;u.set((M*w-k*b)*D,(M*C-k*S)*D,(M*A-k*T)*D),p.set((P*b-E*w)*D,(P*S-E*C)*D,(P*T-E*A)*D)}m[3*_+0]+=u.x,m[3*_+1]+=u.y,m[3*_+2]+=u.z,m[3*y+0]+=u.x,m[3*y+1]+=u.y,m[3*y+2]+=u.z,m[3*x+0]+=u.x,m[3*x+1]+=u.y,m[3*x+2]+=u.z,f[3*_+0]+=p.x,f[3*_+1]+=p.y,f[3*_+2]+=p.z,f[3*y+0]+=p.x,f[3*y+1]+=p.y,f[3*y+2]+=p.z,f[3*x+0]+=p.x,f[3*x+1]+=p.y,f[3*x+2]+=p.z}for(var R=new yt,L=new yt,F=new yt,B=new yt,O=0;O<a;O++){F.set(t[3*O],t[3*O+1],t[3*O+2]),R.set(m[3*O],m[3*O+1],m[3*O+2]),L.set(f[3*O],f[3*O+1],f[3*O+2]);var z=F.dot(R);B.copy(F).mulScalar(z),B.sub2(R,B).normalize(),g[4*O]=B.x,g[4*O+1]=B.y,g[4*O+2]=B.z,B.cross(F,R),g[4*O+3]=B.dot(L)<0?-1:1}return g};class Kc{calculateNormals(){this.normals=Yc(this.positions,this.indices)}calculateTangents(){this.tangents=$c(this.positions,this.normals,this.uvs,this.indices)}}var Zc=4/64;class Jc extends Kc{constructor(e={}){var t;super();var s,i,n,a,r=null!=(t=e.halfExtents)?t:new yt(.5,.5,.5),o=null!=(s=e.widthSegments)?s:1,l=null!=(i=e.lengthSegments)?i:1,h=null!=(n=e.heightSegments)?n:1,c=null!=(a=e.yOffset)?a:0,d=-r.y+c,u=r.y+c,p=[new yt(-r.x,d,r.z),new yt(r.x,d,r.z),new yt(r.x,u,r.z),new yt(-r.x,u,r.z),new yt(r.x,d,-r.z),new yt(-r.x,d,-r.z),new yt(-r.x,u,-r.z),new yt(r.x,u,-r.z)],m=[[0,1,3],[4,5,7],[3,2,6],[1,0,4],[1,4,2],[5,0,6]],f=[[0,0,1],[0,0,-1],[0,1,0],[0,-1,0],[1,0,0],[-1,0,0]],g=1,v=2,_=3,y=4,x=5,w=[],b=[],C=[],S=[],A=0,T=(e,t,s)=>{for(var i=new yt,n=new yt,a=new yt,r=new yt,o=0;o<=t;o++)for(var l=0;l<=s;l++){i.lerp(p[m[e][0]],p[m[e][1]],o/t),n.lerp(p[m[e][0]],p[m[e][2]],l/s),a.sub2(n,p[m[e][0]]),r.add2(i,a);var h=o/t,c=l/s;w.push(r.x,r.y,r.z),b.push(f[e][0],f[e][1],f[e][2]),C.push(h,1-c),h=.875*h+Zc,c=.875*c+Zc,h/=3,c/=3,h+=e%3/3,c+=Math.floor(e/3)/3,o<t&&l<s&&(S.push(A+s+1,A+1,A),S.push(A+s+1,A+s+2,A+1)),A++}};T(0,o,h),T(g,o,h),T(v,o,l),T(_,o,l),T(y,l,h),T(x,l,h),this.positions=w,this.normals=b,this.uvs=C,this.uvs1=C,this.indices=S,e.calculateTangents&&(this.tangents=$c(w,b,C,S))}}class Qc extends Kc{constructor(e={}){var t;super();for(var s,i,n=null!=(t=e.radius)?t:.5,a=null!=(s=e.latitudeBands)?s:16,r=null!=(i=e.longitudeBands)?i:16,o=[],l=[],h=[],c=[],d=0;d<=a;d++)for(var u=d*Math.PI/a,p=Math.sin(u),m=Math.cos(u),f=0;f<=r;f++){var g=2*f*Math.PI/r-Math.PI/2,v=Math.sin(g),_=Math.cos(g)*p,y=m,x=v*p,w=1-f/r,b=1-d/a;o.push(_*n,y*n,x*n),l.push(_,y,x),h.push(w,1-b)}for(var C=0;C<a;++C)for(var S=0;S<r;++S){var A=C*(r+1)+S,T=A+r+1;c.push(A+1,T,A),c.push(A+1,T+1,T)}this.positions=o,this.normals=l,this.uvs=h,this.uvs1=h,this.indices=c,e.calculateTangents&&(this.tangents=$c(o,l,h,c))}}class ed extends Qc{constructor(e={}){var t,s,i=.5;super({radius:i,latitudeBands:null!=(t=e.latitudeBands)?t:16,longitudeBands:null!=(s=e.longitudeBands)?s:16});for(var n=this.positions,a=0;a<n.length;a+=3){var r=n[a]/i,o=n[a+1]/i,l=n[a+2]/i;o<0&&(o*=.3,r*r+l*l<.9025&&(o=-.1)),o+=.1,o*=i,n[a+1]=o}}}class td{static create(e,t){switch(t){case"box":return td.box(e);case"dome":return td.dome(e)}return td.infinite(e)}static infinite(e){return Wo.fromGeometry(e,new Jc(e))}static box(e){return Wo.fromGeometry(e,new Jc({yOffset:.5}))}static dome(e){var t=new ed({latitudeBands:50,longitudeBands:50});return t.normals=void 0,t.uvs=void 0,Wo.fromGeometry(e,t)}}class sd{destroy(){this.meshInstance&&(this.skyLayer&&this.skyLayer.removeMeshInstances([this.meshInstance]),this.meshInstance.destroy(),this.meshInstance=null)}constructor(e,t,s,i,n){this.meshInstance=null;var a=new Wc({uniqueName:"SkyMaterial",vertexCode:yo.skyboxVS,fragmentCode:yo.skyboxPS,attributes:{aPosition:ms}});a.setDefine("__INJECT_SKYBOX_DECODE_FNC",Xc.decodeFunc(i.encoding)),n!==co&&a.setDefine("SKYMESH",""),i.cubemap&&a.setDefine("SKY_CUBEMAP",""),a.setParameter("skyboxHighlightMultiplier",t.skyboxHighlightMultiplier),i.cubemap?a.setParameter("texture_cubeMap",i):(a.setParameter("texture_envAtlas",i),a.setParameter("mipLevel",t.skyboxMip)),a.cull=2,a.depthWrite=!1;var r=t.layers.getLayerById(2);if(r){var o=td.create(e,n),l=new sl(o,a,s);this.meshInstance=l,l.cull=!1,l.pick=!1,r.addMeshInstances([l]),this.skyLayer=r}}}class id{applySettings(e){var t,s,i,n;this.type=null!=(t=e.skyType)?t:co,this.node.setLocalPosition(new yt(null!=(s=e.skyMeshPosition)?s:[0,0,0])),this.node.setLocalEulerAngles(new yt(null!=(i=e.skyMeshRotation)?i:[0,0,0])),this.node.setLocalScale(new yt(null!=(n=e.skyMeshScale)?n:[1,1,1])),e.skyCenter&&(this._center=new yt(e.skyCenter))}set type(e){this._type!==e&&(this._type=e,this.scene.updateShaders=!0,this.updateSkyMesh())}get type(){return this._type}set center(e){this._center.copy(e)}get center(){return this._center}updateSkyMesh(){var e=this.scene._getSkyboxTex();e&&(this.resetSkyMesh(),this.skyMesh=new sd(this.device,this.scene,this.node,e,this.type),this.scene.fire("set:skybox",e))}resetSkyMesh(){var e;null==(e=this.skyMesh)||e.destroy(),this.skyMesh=null}update(){if(this.type!==co){var{center:e,centerArray:t}=this,s=new yt;this.node.getWorldTransform().transformPoint(e,s),t[0]=s.x,t[1]=s.y,t[2]=s.z,this.projectedSkydomeCenterId.setValue(t)}}constructor(e){this._type=co,this._center=new yt(0,1,0),this.skyMesh=null,this.node=new Il("SkyMeshNode"),this.device=e.device,this.scene=e,this.center=new yt(0,1,0),this.centerArray=new Float32Array(3),this.projectedSkydomeCenterId=this.device.scope.resolve("projectedSkydomeCenter")}}var nd=new Il;nd.worldTransform=Et.IDENTITY,nd._dirtyWorld=nd._dirtyNormal=!1;class ad{addLines(e,t){for(var s=this.positions,i=e.length,n=0;n<i;n++){var a=e[n];s.push(a.x,a.y,a.z)}var r=this.colors;if(t.length)for(var o=0;o<i;o++){var l=t[o];r.push(l.r,l.g,l.b,l.a)}else for(var h=0;h<i;h++)r.push(t.r,t.g,t.b,t.a)}addLinesArrays(e,t){for(var s=this.positions,i=0;i<e.length;i+=3)s.push(e[i],e[i+1],e[i+2]);var n=this.colors;if(t.length)for(var a=0;a<t.length;a+=4)n.push(t[a],t[a+1],t[a+2],t[a+3]);else for(var r=e.length/3,o=0;o<r;o++)n.push(t.r,t.g,t.b,t.a)}onPreRender(e,t){this.positions.length>0&&this.material.transparent===t&&(this.mesh.setPositions(this.positions),this.mesh.setColors(this.colors),this.mesh.update(1,!1),this.meshInstance||(this.meshInstance=new sl(this.mesh,this.material,nd)),e.push(this.meshInstance))}clear(){this.positions.length=0,this.colors.length=0}constructor(e,t,s){this.material=t,this.layer=s,this.positions=[],this.colors=[],this.mesh=new Wo(e),this.meshInstance=null}}class rd{getBatch(e,t){var s=this.map.get(e);return s||(s=new ad(this.device,e,t),this.map.set(e,s)),s}onPreRender(e,t){this.map.forEach((s=>{s.onPreRender(e,t)}))}clear(){this.map.forEach((e=>e.clear()))}constructor(e){this.device=e,this.map=new Map}}var od=[],ld=new yt,hd={uniqueName:"ImmediateLine",vertexCode:"\n\t\tattribute vec3 vertex_position;\n\t\tattribute vec4 vertex_color;\n\t\tuniform mat4 matrix_model;\n\t\tuniform mat4 matrix_viewProjection;\n\t\tvarying vec4 color;\n\t\tvoid main(void) {\n\t\t\tcolor = vertex_color;\n\t\t\tgl_Position = matrix_viewProjection * matrix_model * vec4(vertex_position, 1);\n\t\t}\n\t",fragmentCode:'\n\t\t#include "gammaPS"\n\t\tvarying vec4 color;\n\t\tvoid main(void) {\n\t\t\tgl_FragColor = vec4(gammaCorrectOutput(decodeGamma(color.rgb)), color.a);\n\t\t}\n\t',attributes:{vertex_position:ms,vertex_color:ys}};class cd{createMaterial(e){var t=new Wc(hd);return t.blendType=2,t.depthTest=e,t.update(),t}get materialDepth(){return this._materialDepth||(this._materialDepth=this.createMaterial(!0)),this._materialDepth}get materialNoDepth(){return this._materialNoDepth||(this._materialNoDepth=this.createMaterial(!1)),this._materialNoDepth}getBatch(e,t){var s=this.batchesMap.get(e);s||(s=new rd(this.device),this.batchesMap.set(e,s)),this.allBatches.add(s);var i=t?this.materialDepth:this.materialNoDepth;return s.getBatch(i,e)}getShaderDesc(e,t){if(!this.shaderDescs.has(e)){this.shaderDescs.set(e,{uniqueName:"DebugShader:"+e,vertexCode:"\n\t\t\t\tattribute vec2 vertex_position;\n\t\t\t\tuniform mat4 matrix_model;\n\t\t\t\tvarying vec2 uv0;\n\t\t\t\tvoid main(void) {\n\t\t\t\t\tgl_Position = matrix_model * vec4(vertex_position, 0, 1);\n\t\t\t\t\tuv0 = vertex_position.xy + 0.5;\n\t\t\t\t}\n\t\t\t",fragmentCode:t,attributes:{vertex_position:ms}})}return this.shaderDescs.get(e)}getTextureShaderDesc(e){var t=Xc.decodeFunc(e);return this.getShaderDesc("textureShader-"+e,'\n\t\t\t#include "gammaPS"\n\t\t\tvarying vec2 uv0;\n\t\t\tuniform sampler2D colorMap;\n\t\t\tvoid main (void) {\n\t\t\t\tvec3 linearColor = '+t+"(texture2D(colorMap, uv0));\n\t\t\t\tgl_FragColor = vec4(gammaCorrectOutput(linearColor), 1);\n\t\t\t}\n\t\t")}getUnfilterableTextureShaderDesc(){return this.getShaderDesc("textureShaderUnfilterable","\n\t\t\tvarying vec2 uv0;\n\t\t\tuniform highp sampler2D colorMap;\n\t\t\tvoid main (void) {\n\t\t\t\tivec2 uv = ivec2(uv0 * textureSize(colorMap, 0));\n\t\t\t\tgl_FragColor = vec4(texelFetch(colorMap, uv, 0).xyz, 1);\n\t\t\t}\n\t\t")}getDepthTextureShaderDesc(){return this.getShaderDesc("depthTextureShader","\n\t\t\t"+yo.screenDepthPS+'\n\t\t\t#include "gammaPS"\n\t\t\tvarying vec2 uv0;\n\t\t\tvoid main() {\n\t\t\t\tfloat depth = getLinearScreenDepth(getImageEffectUV(uv0)) * camera_params.x;\n\t\t\t\tgl_FragColor = vec4(gammaCorrectOutput(vec3(depth)), 1.0);\n\t\t\t}\n\t\t')}getQuadMesh(){return this.quadMesh||(this.quadMesh=new Wo(this.device),this.quadMesh.setPositions([-.5,-.5,0,.5,-.5,0,-.5,.5,0,.5,.5,0]),this.quadMesh.update(5)),this.quadMesh}drawMesh(e,t,s,i,n){if(!i){var a=this.getGraphNode(t);i=new sl(s,e,a)}var r=this.layerMeshInstances.get(n);r||(r=[],this.layerMeshInstances.set(n,r)),r.push(i)}drawWireAlignedBox(e,t,s,i,n,a){if(a){var r=(e,t,s)=>{ld.set(e,t,s),a.transformPoint(ld,ld),od.push(ld.x,ld.y,ld.z)};r(e.x,e.y,e.z),r(e.x,t.y,e.z),r(e.x,t.y,e.z),r(t.x,t.y,e.z),r(t.x,t.y,e.z),r(t.x,e.y,e.z),r(t.x,e.y,e.z),r(e.x,e.y,e.z),r(e.x,e.y,t.z),r(e.x,t.y,t.z),r(e.x,t.y,t.z),r(t.x,t.y,t.z),r(t.x,t.y,t.z),r(t.x,e.y,t.z),r(t.x,e.y,t.z),r(e.x,e.y,t.z),r(e.x,e.y,e.z),r(e.x,e.y,t.z),r(e.x,t.y,e.z),r(e.x,t.y,t.z),r(t.x,t.y,e.z),r(t.x,t.y,t.z),r(t.x,e.y,e.z),r(t.x,e.y,t.z)}else od.push(e.x,e.y,e.z,e.x,t.y,e.z,e.x,t.y,e.z,t.x,t.y,e.z,t.x,t.y,e.z,t.x,e.y,e.z,t.x,e.y,e.z,e.x,e.y,e.z,e.x,e.y,t.z,e.x,t.y,t.z,e.x,t.y,t.z,t.x,t.y,t.z,t.x,t.y,t.z,t.x,e.y,t.z,t.x,e.y,t.z,e.x,e.y,t.z,e.x,e.y,e.z,e.x,e.y,t.z,e.x,t.y,e.z,e.x,t.y,t.z,t.x,t.y,e.z,t.x,t.y,t.z,t.x,e.y,e.z,t.x,e.y,t.z);this.getBatch(n,i).addLinesArrays(od,s),od.length=0}drawWireSphere(e,t,s,i,n,a){for(var r=2*Math.PI/i,o=0,l=0;l<i;l++){var h=Math.sin(o),c=Math.cos(o);o+=r;var d=Math.sin(o),u=Math.cos(o);od.push(e.x+t*h,e.y,e.z+t*c),od.push(e.x+t*d,e.y,e.z+t*u),od.push(e.x+t*h,e.y+t*c,e.z),od.push(e.x+t*d,e.y+t*u,e.z),od.push(e.x,e.y+t*h,e.z+t*c),od.push(e.x,e.y+t*d,e.z+t*u)}this.getBatch(a,n).addLinesArrays(od,s),od.length=0}getGraphNode(e){var t=new Il("ImmediateDebug");return t.worldTransform=e,t._dirtyWorld=t._dirtyNormal=!1,t}onPreRenderLayer(e,t,s){if(this.batchesMap.forEach(((i,n)=>{n===e&&i.onPreRender(t,s)})),!this.updatedLayers.has(e)){this.updatedLayers.add(e);var i=this.layerMeshInstances.get(e);if(i){for(var n=0;n<i.length;n++)t.push(i[n]);i.length=0}}}onPostRender(){this.allBatches.forEach((e=>e.clear())),this.allBatches.clear(),this.updatedLayers.clear()}constructor(e){this.shaderDescs=new Map,this.device=e,this.quadMesh=null,this.textureShader=null,this.depthTextureShader=null,this.cubeLocalPos=null,this.cubeWorldPos=null,this.batchesMap=new Map,this.allBatches=new Set,this.updatedLayers=new Set,this._materialDepth=null,this._materialNoDepth=null,this.layerMeshInstances=new Map}}var dd=2.399963229728653,ud={circlePoint(e){var t=Math.sqrt(Math.random()),s=2*Math.random()*Math.PI;e.x=t*Math.cos(s),e.y=t*Math.sin(s)},circlePointDeterministic(e,t,s){var i=t*dd,n=Math.sqrt(t)/Math.sqrt(s);e.x=n*Math.cos(i),e.y=n*Math.sin(i)},spherePointDeterministic(e,t,s,i,n){void 0===i&&(i=0),void 0===n&&(n=1),i=1-2*i,n=1-2*n;var a=pt.lerp(i,n,t/s),r=Math.sqrt(1-a*a),o=dd*t;e.x=Math.cos(o)*r,e.y=a,e.z=Math.sin(o)*r},radicalInverse(e){var t=(e<<16|e>>>16)>>>0;return 2.3283064365386963e-10*(t=((16711935&(t=((252645135&(t=((858993459&(t=((1431655765&t)<<1|(2863311530&t)>>>1)>>>0))<<2|(3435973836&t)>>>2)>>>0))<<4|(4042322160&t)>>>4)>>>0))<<8|(4278255360&t)>>>8)>>>0)}},pd=e=>{switch(e){case js:return"Cubemap";case"octahedral":return"Octahedral";default:return"Equirect"}},md=(e,t,s)=>{if(e<=0)t[s+0]=0,t[s+1]=0,t[s+2]=0,t[s+3]=0;else if(e>=1)t[s+0]=255,t[s+1]=0,t[s+2]=0,t[s+3]=0;else{var i=1*e%1,n=255*e%1,a=65025*e%1,r=16581375*e%1;i-=n/255,n-=a/255,a-=r/255,t[s+0]=Math.min(255,Math.floor(256*i)),t[s+1]=Math.min(255,Math.floor(256*n)),t[s+2]=Math.min(255,Math.floor(256*a)),t[s+3]=Math.min(255,Math.floor(256*r))}},fd=(e,t,s,i)=>{var n=2*s*Math.PI,a=Math.pow(1-t,1/(i+1)),r=Math.sqrt(1-a*a);e.set(Math.cos(n)*r,Math.sin(n)*r,a).normalize()},gd=(e,t,s)=>{var i=2*s*Math.PI,n=Math.sqrt(1-t),a=Math.sqrt(t);e.set(Math.cos(i)*a,Math.sin(i)*a,n).normalize()},vd=(e,t,s,i)=>{var n=2*s*Math.PI,a=Math.sqrt((1-t)/(1+(i*i-1)*t)),r=Math.sqrt(1-a*a);e.set(Math.cos(n)*r,Math.sin(n)*r,a).normalize()},_d=(e,t)=>{var s=e*t,i=t/(1-e*e+s*s);return i*i*(1/Math.PI)},yd={16:{2:26,8:20,32:17,128:16,512:16},32:{2:53,8:40,32:34,128:32,512:32},128:{2:214,8:163,32:139,128:130,512:128},1024:{2:1722,8:1310,32:1114,128:1041,512:1025}},xd=(e,t,s)=>{for(var i=s/e,n=1-Math.log2(t)/11,a=n*n,r=new yt,o=new yt,l=new yt(0,0,1),h=[],c=((e,t)=>{var s=yd[e];return s&&s[t]||e})(e,t),d=0;d<c;++d){vd(r,d/c,ud.radicalInverse(d),a);var u=r.z;if(o.set(r.x,r.y,r.z).mulScalar(2*u).sub(l),o.z>0){var p=_d(Math.min(1,u),a)/4+.001,m=.5*Math.log2(i/p);h.push(o.x,o.y,o.z,m)}}for(;h.length<4*e;)h.push(0,0,0,0);return h},wd=(e,t,s)=>{var i=(e=>{for(var t=e.length,s=Math.min(t,512),i=Math.ceil(t/s),n=new Uint8Array(s*i*4),a=0,r=0;r<t;r+=4)md(.5*e[r+0]+.5,n,a+0),md(.5*e[r+1]+.5,n,a+4),md(.5*e[r+2]+.5,n,a+8),md(e[r+3]/8,n,a+12),a+=16;return{width:s,height:i,data:n}})(s);return new ki(e,{name:t,width:i.width,height:i.height,mipmaps:!1,minFilter:0,magFilter:0,levels:[i.data]})};class bd{destroy(){this.destroyContent&&this.map.forEach(((e,t)=>{e.destroy()}))}get(e,t){if(!this.map.has(e)){var s=t();return this.map.set(e,s),s}return this.map.get(e)}constructor(e=!0){this.map=new Map,this.destroyContent=e}}var Cd=new bd(!1),Sd=new Ti,Ad=(e,t,s)=>Sd.get(e,(()=>new bd)).get(t,(()=>wd(e,t,Cd.get(t,s)))),Td=(e,t,s)=>Ad(e,"lambert-samples-"+t+"-"+s,(()=>((e,t)=>{for(var s=t/e,i=new yt,n=[],a=0;a<e;++a){gd(i,a/e,ud.radicalInverse(a));var r=i.z/Math.PI,o=.5*Math.log2(s/r);n.push(i.x,i.y,i.z,o)}return n})(t,s))),Pd=(e,t,s)=>Ad(e,"phong-samples-"+t+"-"+s,(()=>((e,t)=>{for(var s=new yt,i=[],n=0;n<e;++n)fd(s,n/e,ud.radicalInverse(n),t),i.push(s.x,s.y,s.z,0);return i})(t,s)));function Ed(e,t,s){var i,n,a;void 0===s&&(s={});var r,o,l=null!=(a=s.seamPixels)?a:0,h=(null!=(r=null==(i=s.rect)?void 0:i.z)?r:t.width)-2*l,c=(null!=(o=null==(n=s.rect)?void 0:n.w)?o:t.height)-2*l;if(h<1||c<1)return!1;var d=s.hasOwnProperty("specularPower")?s.specularPower:1,u=s.hasOwnProperty("face")?s.face:null,p=s.hasOwnProperty("distribution")?s.distribution:1===d?"none":"phong",m={none:"reproject",lambert:"prefilterSamplesUnweighted",phong:"prefilterSamplesUnweighted",ggx:"prefilterSamples"}[p]||"reproject",f=m.startsWith("prefilterSamples"),g=Xc.decodeFunc(e.encoding),v=Xc.encodeFunc(t.encoding),_="sample"+pd(e.projection),y="getDirection"+pd(t.projection),x=s.hasOwnProperty("numSamples")?s.numSamples:1024,w=m+"_"+g+"_"+v+"_"+_+"_"+y+"_"+x,b=e.device,C=wo(b).getCachedShader(w);C||(C=Po(b,"\nattribute vec2 vertex_position;\n\nuniform vec4 uvMod;\n\nvarying vec2 vUv0;\n\nvoid main(void) {\n    gl_Position = vec4(vertex_position, 0.5, 1.0);\n    vUv0 = getImageEffectUV((vertex_position.xy * 0.5 + 0.5) * uvMod.xy + uvMod.zw);\n}\n","#define PROCESS_FUNC "+m+"\n"+(f?"#define USE_SAMPLES_TEX\n":"")+(e.cubemap?"#define CUBEMAP_SOURCE\n":"")+"#define DECODE_FUNC "+g+"\n#define ENCODE_FUNC "+v+"\n#define SOURCE_FUNC "+_+"\n#define TARGET_FUNC "+y+"\n#define NUM_SAMPLES "+x+"\n#define NUM_SAMPLES_SQRT "+Math.round(Math.sqrt(x)).toFixed(1)+"\n"+"\n"+yo.reprojectPS,w));b.setBlendState(Vi.NOBLEND),b.scope.resolve(e.cubemap?"sourceCube":"sourceTex").setValue(e);var S=b.scope.resolve("params"),A=b.scope.resolve("uvMod");l>0?A.setValue([(h+2*l)/h,(c+2*l)/c,-l/h,-l/c]):A.setValue([1,1,0,0]);var T=[0,t.width*t.height*(t.cubemap?6:1),e.width*e.height*(e.cubemap?6:1)];if(f){var P=e.width*e.height*(e.cubemap?6:1),E="ggx"===p?((e,t,s,i)=>Ad(e,"ggx-samples-"+t+"-"+s+"-"+i,(()=>xd(t,s,i))))(b,x,d,P):"lambert"===p?Td(b,x,P):Pd(b,x,d);b.scope.resolve("samplesTex").setValue(E),b.scope.resolve("samplesTexInverseSize").setValue([1/E.width,1/E.height])}for(var k=0;k<(t.cubemap?6:1);k++)if(null===u||k===u){var M=new ln({colorBuffer:t,face:k,depth:!1,flipY:b.isWebGPU});T[0]=k,S.setValue(T),Oo(b,M,C,null==s?void 0:s.rect),M.destroy()}return!0}var kd=(e,t)=>(void 0===t&&(t=0),1+Math.floor(Math.log2(Math.max(e,t))));class Md{static generateSkyboxCubemap(e,t){var s=((e,t,s)=>new ki(e,{name:"lighting-"+t,cubemap:!0,width:t,height:t,format:s,type:zs,addressU:1,addressV:1,mipmaps:!1}))(e.device,t||(e.cubemap?e.width:e.width/4),7);return Ed(e,s,{numSamples:1024}),s}static generateLightingSource(e,t){var s=e.device,i=(e=>(e=>e.textureHalfFloatRenderable)(e)?Kt:(e=>e.textureFloatRenderable)(e)?Zt:7)(s),n=(null==t?void 0:t.target)||new ki(s,{name:"lighting-source",cubemap:!0,width:(null==t?void 0:t.size)||128,height:(null==t?void 0:t.size)||128,format:i,type:7===i?zs:Fs,addressU:1,addressV:1,mipmaps:!0});return Ed(e,n,{numSamples:e.mipmaps?1:1024}),n}static generateAtlas(e,t){for(var s=e.device,i=(null==t?void 0:t.target)||new ki(s,{name:"envAtlas",width:(null==t?void 0:t.size)||512,height:(null==t?void 0:t.size)||512,format:7,type:zs,projection:qs,addressU:1,addressV:1,mipmaps:!1}),n=i.width/512,a=new bt(0,0,512*n,256*n),r=kd(256)-kd(4),o=0;o<r;++o)Ed(e,i,{numSamples:1,rect:a,seamPixels:n}),a.x+=a.w,a.y+=a.w,a.z=Math.max(1,Math.floor(.5*a.z)),a.w=Math.max(1,Math.floor(.5*a.w));a.set(0,256*n,256*n,128*n);for(var l=1;l<7;++l)Ed(e,i,{numSamples:(null==t?void 0:t.numReflectionSamples)||1024,distribution:(null==t?void 0:t.distribution)||"ggx",specularPower:Math.max(1,2048>>2*l),rect:a,seamPixels:n}),a.y+=a.w,a.z=Math.max(1,Math.floor(.5*a.z)),a.w=Math.max(1,Math.floor(.5*a.w));return a.set(128*n,384*n,64*n,32*n),Ed(e,i,{numSamples:(null==t?void 0:t.numAmbientSamples)||2048,distribution:"lambert",rect:a,seamPixels:n}),i}static generatePrefilteredAtlas(e,t){for(var s=e[0].device,i=e[0].format,n=e[0].type,a=(null==t?void 0:t.target)||new ki(s,{name:"envPrefilteredAtlas",width:(null==t?void 0:t.size)||512,height:(null==t?void 0:t.size)||512,format:i,type:n,projection:qs,addressU:1,addressV:1,mipmaps:!1}),r=a.width/512,o=new bt(0,0,512*r,256*r),l=kd(512),h=0;h<l;++h)Ed(e[0],a,{numSamples:1,rect:o,seamPixels:r}),o.x+=o.w,o.y+=o.w,o.z=Math.max(1,Math.floor(.5*o.z)),o.w=Math.max(1,Math.floor(.5*o.w));o.set(0,256*r,256*r,128*r);for(var c=1;c<e.length;++c)Ed(e[c],a,{numSamples:1,rect:o,seamPixels:r}),o.y+=o.w,o.z=Math.max(1,Math.floor(.5*o.z)),o.w=Math.max(1,Math.floor(.5*o.w));return o.set(128*r,384*r,64*r,32*r),(null==t?void 0:t.legacyAmbient)?Ed(e[5],a,{numSamples:1,rect:o,seamPixels:r}):Ed(e[0],a,{numSamples:(null==t?void 0:t.numSamples)||2048,distribution:"lambert",rect:o,seamPixels:r}),a}}class Id{constructor(){this.type=eo,this.color=new mt(0,0,0),this.density=0,this.start=1,this.end=1e3}}let Dd=class extends tt{get defaultDrawLayer(){return this.layers.getLayerById(3)}set ambientBakeNumSamples(e){this._ambientBakeNumSamples=pt.clamp(Math.floor(e),1,255)}get ambientBakeNumSamples(){return this._ambientBakeNumSamples}set ambientBakeSpherePart(e){this._ambientBakeSpherePart=pt.clamp(e,.001,1)}get ambientBakeSpherePart(){return this._ambientBakeSpherePart}set clusteredLightingEnabled(e){this.device.isWebGPU&&!e||(this._clusteredLightingEnabled||!e?this._clusteredLightingEnabled=e:console.error("Turning on disabled clustered lighting is not currently supported"))}get clusteredLightingEnabled(){return this._clusteredLightingEnabled}set envAtlas(e){e!==this._envAtlas&&(this._envAtlas=e,e&&(e.addressU=1,e.addressV=1,e.minFilter=1,e.magFilter=1,e.mipmaps=!1),this._prefilteredCubemaps=[],this._internalEnvAtlas&&(this._internalEnvAtlas.destroy(),this._internalEnvAtlas=null),this._resetSkyMesh())}get envAtlas(){return this._envAtlas}set layers(e){var t=this._layers;this._layers=e,this.fire("set:layers",t,e)}get layers(){return this._layers}get sky(){return this._sky}get lighting(){return this._lightingParams}get fog(){return this._fogParams}set lightmapFilterRange(e){this._lightmapFilterRange=Math.max(e,.001)}get lightmapFilterRange(){return this._lightmapFilterRange}set lightmapFilterSmoothness(e){this._lightmapFilterSmoothness=Math.max(e,.001)}get lightmapFilterSmoothness(){return this._lightmapFilterSmoothness}set prefilteredCubemaps(e){e=e||[];var t=this._prefilteredCubemaps,s=t.length!==e.length||t.some(((t,s)=>t!==e[s]));if(s){var i=6===e.length&&e.every((e=>!!e));i?(this._internalEnvAtlas=Md.generatePrefilteredAtlas(e,{target:this._internalEnvAtlas}),this._envAtlas=this._internalEnvAtlas):(this._internalEnvAtlas&&(this._internalEnvAtlas.destroy(),this._internalEnvAtlas=null),this._envAtlas=null),this._prefilteredCubemaps=e.slice(),this._resetSkyMesh()}}get prefilteredCubemaps(){return this._prefilteredCubemaps}set skybox(e){e!==this._skyboxCubeMap&&(this._skyboxCubeMap=e,this._resetSkyMesh())}get skybox(){return this._skyboxCubeMap}set skyboxIntensity(e){e!==this._skyboxIntensity&&(this._skyboxIntensity=e,this._resetSkyMesh())}get skyboxIntensity(){return this._skyboxIntensity}set skyboxLuminance(e){e!==this._skyboxLuminance&&(this._skyboxLuminance=e,this._resetSkyMesh())}get skyboxLuminance(){return this._skyboxLuminance}set skyboxMip(e){e!==this._skyboxMip&&(this._skyboxMip=e,this._resetSkyMesh())}get skyboxMip(){return this._skyboxMip}set skyboxHighlightMultiplier(e){e!==this._skyboxHighlightMultiplier&&(this._skyboxHighlightMultiplier=e,this._resetSkyMesh())}get skyboxHighlightMultiplier(){return this._skyboxHighlightMultiplier}set skyboxRotation(e){if(!this._skyboxRotation.equals(e)){var t=e.equals(kt.IDENTITY);this._skyboxRotation.copy(e),t?this._skyboxRotationMat3.setIdentity():(this._skyboxRotationMat4.setTRS(yt.ZERO,e,yt.ONE),this._skyboxRotationMat3.invertMat4(this._skyboxRotationMat4)),this._skyboxRotationShaderInclude||t||(this._skyboxRotationShaderInclude=!0,this._resetSkyMesh())}}get skyboxRotation(){return this._skyboxRotation}destroy(){this._resetSkyMesh(),this.root=null,this.off()}drawLine(e,t,s,i,n){void 0===s&&(s=mt.WHITE),void 0===i&&(i=!0),void 0===n&&(n=this.defaultDrawLayer),this.immediate.getBatch(n,i).addLines([e,t],[s,s])}drawLines(e,t,s,i){void 0===s&&(s=!0),void 0===i&&(i=this.defaultDrawLayer),this.immediate.getBatch(i,s).addLines(e,t)}drawLineArrays(e,t,s,i){void 0===s&&(s=!0),void 0===i&&(i=this.defaultDrawLayer),this.immediate.getBatch(i,s).addLinesArrays(e,t)}applySettings(e){var t,s,i,n,a=e.physics,r=e.render;this._gravity.set(a.gravity[0],a.gravity[1],a.gravity[2]),this.ambientLight.set(r.global_ambient[0],r.global_ambient[1],r.global_ambient[2]),this.ambientLuminance=r.ambientLuminance,this.fog.type=r.fog,this.fog.color.set(r.fog_color[0],r.fog_color[1],r.fog_color[2]),this.fog.start=r.fog_start,this.fog.end=r.fog_end,this.fog.density=r.fog_density,this.lightmapSizeMultiplier=r.lightmapSizeMultiplier,this.lightmapMaxResolution=r.lightmapMaxResolution,this.lightmapMode=r.lightmapMode,this.exposure=r.exposure,this._skyboxIntensity=null!=(t=r.skyboxIntensity)?t:1,this._skyboxLuminance=null!=(s=r.skyboxLuminance)?s:2e4,this._skyboxMip=null!=(i=r.skyboxMip)?i:0,r.skyboxRotation&&(this.skyboxRotation=(new kt).setFromEulerAngles(r.skyboxRotation[0],r.skyboxRotation[1],r.skyboxRotation[2])),this.sky.applySettings(r),this.clusteredLightingEnabled=null!=(n=r.clusteredLightingEnabled)&&n,this.lighting.applySettings(r),["lightmapFilterEnabled","lightmapFilterRange","lightmapFilterSmoothness","ambientBake","ambientBakeNumSamples","ambientBakeSpherePart","ambientBakeOcclusionBrightness","ambientBakeOcclusionContrast"].forEach((e=>{r.hasOwnProperty(e)&&(this[e]=r[e])})),this._resetSkyMesh()}_getSkyboxTex(){var e=this._prefilteredCubemaps;if(this._skyboxMip){return e[[0,1,3,4,5,6][this._skyboxMip]]||this._envAtlas||e[0]||this._skyboxCubeMap}return this._skyboxCubeMap||e[0]||this._envAtlas}_updateSkyMesh(){this.sky.skyMesh||this.sky.updateSkyMesh(),this.sky.update()}_resetSkyMesh(){this.sky.resetSkyMesh(),this.updateShaders=!0}setSkybox(e){e?(this.skybox=e[0]||null,e[1]&&!e[1].cubemap?this.envAtlas=e[1]:this.prefilteredCubemaps=e.slice(1)):(this.skybox=null,this.envAtlas=null)}get lightmapPixelFormat(){return this.lightmapHDR&&this.device.getRenderableHdrFormat()||7}constructor(e){super(),this.ambientBake=!1,this.ambientBakeOcclusionBrightness=0,this.ambientBakeOcclusionContrast=0,this.ambientLight=new mt(0,0,0),this.ambientLuminance=0,this.exposure=1,this.lightmapSizeMultiplier=1,this.lightmapMaxResolution=2048,this.lightmapMode=1,this.lightmapFilterEnabled=!1,this.lightmapHDR=!1,this.root=null,this.physicalUnits=!1,this._envAtlas=null,this._skyboxCubeMap=null,this._fogParams=new Id,this.device=e,this._gravity=new yt(0,-9.8,0),this._layers=null,this._prefilteredCubemaps=[],this._internalEnvAtlas=null,this._skyboxIntensity=1,this._skyboxLuminance=0,this._skyboxMip=0,this._skyboxHighlightMultiplier=1,this._skyboxRotationShaderInclude=!1,this._skyboxRotation=new kt,this._skyboxRotationMat3=new xt,this._skyboxRotationMat4=new Et,this._ambientBakeNumSamples=1,this._ambientBakeSpherePart=.4,this._lightmapFilterRange=10,this._lightmapFilterSmoothness=.2,this._clusteredLightingEnabled=!0,this._lightingParams=new Fc(this.device.supportsAreaLights,this.device.maxTextureSize,(()=>{this.updateShaders=!0})),this._sky=new id(this),this._stats={meshInstances:0,lights:0,dynamicLights:0,bakedLights:0,updateShadersTime:0},this.updateShaders=!0,this._shaderVersion=0,this.immediate=new cd(this.device)}};Dd.EVENT_SETLAYERS="set:layers",Dd.EVENT_SETSKYBOX="set:skybox",Dd.EVENT_PRERENDER="prerender",Dd.EVENT_POSTRENDER="postrender",Dd.EVENT_PRERENDER_LAYER="prerender:layer",Dd.EVENT_POSTRENDER_LAYER="postrender:layer",Dd.EVENT_PRECULL="precull",Dd.EVENT_POSTCULL="postcull";class Rd{constructor(e,t,s){this.device=e,this.inverseBindPose=t,this.boneNames=s}}class Ld{constructor(){this.hasTangents=!1,this.chunks={},this.pass=0,this.alphaTest=!1,this.blendType=3,this.separateAmbient=!1,this.screenSpace=!1,this.skin=!1,this.batch=!1,this.useInstancing=!1,this.useMorphPosition=!1,this.useMorphNormal=!1,this.useMorphTextureBasedInt=!1,this.nineSlicedMode=0,this.clusteredLightingEnabled=!0,this.clusteredLightingCookiesEnabled=!1,this.clusteredLightingShadowsEnabled=!1,this.clusteredLightingShadowType=0,this.clusteredLightingAreaLightsEnabled=!1,this.vertexColors=!1,this.lightMapEnabled=!1,this.dirLightMapEnabled=!1,this.useHeights=!1,this.useNormals=!1,this.useClearCoatNormals=!1,this.useAo=!1,this.diffuseMapEnabled=!1,this.customFragmentShader=null,this.pixelSnap=!1,this.ambientSH=!1,this.ssao=!1,this.twoSidedLighting=!1,this.occludeDirect=!1,this.occludeSpecular=0,this.occludeSpecularFloat=!1,this.useMsdf=!1,this.msdfTextAttribute=!1,this.alphaToCoverage=!1,this.opacityFadesSpecular=!1,this.opacityDither=uo,this.opacityShadowDither=uo,this.cubeMapProjection=0,this.useSpecular=!1,this.useSpecularityFactor=!1,this.enableGGXSpecular=!1,this.fresnelModel=0,this.useRefraction=!1,this.useClearCoat=!1,this.useSheen=!1,this.useIridescence=!1,this.useMetalness=!1,this.useDynamicRefraction=!1,this.dispersion=!1,this.fog=eo,this.gamma=0,this.toneMap=-1,this.reflectionSource=null,this.reflectionEncoding=null,this.reflectionCubemapEncoding=null,this.ambientSource="constant",this.ambientEncoding=null,this.skyboxIntensity=1,this.useCubeMapRotation=!1,this.lightMapWithoutAmbient=!1,this.lights=[],this.noShadow=!1,this.lightMaskDynamic=0,this.userAttributes={},this.linearDepth=!1}}class Fd{static update(e,t,s,i,n,a,r){Fd.updateSharedOptions(e,t,s,n,a),Fd.updateMaterialOptions(e,t),Fd.updateEnvOptions(e,t,s,i),Fd.updateLightingOptions(e,t,n,r)}static updateSharedOptions(e,t,s,i,n){e.chunks=t.chunks,e.pass=n,e.alphaTest=t.alphaTest>0,e.blendType=t.blendType,e.screenSpace=i&&!!(256&i),e.skin=i&&!!(2&i),e.useInstancing=i&&!!(32&i),e.useMorphPosition=i&&!!(i&ro),e.useMorphNormal=i&&!!(i&oo),e.useMorphTextureBasedInt=i&&!!(i&lo),e.hasTangents=i&&!!(512&i),e.nineSlicedMode=t.nineSlicedMode||0,t.useLighting&&s.clusteredLightingEnabled?(e.clusteredLightingEnabled=!0,e.clusteredLightingCookiesEnabled=s.lighting.cookiesEnabled,e.clusteredLightingShadowsEnabled=s.lighting.shadowsEnabled,e.clusteredLightingShadowType=s.lighting.shadowType,e.clusteredLightingAreaLightsEnabled=s.lighting.areaLightsEnabled):(e.clusteredLightingEnabled=!1,e.clusteredLightingCookiesEnabled=!1,e.clusteredLightingShadowsEnabled=!1,e.clusteredLightingAreaLightsEnabled=!1)}static updateMaterialOptions(e,t){e.separateAmbient=!1,e.customFragmentShader=null,e.pixelSnap=t.pixelSnap,e.ambientSH=t.ambientSH,e.twoSidedLighting=t.twoSidedLighting,e.occludeDirect=t.occludeDirect,e.occludeSpecular=t.occludeSpecular,e.occludeSpecularFloat=1!==t.occludeSpecularIntensity,e.useMsdf=!1,e.msdfTextAttribute=!1,e.alphaToCoverage=t.alphaToCoverage,e.opacityFadesSpecular=t.opacityFadesSpecular,e.opacityDither=t.opacityDither,e.cubeMapProjection=0,e.useSpecular=t.hasSpecular,e.useSpecularityFactor=t.hasSpecularityFactor,e.enableGGXSpecular=t.ggxSpecular,e.fresnelModel=t.fresnelModel,e.useRefraction=t.hasRefraction,e.useClearCoat=t.hasClearCoat,e.useSheen=t.hasSheen,e.useIridescence=t.hasIrridescence,e.useMetalness=t.hasMetalness,e.useDynamicRefraction=t.dynamicRefraction,e.dispersion=t.dispersion>0,e.vertexColors=!1,e.lightMapEnabled=t.hasLighting,e.dirLightMapEnabled=t.dirLightMap,e.useHeights=t.hasHeights,e.useNormals=t.hasNormals,e.useClearCoatNormals=t.hasClearCoatNormals,e.useAo=t.hasAo,e.diffuseMapEnabled=t.hasDiffuseMap}static updateEnvOptions(e,t,s,i){e.fog=t.useFog?i.fog:eo,e.gamma=i.shaderOutputGamma,e.toneMap=t.useTonemap?i.toneMapping:6,t.useSkybox&&s.envAtlas&&s.skybox?(e.reflectionSource="envAtlasHQ",e.reflectionEncoding=s.envAtlas.encoding,e.reflectionCubemapEncoding=s.skybox.encoding):t.useSkybox&&s.envAtlas?(e.reflectionSource="envAtlas",e.reflectionEncoding=s.envAtlas.encoding):t.useSkybox&&s.skybox?(e.reflectionSource="cubeMap",e.reflectionEncoding=s.skybox.encoding):(e.reflectionSource=null,e.reflectionEncoding=null),t.ambientSH?(e.ambientSource="ambientSH",e.ambientEncoding=null):e.reflectionSource&&s.envAtlas?(e.ambientSource="envAtlas",e.ambientEncoding=s.envAtlas.encoding):(e.ambientSource="constant",e.ambientEncoding=null);var n=!!e.reflectionSource;e.skyboxIntensity=n,e.useCubeMapRotation=n&&s._skyboxRotationShaderInclude}static updateLightingOptions(e,t,s,i){if(e.lightMapWithoutAmbient=!1,t.useLighting){var n=[],a=s?s>>16:1;e.lightMaskDynamic=!!(1&a),e.lightMapWithoutAmbient=!1,i&&(Fd.collectLights(0,i[0],n,a),Fd.collectLights(1,i[1],n,a),Fd.collectLights(2,i[2],n,a)),e.lights=n}else e.lights=[];(0===e.lights.length||1&s)&&(e.noShadow=!0)}static collectLights(e,t,s,i){for(var n=0;n<t.length;n++){var a=t[n];a.enabled&&a.mask&i&&s.push(a)}}}class Bd{append(){for(var e=arguments.length,t=new Array(e),s=0;s<e;s++)t[s]=arguments[s];t.forEach((e=>{e.endsWith("\n")?this.code+=e:this.code+=e+"\n"}))}prepend(){for(var e=arguments.length,t=new Array(e),s=0;s<e;s++)t[s]=arguments[s];t.forEach((e=>{e.endsWith("\n")?this.code=e+this.code:this.code=e+"\n"+this.code}))}constructor(){this.code=""}}var Od={vertex_normal:fs,vertex_tangent:gs,vertex_texCoord0:ws,vertex_texCoord1:bs,vertex_color:ys,vertex_boneWeights:vs,vertex_boneIndices:_s},zd={vVertexColor:"vec4",vPositionW:"vec3",vNormalV:"vec3",vNormalW:"vec3",vTangentW:"vec3",vBinormalW:"vec3",vObjectSpaceUpW:"vec3",vUv0:"vec2",vUv1:"vec2",vLinearDepth:"float"};class Vd{_vsAddBaseCode(e,t,s){return e+=t.baseVS,1!==s.nineSlicedMode&&2!==s.nineSlicedMode||(e+=t.baseNineSlicedVS),e}_setMapTransform(e,t,s,i){var n=s+100*i;if(!e[3][n]){var a="texture_"+t+"MapTransform";e[0]+="uniform vec3 "+a+"0;\n",e[0]+="uniform vec3 "+a+"1;\n",e[1]+="varying vec2 vUV"+i+"_"+s+";\n",e[2]+="   vUV"+i+"_"+s+" = vec2(dot(vec3(uv"+i+", 1), "+a+"0), dot(vec3(uv"+i+", 1), "+a+"1));\n",e[3][n]=!0}return e}_fsGetBaseCode(){var e=this.options,t=this.chunks,s=this.chunks.basePS;return 1===e.nineSlicedMode?s+=t.baseNineSlicedPS:2===e.nineSlicedMode&&(s+=t.baseNineSlicedTiledPS),s}_fsGetStartCode(e,t,s,i){var n=s.startPS;return 1===i.nineSlicedMode?n+=s.startNineSlicedPS:2===i.nineSlicedMode&&(n+=s.startNineSlicedTiledPS),n}_getLightSourceShapeString(e){switch(e){case 1:return"Rect";case 2:return"Disk";case 3:return"Sphere";default:return""}}generateVertexShader(e,t,s){var i=this.device,n=this.options,a=this.chunks,r="",o="",l="";r=this._vsAddBaseCode(r,a,n),o+="   vPositionW = getWorldPosition();\n",this.options.linearDepth&&(l+="\n                #ifndef VIEWMATRIX\n                #define VIEWMATRIX\n                    uniform mat4 matrix_view;\n                #endif\n            ",o+="\n                // linear depth from the worldPosition, see getLinearDepth\n                vLinearDepth = -(matrix_view * vec4(vPositionW, 1.0)).z;\n            "),this.options.useInstancing&&this.chunks.transformInstancingVS===yo.transformInstancingVS&&(this.attributes.instance_line1=Is,this.attributes.instance_line2=Ds,this.attributes.instance_line3=Rs,this.attributes.instance_line4=Ls),r+=a.transformVS,this.needsNormal&&(r+=a.normalCoreVS,r+=a.normalVS),this.needsNormal&&(this.attributes.vertex_normal=fs,o+="   vNormalW = getNormal();\n","sphereMap"===n.reflectionSource&&i.fragmentUniformsCount<=16&&(r+=a.viewNormalVS,o+="   vNormalV    = getViewNormal();\n"),n.hasTangents&&(n.useHeights||n.useNormals||n.enableGGXSpecular)?(this.attributes.vertex_tangent=gs,r+=a.tangentBinormalVS,o+="   vTangentW   = getTangent();\n",o+="   vBinormalW  = getBinormal();\n"):n.enableGGXSpecular&&(o+="   vObjectSpaceUpW = normalize(dNormalMatrix * vec3(0, 1, 0));\n"));for(var h=0;h<2;h++)e[h]&&(this.attributes["vertex_texCoord"+h]="TEXCOORD"+h,r+=a["uv"+h+"VS"],o+="   vec2 uv"+h+" = getUv"+h+"();\n"),t[h]&&(o+="   vUv"+h+" = uv"+h+";\n");var c=[r,this.varyings,o,[]];s.forEach((e=>{this._setMapTransform(c,e.name,e.id,e.uv)})),r=c[0],this.varyings=c[1],o=c[2],n.vertexColors&&(this.attributes.vertex_color=ys,o+="   vVertexColor = vertex_color;\n"),n.useMsdf&&n.msdfTextAttribute&&(this.attributes.vertex_outlineParameters=ks,this.attributes.vertex_shadowParameters=Ms,o+="    unpackMsdfParams();\n",r+=a.msdfVS),(n.useMorphPosition||n.useMorphNormal)&&(l+="#define MORPHING\n",n.useMorphTextureBasedInt&&(l+="#define MORPHING_INT\n"),n.useMorphPosition&&(l+="#define MORPHING_POSITION\n"),n.useMorphNormal&&(l+="#define MORPHING_NORMAL\n"),this.attributes.morph_vertex_id=Ls),n.skin?(this.attributes.vertex_boneIndices=_s,n.batch?l+="#define BATCH\n":(this.attributes.vertex_boneWeights=vs,l+="#define SKIN\n")):n.useInstancing&&(l+="#define INSTANCING\n"),n.screenSpace&&(l+="#define SCREENSPACE\n"),n.pixelSnap&&(l+="#define PIXELSNAP\n"),r+="\n",r+=a.startVS,r+=o,r+=a.endVS,r+="}",Object.keys(zd).forEach((e=>{r.indexOf(e)>=0&&(this.varyings+="varying "+zd[e]+" "+e+";\n",this.varyingDefines+="#define VARYING_"+e.toUpperCase()+"\n")})),this.vshader=l+this.varyings+r}_fsGetBeginCode(){for(var e="",t=0;t<this.defines.length;t++)e+="#define "+this.defines[t]+"\n";return e}_fsGetPickPassCode(){return"\n            "+this._fsGetBeginCode()+"\n            "+this.varyings+"\n            "+this.varyingDefines+"\n            "+this.frontendDecl+"\n            "+this.frontendCode+"\n            "+this.chunks.pickPS+"\n\n            void main(void) {\n                "+this.frontendFunc+"\n                gl_FragColor = getPickOutput();\n            }\n        "}_fsGetDepthPassCode(){var e=this._fsGetBeginCode();return e+=this.varyings,e+=this.varyingDefines,e+=this.frontendDecl,e+=this.frontendCode,e+=bo.begin(),e+=this.frontendFunc,e+="    gl_FragColor = vec4(1.0, 1.0, 1.0, 1.0);\n",e+=bo.end()}_fsGetPrePassCode(){var e=this._fsGetBeginCode();return e+=this.varyings,e+=this.varyingDefines,e+=this.chunks.floatAsUintPS,e+=this.frontendDecl,e+=this.frontendCode,e+=bo.begin(),e+=this.frontendFunc,e+=this.device.textureFloatRenderable?"\n            gl_FragColor = vec4(vLinearDepth, 1.0, 1.0, 1.0);\n        ":"\n            gl_FragColor = float2uint(vLinearDepth);\n        ",e+=bo.end()}_fsGetShadowPassCode(){var e=this.options,t=this.chunks,s=this.varyings,i=this.shaderPassInfo.lightType,n=this.shaderPassInfo.shadowType;0!==i&&e.clusteredLightingEnabled&&(2!==n&&3!==n&&6!==n||(n=0));var a,r,o=to.get(n),l=null!=(a=null==o?void 0:o.vsm)&&a,h=null!=(r=null==o?void 0:o.pcss)&&r,c=this._fsGetBeginCode();3===n?c+="#define VSM_EXPONENT 15.0\n\n":2===n&&(c+="#define VSM_EXPONENT 5.54\n\n"),0!==i&&(c+="uniform vec3 view_position;\n",c+="uniform float light_radius;\n"),c+=s,c+=this.varyingDefines,c+=this.frontendDecl,c+=this.frontendCode,6===n&&(c+=yo.linearizeDepthPS),c+=bo.begin(),c+=this.frontendFunc;var d=!1;(0===i||!l&&2===i?(c+="    float depth = gl_FragCoord.z;\n",h&&0!==i&&(c+="    depth = linearizeDepth(depth, camera_params);\n")):(c+="    float depth = min(distance(view_position, vPositionW) / light_radius, 0.99999);\n",d=!0),l)?c+=t.storeEVSMPS:h?c+="    gl_FragColor.r = depth;\n":(d&&(c+="    gl_FragDepth = depth;\n"),c+="    gl_FragColor = vec4(1.0);\n");return c+=bo.end()}_fsGetLitPassCode(){var e=this.device,t=this.options,s=this.chunks,i=new Bd,n=new Bd,a=new Bd,r=new Bd;!1===t.opacityFadesSpecular&&i.append("uniform float material_alphaFade;"),t.useSpecular&&(this.defines.push("LIT_SPECULAR"),this.reflections&&this.defines.push("LIT_REFLECTIONS"),t.useClearCoat&&this.defines.push("LIT_CLEARCOAT"),t.fresnelModel>0&&this.defines.push("LIT_SPECULAR_FRESNEL"),t.useSheen&&this.defines.push("LIT_SHEEN"),t.useIridescence&&this.defines.push("LIT_IRIDESCENCE"));var o=[],l=0,h=!1,c=!1,d=!1,u=t.lights.some((e=>e._shape&&0!==e._shape));t.clusteredLightingEnabled&&t.clusteredLightingAreaLightsEnabled&&(u=!0),(u||t.clusteredLightingEnabled)&&(i.append("#define AREA_LIGHTS"),i.append("uniform highp sampler2D areaLightsLutTex1;"),i.append("uniform highp sampler2D areaLightsLutTex2;"));for(var p=0;p<t.lights.length;p++){var m=t.lights[p],f=m._type;if(!t.clusteredLightingEnabled||0===f){var g=u&&m._shape?m._shape:0;i.append("uniform vec3 light"+p+"_color;"),6===m._shadowType&&m.castShadows&&!t.noShadow&&(i.append("uniform float light"+p+"_shadowSearchArea;"),i.append("uniform vec4 light"+p+"_cameraParams;"),0===f&&i.append("uniform vec4 light"+p+"_softShadowParams;")),0===f?i.append("uniform vec3 light"+p+"_direction;"):(i.append("uniform vec3 light"+p+"_position;"),i.append("uniform float light"+p+"_radius;"),2===f&&(i.append("uniform vec3 light"+p+"_direction;"),i.append("uniform float light"+p+"_innerConeAngle;"),i.append("uniform float light"+p+"_outerConeAngle;"))),0!==g&&(0===f&&i.append("uniform vec3 light"+p+"_position;"),i.append("uniform vec3 light"+p+"_halfWidth;"),i.append("uniform vec3 light"+p+"_halfHeight;")),m.castShadows&&!t.noShadow&&(i.append("uniform mat4 light"+p+"_shadowMatrix;"),i.append("uniform float light"+p+"_shadowIntensity;"),0===f&&(i.append("uniform mat4 light"+p+"_shadowMatrixPalette[4];"),i.append("uniform vec4 light"+p+"_shadowCascadeDistances;"),i.append("uniform int light"+p+"_shadowCascadeCount;"),i.append("uniform float light"+p+"_shadowCascadeBlend;")),i.append("uniform vec4 light"+p+"_shadowParams;"),0===f&&(h=!0),1===f?i.append("uniform "+(m._isPcf?"samplerCubeShadow":"samplerCube")+" light"+p+"_shadowMap;"):i.append("uniform "+(m._isPcf?"sampler2DShadow":"sampler2D")+" light"+p+"_shadowMap;"),l++,o[m._shadowType]=!0,m._isVsm&&(c=!0),6===m._shadowType&&(d=!0)),m._cookie&&(m._cookie._cubemap?1===f&&(i.append("uniform samplerCube light"+p+"_cookie;"),i.append("uniform float light"+p+"_cookieIntensity;"),m.castShadows&&!t.noShadow||i.append("uniform mat4 light"+p+"_shadowMatrix;")):2===f&&(i.append("uniform sampler2D light"+p+"_cookie;"),i.append("uniform float light"+p+"_cookieIntensity;"),m.castShadows&&!t.noShadow||i.append("uniform mat4 light"+p+"_shadowMatrix;"),m._cookieTransform&&(i.append("uniform vec4 light"+p+"_cookieMatrix;"),i.append("uniform vec2 light"+p+"_cookieOffset;"))))}}var v=this.needsNormal&&(t.useNormals||t.useClearCoatNormals||t.enableGGXSpecular&&!t.useHeights);if(v&&(t.hasTangents?n.append(s.TBNPS):t.useNormals||t.useClearCoatNormals?n.append(s.TBNderivativePS.replace(/\$UV/g,this.lightingUv)):n.append(s.TBNObjectSpacePS),t.twoSidedLighting&&n.append(s.twoSidedLightingPS)),n.append(s.sphericalPS),n.append(s.decodePS),n.append(s.gammaPS),n.append(s.tonemappingPS),n.append(s.fogPS),n.append(this.frontendCode),t.useCubeMapRotation&&i.append("#define CUBEMAP_ROTATION"),this.needsNormal&&(n.append(s.cubeMapRotatePS),n.append(t.cubeMapProjection>0?s.cubeMapProjectBoxPS:s.cubeMapProjectNonePS),n.append(t.skyboxIntensity?s.envMultiplyPS:s.envConstPS)),(this.lighting&&t.useSpecular||this.reflections)&&(t.useMetalness&&n.append(s.metalnessModulatePS),2===t.fresnelModel&&n.append(s.fresnelSchlickPS),t.useIridescence&&n.append(s.iridescenceDiffractionPS)),t.useAo)switch(n.append(s.aoDiffuseOccPS),t.occludeSpecular){case 1:n.append(t.occludeSpecularFloat?s.aoSpecOccSimplePS:s.aoSpecOccConstSimplePS);break;case 2:n.append(t.occludeSpecularFloat?s.aoSpecOccPS:s.aoSpecOccConstPS)}"envAtlasHQ"===t.reflectionSource?(n.append(s.envAtlasPS),n.append(s.reflectionEnvHQPS.replace(/\$DECODE_CUBEMAP/g,Xc.decodeFunc(t.reflectionCubemapEncoding)).replace(/\$DECODE/g,Xc.decodeFunc(t.reflectionEncoding)))):"envAtlas"===t.reflectionSource?(n.append(s.envAtlasPS),n.append(s.reflectionEnvPS.replace(/\$DECODE/g,Xc.decodeFunc(t.reflectionEncoding)))):"cubeMap"===t.reflectionSource?n.append(s.reflectionCubePS.replace(/\$DECODE/g,Xc.decodeFunc(t.reflectionEncoding))):"sphereMap"===t.reflectionSource&&n.append(s.reflectionSpherePS.replace(/\$DECODE/g,Xc.decodeFunc(t.reflectionEncoding))),this.reflections&&(t.useClearCoat&&n.append(s.reflectionCCPS),t.useSheen&&n.append(s.reflectionSheenPS)),t.useRefraction&&(t.useDynamicRefraction?(t.dispersion&&(i.append("uniform float material_dispersion;"),i.append("#define DISPERSION\n")),n.append(s.refractionDynamicPS)):this.reflections&&n.append(s.refractionCubePS)),t.useSheen&&n.append(s.lightSheenPS),t.clusteredLightingEnabled&&(n.append(s.clusteredLightUtilsPS),t.clusteredLightingCookiesEnabled&&n.append(s.clusteredLightCookiesPS),t.clusteredLightingShadowsEnabled&&!t.noShadow&&(o[0]=!0,o[4]=!0,o[6]=!0)),(l>0||t.clusteredLightingEnabled)&&(h&&n.append(s.shadowCascadesPS),(o[5]||o[0]||o[7]||o[8])&&n.append(s.shadowStandardPS),(o[4]||o[9])&&n.append(s.shadowStandardGL2PS),c&&(n.append(s.shadowVSM_commonPS),o[2]&&n.append(s.shadowEVSMPS.replace(/\$/g,"16")),o[3]&&n.append(e.extTextureFloatLinear?s.shadowEVSMPS.replace(/\$/g,"32"):s.shadowEVSMnPS.replace(/\$/g,"32"))),d&&(n.append(s.linearizeDepthPS),n.append(s.shadowPCSSPS),n.append(s.shadowSoftPS))),t.enableGGXSpecular&&n.append("uniform float material_anisotropy;"),this.lighting&&(n.append(s.lightDiffuseLambertPS),(u||t.clusteredLightingAreaLightsEnabled)&&n.append(s.ltcPS));var _=!1;t.useSpecular&&(this.lighting&&n.append(t.enableGGXSpecular?s.lightSpecularAnisoGGXPS:s.lightSpecularBlinnPS),t.fresnelModel||this.reflections||t.diffuseMapEnabled||(i.append("uniform vec3 material_ambient;"),i.append("#define LIT_OLD_AMBIENT"),_=!0)),n.append(s.combinePS),t.lightMapEnabled&&n.append(t.useSpecular&&t.dirLightMapEnabled?s.lightmapDirAddPS:s.lightmapAddPS);var y=!t.lightMapEnabled||t.lightMapWithoutAmbient;y&&("ambientSH"===t.ambientSource?n.append(s.ambientSHPS):"envAtlas"===t.ambientSource?("envAtlas"!==t.reflectionSource&&"envAtlasHQ"!==t.reflectionSource&&n.append(s.envAtlasPS),n.append(s.ambientEnvPS.replace(/\$DECODE/g,Xc.decodeFunc(t.ambientEncoding)))):n.append(s.ambientConstantPS)),_||i.append("uniform vec3 material_ambient;"),t.useMsdf&&(t.msdfTextAttribute||i.append("#define UNIFORM_TEXT_PARAMETERS"),n.append(s.msdfPS)),this.needsNormal&&(n.append(s.viewDirPS),t.useSpecular&&n.append(t.enableGGXSpecular?s.reflDirAnisoPS:s.reflDirPS));var x,w=!1,b=!1,C=!1,S=!1,A=!1;if(t.clusteredLightingEnabled&&this.lighting){if(S=!0,w=!0,b=!0,A=!0,n.append(s.floatUnpackingPS),t.lightMaskDynamic&&i.append("#define CLUSTER_MESH_DYNAMIC_LIGHTS"),t.clusteredLightingCookiesEnabled&&i.append("#define CLUSTER_COOKIES"),t.clusteredLightingShadowsEnabled&&!t.noShadow){var T,P=(null==(T=to.get(t.clusteredLightingShadowType))?void 0:T.name).substring(0,4);i.append("#define CLUSTER_SHADOWS"),i.append("#define CLUSTER_SHADOW_TYPE_"+P)}t.clusteredLightingAreaLightsEnabled&&i.append("#define CLUSTER_AREALIGHTS"),i.append(Gl.getShaderDefines()),t.clusteredLightingShadowsEnabled&&!t.noShadow&&n.append(s.clusteredLightShadowsPS),n.append(s.clusteredLightPS)}if(r.append(this._fsGetStartCode(r,e,s,t)),this.needsNormal&&(r.append("    dVertexNormalW = normalize(vNormalW);"),(t.useHeights||t.useNormals)&&t.hasTangents&&(r.append("    dTangentW = vTangentW;"),r.append("    dBinormalW = vBinormalW;")),r.append("    getViewDir();"),v&&(r.append("    getTBN(dTangentW, dBinormalW, dVertexNormalW);"),t.twoSidedLighting&&r.append("    handleTwoSidedLighting();"))),r.append(this.frontendFunc),t.ssao&&(n.append("\n                    uniform sampler2D ssaoTexture;\n                    uniform vec2 ssaoTextureSizeInv;\n                "),a.append("litArgs_ao *= texture2DLod(ssaoTexture, gl_FragCoord.xy * ssaoTextureSizeInv, 0.0).r;")),this.needsNormal&&(t.useSpecular&&a.append("    getReflDir(litArgs_worldNormal, dViewDirW, litArgs_gloss, dTBN);"),t.useClearCoat&&a.append("    ccReflDirW = normalize(-reflect(dViewDirW, litArgs_clearcoat_worldNormal));")),(this.lighting&&t.useSpecular||this.reflections)&&(t.useMetalness&&(a.append("    float f0 = 1.0 / litArgs_ior; f0 = (f0 - 1.0) / (f0 + 1.0); f0 *= f0;"),a.append("    litArgs_specularity = getSpecularModulate(litArgs_specularity, litArgs_albedo, litArgs_metalness, f0);"),a.append("    litArgs_albedo = getAlbedoModulate(litArgs_albedo, litArgs_metalness);")),t.useIridescence&&a.append("    vec3 iridescenceFresnel = getIridescence(saturate(dot(dViewDirW, litArgs_worldNormal)), litArgs_specularity, litArgs_iridescence_thickness);")),y&&(a.append("    addAmbient(litArgs_worldNormal);"),t.useSpecular&&a.append("   dDiffuseLight = dDiffuseLight * (1.0 - litArgs_specularity);"),t.separateAmbient&&a.append("\n                    vec3 dAmbientLight = dDiffuseLight;\n                    dDiffuseLight = vec3(0);\n                ")),_||a.append("    dDiffuseLight *= material_ambient;"),t.useAo&&!t.occludeDirect&&a.append("    occludeDiffuse(litArgs_ao);"),t.lightMapEnabled&&a.append("    addLightMap(\n                litArgs_lightmap, \n                litArgs_lightmapDir, \n                litArgs_worldNormal, \n                dViewDirW, \n                dReflDirW, \n                litArgs_gloss, \n                litArgs_specularity, \n                dVertexNormalW,\n                dTBN\n            #if defined(LIT_IRIDESCENCE)\n                , iridescenceFresnel,\n                litArgs_iridescence_intensity\n            #endif\n                );"),this.lighting||this.reflections){this.reflections&&(t.useClearCoat&&(a.append("    addReflectionCC(ccReflDirW, litArgs_clearcoat_gloss);"),t.fresnelModel>0?(a.append("    ccFresnel = getFresnelCC(dot(dViewDirW, litArgs_clearcoat_worldNormal));"),a.append("    ccReflection.rgb *= ccFresnel;")):a.append("    ccFresnel = 0.0;")),t.useSpecularityFactor&&a.append("    ccReflection.rgb *= litArgs_specularityFactor;"),t.useSheen&&a.append("    addReflectionSheen(litArgs_worldNormal, dViewDirW, litArgs_sheen_gloss);"),a.append("    addReflection(dReflDirW, litArgs_gloss);"),t.fresnelModel>0?a.append("    dReflection.rgb *= \n                        getFresnel(\n                            dot(dViewDirW, litArgs_worldNormal), \n                            litArgs_gloss, \n                            litArgs_specularity\n                        #if defined(LIT_IRIDESCENCE)\n                            , iridescenceFresnel,\n                            litArgs_iridescence_intensity\n                        #endif\n                            );"):a.append("    dReflection.rgb *= litArgs_specularity;"),t.useSpecularityFactor&&a.append("    dReflection.rgb *= litArgs_specularityFactor;")),u&&(a.append("    dSpecularLight *= litArgs_specularity;"),t.useSpecular&&a.append("    calcLTCLightValues(litArgs_gloss, litArgs_worldNormal, dViewDirW, litArgs_specularity, litArgs_clearcoat_gloss, litArgs_clearcoat_worldNormal, litArgs_clearcoat_specularity);"));for(var E=0;E<t.lights.length;E++){var k=t.lights[E],M=k._type;if(!t.clusteredLightingEnabled||0===M){x=!1;var I=u&&k._shape?k.shape:0,D=u&&k._shape?this._getLightSourceShapeString(I):"";if(0!==I&&a.append("    calc"+D+"LightValues(light"+E+"_position, light"+E+"_halfWidth, light"+E+"_halfHeight);"),0===M?(a.append("    dLightDirNormW = light"+E+"_direction;"),a.append("    dAtten = 1.0;")):(k._cookie&&(2!==M||k._cookie._cubemap?1===M&&k._cookie._cubemap&&(A=!0,x=!0):(A=!0,x=!0)),a.append("    getLightDirPoint(light"+E+"_position);"),w=!0,x&&(2===M?a.append("    dAtten3 = getCookie2D"+(k._cookieFalloff?"":"Clip")+(k._cookieTransform?"Xform":"")+"(light"+E+"_cookie, light"+E+"_shadowMatrix, light"+E+"_cookieIntensity"+(k._cookieTransform?", light"+E+"_cookieMatrix, light"+E+"_cookieOffset":"")+")."+k._cookieChannel+";"):a.append("    dAtten3 = getCookieCube(light"+E+"_cookie, light"+E+"_shadowMatrix, light"+E+"_cookieIntensity)."+k._cookieChannel+";")),0===I?0===k._falloffMode?(a.append("    dAtten = getFalloffLinear(light"+E+"_radius, dLightDirW);"),b=!0):(a.append("    dAtten = getFalloffInvSquared(light"+E+"_radius, dLightDirW);"),C=!0):(a.append("    dAtten = getFalloffWindow(light"+E+"_radius, dLightDirW);"),C=!0),a.append("    if (dAtten > 0.00001) {"),2===M&&(x&&!k._cookieFalloff||(a.append("    dAtten *= getSpotEffect(light"+E+"_direction, light"+E+"_innerConeAngle, light"+E+"_outerConeAngle, dLightDirNormW);"),S=!0))),0!==I?0===M?a.append("    dAttenD = getLightDiffuse(litArgs_worldNormal, dViewDirW, dLightDirW, dLightDirNormW);"):a.append("    dAttenD = get"+D+"LightDiffuse(litArgs_worldNormal, dViewDirW, dLightDirW, dLightDirNormW) * 16.0;"):a.append("    dAtten *= getLightDiffuse(litArgs_worldNormal, dViewDirW, dLightDirW, dLightDirNormW);"),k.castShadows&&!t.noShadow){var R=to.get(k._shadowType),L=6===k._shadowType,F=null==R?void 0:R.vsm,B=null==R?void 0:R.pcf,O=null,z=void 0;switch(k._shadowType){case 2:O="VSM16",z="5.54";break;case 3:O="VSM32",z="15.0";break;case 5:case 7:O="PCF1x1";break;case 4:case 9:O="PCF5x5";break;case 6:O="PCSS";break;default:O="PCF3x3"}if(null!==O){k._normalOffsetBias&&!k._isVsm&&n.append("#define SHADOW_SAMPLE_NORMAL_OFFSET"),0===M&&n.append("#define SHADOW_SAMPLE_ORTHO"),(B||L||e.isWebGPU)&&n.append("#define SHADOW_SAMPLE_SOURCE_ZBUFFER"),1===M&&n.append("#define SHADOW_SAMPLE_POINT");var V=s.shadowSampleCoordPS;n.append(V.replace("$LIGHT",E)),n.append("#undef SHADOW_SAMPLE_NORMAL_OFFSET"),n.append("#undef SHADOW_SAMPLE_ORTHO"),n.append("#undef SHADOW_SAMPLE_SOURCE_ZBUFFER"),n.append("#undef SHADOW_SAMPLE_POINT");var N="light"+E+"_shadowMatrix";0===M&&k.numCascades>1&&(a.append("int cascadeIndex"+E+" = getShadowCascadeIndex(light"+E+"_shadowCascadeDistances, light"+E+"_shadowCascadeCount);"),k.cascadeBlend>0&&a.append("cascadeIndex"+E+" = ditherShadowCascadeIndex(cascadeIndex"+E+", light"+E+"_shadowCascadeDistances, light"+E+"_shadowCascadeCount, light"+E+"_shadowCascadeBlend);"),a.append("mat4 cascadeShadowMat"+E+" = light"+E+"_shadowMatrixPalette[cascadeIndex"+E+"];"),N="cascadeShadowMat"+E),a.append("    dShadowCoord = getShadowSampleCoord"+E+"("+N+", light"+E+"_shadowParams, vPositionW, dLightPosW, dLightDirW, dLightDirNormW, dVertexNormalW);"),0===M&&a.append("    fadeShadow(light"+E+"_shadowCascadeDistances);");var U="SHADOWMAP_PASS(light"+E+"_shadowMap), dShadowCoord, light"+E+"_shadowParams";if(F)U=U+", "+z+", dLightDirW";else if(L){var H=0===M?"light"+E+"_softShadowParams":"vec2(light"+E+"_shadowSearchArea)";0!==I&&(H="vec2(length(light"+E+"_halfWidth), length(light"+E+"_halfHeight)) * light"+E+"_shadowSearchArea"),U=U+", light"+E+"_cameraParams, "+H+", dLightDirW"}1===M?(O="Point"+O,L||(U+=", dLightDirW")):2===M&&(O="Spot"+O),a.append("    float shadow"+E+" = getShadow"+O+"("+U+");"),a.append("    dAtten *= mix(1.0, shadow"+E+", light"+E+"_shadowIntensity);")}}if(0!==I?t.useSpecular?a.append("    dDiffuseLight += ((dAttenD * dAtten) * light"+E+"_color"+(x?" * dAtten3":"")+") * (1.0 - dLTCSpecFres);"):a.append("    dDiffuseLight += (dAttenD * dAtten) * light"+E+"_color"+(x?" * dAtten3":"")+";"):u&&t.useSpecular?a.append("    dDiffuseLight += (dAtten * light"+E+"_color"+(x?" * dAtten3":"")+") * (1.0 - litArgs_specularity);"):a.append("    dDiffuseLight += dAtten * light"+E+"_color"+(x?" * dAtten3":"")+";"),t.useSpecular&&a.append("    dHalfDirW = normalize(-dLightDirNormW + dViewDirW);"),k.affectSpecularity)if(0!==I)t.useClearCoat&&a.append("    ccSpecularLight += ccLTCSpecFres * get"+D+"LightSpecular(litArgs_clearcoat_worldNormal, dViewDirW) * dAtten * light"+E+"_color"+(x?" * dAtten3":"")+";"),t.useSpecular&&a.append("    dSpecularLight += dLTCSpecFres * get"+D+"LightSpecular(litArgs_worldNormal, dViewDirW) * dAtten * light"+E+"_color"+(x?" * dAtten3":"")+";");else{var G=!1;0===M&&t.fresnelModel>0&&(G=!0),t.useClearCoat&&a.append("    ccSpecularLight += getLightSpecular(dHalfDirW, ccReflDirW, litArgs_clearcoat_worldNormal, dViewDirW, dLightDirNormW, litArgs_clearcoat_gloss, dTBN) * dAtten * light"+E+"_color"+(x?" * dAtten3":"")+(G?" * getFresnelCC(dot(dViewDirW, dHalfDirW));":";")),t.useSheen&&a.append("    sSpecularLight += getLightSpecularSheen(dHalfDirW, litArgs_worldNormal, dViewDirW, dLightDirNormW, litArgs_sheen_gloss) * dAtten * light"+E+"_color"+(x?" * dAtten3;":";")),t.useSpecular&&a.append("    dSpecularLight += getLightSpecular(dHalfDirW, dReflDirW, litArgs_worldNormal, dViewDirW, dLightDirNormW, litArgs_gloss, dTBN) * dAtten * light"+E+"_color"+(x?" * dAtten3":"")+(G?" \n                                    * getFresnel(\n                                        dot(dViewDirW, dHalfDirW), \n                                        litArgs_gloss, \n                                        litArgs_specularity\n                                    #if defined(LIT_IRIDESCENCE)\n                                        , iridescenceFresnel, \n                                        litArgs_iridescence_intensity\n                                    #endif\n                                    );":"* litArgs_specularity;"))}0!==M&&a.append("    }")}}t.clusteredLightingEnabled&&this.lighting&&(b=!0,C=!0,w=!0,a.append("    addClusteredLights(\n                                        litArgs_worldNormal, \n                                        dViewDirW, \n                                        dReflDirW,\n                                #if defined(LIT_CLEARCOAT)\n                                        ccReflDirW,\n                                #endif\n                                        litArgs_gloss, \n                                        litArgs_specularity, \n                                        dVertexNormalW, \n                                        dTBN, \n                                #if defined(LIT_IRIDESCENCE)\n                                        iridescenceFresnel,\n                                #endif\n                                        litArgs_clearcoat_worldNormal, \n                                        litArgs_clearcoat_gloss,\n                                        litArgs_sheen_gloss,\n                                        litArgs_iridescence_intensity\n                                    );")),u&&(t.useClearCoat&&a.append("    litArgs_clearcoat_specularity = 1.0;"),t.useSpecular&&a.append("    litArgs_specularity = vec3(1);")),t.useRefraction&&a.append("    addRefraction(\n                        litArgs_worldNormal, \n                        dViewDirW, \n                        litArgs_thickness, \n                        litArgs_gloss, \n                        litArgs_specularity, \n                        litArgs_albedo, \n                        litArgs_transmission,\n                        litArgs_ior,\n                        litArgs_dispersion\n                    #if defined(LIT_IRIDESCENCE)\n                        , iridescenceFresnel, \n                        litArgs_iridescence_intensity\n                    #endif\n                    );")}t.useAo&&(t.occludeDirect&&a.append("    occludeDiffuse(litArgs_ao);"),1!==t.occludeSpecular&&2!==t.occludeSpecular||a.append("    occludeSpecular(litArgs_gloss, litArgs_ao, litArgs_worldNormal, dViewDirW);")),t.useSpecularityFactor&&a.append("    dSpecularLight *= litArgs_specularityFactor;"),!1===t.opacityFadesSpecular&&(2!==t.blendType&&4!==t.blendType||(a.append("float specLum = dot((dSpecularLight + dReflection.rgb * dReflection.a), vec3( 0.2126, 0.7152, 0.0722 ));"),a.append("#ifdef LIT_CLEARCOAT\n specLum += dot(ccSpecularLight * litArgs_clearcoat_specularity + ccReflection.rgb * litArgs_clearcoat_specularity, vec3( 0.2126, 0.7152, 0.0722 ));\n#endif"),a.append("litArgs_opacity = clamp(litArgs_opacity + gammaCorrectInput(specLum), 0.0, 1.0);")),a.append("litArgs_opacity *= material_alphaFade;")),a.append(s.endPS),2===t.blendType||6===t.blendType||t.alphaToCoverage?a.append(s.outputAlphaPS):4===t.blendType?a.append(s.outputAlphaPremulPS):a.append(s.outputAlphaOpaquePS),t.useMsdf&&a.append("    gl_FragColor = applyMsdf(gl_FragColor);"),a.append(s.outputPS),a.append(s.debugOutputPS),w&&n.prepend(s.lightDirPointPS),b&&n.prepend(s.falloffLinearPS),C&&n.prepend(s.falloffInvSquaredPS),S&&n.prepend(s.spotPS),A&&!t.clusteredLightingEnabled&&n.prepend(s.cookiePS);var W="",j="void evaluateBackend() {\n"+a.code+"\n}";n.append(j),r.append(s.debugProcessFrontendPS),r.append("    evaluateBackend();"),r.append(bo.end());var q=i.code+n.code+r.code;return q.includes("dTBN")&&(W+="mat3 dTBN;\n"),q.includes("dVertexNormalW")&&(W+="vec3 dVertexNormalW;\n"),q.includes("dTangentW")&&(W+="vec3 dTangentW;\n"),q.includes("dBinormalW")&&(W+="vec3 dBinormalW;\n"),q.includes("dViewDirW")&&(W+="vec3 dViewDirW;\n"),q.includes("dReflDirW")&&(W+="vec3 dReflDirW;\n"),q.includes("dHalfDirW")&&(W+="vec3 dHalfDirW;\n"),q.includes("ccReflDirW")&&(W+="vec3 ccReflDirW;\n"),q.includes("dLightDirNormW")&&(W+="vec3 dLightDirNormW;\n"),q.includes("dLightDirW")&&(W+="vec3 dLightDirW;\n"),q.includes("dLightPosW")&&(W+="vec3 dLightPosW;\n"),q.includes("dShadowCoord")&&(W+="vec3 dShadowCoord;\n"),q.includes("dReflection")&&(W+="vec4 dReflection;\n"),q.includes("dDiffuseLight")&&(W+="vec3 dDiffuseLight;\n"),q.includes("dSpecularLight")&&(W+="vec3 dSpecularLight;\n"),q.includes("dAtten")&&(W+="float dAtten;\n"),q.includes("dAttenD")&&(W+="float dAttenD;\n"),q.includes("dAtten3")&&(W+="vec3 dAtten3;\n"),q.includes("dMsdf")&&(W+="vec4 dMsdf;\n"),q.includes("ccFresnel")&&(W+="float ccFresnel;\n"),q.includes("ccReflection")&&(W+="vec3 ccReflection;\n"),q.includes("ccSpecularLight")&&(W+="vec3 ccSpecularLight;\n"),q.includes("ccSpecularityNoFres")&&(W+="float ccSpecularityNoFres;\n"),q.includes("sSpecularLight")&&(W+="vec3 sSpecularLight;\n"),q.includes("sReflection")&&(W+="vec3 sReflection;\n"),this._fsGetBeginCode()+this.varyings+this.varyingDefines+this._fsGetBaseCode()+W+this.frontendDecl+q}generateFragmentShader(e,t,s,i){var n=this.options;this.frontendDecl=e,this.frontendCode=t,this.frontendFunc=s,this.lightingUv=i,3===n.pass?this.fshader=this._fsGetPickPassCode():2===n.pass?this.fshader=this._fsGetDepthPassCode():1===n.pass?this.fshader=this._fsGetPrePassCode():this.shadowPass?this.fshader=this._fsGetShadowPassCode():n.customFragmentShader?this.fshader=this._fsGetBeginCode()+n.customFragmentShader:this.fshader=this._fsGetLitPassCode()}constructor(e,t){if(this.device=e,this.options=t,this.attributes={vertex_position:ms},t.userAttributes)for(var[s,i]of Object.entries(t.userAttributes))this.attributes[i]=s;if(t.chunks){var n=t.chunks;for(var a in this.chunks=Object.create(yo),yo)if(n.hasOwnProperty(a)){var r=n[a];for(var o in Od)Od.hasOwnProperty(o)&&r.indexOf(o)>=0&&(this.attributes[o]=Od[o]);this.chunks[a]=r}}else this.chunks=yo;this.shaderPassInfo=Ao.get(this.device).getByIndex(t.pass),this.shadowPass=this.shaderPassInfo.isShadow,this.lighting=t.lights.length>0||t.dirLightMapEnabled||t.clusteredLightingEnabled,this.reflections=!!t.reflectionSource,this.needsNormal=this.lighting||this.reflections||t.useSpecular||t.ambientSH||t.useHeights||t.enableGGXSpecular||t.clusteredLightingEnabled&&!this.shadowPass||t.useClearCoatNormals,this.needsNormal=this.needsNormal&&!this.shadowPass,this.needsSceneColor=t.useDynamicRefraction,this.needsScreenSize=t.useDynamicRefraction,this.needsTransforms=t.useDynamicRefraction,this.varyings="",this.varyingDefines="",this.vshader=null,this.frontendDecl=null,this.frontendCode=null,this.frontendFunc=null,this.lightingUv=null,this.defines=[],this.fshader=null}}var Nd={generateKey:e=>"lit"+Object.keys(e).sort().map((t=>"chunks"===t?Nd.generateChunksKey(e):"lights"===t?Nd.generateLightsKey(e):t+e[t])).join("\n"),generateLightsKey:e=>"lights:"+e.lights.map((t=>e.clusteredLightingEnabled&&0!==t._type?"":t.key+",")).join(""),generateChunksKey(e){var t;return"chunks:\n"+Object.keys(null!=(t=e.chunks)?t:{}).sort().map((t=>t+e.chunks[t])).join("")}};class Ud{get pass(){return this.litOptions.pass}constructor(){this.defines=new Map,this.forceUv1=!1,this.specularTint=!1,this.metalnessTint=!1,this.glossTint=!1,this.emissiveEncoding="linear",this.lightMapEncoding="linear",this.packedNormal=!1,this.glossInvert=!1,this.sheenGlossInvert=!1,this.clearCoatGlossInvert=!1,this.useAO=!1,this.litOptions=new Ld}}function Hd(){return Hd=Object.assign||function(e){for(var t=1;t<arguments.length;t++){var s=arguments[t];for(var i in s)Object.prototype.hasOwnProperty.call(s,i)&&(e[i]=s[i])}return e},Hd.apply(this,arguments)}var Gd=[],Wd=e=>Object.keys(e).filter((e=>"litOptions"!==e)).sort();var jd=new class extends bo{generateKey(e){var t;return e===this.optionsContextMin?(this.propsMin||(this.propsMin=Wd(e)),t=this.propsMin):e===this.optionsContext?(this.props||(this.props=Wd(e)),t=this.props):t=Wd(e),"standard:\n"+bo.definesHash(e.defines)+"\n"+t.map((t=>t+e[t])).join("\n")+Nd.generateKey(e.litOptions)}_getUvSourceExpression(e,t,s){var i,n=s[e],a=s[t],r=0===s.litOptions.pass;return r&&1===s.litOptions.nineSlicedMode||r&&2===s.litOptions.nineSlicedMode?i="nineSlicedUv":(i=0===n?"vUv"+a:"vUV"+a+"_"+n,s.heightMap&&"heightMapTransform"!==e&&(i+=" + dUvOffset")),i}_addMapDef(e,t){return t?"#define "+e+"\n":"#undef "+e+"\n"}_addMapDefs(e,t,s,i,n){return this._addMapDef("MAPFLOAT",e)+this._addMapDef("MAPCOLOR",t)+this._addMapDef("MAPVERTEX",s)+this._addMapDef("MAPTEXTURE",i)+this._addMapDef("MAPINVERT",n)}_addMap(e,t,s,i,n,a){void 0===a&&(a=null);var r=e+"Map",o=r+"Uv",l=r+"Identifier",h=r+"Transform",c=r+"Channel",d=e+"VertexColorChannel",u=e+"VertexColor",p=e+"Mode",m=e+"Invert",f=s[e+"Tint"],g=s[u],v=s[r],_=s[l],y=s[p],x=i[t];if(v){var w=this._getUvSourceExpression(h,o,s);if(x=x.replace(/\$UV/g,w).replace(/\$CH/g,s[c]),n&&-1!==x.search(/\$SAMPLER/g)){var b="texture_"+r,C=n[_];C?b=C:n[_]=b,x=x.replace(/\$SAMPLER/g,b)}if(a&&(x="aaa"===s[c]?x.replace(/\$DECODE/g,"passThrough"):x.replace(/\$DECODE/g,Xc.decodeFunc(a))).indexOf("$texture2DSAMPLE")){x=x.replace(/\$texture2DSAMPLE/g,{linear:"texture2D",srgb:"texture2DSRGB",rgbm:"texture2DRGBM",rgbe:"texture2DRGBE"}[a]||"texture2D")}}g&&(x=x.replace(/\$VC/g,s[d])),y&&(x=x.replace(/\$DETAILMODE/g,y));var S=!!(1&f),A=!!(2&f),T=!!s[m];return(x=this._addMapDefs(S,A,g,v,T)+x).replace(/\$/g,"")}_correctChannel(e,t,s){if(s[e]>0){if(s[e]<t.length)return t.substring(0,s[e]);if(s[e]>t.length){for(var i=t,n=i.charAt(i.length-1),a=s[e]-i.length,r=0;r<a;r++)i+=n;return i}return t}}createShaderDefinition(e,t){var s=Ao.get(e).getByIndex(t.litOptions.pass).isForward,i=new Vd(e,t.litOptions),n=[],a=[],r=[],o={};for(var l in Gd){var h=l+"Map";if(t[l+"VertexColor"]){var c=l+"VertexColorChannel";t[c]=this._correctChannel(l,t[c],Gd)}if(t[h]){var d=h+"Channel",u=h+"Transform",p=h+"Uv";t[p]=Math.min(t[p],1),t[d]=this._correctChannel(l,t[d],Gd);var m=t[p];n[m]=!0,a[m]=a[m]||t[h]&&!t[u],t[u]&&r.push({name:l,id:t[u],uv:t[p]})}}t.forceUv1&&(n[1]=!0,a[1]=void 0===a[1]||a[1]),i.generateVertexShader(n,a,r),t.litOptions.fresnelModel=0===t.litOptions.fresnelModel?2:t.litOptions.fresnelModel;var f=new Bd,g=new Bd,v=new Bd,_=new Bd,y="";if(2===t.litOptions.nineSlicedMode?f.append("const float textureBias = -1000.0;"):f.append("uniform float textureBias;"),s){if(t.heightMap&&(f.append("vec2 dUvOffset;"),g.append(this._addMap("height","parallaxPS",t,i.chunks,o)),v.append("getParallax();")),3!==t.litOptions.blendType||t.litOptions.alphaTest||t.litOptions.alphaToCoverage||t.litOptions.opacityDither!==uo){f.append("float dAlpha;"),g.append(this._addMap("opacity","opacityPS",t,i.chunks,o)),v.append("getOpacity();"),_.append("litArgs_opacity = dAlpha;"),t.litOptions.alphaTest&&(g.append(i.chunks.alphaTestPS),v.append("alphaTest(dAlpha);"));var x=t.litOptions.opacityDither;x!==uo&&(x===po&&f.append(i.chunks.bayerPS),f.append("#define DITHER_"+x.toUpperCase()+"\n"),f.append(i.chunks.opacityDitherPS),v.append("opacityDither(dAlpha, 0.0);"))}else f.append("float dAlpha = 1.0;");if(i.needsNormal){if((t.normalMap||t.clearCoatNormalMap)&&(g.append(t.packedNormal?i.chunks.normalXYPS:i.chunks.normalXYZPS),!t.litOptions.hasTangents)){var w=t.normalMap?"normalMap":"clearCoatNormalMap";y=this._getUvSourceExpression(w+"Transform",w+"Uv",t)}f.append("vec3 dNormalW;"),g.append(this._addMap("normalDetail","normalDetailMapPS",t,i.chunks,o)),g.append(this._addMap("normal","normalMapPS",t,i.chunks,o)),v.append("getNormal();"),_.append("litArgs_worldNormal = dNormalW;")}if(i.needsSceneColor&&f.append("uniform sampler2D uSceneColorMap;"),i.needsScreenSize&&f.append("uniform vec4 uScreenSize;"),i.needsTransforms&&(f.append("uniform mat4 matrix_viewProjection;"),f.append("uniform mat4 matrix_model;")),(t.diffuseDetail||t.aoDetail)&&g.append(i.chunks.detailModesPS),f.append("vec3 dAlbedo;"),t.diffuseDetail&&g.append(this._addMap("diffuseDetail","diffuseDetailMapPS",t,i.chunks,o,t.diffuseDetailEncoding)),g.append(this._addMap("diffuse","diffusePS",t,i.chunks,o,t.diffuseEncoding)),v.append("getAlbedo();"),_.append("litArgs_albedo = dAlbedo;"),t.litOptions.useRefraction&&(f.append("float dTransmission;"),g.append(this._addMap("refraction","transmissionPS",t,i.chunks,o)),v.append("getRefraction();"),_.append("litArgs_transmission = dTransmission;"),f.append("float dThickness;"),g.append(this._addMap("thickness","thicknessPS",t,i.chunks,o)),v.append("getThickness();"),_.append("litArgs_thickness = dThickness;"),t.litOptions.dispersion&&_.append("litArgs_dispersion = material_dispersion;")),t.litOptions.useIridescence&&(f.append("float dIridescence;"),g.append(this._addMap("iridescence","iridescencePS",t,i.chunks,o)),v.append("getIridescence();"),_.append("litArgs_iridescence_intensity = dIridescence;"),f.append("float dIridescenceThickness;"),g.append(this._addMap("iridescenceThickness","iridescenceThicknessPS",t,i.chunks,o)),v.append("getIridescenceThickness();"),_.append("litArgs_iridescence_thickness = dIridescenceThickness;")),i.lighting&&t.litOptions.useSpecular||i.reflections?(f.append("vec3 dSpecularity;"),f.append("float dGlossiness;"),t.litOptions.useSheen&&(f.append("vec3 sSpecularity;"),g.append(this._addMap("sheen","sheenPS",t,i.chunks,o,t.sheenEncoding)),v.append("getSheen();"),_.append("litArgs_sheen_specularity = sSpecularity;"),f.append("float sGlossiness;"),g.append(this._addMap("sheenGloss","sheenGlossPS",t,i.chunks,o)),v.append("getSheenGlossiness();"),_.append("litArgs_sheen_gloss = sGlossiness;")),t.litOptions.useMetalness&&(f.append("float dMetalness;"),g.append(this._addMap("metalness","metalnessPS",t,i.chunks,o)),v.append("getMetalness();"),_.append("litArgs_metalness = dMetalness;"),f.append("float dIor;"),g.append(this._addMap("ior","iorPS",t,i.chunks,o)),v.append("getIor();"),_.append("litArgs_ior = dIor;")),t.litOptions.useSpecularityFactor&&(f.append("float dSpecularityFactor;"),g.append(this._addMap("specularityFactor","specularityFactorPS",t,i.chunks,o)),v.append("getSpecularityFactor();"),_.append("litArgs_specularityFactor = dSpecularityFactor;")),t.useSpecularColor?g.append(this._addMap("specular","specularPS",t,i.chunks,o,t.specularEncoding)):g.append("void getSpecularity() { dSpecularity = vec3(1); }"),g.append(this._addMap("gloss","glossPS",t,i.chunks,o)),v.append("getGlossiness();"),v.append("getSpecularity();"),_.append("litArgs_specularity = dSpecularity;"),_.append("litArgs_gloss = dGlossiness;")):(f.append("vec3 dSpecularity = vec3(0.0);"),f.append("float dGlossiness = 0.0;")),t.aoDetail&&g.append(this._addMap("aoDetail","aoDetailMapPS",t,i.chunks,o)),(t.aoMap||t.aoVertexColor||t.useAO)&&(f.append("float dAo;"),g.append(this._addMap("ao","aoPS",t,i.chunks,o)),v.append("getAO();"),_.append("litArgs_ao = dAo;")),f.append("vec3 dEmission;"),g.append(this._addMap("emissive","emissivePS",t,i.chunks,o,t.emissiveEncoding)),v.append("getEmission();"),_.append("litArgs_emission = dEmission;"),t.litOptions.useClearCoat&&(f.append("float ccSpecularity;"),f.append("float ccGlossiness;"),f.append("vec3 ccNormalW;"),g.append(this._addMap("clearCoat","clearCoatPS",t,i.chunks,o)),g.append(this._addMap("clearCoatGloss","clearCoatGlossPS",t,i.chunks,o)),g.append(this._addMap("clearCoatNormal","clearCoatNormalPS",t,i.chunks,o)),v.append("getClearCoat();"),v.append("getClearCoatGlossiness();"),v.append("getClearCoatNormal();"),_.append("litArgs_clearcoat_specularity = ccSpecularity;"),_.append("litArgs_clearcoat_gloss = ccGlossiness;"),_.append("litArgs_clearcoat_worldNormal = ccNormalW;")),t.lightMap||t.lightVertexColor){var b=t.dirLightMap&&t.litOptions.useSpecular,C=b?"lightmapDirPS":"lightmapSinglePS";f.append("vec3 dLightmap;"),b&&f.append("vec3 dLightmapDir;"),g.append(this._addMap("light",C,t,i.chunks,o,t.lightMapEncoding)),v.append("getLightMap();"),_.append("litArgs_lightmap = dLightmap;"),b&&_.append("litArgs_lightmapDir = dLightmapDir;")}}else{var S=t.litOptions.opacityShadowDither;(t.litOptions.alphaTest||S)&&(f.append("float dAlpha;"),g.append(this._addMap("opacity","opacityPS",t,i.chunks,o)),v.append("getOpacity();"),_.append("litArgs_opacity = dAlpha;"),t.litOptions.alphaTest&&(g.append(i.chunks.alphaTestPS),v.append("alphaTest(dAlpha);")),S!==uo&&(S===po&&f.append(i.chunks.bayerPS),f.append("#define DITHER_"+S.toUpperCase()+"\n"),f.append(i.chunks.opacityDitherPS),v.append("opacityDither(dAlpha, 0.0);")))}for(var A in f.append(i.chunks.litShaderArgsPS),g.append("void evaluateFrontend() { \n"+v.code+"\n"+_.code+"\n }\n"),v.code="evaluateFrontend();",o)f.append("uniform sampler2D "+o[A]+";");v.code="\n"+v.code.split("\n").map((e=>"    "+e)).join("\n")+"\n\n",i.generateFragmentShader(f.code,g.code,v.code,y);var T=new Map(Object.entries(Hd({},Object.getPrototypeOf(i.chunks),i.chunks,t.litOptions.chunks))),P=new Map(t.defines),E=Na.createDefinition(e,{name:"StandardShader",attributes:i.attributes,vertexCode:i.vshader,fragmentCode:i.fshader,vertexIncludes:T,fragmentIncludes:T,fragmentDefines:P,vertexDefines:P});return i.shaderPassInfo.isForward&&(E.tag=1),E}constructor(...e){super(...e),this.optionsContext=new Ud,this.optionsContextMin=new Ud}},qd=(e,t)=>{if(e.length!==t.length)return!1;for(var s=0;s<e.length;++s)if(e[s]!==t[s])return!1;return!0};class Xd{updateMinRef(e,t,s,i,n,a){this._updateSharedOptions(e,t,s,i,n),this._updateMinOptions(e,s,n),this._updateUVOptions(e,s,i,!0)}updateRef(e,t,s,i,n,a,r){this._updateSharedOptions(e,t,i,n,a),this._updateEnvOptions(e,i,t,s),this._updateMaterialOptions(e,i),e.litOptions.hasTangents=n&&!!(512&n),this._updateLightOptions(e,t,i,n,r),this._updateUVOptions(e,i,n,!1,s)}_updateSharedOptions(e,t,s,i,n){e.forceUv1=s.forceUv1,s.userAttributes&&(e.litOptions.userAttributes=Object.fromEntries(s.userAttributes.entries())),e.litOptions.chunks=s.chunks||{},e.litOptions.pass=n,e.litOptions.alphaTest=s.alphaTest>0,e.litOptions.blendType=s.blendType,e.litOptions.screenSpace=i&&!!(256&i),e.litOptions.skin=i&&!!(2&i),e.litOptions.batch=i&&!!(i&ho),e.litOptions.useInstancing=i&&!!(32&i),e.litOptions.useMorphPosition=i&&!!(i&ro),e.litOptions.useMorphNormal=i&&!!(i&oo),e.litOptions.useMorphTextureBasedInt=i&&!!(i&lo),e.litOptions.nineSlicedMode=s.nineSlicedMode||0,t.clusteredLightingEnabled&&s.useLighting?(e.litOptions.clusteredLightingEnabled=!0,e.litOptions.clusteredLightingCookiesEnabled=t.lighting.cookiesEnabled,e.litOptions.clusteredLightingShadowsEnabled=t.lighting.shadowsEnabled,e.litOptions.clusteredLightingShadowType=t.lighting.shadowType,e.litOptions.clusteredLightingAreaLightsEnabled=t.lighting.areaLightsEnabled):(e.litOptions.clusteredLightingEnabled=!1,e.litOptions.clusteredLightingCookiesEnabled=!1,e.litOptions.clusteredLightingShadowsEnabled=!1,e.litOptions.clusteredLightingAreaLightsEnabled=!1)}_updateUVOptions(e,t,s,i,n){var a=!1,r=!1,o=!1;s&&(a=!!(4&s),r=!!(8&s),o=!!(16&s)),e.litOptions.vertexColors=!1,this._mapXForms=[];var l={};for(var h in Gd)this._updateTexOptions(e,t,h,a,r,o,i,l);this._mapXForms=null,e.litOptions.ssao=null==n?void 0:n.ssaoEnabled,e.useAO=e.litOptions.ssao,e.litOptions.lightMapEnabled=e.lightMap,e.litOptions.dirLightMapEnabled=e.dirLightMap,e.litOptions.useHeights=e.heightMap,e.litOptions.useNormals=e.normalMap,e.litOptions.useClearCoatNormals=e.clearCoatNormalMap,e.litOptions.useAo=e.aoMap||e.aoVertexColor||e.litOptions.ssao,e.litOptions.diffuseMapEnabled=e.diffuseMap}_updateTexOptions(e,t,s,i,n,a,r,o){var l="opacity"===s;if(!r||l){var h=s+"Map",c=s+"VertexColor",d=s+"VertexColorChannel",u=h+"Channel",p=h+"Transform",m=h+"Uv",f=h+"Identifier";if("light"!==s&&(e[h]=!1,e[f]=void 0,e[u]="",e[p]=0,e[m]=0),e[c]=!1,e[d]="",l&&3===t.blendType&&0===t.alphaTest&&!t.alphaToCoverage&&t.opacityDither===uo)return;if("height"!==s&&t[c]&&a&&(e[c]=t[c],e[d]=t[d],e.litOptions.vertexColors=!0),t[h]){var g=!0;if(0!==t[m]||i||(g=!1),1!==t[m]||n||(g=!1),g){var v=t[h].id,_=o[v];void 0===_&&(o[v]=s,_=s),e[h]=!!t[h],e[f]=_,e[p]=this._getMapTransformID(t.getUniform(p),t[m]),e[u]=t[u],e[m]=t[m]}}}}_updateMinOptions(e,t,s){var i=1===s;e.litOptions.opacityShadowDither=i?t.opacityDither:t.opacityShadowDither,e.litOptions.linearDepth=i,e.litOptions.lights=[]}_updateMaterialOptions(e,t){var s,i,n,a,r,o=!!(t.useMetalness||t.specularMap||t.sphereMap||t.cubeMap||(r=t.specular,0!==r.r||0!==r.g||0!==r.b)||t.specularityFactor>0&&t.useMetalness||t.enableGGXSpecular||t.clearCoat>0),l=!t.useMetalness||t.useMetalnessSpecularColor,h=o&&(t.specularTint||!t.specularMap&&!t.specularVertexColor)&&(e=>1!==e.r||1!==e.g||1!==e.b)(t.specular),c=o&&t.useMetalnessSpecularColor&&(t.specularityFactorTint||t.specularityFactor<1&&!t.specularityFactorMap),d=!!t.normalMap&&(t.normalMap.format===$t||t.normalMap.type===Vs),u=(e,t)=>Math.abs(e-t)<1e-4;e.specularTint=h?2:0,e.specularityFactorTint=c?1:0,e.metalnessTint=t.useMetalness&&t.metalness<1?1:0,e.glossTint=1,e.diffuseEncoding=null==(s=t.diffuseMap)?void 0:s.encoding,e.diffuseDetailEncoding=null==(i=t.diffuseDetailMap)?void 0:i.encoding,e.emissiveEncoding=null==(n=t.emissiveMap)?void 0:n.encoding,e.lightMapEncoding=null==(a=t.lightMap)?void 0:a.encoding,e.packedNormal=d,e.refractionTint=u(t.refraction,1)?0:1,e.refractionIndexTint=u(t.refractionIndex,1/1.5)?0:1,e.thicknessTint=t.useDynamicRefraction&&1!==t.thickness?1:0,e.specularEncoding=t.specularEncoding||"linear",e.sheenEncoding=t.sheenEncoding||"linear",e.aoMapUv=t.aoUvSet,e.aoDetail=!!t.aoMap,e.diffuseDetail=!!t.diffuseMap,e.normalDetail=!!t.normalMap,e.diffuseDetailMode=t.diffuseDetailMode,e.aoDetailMode=t.aoDetailMode,e.clearCoatTint=u(t.clearCoat,1)?0:1,e.clearCoatGloss=!!t.clearCoatGloss,e.clearCoatGlossTint=1!==t.clearCoatGloss?1:0,e.iorTint=u(t.refractionIndex,1/1.5)?0:1,e.iridescenceTint=1!==t.iridescence?1:0,e.glossInvert=t.glossInvert,e.sheenGlossInvert=t.sheenGlossInvert,e.clearCoatGlossInvert=t.clearCoatGlossInvert,e.useSpecularColor=l,e.litOptions.separateAmbient=!1,e.litOptions.customFragmentShader=t.customFragmentShader,e.litOptions.pixelSnap=t.pixelSnap,e.litOptions.ambientSH=!!t.ambientSH,e.litOptions.twoSidedLighting=t.twoSidedLighting,e.litOptions.occludeSpecular=t.occludeSpecular,e.litOptions.occludeSpecularFloat=1!==t.occludeSpecularIntensity,e.litOptions.useMsdf=!!t.msdfMap,e.litOptions.msdfTextAttribute=!!t.msdfTextAttribute,e.litOptions.alphaToCoverage=t.alphaToCoverage,e.litOptions.opacityFadesSpecular=t.opacityFadesSpecular,e.litOptions.opacityDither=t.opacityDither,e.litOptions.cubeMapProjection=t.cubeMapProjection,e.litOptions.occludeDirect=t.occludeDirect,e.litOptions.useSpecular=o,e.litOptions.useSpecularityFactor=(c||!!t.specularityFactorMap)&&t.useMetalnessSpecularColor,e.litOptions.enableGGXSpecular=t.enableGGXSpecular,e.litOptions.fresnelModel=t.fresnelModel,e.litOptions.useRefraction=(t.refraction||!!t.refractionMap)&&(t.useDynamicRefraction||!!e.litOptions.reflectionSource),e.litOptions.useClearCoat=!!t.clearCoat,e.litOptions.useSheen=t.useSheen,e.litOptions.useIridescence=t.useIridescence&&0!==t.iridescence,e.litOptions.useMetalness=t.useMetalness,e.litOptions.useDynamicRefraction=t.useDynamicRefraction,e.litOptions.dispersion=t.dispersion>0}_updateEnvOptions(e,t,s,i){e.litOptions.fog=t.useFog?i.fog:eo,e.litOptions.gamma=i.shaderOutputGamma,e.litOptions.toneMap=t.useTonemap?i.toneMapping:6;var n=!1;if(t.envAtlas&&t.cubeMap?(e.litOptions.reflectionSource="envAtlasHQ",e.litOptions.reflectionEncoding=t.envAtlas.encoding,e.litOptions.reflectionCubemapEncoding=t.cubeMap.encoding):t.envAtlas?(e.litOptions.reflectionSource="envAtlas",e.litOptions.reflectionEncoding=t.envAtlas.encoding):t.cubeMap?(e.litOptions.reflectionSource="cubeMap",e.litOptions.reflectionEncoding=t.cubeMap.encoding):t.sphereMap?(e.litOptions.reflectionSource="sphereMap",e.litOptions.reflectionEncoding=t.sphereMap.encoding):t.useSkybox&&s.envAtlas&&s.skybox?(e.litOptions.reflectionSource="envAtlasHQ",e.litOptions.reflectionEncoding=s.envAtlas.encoding,e.litOptions.reflectionCubemapEncoding=s.skybox.encoding,n=!0):t.useSkybox&&s.envAtlas?(e.litOptions.reflectionSource="envAtlas",e.litOptions.reflectionEncoding=s.envAtlas.encoding,n=!0):t.useSkybox&&s.skybox?(e.litOptions.reflectionSource="cubeMap",e.litOptions.reflectionEncoding=s.skybox.encoding,n=!0):(e.litOptions.reflectionSource=null,e.litOptions.reflectionEncoding=null),t.ambientSH)e.litOptions.ambientSource="ambientSH",e.litOptions.ambientEncoding=null;else{var a=t.envAtlas||(t.useSkybox&&s.envAtlas?s.envAtlas:null);a&&!t.sphereMap?(e.litOptions.ambientSource="envAtlas",e.litOptions.ambientEncoding=a.encoding):(e.litOptions.ambientSource="constant",e.litOptions.ambientEncoding=null)}e.litOptions.skyboxIntensity=n,e.litOptions.useCubeMapRotation=n&&s._skyboxRotationShaderInclude}_updateLightOptions(e,t,s,i,n){if(e.lightMap=!1,e.lightMapChannel="",e.lightMapUv=0,e.lightMapTransform=0,e.litOptions.lightMapWithoutAmbient=!1,e.dirLightMap=!1,i&&(e.litOptions.noShadow=!!(1&i),64&i&&(e.lightMapEncoding=7===t.lightmapPixelFormat?"rgbm":"linear",e.lightMap=!0,e.lightMapChannel="rgb",e.lightMapUv=1,e.lightMapTransform=0,e.litOptions.lightMapWithoutAmbient=!s.lightMap,128&i&&(e.dirLightMap=!0),4096&i&&(e.litOptions.lightMapWithoutAmbient=!1))),s.useLighting){var a=[],r=i?i>>16:1;e.litOptions.lightMaskDynamic=!!(1&r),n&&(Fd.collectLights(0,n[0],a,r),Fd.collectLights(1,n[1],a,r),Fd.collectLights(2,n[2],a,r)),e.litOptions.lights=a}else e.litOptions.lights=[];0===e.litOptions.lights.length&&(e.litOptions.noShadow=!0)}_getMapTransformID(e,t){if(!e)return 0;var s=this._mapXForms[t];s||(s=[],this._mapXForms[t]=s);for(var i=0;i<s.length;i++)if(qd(s[i][0].value,e[0].value)&&qd(s[i][1].value,e[1].value))return i+1;return s.push(e)}constructor(){this._mapXForms=null}}function Yd(){return Yd=Object.assign||function(e){for(var t=1;t<arguments.length;t++){var s=arguments[t];for(var i in s)Object.prototype.hasOwnProperty.call(s,i)&&(e[i]=s[i])}return e},Yd.apply(this,arguments)}function $d(e,t,s){void 0===t&&(t=!0),void 0===s&&(s=!0);var i={};return i[e+"Map"]="texture",i[e+"MapTiling"]="vec2",i[e+"MapOffset"]="vec2",i[e+"MapRotation"]="number",i[e+"MapUv"]="number",t&&(i[e+"MapChannel"]="string",s&&(i[e+"VertexColor"]="boolean",i[e+"VertexColorChannel"]="string")),i}var Kd=Yd({name:"string",chunks:"chunks",mappingFormat:"string",_engine:"boolean",ambient:"rgb"},$d("ao"),$d("aoDetail",!0,!1),{aoDetailMode:"string",diffuse:"rgb"},$d("diffuse"),$d("diffuseDetail",!0,!1),{diffuseDetailMode:"string",specular:"rgb",specularTint:"boolean"},$d("specular"),{occludeSpecular:"enum:occludeSpecular",specularityFactor:"number",specularityFactorTint:"boolean"},$d("specularityFactor"),{useMetalness:"boolean",metalness:"number",enableGGXSpecular:"boolean",anisotropy:"number",metalnessTint:"boolean"},$d("metalness"),{useMetalnessSpecularColor:"boolean",shininess:"number",gloss:"number",glossInvert:"boolean"},$d("gloss"),{clearCoat:"number"},$d("clearCoat"),{clearCoatGloss:"number",clearCoatGlossInvert:"boolean"},$d("clearCoatGloss"),{clearCoatBumpiness:"number"},$d("clearCoatNormal",!1),{useSheen:"boolean",sheen:"rgb"},$d("sheen"),{sheenGloss:"number",sheenGlossInvert:"boolean"},$d("sheenGloss"),{fresnelModel:"number",emissive:"rgb"},$d("emissive"),{emissiveIntensity:"number"},$d("normal",!1),{bumpiness:"number"},$d("normalDetail",!1),{normalDetailMapBumpiness:"number"},$d("height",!0,!1),{heightMapFactor:"number",alphaToCoverage:"boolean",alphaTest:"number",alphaFade:"number",opacity:"number"},$d("opacity"),{opacityFadesSpecular:"boolean",opacityDither:"string",opacityShadowDither:"string",reflectivity:"number",refraction:"number",refractionTint:"boolean"},$d("refraction"),{refractionIndex:"number",dispersion:"number",thickness:"number",thicknessTint:"boolean"},$d("thickness"),{attenuation:"rgb",attenuationDistance:"number",useDynamicRefraction:"boolean",sphereMap:"texture",cubeMap:"cubemap",cubeMapProjection:"number",cubeMapProjectionBox:"boundingbox",useIridescence:"boolean",iridescence:"number",iridescenceTint:"boolean"},$d("iridescence"),{iridescenceThicknessTint:"boolean",iridescenceThicknessMin:"number",iridescenceThicknessMax:"number",iridescenceRefractionIndex:"number"},$d("iridescenceThickness"),$d("light"),{depthTest:"boolean",depthFunc:"enum:depthFunc",depthWrite:"boolean",depthBias:"number",slopeDepthBias:"number",cull:"enum:cull",blendType:"enum:blendType",useFog:"boolean",useLighting:"boolean",useSkybox:"boolean",useTonemap:"boolean",envAtlas:"texture",twoSidedLighting:"boolean"}),Zd=[];for(var Jd in Kd){"texture"===Kd[Jd]&&Zd.push(Jd)}var Qd=[];for(var eu in Kd){"cubemap"===Kd[eu]&&Qd.push(eu)}var tu={},su={},iu=new Set,nu=new mt;class au extends mh{reset(){Object.keys(tu).forEach((e=>{this["_"+e]=tu[e].value()})),this._uniformCache={}}copy(e){return super.copy(e),Object.keys(tu).forEach((t=>{this[t]=e[t]})),this.userAttributes=new Map(e.userAttributes),this}setAttribute(e,t){this.userAttributes.set(t,e)}_setParameter(e,t){iu.add(e),this.setParameter(e,t)}_setParameters(e){e.forEach((e=>{this._setParameter(e.name,e.value)}))}_processParameters(e){var t=this[e];t.forEach((e=>{iu.has(e)||delete this.parameters[e]})),this[e]=iu,(iu=t).clear()}_updateMap(e){var t=e+"Map",s=this[t];if(s){this._setParameter("texture_"+t,s);var i=t+"Transform",n=this.getUniform(i);n&&this._setParameters(n)}}_allocUniform(e,t){var s=this._uniformCache[e];return s||(s=t(),this._uniformCache[e]=s),s}getUniform(e,t,s){return su[e](this,t,s)}updateUniforms(e,t){var s=s=>this.getUniform(s,e,t);for(var i in this._setParameter("material_ambient",s("ambient")),this._setParameter("material_diffuse",s("diffuse")),this._setParameter("material_aoIntensity",this.aoIntensity),this.useMetalness?((!this.metalnessMap||this.metalness<1)&&this._setParameter("material_metalness",this.metalness),this.specularMap&&!this.specularTint||this._setParameter("material_specular",s("specular")),this.specularityFactorMap&&!this.specularityFactorTint||this._setParameter("material_specularityFactor",this.specularityFactor),this._setParameter("material_sheen",s("sheen")),this._setParameter("material_sheenGloss",this.sheenGloss),this._setParameter("material_refractionIndex",this.refractionIndex)):this.specularMap&&!this.specularTint||this._setParameter("material_specular",s("specular")),this.enableGGXSpecular&&this._setParameter("material_anisotropy",this.anisotropy),this.clearCoat>0&&(this._setParameter("material_clearCoat",this.clearCoat),this._setParameter("material_clearCoatGloss",this.clearCoatGloss),this._setParameter("material_clearCoatBumpiness",this.clearCoatBumpiness)),this._setParameter("material_gloss",this.gloss),this._setParameter("material_emissive",s("emissive")),this._setParameter("material_emissiveIntensity",this.emissiveIntensity),this.refraction>0&&this._setParameter("material_refraction",this.refraction),this.dispersion>0&&this._setParameter("material_dispersion",this.dispersion),this.useDynamicRefraction&&(this._setParameter("material_thickness",this.thickness),this._setParameter("material_attenuation",s("attenuation")),this._setParameter("material_invAttenuationDistance",0===this.attenuationDistance?0:1/this.attenuationDistance)),this.useIridescence&&(this._setParameter("material_iridescence",this.iridescence),this._setParameter("material_iridescenceRefractionIndex",this.iridescenceRefractionIndex),this._setParameter("material_iridescenceThicknessMin",this.iridescenceThicknessMin),this._setParameter("material_iridescenceThicknessMax",this.iridescenceThicknessMax)),this._setParameter("material_opacity",this.opacity),!1===this.opacityFadesSpecular&&this._setParameter("material_alphaFade",this.alphaFade),this.occludeSpecular&&this._setParameter("material_occludeSpecularIntensity",this.occludeSpecularIntensity),1===this.cubeMapProjection&&this._setParameter(s("cubeMapProjectionBox")),Gd)this._updateMap(i);this.ambientSH&&this._setParameter("ambientSH[0]",this.ambientSH),this.normalMap&&this._setParameter("material_bumpiness",this.bumpiness),this.normalMap&&this.normalDetailMap&&this._setParameter("material_normalDetailMapBumpiness",this.normalDetailMapBumpiness),this.heightMap&&this._setParameter("material_heightMapFactor",s("heightMapFactor")),this.envAtlas&&this.cubeMap?(this._setParameter("texture_envAtlas",this.envAtlas),this._setParameter("texture_cubeMap",this.cubeMap)):this.envAtlas?this._setParameter("texture_envAtlas",this.envAtlas):this.cubeMap?this._setParameter("texture_cubeMap",this.cubeMap):this.sphereMap&&this._setParameter("texture_sphereMap",this.sphereMap),this._setParameter("material_reflectivity",this.reflectivity),this._processParameters("_activeParams"),super.updateUniforms(e,t)}updateEnvUniforms(e,t){!(this.envAtlas||this.cubeMap||this.sphereMap)&&this.useSkybox&&(t.envAtlas&&t.skybox?(this._setParameter("texture_envAtlas",t.envAtlas),this._setParameter("texture_cubeMap",t.skybox)):t.envAtlas?this._setParameter("texture_envAtlas",t.envAtlas):t.skybox&&this._setParameter("texture_cubeMap",t.skybox)),this._processParameters("_activeLightingParams")}getShaderVariant(e){var{device:t,scene:s,pass:i,objDefs:n,sortedLights:a,cameraShaderParams:r}=e;this.updateEnvUniforms(t,s);var o=Ao.get(t).getByIndex(i),l=2===i||3===i||1===i||o.isShadow,h=l?jd.optionsContextMin:jd.optionsContext;h.defines=ko(this,e),l?this.shaderOptBuilder.updateMinRef(h,s,this,n,i,a):this.shaderOptBuilder.updateRef(h,s,r,this,n,i,a),this.onUpdateShader&&(h=this.onUpdateShader(h));var c=new go(e.viewUniformFormat,e.viewBindGroupFormat,e.vertexFormat),d=wo(t);d.register("standard",jd);var u=d.getProgram("standard",h,c,this.userId);return this._dirtyShader=!1,u}destroy(){for(var e in this._assetReferences)this._assetReferences[e]._unbind();this._assetReferences=null,super.destroy()}constructor(){super(),this.userAttributes=new Map,this._assetReferences={},this._activeParams=new Set,this._activeLightingParams=new Set,this.shaderOptBuilder=new Xd,this.reset()}}au.TEXTURE_PARAMETERS=Zd,au.CUBEMAP_PARAMETERS=Qd;var ru=(e,t)=>{su[e]=t},ou=(e,t,s,i)=>{Object.defineProperty(au.prototype,e,{get:i||function(){return this["_"+e]},set:s}),tu[e]={value:t}},lu=e=>{var t="_"+e.name,s=e.dirtyShaderFunc||(()=>!0);ou(e.name,(()=>e.defaultValue),(function(e){var i=this[t];i!==e&&(this._dirtyShader=this._dirtyShader||s(i,e),this[t]=e)}),e.getterFunc)},hu=e=>{var t="_"+e.name,s=e.dirtyShaderFunc||(()=>!0);ou(e.name,(()=>e.defaultValue.clone()),(function(e){var i=this[t];i.equals(e)||(this._dirtyShader=this._dirtyShader||s(i,e),this[t]=i.copy(e))}),e.getterFunc)},cu=e=>e.defaultValue&&e.defaultValue.clone?hu(e):lu(e);function du(e,t,s,i){void 0===t&&(t="rgb"),void 0===s&&(s=!0),void 0===i&&(i=0),Gd[e]=t.length||-1,cu({name:e+"Map",defaultValue:null,dirtyShaderFunc:(e,t)=>!!e!=!!t||e&&(e.type!==t.type||e.format!==t.format)}),cu({name:e+"MapTiling",defaultValue:new wt(1,1)}),cu({name:e+"MapOffset",defaultValue:new wt(0,0)}),cu({name:e+"MapRotation",defaultValue:0}),cu({name:e+"MapUv",defaultValue:i}),t&&(cu({name:e+"MapChannel",defaultValue:t}),s&&(cu({name:e+"VertexColor",defaultValue:!1}),cu({name:e+"VertexColorChannel",defaultValue:t})));var n=e+"MapTiling",a=e+"MapOffset",r=e+"MapRotation",o=e+"MapTransform";ru(o,((e,t,s)=>{var i=e[n],l=e[a],h=e[r];if(1===i.x&&1===i.y&&0===l.x&&0===l.y&&0===h)return null;var c=e._allocUniform(o,(()=>[{name:"texture_"+o+"0",value:new Float32Array(3)},{name:"texture_"+o+"1",value:new Float32Array(3)}])),d=Math.cos(h*pt.DEG_TO_RAD),u=Math.sin(h*pt.DEG_TO_RAD),p=c[0].value;p[0]=d*i.x,p[1]=-u*i.y,p[2]=l.x;var m=c[1].value;return m[0]=u*i.x,m[1]=d*i.y,m[2]=1-i.y-l.y,c}))}function uu(e,t){cu({name:e,defaultValue:t,getterFunc:function(){return this._dirtyShader=!0,this["_"+e]}}),ru(e,((t,s,i)=>{var n=t._allocUniform(e,(()=>new Float32Array(3))),a=t[e];return nu.linear(a),n[0]=nu.r,n[1]=nu.g,n[2]=nu.b,n}))}function pu(e,t,s){cu({name:e,defaultValue:t,dirtyShaderFunc:(e,t)=>(0===e||1===e)!=(0===t||1===t)}),ru(e,s)}function mu(e,t){cu({name:e,defaultValue:null,dirtyShaderFunc:(e,t)=>!!e==!!t}),ru(e,t)}function fu(e,t){cu({name:e,defaultValue:t})}!function(){uu("ambient",new mt(1,1,1)),uu("diffuse",new mt(1,1,1)),uu("specular",new mt(0,0,0)),uu("emissive",new mt(0,0,0)),uu("sheen",new mt(1,1,1)),uu("attenuation",new mt(1,1,1)),pu("emissiveIntensity",1),pu("specularityFactor",1),pu("sheenGloss",0),pu("gloss",.25),pu("aoIntensity",1),pu("heightMapFactor",1,((e,t,s)=>.025*e.heightMapFactor)),pu("opacity",1),pu("alphaFade",1),pu("alphaTest",0),pu("bumpiness",1),pu("normalDetailMapBumpiness",1),pu("reflectivity",1),pu("occludeSpecularIntensity",1),pu("refraction",0),pu("refractionIndex",1/1.5),pu("dispersion",0),pu("thickness",0),pu("attenuationDistance",0),pu("metalness",1),pu("anisotropy",0),pu("clearCoat",0),pu("clearCoatGloss",1),pu("clearCoatBumpiness",1),pu("aoUvSet",0,null),pu("iridescence",0),pu("iridescenceRefractionIndex",1/1.5),pu("iridescenceThicknessMin",0),pu("iridescenceThicknessMax",0),mu("ambientSH"),mu("cubeMapProjectionBox",((e,t,s)=>{var i=e._allocUniform("cubeMapProjectionBox",(()=>[{name:"envBoxMin",value:new Float32Array(3)},{name:"envBoxMax",value:new Float32Array(3)}])),n=e.cubeMapProjectionBox.getMin(),a=i[0].value;a[0]=n.x,a[1]=n.y,a[2]=n.z;var r=e.cubeMapProjectionBox.getMax(),o=i[1].value;return o[0]=r.x,o[1]=r.y,o[2]=r.z,i})),fu("specularTint",!1),fu("specularityFactorTint",!1),fu("useMetalness",!1),fu("useMetalnessSpecularColor",!1),fu("useSheen",!1),fu("enableGGXSpecular",!1),fu("occludeDirect",!1),fu("opacityFadesSpecular",!0),fu("occludeSpecular",1),fu("fresnelModel",2),fu("useDynamicRefraction",!1),fu("cubeMapProjection",0),fu("customFragmentShader",null),fu("useFog",!0),fu("useLighting",!0),fu("useTonemap",!0),fu("useSkybox",!0),fu("forceUv1",!1),fu("pixelSnap",!1),fu("twoSidedLighting",!1),fu("nineSlicedMode",void 0),fu("msdfTextAttribute",!1),fu("useIridescence",!1),fu("glossInvert",!1),fu("sheenGlossInvert",!1),fu("clearCoatGlossInvert",!1),fu("opacityDither",uo),fu("opacityShadowDither",uo),du("diffuse"),du("specular"),du("emissive"),du("thickness","g"),du("specularityFactor","g"),du("normal",""),du("metalness","g"),du("gloss","g"),du("opacity","a"),du("refraction","g"),du("height","g",!1),du("ao","g"),du("light","rgb",!0,1),du("msdf",""),du("diffuseDetail","rgb",!1),du("normalDetail",""),du("aoDetail","g",!1),du("clearCoat","g"),du("clearCoatGloss","g"),du("clearCoatNormal",""),du("sheen","rgb"),du("sheenGloss","g"),du("iridescence","g"),du("iridescenceThickness","g"),fu("diffuseDetailMode","mul"),fu("aoDetailMode","mul"),mu("cubeMap"),mu("sphereMap"),mu("envAtlas");var e=[null,null,null,null,null,null];ou("prefilteredCubemaps",(()=>e.slice()),(function(e){var t=this._prefilteredCubemaps;e=e||[];for(var s=!1,i=!0,n=0;n<6;++n){var a=e[n]||null;t[n]!==a&&(t[n]=a,s=!0),i=i&&!!t[n]}s&&(i?this.envAtlas=Md.generatePrefilteredAtlas(t,{target:this.envAtlas}):this.envAtlas&&(this.envAtlas.destroy(),this.envAtlas=null),this._dirtyShader=!0)}),(function(){return this._prefilteredCubemaps}))}();var gu=4/64,vu=.875;class _u extends Kc{constructor(e,t,s,i,n,a){super();var r,o=new yt,l=new yt,h=new yt,c=new yt,d=new yt,u=new yt,p=[],m=[],f=[],g=[],v=[];if(s>0)for(var _=0;_<=i;_++)for(var y=0;y<=n;y++){var x=y/n*2*Math.PI-Math.PI,w=Math.sin(x),b=Math.cos(x);d.set(w*e,-s/2,b*e),c.set(w*t,s/2,b*t),o.lerp(d,c,_/i),l.sub2(c,d).normalize(),u.set(b,0,-w),h.cross(u,l).normalize(),p.push(o.x,o.y,o.z),m.push(h.x,h.y,h.z);var C=y/n,S=_/i;f.push(C,1-S);var A=S;if(S=C,C=(C=A)*vu+gu,S=S*vu+gu,C/=3,g.push(C,1-S),_<i&&y<n){var T=_*(n+1)+y,P=_*(n+1)+(y+1),E=(_+1)*(n+1)+y,k=(_+1)*(n+1)+(y+1);v.push(T,P,E),v.push(P,k,E)}}if(a){for(var M=Math.floor(n/2),I=n,D=s/2,R=0;R<=M;R++)for(var L=R*Math.PI*.5/M,F=Math.sin(L),B=Math.cos(L),O=0;O<=I;O++){var z=2*O*Math.PI/I-Math.PI/2,V=Math.sin(z),N=Math.cos(z)*F,U=B,H=V*F,G=1-O/I,W=1-R/M;p.push(N*t,U*t+D,H*t),m.push(N,U,H),f.push(G,1-W),G=G*vu+gu,W=W*vu+gu,G/=3,W/=3,G+=1/3,g.push(G,1-W)}r=(i+1)*(n+1);for(var j=0;j<M;++j)for(var q=0;q<I;++q){var X=j*(I+1)+q,Y=X+I+1;v.push(r+X+1,r+Y,r+X),v.push(r+X+1,r+Y+1,r+Y)}for(var $=0;$<=M;$++)for(var K=.5*Math.PI+$*Math.PI*.5/M,Z=Math.sin(K),J=Math.cos(K),Q=0;Q<=I;Q++){var ee=2*Q*Math.PI/I-Math.PI/2,te=Math.sin(ee),se=Math.cos(ee)*Z,ie=J,ne=te*Z,ae=1-Q/I,re=1-$/M;p.push(se*t,ie*t-D,ne*t),m.push(se,ie,ne),f.push(ae,1-re),ae=ae*vu+gu,re=re*vu+gu,ae/=3,re/=3,ae+=2/3,g.push(ae,1-re)}r=(i+1)*(n+1)+(I+1)*(M+1);for(var oe=0;oe<M;++oe)for(var le=0;le<I;++le){var he=oe*(I+1)+le,ce=he+I+1;v.push(r+he+1,r+ce,r+he),v.push(r+he+1,r+ce+1,r+ce)}}else{if(r=(i+1)*(n+1),e>0)for(var de=0;de<n;de++){var ue=de/n*2*Math.PI,pe=Math.sin(ue),me=-s/2,fe=Math.cos(ue),ge=1-(pe+1)/2,ve=(fe+1)/2;p.push(pe*e,me,fe*e),m.push(0,-1,0),f.push(ge,1-ve),ge=ge*vu+gu,ve=ve*vu+gu,ge/=3,ve/=3,ge+=1/3,g.push(ge,1-ve),de>1&&v.push(r,r+de,r+de-1)}if(r+=n,t>0)for(var _e=0;_e<n;_e++){var ye=_e/n*2*Math.PI,xe=Math.sin(ye),we=s/2,be=Math.cos(ye),Ce=1-(xe+1)/2,Se=(be+1)/2;p.push(xe*t,we,be*t),m.push(0,1,0),f.push(Ce,1-Se),Ce=Ce*vu+gu,Se=Se*vu+gu,Ce/=3,Se/=3,Ce+=2/3,g.push(Ce,1-Se),_e>1&&v.push(r,r+_e-1,r+_e)}}this.positions=p,this.normals=m,this.uvs=f,this.uvs1=g,this.indices=v}}class yu extends _u{constructor(e={}){var t,s,i,n,a=null!=(t=e.radius)?t:.3;super(a,a,(null!=(s=e.height)?s:1)-2*a,null!=(i=e.heightSegments)?i:1,null!=(n=e.sides)?n:20,!0),e.calculateTangents&&(this.tangents=$c(this.positions,this.normals,this.uvs,this.indices))}}class xu extends _u{constructor(e={}){var t,s,i,n,a;super(null!=(t=e.baseRadius)?t:.5,null!=(s=e.peakRadius)?s:0,null!=(i=e.height)?i:1,null!=(n=e.heightSegments)?n:5,null!=(a=e.capSegments)?a:18,!1),e.calculateTangents&&(this.tangents=$c(this.positions,this.normals,this.uvs,this.indices))}}class wu extends _u{constructor(e={}){var t,s,i,n,a=null!=(t=e.radius)?t:.5;super(a,a,null!=(s=e.height)?s:1,null!=(i=e.heightSegments)?i:5,null!=(n=e.capSegments)?n:20,!1),e.calculateTangents&&(this.tangents=$c(this.positions,this.normals,this.uvs,this.indices))}}class bu extends Kc{constructor(e={}){var t;super();for(var s,i,n=null!=(t=e.halfExtents)?t:new wt(.5,.5),a=null!=(s=e.widthSegments)?s:5,r=null!=(i=e.lengthSegments)?i:5,o=[],l=[],h=[],c=[],d=0,u=0;u<=a;u++)for(var p=0;p<=r;p++){var m=-n.x+2*n.x*u/a,f=-(-n.y+2*n.y*p/r),g=u/a,v=p/r;o.push(m,0,f),l.push(0,1,0),h.push(g,1-v),u<a&&p<r&&(c.push(d+r+1,d+1,d),c.push(d+r+1,d+r+2,d+1)),d++}this.positions=o,this.normals=l,this.uvs=h,this.uvs1=h,this.indices=c,e.calculateTangents&&(this.tangents=$c(o,l,h,c))}}class Cu extends Kc{constructor(e={}){var t;super();for(var s,i,n,a,r=null!=(t=e.tubeRadius)?t:.2,o=null!=(s=e.ringRadius)?s:.3,l=(null!=(i=e.sectorAngle)?i:360)*pt.DEG_TO_RAD,h=null!=(n=e.segments)?n:30,c=null!=(a=e.sides)?a:20,d=[],u=[],p=[],m=[],f=0;f<=c;f++)for(var g=0;g<=h;g++){var v=Math.cos(l*g/h)*(o+r*Math.cos(2*Math.PI*f/c)),_=Math.sin(2*Math.PI*f/c)*r,y=Math.sin(l*g/h)*(o+r*Math.cos(2*Math.PI*f/c)),x=Math.cos(l*g/h)*Math.cos(2*Math.PI*f/c),w=Math.sin(2*Math.PI*f/c),b=Math.sin(l*g/h)*Math.cos(2*Math.PI*f/c),C=f/c,S=1-g/h;if(d.push(v,_,y),u.push(x,w,b),p.push(C,1-S),f<c&&g<h){var A=f*(h+1)+g,T=(f+1)*(h+1)+g,P=f*(h+1)+(g+1),E=(f+1)*(h+1)+(g+1);m.push(A,T,P),m.push(T,E,P)}}this.positions=d,this.normals=u,this.uvs=p,this.uvs1=p,this.indices=m,e.calculateTangents&&(this.tangents=$c(d,u,p,m))}}class Su{destroy(){this.clearCache()}register(e,t){this._generators.has(e)||this._generators.set(e,t)}unregister(e){this._generators.has(e)&&this._generators.delete(e)}isRegistered(e){return this._generators.has(e)}generateShaderDefinition(e,t,s,i){var n=this.definitionsCache.get(s);if(!n){var a,r,o;(null==(a=i.litOptions)?void 0:a.lights)&&(o=i.litOptions.lights,i.litOptions.lights=o.map((e=>{var t=e.clone?e.clone():e;return t.key=e.key,t}))),this.storeNewProgram(t,i),(null==(r=i.litOptions)?void 0:r.lights)&&(i.litOptions.lights=o);var l,h=this._device;(n=e.createShaderDefinition(h,i)).name=null!=(l=n.name)?l:i.pass?t+"-pass:"+i.pass:t,this.definitionsCache.set(s,n)}return n}getCachedShader(e){return this.processedCache.get(e)}setCachedShader(e,t){this.processedCache.set(e,t)}getProgram(e,t,s,i){var n=this._generators.get(e);if(!n)return null;var a=Ki(n.generateKey(t)),r=a+"#"+Ki(s.generateKey(this._device)),o=this.getCachedShader(r);if(!o){var l,h=this.generateShaderDefinition(n,e,a,t),c="";void 0!==t.pass&&(c="-"+(l=Ao.get(this._device).getByIndex(t.pass)).name),this._device.fire("shader:generate",{userMaterialId:i,shaderPassInfo:l,definition:h});var d={name:""+h.name+c+"-proc",attributes:h.attributes,vshader:h.vshader,vincludes:h.vincludes,fincludes:h.fincludes,fshader:h.fshader,processingOptions:s,shaderLanguage:h.shaderLanguage,meshUniformBufferFormat:h.meshUniformBufferFormat,meshBindGroupFormat:h.meshBindGroupFormat};o=new Ha(this._device,d),this.setCachedShader(r,o)}return o}storeNewProgram(e,t){var s={};if("standard"===e){var i=this._getDefaultStdMatOptions(t.pass);for(var n in t)(t.hasOwnProperty(n)&&i[n]!==t[n]||"pass"===n)&&(s[n]=t[n]);for(var a in t.litOptions)s[a]=t.litOptions[a]}else s=t;this._programsCollection.push(JSON.stringify({name:e,options:s}))}dumpPrograms(){var e="let device = pc.app ? pc.app.graphicsDevice : pc.Application.getApplication().graphicsDevice;\n";e+="let shaders = [",this._programsCollection[0]&&(e+="\n\t"+this._programsCollection[0]);for(var t=1;t<this._programsCollection.length;++t)e+=",\n\t"+this._programsCollection[t];e+="\n];\n",e+="pc.getProgramLibrary(device).precompile(shaders);\n",e+='if (pc.version != "2.5.1" || pc.revision != "'+je+'")\n',e+='\tconsole.warn("precompile-shaders.js: engine version mismatch, rebuild shaders lib with current engine");';var s=document.createElement("a");s.setAttribute("href","data:text/plain;charset=utf-8,"+encodeURIComponent(e)),s.setAttribute("download","precompile-shaders.js"),s.style.display="none",document.body.appendChild(s),s.click(),document.body.removeChild(s)}clearCache(){this._isClearingCache=!0,this.processedCache.forEach((e=>{e.destroy()})),this.processedCache.clear(),this._isClearingCache=!1}removeFromCache(e){this._isClearingCache||this.processedCache.forEach(((t,s)=>{e===t&&this.processedCache.delete(s)}))}_getDefaultStdMatOptions(e){var t=Ao.get(this._device).getByIndex(e);return 2===e||3===e||1===e||t.isShadow?this._defaultStdMatOptionMin:this._defaultStdMatOption}precompile(e){if(e)for(var t=new Array(e.length),s=0;s<e.length;s++){if("standard"===e[s].name){var i=e[s].options,n=this._getDefaultStdMatOptions(i.pass);for(var a in n)n.hasOwnProperty(a)&&void 0===i[a]&&(i[a]=n[a])}t[s]=this.getProgram(e[s].name,e[s].options)}this._precached=!0}constructor(e,t){this.processedCache=new Map,this.definitionsCache=new Map,this._generators=new Map,this._device=e,this._isClearingCache=!1,this._precached=!1,this._programsCollection=[],this._defaultStdMatOption=new Ud,this._defaultStdMatOptionMin=new Ud;var s=new ol;t.shaderOptBuilder.updateRef(this._defaultStdMatOption,{},s,t,null,[],0,null),t.shaderOptBuilder.updateMinRef(this._defaultStdMatOptionMin,{},t,null,4,null),e.on("destroy:shader",(e=>{this.removeFromCache(e)}))}}var Au=new Et,Tu=new kt,Pu=new Ft,Eu=new Ft,ku=new mt(1,1,0,.4),Mu=.28209479177387814;class Iu{constructor(e,t,s,i,n){var a=e.getProp("x"),r=e.getProp("y"),o=e.getProp("z"),l=e.getProp("rot_1"),h=e.getProp("rot_2"),c=e.getProp("rot_3"),d=e.getProp("rot_0"),u=e.getProp("scale_0"),p=e.getProp("scale_1"),m=e.getProp("scale_2"),f=e.getProp("f_dc_0"),g=e.getProp("f_dc_1"),v=e.getProp("f_dc_2"),_=e.getProp("opacity");this.read=e=>{t&&(t.x=a[e],t.y=r[e],t.z=o[e]),s&&s.set(l[e],h[e],c[e],d[e]),i&&i.set(Math.exp(u[e]),Math.exp(p[e]),Math.exp(m[e])),n&&n.set(.5+f[e]*Mu,.5+g[e]*Mu,.5+v[e]*Mu,(e=>{if(e>0)return 1/(1+Math.exp(-e));var t=Math.exp(e);return t/(1+t)})(_[e]))}}}var Du=(e,t,s)=>{Tu.set(s.x,s.y,s.z,s.w).normalize(),e.setTRS(t,Tu,yt.ONE)};class Ru{static calcSplatAabb(e,t,s,i){Du(Au,t,s),Pu.center.set(0,0,0),Pu.halfExtents.set(2*i.x,2*i.y,2*i.z),e.setFromTransformedAabb(Pu,Au)}getProp(e,t){var s,i;return void 0===t&&(t="vertex"),null==(i=this.getElement(t))||null==(s=i.properties.find((t=>t.name===e)))?void 0:s.storage}getElement(e){return this.elements.find((t=>t.name===e))}addProp(e,t){this.getElement("vertex").properties.push({type:"float",name:e,storage:t,byteSize:4})}createIter(e,t,s,i){return new Iu(this,e,t,s,i)}calcAabb(e,t){for(var s,i,n,a,r,o,l=!0,h=this.getProp("x"),c=this.getProp("y"),d=this.getProp("z"),u=this.getProp("scale_0"),p=this.getProp("scale_1"),m=this.getProp("scale_2"),f=0;f<this.numSplats;++f)if(!t||t(f)){var g=2*Math.exp(Math.max(u[f],p[f],m[f])),v=h[f],_=c[f],y=d[f];l?(l=!1,s=v-g,i=_-g,n=y-g,a=v+g,r=_+g,o=y+g):(s=Math.min(s,v-g),i=Math.min(i,_-g),n=Math.min(n,y-g),a=Math.max(a,v+g),r=Math.max(r,_+g),o=Math.max(o,y+g))}return l||(e.center.set(.5*(s+a),.5*(i+r),.5*(n+o)),e.halfExtents.set(.5*(a-s),.5*(r-i),.5*(o-n))),!l}calcAabbExact(e,t){for(var s=new yt,i=new kt,n=new yt,a=this.createIter(s,i,n),r=!0,o=0;o<this.numSplats;++o)t&&!t(o)||(a.read(o),r?(r=!1,Ru.calcSplatAabb(e,s,i,n)):(Ru.calcSplatAabb(Eu,s,i,n),e.add(Eu)));return!r}getCenters(e){for(var t=this.getProp("x"),s=this.getProp("y"),i=this.getProp("z"),n=0;n<this.numSplats;++n)e[3*n+0]=t[n],e[3*n+1]=s[n],e[3*n+2]=i[n]}calcFocalPoint(e,t){var s=this.getProp("x"),i=this.getProp("y"),n=this.getProp("z"),a=this.getProp("scale_0"),r=this.getProp("scale_1"),o=this.getProp("scale_2");e.x=0,e.y=0,e.z=0;for(var l=0,h=0;h<this.numSplats;++h)if(!t||t(h)){var c=1/(1+Math.exp(Math.max(a[h],r[h],o[h])));e.x+=s[h]*c,e.y+=i[h]*c,e.z+=n[h]*c,l+=c}e.mulScalar(1/l)}renderWireframeBounds(e,t){for(var s=new yt,i=new kt,n=new yt,a=new yt,r=new yt,o=this.createIter(s,i,n),l=0;l<this.numSplats;++l)o.read(l),Du(Au,s,i),Au.mul2(t,Au),a.set(-2*n.x,-2*n.y,-2*n.z),r.set(2*n.x,2*n.y,2*n.z),e.immediate.drawWireAlignedBox(a,r,ku,!0,e.defaultDrawLayer,Au)}get isCompressed(){return!1}get shBands(){var e;return null!=(e={9:1,24:2,45:3}[(()=>{for(var e=0;e<45;++e)if(!this.getProp("f_rest_"+e))return e;return 45})()])?e:0}calcMortonOrder(){for(var e=e=>{for(var t=e[0],s=e[0],i=1;i<e.length;i++)e[i]<t&&(t=e[i]),e[i]>s&&(s=e[i]);return{min:t,max:s}},t=(e,t,s)=>{var i=e=>e=153391689&((e=51130563&((e=50393103&((e=4278190335&((e&=1023)^e<<16))^e<<8))^e<<4))^e<<2);return(i(s)<<2)+(i(t)<<1)+i(e)},s=this.getProp("x"),i=this.getProp("y"),n=this.getProp("z"),{min:a,max:r}=e(s),{min:o,max:l}=e(i),{min:h,max:c}=e(n),d=a===r?0:1024/(r-a),u=o===l?0:1024/(l-o),p=h===c?0:1024/(c-h),m=new Map,f=0;f<this.numSplats;f++){var g=t(Math.floor((s[f]-a)*d),Math.floor((i[f]-o)*u),Math.floor((n[f]-h)*p)),v=m.get(g);v?v.push(f):m.set(g,[f])}for(var _=Array.from(m.keys()).sort(((e,t)=>e-t)),y=new Uint32Array(this.numSplats),x=0,w=0;w<_.length;++w)for(var b=m.get(_[w]),C=0;C<b.length;++C)y[x++]=b[C];return y}reorder(e){var t=new Map,s=s=>{for(var i,n=new s.constructor((e=>{if(t.has(e)){var s=t.get(e);return t.delete(e),s}return new ArrayBuffer(e)})(s.byteLength)),a=0;a<e.length;a++)n[a]=s[e[a]];return i=s.buffer,t.set(i.byteLength,i),n};this.elements.forEach((e=>{e.properties.forEach((e=>{e.storage&&(e.storage=s(e.storage))}))}))}reorderData(){this.reorder(this.calcMortonOrder())}constructor(e){this.elements=e,this.numSplats=this.getElement("vertex").count}}var Lu=e=>{var t;void 0===e&&(e={});var s,i,n=null!=(t=e.dither)?t:uo,a=n!==uo,r=new Wc({uniqueName:"SplatMaterial",vertexCode:null!=(s=e.vertex)?s:yo.gsplatVS,fragmentCode:null!=(i=e.fragment)?i:yo.gsplatPS,attributes:{vertex_position:ms,vertex_id_attrib:Ds}});return r.setDefine("DITHER_"+n.toUpperCase(),""),r.cull=0,r.blendType=a?3:4,r.depthWrite=a,r.update(),r};class Fu{destroy(){var e,t,s,i,n,a,r;null==(e=this.colorTexture)||e.destroy(),null==(t=this.transformATexture)||t.destroy(),null==(s=this.transformBTexture)||s.destroy(),null==(i=this.sh1to3Texture)||i.destroy(),null==(n=this.sh4to7Texture)||n.destroy(),null==(a=this.sh8to11Texture)||a.destroy(),null==(r=this.sh12to15Texture)||r.destroy()}createMaterial(e){var t=Lu(e);return t.setParameter("splatColor",this.colorTexture),t.setParameter("transformA",this.transformATexture),t.setParameter("transformB",this.transformBTexture),t.setParameter("numSplats",this.numSplatsVisible),t.setDefine("SH_BANDS",this.shBands),this.sh1to3Texture&&t.setParameter("splatSH_1to3",this.sh1to3Texture),this.sh4to7Texture&&t.setParameter("splatSH_4to7",this.sh4to7Texture),this.sh8to11Texture&&t.setParameter("splatSH_8to11",this.sh8to11Texture),this.sh12to15Texture&&t.setParameter("splatSH_12to15",this.sh12to15Texture),t}evalTextureSize(e){var t=Math.ceil(Math.sqrt(e)),s=Math.ceil(e/t);return new wt(t,s)}createTexture(e,t,s){return new ki(this.device,{name:e,width:s.x,height:s.y,format:t,cubemap:!1,mipmaps:!1,minFilter:0,magFilter:0,addressU:1,addressV:1})}updateColorData(e){var t=this.colorTexture;if(t){for(var s=_t.float2Half,i=t.lock(),n=e.getProp("f_dc_0"),a=e.getProp("f_dc_1"),r=e.getProp("f_dc_2"),o=e.getProp("opacity"),l=.28209479177387814,h=0;h<this.numSplats;++h){var c=n[h]*l+.5,d=a[h]*l+.5,u=r[h]*l+.5,p=1/(1+Math.exp(-o[h]));i[4*h+0]=s(c),i[4*h+1]=s(d),i[4*h+2]=s(u),i[4*h+3]=s(p)}t.unlock()}}updateTransformData(e){var t=_t.float2Half;if(this.transformATexture){for(var s=this.transformATexture.lock(),i=new Float32Array(s.buffer),n=this.transformBTexture.lock(),a=new yt,r=new kt,o=new yt,l=e.createIter(a,r,o),h=0;h<this.numSplats;h++)l.read(h),r.normalize(),r.w<0&&r.mulScalar(-1),i[4*h+0]=a.x,i[4*h+1]=a.y,i[4*h+2]=a.z,s[4*h+3]=t(r.x)|t(r.y)<<16,n[4*h+0]=t(o.x),n[4*h+1]=t(o.y),n[4*h+2]=t(o.z),n[4*h+3]=t(r.z);this.transformATexture.unlock(),this.transformBTexture.unlock()}}updateSHData(e){for(var t,s,i,n,a,r,o=this.sh1to3Texture.lock(),l=null==(t=this.sh4to7Texture)?void 0:t.lock(),h=null==(s=this.sh8to11Texture)?void 0:s.lock(),c=null==(i=this.sh12to15Texture)?void 0:i.lock(),d={1:3,2:8,3:15}[this.shBands],u=((e,t)=>{for(var s=[],i=0;i<t;++i)s.push(e.getProp("f_rest_"+i));return s})(e,3*d),p=2047,m=new Float32Array(1),f=new Uint32Array(m.buffer),g=new Array(3*d).fill(0),v=0;v<e.numSplats;++v){for(var _=0;_<d;++_)g[3*_]=u[_][v],g[3*_+1]=u[_+d][v],g[3*_+2]=u[_+2*d][v];for(var y=g[0],x=1;x<3*d;++x)y=Math.max(y,Math.abs(g[x]));if(0!==y){for(var w=0;w<d;++w)g[3*w+0]=Math.max(0,Math.min(p,Math.floor((g[3*w+0]/y*.5+.5)*p+.5))),g[3*w+1]=Math.max(0,Math.min(1023,Math.floor(1023*(g[3*w+1]/y*.5+.5)+.5))),g[3*w+2]=Math.max(0,Math.min(p,Math.floor((g[3*w+2]/y*.5+.5)*p+.5)));m[0]=y,o[4*v+0]=f[0],o[4*v+1]=g[0]<<21|g[1]<<11|g[2],o[4*v+2]=g[3]<<21|g[4]<<11|g[5],o[4*v+3]=g[6]<<21|g[7]<<11|g[8],this.shBands>1&&(l[4*v+0]=g[9]<<21|g[10]<<11|g[11],l[4*v+1]=g[12]<<21|g[13]<<11|g[14],l[4*v+2]=g[15]<<21|g[16]<<11|g[17],l[4*v+3]=g[18]<<21|g[19]<<11|g[20],this.shBands>2?(h[4*v+0]=g[21]<<21|g[22]<<11|g[23],h[4*v+1]=g[24]<<21|g[25]<<11|g[26],h[4*v+2]=g[27]<<21|g[28]<<11|g[29],h[4*v+3]=g[30]<<21|g[31]<<11|g[32],c[4*v+0]=g[33]<<21|g[34]<<11|g[35],c[4*v+1]=g[36]<<21|g[37]<<11|g[38],c[4*v+2]=g[39]<<21|g[40]<<11|g[41],c[4*v+3]=g[42]<<21|g[43]<<11|g[44]):h[v]=g[21]<<21|g[22]<<11|g[23])}}this.sh1to3Texture.unlock(),null==(n=this.sh4to7Texture)||n.unlock(),null==(a=this.sh8to11Texture)||a.unlock(),null==(r=this.sh12to15Texture)||r.unlock()}constructor(e,t){var s=t.numSplats;this.device=e,this.numSplats=s,this.numSplatsVisible=s,this.centers=new Float32Array(3*t.numSplats),t.getCenters(this.centers),this.aabb=new Ft,t.calcAabb(this.aabb);var i=this.evalTextureSize(s);this.colorTexture=this.createTexture("splatColor",Kt,i),this.transformATexture=this.createTexture("transformA",rs,i),this.transformBTexture=this.createTexture("transformB",Kt,i),this.updateColorData(t),this.updateTransformData(t),this.shBands=t.shBands,this.shBands>0&&(this.sh1to3Texture=this.createTexture("splatSH_1to3",rs,i),this.shBands>1&&(this.sh4to7Texture=this.createTexture("splatSH_4to7",rs,i),this.shBands>2?(this.sh8to11Texture=this.createTexture("splatSH_8to11",rs,i),this.sh12to15Texture=this.createTexture("splatSH_12to15",rs,i)):this.sh8to11Texture=this.createTexture("splatSH_8to11",as,i)),this.updateSHData(t))}}function Bu(){var e,t,s,i,n,a,r,o=!1,l={x:0,y:0,z:0},h={x:0,y:0,z:0},c={x:0,y:0,z:0},d={x:0,y:0,z:0};self.onmessage=u=>{if(u.data.order&&(e=new Uint32Array(u.data.order)),u.data.centers){for(var p=!1,m=(t=new Float32Array(u.data.centers)).length/3,f=0;f<m;++f){var g=t[3*f+0],v=t[3*f+1],_=t[3*f+2];isNaN(g)||isNaN(v)||isNaN(_)||(p?(c.x=Math.min(c.x,g),d.x=Math.max(d.x,g),c.y=Math.min(c.y,v),d.y=Math.max(d.y,v),c.z=Math.min(c.z,_),d.z=Math.max(d.z,_)):(p=!0,c.x=d.x=g,c.y=d.y=v,c.z=d.z=_))}p||(c.x=d.x=c.y=d.y=c.z=d.z=0),o=!0}u.data.hasOwnProperty("mapping")&&(s=u.data.mapping?new Uint32Array(u.data.mapping):null,o=!0),u.data.cameraPosition&&(i=u.data.cameraPosition),u.data.cameraDirection&&(n=u.data.cameraDirection),(()=>{if(e&&t&&0!==t.length&&i&&n){var u=i.x,p=i.y,m=i.z,f=n.x,g=n.y,v=n.z,_=.001;if(!(!o&&Math.abs(u-l.x)<_&&Math.abs(p-l.y)<_&&Math.abs(m-l.z)<_&&Math.abs(f-h.x)<_&&Math.abs(g-h.y)<_&&Math.abs(v-h.z)<_)){var y,x;o=!1,l.x=u,l.y=p,l.z=m,h.x=f,h.y=g,h.z=v;for(var w=0;w<8;++w){var b=((1&w?c.x:d.x)-u)*f+((2&w?c.y:d.y)-p)*g+((4&w?c.z:d.z)-m)*v;0===w?y=x=b:(y=Math.min(y,b),x=Math.max(x,b))}var C=t.length/3,S=Math.max(10,Math.min(20,Math.round(Math.log2(C/4)))),A=2**S+1;(null==a?void 0:a.length)!==C&&(a=new Uint32Array(C)),r&&r.length===A?r.fill(0):r=new Uint32Array(A);for(var T=x-y,P=T<1e-6?0:1/T*2**S,E=0;E<C;++E){var k=3*E,M=(t[k+0]-u)*f+(t[k+1]-p)*g+(t[k+2]-m)*v;if(!isNaN(M)){var I=Math.floor((M-y)*P);a[E]=I,r[I]++}}for(var D=1;D<A;D++)r[D]+=r[D-1];for(var R=0;R<C;R++){var L=a[R],F=--r[L];e[F]=R}var B=t=>a[e[t]]/P+y,O=B(C-1)>=0?(()=>{var e=((e,t,s)=>{for(;e<=t;){var i=t+e>>1,n=s(i);if(n>0)e=i+1;else{if(!(n<0))return i;t=i-1}}return~e})(0,C-1,(e=>-B(e)));return Math.min(C,Math.abs(e))})():C;if(s)for(var z=0;z<C;++z)e[z]=s[e[z]];self.postMessage({order:e.buffer,count:O},[e.buffer]),e=null}}})()}}class Ou extends tt{destroy(){this.worker.terminate(),this.worker=null}init(e,t){this.orderTexture=e,this.centers=t.slice();for(var s=this.orderTexture.lock({mode:1}).buffer.slice(),i=0;i<s.length;++i)s[i]=i;this.orderTexture.unlock(),this.worker.postMessage({order:s,centers:t.buffer},[s,t.buffer])}setMapping(e){if(e){for(var t=new Float32Array(3*e.length),s=0;s<e.length;++s){var i=3*e[s],n=3*s;t[n+0]=this.centers[i+0],t[n+1]=this.centers[i+1],t[n+2]=this.centers[i+2]}this.worker.postMessage({centers:t.buffer,mapping:e.buffer},[t.buffer,e.buffer])}else{var a=this.centers.slice();this.worker.postMessage({centers:a.buffer,mapping:null},[a.buffer])}}setCamera(e,t){this.worker.postMessage({cameraPosition:{x:e.x,y:e.y,z:e.z},cameraDirection:{x:t.x,y:t.y,z:t.z}})}constructor(){super(),this.worker=new Worker(URL.createObjectURL(new Blob(["("+Bu.toString()+")()"],{type:"application/javascript"}))),this.worker.onmessage=e=>{var t=e.data.order,s=this.orderTexture._levels[0].buffer;this.worker.postMessage({order:s},[s]),this.orderTexture._levels[0]=new Uint32Array(t),this.orderTexture.upload(),this.fire("updated",e.data.count)}}}var zu=new Et,Vu=new yt,Nu=new yt,Uu=[0,0];class Hu{destroy(){var e,t,s;null==(e=this.material)||e.destroy(),null==(t=this.meshInstance)||t.destroy(),null==(s=this.sorter)||s.destroy()}clone(){return new Hu(this.splat,this.options)}createMaterial(e){this.material=this.splat.createMaterial(e),this.material.setParameter("splatOrder",this.orderTexture),this.meshInstance&&(this.meshInstance.material=this.material)}updateViewport(){var e=this.splat.device;if(Uu[0]=e.width,Uu[1]=e.height,this.cameras.length>0){var t=this.cameras[0].xr;t&&t.active&&2===t.views.list.length&&(Uu[0]/=2)}this.material.setParameter("viewport",Uu)}sort(e){if(this.sorter){var t=e.getWorldTransform();t.getTranslation(Vu),t.getZ(Nu);var s=this.meshInstance.node.getWorldTransform(),i=zu.invert(s);i.transformPoint(Vu,Vu),i.transformVector(Nu,Nu),Vu.equalsApprox(this.lastCameraPosition)&&Nu.equalsApprox(this.lastCameraDirection)||(this.lastCameraPosition.copy(Vu),this.lastCameraDirection.copy(Nu),this.sorter.setCamera(Vu,Nu))}this.updateViewport()}update(){if(this.cameras.length>0){var e=this.cameras[0];this.sort(e._node),this.cameras.length=0}}constructor(e,t){this.options={},this.sorter=null,this.lastCameraPosition=new yt,this.lastCameraDirection=new yt,this.cameras=[],this.splat=e,t=Object.assign(this.options,t);var s=e.device;this.orderTexture=this.splat.createTexture("splatOrder",as,this.splat.evalTextureSize(this.splat.numSplats)),this.createMaterial(t);for(var i=128,n=Math.ceil(e.numSplats/i)*i/i,a=new Uint32Array(n),r=0;r<n;++r)a[r]=r*i;for(var o=new tn(s,[{semantic:Ds,components:1,type:5,asInt:!0}]),l=new $i(s,o,n,{usage:0,data:a.buffer}),h=new Float32Array(1536),c=new Uint32Array(768),d=0;d<i;++d){h.set([-1,-1,d,1,-1,d,1,1,d,-1,1,d],12*d);var u=4*d;c.set([0+u,1+u,2+u,0+u,2+u,3+u],6*d)}var p=new Wo(s);p.setPositions(h,3),p.setIndices(c),p.update(),this.mesh=p,this.mesh.aabb.copy(e.aabb),this.meshInstance=new sl(this.mesh,this.material),this.meshInstance.setInstancing(l,!0),this.meshInstance.gsplatInstance=this,this.meshInstance.instancingCount=0,this.centers=new Float32Array(e.centers),t.dither&&t.dither!==uo||(this.sorter=new Ou,this.sorter.init(this.orderTexture,this.centers),this.sorter.on("updated",(e=>{this.meshInstance.instancingCount=Math.ceil(e/i),this.material.setParameter("numSplats",e)})))}}var Gu,Wu="KEEP_ASPECT",ju="AUTO";function qu(){return Gu}function Xu(e){Gu=e}class Yu{addRenderPass(e){e.frameUpdate();for(var t=e.beforePasses,s=0;s<t.length;s++){var i=t[s];i.enabled&&this.addRenderPass(i)}e.enabled&&this.renderPasses.push(e);for(var n=e.afterPasses,a=0;a<n.length;a++){var r=n[a];r.enabled&&this.addRenderPass(r)}}reset(){this.renderPasses.length=0}compile(){for(var e=this.renderTargetMap,t=this.renderPasses,s=0;s<t.length;s++){var i=t[s],n=i.renderTarget;if(void 0!==n){var a=e.get(n);if(a){for(var r=i.colorArrayOps.length,o=0;o<r;o++){i.colorArrayOps[o].clear||(a.colorArrayOps[o].store=!0)}i.depthStencilOps.clearDepth||(a.depthStencilOps.storeDepth=!0),i.depthStencilOps.clearStencil||(a.depthStencilOps.storeStencil=!0)}e.set(n,i)}}for(var l=0;l<t.length-1;l++){var h=t[l],c=h.renderTarget,d=t[l+1];c===d.renderTarget&&void 0!==c&&(d.depthStencilOps.clearDepth||d.depthStencilOps.clearStencil||d.colorArrayOps.some((e=>e.clear))||h.afterPasses.length>0||d.beforePasses.length>0||(h._skipEnd=!0,d._skipStart=!0))}for(var u=null,p=null,m=0;m<t.length;m++){var f=t[m],g=f.renderTarget,v=null==g?void 0:g.colorBuffer;if(null==v?void 0:v.cubemap){if(u===v)for(var _=p.colorArrayOps.length,y=0;y<_;y++)p.colorArrayOps[y].mipmaps=!1;u=g.colorBuffer,p=f}else f.requiresCubemaps&&(u=null,p=null)}e.clear()}render(e){this.compile();for(var t=this.renderPasses,s=0;s<t.length;s++)t[s].render()}constructor(){this.renderPasses=[],this.renderTargetMap=new Map}}class $u{destroy(){var e,t;null==(e=this.texture0)||e.destroy(),null==(t=this.texture1)||t.destroy()}constructor(e,t){this.texture0=e,this.texture1=t}}var Ku=new Ti;class Zu{static createTexture(e,t,s,i){return void 0===i&&(i=""),new ki(e,{name:"AreaLightLUT"+i,width:s,height:s,format:t,addressU:1,addressV:1,type:Fs,magFilter:1,minFilter:0,anisotropy:1,mipmaps:!1})}static applyTextures(e,t,s){Ku.remove(e),Ku.get(e,(()=>new $u(t,t===s?null:s))),e.scope.resolve("areaLightsLutTex1").setValue(t),e.scope.resolve("areaLightsLutTex2").setValue(s)}static createPlaceholder(e){var t=Zu.createTexture(e,Kt,2,"placeholder");t.lock().fill(0),t.unlock(),Zu.applyTextures(e,t,t)}static set(e,t,s){function i(e,t,s){var i=Zu.createTexture(e,s,64);return i.lock().set(t),i.unlock(),i}function n(e){for(var t=e.length,s=new Uint16Array(t),i=_t.float2Half,n=0;n<t;n++)s[n]=i(e[n]);return s}var a=s,r=n(t),o=n(a),l=i(e,r,Kt),h=i(e,o,Kt);Zu.applyTextures(e,l,h)}}var Ju="en-US",Qu={en:"en-US",es:"en-ES",zh:"zh-CN","zh-HK":"zh-TW","zh-TW":"zh-HK","zh-MO":"zh-HK",fr:"fr-FR",de:"de-DE",it:"it-IT",ru:"ru-RU",ja:"ja-JP"},ep={};function tp(e,t){for(var s=0,i=e.length;s<i;s++)ep[e[s]]=t}function sp(e){var t=e.indexOf("-");return-1!==t?e.substring(0,t):e}function ip(e,t){if(t[e])return e;var s=Qu[e];if(s&&t[s])return s;var i=sp(e);return t[s=Qu[i]]?s:t[i]?i:Ju}tp(["ja","ko","th","vi","zh","id"],(e=>0)),tp(["fa","hi"],(e=>e>=0&&e<=1?0:1)),tp(["fr","pt"],(e=>e>=0&&e<2?0:1)),tp(["da"],(e=>1===e||!Number.isInteger(e)&&e>=0&&e<=1?0:1)),tp(["de","en","it","el","es","tr","fi","sv","nb","no","ur"],(e=>1===e?0:1)),tp(["ru","uk"],(e=>{if(Number.isInteger(e)){var t=e%10,s=e%100;if(1===t&&11!==s)return 0;if(t>=2&&t<=4&&(s<12||s>14))return 1;if(0===t||t>=5&&t<=9||s>=11&&s<=14)return 2}return 3})),tp(["pl"],(e=>{if(Number.isInteger(e)){if(1===e)return 0;var t=e%10,s=e%100;if(t>=2&&t<=4&&(s<12||s>14))return 1;if(t>=0&&t<=1||t>=5&&t<=9||s>=12&&s<=14)return 2}return 3})),tp(["ar"],(e=>{if(0===e)return 0;if(1===e)return 1;if(2===e)return 2;if(Number.isInteger(e)){var t=e%100;if(t>=3&&t<=10)return 3;if(t>=11&&t<=99)return 4}return 5}));var np=ep[sp(Ju)];function ap(e){return ep[e]||np}var rp=new RegExp("^\\s*(?:(?:[a-z]+[a-z0-9\\-+.]*:)?//|data:|blob:)","i");class op{equals(e){return this.url===e.url&&this.filename===e.filename&&this.hash===e.hash&&this.size===e.size&&this.opt===e.opt&&this.contents===e.contents}constructor(e="",t="",s=null,i=null,n=null,a=null){this.url=e,this.filename=t,this.hash=s,this.size=i,this.opt=n,this.contents=a}}var lp=-1,hp={pvr:"extCompressedTexturePVRTC",dxt:"extCompressedTextureS3TC",etc2:"extCompressedTextureETC",etc1:"extCompressedTextureETC1",basis:"canvas"},cp=["pvr","dxt","etc2","etc1","basis"];class dp extends tt{set id(e){this._id=e}get id(){return this._id}set name(e){if(this._name!==e){var t=this._name;this._name=e,this.fire("name",this,this._name,t)}}get name(){return this._name}set file(e){if(e&&e.variants&&-1!==["texture","textureatlas","bundle"].indexOf(this.type)){var t,s,i=(null==(s=this.registry)||null==(t=s._loader)?void 0:t._app)||qu(),n=null==i?void 0:i.graphicsDevice;if(n)for(var a,r=function(t,s){var r=cp[t];if(e.variants[r]&&n[hp[r]])return e=e.variants[r],"break";if(i.enableBundles){var o=i.bundles.listBundlesForAsset(a);if(o&&o.find((e=>{var t;return null==e||null==(t=e.file)?void 0:t.variants[r]})))return"break"}},o=0,l=cp.length;o<l;o++){if("break"===(a=this,r(o)))break}}var h=this._file,c=e?new op(e.url,e.filename,e.hash,e.size,e.opt,e.contents):null;(!!c!=!!h||c&&!c.equals(h))&&(this._file=c,this.fire("change",this,"file",c,h),this.reload())}get file(){return this._file}set data(e){var t=this._data;this._data=e,e!==t&&(this.fire("change",this,"data",e,t),this.loaded&&this.registry._loader.patch(this,this.registry))}get data(){return this._data}set resource(e){var t=this._resources[0];this._resources[0]=e,this.fire("change",this,"resource",e,t)}get resource(){return this._resources[0]}set resources(e){var t=this._resources;this._resources=e,this.fire("change",this,"resources",e,t)}get resources(){return this._resources}set preload(e){e=!!e,this._preload!==e&&(this._preload=e,this._preload&&!this.loaded&&!this.loading&&this.registry&&this.registry.load(this))}get preload(){return this._preload}set loadFaces(e){e=!!e,this.hasOwnProperty("_loadFaces")&&e===this._loadFaces||(this._loadFaces=e,this.loaded&&this.registry._loader.patch(this,this.registry))}get loadFaces(){return this._loadFaces}getFileUrl(){var e=this.file;if(!e||!e.url)return null;var t=e.url;if(this.registry&&this.registry.prefix&&!rp.test(t)&&(t=this.registry.prefix+t),"script"!==this.type&&e.hash){var s=-1!==t.indexOf("?")?"&":"?";t+=s+"t="+e.hash}return t}getAbsoluteUrl(e){if(e.startsWith("blob:")||e.startsWith("data:"))return e;var t=Ye.getDirectory(this.file.url);return Ye.join(t,e)}getLocalizedAssetId(e){return e=ip(e,this._i18n),this._i18n[e]||null}addLocalizedAssetId(e,t){this._i18n[e]=t,this.fire("add:localized",e,t)}removeLocalizedAssetId(e){var t=this._i18n[e];t&&(delete this._i18n[e],this.fire("remove:localized",e,t))}ready(e,t){t=t||this,this.loaded?e.call(t,this):this.once("load",(s=>{e.call(t,s)}))}reload(){this.loaded&&(this.loaded=!1,this.registry.load(this))}unload(){if(this.loaded||0!==this._resources.length){this.fire("unload",this),this.registry.fire("unload:"+this.id,this);var e=this._resources;this.urlObject&&(URL.revokeObjectURL(this.urlObject),this.urlObject=null),this.resources=[],this.loaded=!1,this.file&&this.registry._loader.clearCache(this.getFileUrl(),this.type);for(var t=0;t<e.length;++t){var s=e[t];s&&s.destroy&&s.destroy()}}}static fetchArrayBuffer(e,t,s,i){var n;void 0===i&&(i=0),(null==s||null==(n=s.file)?void 0:n.contents)?setTimeout((()=>{t(null,s.file.contents)})):Qr.get(e,{cache:!0,responseType:"arraybuffer",retry:i>0,maxRetries:i},t)}constructor(e,t,s,i,n){super(),this._id=lp--,this._name=e||"",this.type=t,this.tags=new lt(this),this._preload=!1,this._file=null,this._data=i||{},this.options=n||{},this._resources=[],this.urlObject=null,this._i18n={},this.loaded=!1,this.loading=!1,this.registry=null,s&&(this.file=s)}}dp.EVENT_LOAD="load",dp.EVENT_UNLOAD="unload",dp.EVENT_REMOVE="remove",dp.EVENT_ERROR="error",dp.EVENT_CHANGE="change",dp.EVENT_PROGRESS="progress",dp.EVENT_ADDLOCALIZED="add:localized",dp.EVENT_REMOVELOCALIZED="remove:localized";class up{addItem(e){var t=e.tags._list;for(var s of t)this.add(s,e)}removeItem(e){var t=e.tags._list;for(var s of t)this.remove(s,e)}add(e,t){this._index[e]&&-1!==this._index[e].list.indexOf(t)||(this._index[e]||(this._index[e]={list:[]},this._key&&(this._index[e].keys={})),this._index[e].list.push(t),this._key&&(this._index[e].keys[t[this._key]]=t))}remove(e,t){if(this._index[e]&&(!this._key||this._index[e].keys[t[this._key]])){var s=this._index[e].list.indexOf(t);-1!==s&&(this._index[e].list.splice(s,1),this._key&&delete this._index[e].keys[t[this._key]],0===this._index[e].list.length&&delete this._index[e])}}find(e){for(var t,s,i,n,a,r={},o=[],l=(e,t)=>this._index[e].list.length-this._index[t].list.length,h=0;h<e.length;h++){if((s=e[h])instanceof Array){if(0===s.length)continue;if(1!==s.length){a=!1;for(var c=0;c<s.length;c++)if(!this._index[s[c]]){a=!0;break}if(a)continue;1===(n=(i=s.slice(0).sort(l)).slice(1)).length&&(n=n[0]);for(var d=0;d<this._index[i[0]].list.length;d++)t=this._index[i[0]].list[d],(this._key?!r[t[this._key]]:-1===o.indexOf(t))&&t.tags.has(n)&&(this._key&&(r[t[this._key]]=!0),o.push(t));continue}s=s[0]}if(s&&"string"==typeof s&&this._index[s])for(var u=0;u<this._index[s].list.length;u++)t=this._index[s].list[u],this._key?r[t[this._key]]||(r[t[this._key]]=!0,o.push(t)):-1===o.indexOf(t)&&o.push(t)}return o}constructor(e=null){this._index={},this._key=e}}class pp extends tt{list(e){void 0===e&&(e={});var t=Array.from(this._assets);return void 0!==e.preload?t.filter((t=>t.preload===e.preload)):t}add(e){var t,s;this._assets.has(e)||(this._assets.add(e),this._idToAsset.set(e.id,e),(null==(t=e.file)?void 0:t.url)&&this._urlToAsset.set(e.file.url,e),this._nameToAsset.has(e.name)||this._nameToAsset.set(e.name,new Set),this._nameToAsset.get(e.name).add(e),e.on("name",this._onNameChange,this),e.registry=this,this._tags.addItem(e),e.tags.on("add",this._onTagAdd,this),e.tags.on("remove",this._onTagRemove,this),this.fire("add",e),this.fire("add:"+e.id,e),(null==(s=e.file)?void 0:s.url)&&this.fire("add:url:"+e.file.url,e),e.preload&&this.load(e))}remove(e){var t,s;if(!this._assets.has(e))return!1;if(this._assets.delete(e),this._idToAsset.delete(e.id),(null==(t=e.file)?void 0:t.url)&&this._urlToAsset.delete(e.file.url),e.off("name",this._onNameChange,this),this._nameToAsset.has(e.name)){var i=this._nameToAsset.get(e.name);i.delete(e),0===i.size&&this._nameToAsset.delete(e.name)}return this._tags.removeItem(e),e.tags.off("add",this._onTagAdd,this),e.tags.off("remove",this._onTagRemove,this),e.fire("remove",e),this.fire("remove",e),this.fire("remove:"+e.id,e),(null==(s=e.file)?void 0:s.url)&&this.fire("remove:url:"+e.file.url,e),!0}get(e){return this._idToAsset.get(Number(e))}getByUrl(e){return this._urlToAsset.get(e)}load(e,t){if(!e.loading&&!e.loaded||(null==t?void 0:t.force)){var s=e.file,i=()=>{this.fire("load",e),this.fire("load:"+e.id,e),s&&s.url&&this.fire("load:url:"+s.url,e),e.fire("load",e)},n=t=>{if(t instanceof Array?e.resources=t:e.resource=t,this._loader.patch(e,this),"bundle"===e.type){for(var n=e.data.assets,a=0;a<n.length;a++){var r=this._idToAsset.get(n[a]);r&&!r.loaded&&this.load(r,{force:!0})}e.resource.loaded?i():(this.fire("load:start",e),this.fire("load:start:"+e.id,e),s&&s.url&&this.fire("load:start:url:"+s.url,e),e.fire("load:start",e),e.resource.on("load",i))}else i()};if(s||"cubemap"===e.type){this.fire("load:start",e),this.fire("load:"+e.id+":start",e),e.loading=!0;var a=e.getFileUrl();if("bundle"===e.type)for(var r=e.data.assets,o=0;o<r.length;o++){var l=this._idToAsset.get(r[o]);l&&(l.loaded||l.resource||l.loading||(l.loading=!0))}this._loader.load(a,e.type,((t,s,i)=>{if(e.loaded=!0,e.loading=!1,t)this.fire("error",t,e),this.fire("error:"+e.id,t,e),e.fire("error",t,e);else{if("script"===e.type){var a=this._loader.getHandler("script");a._cache[e.id]&&a._cache[e.id].parentNode===document.head&&document.head.removeChild(a._cache[e.id]),a._cache[e.id]=i}n(s)}}),e,t)}else{var h=this._loader.open(e.type,e.data);e.loaded=!0,n(h)}}}loadFromUrl(e,t,s){this.loadFromUrlAndFilename(e,null,t,s)}loadFromUrlAndFilename(e,t,s,i){var n=Ye.getBasename(t||e),a={filename:t||n,url:e},r=this.getByUrl(e);if(r){if(r.loaded)return void i(r.loadFromUrlError||null,r)}else r=new dp(n,s,a),this.add(r);var o=e=>{e.once("load",(e=>{"material"===s?this._loadTextures(e,((t,s)=>{i(t,e)})):i(null,e)})),e.once("error",(t=>{t&&(this.loadFromUrlError=t),i(t,e)})),this.load(e)};r.resource?i(null,r):"model"===s?this._loadModel(r,o):o(r)}_loadModel(e,t){var s=e.getFileUrl(),i=Ye.getExtension(s);if(".json"===i||".glb"===i){var n=Ye.getDirectory(s),a=Ye.getBasename(s),r=Ye.join(n,a.replace(i,".mapping.json"));this._loader.load(r,"json",((s,i)=>{s?(e.data={mapping:[]},t(e)):this._loadMaterials(e,i,((s,n)=>{e.data=i,t(e)}))}))}else t(e)}_loadMaterials(e,t,s){for(var i=[],n=0,a=(e,t)=>{this._loadTextures(t,((e,a)=>{i.push(t),i.length===n&&s(null,i)}))},r=0;r<t.mapping.length;r++){var o=t.mapping[r].path;if(o){n++;var l=e.getAbsoluteUrl(o);this.loadFromUrl(l,"material",a)}}0===n&&s(null,i)}_loadTextures(e,t){var s=[],i=0,n=e.data;if("path"===n.mappingFormat){for(var a=(e,n)=>{e&&console.error(e),s.push(n),s.length===i&&t(null,s)},r=Zd,o=0;o<r.length;o++){var l=n[r[o]];if(l&&"string"==typeof l){i++;var h=e.getAbsoluteUrl(l);this.loadFromUrl(h,"texture",a)}}0===i&&t(null,s)}else t(null,s)}_onTagAdd(e,t){this._tags.add(e,t)}_onTagRemove(e,t){this._tags.remove(e,t)}_onNameChange(e,t,s){if(this._nameToAsset.has(s)){var i=this._nameToAsset.get(s);i.delete(e),0===i.size&&this._nameToAsset.delete(s)}this._nameToAsset.has(e.name)||this._nameToAsset.set(e.name,new Set),this._nameToAsset.get(e.name).add(e)}findByTag(){for(var e=arguments.length,t=new Array(e),s=0;s<e;s++)t[s]=arguments[s];return this._tags.find(t)}filter(e){return Array.from(this._assets).filter((t=>e(t)))}find(e,t){var s=this._nameToAsset.get(e);if(!s)return null;for(var i of s)if(!t||i.type===t)return i;return null}findAll(e,t){var s=this._nameToAsset.get(e);if(!s)return[];var i=Array.from(s);return t?i.filter((e=>e.type===t)):i}constructor(e){super(),this._assets=new Set,this._idToAsset=new Map,this._urlToAsset=new Map,this._nameToAsset=new Map,this._tags=new up("_id"),this.prefix=null,this.bundles=null,this._loader=e}}pp.EVENT_LOAD="load",pp.EVENT_ADD="add",pp.EVENT_REMOVE="remove",pp.EVENT_ERROR="error";class mp{_onAssetAdd(e){if("bundle"===e.type){this._idToBundle.set(e.id,e),this._assets.on("load:start:"+e.id,this._onBundleLoadStart,this),this._assets.on("load:"+e.id,this._onBundleLoad,this),this._assets.on("error:"+e.id,this._onBundleError,this);for(var t=e.data.assets,s=0;s<t.length;s++)this._indexAssetInBundle(t[s],e)}else this._assetToBundles.has(e.id)&&this._indexAssetFileUrls(e)}_unbindAssetEvents(e){this._assets.off("load:start:"+e,this._onBundleLoadStart,this),this._assets.off("load:"+e,this._onBundleLoad,this),this._assets.off("error:"+e,this._onBundleError,this)}_indexAssetInBundle(e,t){var s=this._assetToBundles.get(e);s||(s=new Set,this._assetToBundles.set(e,s)),s.add(t);var i=this._assets.get(e);i&&this._indexAssetFileUrls(i)}_indexAssetFileUrls(e){var t=this._getAssetFileUrls(e);if(t)for(var s=0;s<t.length;s++){var i=this._assetToBundles.get(e.id);i&&this._urlsToBundles.set(t[s],i)}}_getAssetFileUrls(e){var t=e.getFileUrl();if(!t)return null;var s=[t=t.split("?")[0]];if("font"===e.type)for(var i=e.data.info.maps.length,n=1;n<i;n++)s.push(t.replace(".png",n+".png"));return s}_onAssetRemove(e){if("bundle"===e.type){this._idToBundle.delete(e.id),this._unbindAssetEvents(e.id);for(var t=e.data.assets,s=0;s<t.length;s++){var i=this._assetToBundles.get(t[s]);if(i&&(i.delete(e),0===i.size))for(var[n,a]of(this._assetToBundles.delete(t[s]),this._urlsToBundles))a===i&&this._urlsToBundles.delete(n)}this._onBundleError("Bundle "+e.id+" was removed")}else{if(!this._assetToBundles.get(e.id))return;this._assetToBundles.delete(e.id);var r=this._getAssetFileUrls(e);if(!r)return;for(var o=0;o<r.length;o++)this._urlsToBundles.delete(r[o])}}_onBundleLoadStart(e){e.resource.on("add",((e,t)=>{var s=this._fileRequests.get(e);if(s){for(var i=0;i<s.length;i++)s[i](null,t);this._fileRequests.delete(e)}}))}_onBundleLoad(e){if(e.resource){if(this._fileRequests)for(var[t,s]of this._fileRequests){var i=this._urlsToBundles.get(t);if(i&&i.has(e)){var n=decodeURIComponent(t),a=void 0,r=void 0;if(e.resource.has(n))r=e.resource.get(n);else{if(!e.resource.loaded)continue;a="Bundle "+e.id+" does not contain URL "+t}for(var o=0;o<s.length;o++)s[o](a,a||r);this._fileRequests.delete(t)}}}else this._onBundleError("Bundle "+e.id+" failed to load")}_onBundleError(e){for(var[t,s]of this._fileRequests){if(!this._findLoadedOrLoadingBundleForUrl(t)){for(var i=0;i<s.length;i++)s[i](e);this._fileRequests.delete(t)}}}_findLoadedOrLoadingBundleForUrl(e){var t=this._urlsToBundles.get(e);if(!t)return null;var s=null;for(var i of t){if(i.loaded&&i.resource)return i;i.loading&&(s=i)}return s}listBundlesForAsset(e){var t=this._assetToBundles.get(e.id);return t?Array.from(t):null}list(){return Array.from(this._idToBundle.values())}hasUrl(e){return this._urlsToBundles.has(e)}urlIsLoadedOrLoading(e){return!!this._findLoadedOrLoadingBundleForUrl(e)}loadUrl(e,t){var s=this._findLoadedOrLoadingBundleForUrl(e);if(s){if(s.loaded){var i=decodeURIComponent(e);if(s.resource.has(i))return void t(null,s.resource.get(i));if(s.resource.loaded)return void t("Bundle "+s.id+" does not contain URL "+e)}var n=this._fileRequests.get(e);n||(n=[],this._fileRequests.set(e,n)),n.push(t)}else t("URL "+e+" not found in any bundles")}destroy(){for(var e of(this._assets.off("add",this._onAssetAdd,this),this._assets.off("remove",this._onAssetRemove,this),this._idToBundle.keys()))this._unbindAssetEvents(e);this._assets=null,this._idToBundle.clear(),this._idToBundle=null,this._assetToBundles.clear(),this._assetToBundles=null,this._urlsToBundles.clear(),this._urlsToBundles=null,this._fileRequests.clear(),this._fileRequests=null}constructor(e){this._idToBundle=new Map,this._assetToBundles=new Map,this._urlsToBundles=new Map,this._fileRequests=new Map,this._assets=e,this._assets.bundles=this,this._assets.on("add",this._onAssetAdd,this),this._assets.on("remove",this._onAssetRemove,this)}}class fp extends tt{add(e){var t=e.id;if(this[t])throw new Error("ComponentSystem name '"+t+"' already registered or not allowed");this[t]=e,this.list.push(e)}remove(e){var t=e.id;if(!this[t])throw new Error("No ComponentSystem named '"+t+"' registered");delete this[t];var s=this.list.indexOf(this[t]);-1!==s&&this.list.splice(s,1)}destroy(){this.off();for(var e=0;e<this.list.length;e++)this.list[e].destroy()}constructor(){super(),this.list=[]}}class gp extends tt{addFile(e,t){this._index.has(e)||(this._index.set(e,t),this.fire("add",e,t))}has(e){return this._index.has(e)}get(e){return this._index.get(e)||null}destroy(){this._index.clear()}set loaded(e){e&&!this._loaded&&(this._loaded=!0,this.fire("load"))}get loaded(){return this._loaded}constructor(...e){super(...e),this._index=new Map,this._loaded=!1}}gp.EVENT_ADD="add",gp.EVENT_LOAD="load";class vp extends tt{pump(e,t){if(e)return this.fire("done"),null;this.bytesReceived+=t.byteLength;var s=new Uint8Array(this.data.length+t.length);for(s.set(this.data),s.set(t,this.data.length),this.data=s;this.readFile(););return this.reader.read().then((e=>{this.pump(e.done,e.value)})).catch((e=>{this.fire("error",e)}))}readFile(){if(!this.headerRead&&this.bytesReceived>this.bytesRead+this.headerSize){this.headerRead=!0;var e=new DataView(this.data.buffer,this.bytesRead,this.headerSize);null!=this.decoder||(this.decoder=new TextDecoder("windows-1252"));var t=this.decoder.decode(e);if(this.fileName=t.substring(0,100).replace(/\0/g,""),this.fileSize=parseInt(t.substring(124,136),8),this.fileType=t.substring(156,157),this.ustarFormat=t.substring(257,263),-1!==this.ustarFormat.indexOf("ustar")){var s=t.substring(345,500).replace(/\0/g,"");s.length>0&&(this.fileName=s.trim()+this.fileName.trim())}this.bytesRead+=512}if(this.headerRead){if(this.bytesReceived<this.bytesRead+this.fileSize)return!1;if(""===this.fileType||"0"===this.fileType){var i=new DataView(this.data.buffer,this.bytesRead,this.fileSize),n={name:this.prefix+this.fileName,size:this.fileSize,data:i};this.fire("file",n)}this.bytesRead+=this.fileSize,this.headerRead=!1;var a=this.bytesRead%this.paddingSize;return 0!==a&&(this.bytesRead+=this.paddingSize-a),!0}return!1}constructor(e,t=""){super(),this.headerSize=512,this.paddingSize=512,this.bytesRead=0,this.bytesReceived=0,this.headerRead=!1,this.reader=null,this.data=new Uint8Array(0),this.decoder=null,this.prefix="",this.fileName="",this.fileSize=0,this.fileType="",this.ustarFormat="",this.prefix=t||"",this.reader=e.body.getReader(),this.reader.read().then((e=>{this.pump(e.done,e.value)})).catch((e=>{this.fire("error",e)}))}}class _p{set maxRetries(e){this._maxRetries=e}get maxRetries(){return this._maxRetries}load(e,t,s){}open(e,t,s){return t}patch(e,t){}constructor(e,t){this.handlerType="",this._maxRetries=0,this._app=e,this.handlerType=t}}class yp extends _p{_fetchRetries(e,t,s){return void 0===s&&(s=0),new Promise(((i,n)=>{var a=()=>{fetch(e,t).then(i).catch((e=>{++s<this.maxRetries?a():n(e)}))};a()}))}load(e,t){"string"==typeof e&&(e={load:e,original:e}),this._fetchRetries(e.load,{mode:"cors",credentials:"include"},this.maxRetries).then((e=>{var s=new gp;t(null,s);var i=new vp(e,this._assets.prefix);i.on("file",(e=>{s.addFile(e.name,e.data)})),i.on("done",(()=>{s.loaded=!0})),i.on("error",(e=>{t(e)}))})).catch((e=>{t(e)}))}open(e,t){return t}constructor(e){super(e,"bundle"),this._assets=e.assets}}class xp{addHandler(e,t){this._handlers[e]=t,t._loader=this}removeHandler(e){delete this._handlers[e]}getHandler(e){return this._handlers[e]}static makeKey(e,t){return e+"-"+t}load(e,t,s,i,n){var a=this._handlers[t];if(a)if(e){var r=xp.makeKey(e,t);if(void 0!==this._cache[r])s(null,this._cache[r]);else if(this._requests[r])this._requests[r].push(s);else{this._requests[r]=[s];var o=this,l=function(e,t){if(e)o._onFailure(r,e);else{if(t.load instanceof DataView){if(a.openBinary){if(!o._requests[r])return;try{var s=a.openBinary(t.load);o._onSuccess(r,s)}catch(e){o._onFailure(r,e)}return}t.load=URL.createObjectURL(new Blob([t.load])),i&&(i.urlObject&&URL.revokeObjectURL(i.urlObject),i.urlObject=t.load)}a.load(t,((e,s,n)=>{if(o._requests[r])if(e)o._onFailure(r,e);else try{o._onSuccess(r,a.open(t.original,s,i),n)}catch(e){o._onFailure(r,e)}}),i)}},h=e.split("?")[0];if(!this._app.enableBundles||!this._app.bundles.hasUrl(h)||n&&n.bundlesIgnore)l(null,{load:e,original:i&&i.file.filename||e});else{if(!this._app.bundles.urlIsLoadedOrLoading(h)){var c,d,u=this._app.bundles.listBundlesForAsset(i);n&&n.bundlesFilter&&(d=n.bundlesFilter(u)),d||(null==u||u.sort(((e,t)=>e.file.size-t.file.size)),d=null==u?void 0:u[0]),d&&(null==(c=this._app.assets)||c.load(d))}this._app.bundles.loadUrl(h,((e,t)=>{l(e,{load:t,original:h})}))}}}else this._loadNull(a,s,i);else s("No resource handler for asset type: '"+t+"' when loading ["+e+"]")}_loadNull(e,t,s){e.load(null,(function(i,n,a){if(i)t(i);else try{t(null,e.open(null,n,s),a)}catch(e){t(e)}}),s)}_onSuccess(e,t,s){null!==t?this._cache[e]=t:delete this._cache[e];for(var i=0;i<this._requests[e].length;i++)this._requests[e][i](null,t,s);delete this._requests[e]}_onFailure(e,t){if(console.error(t),this._requests[e]){for(var s=0;s<this._requests[e].length;s++)this._requests[e][s](t);delete this._requests[e]}}open(e,t){var s=this._handlers[e];return s?s.open(null,t):(console.warn("No resource handler found for: "+e),t)}patch(e,t){var s=this._handlers[e.type];s?s.patch&&s.patch(e,t):console.warn("No resource handler found for: "+e.type)}clearCache(e,t){var s=xp.makeKey(e,t);delete this._cache[s]}getFromCache(e,t){var s=xp.makeKey(e,t);if(this._cache[s])return this._cache[s]}enableRetry(e){for(var t in void 0===e&&(e=5),e=Math.max(0,e)||0,this._handlers)this._handlers[t].maxRetries=e}disableRetry(){for(var e in this._handlers)this._handlers[e].maxRetries=0}destroy(){this._handlers={},this._requests={},this._cache={}}constructor(e){this._handlers={},this._requests={},this._cache={},this._app=e}}class wp{_validate(e){if(!e.header)throw new Error('pc.I18n#addData: Missing "header" field');if(!e.header.version)throw new Error('pc.I18n#addData: Missing "header.version" field');if(1!==e.header.version)throw new Error('pc.I18n#addData: Invalid "header.version" field');if(!e.data)throw new Error('pc.I18n#addData: Missing "data" field');if(!Array.isArray(e.data))throw new Error('pc.I18n#addData: "data" field must be an array');for(var t=0,s=e.data.length;t<s;t++){var i=e.data[t];if(!i.info)throw new Error('pc.I18n#addData: missing "data['+t+'].info" field');if(!i.info.locale)throw new Error('pc.I18n#addData: missing "data['+t+'].info.locale" field');if("string"!=typeof i.info.locale)throw new Error('pc.I18n#addData: "data['+t+'].info.locale" must be a string');if(!i.messages)throw new Error('pc.I18n#addData: missing "data['+t+'].messages" field')}}parse(e){return e.data}}let bp=class extends tt{set assets(e){for(var t={},s=0,i=e.length;s<i;s++){t[e[s]instanceof dp?e[s].id:e[s]]=!0}for(var n=this._assets.length;n--;){var a=this._assets[n];if(!t[a]){this._app.assets.off("add:"+a,this._onAssetAdd,this);var r=this._app.assets.get(a);r&&this._onAssetRemove(r),this._assets.splice(n,1)}}for(var o in t){var l=parseInt(o,10);if(-1===this._assets.indexOf(l)){this._assets.push(l);var h=this._app.assets.get(l);h?this._onAssetAdd(h):this._app.assets.once("add:"+l,this._onAssetAdd,this)}}}get assets(){return this._assets}set locale(e){if(this._locale!==e){var t=sp(e);if("in"!==t||(e=function(e,t){var s=e.indexOf("-");return-1!==s?t+e.substring(s):t}(e,t="id"),this._locale!==e)){var s=this._locale;this._locale=e,this._lang=t,this._pluralFn=ap(this._lang),this.fire("set:locale",e,s)}}}get locale(){return this._locale}static findAvailableLocale(e,t){return ip(e,t)}findAvailableLocale(e){if(this._translations[e])return e;var t=sp(e);return this._findFallbackLocale(e,t)}getText(e,t){var s,i=e;t||(t=this._locale,s=this._lang);var n=this._translations[t];return n||(s||(s=sp(t)),t=this._findFallbackLocale(t,s),n=this._translations[t]),n&&n.hasOwnProperty(e)&&(i=n[e],Array.isArray(i)&&(i=i[0]),null==i&&(i=e)),i}getPluralText(e,t,s){var i,n,a=e;s?n=ap(i=sp(s)):(s=this._locale,i=this._lang,n=this._pluralFn);var r=this._translations[s];if(r||(n=ap(i=sp(s=this._findFallbackLocale(s,i))),r=this._translations[s]),r&&r[e]&&n){var o=n(t);null==(a=r[e][o])&&(a=e)}return a}addData(e){var t;try{t=this._parser.parse(e)}catch(e){return void console.error(e)}for(var s=0,i=t.length;s<i;s++){var n=t[s],a=n.info.locale,r=n.messages;if(!this._translations[a]){this._translations[a]={};var o=sp(a);this._availableLangs[o]||(this._availableLangs[o]=a)}Object.assign(this._translations[a],r),this.fire("data:add",a,r)}}removeData(e){var t;try{t=this._parser.parse(e)}catch(e){return void console.error(e)}for(var s=0,i=t.length;s<i;s++){var n=t[s],a=n.info.locale,r=this._translations[a];if(r){var o=n.messages;for(var l in o)delete r[l];0===Object.keys(r).length&&(delete this._translations[a],delete this._availableLangs[sp(a)]),this.fire("data:remove",a,o)}}}destroy(){this._translations=null,this._availableLangs=null,this._assets=null,this._parser=null,this.off()}_findFallbackLocale(e,t){var s=Qu[e];return s&&this._translations[s]||(s=Qu[t])&&this._translations[s]||(s=this._availableLangs[t])&&this._translations[s]?s:Ju}_onAssetAdd(e){e.on("load",this._onAssetLoad,this),e.on("change",this._onAssetChange,this),e.on("remove",this._onAssetRemove,this),e.on("unload",this._onAssetUnload,this),e.resource&&this._onAssetLoad(e)}_onAssetLoad(e){this.addData(e.resource)}_onAssetChange(e){e.resource&&this.addData(e.resource)}_onAssetRemove(e){e.off("load",this._onAssetLoad,this),e.off("change",this._onAssetChange,this),e.off("remove",this._onAssetRemove,this),e.off("unload",this._onAssetUnload,this),e.resource&&this.removeData(e.resource),this._app.assets.once("add:"+e.id,this._onAssetAdd,this)}_onAssetUnload(e){e.resource&&this.removeData(e.resource)}constructor(e){super(),this.locale=Ju,this._translations={},this._availableLangs={},this._app=e,this._assets=[],this._parser=new wp}};class Cp extends tt{destroy(){this.app=null,this.off()}addSchema(e,t){t&&this._scriptSchemas.set(e,t)}getSchema(e){return this._scriptSchemas.get(e)}add(e){var t=e.__name;return this._scripts.hasOwnProperty(t)?(setTimeout((()=>{if(e.prototype.swap){var s=this._scripts[t],i=this._list.indexOf(s);this._list[i]=e,this._scripts[t]=e,this.fire("swap",t,e),this.fire("swap:"+t,e)}else console.warn("script registry already has '"+t+"' script, define 'swap' method for new script type to enable code hot swapping")})),!1):(this._scripts[t]=e,this._list.push(e),this.fire("add",t,e),this.fire("add:"+t,e),setTimeout((()=>{if(this._scripts.hasOwnProperty(t)&&this.app&&this.app.systems&&this.app.systems.script){var e,s=this.app.systems.script._components,i=[],n=[];for(s.loopIndex=0;s.loopIndex<s.length;s.loopIndex++){var a=s.items[s.loopIndex];if(a._scriptsIndex[t]&&a._scriptsIndex[t].awaiting){a._scriptsData&&a._scriptsData[t]&&(e=a._scriptsData[t].attributes);var r=a.create(t,{preloading:!0,ind:a._scriptsIndex[t].ind,attributes:e});for(var o of(r&&i.push(r),a.scripts))a.initializeAttributes(o)}}for(var l=0;l<i.length;l++)i[l].enabled&&(i[l]._initialized=!0,n.push(i[l]),i[l].initialize&&i[l].initialize());for(var h=0;h<n.length;h++)n[h].enabled&&!n[h]._postInitialized&&(n[h]._postInitialized=!0,n[h].postInitialize&&n[h].postInitialize())}})),!0)}remove(e){var t=e,s=e;if("string"!=typeof s?s=t.__name:t=this.get(s),this.get(s)!==t)return!1;delete this._scripts[s];var i=this._list.indexOf(t);return this._list.splice(i,1),this.fire("remove",s,t),this.fire("remove:"+s,t),!0}get(e){return this._scripts[e]||null}has(e){if("string"==typeof e)return this._scripts.hasOwnProperty(e);if(!e)return!1;var t=e.__name;return this._scripts[t]===e}list(){return this._list}constructor(e){super(),this._scripts={},this._list=[],this._scriptSchemas=new Map,this.app=e}}var Sp=(e,t)=>e.constructor.order-t.constructor.order,Ap=[],Tp=[],Pp=e=>{e.length=0,Tp.push(e)};class Ep extends Il{addComponent(e,t){var s=this._app.systems[e];return s?this.c[e]?null:s.addComponent(this,t):null}removeComponent(e){var t=this._app.systems[e];t&&this.c[e]&&t.removeComponent(this)}findComponent(e){var t=this.findOne((t=>{var s;return null==(s=t.c)?void 0:s[e]}));return t&&t.c[e]}findComponents(e){return this.find((t=>{var s;return null==(s=t.c)?void 0:s[e]})).map((t=>t.c[e]))}findScript(e){var t=this.findOne((t=>{var s,i;return null==(i=t.c)||null==(s=i.script)?void 0:s.has(e)}));return null==t?void 0:t.c.script.get(e)}findScripts(e){return this.find((t=>{var s,i;return null==(i=t.c)||null==(s=i.script)?void 0:s.has(e)})).map((t=>t.c.script.get(e)))}getGuid(){return this._guid||this.setGuid(Xe.create()),this._guid}setGuid(e){var t=this._app._entityIndex;this._guid&&delete t[this._guid],this._guid=e,t[this._guid]=this}_notifyHierarchyStateChanged(e,t){var s=!1;e===this&&0===Ap.length&&(s=!0),e._beingEnabled=!0,e._onHierarchyStateChanged(t),e._onHierarchyStatePostChanged&&Ap.push(e);for(var i=e._children,n=0,a=i.length;n<a;n++)i[n]._enabled&&this._notifyHierarchyStateChanged(i[n],t);if(e._beingEnabled=!1,s){for(var r=0;r<Ap.length;r++)Ap[r]._onHierarchyStatePostChanged();Ap.length=0}}_onHierarchyStateChanged(e){super._onHierarchyStateChanged(e);for(var t=this._getSortedComponents(),s=0;s<t.length;s++){var i=t[s];i.enabled&&(e?i.onEnable():i.onDisable())}Pp(t)}_onHierarchyStatePostChanged(){for(var e=this._getSortedComponents(),t=0;t<e.length;t++)e[t].onPostStateChange();Pp(e)}findByGuid(e){if(this._guid===e)return this;var t=this._app._entityIndex[e];return t&&(t===this||t.isDescendantOf(this))?t:null}destroy(){for(var e in this._destroying=!0,this.c)this.c[e].enabled=!1;for(var t in this.c)this.c[t].system.removeComponent(this);super.destroy(),this._guid&&delete this._app._entityIndex[this._guid],this._destroying=!1}clone(){var e={},t=this._cloneRecursively(e);return e[this.getGuid()]=t,kp(this,this,t,e),t}_getSortedComponents(){var e,t=this.c,s=null!=(e=Tp.pop())?e:[],i=0;for(var n in t)if(t.hasOwnProperty(n)){var a=t[n];i|=0!==a.constructor.order,s.push(a)}return i&&s.length>1&&s.sort(Sp),s}_cloneRecursively(e){var t=new this.constructor(void 0,this._app);for(var s in super._cloneInternal(t),this.c){this.c[s].system.cloneComponent(this,t)}for(var i=0;i<this._children.length;i++){var n=this._children[i];if(n instanceof Ep){var a=n._cloneRecursively(e);t.addChild(a),e[n.getGuid()]=a}}return t}constructor(e,t=qu()){super(e),this.c={},this._destroying=!1,this._guid=null,this._template=!1,this._app=t}}function kp(e,t,s,i){if(t instanceof Ep){var n=t.c;for(var a in n)for(var r=n[a],o=r.system.getPropertiesOfType("entity"),l=0,h=o.length;l<h;l++){var c=o[l].name,d=r[c];if(!!e.findByGuid(d)){var u=i[d].getGuid();u&&(s.c[a][c]=u)}}n.script&&s.script.resolveDuplicatedEntityReferenceProperties(n.script,i),n.render&&s.render.resolveDuplicatedEntityReferenceProperties(n.render,i),n.button&&s.button.resolveDuplicatedEntityReferenceProperties(n.button,i),n.scrollview&&s.scrollview.resolveDuplicatedEntityReferenceProperties(n.scrollview,i),n.scrollbar&&s.scrollbar.resolveDuplicatedEntityReferenceProperties(n.scrollbar,i),n.anim&&s.anim.resolveDuplicatedEntityReferenceProperties(n.anim,i);for(var p=t.children.filter((e=>e instanceof Ep)),m=s.children.filter((e=>e instanceof Ep)),f=0,g=p.length;f<g;f++)kp(e,p[f],m[f],i)}}Ep.EVENT_DESTROY="destroy";class Mp{get loaded(){return!!this.data}get loading(){return this._loading}constructor(e,t){this.data=null,this._loading=!1,this._onLoadedCallbacks=[],this.name=e,this.url=t}}class Ip{destroy(){this._app=null}list(){return this._list}add(e,t){if(this._index.hasOwnProperty(e))return!1;var s=new Mp(e,t),i=this._list.push(s);return this._index[s.name]=i-1,this._urlIndex[s.url]=i-1,!0}find(e){return this._index.hasOwnProperty(e)?this._list[this._index[e]]:null}findByUrl(e){return this._urlIndex.hasOwnProperty(e)?this._list[this._urlIndex[e]]:null}remove(e){if(this._index.hasOwnProperty(e)){var t=this._index[e],s=this._list[t];delete this._urlIndex[s.url],delete this._index[e],this._list.splice(t,1);for(var i=0;i<this._list.length;i++)s=this._list[i],this._index[s.name]=i,this._urlIndex[s.url]=i}}_loadSceneData(e,t,s){var i=this._app,n=e;if("string"==typeof e&&(e=this.findByUrl(n)||this.find(n)||new Mp("Untitled",n)),n=e.url)if(e.loaded)s(null,e);else{if(i.assets&&i.assets.prefix&&!rp.test(n)&&(n=Ye.join(i.assets.prefix,n)),e._onLoadedCallbacks.push(s),!e._loading)i.loader.getHandler("hierarchy").load(n,((s,i)=>{e.data=i,e._loading=!1;for(var n=0;n<e._onLoadedCallbacks.length;n++)e._onLoadedCallbacks[n](s,e);t||(e.data=null),e._onLoadedCallbacks.length=0}));e._loading=!0}else s("Cannot find scene to load")}loadSceneData(e,t){this._loadSceneData(e,!0,t)}unloadSceneData(e){"string"==typeof e&&(e=this.findByUrl(e)),e&&(e.data=null)}_loadSceneHierarchy(e,t,s){this._loadSceneData(e,!1,((e,i)=>{if(e)s&&s(e);else{t&&t(i);var n=this._app;n._preloadScripts(i.data,(()=>{var e=n.loader.getHandler("hierarchy");n.systems.script.preloading=!0;var t=e.open(i.url,i.data);n.systems.script.preloading=!1,n.loader.clearCache(i.url,"hierarchy"),n.root.addChild(t),n.systems.fire("initialize",t),n.systems.fire("postInitialize",t),n.systems.fire("postPostInitialize",t),s&&s(null,t)}))}}))}loadSceneHierarchy(e,t){this._loadSceneHierarchy(e,null,t)}loadSceneSettings(e,t){this._loadSceneData(e,!1,((e,s)=>{e?t&&t(e):(this._app.applySceneSettings(s.data.settings),t&&t(null))}))}changeScene(e,t){var s=this._app;this._loadSceneHierarchy(e,(e=>{for(var{children:t}=s.root;t.length;)t[0].destroy();s.applySceneSettings(e.data.settings)}),t)}loadScene(e,t){var s=this._app,i=s.loader.getHandler("scene");s.assets&&s.assets.prefix&&!rp.test(e)&&(e=Ye.join(s.assets.prefix,e)),i.load(e,((n,a)=>{if(n)t&&t(n);else{s._preloadScripts(a,(()=>{s.systems.script.preloading=!0;var n=i.open(e,a),r=this.findByUrl(e);r&&!r.loaded&&(r.data=a),s.systems.script.preloading=!1,s.loader.clearCache(e,"scene"),s.loader.patch({resource:n,type:"scene"},s.assets),s.root.addChild(n.root),s.systems.rigidbody&&"undefined"!=typeof Ammo&&s.systems.rigidbody.gravity.set(n._gravity.x,n._gravity.y,n._gravity.z),t&&t(null,n)}))}}))}constructor(e){this._list=[],this._index={},this._urlIndex={},this._app=e}}class Dp{get scene(){return qu().scene._stats}get lightmapper(){var e;return null==(e=qu().lightmapper)?void 0:e.stats}get batcher(){var e=qu()._batcher;return e?e._stats:null}constructor(e){this.frame={fps:0,ms:0,dt:0,updateStart:0,updateTime:0,renderStart:0,renderTime:0,physicsStart:0,physicsTime:0,cullTime:0,sortTime:0,skinTime:0,morphTime:0,instancingTime:0,triangles:0,otherPrimitives:0,shaders:0,materials:0,cameras:0,shadowMapUpdates:0,shadowMapTime:0,depthMapTime:0,forwardTime:0,lightClustersTime:0,lightClusters:0,_timeToCountFrames:0,_fpsAccum:0},this.drawCalls={forward:0,depth:0,shadow:0,immediate:0,misc:0,total:0,skinned:0,instanced:0,removedByInstancing:0},this.misc={renderTargetCreationTime:0},this.particles={updatesPerFrame:0,_updatesPerFrame:0,frameTime:0,_frameTime:0},this.shaders=e._shaderStats,this.vram=e._vram,Object.defineProperty(this.vram,"totalUsed",{get:function(){return this.tex+this.vb+this.ib}}),Object.defineProperty(this.vram,"geom",{get:function(){return this.vb+this.ib}})}}class Rp extends tt{init(e){var{assetPrefix:t,batchManager:s,componentSystems:i,elementInput:n,gamepads:a,graphicsDevice:r,keyboard:o,lightmapper:l,mouse:h,resourceHandlers:c,scriptsOrder:d,scriptPrefix:u,soundManager:p,touch:m,xr:f}=e;this.graphicsDevice=r,this._initDefaultMaterial(),this._initProgramLibrary(),this.stats=new Dp(r),this._soundManager=p,this.scene=new Dd(r),this._registerSceneImmediate(this.scene),this.assets=new pp(this.loader),t&&(this.assets.prefix=t),this.bundles=new mp(this.assets),this.scriptsOrder=d||[],this.defaultLayerWorld=new bc({name:"World",id:0}),this.defaultLayerDepth=new bc({name:"Depth",id:1,enabled:!1,opaqueSortMode:0}),this.defaultLayerSkybox=new bc({name:"Skybox",id:2,opaqueSortMode:0}),this.defaultLayerUi=new bc({name:"UI",id:4,transparentSortMode:1}),this.defaultLayerImmediate=new bc({name:"Immediate",id:3,opaqueSortMode:0});var g=new Ac("default");g.pushOpaque(this.defaultLayerWorld),g.pushOpaque(this.defaultLayerDepth),g.pushOpaque(this.defaultLayerSkybox),g.pushTransparent(this.defaultLayerWorld),g.pushOpaque(this.defaultLayerImmediate),g.pushTransparent(this.defaultLayerImmediate),g.pushTransparent(this.defaultLayerUi),this.scene.layers=g,Zu.createPlaceholder(r),this.renderer=new gc(r),this.renderer.scene=this.scene,l&&(this.lightmapper=new l(r,this.root,this.scene,this.renderer,this.assets),this.once("prerender",this._firstBake,this)),s&&(this._batcher=new s(r,this.root,this.scene),this.once("prerender",this._firstBatch,this)),this.keyboard=o||null,this.mouse=h||null,this.touch=m||null,this.gamepads=a||null,n&&(this.elementInput=n,this.elementInput.app=this),this.xr=f?new f(this):null,this.elementInput&&this.elementInput.attachSelectEvents(),this._scriptPrefix=u||"",this.enableBundles&&this.loader.addHandler("bundle",new yp(this)),c.forEach((e=>{var t=new e(this);this.loader.addHandler(t.handlerType,t)})),i.forEach((e=>{this.systems.add(new e(this))})),this._visibilityChangeHandler=this.onVisibilityChange.bind(this),"undefined"!=typeof document&&(void 0!==document.hidden?(this._hiddenAttr="hidden",document.addEventListener("visibilitychange",this._visibilityChangeHandler,!1)):void 0!==document.mozHidden?(this._hiddenAttr="mozHidden",document.addEventListener("mozvisibilitychange",this._visibilityChangeHandler,!1)):void 0!==document.msHidden?(this._hiddenAttr="msHidden",document.addEventListener("msvisibilitychange",this._visibilityChangeHandler,!1)):void 0!==document.webkitHidden&&(this._hiddenAttr="webkitHidden",document.addEventListener("webkitvisibilitychange",this._visibilityChangeHandler,!1))),this.tick=Fp(this)}static getApplication(e){return e?Rp._applications[e]:qu()}_initDefaultMaterial(){var e=new au;e.name="Default Material",function(e,t){jo.get(e,(()=>t))}(this.graphicsDevice,e)}_initProgramLibrary(){var e=new Su(this.graphicsDevice,new au);!function(e,t){xo.get(e,(()=>t))}(this.graphicsDevice,e)}get soundManager(){return this._soundManager}get batcher(){return this._batcher}get fillMode(){return this._fillMode}get resolutionMode(){return this._resolutionMode}configure(e,t){Qr.get(e,((e,s)=>{if(e)t(e);else{var i=s.application_properties,n=s.scenes,a=s.assets;this._parseApplicationProperties(i,(e=>{this._parseScenes(n),this._parseAssets(a),t(e||null)}))}}))}preload(e){this.fire("preload:start");var t=this.assets.list({preload:!0});if(0===t.length)return this.fire("preload:end"),void e();var s=0,i=()=>{s++,this.fire("preload:progress",s/t.length),s===t.length&&(this.fire("preload:end"),e())};t.forEach((e=>{e.loaded?i():(e.once("load",i),e.once("error",i),this.assets.load(e))}))}_preloadScripts(e,t){t()}_parseApplicationProperties(e,t){if("number"==typeof e.maxAssetRetries&&e.maxAssetRetries>0&&this.loader.enableRetry(e.maxAssetRetries),e.useDevicePixelRatio||(e.useDevicePixelRatio=e.use_device_pixel_ratio),e.resolutionMode||(e.resolutionMode=e.resolution_mode),e.fillMode||(e.fillMode=e.fill_mode),this._width=e.width,this._height=e.height,e.useDevicePixelRatio&&(this.graphicsDevice.maxPixelRatio=window.devicePixelRatio),this.setCanvasResolution(e.resolutionMode,this._width,this._height),this.setCanvasFillMode(e.fillMode,this._width,this._height),e.layers&&e.layerOrder){var s=new Ac("application"),i={};for(var n in e.layers){var a=e.layers[n];a.id=parseInt(n,10),a.enabled=1!==a.id,i[n]=new bc(a)}for(var r=0,o=e.layerOrder.length;r<o;r++){var l=e.layerOrder[r],h=i[l.layer];h&&(l.transparent?s.pushTransparent(h):s.pushOpaque(h),s.subLayerEnabled[r]=l.enabled)}this.scene.layers=s}if(e.batchGroups){var c=this.batcher;if(c)for(var d=0,u=e.batchGroups.length;d<u;d++){var p=e.batchGroups[d];c.addGroup(p.name,p.dynamic,p.maxAabbSize,p.id,p.layers)}}e.i18nAssets&&(this.i18n.assets=e.i18nAssets),this._loadLibraries(e.libraries,t)}_loadLibraries(e,t){var s=e.length,i=s,n=/^https?:\/\//;if(s)for(var a=(e,s)=>{i--,e?t(e):0===i&&(this.onLibrariesLoaded(),t(null))},r=0;r<s;++r){var o=e[r];!n.test(o.toLowerCase())&&this._scriptPrefix&&(o=Ye.join(this._scriptPrefix,o)),this.loader.load(o,"script",a)}else this.onLibrariesLoaded(),t(null)}_parseScenes(e){if(e)for(var t=0;t<e.length;t++)this.scenes.add(e[t].name,e[t].url)}_parseAssets(e){for(var t=[],s={},i={},n=0;n<this.scriptsOrder.length;n++){var a=this.scriptsOrder[n];e[a]&&(s[a]=!0,t.push(e[a]))}if(this.enableBundles)for(var r in e)"bundle"===e[r].type&&(i[r]=!0,t.push(e[r]));for(var o in e)s[o]||i[o]||t.push(e[o]);for(var l=0;l<t.length;l++){var h=t[l],c=new dp(h.name,h.type,h.file,h.data);if(c.id=parseInt(h.id,10),c.preload=!!h.preload&&h.preload,c.loaded="script"===h.type&&h.data&&h.data.loadingType>0,c.tags.add(h.tags),h.i18n)for(var d in h.i18n)c.addLocalizedAssetId(d,h.i18n[d]);this.assets.add(c)}}start(){this.frame=0,this.fire("start",{timestamp:ht(),target:this}),this._librariesLoaded||this.onLibrariesLoaded(),this.systems.fire("initialize",this.root),this.fire("initialize"),this.systems.fire("postInitialize",this.root),this.systems.fire("postPostInitialize",this.root),this.fire("postinitialize"),this.tick()}inputUpdate(e){this.controller&&this.controller.update(e),this.mouse&&this.mouse.update(),this.keyboard&&this.keyboard.update(),this.gamepads&&this.gamepads.update()}update(e){this.frame++,this.graphicsDevice.updateClientRect(),this.systems.fire(this._inTools?"toolsUpdate":"update",e),this.systems.fire("animationUpdate",e),this.systems.fire("postUpdate",e),this.fire("update",e),this.inputUpdate(e)}frameStart(){this.graphicsDevice.frameStart()}frameEnd(){this.graphicsDevice.frameEnd()}render(){this.fire("prerender"),this.root.syncHierarchy(),this._batcher&&this._batcher.updateAll(),this.renderComposition(this.scene.layers),this.fire("postrender")}renderComposition(e){this.renderer.update(e),this.renderer.buildFrameGraph(this.frameGraph,e),this.frameGraph.render(this.graphicsDevice)}_fillFrameStatsBasic(e,t,s){var i=this.stats.frame;i.dt=t,i.ms=s,e>i._timeToCountFrames?(i.fps=i._fpsAccum,i._fpsAccum=0,i._timeToCountFrames=e+1e3):i._fpsAccum++,this.stats.drawCalls.total=this.graphicsDevice._drawCallsPerFrame,this.graphicsDevice._drawCallsPerFrame=0}_fillFrameStats(){var e=this.stats.frame;e.cameras=this.renderer._camerasRendered,e.materials=this.renderer._materialSwitches,e.shaders=this.graphicsDevice._shaderSwitchesPerFrame,e.shadowMapUpdates=this.renderer._shadowMapUpdates,e.shadowMapTime=this.renderer._shadowMapTime,e.depthMapTime=this.renderer._depthMapTime,e.forwardTime=this.renderer._forwardTime;var t=this.graphicsDevice._primsPerFrame;e.triangles=t[4]/3+Math.max(t[5]-2,0)+Math.max(t[6]-2,0),e.cullTime=this.renderer._cullTime,e.sortTime=this.renderer._sortTime,e.skinTime=this.renderer._skinTime,e.morphTime=this.renderer._morphTime,e.lightClusters=this.renderer._lightClusters,e.lightClustersTime=this.renderer._lightClustersTime,e.otherPrimitives=0;for(var s=0;s<t.length;s++)s<4&&(e.otherPrimitives+=t[s]),t[s]=0;this.renderer._camerasRendered=0,this.renderer._materialSwitches=0,this.renderer._shadowMapUpdates=0,this.graphicsDevice._shaderSwitchesPerFrame=0,this.renderer._cullTime=0,this.renderer._layerCompositionUpdateTime=0,this.renderer._lightClustersTime=0,this.renderer._sortTime=0,this.renderer._skinTime=0,this.renderer._morphTime=0,this.renderer._shadowMapTime=0,this.renderer._depthMapTime=0,this.renderer._forwardTime=0,(e=this.stats.drawCalls).forward=this.renderer._forwardDrawCalls,e.culled=this.renderer._numDrawCallsCulled,e.depth=0,e.shadow=this.renderer._shadowDrawCalls,e.skinned=this.renderer._skinDrawCalls,e.immediate=0,e.instanced=0,e.removedByInstancing=0,e.misc=e.total-(e.forward+e.shadow),this.renderer._depthDrawCalls=0,this.renderer._shadowDrawCalls=0,this.renderer._forwardDrawCalls=0,this.renderer._numDrawCallsCulled=0,this.renderer._skinDrawCalls=0,this.renderer._immediateRendered=0,this.renderer._instancedDrawCalls=0,this.stats.misc.renderTargetCreationTime=this.graphicsDevice.renderTargetCreationTime,(e=this.stats.particles).updatesPerFrame=e._updatesPerFrame,e.frameTime=e._frameTime,e._updatesPerFrame=0,e._frameTime=0}setCanvasFillMode(e,t,s){this._fillMode=e,this.resizeCanvas(t,s)}setCanvasResolution(e,t,s){this._resolutionMode=e,e===ju&&void 0===t&&(t=this.graphicsDevice.canvas.clientWidth,s=this.graphicsDevice.canvas.clientHeight),this.graphicsDevice.resizeCanvas(t,s)}isHidden(){return document[this._hiddenAttr]}onVisibilityChange(){this.isHidden()?this._soundManager&&this._soundManager.suspend():this._soundManager&&this._soundManager.resume()}resizeCanvas(e,t){if(this._allowResize&&(!this.xr||!this.xr.session)){var s=window.innerWidth,i=window.innerHeight;if(this._fillMode===Wu){var n=this.graphicsDevice.canvas.width/this.graphicsDevice.canvas.height;n>s/i?t=(e=s)/n:e=(t=i)*n}else"FILL_WINDOW"===this._fillMode&&(e=s,t=i);return this.graphicsDevice.canvas.style.width=e+"px",this.graphicsDevice.canvas.style.height=t+"px",this.updateCanvasSize(),{width:e,height:t}}}updateCanvasSize(){var e;if(this._allowResize&&!(null==(e=this.xr)?void 0:e.active)&&this._resolutionMode===ju){var t=this.graphicsDevice.canvas;this.graphicsDevice.resizeCanvas(t.clientWidth,t.clientHeight)}}onLibrariesLoaded(){this._librariesLoaded=!0,this.systems.rigidbody&&this.systems.rigidbody.onLibraryLoaded()}applySceneSettings(e){var t;if(this.systems.rigidbody&&"undefined"!=typeof Ammo){var[s,i,n]=e.physics.gravity;this.systems.rigidbody.gravity.set(s,i,n)}this.scene.applySettings(e),e.render.hasOwnProperty("skybox")&&(e.render.skybox?(t=this.assets.get(e.render.skybox))?this.setSkybox(t):this.assets.once("add:"+e.render.skybox,this.setSkybox,this):this.setSkybox(null))}setAreaLightLuts(e,t){e&&t&&Zu.set(this.graphicsDevice,e,t)}setSkybox(e){if(e!==this._skyboxAsset){var t=()=>{this.setSkybox(null)},s=()=>{this.scene.setSkybox(this._skyboxAsset?this._skyboxAsset.resources:null)};this._skyboxAsset&&(this.assets.off("load:"+this._skyboxAsset.id,s,this),this.assets.off("remove:"+this._skyboxAsset.id,t,this),this._skyboxAsset.off("change",s,this)),this._skyboxAsset=e,this._skyboxAsset&&(this.assets.on("load:"+this._skyboxAsset.id,s,this),this.assets.once("remove:"+this._skyboxAsset.id,t,this),this._skyboxAsset.on("change",s,this),0!==this.scene.skyboxMip||this._skyboxAsset.loadFaces||(this._skyboxAsset.loadFaces=!0),this.assets.load(this._skyboxAsset)),s()}}_firstBake(){var e;null==(e=this.lightmapper)||e.bake(null,this.scene.lightmapMode)}_firstBatch(){var e;null==(e=this.batcher)||e.generate()}_processTimestamp(e){return e}drawLine(e,t,s,i,n){this.scene.drawLine(e,t,s,i,n)}drawLines(e,t,s,i){void 0===s&&(s=!0),void 0===i&&(i=this.scene.defaultDrawLayer),this.scene.drawLines(e,t,s,i)}drawLineArrays(e,t,s,i){void 0===s&&(s=!0),void 0===i&&(i=this.scene.defaultDrawLayer),this.scene.drawLineArrays(e,t,s,i)}drawWireSphere(e,t,s,i,n,a){void 0===s&&(s=mt.WHITE),void 0===i&&(i=20),void 0===n&&(n=!0),void 0===a&&(a=this.scene.defaultDrawLayer),this.scene.immediate.drawWireSphere(e,t,s,i,n,a)}drawWireAlignedBox(e,t,s,i,n,a){void 0===s&&(s=mt.WHITE),void 0===i&&(i=!0),void 0===n&&(n=this.scene.defaultDrawLayer),this.scene.immediate.drawWireAlignedBox(e,t,s,i,n,a)}drawMeshInstance(e,t){void 0===t&&(t=this.scene.defaultDrawLayer),this.scene.immediate.drawMesh(null,null,null,e,t)}drawMesh(e,t,s,i){void 0===i&&(i=this.scene.defaultDrawLayer),this.scene.immediate.drawMesh(t,s,e,null,i)}drawQuad(e,t,s){void 0===s&&(s=this.scene.defaultDrawLayer),this.scene.immediate.drawMesh(t,e,this.scene.immediate.getQuadMesh(),null,s)}drawTexture(e,t,s,i,n,a,r,o){if(void 0===r&&(r=this.scene.defaultDrawLayer),void 0===o&&(o=!0),!1!==o||this.graphicsDevice.isWebGPU){var l=new Et;l.setTRS(new yt(e,t,0),kt.IDENTITY,new yt(s,-i,0)),a||((a=new Wc).cull=0,a.setParameter("colorMap",n),a.shaderDesc=o?this.scene.immediate.getTextureShaderDesc(n.encoding):this.scene.immediate.getUnfilterableTextureShaderDesc(),a.update()),this.drawQuad(l,a,r)}}drawDepthTexture(e,t,s,i,n){void 0===n&&(n=this.scene.defaultDrawLayer);var a=new Wc;a.cull=0,a.shaderDesc=this.scene.immediate.getDepthTextureShaderDesc(),a.update(),this.drawTexture(e,t,s,i,null,a,n)}destroy(){var e,t,s,i;if(this._inFrameUpdate)this._destroyRequested=!0;else{var n=this.graphicsDevice.canvas.id;this.fire("destroy",this),this.off("librariesloaded"),"undefined"!=typeof document&&(document.removeEventListener("visibilitychange",this._visibilityChangeHandler,!1),document.removeEventListener("mozvisibilitychange",this._visibilityChangeHandler,!1),document.removeEventListener("msvisibilitychange",this._visibilityChangeHandler,!1),document.removeEventListener("webkitvisibilitychange",this._visibilityChangeHandler,!1)),this._visibilityChangeHandler=null,this.root.destroy(),this.root=null,this.mouse&&(this.mouse.off(),this.mouse.detach(),this.mouse=null),this.keyboard&&(this.keyboard.off(),this.keyboard.detach(),this.keyboard=null),this.touch&&(this.touch.off(),this.touch.detach(),this.touch=null),this.elementInput&&(this.elementInput.detach(),this.elementInput=null),this.gamepads&&(this.gamepads.destroy(),this.gamepads=null),this.controller&&(this.controller=null),this.systems.destroy(),this.scene.layers&&this.scene.layers.destroy();for(var a=this.assets.list(),r=0;r<a.length;r++)a[r].unload(),a[r].off();this.assets.off(),this.bundles.destroy(),this.bundles=null,this.i18n.destroy(),this.i18n=null;var o=this.loader.getHandler("script");null==o||o.clearCache(),this.loader.destroy(),this.loader=null,this.scene.destroy(),this.scene=null,this.systems=null,this.context=null,this.scripts.destroy(),this.scripts=null,this.scenes.destroy(),this.scenes=null,null==(e=this.lightmapper)||e.destroy(),this.lightmapper=null,this._batcher&&(this._batcher.destroy(),this._batcher=null),this._entityIndex={},this.defaultLayerDepth.onDisable=null,this.defaultLayerDepth.onEnable=null,this.defaultLayerDepth=null,this.defaultLayerWorld=null,null==(t=this.xr)||t.end(),null==(s=this.xr)||s.destroy(),this.renderer.destroy(),this.renderer=null,this.graphicsDevice.destroy(),this.graphicsDevice=null,this.tick=null,this.off(),null==(i=this._soundManager)||i.destroy(),this._soundManager=null,Rp._applications[n]=null,qu()===this&&Xu(null),Rp.cancelTick(this)}}static cancelTick(e){e.frameRequestId&&(window.cancelAnimationFrame(e.frameRequestId),e.frameRequestId=void 0)}getEntityFromIndex(e){return this._entityIndex[e]}_registerSceneImmediate(e){this.on("postrender",e.immediate.onPostRender,e.immediate)}constructor(e){super(),this._batcher=null,this._destroyRequested=!1,this._inFrameUpdate=!1,this._librariesLoaded=!1,this._fillMode=Wu,this._resolutionMode="FIXED",this._allowResize=!0,this._skyboxAsset=null,this._entityIndex={},this._inTools=!1,this._scriptPrefix="",this._time=0,this.enableBundles="undefined"!=typeof TextDecoder,this.timeScale=1,this.maxDeltaTime=.1,this.frame=0,this.frameGraph=new Yu,this.scriptsOrder=[],this.autoRender=!0,this.renderNextFrame=!1,this.lightmapper=null,this.loader=new xp(this),this.scenes=new Ip(this),this.scripts=new Cp(this),this.systems=new fp,this.i18n=new bp(this),this.keyboard=null,this.mouse=null,this.touch=null,this.gamepads=null,this.elementInput=null,this.xr=null,Rp._applications[e.id]=this,Xu(this),this.root=new Ep,this.root._enabledInHierarchy=!0}}Rp._applications={};var Lp={},Fp=function(e){var t=e;return function(e,s){var i;if(t.graphicsDevice){var n,a;if(t.frameRequestId)null==(a=t.xr)||null==(n=a.session)||n.cancelAnimationFrame(t.frameRequestId),cancelAnimationFrame(t.frameRequestId),t.frameRequestId=null;t._inFrameUpdate=!0,Xu(t);var r=t._processTimestamp(e)||ht(),o=r-(t._time||r),l=o/1e3;if(l=pt.clamp(l,0,t.maxDeltaTime),l*=t.timeScale,t._time=r,(null==(i=t.xr)?void 0:i.session)?t.frameRequestId=t.xr.session.requestAnimationFrame(t.tick):t.frameRequestId=Qe.browser||Qe.worker?requestAnimationFrame(t.tick):null,!t.graphicsDevice.contextLost){t._fillFrameStatsBasic(r,l,o),t.fire("frameupdate",o);var h,c=!0;if(s)c=null==(h=t.xr)?void 0:h.update(s),t.graphicsDevice.defaultFramebuffer=s.session.renderState.baseLayer.framebuffer;else t.graphicsDevice.defaultFramebuffer=null;c&&(t.update(l),t.fire("framerender"),(t.autoRender||t.renderNextFrame)&&(t.updateCanvasSize(),t.frameStart(),t.render(),t.frameEnd(),t.renderNextFrame=!1),Lp.timestamp=ht(),Lp.target=t,t.fire("frameend",Lp)),t._inFrameUpdate=!1,t._destroyRequested&&t.destroy()}}}};class Bp{constructor(){this.componentSystems=[],this.resourceHandlers=[]}}class Op extends tt{static _buildAccessors(e,t){t.forEach((t=>{var s="object"==typeof t?t.name:t;Object.defineProperty(e,s,{get:function(){return this.data[s]},set:function(e){var t=this.data,i=t[s];t[s]=e,this.fire("set",s,i,e)},configurable:!0})})),e._accessorsBuilt=!0}buildAccessors(e){Op._buildAccessors(this,e)}onSetEnabled(e,t,s){t!==s&&this.entity.enabled&&(s?this.onEnable():this.onDisable())}onEnable(){}onDisable(){}onPostStateChange(){}get data(){var e=this.system.store[this.entity.getGuid()];return e?e.data:null}set enabled(e){}get enabled(){return!0}constructor(e,t){super(),this.system=e,this.entity=t,this.system.schema&&!this._accessorsBuilt&&this.buildAccessors(this.system.schema),this.on("set",(function(e,t,s){this.fire("set_"+e,e,t,s)})),this.on("set_enabled",this.onSetEnabled,this)}}Op.order=0;class zp extends tt{addComponent(e,t){void 0===t&&(t={});var s=new this.ComponentType(this,e),i=new this.DataType;return this.store[e.getGuid()]={entity:e,data:i},e[this.id]=s,e.c[this.id]=s,this.initializeComponentData(s,t,[]),this.fire("add",e,s),s}removeComponent(e){var t=this.id,s=this.store[e.getGuid()],i=e.c[t];i.fire("beforeremove"),this.fire("beforeremove",e,i),delete this.store[e.getGuid()],e[t]=void 0,delete e.c[t],this.fire("remove",e,s.data)}cloneComponent(e,t){var s=this.store[e.getGuid()];return this.addComponent(t,s.data)}initializeComponentData(e,t,s){void 0===t&&(t={});for(var i=0,n=s.length;i<n;i++){var a=s[i],r=void 0,o=void 0;"object"==typeof a?(r=a.name,o=a.type):(r=a,o=void 0);var l=t[r];void 0!==l?(void 0!==o&&(l=Vp(l,o)),e[r]=l):e[r]=e.data[r]}e.enabled&&e.entity.enabled&&e.onEnable()}getPropertiesOfType(e){var t=[];return(this.schema||[]).forEach((s=>{s&&"object"==typeof s&&s.type===e&&t.push(s)})),t}destroy(){this.off()}constructor(e){super(),this.app=e,this.store={},this.schema=[]}}function Vp(e,t){if(!e)return e;switch(t){case"rgb":return e instanceof mt?e.clone():new mt(e[0],e[1],e[2]);case"rgba":return e instanceof mt?e.clone():new mt(e[0],e[1],e[2],e[3]);case"vec2":return e instanceof wt?e.clone():new wt(e[0],e[1]);case"vec3":return e instanceof yt?e.clone():new yt(e[0],e[1],e[2]);case"vec4":return e instanceof bt?e.clone():new bt(e[0],e[1],e[2],e[3]);case"boolean":case"number":case"string":case"entity":return e;default:throw new Error("Could not convert unhandled type: "+t)}}class Np{update(e,t){if(e<this._left||e>=this._right){var s=t.length;if(s)if(e<t[0])this._left=-1/0,this._right=t[0],this._len=0,this._recip=0,this._p0=this._p1=0;else if(e>=t[s-1])this._left=t[s-1],this._right=1/0,this._len=0,this._recip=0,this._p0=this._p1=s-1;else{var i=this._findKey(e,t);this._left=t[i],this._right=t[i+1],this._len=this._right-this._left;var n=1/this._len;this._recip=isFinite(n)?n:0,this._p0=i,this._p1=i+1}else this._left=-1/0,this._right=1/0,this._len=0,this._recip=0,this._p0=this._p1=0}this._t=0===this._recip?0:(e-this._left)*this._recip,this._hermite.valid=!1}_findKey(e,t){for(var s=0;e>=t[s+1];)s++;return s}eval(e,t,s){var i=s._data,n=s._components,a=this._p0*n;if(0===t)for(var r=0;r<n;++r)e[r]=i[a+r];else{var o=this._t,l=this._p1*n;switch(t){case 1:for(var h=0;h<n;++h)e[h]=pt.lerp(i[a+h],i[l+h],o);break;case 2:var c=this._hermite;if(!c.valid){var d=o*o,u=o+o,p=1-o,m=p*p;c.valid=!0,c.p0=(1+u)*m,c.m0=o*m,c.p1=d*(3-u),c.m1=d*(o-1)}for(var f=(3*this._p0+1)*n,g=(3*this._p0+2)*n,v=(3*this._p1+1)*n,_=(3*this._p1+0)*n,y=0;y<n;++y)e[y]=c.p0*i[f+y]+c.m0*i[g+y]*this._len+c.p1*i[v+y]+c.m1*i[_+y]*this._len}}}constructor(){this._left=1/0,this._right=-1/0,this._len=0,this._recip=0,this._p0=0,this._p1=0,this._t=0,this._hermite={valid:!1,p0:0,m0:0,p1:0,m1:0}}}class Up{constructor(e){this._name=e.name+"Snapshot",this._time=-1,this._cache=[],this._results=[];for(var t=0;t<e._inputs.length;++t)this._cache[t]=new Np;for(var s=e._curves,i=e._outputs,n=0;n<s.length;++n){for(var a=i[s[n]._output],r=[],o=0;o<a._components;++o)r[o]=0;this._results[n]=r}}}function Hp(){return Hp=Object.assign||function(e){for(var t=1;t<arguments.length;t++){var s=arguments[t];for(var i in s)Object.prototype.hasOwnProperty.call(s,i)&&(e[i]=s[i])}return e},Hp.apply(this,arguments)}class Gp{set name(e){this._name=e}get name(){return this._name}set track(e){this._track=e,this._snapshot=new Up(e)}get track(){return this._track}get snapshot(){return this._snapshot}set time(e){this._time=e,this.alignCursorToCurrentTime()}get time(){return this._time}set speed(e){var t=Math.sign(e)!==Math.sign(this._speed);this._speed=e,t&&this.alignCursorToCurrentTime()}get speed(){return this._speed}set loop(e){this._loop=e}get loop(){return this._loop}set blendWeight(e){this._blendWeight=e}get blendWeight(){return this._blendWeight}set blendOrder(e){this._blendOrder=e}get blendOrder(){return this._blendOrder}set eventCursor(e){this._eventCursor=e}get eventCursor(){return this._eventCursor}get eventCursorEnd(){return this.isReverse?0:this._track.events.length-1}get nextEvent(){return this._track.events[this._eventCursor]}get isReverse(){return this._speed<0}nextEventAheadOfTime(e){return!!this.nextEvent&&(this.isReverse?this.nextEvent.time<=e:this.nextEvent.time>=e)}nextEventBehindTime(e){return!!this.nextEvent&&(e===this.track.duration?this.isReverse?this.nextEvent.time>=e:this.nextEvent.time<=e:this.isReverse?this.nextEvent.time>e:this.nextEvent.time<e)}resetEventCursor(){this._eventCursor=this.isReverse?this._track.events.length-1:0}moveEventCursor(){this._eventCursor+=this.isReverse?-1:1,this._eventCursor>=this.track.events.length?this._eventCursor=0:this._eventCursor<0&&(this._eventCursor=this.track.events.length-1)}clipFrameTime(e){var t=Gp.eventFrame;t.start=0,t.end=e,t.residual=0,this.isReverse?e<0&&(t.start=this.track.duration,t.end=0,t.residual=e+this.track.duration):e>this.track.duration&&(t.start=0,t.end=this.track.duration,t.residual=e-this.track.duration)}alignCursorToCurrentTime(){for(this.resetEventCursor();this.nextEventBehindTime(this._time)&&this._eventCursor!==this.eventCursorEnd;)this.moveEventCursor()}fireNextEvent(){this._eventHandler.fire(this.nextEvent.name,Hp({track:this.track},this.nextEvent)),this.moveEventCursor()}fireNextEventInFrame(e,t){return!(!this.nextEventAheadOfTime(e)||!this.nextEventBehindTime(t))&&(this.fireNextEvent(),!0)}activeEventsForFrame(e,t){var s=Gp.eventFrame;this.clipFrameTime(t);for(var i=this.eventCursor;this.fireNextEventInFrame(e,s.end)&&i!==this.eventCursor;);this.loop&&Math.abs(s.residual)>0&&this.activeEventsForFrame(s.start,s.residual)}progressForTime(e){return e*this._speed/this._track.duration}_update(e){if(this._playing){var t=this._time,s=this._track.duration,i=this._speed,n=this._loop;this._track.events.length>0&&s>0&&this.activeEventsForFrame(t,t+i*e),t+=i*e,i>=0?t>s&&(n?t=t%s||0:(t=this._track.duration,this.pause())):t<0&&(n?t=s+(t%s||0):(t=0,this.pause())),this._time=t}this._time!==this._snapshot._time&&this._track.eval(this._time,this._snapshot)}play(){this._playing=!0,this._time=0}stop(){this._playing=!1,this._time=0}pause(){this._playing=!1}resume(){this._playing=!0}reset(){this._time=0}constructor(e,t,s,i,n,a){this._name=e.name,this._track=e,this._snapshot=new Up(e),this._playing=i,this._time=t,this._speed=s,this._loop=n,this._blendWeight=1,this._blendOrder=0,this._eventHandler=a,this.alignCursorToCurrentTime()}}Gp.eventFrame={start:0,end:0,residual:0};var Wp="NONE",jp="INTEGER",qp="FLOAT",Xp="BOOLEAN",Yp="TRIGGER",$p="START",Kp="END",Zp="ANY",Jp=[$p,Kp,Zp],Qp="OVERWRITE";class em{static dot(e,t){for(var s=e.length,i=0,n=0;n<s;++n)i+=e[n]*t[n];return i}static normalize(e){var t=em.dot(e,e);if(t>0){t=1/Math.sqrt(t);for(var s=e.length,i=0;i<s;++i)e[i]*=t}}static set(e,t,s){var i=e.length;if("quaternion"===s){var n=em.dot(t,t);n>0&&(n=1/Math.sqrt(n));for(var a=0;a<i;++a)e[a]=t[a]*n}else for(var r=0;r<i;++r)e[r]=t[r]}static blendVec(e,t,s,i){for(var n=i?1:1-s,a=e.length,r=0;r<a;++r)e[r]=e[r]*n+t[r]*s}static blendQuat(e,t,s,i){var n=e.length,a=i?1:1-s;em.dot(e,t)<0&&(s=-s);for(var r=0;r<n;++r)e[r]=e[r]*a+t[r]*s;i||em.normalize(e)}static blend(e,t,s,i,n){"quaternion"===i?em.blendQuat(e,t,s,n):em.blendVec(e,t,s,n)}static stableSort(e,t){for(var s=e.length,i=0;i<s-1;++i)for(var n=i+1;n<s;++n)if(t(e[n],e[i])){var a=e[i];e[i]=e[n],e[n]=a}}}class tm{get _normalizeWeights(){return this._component.normalizeWeights}getWeight(e){return this.dirty&&this.updateWeights(),this._normalizeWeights&&0===this.totalWeight||!this.mask[e]?0:this._normalizeWeights?this.weights[e]/this.totalWeight:pt.clamp(this.weights[e],0,1)}_layerBlendType(e){return this._component.layers[e].blendType}setMask(e,t){this.mask[e]=t,this._normalizeWeights&&(this._component.layers[e].blendType===Qp&&(this.mask=this.mask.fill(0,0,e)),this.dirty=!0)}updateWeights(){this.totalWeight=0;for(var e=0;e<this.weights.length;e++)this.weights[e]=this._component.layers[e].weight,this.totalWeight+=this.mask[e]*this.weights[e];this.dirty=!1}updateValue(e,t){if(0===this.counter&&(em.set(this.value,tm.IDENTITY_QUAT_ARR,this.valueType),this._normalizeWeights||em.blend(this.value,this.baseValue,1,this.valueType)),this.mask[e]&&0!==this.getWeight(e)){if("ADDITIVE"!==this._layerBlendType(e)||this._normalizeWeights)em.blend(this.value,t,this.getWeight(e),this.valueType);else if(this.valueType===tm.TYPE_QUAT){var s=tm.q1.set(this.value[0],this.value[1],this.value[2],this.value[3]),i=tm.q2.set(this.baseValue[0],this.baseValue[1],this.baseValue[2],this.baseValue[3]),n=tm.q3.set(t[0],t[1],t[2],t[3]),a=i.invert().mul(n);a.slerp(kt.IDENTITY,a,this.getWeight(e)),s.mul(a),tm.quatArr[0]=s.x,tm.quatArr[1]=s.y,tm.quatArr[2]=s.z,tm.quatArr[3]=s.w,em.set(this.value,tm.quatArr,this.valueType)}else tm.vecArr[0]=t[0]-this.baseValue[0],tm.vecArr[1]=t[1]-this.baseValue[1],tm.vecArr[2]=t[2]-this.baseValue[2],em.blend(this.value,tm.vecArr,this.getWeight(e),this.valueType,!0);this.setter&&this.setter(this.value)}}unbind(){this.setter&&this.setter(this.baseValue)}constructor(e,t){this._component=e,this.mask=new Int8Array(e.layers.length),this.weights=new Float32Array(e.layers.length),this.totalWeight=0,this.counter=0,this.layerCounter=0,this.valueType=t,this.dirty=!0,this.value=t===tm.TYPE_QUAT?[0,0,0,1]:[0,0,0],this.baseValue=null,this.setter=null}}tm.TYPE_QUAT="quaternion",tm.TYPE_VEC3="vector3",tm.q1=new kt,tm.q2=new kt,tm.q3=new kt,tm.quatArr=[0,0,0,1],tm.vecArr=[0,0,0],tm.IDENTITY_QUAT_ARR=[0,0,0,1];class sm{get clips(){return this._clips}addClip(e){for(var t=this._targets,s=this._binder,i=e.track.curves,n=e.snapshot,a=[],r=[],o=0;o<i.length;++o)for(var l=i[o].paths,h=0;h<l.length;++h){var c=l[h],d=s.resolve(c),u=t[d&&d.targetPath||null];if(!u&&d){u={target:d,value:[],curves:0,blendCounter:0};for(var p=0;p<u.target.components;++p)u.value.push(0);if(t[d.targetPath]=u,s.animComponent){if(!s.animComponent.targets[d.targetPath]){var m=void 0;m="localRotation"===d.targetPath.substring(d.targetPath.length-13)?tm.TYPE_QUAT:tm.TYPE_VEC3,s.animComponent.targets[d.targetPath]=new tm(s.animComponent,m)}s.animComponent.targets[d.targetPath].layerCounter++,s.animComponent.targets[d.targetPath].setMask(s.layerIndex,1)}}u&&(u.curves++,a.push(n._results[o]),r.push(u))}this._clips.push(e),this._inputs.push(a),this._outputs.push(r)}removeClip(e){for(var t=this._targets,s=this._binder,i=this._clips,n=i[e].track.curves,a=0;a<n.length;++a)for(var r=n[a].paths,o=0;o<r.length;++o){var l=r[o],h=this._binder.resolve(l);h&&(h.curves--,0===h.curves&&(s.unresolve(l),delete t[h.targetPath],s.animComponent&&s.animComponent.targets[h.targetPath].layerCounter--))}i.splice(e,1),this._inputs.splice(e,1),this._outputs.splice(e,1)}removeClips(){for(;this._clips.length>0;)this.removeClip(0)}updateClipTrack(e,t){this._clips.forEach((s=>{s.name.includes(e)&&(s.track=t)})),this.rebind()}findClip(e){for(var t=this._clips,s=0;s<t.length;++s){var i=t[s];if(i.name===e)return i}return null}rebind(){this._binder.rebind(),this._targets={};var e=[...this.clips];this.removeClips(),e.forEach((e=>{this.addClip(e)}))}assignMask(e){return this._binder.assignMask(e)}update(e,t){void 0===t&&(t=!0);var s=this._clips,i=s.map(((e,t)=>t));em.stableSort(i,((e,t)=>s[e].blendOrder<s[t].blendOrder));for(var n=0;n<i.length;++n){var a=i[n],r=s[a],o=this._inputs[a],l=this._outputs[a],h=r.blendWeight;if(h>0&&r._update(e),!t)break;var c=void 0,d=void 0,u=void 0;if(h>=1)for(var p=0;p<o.length;++p)c=o[p],u=(d=l[p]).value,em.set(u,c,d.target.type),d.blendCounter++;else if(h>0)for(var m=0;m<o.length;++m)c=o[m],u=(d=l[m]).value,0===d.blendCounter?em.set(u,c,d.target.type):em.blend(u,c,h,d.target.type),d.blendCounter++}var f=this._targets,g=this._binder;for(var v in f)if(f.hasOwnProperty(v)){var _=f[v];if(g.animComponent&&_.target.isTransform){var y=g.animComponent.targets[v];y.counter===y.layerCounter&&(y.counter=0),y.path||(y.path=v,y.baseValue=_.target.get(),y.setter=_.target.set),y.updateValue(g.layerIndex,_.value),y.counter++}else _.target.set(_.value);_.blendCounter=0}this._binder.update(e)}constructor(e){this._binder=e,this._clips=[],this._inputs=[],this._outputs=[],this._targets={}}}class im{get events(){return this._events}constructor(e){this._events=[...e],this._events.sort(((e,t)=>e.time-t.time))}}class nm{get name(){return this._name}get duration(){return this._duration}get inputs(){return this._inputs}get outputs(){return this._outputs}get curves(){return this._curves}set events(e){this._animEvents=e}get events(){return this._animEvents.events}eval(e,t){t._time=e;for(var s=this._inputs,i=this._outputs,n=this._curves,a=t._cache,r=t._results,o=0;o<s.length;++o)a[o].update(e,s[o]._data);for(var l=0;l<n.length;++l){var h=n[l],c=i[h._output],d=r[l];a[h._input].eval(d,h._interpolation,c)}}constructor(e,t,s,i,n,a=new im([])){this._name=e,this._duration=t,this._inputs=s,this._outputs=i,this._curves=n,this._animEvents=a}}nm.EMPTY=Object.freeze(new nm("empty",Number.MAX_VALUE,[],[],[]));class am{static joinPath(e,t){t=t||".";return e.map((function(e){return e.replace(/\\/g,"\\\\").replace(new RegExp("\\"+t,"g"),"\\"+t)})).join(t)}static splitPath(e,t){t=t||".";for(var s=[],i="",n=0;n<e.length;){var a=e[n++];"\\"===a&&n<e.length?i+="\\"===(a=e[n++])||a===t?a:"\\"+a:a===t?(s.push(i),i=""):i+=a}return i.length>0&&s.push(i),s}static encode(e,t,s){return(Array.isArray(e)?e.join("/"):e)+"/"+t+"/"+(Array.isArray(s)?s.join("/"):s)}resolve(e){return null}unresolve(e){}update(e){}}class rm{get set(){return this._set}get get(){return this._get}get type(){return this._type}get components(){return this._components}get targetPath(){return this._targetPath}get isTransform(){return this._isTransform}constructor(e,t,s,i){e.set?(this._set=e.set,this._get=e.get):this._set=e,this._type=t,this._components=s,this._targetPath=i,this._isTransform="localRotation"===this._targetPath.substring(this._targetPath.length-13)||"localPosition"===this._targetPath.substring(this._targetPath.length-13)||"localScale"===this._targetPath.substring(this._targetPath.length-10)}}class om{_isPathActive(e){if(!this._mask)return!0;for(var t=[e.entityPath[0],this.graph.name],s=0;s<t.length;++s){var i=t[s];if(this._isPathInMask(i,1===e.entityPath.length))return!0;for(var n=1;n<e.entityPath.length;n++)if(i+="/"+e.entityPath[n],this._isPathInMask(i,n===e.entityPath.length-1))return!0}return!1}findNode(e){return this._isPathActive(e)?(this.graph&&((t=this.graph.findByPath(e.entityPath))||(t=this.graph.findByPath(e.entityPath.slice(1)))),t||(t=this.nodes[e.entityPath[e.entityPath.length-1]||""]),t):null;var t}static createAnimTarget(e,t,s,i,n,a){var r=am.encode(i.path,a||"entity",n);return new rm(e,t,s,r)}resolve(e){var t=am.encode(e.entityPath,e.component,e.propertyPath),s=this.targetCache[t];if(s)return s;var i=this.findNode(e);if(!i)return null;var n=this.handlers[e.propertyPath];return n&&(s=n(i))?(this.targetCache[t]=s,this.nodeCounts[i.path]?this.nodeCounts[i.path]++:(this.activeNodes.push(i),this.nodeCounts[i.path]=1),s):null}unresolve(e){if("graph"===e.component){var t=this.nodes[e.entityPath[e.entityPath.length-1]||""];if(this.nodeCounts[t.path]--,0===this.nodeCounts[t.path]){var s=this.activeNodes,i=s.indexOf(t.node),n=s.length;i<n-1&&(s[i]=s[n-1]),s.pop()}}}update(e){for(var t=this.activeNodes,s=0;s<t.length;++s)t[s]._dirtifyLocal()}assignMask(e){return e!==this._mask&&(this._mask=e,!0)}constructor(e){if(this._isPathInMask=(e,t)=>{var s=this._mask[e];return!!s&&!!(s.children||t&&!1!==s.value)},this.graph=e,e){this._mask=null;var t={},s=function(e){t[e.name]=e;for(var i=0;i<e.children.length;++i)s(e.children[i])};s(e),this.nodes=t,this.targetCache={};var i=function(e){for(var t,s=e;s&&!(s instanceof Ep);)s=s.parent;return s&&(s.render?t=s.render.meshInstances:s.model&&(t=s.model.meshInstances)),t};this.nodeCounts={},this.activeNodes=[],this.handlers={localPosition:function(e){var t=e.localPosition;return om.createAnimTarget((function(e){t.set(...e)}),"vector",3,e,"localPosition")},localRotation:function(e){var t=e.localRotation;return om.createAnimTarget((function(e){t.set(...e)}),"quaternion",4,e,"localRotation")},localScale:function(e){var t=e.localScale;return om.createAnimTarget((function(e){t.set(...e)}),"vector",3,e,"localScale")},weight:function(e,t){t=0===t.indexOf("name.")?t.replace("name.",""):Number(t);var s,n=i(e);if(n)for(var a=function(i){if(n[i].node.name===e.name&&n[i].morphInstance){var a=n[i].morphInstance;s||(s=[]),s.push((e=>{a.setWeight(t,e[0])}))}},r=0;r<n.length;++r)a(r);if(s){return om.createAnimTarget((e=>{for(var t=0;t<s.length;++t)s[t](e)}),"number",1,e,"weight."+t)}return null},materialTexture:(e,t)=>{var s=i(e);if(s){for(var n,a=0;a<s.length;++a)if(s[a].node.name===e.name){n=s[a];break}if(n){return om.createAnimTarget((e=>{var s=this.animComponent.system.app.assets.get(e[0]);s&&s.resource&&"texture"===s.type&&(n.material[t]=s.resource,n.material.update())}),"vector",1,e,"materialTexture","material")}}return null}}}}}class lm{get parent(){return this._parent}get name(){return this._name}get path(){return this._parent?this._parent.path+"."+this._name:this._name}get point(){return this._point}get pointLength(){return this._pointLength}set weight(e){this._weight=e}get weight(){return this._parent?this._parent.weight*this._weight:this._weight}get normalizedWeight(){var e=this._state.totalWeight;return 0===e?0:this.weight/e}get speed(){return this._weightedSpeed*this._speed}get absoluteSpeed(){return Math.abs(this._speed)}set weightedSpeed(e){this._weightedSpeed=e}get weightedSpeed(){return this._weightedSpeed}set animTrack(e){this._animTrack=e}get animTrack(){return this._animTrack}constructor(e,t,s,i,n=1){this._state=e,this._parent=t,this._name=s,Array.isArray(i)?(this._point=new wt(i[0],i[1]),this._pointLength=this._point.length()):(this._point=i,this._pointLength=i),this._speed=n,this._weightedSpeed=1,this._weight=1,this._animTrack=null}}class hm extends lm{get weight(){return this.calculateWeights(),this._parent?this._parent.weight*this._weight:this._weight}get syncAnimations(){return this._syncAnimations}getChild(e){for(var t=0;t<this._children.length;t++)if(this._children[t].name===e)return this._children[t];return null}updateParameterValues(){for(var e=!0,t=0;t<this._parameterValues.length;t++){var s=this._findParameter(this._parameters[t]).value;this._parameterValues[t]!==s&&(this._parameterValues[t]=s,e=!1)}return e}getNodeWeightedDuration(e){return this._children[e].animTrack.duration/this._children[e].speedMultiplier*this._children[e].weight}getNodeCount(){for(var e=0,t=0;t<this._children.length;t++){this._children[t].constructor===hm?e+=this._children[t].getNodeCount():e++}return e}constructor(e,t,s,i,n,a,r,o,l){super(e,t,s,i),this._parameters=n,this._parameterValues=new Array(n.length),this._children=[],this._findParameter=l,this._syncAnimations=!1!==r,this._pointCache={};for(var h=0;h<a.length;h++){var c=a[h];c.children?this._children.push(o(c.type,e,this,c.name,1,c.parameter?[c.parameter]:c.parameters,c.children,c.syncAnimations,o,l)):this._children.push(new lm(e,this,c.name,c.point,c.speed))}}}class cm extends hm{calculateWeights(){if(!this.updateParameterValues()){var e=0;this._children[0].weight=0;for(var t=0;t<this._children.length;t++){var s=this._children[t];if(t!==this._children.length-1){var i=this._children[t+1];if(s.point===i.point)s.weight=.5,i.weight=.5;else if(pt.between(this._parameterValues[0],s.point,i.point,!0)){var n=Math.abs(s.point-i.point),a=(n-Math.abs(s.point-this._parameterValues[0]))/n;s.weight=a,i.weight=1-a}else i.weight=0}this._syncAnimations&&(e+=s.animTrack.duration/s.absoluteSpeed*s.weight)}if(this._syncAnimations)for(var r=0;r<this._children.length;r++){var o=this._children[r];o.weightedSpeed=o.animTrack.duration/o.absoluteSpeed/e}}}constructor(e,t,s,i,n,a,r,o,l){a.sort(((e,t)=>e.point-t.point)),super(e,t,s,i,n,a,r,o,l)}}class dm extends hm{pointDistanceCache(e,t){var s=""+e+t;return this._pointCache[s]||(this._pointCache[s]=this._children[t].point.clone().sub(this._children[e].point)),this._pointCache[s]}calculateWeights(){if(!this.updateParameterValues()){var e,t;dm._p.set(...this._parameterValues),e=0,t=0;for(var s=0;s<this._children.length;s++){var i=this._children[s],n=i.point;dm._pip.set(dm._p.x,dm._p.y).sub(n);for(var a=Number.MAX_VALUE,r=0;r<this._children.length;r++)if(s!==r){var o=this.pointDistanceCache(s,r),l=pt.clamp(1-dm._pip.dot(o)/o.lengthSq(),0,1);l<a&&(a=l)}i.weight=a,e+=a,this._syncAnimations&&(t+=i.animTrack.duration/i.absoluteSpeed*i.weight)}for(var h=0;h<this._children.length;h++){var c=this._children[h];c.weight=c._weight/e,this._syncAnimations&&(c.weightedSpeed=c.animTrack.duration/c.absoluteSpeed/t)}}}}dm._p=new wt,dm._pip=new wt;class um extends hm{pointCache(e,t){var s=""+e+t;return this._pointCache[s]||(this._pointCache[s]=new wt((this._children[t].pointLength-this._children[e].pointLength)/((this._children[t].pointLength+this._children[e].pointLength)/2),2*wt.angleRad(this._children[e].point,this._children[t].point))),this._pointCache[s]}calculateWeights(){if(!this.updateParameterValues()){var e,t;um._p.set(...this._parameterValues);var s=um._p.length();e=0,t=0;for(var i=0;i<this._children.length;i++){for(var n=this._children[i],a=n.point,r=n.pointLength,o=Number.MAX_VALUE,l=0;l<this._children.length;l++)if(i!==l){var h=this.pointCache(i,l),c=this._children[l].pointLength;um._pip.set((s-r)/((c+r)/2),2*wt.angleRad(a,um._p));var d=pt.clamp(1-Math.abs(um._pip.dot(h)/h.lengthSq()),0,1);d<o&&(o=d)}n.weight=o,e+=o,this._syncAnimations&&(t+=n.animTrack.duration/n.absoluteSpeed*n.weight)}for(var u=0;u<this._children.length;u++){var p=this._children[u];if(p.weight=p._weight/e,this._syncAnimations){var m=p.animTrack.duration/t*e;p.weightedSpeed=p.absoluteSpeed*m}}}}}um._p=new wt,um._pip=new wt;class pm extends hm{calculateWeights(){if(!this.updateParameterValues()){for(var e=0,t=0,s=0;s<this._children.length;s++)if(e+=Math.max(this._parameterValues[s],0),this._syncAnimations){var i=this._children[s];t+=i.animTrack.duration/i.absoluteSpeed*i.weight}for(var n=0;n<this._children.length;n++){var a=this._children[n],r=Math.max(this._parameterValues[n],0);e?(a.weight=r/e,this._syncAnimations&&(a.weightedSpeed=a.animTrack.duration/a.absoluteSpeed/t)):(a.weight=0,this._syncAnimations&&(a.weightedSpeed=0))}}}}class mm{_createTree(e,t,s,i,n,a,r,o,l,h){switch(e){case"1D":return new cm(t,s,i,n,a,r,o,l,h);case"2D_CARTESIAN":return new dm(t,s,i,n,a,r,o,l,h);case"2D_DIRECTIONAL":return new um(t,s,i,n,a,r,o,l,h);case"DIRECT":return new pm(t,s,i,n,a,r,o,l,h)}}_getNodeFromPath(e){for(var t=this._blendTree,s=1;s<e.length;s++)t=t.getChild(e[s]);return t}addAnimation(e,t){var s=e.join("."),i=this._animationList.findIndex((e=>e.path===s));if(i>=0)this._animationList[i].animTrack=t;else{var n=this._getNodeFromPath(e);n.animTrack=t,this._animationList.push(n)}this._updateHasAnimations()}_updateHasAnimations(){this._hasAnimations=this._animationList.length>0&&this._animationList.every((e=>e.animTrack&&e.animTrack!==nm.EMPTY))}get name(){return this._name}set animations(e){this._animationList=e,this._updateHasAnimations()}get animations(){return this._animationList}get hasAnimations(){return this._hasAnimations}set speed(e){this._speed=e}get speed(){return this._speed}set loop(e){this._loop=e}get loop(){return this._loop}get nodeCount(){return this._blendTree&&this._blendTree.constructor!==lm?this._blendTree.getNodeCount():1}get playable(){return-1!==Jp.indexOf(this.name)||this.animations.length===this.nodeCount}get looping(){if(this.animations.length>0){var e=this.name+"."+this.animations[0].animTrack.name,t=this._controller.animEvaluator.findClip(e);if(t)return t.loop}return!1}get totalWeight(){for(var e=0,t=0;t<this.animations.length;t++)e+=this.animations[t].weight;return e}get timelineDuration(){for(var e=0,t=0;t<this.animations.length;t++){var s=this.animations[t];s.animTrack.duration>e&&(e=s.animTrack.duration)}return e}constructor(e,t,s=1,i=!0,n){this._animations={},this._animationList=[],this._controller=e,this._name=t,this._speed=s,this._loop=i,this._hasAnimations=!1,this._blendTree=n?this._createTree(n.type,this,null,t,1,n.parameter?[n.parameter]:n.parameters,n.children,n.syncAnimations,this._createTree,this._controller.findParameter):new lm(this,null,t,1,s)}}class fm{get from(){return this._from}set to(e){this._to=e}get to(){return this._to}get time(){return this._time}get priority(){return this._priority}get conditions(){return this._conditions}get exitTime(){return this._exitTime}get transitionOffset(){return this._transitionOffset}get interruptionSource(){return this._interruptionSource}get hasExitTime(){return!!this.exitTime}constructor({from:e,to:t,time:s=0,priority:i=0,conditions:n=[],exitTime:a=null,transitionOffset:r=null,interruptionSource:o=Wp}){this._from=e,this._to=t,this._time=s,this._priority=i,this._conditions=n,this._exitTime=a,this._transitionOffset=r,this._interruptionSource=o}}function gm(){return gm=Object.assign||function(e){for(var t=1;t<arguments.length;t++){var s=arguments[t];for(var i in s)Object.prototype.hasOwnProperty.call(s,i)&&(e[i]=s[i])}return e},gm.apply(this,arguments)}class vm{get animEvaluator(){return this._animEvaluator}set activeState(e){this._activeStateName=e}get activeState(){return this._findState(this._activeStateName)}get activeStateName(){return this._activeStateName}get activeStateAnimations(){return this.activeState.animations}set previousState(e){this._previousStateName=e}get previousState(){return this._findState(this._previousStateName)}get previousStateName(){return this._previousStateName}get playable(){for(var e=!0,t=0;t<this._stateNames.length;t++)this._states[this._stateNames[t]].playable||(e=!1);return e}set playing(e){this._playing=e}get playing(){return this._playing}get activeStateProgress(){return this._getActiveStateProgressForTime(this._timeInState)}get activeStateDuration(){if(this._activeStateDurationDirty){for(var e=0,t=0;t<this.activeStateAnimations.length;t++){var s=this._animEvaluator.findClip(this.activeStateAnimations[t].name);s&&(e=Math.max(e,s.track.duration))}this._activeStateDuration=e,this._activeStateDurationDirty=!1}return this._activeStateDuration}set activeStateCurrentTime(e){this._timeInStateBefore=e,this._timeInState=e;for(var t=0;t<this.activeStateAnimations.length;t++){var s=this.animEvaluator.findClip(this.activeStateAnimations[t].name);s&&(s.time=e)}}get activeStateCurrentTime(){return this._timeInState}get transitioning(){return this._isTransitioning}get transitionProgress(){return this._currTransitionTime/this._totalTransitionTime}get states(){return this._stateNames}assignMask(e){return this._animEvaluator.assignMask(e)}_findState(e){return this._states[e]}_getActiveStateProgressForTime(e){if(this.activeStateName===$p||this.activeStateName===Kp||this.activeStateName===Zp)return 1;var t=this._animEvaluator.findClip(this.activeStateAnimations[0].name);return t?t.progressForTime(e):null}_findTransitionsFromState(e){var t=this._findTransitionsFromStateCache[e];return t||(t=this._transitions.filter((t=>t.from===e)),Sc(t),this._findTransitionsFromStateCache[e]=t),t}_findTransitionsBetweenStates(e,t){var s=this._findTransitionsBetweenStatesCache[e+"->"+t];return s||(s=this._transitions.filter((s=>s.from===e&&s.to===t)),Sc(s),this._findTransitionsBetweenStatesCache[e+"->"+t]=s),s}_transitionHasConditionsMet(e){for(var t=e.conditions,s=0;s<t.length;s++){var i=t[s],n=this._findParameter(i.parameterName);switch(i.predicate){case"GREATER_THAN":if(!(n.value>i.value))return!1;break;case"LESS_THAN":if(!(n.value<i.value))return!1;break;case"GREATER_THAN_EQUAL_TO":if(!(n.value>=i.value))return!1;break;case"LESS_THAN_EQUAL_TO":if(!(n.value<=i.value))return!1;break;case"EQUAL_TO":if(n.value!==i.value)return!1;break;case"NOT_EQUAL_TO":if(n.value===i.value)return!1}}return!0}_findTransition(e,t){var s=[];if(e&&t)s=s.concat(this._findTransitionsBetweenStates(e,t));else if(this._isTransitioning)switch(this._transitionInterruptionSource){case"PREV_STATE":s=(s=s.concat(this._findTransitionsFromState(this._previousStateName))).concat(this._findTransitionsFromState(Zp));break;case"NEXT_STATE":s=(s=s.concat(this._findTransitionsFromState(this._activeStateName))).concat(this._findTransitionsFromState(Zp));break;case"PREV_STATE_NEXT_STATE":s=(s=(s=s.concat(this._findTransitionsFromState(this._previousStateName))).concat(this._findTransitionsFromState(this._activeStateName))).concat(this._findTransitionsFromState(Zp));break;case"NEXT_STATE_PREV_STATE":s=(s=(s=s.concat(this._findTransitionsFromState(this._activeStateName))).concat(this._findTransitionsFromState(this._previousStateName))).concat(this._findTransitionsFromState(Zp))}else s=(s=s.concat(this._findTransitionsFromState(this._activeStateName))).concat(this._findTransitionsFromState(Zp));if(s=s.filter((e=>{if(e.to===this.activeStateName)return!1;if(e.hasExitTime){var t=this._getActiveStateProgressForTime(this._timeInStateBefore),s=this._getActiveStateProgressForTime(this._timeInState);if(e.exitTime<1&&this.activeState.loop&&(t-=Math.floor(t),s-=Math.floor(s)),s===t){if(s!==e.exitTime)return null}else if(!(e.exitTime>t&&e.exitTime<=s))return null}return this._transitionHasConditionsMet(e)})),s.length>0){var i=s[0];if(i.to===Kp){var n=this._findTransitionsFromState($p)[0];i.to=n.to}return i}return null}updateStateFromTransition(e){var t,s,i;this.previousState=e.from?this.activeStateName:null,this.activeState=e.to,this._activeStateDurationDirty=!0;for(var n=0;n<e.conditions.length;n++){var a=e.conditions[n];this._findParameter(a.parameterName).type===Yp&&this._consumeTrigger(a.parameterName)}if(this.previousState){this._isTransitioning||(this._transitionPreviousStates=[]),this._transitionPreviousStates.push({name:this._previousStateName,weight:1});for(var r=Math.min(0!==this._totalTransitionTime?this._currTransitionTime/this._totalTransitionTime:1,1),o=0;o<this._transitionPreviousStates.length;o++){this._isTransitioning?o!==this._transitionPreviousStates.length-1?this._transitionPreviousStates[o].weight*=1-r:this._transitionPreviousStates[o].weight=r:this._transitionPreviousStates[o].weight=1,t=this._findState(this._transitionPreviousStates[o].name);for(var l=0;l<t.animations.length;l++)s=t.animations[l],(i=this._animEvaluator.findClip(s.name+".previous."+o))||((i=this._animEvaluator.findClip(s.name)).name=s.name+".previous."+o),o!==this._transitionPreviousStates.length-1&&i.pause()}}this._isTransitioning=!0,this._totalTransitionTime=e.time,this._currTransitionTime=0,this._transitionInterruptionSource=e.interruptionSource;var h=this.activeState,c=e.transitionOffset&&e.transitionOffset>0&&e.transitionOffset<1,d=0,u=0;if(c){var p=h.timelineDuration*e.transitionOffset;d=p,u=p}this._timeInState=d,this._timeInStateBefore=u;for(var m=0;m<h.animations.length;m++){if(i=this._animEvaluator.findClip(h.animations[m].name))i.reset();else{var f=Number.isFinite(h.animations[m].speed)?h.animations[m].speed:h.speed;(i=new Gp(h.animations[m].animTrack,this._timeInState,f,!0,h.loop,this._eventHandler)).name=h.animations[m].name,this._animEvaluator.addClip(i)}if(e.time>0?i.blendWeight=0:i.blendWeight=h.animations[m].normalizedWeight,i.play(),c)i.time=h.timelineDuration*e.transitionOffset;else{var g=h.speed>=0?0:this.activeStateDuration;i.time=g}}}_transitionToState(e){if(this._findState(e)){var t=this._findTransition(this._activeStateName,e);t||(this._animEvaluator.removeClips(),t=new fm({from:null,to:e})),this.updateStateFromTransition(t)}}assignAnimation(e,t,s,i){var n=e.split("."),a=this._findState(n[0]);a||(a=new mm(this,n[0],s),this._states[n[0]]=a,this._stateNames.push(n[0])),a.addAnimation(n,t),this._animEvaluator.updateClipTrack(a.name,t),void 0!==s&&(a.speed=s),void 0!==i&&(a.loop=i),!this._playing&&this._activate&&this.playable&&this.play(),this._activeStateDurationDirty=!0}removeNodeAnimations(e){if(-1!==Jp.indexOf(e))return!1;var t=this._findState(e);return!!t&&(t.animations=[],!0)}play(e){e&&this._transitionToState(e),this._playing=!0}pause(){this._playing=!1}reset(){this._previousStateName=null,this._activeStateName=$p,this._playing=!1,this._currTransitionTime=1,this._totalTransitionTime=1,this._isTransitioning=!1,this._timeInState=0,this._timeInStateBefore=0,this._animEvaluator.removeClips()}rebind(){this._animEvaluator.rebind()}update(e){if(this._playing){var t,s,i;(this.activeState.loop||this._timeInState<this.activeStateDuration)&&(this._timeInStateBefore=this._timeInState,this._timeInState+=e*this.activeState.speed,!this.activeState.loop&&this._timeInState>this.activeStateDuration&&(this._timeInState=this.activeStateDuration,e=this.activeStateDuration-this._timeInStateBefore));var n=this._findTransition(this._activeStateName);if(n&&this.updateStateFromTransition(n),this._isTransitioning)if(this._currTransitionTime+=e,this._currTransitionTime<=this._totalTransitionTime){for(var a=0!==this._totalTransitionTime?this._currTransitionTime/this._totalTransitionTime:1,r=0;r<this._transitionPreviousStates.length;r++){t=this._findState(this._transitionPreviousStates[r].name);for(var o=this._transitionPreviousStates[r].weight,l=0;l<t.animations.length;l++)s=t.animations[l],(i=this._animEvaluator.findClip(s.name+".previous."+r))&&(i.blendWeight=(1-a)*s.normalizedWeight*o)}t=this.activeState;for(var h=0;h<t.animations.length;h++)s=t.animations[h],this._animEvaluator.findClip(s.name).blendWeight=a*s.normalizedWeight}else{this._isTransitioning=!1;for(var c=this.activeStateAnimations.length,d=this._animEvaluator.clips.length,u=0;u<d-c;u++)this._animEvaluator.removeClip(0);this._transitionPreviousStates=[],t=this.activeState;for(var p=0;p<t.animations.length;p++)s=t.animations[p],(i=this._animEvaluator.findClip(s.name))&&(i.blendWeight=s.normalizedWeight)}else if(this.activeState._blendTree.constructor!==lm){t=this.activeState;for(var m=0;m<t.animations.length;m++)s=t.animations[m],(i=this._animEvaluator.findClip(s.name))&&(i.blendWeight=s.normalizedWeight,s.parent.syncAnimations&&(i.speed=s.speed))}this._animEvaluator.update(e,this.activeState.hasAnimations)}}constructor(e,t,s,i,n,a,r){this._states={},this._stateNames=[],this._findTransitionsFromStateCache={},this._findTransitionsBetweenStatesCache={},this._previousStateName=null,this._activeStateName=$p,this._activeStateDuration=0,this._activeStateDurationDirty=!0,this._playing=!1,this._currTransitionTime=1,this._totalTransitionTime=1,this._isTransitioning=!1,this._transitionInterruptionSource=Wp,this._transitionPreviousStates=[],this._timeInState=0,this._timeInStateBefore=0,this.findParameter=e=>this._findParameter(e),this._animEvaluator=e,this._eventHandler=n,this._findParameter=a,this._consumeTrigger=r;for(var o=0;o<t.length;o++)this._states[t[o].name]=new mm(this,t[o].name,t[o].speed,t[o].loop,t[o].blendTree),this._stateNames.push(t[o].name);this._transitions=s.map((e=>new fm(gm({},e)))),this._activate=i}}var _m=new wt,ym=new yt,xm=new bt,wm=new mt,bm=new kt;class Cm extends om{static _packFloat(e){return e[0]}static _packBoolean(e){return!!e[0]}static _packVec2(e){return _m.x=e[0],_m.y=e[1],_m}static _packVec3(e){return ym.x=e[0],ym.y=e[1],ym.z=e[2],ym}static _packVec4(e){return xm.x=e[0],xm.y=e[1],xm.z=e[2],xm.w=e[3],xm}static _packColor(e){return wm.r=e[0],wm.g=e[1],wm.b=e[2],wm.a=e[3],wm}static _packQuat(e){return bm.x=e[0],bm.y=e[1],bm.z=e[2],bm.w=e[3],bm}resolve(e){var t,s,i,n=am.encode(e.entityPath,e.component,e.propertyPath),a=this.targetCache[n];if(a)return a;switch(e.component){case"entity":t=this._getEntityFromHierarchy(e.entityPath),i=am.encode(t.path,"entity",e.propertyPath),s=t;break;case"graph":if(!(s=this.findNode(e)))return null;i=am.encode(s.path,"graph",e.propertyPath);break;default:if(!(s=(t=this._getEntityFromHierarchy(e.entityPath)).findComponent(e.component)))return null;i=am.encode(t.path,e.component,e.propertyPath)}return a=this._createAnimTargetForProperty(s,e.propertyPath,i),this.targetCache[n]=a,a}update(e){var t=this.activeNodes;if(t)for(var s=0;s<t.length;s++)t[s]._dirtifyLocal()}_getEntityFromHierarchy(e){if(!this.animComponent.entity.name===e[0])return null;var t=this.animComponent.entity;return 1===e.length?t:t._parent.findByPath(e)}_resolvePath(e,t,s){for(var i=t.length-(s?0:1),n=0;n<i;n++)e=e[t[n]];return e}_setter(e,t,s){var i=this._resolvePath(e,t),n=t[t.length-1],a="set"+n.substring(0,1).toUpperCase()+n.substring(1);if(i[a]){var r=i["get"+n.substring(0,1).toUpperCase()+n.substring(1)].bind(i)();r=[r.x,r.y,r.z,r.w];var o=i[a].bind(i);return{set:e=>{o(s(e))},get:()=>r}}var l=i[n];if("object"==typeof l&&l.hasOwnProperty("copy"))return function(e){l.copy(s(e))};if(-1!==[wt,yt,bt,mt,kt].indexOf(i.constructor)&&t.length>1){var h=t.length>2?this._resolvePath(e,t.slice(0,-1)):e,c=t[t.length-2];return function(e){i[n]=s(e),h[c]=i}}return function(e){i[n]=s(e)}}_createAnimTargetForProperty(e,t,s){if(this.handlers&&t[0].startsWith("weight."))return this.handlers.weight(e,t[0].replace("weight.",""));if(this.handlers&&"material"===t[0]&&2===t.length){var i=t[1];if(i.endsWith("Map"))return this.handlers.materialTexture(e,i)}var n,a,r,o=this._resolvePath(e,t,!0);if(void 0===o)return null;if("number"==typeof o)n=this._setter(e,t,Cm._packFloat),a="vector",r=1;else if("boolean"==typeof o)n=this._setter(e,t,Cm._packBoolean),a="vector",r=1;else if("object"==typeof o)switch(o.constructor){case wt:n=this._setter(e,t,Cm._packVec2),a="vector",r=2;break;case yt:n=this._setter(e,t,Cm._packVec3),a="vector",r=3;break;case bt:n=this._setter(e,t,Cm._packVec4),a="vector",r=4;break;case mt:n=this._setter(e,t,Cm._packColor),a="vector",r=4;break;case kt:n=this._setter(e,t,Cm._packQuat),a="quaternion",r=4;break;default:return null}return-1!==t.indexOf("material")?new rm((t=>{n(t),e.material.update()}),a,r,s):new rm(n,a,r,s)}rebind(){this.targetCache={},this.animComponent.rootBone?this.graph=this.animComponent.rootBone:this.graph=this.animComponent.entity;var e={},t=function(s){e[s.name]=s;for(var i=0;i<s.children.length;++i)t(s.children[i])};t(this.graph),this.nodes=e}constructor(e,t,s,i,n){super(t),this.animComponent=e,this._mask=i,this.layerName=s,this.layerIndex=n}}class Sm{get name(){return this._name}set playing(e){this._controller.playing=e}get playing(){return this._controller.playing}get playable(){return this._controller.playable}get activeState(){return this._controller.activeStateName}get previousState(){return this._controller.previousStateName}get activeStateProgress(){return this._controller.activeStateProgress}get activeStateDuration(){return this._controller.activeStateDuration}set activeStateCurrentTime(e){var t=this._controller,s=t.playing;t.playing=!0,t.activeStateCurrentTime=e,s||t.update(0),t.playing=s}get activeStateCurrentTime(){return this._controller.activeStateCurrentTime}get transitioning(){return this._controller.transitioning}get transitionProgress(){return this.transitioning?this._controller.transitionProgress:null}get states(){return this._controller.states}set weight(e){this._weight=e,this._component.dirtifyTargets()}get weight(){return this._weight}set blendType(e){e!==this._blendType&&(this._blendType=e,this._controller.normalizeWeights&&this._component.rebind())}get blendType(){return this._blendType}set mask(e){this._controller.assignMask(e)&&this._component.rebind(),this._mask=e}get mask(){return this._mask}play(e){this._controller.play(e)}pause(){this._controller.pause()}reset(){this._controller.reset()}rebind(){this._controller.rebind()}update(e){this._blendTime&&(this._blendTimeElapsed<this._blendTime?(this.weight=pt.lerp(this._startingWeight,this._targetWeight,this._blendTimeElapsed/this._blendTime),this._blendTimeElapsed+=e):(this.weight=this._targetWeight,this._blendTime=0,this._blendTimeElapsed=0,this._startingWeight=0,this._targetWeight=0)),this._controller.update(e)}blendToWeight(e,t){this._startingWeight=this.weight,this._targetWeight=e,this._blendTime=Math.max(0,t),this._blendTimeElapsed=0}assignAnimation(e,t,s,i){t instanceof nm&&(this._controller.assignAnimation(e,t,s,i),0===this._controller._transitions.length&&this._controller._transitions.push(new fm({from:"START",to:e})),this._component.activate&&this._component.playable&&(this._component.playing=!0))}removeNodeAnimations(e){this._controller.removeNodeAnimations(e)&&(this._component.playing=!1)}getAnimationAsset(e){return this._component.animationAssets[this.name+":"+e]}transition(e,t,s){void 0===t&&(t=0),void 0===s&&(s=null),this._controller.updateStateFromTransition(new fm({from:this._controller.activeStateName,to:e,time:t,transitionOffset:s}))}constructor(e,t,s,i=1,n=Qp){this._mask=null,this._blendTime=0,this._blendTimeElapsed=0,this._startingWeight=0,this._targetWeight=0,this._name=e,this._controller=t,this._component=s,this._weight=i,this._blendType=n}}class Am{get parameters(){return Object.assign({},this._parameters)}get layers(){return this._layers}constructor(e){if(this._layers=[],this._parameters={},Array.isArray(e.layers))this._layers=e.layers;else for(var t in e.layers){for(var s=e.layers[t],i={name:s.name,blendType:s.blendType,weight:s.weight,states:[],transitions:[]},n=0;n<s.states.length;n++)i.states.push(e.states[s.states[n]]);for(var a=0;a<s.transitions.length;a++){var r=e.transitions[s.transitions[a]];if(r.conditions&&!Array.isArray(r.conditions)){for(var o=Object.keys(r.conditions),l=[],h=0;h<o.length;h++){var c=r.conditions[o[h]];c.parameterName&&l.push(c)}r.conditions=l}Number.isInteger(r.from)&&(r.from=e.states[r.from].name),Number.isInteger(r.to)&&(r.to=e.states[r.to].name),i.transitions.push(r)}this._layers.push(i)}for(var d in e.parameters){var u=e.parameters[d];this._parameters[u.name]={type:u.type,value:u.value}}}}function Tm(){return Tm=Object.assign||function(e){for(var t=1;t<arguments.length;t++){var s=arguments[t];for(var i in s)Object.prototype.hasOwnProperty.call(s,i)&&(e[i]=s[i])}return e},Tm.apply(this,arguments)}class Pm extends Op{set stateGraphAsset(e){if(null!==e){var t,s;if(this._stateGraphAsset)this.system.app.assets.get(this._stateGraphAsset).off("change",this._onStateGraphAssetChangeEvent,this);e instanceof dp?(t=e.id,(s=this.system.app.assets.get(t))||(this.system.app.assets.add(e),s=this.system.app.assets.get(t))):(t=e,s=this.system.app.assets.get(t)),s&&this._stateGraphAsset!==t&&(s.resource?(this._stateGraph=s.resource,this.loadStateGraph(this._stateGraph),s.on("change",this._onStateGraphAssetChangeEvent,this)):(s.once("load",(e=>{this._stateGraph=e.resource,this.loadStateGraph(this._stateGraph)})),s.on("change",this._onStateGraphAssetChangeEvent,this),this.system.app.assets.load(s)),this._stateGraphAsset=t)}else this.removeStateGraph()}get stateGraphAsset(){return this._stateGraphAsset}set normalizeWeights(e){this._normalizeWeights=e,this.unbind()}get normalizeWeights(){return this._normalizeWeights}set animationAssets(e){this._animationAssets=e,this.loadAnimationAssets()}get animationAssets(){return this._animationAssets}set speed(e){this._speed=e}get speed(){return this._speed}set activate(e){this._activate=e}get activate(){return this._activate}set playing(e){this._playing=e}get playing(){return this._playing}set rootBone(e){if("string"==typeof e){var t=this.entity.root.findByGuid(e);this._rootBone=t}else this._rootBone=e instanceof Ep?e:null;this.rebind()}get rootBone(){return this._rootBone}set stateGraph(e){this._stateGraph=e}get stateGraph(){return this._stateGraph}get layers(){return this._layers}set layerIndices(e){this._layerIndices=e}get layerIndices(){return this._layerIndices}set parameters(e){this._parameters=e}get parameters(){return this._parameters}set targets(e){this._targets=e}get targets(){return this._targets}get playable(){for(var e=0;e<this._layers.length;e++)if(!this._layers[e].playable)return!1;return!0}get baseLayer(){return this._layers.length>0?this._layers[0]:null}_onStateGraphAssetChangeEvent(e){var t=this.animationAssets,s=this.layers.map((e=>e.mask));this.removeStateGraph(),this._stateGraph=new Am(e._data),this.loadStateGraph(this._stateGraph),this.animationAssets=t,this.loadAnimationAssets(),this.layers.forEach(((e,t)=>{e.mask=s[t]})),this.rebind()}dirtifyTargets(){for(var e=Object.values(this._targets),t=0;t<e.length;t++)e[t].dirty=!0}_addLayer(e){var t,{name:s,states:i,transitions:n,weight:a,mask:r,blendType:o}=e;t=this.rootBone?this.rootBone:this.entity;var l=this._layers.length,h=new Cm(this,t,s,r,l),c=new sm(h),d=new vm(c,i,n,this._activate,this,this.findParameter,this.consumeTrigger);return this._layers.push(new Sm(s,d,this,a,o)),this._layerIndices[s]=l,this._layers[l]}addLayer(e,t,s,i){var n=this.findAnimationLayer(e);if(n)return n;return this._addLayer({name:e,states:[{name:"START",speed:1}],transitions:[],weight:t,mask:s,blendType:i})}_assignParameters(e){this._parameters={};for(var t=Object.keys(e.parameters),s=0;s<t.length;s++){var i=t[s];this._parameters[i]={type:e.parameters[i].type,value:e.parameters[i].value}}}loadStateGraph(e){this._stateGraph=e,this._assignParameters(e),this._layers=[];for(var t=!1,s=0;s<e.layers.length;s++){var i=e.layers[s];this._addLayer(Tm({},i)),i.states.some((e=>e.blendTree))&&(t=!0)}t||this.setupAnimationAssets()}setupAnimationAssets(){for(var e=0;e<this._layers.length;e++)for(var t=this._layers[e],s=t.name,i=0;i<t.states.length;i++){var n=t.states[i];if(-1===Jp.indexOf(n)){var a=s+":"+n;this._animationAssets[a]||(this._animationAssets[a]={asset:null})}}this.loadAnimationAssets()}loadAnimationAssets(){for(var e=0;e<this._layers.length;e++)for(var t=this._layers[e],s=0;s<t.states.length;s++){var i=t.states[s];if(-1===Jp.indexOf(i)){var n=this._animationAssets[t.name+":"+i];if(n&&n.asset){var a=n.asset,r=this.system.app.assets.get(a);r&&(r.resource?this.onAnimationAssetLoaded(t.name,i,r):(r.once("load",function(e,t){return function(s){this.onAnimationAssetLoaded(e,t,s)}.bind(this)}.bind(this)(t.name,i)),this.system.app.assets.load(r)))}else this.findAnimationLayer(t.name).assignAnimation(i,nm.EMPTY)}}}onAnimationAssetLoaded(e,t,s){this.findAnimationLayer(e).assignAnimation(t,s.resource)}removeStateGraph(){this._stateGraph=null,this._stateGraphAsset=null,this._animationAssets={},this._layers=[],this._layerIndices={},this._parameters={},this._playing=!1,this.unbind(),this._targets={}}reset(){this._assignParameters(this._stateGraph);for(var e=0;e<this._layers.length;e++){var t=this._layers[e].playing;this._layers[e].reset(),this._layers[e].playing=t}}unbind(){this._normalizeWeights||Object.keys(this._targets).forEach((e=>{this._targets[e].unbind()}))}rebind(){this._targets={};for(var e=0;e<this._layers.length;e++)this._layers[e].rebind()}findAnimationLayer(e){var t=this._layerIndices[e];return this._layers[t]||null}addAnimationState(e,t,s,i,n){void 0===s&&(s=1),void 0===i&&(i=!0),void 0===n&&(n="Base"),this._stateGraph||this.loadStateGraph(new Am({layers:[{name:n,states:[{name:"START",speed:1},{name:e,speed:s,loop:i,defaultState:!0}],transitions:[{from:"START",to:e}]}],parameters:{}}));var a,r=this.findAnimationLayer(n);r?r.assignAnimation(e,t,s,i):null==(a=this.addLayer(n))||a.assignAnimation(e,t,s,i)}assignAnimation(e,t,s,i,n){if(void 0===i&&(i=1),void 0===n&&(n=!0),!this._stateGraph&&-1===e.indexOf("."))return this.loadStateGraph(new Am({layers:[{name:"Base",states:[{name:"START",speed:1},{name:e,speed:i,loop:n,defaultState:!0}],transitions:[{from:"START",to:e}]}],parameters:{}})),void this.baseLayer.assignAnimation(e,t);var a=s?this.findAnimationLayer(s):this.baseLayer;a&&a.assignAnimation(e,t,i,n)}removeNodeAnimations(e,t){var s=t?this.findAnimationLayer(t):this.baseLayer;s&&s.removeNodeAnimations(e)}getParameterValue(e,t){var s=this._parameters[e];if(s&&s.type===t)return s.value}setParameterValue(e,t,s){var i=this._parameters[e];i&&i.type===t&&(i.value=s)}getFloat(e){return this.getParameterValue(e,qp)}setFloat(e,t){this.setParameterValue(e,qp,t)}getInteger(e){return this.getParameterValue(e,jp)}setInteger(e,t){"number"==typeof t&&t%1==0&&this.setParameterValue(e,jp,t)}getBoolean(e){return this.getParameterValue(e,Xp)}setBoolean(e,t){this.setParameterValue(e,Xp,!!t)}getTrigger(e){return this.getParameterValue(e,Yp)}setTrigger(e,t){void 0===t&&(t=!1),this.setParameterValue(e,Yp,!0),t&&this._consumedTriggers.add(e)}resetTrigger(e){this.setParameterValue(e,Yp,!1)}onBeforeRemove(){Number.isFinite(this._stateGraphAsset)&&this.system.app.assets.get(this._stateGraphAsset).off("change",this._onStateGraphAssetChangeEvent,this)}update(e){for(var t=0;t<this.layers.length;t++)this.layers[t].update(e*this.speed);this._consumedTriggers.forEach((e=>{this.parameters[e].value=!1})),this._consumedTriggers.clear()}resolveDuplicatedEntityReferenceProperties(e,t){e.rootBone&&t[e.rootBone.getGuid()]?this.rootBone=t[e.rootBone.getGuid()]:this.rebind()}constructor(...e){super(...e),this._stateGraphAsset=null,this._animationAssets={},this._speed=1,this._activate=!0,this._playing=!1,this._rootBone=null,this._stateGraph=null,this._layers=[],this._layerIndices={},this._parameters={},this._targets={},this._consumedTriggers=new Set,this._normalizeWeights=!1,this.findParameter=e=>this._parameters[e],this.consumeTrigger=e=>{this._consumedTriggers.add(e)}}}class Em{constructor(){this.enabled=!0}}var km=["enabled"];class Mm extends zp{initializeComponentData(e,t,s){super.initializeComponentData(e,t,km);var i=["animationAssets","stateGraph","layers","masks"];Object.keys(t).forEach((s=>{i.includes(s)||(e[s]=t[s])})),t.stateGraph&&(e.stateGraph=t.stateGraph,e.loadStateGraph(e.stateGraph)),t.layers&&t.layers.forEach(((t,s)=>{t._controller.states.forEach((i=>{t._controller._states[i]._animationList.forEach((i=>{if(i.animTrack&&i.animTrack!==nm.EMPTY)e.layers[s].assignAnimation(i.name,i.animTrack);else{var n=this.app.assets.get(t._component._animationAssets[t.name+":"+i.name].asset);n&&!n.loaded&&n.once("load",(()=>{e.layers[s].assignAnimation(i.name,n.resource)}))}}))}))})),t.animationAssets&&(e.animationAssets=Object.assign(e.animationAssets,t.animationAssets)),t.masks&&Object.keys(t.masks).forEach((s=>{if(e.layers[s]){var i=t.masks[s].mask,n={};Object.keys(i).forEach((e=>{n[decodeURI(e)]=i[e]})),e.layers[s].mask=n}}))}onAnimationUpdate(e){var t=this.store;for(var s in t)if(t.hasOwnProperty(s)){var i=t[s].entity.anim;i.data.enabled&&i.entity.enabled&&i.playing&&i.update(e)}}cloneComponent(e,t){var s;e.anim.rootBone&&e.anim.rootBone!==e||(s={},e.anim.layers.forEach(((e,i)=>{if(e.mask){var n={};Object.keys(e.mask).forEach((s=>{var i=s.split("/");i.shift();var a=[t.name,...i].join("/");n[a]=e.mask[s]})),s[i]={mask:n}}})));var i={enabled:e.anim.enabled,stateGraphAsset:e.anim.stateGraphAsset,animationAssets:e.anim.animationAssets,speed:e.anim.speed,activate:e.anim.activate,playing:e.anim.playing,rootBone:e.anim.rootBone,stateGraph:e.anim.stateGraph,layers:e.anim.layers,layerIndices:e.anim.layerIndices,parameters:e.anim.parameters,normalizeWeights:e.anim.normalizeWeights,masks:s};return this.addComponent(t,i)}onBeforeRemove(e,t){t.onBeforeRemove()}destroy(){super.destroy(),this.app.systems.off("animationUpdate",this.onAnimationUpdate,this)}constructor(e){super(e),this.id="anim",this.ComponentType=Pm,this.DataType=Em,this.schema=km,this.on("beforeremove",this.onBeforeRemove,this),this.app.systems.on("animationUpdate",this.onAnimationUpdate,this)}}Op._buildAccessors(Pm.prototype,km);class Im{destroy(e){this.map.forEach((e=>e.mesh.destroy()))}constructor(){this.map=new Map}}var Dm=new Ti;class Rm extends Dn{constructor(e,t){super(),this.skin=e,this.skinInstance=t}}class Lm{static createCachedSkinInstance(e,t,s){var i=Lm.getCachedSkinInstance(e,t);return i||((i=new No(e)).resolve(t,s),Lm.addCachedSkinInstance(e,t,i)),i}static getCachedSkinInstance(e,t){var s=null,i=Lm._skinInstanceCache.get(t);if(i){var n=i.find((t=>t.skin===e));n&&(n.incRefCount(),s=n.skinInstance)}return s}static addCachedSkinInstance(e,t,s){var i=Lm._skinInstanceCache.get(t);i||(i=[],Lm._skinInstanceCache.set(t,i));var n=i.find((t=>t.skin===e));n||(n=new Rm(e,s),i.push(n)),n.incRefCount()}static removeCachedSkinInstance(e){if(e){var t=e.rootBone;if(t){var s=Lm._skinInstanceCache.get(t);if(s){var i=s.findIndex((t=>t.skinInstance===e));if(i>=0){var n=s[i];n.decRefCount(),0===n.refCount&&(s.splice(i,1),s.length||Lm._skinInstanceCache.delete(t),e&&(e.destroy(),n.skinInstance=null))}}}}}}Lm._skinInstanceCache=new Map;class Fm{set id(e){if(this.url)throw Error("Can't set id and url");this._unbind(),this._id=e,this.asset=this._registry.get(this._id),this._bind()}get id(){return this._id}set url(e){if(this.id)throw Error("Can't set id and url");this._unbind(),this._url=e,this.asset=this._registry.getByUrl(this._url),this._bind()}get url(){return this._url}_bind(){this.id&&(this._onAssetLoad&&(this._evtLoadById=this._registry.on("load:"+this.id,this._onLoad,this)),this._onAssetAdd&&(this._evtAddById=this._registry.once("add:"+this.id,this._onAdd,this)),this._onAssetRemove&&(this._evtRemoveById=this._registry.on("remove:"+this.id,this._onRemove,this)),this._onAssetUnload&&(this._evtUnloadById=this._registry.on("unload:"+this.id,this._onUnload,this))),this.url&&(this._onAssetLoad&&(this._evtLoadByUrl=this._registry.on("load:url:"+this.url,this._onLoad,this)),this._onAssetAdd&&(this._evtAddByUrl=this._registry.once("add:url:"+this.url,this._onAdd,this)),this._onAssetRemove&&(this._evtRemoveByUrl=this._registry.on("remove:url:"+this.url,this._onRemove,this)))}_unbind(){var e,t,s,i,n,a,r;this.id&&(null==(e=this._evtLoadById)||e.off(),this._evtLoadById=null,null==(t=this._evtAddById)||t.off(),this._evtAddById=null,null==(s=this._evtRemoveById)||s.off(),this._evtRemoveById=null,null==(i=this._evtUnloadById)||i.off(),this._evtUnloadById=null);this.url&&(null==(n=this._evtLoadByUrl)||n.off(),this._evtLoadByUrl=null,null==(a=this._evtAddByUrl)||a.off(),this._evtAddByUrl=null,null==(r=this._evtRemoveByUrl)||r.off(),this._evtRemoveByUrl=null)}_onLoad(e){this._onAssetLoad.call(this._scope,this.propertyName,this.parent,e)}_onAdd(e){this.asset=e,this._onAssetAdd.call(this._scope,this.propertyName,this.parent,e)}_onRemove(e){this._onAssetRemove.call(this._scope,this.propertyName,this.parent,e),this.asset=null}_onUnload(e){this._onAssetUnload.call(this._scope,this.propertyName,this.parent,e)}constructor(e,t,s,i,n){this._evtLoadById=null,this._evtUnloadById=null,this._evtAddById=null,this._evtRemoveById=null,this._evtLoadByUrl=null,this._evtAddByUrl=null,this._evtRemoveByUrl=null,this.propertyName=e,this.parent=t,this._scope=n,this._registry=s,this.id=null,this.url=null,this.asset=null,this._onAssetLoad=i.load,this._onAssetAdd=i.add,this._onAssetRemove=i.remove,this._onAssetUnload=i.unload}}class Bm extends Op{set renderStyle(e){this._renderStyle!==e&&(this._renderStyle=e,sl._prepareRenderStyleForArray(this._meshInstances,e))}get renderStyle(){return this._renderStyle}set customAabb(e){this._customAabb=e;var t=this._meshInstances;if(t)for(var s=0;s<t.length;s++)t[s].setCustomAabb(this._customAabb)}get customAabb(){return this._customAabb}set type(e){if(this._type!==e&&(this._area=null,this._type=e,this.destroyMeshInstances(),"asset"!==e)){var t=this._material;t&&t!==this.system.defaultMaterial||(t=this._materialReferences[0]&&this._materialReferences[0].asset&&this._materialReferences[0].asset.resource);var s=((e,t)=>{var s=Dm.get(e,(()=>new Im)),i=s.map.get(t);if(!i){var n,a;switch(t){case"box":n=Wo.fromGeometry(e,new Jc),a={x:2,y:2,z:2,uv:2/3};break;case"capsule":n=Wo.fromGeometry(e,new yu({radius:.5,height:2})),a={x:2*Math.PI,y:Math.PI,z:2*Math.PI,uv:1/3+1/3/3*2};break;case"cone":n=Wo.fromGeometry(e,new xu({baseRadius:.5,peakRadius:0,height:1})),a={x:2.54,y:2.54,z:2.54,uv:1/3+1/3/3};break;case"cylinder":n=Wo.fromGeometry(e,new wu({radius:.5,height:1})),a={x:Math.PI,y:1.58,z:Math.PI,uv:1/3+1/3/3*2};break;case"plane":n=Wo.fromGeometry(e,new bu({halfExtents:new wt(.5,.5),widthSegments:1,lengthSegments:1})),a={x:0,y:1,z:0,uv:1};break;case"sphere":n=Wo.fromGeometry(e,new Qc({radius:.5})),a={x:Math.PI,y:Math.PI,z:Math.PI,uv:1};break;case"torus":n=Wo.fromGeometry(e,new Cu({tubeRadius:.2,ringRadius:.3})),a={x:.5*Math.PI*.5-.1*Math.PI*.1,y:.4,z:.4,uv:1};break;default:throw new Error("Invalid primitive type: "+t)}n.incRefCount(),i={mesh:n,area:a},s.map.set(t,i)}return i})(this.system.app.graphicsDevice,e);this._area=s.area,this.meshInstances=[new sl(s.mesh,t||this.system.defaultMaterial,this.entity)]}}get type(){return this._type}set meshInstances(e){if(this.destroyMeshInstances(),this._meshInstances=e,this._meshInstances){for(var t=this._meshInstances,s=0;s<t.length;s++)t[s].node||(t[s].node=this.entity),t[s].castShadow=this._castShadows,t[s].receiveShadow=this._receiveShadows,t[s].renderStyle=this._renderStyle,t[s].setLightmapped(this._lightmapped),t[s].setCustomAabb(this._customAabb);this.enabled&&this.entity.enabled&&this.addToLayers()}}get meshInstances(){return this._meshInstances}set lightmapped(e){if(e!==this._lightmapped){this._lightmapped=e;var t=this._meshInstances;if(t)for(var s=0;s<t.length;s++)t[s].setLightmapped(e)}}get lightmapped(){return this._lightmapped}set castShadows(e){if(this._castShadows!==e){var t=this._meshInstances;if(t){var s=this.layers,i=this.system.app.scene;if(this._castShadows&&!e)for(var n=0;n<s.length;n++){var a=i.layers.getLayerById(this.layers[n]);a&&a.removeShadowCasters(t)}for(var r=0;r<t.length;r++)t[r].castShadow=e;if(!this._castShadows&&e)for(var o=0;o<s.length;o++){var l=i.layers.getLayerById(s[o]);l&&l.addShadowCasters(t)}}this._castShadows=e}}get castShadows(){return this._castShadows}set receiveShadows(e){if(this._receiveShadows!==e){this._receiveShadows=e;var t=this._meshInstances;if(t)for(var s=0;s<t.length;s++)t[s].receiveShadow=e}}get receiveShadows(){return this._receiveShadows}set castShadowsLightmap(e){this._castShadowsLightmap=e}get castShadowsLightmap(){return this._castShadowsLightmap}set lightmapSizeMultiplier(e){this._lightmapSizeMultiplier=e}get lightmapSizeMultiplier(){return this._lightmapSizeMultiplier}set layers(e){var t,s=this.system.app.scene.layers;if(this._meshInstances)for(var i=0;i<this._layers.length;i++)(t=s.getLayerById(this._layers[i]))&&t.removeMeshInstances(this._meshInstances);this._layers.length=0;for(var n=0;n<e.length;n++)this._layers[n]=e[n];if(this.enabled&&this.entity.enabled&&this._meshInstances)for(var a=0;a<this._layers.length;a++)(t=s.getLayerById(this._layers[a]))&&t.addMeshInstances(this._meshInstances)}get layers(){return this._layers}set batchGroupId(e){if(this._batchGroupId!==e){var t,s;if(this.entity.enabled&&this._batchGroupId>=0)null==(t=this.system.app.batcher)||t.remove(zo.RENDER,this.batchGroupId,this.entity);if(this.entity.enabled&&e>=0)null==(s=this.system.app.batcher)||s.insert(zo.RENDER,e,this.entity);e<0&&this._batchGroupId>=0&&this.enabled&&this.entity.enabled&&this.addToLayers(),this._batchGroupId=e}}get batchGroupId(){return this._batchGroupId}set material(e){if(this._material!==e&&(this._material=e,this._meshInstances&&"asset"!==this._type))for(var t=0;t<this._meshInstances.length;t++)this._meshInstances[t].material=e}get material(){return this._material}set materialAssets(e){if(void 0===e&&(e=[]),this._materialReferences.length>e.length){for(var t=e.length;t<this._materialReferences.length;t++)this._materialReferences[t].id=null;this._materialReferences.length=e.length}for(var s=0;s<e.length;s++)if(this._materialReferences[s]||this._materialReferences.push(new Fm(s,this,this.system.app.assets,{add:this._onMaterialAdded,load:this._onMaterialLoad,remove:this._onMaterialRemove,unload:this._onMaterialUnload},this)),e[s]){var i=e[s]instanceof dp?e[s].id:e[s];this._materialReferences[s].id!==i&&(this._materialReferences[s].id=i),this._materialReferences[s].asset&&this._onMaterialAdded(s,this,this._materialReferences[s].asset)}else this._materialReferences[s].id=null,this._meshInstances[s]&&(this._meshInstances[s].material=this.system.defaultMaterial)}get materialAssets(){return this._materialReferences.map((e=>e.id))}set asset(e){var t=e instanceof dp?e.id:e;this._assetReference.id!==t&&(this._assetReference.asset&&this._assetReference.asset.resource&&this._onRenderAssetRemove(),this._assetReference.id=t,this._assetReference.asset&&this._onRenderAssetAdded())}get asset(){return this._assetReference.id}assignAsset(e){var t=e instanceof dp?e.id:e;this._assetReference.id=t}set rootBone(e){if(this._rootBone!==e){var t="string"==typeof e;if(this._rootBone&&t&&this._rootBone.getGuid()===e)return;this._rootBone&&this._clearSkinInstances(),this._rootBone=e instanceof Il?e:t&&this.system.app.getEntityFromIndex(e)||null,this._rootBone&&this._cloneSkinInstances()}}get rootBone(){return this._rootBone}destroyMeshInstances(){var e=this._meshInstances;if(e){this.removeFromLayers(),this._clearSkinInstances();for(var t=0;t<e.length;t++)e[t].destroy();this._meshInstances.length=0}}addToLayers(){for(var e=this.system.app.scene.layers,t=0;t<this._layers.length;t++){var s=e.getLayerById(this._layers[t]);s&&s.addMeshInstances(this._meshInstances)}}removeFromLayers(){if(this._meshInstances&&this._meshInstances.length)for(var e=this.system.app.scene.layers,t=0;t<this._layers.length;t++){var s=e.getLayerById(this._layers[t]);s&&s.removeMeshInstances(this._meshInstances)}}onRemoveChild(){this.removeFromLayers()}onInsertChild(){this._meshInstances&&this.enabled&&this.entity.enabled&&this.addToLayers()}onRemove(){this.destroyMeshInstances(),this.asset=null,this.materialAsset=null,this._assetReference.id=null;for(var e=0;e<this._materialReferences.length;e++)this._materialReferences[e].id=null;this.entity.off("remove",this.onRemoveChild,this),this.entity.off("insert",this.onInsertChild,this)}onLayersChanged(e,t){this.addToLayers(),e.off("add",this.onLayerAdded,this),e.off("remove",this.onLayerRemoved,this),t.on("add",this.onLayerAdded,this),t.on("remove",this.onLayerRemoved,this)}onLayerAdded(e){this.layers.indexOf(e.id)<0||e.addMeshInstances(this._meshInstances)}onLayerRemoved(e){this.layers.indexOf(e.id)<0||e.removeMeshInstances(this._meshInstances)}onEnable(){var e=this.system.app,t=e.scene,s=t.layers;this._rootBone&&this._cloneSkinInstances(),this._evtLayersChanged=t.on("set:layers",this.onLayersChanged,this),s&&(this._evtLayerAdded=s.on("add",this.onLayerAdded,this),this._evtLayerRemoved=s.on("remove",this.onLayerRemoved,this));var i,n="asset"===this._type;this._meshInstances&&this._meshInstances.length?this.addToLayers():n&&this.asset&&this._onRenderAssetAdded();for(var a=0;a<this._materialReferences.length;a++)this._materialReferences[a].asset&&this.system.app.assets.load(this._materialReferences[a].asset);this._batchGroupId>=0&&(null==(i=e.batcher)||i.insert(zo.RENDER,this.batchGroupId,this.entity))}onDisable(){var e,t,s,i,n=this.system.app,a=n.scene.layers;(null==(e=this._evtLayersChanged)||e.off(),this._evtLayersChanged=null,this._rootBone&&this._clearSkinInstances(),a)&&(null==(t=this._evtLayerAdded)||t.off(),this._evtLayerAdded=null,null==(s=this._evtLayerRemoved)||s.off(),this._evtLayerRemoved=null);this._batchGroupId>=0&&(null==(i=n.batcher)||i.remove(zo.RENDER,this.batchGroupId,this.entity));this.removeFromLayers()}hide(){if(this._meshInstances)for(var e=0;e<this._meshInstances.length;e++)this._meshInstances[e].visible=!1}show(){if(this._meshInstances)for(var e=0;e<this._meshInstances.length;e++)this._meshInstances[e].visible=!0}_onRenderAssetAdded(){this._assetReference.asset&&(this._assetReference.asset.resource?this._onRenderAssetLoad():this.enabled&&this.entity.enabled&&this.system.app.assets.load(this._assetReference.asset))}_onRenderAssetLoad(){if(this.destroyMeshInstances(),this._assetReference.asset){var e,t=this._assetReference.asset.resource;null==(e=this._evtSetMeshes)||e.off(),this._evtSetMeshes=t.on("set:meshes",this._onSetMeshes,this),t.meshes&&this._onSetMeshes(t.meshes)}}_onSetMeshes(e){this._cloneMeshes(e)}_clearSkinInstances(){for(var e=0;e<this._meshInstances.length;e++){var t=this._meshInstances[e];Lm.removeCachedSkinInstance(t.skinInstance),t.skinInstance=null}}_cloneSkinInstances(){if(this._meshInstances.length&&this._rootBone instanceof Il)for(var e=0;e<this._meshInstances.length;e++){var t=this._meshInstances[e],s=t.mesh;s.skin&&!t.skinInstance&&(t.skinInstance=Lm.createCachedSkinInstance(s.skin,this._rootBone,this.entity))}}_cloneMeshes(e){if(e&&e.length){for(var t=[],s=0;s<e.length;s++){var i=e[s],n=this._materialReferences[s]&&this._materialReferences[s].asset&&this._materialReferences[s].asset.resource,a=new sl(i,n||this.system.defaultMaterial,this.entity);t.push(a),i.morph&&(a.morphInstance=new Oc(i.morph))}this.meshInstances=t,this._cloneSkinInstances()}}_onRenderAssetUnload(){"asset"===this._type&&this.destroyMeshInstances()}_onRenderAssetRemove(){var e;null==(e=this._evtSetMeshes)||e.off(),this._evtSetMeshes=null,this._onRenderAssetUnload()}_onMaterialAdded(e,t,s){s.resource?this._onMaterialLoad(e,t,s):this.enabled&&this.entity.enabled&&this.system.app.assets.load(s)}_updateMainMaterial(e,t){0===e&&(this.material=t)}_onMaterialLoad(e,t,s){this._meshInstances[e]&&(this._meshInstances[e].material=s.resource),this._updateMainMaterial(e,s.resource)}_onMaterialRemove(e,t,s){this._meshInstances[e]&&(this._meshInstances[e].material=this.system.defaultMaterial),this._updateMainMaterial(e,this.system.defaultMaterial)}_onMaterialUnload(e,t,s){this._meshInstances[e]&&(this._meshInstances[e].material=this.system.defaultMaterial),this._updateMainMaterial(e,this.system.defaultMaterial)}resolveDuplicatedEntityReferenceProperties(e,t){e.rootBone&&(this.rootBone=t[e.rootBone.getGuid()])}constructor(e,t){super(e,t),this._type="asset",this._castShadows=!0,this._receiveShadows=!0,this._castShadowsLightmap=!0,this._lightmapped=!1,this._lightmapSizeMultiplier=1,this.isStatic=!1,this._batchGroupId=-1,this._layers=[0],this._renderStyle=0,this._meshInstances=[],this._customAabb=null,this._area=null,this._materialReferences=[],this._rootBone=null,this._evtLayersChanged=null,this._evtLayerAdded=null,this._evtLayerRemoved=null,this._evtSetMeshes=null,this._assetReference=new Fm("asset",this,e.app.assets,{add:this._onRenderAssetAdded,load:this._onRenderAssetLoad,remove:this._onRenderAssetRemove,unload:this._onRenderAssetUnload},this),this._material=e.defaultMaterial,t.on("remove",this.onRemoveChild,this),t.on("removehierarchy",this.onRemoveChild,this),t.on("insert",this.onInsertChild,this),t.on("inserthierarchy",this.onInsertChild,this)}}class Om{constructor(){this.enabled=!0}}var zm=["enabled"],Vm=["material","meshInstances","asset","materialAssets","castShadows","receiveShadows","castShadowsLightmap","lightmapped","lightmapSizeMultiplier","renderStyle","type","layers","isStatic","batchGroupId","rootBone"];class Nm extends zp{initializeComponentData(e,t,s){null!==t.batchGroupId&&void 0!==t.batchGroupId||(t.batchGroupId=-1),t.layers&&t.layers.length&&(t.layers=t.layers.slice(0));for(var i=0;i<Vm.length;i++)t.hasOwnProperty(Vm[i])&&(e[Vm[i]]=t[Vm[i]]);t.aabbCenter&&t.aabbHalfExtents&&(e.customAabb=new Ft(new yt(t.aabbCenter),new yt(t.aabbHalfExtents))),super.initializeComponentData(e,t,zm)}cloneComponent(e,t){for(var s={},i=0;i<Vm.length;i++)s[Vm[i]]=e.render[Vm[i]];s.enabled=e.render.enabled,delete s.meshInstances;var n=this.addComponent(t,s),a=e.render.meshInstances,r=a.map((e=>e.mesh));n._onSetMeshes(r);for(var o=0;o<a.length;o++)n.meshInstances[o].material=a[o].material;return e.render.customAabb&&(n.customAabb=e.render.customAabb.clone()),n}onRemove(e,t){t.onRemove()}constructor(e){super(e),this.id="render",this.ComponentType=Bm,this.DataType=Om,this.schema=zm,this.defaultMaterial=qo(e.graphicsDevice),this.on("beforeremove",this.onRemove,this)}}Op._buildAccessors(Bm.prototype,zm);class Um{constructor(e,t){this.effect=e,this.inputTarget=t,this.outputTarget=null,this.name=e.constructor.name}}class Hm{_allocateColorBuffer(e,t){var s,i,n=this.camera.rect,a=this.destinationRenderTarget,r=this.app.graphicsDevice,o=Math.floor(n.z*(null!=(s=null==a?void 0:a.width)?s:r.width)),l=Math.floor(n.w*(null!=(i=null==a?void 0:a.height)?i:r.height));return new ki(r,{name:t,format:e,width:o,height:l,mipmaps:!1,minFilter:0,magFilter:0,addressU:1,addressV:1})}_createOffscreenTarget(e,t){var s,i,n=this.app.graphicsDevice,a=(null!=(s=this.destinationRenderTarget)?s:n.backBuffer).isColorBufferSrgb(0),r=null!=(i=t&&n.getRenderableHdrFormat([Kt,Zt],!0))?i:a?ss:7,o=this.camera.entity.name+"-posteffect-"+this.effects.length,l=this._allocateColorBuffer(r,o);return new ln({colorBuffer:l,depth:e,stencil:e&&this.app.graphicsDevice.supportsStencil,samples:e?n.samples:1})}_resizeOffscreenTarget(e){var t=e.colorBuffer.format,s=e.colorBuffer.name;e.destroyFrameBuffers(),e.destroyTextureBuffers(),e._colorBuffer=this._allocateColorBuffer(t,s),e._colorBuffers=[e._colorBuffer]}_destroyOffscreenTarget(e){e.destroyTextureBuffers(),e.destroy()}addEffect(e){var t=this.effects,s=0===t.length,i=this._createOffscreenTarget(s,e.hdr),n=new Um(e,i);t.push(n),this._sourceTarget=n.inputTarget,t.length>1&&(t[t.length-2].outputTarget=n.inputTarget),this._newPostEffect=e,e.needsDepthBuffer&&this._requestDepthMap(),this.enable(),this._newPostEffect=void 0}removeEffect(e){for(var t=-1,s=0,i=this.effects.length;s<i;s++)if(this.effects[s].effect===e){t=s;break}t>=0&&(t>0?this.effects[t-1].outputTarget=t+1<this.effects.length?this.effects[t+1].inputTarget:null:this.effects.length>1&&(this.effects[1].inputTarget._depth||(this._destroyOffscreenTarget(this.effects[1].inputTarget),this.effects[1].inputTarget=this._createOffscreenTarget(!0,this.effects[1].hdr),this._sourceTarget=this.effects[1].inputTarget),this.camera.renderTarget=this.effects[1].inputTarget),this._destroyOffscreenTarget(this.effects[t].inputTarget),this.effects.splice(t,1)),this.enabled&&e.needsDepthBuffer&&this._releaseDepthMap(),0===this.effects.length&&this.disable()}_requestDepthMaps(){for(var e=0,t=this.effects.length;e<t;e++){var s=this.effects[e].effect;this._newPostEffect!==s&&(s.needsDepthBuffer&&this._requestDepthMap())}}_releaseDepthMaps(){for(var e=0,t=this.effects.length;e<t;e++){this.effects[e].effect.needsDepthBuffer&&this._releaseDepthMap()}}_requestDepthMap(){var e=this.app.scene.layers.getLayerById(1);e&&(e.incrementCounter(),this.camera.requestSceneDepthMap(!0))}_releaseDepthMap(){var e=this.app.scene.layers.getLayerById(1);e&&(e.decrementCounter(),this.camera.requestSceneDepthMap(!1))}destroy(){for(var e=0,t=this.effects.length;e<t;e++)this.effects[e].inputTarget.destroy();this.effects.length=0,this.disable()}enable(){!this.enabled&&this.effects.length&&(this.enabled=!0,this._requestDepthMaps(),this.app.graphicsDevice.on("resizecanvas",this._onCanvasResized,this),this.destinationRenderTarget=this.camera.renderTarget,this.camera.renderTarget=this.effects[0].inputTarget,this.camera.onPostprocessing=()=>{if(this.enabled){var e=null,t=this.effects.length;if(t)for(var s=0;s<t;s++){var i=this.effects[s],n=i.outputTarget;s===t-1&&(e=this.camera.rect,this.destinationRenderTarget&&(n=this.destinationRenderTarget)),i.effect.render(i.inputTarget,n,e)}}})}disable(){this.enabled&&(this.enabled=!1,this.app.graphicsDevice.off("resizecanvas",this._onCanvasResized,this),this._releaseDepthMaps(),this._destroyOffscreenTarget(this._sourceTarget),this.camera.renderTarget=this.destinationRenderTarget,this.camera.onPostprocessing=null)}_onCanvasResized(e,t){var s,i,n=this.camera.rect,a=this.destinationRenderTarget;e=null!=(s=null==a?void 0:a.width)?s:e,t=null!=(i=null==a?void 0:a.height)?i:t,this.camera.camera.aspectRatio=e*n.z/(t*n.w),this.resizeRenderTargets()}resizeRenderTargets(){for(var e,t,s=this.app.graphicsDevice,i=this.destinationRenderTarget,n=null!=(e=null==i?void 0:i.width)?e:s.width,a=null!=(t=null==i?void 0:i.height)?t:s.height,r=this.camera.rect,o=Math.floor(r.z*n),l=Math.floor(r.w*a),h=this.effects,c=0,d=h.length;c<d;c++){var u=h[c];u.inputTarget.width===o&&u.inputTarget.height===l||this._resizeOffscreenTarget(u.inputTarget)}}onCameraRectChanged(e,t,s){this.enabled&&this.resizeRenderTargets()}constructor(e,t){this.app=e,this.camera=t,this.destinationRenderTarget=null,this.effects=[],this.enabled=!1,this.depthTarget=null,t.on("set:rect",this.onCameraRectChanged,this)}}class Gm extends Op{setShaderPass(e){var t=Ao.get(this.system.app.graphicsDevice),s=e?t.allocate(e,{isForward:!0}):null;return this._camera.shaderPassInfo=s,s.index}getShaderPass(){var e;return null==(e=this._camera.shaderPassInfo)?void 0:e.name}set renderPasses(e){this._camera.renderPasses=e||[],this.dirtyLayerCompositionCameras(),this.system.app.scene.updateShaders=!0}get renderPasses(){return this._camera.renderPasses}get shaderParams(){return this._camera.shaderParams}set gammaCorrection(e){this.camera.shaderParams.gammaCorrection=e}get gammaCorrection(){return this.camera.shaderParams.gammaCorrection}set toneMapping(e){this.camera.shaderParams.toneMapping=e}get toneMapping(){return this.camera.shaderParams.toneMapping}set fog(e){this._camera.fogParams=e}get fog(){return this._camera.fogParams}set aperture(e){this._camera.aperture=e}get aperture(){return this._camera.aperture}set aspectRatio(e){this._camera.aspectRatio=e}get aspectRatio(){return this._camera.aspectRatio}set aspectRatioMode(e){this._camera.aspectRatioMode=e}get aspectRatioMode(){return this._camera.aspectRatioMode}set calculateProjection(e){this._camera.calculateProjection=e}get calculateProjection(){return this._camera.calculateProjection}set calculateTransform(e){this._camera.calculateTransform=e}get calculateTransform(){return this._camera.calculateTransform}get camera(){return this._camera}set clearColor(e){this._camera.clearColor=e}get clearColor(){return this._camera.clearColor}set clearColorBuffer(e){this._camera.clearColorBuffer=e,this.dirtyLayerCompositionCameras()}get clearColorBuffer(){return this._camera.clearColorBuffer}set clearDepthBuffer(e){this._camera.clearDepthBuffer=e,this.dirtyLayerCompositionCameras()}get clearDepthBuffer(){return this._camera.clearDepthBuffer}set clearStencilBuffer(e){this._camera.clearStencilBuffer=e,this.dirtyLayerCompositionCameras()}get clearStencilBuffer(){return this._camera.clearStencilBuffer}set cullFaces(e){this._camera.cullFaces=e}get cullFaces(){return this._camera.cullFaces}set disablePostEffectsLayer(e){this._disablePostEffectsLayer=e,this.dirtyLayerCompositionCameras()}get disablePostEffectsLayer(){return this._disablePostEffectsLayer}set farClip(e){this._camera.farClip=e}get farClip(){return this._camera.farClip}set flipFaces(e){this._camera.flipFaces=e}get flipFaces(){return this._camera.flipFaces}set fov(e){this._camera.fov=e}get fov(){return this._camera.fov}get frustum(){return this._camera.frustum}set frustumCulling(e){this._camera.frustumCulling=e}get frustumCulling(){return this._camera.frustumCulling}set horizontalFov(e){this._camera.horizontalFov=e}get horizontalFov(){return this._camera.horizontalFov}set layers(e){var t=this._camera.layers,s=this.system.app.scene;t.forEach((e=>{var t=s.layers.getLayerById(e);null==t||t.removeCamera(this)})),this._camera.layers=e,this.enabled&&this.entity.enabled&&e.forEach((e=>{var t=s.layers.getLayerById(e);null==t||t.addCamera(this)}))}get layers(){return this._camera.layers}get layersSet(){return this._camera.layersSet}set jitter(e){this._camera.jitter=e}get jitter(){return this._camera.jitter}set nearClip(e){this._camera.nearClip=e}get nearClip(){return this._camera.nearClip}set orthoHeight(e){this._camera.orthoHeight=e}get orthoHeight(){return this._camera.orthoHeight}get postEffects(){return this._postEffects}get postEffectsEnabled(){return this._postEffects.enabled}set priority(e){this._priority=e,this.dirtyLayerCompositionCameras()}get priority(){return this._priority}set projection(e){this._camera.projection=e}get projection(){return this._camera.projection}get projectionMatrix(){return this._camera.projectionMatrix}set rect(e){this._camera.rect=e,this.fire("set:rect",this._camera.rect)}get rect(){return this._camera.rect}set renderSceneColorMap(e){e&&!this._sceneColorMapRequested?(this.requestSceneColorMap(!0),this._sceneColorMapRequested=!0):this._sceneColorMapRequested&&(this.requestSceneColorMap(!1),this._sceneColorMapRequested=!1)}get renderSceneColorMap(){return this._renderSceneColorMap>0}set renderSceneDepthMap(e){e&&!this._sceneDepthMapRequested?(this.requestSceneDepthMap(!0),this._sceneDepthMapRequested=!0):this._sceneDepthMapRequested&&(this.requestSceneDepthMap(!1),this._sceneDepthMapRequested=!1)}get renderSceneDepthMap(){return this._renderSceneDepthMap>0}set renderTarget(e){this._camera.renderTarget=e,this.dirtyLayerCompositionCameras()}get renderTarget(){return this._camera.renderTarget}set scissorRect(e){this._camera.scissorRect=e}get scissorRect(){return this._camera.scissorRect}set sensitivity(e){this._camera.sensitivity=e}get sensitivity(){return this._camera.sensitivity}set shutter(e){this._camera.shutter=e}get shutter(){return this._camera.shutter}get viewMatrix(){return this._camera.viewMatrix}_enableDepthLayer(e){if(this.layers.find((e=>1===e))){var t=this.system.app.scene.layers.getLayerById(1);e?null==t||t.incrementCounter():null==t||t.decrementCounter()}else if(e)return!1;return!0}requestSceneColorMap(e){this._renderSceneColorMap+=e?1:-1,this._enableDepthLayer(e),this.camera._enableRenderPassColorGrab(this.system.app.graphicsDevice,this.renderSceneColorMap)}requestSceneDepthMap(e){this._renderSceneDepthMap+=e?1:-1,this._enableDepthLayer(e),this.camera._enableRenderPassDepthGrab(this.system.app.graphicsDevice,this.system.app.renderer,this.renderSceneDepthMap)}dirtyLayerCompositionCameras(){this.system.app.scene.layers._dirty=!0}screenToWorld(e,t,s,i){var n=this.system.app.graphicsDevice,{width:a,height:r}=n.clientRect;return this._camera.screenToWorld(e,t,s,a,r,i)}worldToScreen(e,t){var s=this.system.app.graphicsDevice,{width:i,height:n}=s.clientRect;return this._camera.worldToScreen(e,i,n,t)}onAppPrerender(){this._camera._viewMatDirty=!0,this._camera._viewProjMatDirty=!0}addCameraToLayers(){for(var e=this.layers,t=0;t<e.length;t++){var s=this.system.app.scene.layers.getLayerById(e[t]);s&&s.addCamera(this)}}removeCameraFromLayers(){for(var e=this.layers,t=0;t<e.length;t++){var s=this.system.app.scene.layers.getLayerById(e[t]);s&&s.removeCamera(this)}}onLayersChanged(e,t){this.addCameraToLayers(),e.off("add",this.onLayerAdded,this),e.off("remove",this.onLayerRemoved,this),t.on("add",this.onLayerAdded,this),t.on("remove",this.onLayerRemoved,this)}onLayerAdded(e){this.layers.indexOf(e.id)<0||e.addCamera(this)}onLayerRemoved(e){this.layers.indexOf(e.id)<0||e.removeCamera(this)}onEnable(){var e,t,s,i=this.system.app.scene,n=i.layers;(this.system.addCamera(this),null==(e=this._evtLayersChanged)||e.off(),this._evtLayersChanged=i.on("set:layers",this.onLayersChanged,this),n)&&(null==(t=this._evtLayerAdded)||t.off(),this._evtLayerAdded=n.on("add",this.onLayerAdded,this),null==(s=this._evtLayerRemoved)||s.off(),this._evtLayerRemoved=n.on("remove",this.onLayerRemoved,this));this.enabled&&this.entity.enabled&&this.addCameraToLayers(),this.postEffects.enable()}onDisable(){var e,t,s,i=this.system.app.scene.layers;(this.postEffects.disable(),this.removeCameraFromLayers(),null==(e=this._evtLayersChanged)||e.off(),this._evtLayersChanged=null,i)&&(null==(t=this._evtLayerAdded)||t.off(),this._evtLayerAdded=null,null==(s=this._evtLayerRemoved)||s.off(),this._evtLayerRemoved=null);this.system.removeCamera(this)}onRemove(){this.onDisable(),this.off(),this.camera.destroy()}calculateAspectRatio(e){var t=this.system.app.graphicsDevice,s=e?e.width:t.width,i=e?e.height:t.height;return s*this.rect.z/(i*this.rect.w)}frameUpdate(e){0===this.aspectRatioMode&&(this.aspectRatio=this.calculateAspectRatio(e))}startXr(e,t,s){this.system.app.xr.start(this,e,t,s)}endXr(e){this._camera.xr?this._camera.xr.end(e):e&&e(new Error("Camera is not in XR"))}copy(e){this.aperture=e.aperture,this.aspectRatio=e.aspectRatio,this.aspectRatioMode=e.aspectRatioMode,this.calculateProjection=e.calculateProjection,this.calculateTransform=e.calculateTransform,this.clearColor=e.clearColor,this.clearColorBuffer=e.clearColorBuffer,this.clearDepthBuffer=e.clearDepthBuffer,this.clearStencilBuffer=e.clearStencilBuffer,this.cullFaces=e.cullFaces,this.disablePostEffectsLayer=e.disablePostEffectsLayer,this.farClip=e.farClip,this.flipFaces=e.flipFaces,this.fov=e.fov,this.frustumCulling=e.frustumCulling,this.horizontalFov=e.horizontalFov,this.layers=e.layers,this.nearClip=e.nearClip,this.orthoHeight=e.orthoHeight,this.priority=e.priority,this.projection=e.projection,this.rect=e.rect,this.renderTarget=e.renderTarget,this.scissorRect=e.scissorRect,this.sensitivity=e.sensitivity,this.shutter=e.shutter}constructor(e,t){super(e,t),this.onPostprocessing=null,this._renderSceneDepthMap=0,this._renderSceneColorMap=0,this._sceneDepthMapRequested=!1,this._sceneColorMapRequested=!1,this._priority=0,this._disablePostEffectsLayer=4,this._camera=new pl,this._evtLayersChanged=null,this._evtLayerAdded=null,this._evtLayerRemoved=null,this._camera.node=t,this._postEffects=new Hm(e.app,this)}}class Wm{constructor(){this.enabled=!0}}var jm=["enabled"];class qm extends zp{initializeComponentData(e,t,s){s=["aspectRatio","aspectRatioMode","calculateProjection","calculateTransform","clearColor","clearColorBuffer","clearDepthBuffer","clearStencilBuffer","renderSceneColorMap","renderSceneDepthMap","cullFaces","farClip","flipFaces","fov","frustumCulling","horizontalFov","layers","renderTarget","nearClip","orthoHeight","projection","priority","rect","scissorRect","aperture","shutter","sensitivity","gammaCorrection","toneMapping"];for(var i=0;i<s.length;i++){var n=s[i];if(t.hasOwnProperty(n)){var a=t[n];switch(n){case"rect":case"scissorRect":Array.isArray(a)?e[n]=new bt(a[0],a[1],a[2],a[3]):e[n]=a;break;case"clearColor":Array.isArray(a)?e[n]=new mt(a[0],a[1],a[2],a[3]):e[n]=a;break;default:e[n]=a}}}super.initializeComponentData(e,t,["enabled"])}cloneComponent(e,t){var s=e.camera;return this.addComponent(t,{aspectRatio:s.aspectRatio,aspectRatioMode:s.aspectRatioMode,calculateProjection:s.calculateProjection,calculateTransform:s.calculateTransform,clearColor:s.clearColor,clearColorBuffer:s.clearColorBuffer,clearDepthBuffer:s.clearDepthBuffer,clearStencilBuffer:s.clearStencilBuffer,renderSceneDepthMap:s.renderSceneDepthMap,renderSceneColorMap:s.renderSceneColorMap,cullFaces:s.cullFaces,enabled:s.enabled,farClip:s.farClip,flipFaces:s.flipFaces,fov:s.fov,frustumCulling:s.frustumCulling,horizontalFov:s.horizontalFov,layers:s.layers,renderTarget:s.renderTarget,nearClip:s.nearClip,orthoHeight:s.orthoHeight,projection:s.projection,priority:s.priority,rect:s.rect,scissorRect:s.scissorRect,aperture:s.aperture,sensitivity:s.sensitivity,shutter:s.shutter,gammaCorrection:s.gammaCorrection,toneMapping:s.toneMapping})}onBeforeRemove(e,t){this.removeCamera(t),t.onRemove()}onAppPrerender(){for(var e=0,t=this.cameras.length;e<t;e++)this.cameras[e].onAppPrerender()}addCamera(e){this.cameras.push(e),Sc(this.cameras)}removeCamera(e){var t=this.cameras.indexOf(e);t>=0&&(this.cameras.splice(t,1),Sc(this.cameras))}destroy(){this.app.off("prerender",this.onAppPrerender,this),super.destroy()}constructor(e){super(e),this.cameras=[],this.id="camera",this.ComponentType=Gm,this.DataType=Wm,this.schema=jm,this.on("beforeremove",this.onBeforeRemove,this),this.app.on("prerender",this.onAppPrerender,this)}}Op._buildAccessors(Gm.prototype,jm);class Xm{constructor(){this.enabled=!0,this.type="directional",this.color=new mt(1,1,1),this.intensity=1,this.luminance=0,this.shape=0,this.affectSpecularity=!0,this.castShadows=!1,this.shadowDistance=40,this.shadowIntensity=1,this.shadowResolution=1024,this.shadowBias=.05,this.numCascades=1,this.cascadeBlend=0,this.bakeNumSamples=1,this.bakeArea=0,this.cascadeDistribution=.5,this.normalOffsetBias=0,this.range=10,this.innerConeAngle=40,this.outerConeAngle=45,this.falloffMode=0,this.shadowType=0,this.vsmBlurSize=11,this.vsmBlurMode=1,this.vsmBias=.0025,this.cookieAsset=null,this.cookie=null,this.cookieIntensity=1,this.cookieFalloff=!0,this.cookieChannel="rgb",this.cookieAngle=0,this.cookieScale=null,this.cookieOffset=null,this.shadowUpdateMode=2,this.mask=1,this.affectDynamic=!0,this.affectLightmapped=!1,this.bake=!1,this.bakeDir=!0,this.isStatic=!1,this.layers=[0],this.penumbraSize=1,this.penumbraFalloff=1,this.shadowSamples=16,this.shadowBlockerSamples=16}}var Ym=Object.keys(new Xm);class $m extends Op{get data(){var e=this.system.store[this.entity.getGuid()];return e?e.data:null}set enabled(e){this._setValue("enabled",e,(function(e,t){this.onSetEnabled(null,t,e)}))}get enabled(){return this.data.enabled}set light(e){this._setValue("light",e)}get light(){return this.data.light}set type(e){this._setValue("type",e,(function(e,t){this.system.changeType(this,t,e),this.refreshProperties()}))}get type(){return this.data.type}set color(e){this._setValue("color",e,(function(e,t){this.light.setColor(e)}),!0)}get color(){return this.data.color}set intensity(e){this._setValue("intensity",e,(function(e,t){this.light.intensity=e}))}get intensity(){return this.data.intensity}set luminance(e){this._setValue("luminance",e,(function(e,t){this.light.luminance=e}))}get luminance(){return this.data.luminance}set shape(e){this._setValue("shape",e,(function(e,t){this.light.shape=e}))}get shape(){return this.data.shape}set affectSpecularity(e){this._setValue("affectSpecularity",e,(function(e,t){this.light.affectSpecularity=e}))}get affectSpecularity(){return this.data.affectSpecularity}set castShadows(e){this._setValue("castShadows",e,(function(e,t){this.light.castShadows=e}))}get castShadows(){return this.data.castShadows}set shadowDistance(e){this._setValue("shadowDistance",e,(function(e,t){this.light.shadowDistance=e}))}get shadowDistance(){return this.data.shadowDistance}set shadowIntensity(e){this._setValue("shadowIntensity",e,(function(e,t){this.light.shadowIntensity=e}))}get shadowIntensity(){return this.data.shadowIntensity}set shadowResolution(e){this._setValue("shadowResolution",e,(function(e,t){this.light.shadowResolution=e}))}get shadowResolution(){return this.data.shadowResolution}set shadowBias(e){this._setValue("shadowBias",e,(function(e,t){this.light.shadowBias=-.01*pt.clamp(e,0,1)}))}get shadowBias(){return this.data.shadowBias}set numCascades(e){this._setValue("numCascades",e,(function(e,t){this.light.numCascades=pt.clamp(Math.floor(e),1,4)}))}get numCascades(){return this.data.numCascades}set cascadeBlend(e){this._setValue("cascadeBlend",e,(function(e,t){this.light.cascadeBlend=pt.clamp(e,0,1)}))}get cascadeBlend(){return this.data.cascadeBlend}set bakeNumSamples(e){this._setValue("bakeNumSamples",e,(function(e,t){this.light.bakeNumSamples=pt.clamp(Math.floor(e),1,255)}))}get bakeNumSamples(){return this.data.bakeNumSamples}set bakeArea(e){this._setValue("bakeArea",e,(function(e,t){this.light.bakeArea=pt.clamp(e,0,180)}))}get bakeArea(){return this.data.bakeArea}set cascadeDistribution(e){this._setValue("cascadeDistribution",e,(function(e,t){this.light.cascadeDistribution=pt.clamp(e,0,1)}))}get cascadeDistribution(){return this.data.cascadeDistribution}set normalOffsetBias(e){this._setValue("normalOffsetBias",e,(function(e,t){this.light.normalOffsetBias=pt.clamp(e,0,1)}))}get normalOffsetBias(){return this.data.normalOffsetBias}set range(e){this._setValue("range",e,(function(e,t){this.light.attenuationEnd=e}))}get range(){return this.data.range}set innerConeAngle(e){this._setValue("innerConeAngle",e,(function(e,t){this.light.innerConeAngle=e}))}get innerConeAngle(){return this.data.innerConeAngle}set outerConeAngle(e){this._setValue("outerConeAngle",e,(function(e,t){this.light.outerConeAngle=e}))}get outerConeAngle(){return this.data.outerConeAngle}set falloffMode(e){this._setValue("falloffMode",e,(function(e,t){this.light.falloffMode=e}))}get falloffMode(){return this.data.falloffMode}set shadowType(e){this._setValue("shadowType",e,(function(e,t){this.light.shadowType=e}))}get shadowType(){return this.data.shadowType}set vsmBlurSize(e){this._setValue("vsmBlurSize",e,(function(e,t){this.light.vsmBlurSize=e}))}get vsmBlurSize(){return this.data.vsmBlurSize}set vsmBlurMode(e){this._setValue("vsmBlurMode",e,(function(e,t){this.light.vsmBlurMode=e}))}get vsmBlurMode(){return this.data.vsmBlurMode}set vsmBias(e){this._setValue("vsmBias",e,(function(e,t){this.light.vsmBias=pt.clamp(e,0,1)}))}get vsmBias(){return this.data.vsmBias}set cookieAsset(e){this._setValue("cookieAsset",e,(function(e,t){if(!this._cookieAssetId||!(e instanceof dp&&e.id===this._cookieAssetId||e===this._cookieAssetId))if(this.onCookieAssetRemove(),this._cookieAssetId=null,e instanceof dp)this.data.cookieAsset=e.id,this._cookieAssetId=e.id,this.onCookieAssetAdd(e);else if("number"==typeof e){this._cookieAssetId=e;var s=this.system.app.assets.get(e);s?this.onCookieAssetAdd(s):(this._cookieAssetAdd=!0,this.system.app.assets.on("add:"+this._cookieAssetId,this.onCookieAssetAdd,this))}}))}get cookieAsset(){return this.data.cookieAsset}set cookie(e){this._setValue("cookie",e,(function(e,t){this.light.cookie=e}))}get cookie(){return this.data.cookie}set cookieIntensity(e){this._setValue("cookieIntensity",e,(function(e,t){this.light.cookieIntensity=pt.clamp(e,0,1)}))}get cookieIntensity(){return this.data.cookieIntensity}set cookieFalloff(e){this._setValue("cookieFalloff",e,(function(e,t){this.light.cookieFalloff=e}))}get cookieFalloff(){return this.data.cookieFalloff}set cookieChannel(e){this._setValue("cookieChannel",e,(function(e,t){this.light.cookieChannel=e}))}get cookieChannel(){return this.data.cookieChannel}set cookieAngle(e){this._setValue("cookieAngle",e,(function(e,t){if(0!==e||null!==this.cookieScale){this._cookieMatrix||(this._cookieMatrix=new bt);var s=1,i=1;this.cookieScale&&(s=this.cookieScale.x,i=this.cookieScale.y);var n=Math.cos(e*pt.DEG_TO_RAD),a=Math.sin(e*pt.DEG_TO_RAD);this._cookieMatrix.set(n/s,-a/s,a/i,n/i),this.light.cookieTransform=this._cookieMatrix}else this.light.cookieTransform=null}))}get cookieAngle(){return this.data.cookieAngle}set cookieScale(e){this._setValue("cookieScale",e,(function(e,t){if(null!==e||0!==this.cookieAngle){this._cookieMatrix||(this._cookieMatrix=new bt);var s=e.x,i=e.y,n=Math.cos(this.cookieAngle*pt.DEG_TO_RAD),a=Math.sin(this.cookieAngle*pt.DEG_TO_RAD);this._cookieMatrix.set(n/s,-a/s,a/i,n/i),this.light.cookieTransform=this._cookieMatrix}else this.light.cookieTransform=null}),!0)}get cookieScale(){return this.data.cookieScale}set cookieOffset(e){this._setValue("cookieOffset",e,(function(e,t){this.light.cookieOffset=e}),!0)}get cookieOffset(){return this.data.cookieOffset}set shadowUpdateMode(e){this._setValue("shadowUpdateMode",e,(function(e,t){this.light.shadowUpdateMode=e}),!0)}get shadowUpdateMode(){return this.data.shadowUpdateMode}set mask(e){this._setValue("mask",e,(function(e,t){this.light.mask=e}))}get mask(){return this.data.mask}set affectDynamic(e){this._setValue("affectDynamic",e,(function(e,t){e?this.light.mask|=1:this.light.mask&=-2,this.light.layersDirty()}))}get affectDynamic(){return this.data.affectDynamic}set affectLightmapped(e){this._setValue("affectLightmapped",e,(function(e,t){e?(this.light.mask|=2,this.bake&&(this.light.mask&=-5)):(this.light.mask&=-3,this.bake&&(this.light.mask|=4))}))}get affectLightmapped(){return this.data.affectLightmapped}set bake(e){this._setValue("bake",e,(function(e,t){e?(this.light.mask|=4,this.affectLightmapped&&(this.light.mask&=-3)):(this.light.mask&=-5,this.affectLightmapped&&(this.light.mask|=2)),this.light.layersDirty()}))}get bake(){return this.data.bake}set bakeDir(e){this._setValue("bakeDir",e,(function(e,t){this.light.bakeDir=e}))}get bakeDir(){return this.data.bakeDir}set isStatic(e){this._setValue("isStatic",e,(function(e,t){this.light.isStatic=e}))}get isStatic(){return this.data.isStatic}set layers(e){this._setValue("layers",e,(function(e,t){for(var s=0;s<t.length;s++){var i=this.system.app.scene.layers.getLayerById(t[s]);i&&(i.removeLight(this),this.light.removeLayer(i))}for(var n=0;n<e.length;n++){var a=this.system.app.scene.layers.getLayerById(e[n]);a&&(this.enabled&&this.entity.enabled&&(a.addLight(this),this.light.addLayer(a)))}}))}get layers(){return this.data.layers}set shadowUpdateOverrides(e){this.light.shadowUpdateOverrides=e}get shadowUpdateOverrides(){return this.light.shadowUpdateOverrides}set shadowSamples(e){this.light.shadowSamples=e}get shadowSamples(){return this.light.shadowSamples}set shadowBlockerSamples(e){this.light.shadowBlockerSamples=e}get shadowBlockerSamples(){return this.light.shadowBlockerSamples}set penumbraSize(e){this.light.penumbraSize=e}get penumbraSize(){return this.light.penumbraSize}set penumbraFalloff(e){this.light.penumbraFalloff=e}get penumbraFalloff(){return this.light.penumbraFalloff}_setValue(e,t,s,i){var n=this.data,a=n[e];(i||a!==t)&&(n[e]=t,s&&s.call(this,t,a))}addLightToLayers(){for(var e=0;e<this.layers.length;e++){var t=this.system.app.scene.layers.getLayerById(this.layers[e]);t&&(t.addLight(this),this.light.addLayer(t))}}removeLightFromLayers(){for(var e=0;e<this.layers.length;e++){var t=this.system.app.scene.layers.getLayerById(this.layers[e]);t&&(t.removeLight(this),this.light.removeLayer(t))}}onLayersChanged(e,t){this.enabled&&this.entity.enabled&&this.addLightToLayers(),e.off("add",this.onLayerAdded,this),e.off("remove",this.onLayerRemoved,this),t.on("add",this.onLayerAdded,this),t.on("remove",this.onLayerRemoved,this)}onLayerAdded(e){this.layers.indexOf(e.id)>=0&&this.enabled&&this.entity.enabled&&(e.addLight(this),this.light.addLayer(e))}onLayerRemoved(e){this.layers.indexOf(e.id)>=0&&(e.removeLight(this),this.light.removeLayer(e))}refreshProperties(){for(var e=0;e<Ym.length;e++){var t=Ym[e];this[t]=this[t]}this.enabled&&this.entity.enabled&&this.onEnable()}onCookieAssetSet(){var e=!1;"cubemap"!==this._cookieAsset.type||this._cookieAsset.loadFaces||(this._cookieAsset.loadFaces=!0,e=!0),this._cookieAsset.resource&&!e||this.system.app.assets.load(this._cookieAsset),this._cookieAsset.resource&&this.onCookieAssetLoad()}onCookieAssetAdd(e){this._cookieAssetId===e.id&&(this._cookieAsset=e,this.light.enabled&&this.onCookieAssetSet(),this._cookieAsset.on("load",this.onCookieAssetLoad,this),this._cookieAsset.on("remove",this.onCookieAssetRemove,this))}onCookieAssetLoad(){this._cookieAsset&&this._cookieAsset.resource&&(this.cookie=this._cookieAsset.resource)}onCookieAssetRemove(){this._cookieAssetId&&(this._cookieAssetAdd&&(this.system.app.assets.off("add:"+this._cookieAssetId,this.onCookieAssetAdd,this),this._cookieAssetAdd=!1),this._cookieAsset&&(this._cookieAsset.off("load",this.onCookieAssetLoad,this),this._cookieAsset.off("remove",this.onCookieAssetRemove,this),this._cookieAsset=null),this.cookie=null)}onEnable(){var e=this.system.app.scene,t=e.layers;this.light.enabled=!0,this._evtLayersChanged=e.on("set:layers",this.onLayersChanged,this),t&&(this._evtLayerAdded=t.on("add",this.onLayerAdded,this),this._evtLayerRemoved=t.on("remove",this.onLayerRemoved,this)),this.enabled&&this.entity.enabled&&this.addLightToLayers(),this._cookieAsset&&!this.cookie&&this.onCookieAssetSet()}onDisable(){var e,t,s,i=this.system.app.scene.layers;(this.light.enabled=!1,null==(e=this._evtLayersChanged)||e.off(),this._evtLayersChanged=null,i)&&(null==(t=this._evtLayerAdded)||t.off(),this._evtLayerAdded=null,null==(s=this._evtLayerRemoved)||s.off(),this._evtLayerRemoved=null);this.removeLightFromLayers()}onRemove(){this.onDisable(),this.light.destroy(),this.cookieAsset=null}constructor(...e){super(...e),this._evtLayersChanged=null,this._evtLayerAdded=null,this._evtLayerRemoved=null,this._cookieAsset=null,this._cookieAssetId=null,this._cookieAssetAdd=!1,this._cookieMatrix=null}}function Km(){return Km=Object.assign||function(e){for(var t=1;t<arguments.length;t++){var s=arguments[t];for(var i in s)Object.prototype.hasOwnProperty.call(s,i)&&(e[i]=s[i])}return e},Km.apply(this,arguments)}class Zm extends zp{initializeComponentData(e,t){var s=Km({},t);s.type||(s.type=e.data.type),e.data.type=s.type,s.layers&&Array.isArray(s.layers)&&(s.layers=s.layers.slice(0)),s.color&&Array.isArray(s.color)&&(s.color=new mt(s.color[0],s.color[1],s.color[2])),s.cookieOffset&&s.cookieOffset instanceof Array&&(s.cookieOffset=new wt(s.cookieOffset[0],s.cookieOffset[1])),s.cookieScale&&s.cookieScale instanceof Array&&(s.cookieScale=new wt(s.cookieScale[0],s.cookieScale[1])),s.enable&&(console.warn("WARNING: enable: Property is deprecated. Set enabled property instead."),s.enabled=s.enable),s.shape||(s.shape=0);var i=new Lc(this.app.graphicsDevice,this.app.scene.clusteredLightingEnabled);i.type=Mc[s.type],i._node=e.entity,e.data.light=i,super.initializeComponentData(e,s,Ym)}_onRemoveComponent(e,t){t.onRemove()}cloneComponent(e,t){for(var s,i=e.light,n=[],a=0;a<Ym.length;a++)"light"!==(s=Ym[a])&&(i[s]&&i[s].clone?n[s]=i[s].clone():n[s]=i[s]);return this.addComponent(t,n)}changeType(e,t,s){t!==s&&(e.light.type=Mc[s])}constructor(e){super(e),this.id="light",this.ComponentType=$m,this.DataType=Xm,this.on("beforeremove",this._onRemoveComponent,this)}}class Jm extends Op{set customAabb(e){var t,s;this._customAabb=e,null==(s=this._instance)||null==(t=s.meshInstance)||t.setCustomAabb(this._customAabb)}get customAabb(){return this._customAabb}set instance(e){var t;if(this.destroyInstance(),this._instance=e,null==(t=this._instance)?void 0:t.meshInstance){var s=this._instance.meshInstance;s.node||(s.node=this.entity),s.setCustomAabb(this._customAabb),this._materialOptions&&this._instance.createMaterial(this._materialOptions),this.enabled&&this.entity.enabled&&this.addToLayers()}}get instance(){return this._instance}set materialOptions(e){this._materialOptions=Object.assign({},e),this._instance&&this._instance.createMaterial(this._materialOptions)}get materialOptions(){return this._materialOptions}get material(){var e;return null==(e=this._instance)?void 0:e.material}set layers(e){this.removeFromLayers(),this._layers.length=0;for(var t=0;t<e.length;t++)this._layers[t]=e[t];this.enabled&&this.entity.enabled&&this.addToLayers()}get layers(){return this._layers}set asset(e){var t=e instanceof dp?e.id:e;this._assetReference.id!==t&&(this._assetReference.asset&&this._assetReference.asset.resource&&this._onGSplatAssetRemove(),this._assetReference.id=t,this._assetReference.asset&&this._onGSplatAssetAdded())}get asset(){return this._assetReference.id}assignAsset(e){var t=e instanceof dp?e.id:e;this._assetReference.id=t}destroyInstance(){var e;this._instance&&(this.removeFromLayers(),null==(e=this._instance)||e.destroy(),this._instance=null)}addToLayers(){var e,t=null==(e=this.instance)?void 0:e.meshInstance;if(t)for(var s=this.system.app.scene.layers,i=0;i<this._layers.length;i++){var n;null==(n=s.getLayerById(this._layers[i]))||n.addMeshInstances([t])}}removeFromLayers(){var e,t=null==(e=this.instance)?void 0:e.meshInstance;if(t)for(var s=this.system.app.scene.layers,i=0;i<this._layers.length;i++){var n;null==(n=s.getLayerById(this._layers[i]))||n.removeMeshInstances([t])}}onRemoveChild(){this.removeFromLayers()}onInsertChild(){this._instance&&this.enabled&&this.entity.enabled&&this.addToLayers()}onRemove(){this.destroyInstance(),this.asset=null,this._assetReference.id=null,this.entity.off("remove",this.onRemoveChild,this),this.entity.off("insert",this.onInsertChild,this)}onLayersChanged(e,t){this.addToLayers(),e.off("add",this.onLayerAdded,this),e.off("remove",this.onLayerRemoved,this),t.on("add",this.onLayerAdded,this),t.on("remove",this.onLayerRemoved,this)}onLayerAdded(e){this.layers.indexOf(e.id)<0||this._instance&&e.addMeshInstances(this._instance.meshInstance)}onLayerRemoved(e){this.layers.indexOf(e.id)<0||this._instance&&e.removeMeshInstances(this._instance.meshInstance)}onEnable(){var e=this.system.app.scene,t=e.layers;this._evtLayersChanged=e.on("set:layers",this.onLayersChanged,this),t&&(this._evtLayerAdded=t.on("add",this.onLayerAdded,this),this._evtLayerRemoved=t.on("remove",this.onLayerRemoved,this)),this._instance?this.addToLayers():this.asset&&this._onGSplatAssetAdded()}onDisable(){var e,t,s,i=this.system.app.scene.layers;(null==(e=this._evtLayersChanged)||e.off(),this._evtLayersChanged=null,i)&&(null==(t=this._evtLayerAdded)||t.off(),this._evtLayerAdded=null,null==(s=this._evtLayerRemoved)||s.off(),this._evtLayerRemoved=null);this.removeFromLayers()}hide(){this._instance&&(this._instance.meshInstance.visible=!1)}show(){this._instance&&(this._instance.meshInstance.visible=!0)}_onGSplatAssetAdded(){this._assetReference.asset&&(this._assetReference.asset.resource?this._onGSplatAssetLoad():this.enabled&&this.entity.enabled&&this.system.app.assets.load(this._assetReference.asset))}_onGSplatAssetLoad(){this.destroyInstance();var e=this._assetReference.asset;e&&(this.instance=e.resource.createInstance())}_onGSplatAssetUnload(){this.destroyInstance()}_onGSplatAssetRemove(){this._onGSplatAssetUnload()}constructor(e,t){super(e,t),this._layers=[0],this._instance=null,this._customAabb=null,this._materialOptions=null,this._evtLayersChanged=null,this._evtLayerAdded=null,this._evtLayerRemoved=null,this._assetReference=new Fm("asset",this,e.app.assets,{add:this._onGSplatAssetAdded,load:this._onGSplatAssetLoad,remove:this._onGSplatAssetRemove,unload:this._onGSplatAssetUnload},this),t.on("remove",this.onRemoveChild,this),t.on("removehierarchy",this.onRemoveChild,this),t.on("insert",this.onInsertChild,this),t.on("inserthierarchy",this.onInsertChild,this)}}class Qm{constructor(){this.enabled=!0}}var ef=["enabled"],tf=["instance","asset","layers"];class sf extends zp{initializeComponentData(e,t,s){t.layers&&t.layers.length&&(t.layers=t.layers.slice(0));for(var i=0;i<tf.length;i++)t.hasOwnProperty(tf[i])&&(e[tf[i]]=t[tf[i]]);t.aabbCenter&&t.aabbHalfExtents&&(e.customAabb=new Ft(new yt(t.aabbCenter),new yt(t.aabbHalfExtents))),super.initializeComponentData(e,t,ef)}cloneComponent(e,t){for(var s=e.gsplat,i={},n=0;n<tf.length;n++)i[tf[n]]=s[tf[n]];i.enabled=s.enabled,delete i.instance;var a=this.addComponent(t,i);return a.instance=s.instance.clone(),s.customAabb&&(a.customAabb=s.customAabb.clone()),a}onRemove(e,t){t.onRemove()}constructor(e){super(e),this.id="gsplat",this.ComponentType=Jm,this.DataType=Qm,this.schema=ef,this.on("beforeremove",this.onRemove,this)}}Op._buildAccessors(Jm.prototype,ef);class nf extends tt{set meshes(e){this.decRefMeshes(),this._meshes=e,this.incRefMeshes(),this.fire("set:meshes",e)}get meshes(){return this._meshes}destroy(){this.meshes=null}decRefMeshes(){var e;null==(e=this._meshes)||e.forEach(((e,t)=>{e&&(e.decRefCount(),e.refCount<1&&(e.destroy(),this._meshes[t]=null))}))}incRefMeshes(){var e;null==(e=this._meshes)||e.forEach((e=>{null==e||e.incRefCount()}))}constructor(...e){super(...e),this._meshes=null}}function af(e){var t=this;if(t.resource){var s=e.resource,i=s.renders&&s.renders[t.data.renderIndex];i&&(t.resource.meshes=i.resource.meshes)}}function rf(e){var t=this;t.registry.off("load:"+e.id,af,t),t.registry.on("load:"+e.id,af,t),t.registry.off("remove:"+e.id,of,t),t.registry.once("remove:"+e.id,of,t),e.resource?af.call(t,e):t.registry.load(e)}function of(e){var t=this;t.registry.off("load:"+e.id,af,t),t.resource&&t.resource.destroy()}nf.EVENT_SETMESHES="set:meshes";class lf extends _p{open(e,t){return new nf}patch(e,t){if(e.data.containerAsset){var s=t.get(e.data.containerAsset);s?rf.call(e,s):t.once("add:"+e.data.containerAsset,rf,e)}}constructor(e){super(e,"render"),this._registry=e.assets}}class hf{get paths(){return this._paths}get input(){return this._input}get output(){return this._output}get interpolation(){return this._interpolation}constructor(e,t,s,i){this._paths=e,this._input=t,this._output=s,this._interpolation=i}}class cf{get components(){return this._components}get data(){return this._data}constructor(e,t){this._components=e,this._data=t}}function df(e,t){var s,i=(e,t)=>{switch(t){case s.DT_INT8:return new Int8Array(e.buffer,e.byteOffset,e.byteLength);case s.DT_INT16:return new Int16Array(e.buffer,e.byteOffset,e.byteLength/2);case s.DT_INT32:return new Int32Array(e.buffer,e.byteOffset,e.byteLength/4);case s.DT_UINT8:return new Uint8Array(e.buffer,e.byteOffset,e.byteLength);case s.DT_UINT16:return new Uint16Array(e.buffer,e.byteOffset,e.byteLength/2);case s.DT_UINT32:return new Uint32Array(e.buffer,e.byteOffset,e.byteLength/4);case s.DT_FLOAT32:return new Float32Array(e.buffer,e.byteOffset,e.byteLength/4)}return null},n=e=>e.num_components()*(e=>{switch(e){case s.DT_INT8:return 1;case s.DT_INT16:return 2;case s.DT_INT32:return 4;case s.DT_UINT8:return 1;case s.DT_UINT16:return 2;case s.DT_UINT32:case s.DT_FLOAT32:return 4}return 1})(e.data_type()),a={0:0,1:1,5:2,2:3,7:4,8:5,4:6,3:7},r=(e,t)=>{for(var s=(e,t,s)=>{e[0]=t[0]-s[0],e[1]=t[1]-s[1],e[2]=t[2]-s[2]},i=(e,t,s)=>{e[0]=t[1]*s[2]-s[1]*t[2],e[1]=t[2]*s[0]-s[2]*t[0],e[2]=t[0]*s[1]-s[0]*t[1]},n=(e,t)=>{var s=e[t+0],i=e[t+1],n=e[t+2],a=1/Math.sqrt(s*s+i*i+n*n);e[t+0]*=a,e[t+1]*=a,e[t+2]*=a},a=(e,t,s)=>{for(var i=0;i<3;++i)e[i]=t[s+i]},r=t.length/3,o=e.length/3,l=new Float32Array(e.length),h=[0,0,0],c=[0,0,0],d=[0,0,0],u=[0,0,0],p=[0,0,0],m=[0,0,0],f=0;f<r;++f){var g=3*t[3*f+0],v=3*t[3*f+1],_=3*t[3*f+2];a(h,e,g),a(c,e,v),a(d,e,_),s(u,c,h),s(p,d,h),i(m,u,p),n(m,0);for(var y=0;y<3;++y)l[g+y]+=m[y],l[v+y]+=m[y],l[_+y]+=m[y]}for(var x=0;x<o;++x)n(l,3*x);return new Uint8Array(l.buffer)},o=e=>{var t=(e=>{var t={},o=new s.DecoderBuffer;o.Init(e,e.length);var l=new s.Decoder;if(l.GetEncodedGeometryType(o)!==s.TRIANGULAR_MESH)return t.error="Failed to decode draco mesh: not a mesh",t;var h=new s.Mesh,c=l.DecodeBufferToMesh(o,h);if(!c||!c.ok()||0===s.getPointer(h))return t.error="Failed to decode draco asset",t;var d=3*h.num_faces(),u=h.num_points()<=65535,p=d*(u?2:4),m=s._malloc(p);u?(l.GetTrianglesUInt16Array(h,p,m),t.indices=new Uint16Array(s.HEAPU16.buffer,m,d).slice().buffer):(l.GetTrianglesUInt32Array(h,p,m),t.indices=new Uint32Array(s.HEAPU32.buffer,m,d).slice().buffer),s._free(m);for(var f=[],g=0;g<h.num_attributes();++g)f.push(l.GetAttribute(h,g));f.sort(((e,t)=>{var s,i;return(null!=(s=a[e.attribute_type()])?s:a.length)-(null!=(i=a[t.attribute_type()])?i:a.length)})),t.attributes=f.map((e=>e.unique_id()));var v=0,_=f.map((e=>{var t=v;return v+=4*Math.ceil(n(e)/4),t})),y=f.some((e=>1===e.attribute_type())),x=_[1];if(!y){for(var w=1;w<_.length;++w)_[w]+=12;v+=12}t.vertices=new ArrayBuffer(h.num_points()*v);for(var b=new Uint8Array(t.vertices),C=0;C<h.num_attributes();++C){var S=f[C],A=n(S),T=h.num_points()*A,P=s._malloc(T);l.GetAttributeDataArrayForAllPoints(h,S,S.data_type(),T,P);for(var E=new Uint8Array(s.HEAPU8.buffer,P,T),k=0;k<h.num_points();++k)for(var M=0;M<A;++M)b[k*v+_[C]+M]=E[k*A+M];if(!y&&0===S.attribute_type())for(var I=r(i(E,S.data_type()),u?new Uint16Array(t.indices):new Uint32Array(t.indices)),D=0;D<h.num_points();++D)for(var R=0;R<12;++R)b[D*v+x+R]=I[12*D+R];s._free(P)}return s.destroy(h),s.destroy(l),s.destroy(o),t})(new Uint8Array(e.buffer));self.postMessage({jobId:e.jobId,error:t.error,indices:t.indices,vertices:t.vertices,attributes:t.attributes},[t.indices,t.vertices].filter((e=>null!=e)))},l=[];self.onmessage=e=>{var t=e.data;switch(t.type){case"init":self.DracoDecoderModule({instantiateWasm:(e,s)=>(WebAssembly.instantiate(t.module,e).then((e=>s(e))).catch((e=>console.error("instantiate failed + "+e))),{})}).then((e=>{s=e,l.forEach((e=>o(e)))}));break;case"decodeMesh":s?o(t):l.push(t)}}}class uf{init(e){for(e.forEach((e=>{e.addEventListener("message",(t=>{var s=t.data,i=this.jobCallbacks.get(s.jobId);if(i&&i(s.error,{indices:s.indices,vertices:s.vertices,attributes:s.attributes}),this.jobCallbacks.delete(s.jobId),this.jobQueue.length>0){var n=this.jobQueue.shift();this.run(e,n)}else{var a=this.workers[2].indexOf(e);if(-1!==a)this.workers[2].splice(a,1),this.workers[1].push(e);else{var r=this.workers[1].indexOf(e);-1!==r&&(this.workers[1].splice(r,1),this.workers[0].push(e))}}}))})),this.workers[0]=e;this.jobQueue.length&&(this.workers[0].length||this.workers[1].length);){var t=this.jobQueue.shift();if(this.workers[0].length>0){var s=this.workers[0].shift();this.workers[1].push(s),this.run(s,t)}else{var i=this.workers[1].shift();this.workers[2].push(i),this.run(i,t)}}}enqueueJob(e,t){var s={jobId:this.jobId++,buffer:e};if(this.jobCallbacks.set(s.jobId,t),this.workers[0].length>0){var i=this.workers[0].shift();this.workers[1].push(i),this.run(i,s)}else if(this.workers[1].length>0){var n=this.workers[1].shift();this.workers[2].push(n),this.run(n,s)}else this.jobQueue.push(s)}constructor(){this.workers=[[],[],[]],this.jobId=0,this.jobQueue=[],this.jobCallbacks=new Map,this.run=(e,t)=>{e.postMessage({type:"decodeMesh",jobId:t.jobId,buffer:t.buffer},[t.buffer])}}}var pf,mf=e=>new Promise(((t,s)=>{var i={cache:!0,responseType:"text",retry:!0,maxRetries:3};Qr.get(e,i,((e,i)=>{e?s(e):t(i)}))})),ff=e=>{var t=()=>fetch(e).then((e=>e.arrayBuffer())).then((e=>WebAssembly.compile(e)));return WebAssembly.compileStreaming?WebAssembly.compileStreaming(fetch(e)).catch((e=>t())):t()},gf=(e,t)=>!!(e=>{if(pf)return!0;if(!e){var t=rt.getConfig("DracoDecoderModule");e=t?{jsUrl:t.glueUrl,wasmUrl:t.wasmUrl,numWorkers:t.numWorkers}:{jsUrl:"draco.wasm.js",wasmUrl:"draco.wasm.wasm",numWorkers:1}}return!(!e.jsUrl||!e.wasmUrl||(pf=new uf,Promise.all([mf(e.jsUrl),ff(e.wasmUrl)]).then((t=>{for(var[s,i]=t,n=["/* draco */",s,"/* worker */","(\n"+df.toString()+"\n)()\n\n"].join("\n"),a=new Blob([n],{type:"application/javascript"}),r=URL.createObjectURL(a),o=Math.max(1,Math.min(16,e.numWorkers||1)),l=[],h=0;h<o;++h){var c=new Worker(r);c.postMessage({type:"init",module:i}),l.push(c)}pf.init(l)})),0))})()&&(pf.enqueueJob(e,t),!0);function vf(e,t,s,i,n,a,r){try{var o=e[a](r),l=o.value}catch(e){return void s(e)}o.done?t(l):Promise.resolve(l).then(i,n)}function _f(e){return function(){var t=this,s=arguments;return new Promise((function(i,n){var a=e.apply(t,s);function r(e){vf(a,i,n,r,o,"next",e)}function o(e){vf(a,i,n,r,o,"throw",e)}r(void 0)}))}}class yf{destroy(){this.renders&&this.renders.forEach((e=>{e.meshes=null}))}}var xf=e=>/^data:[^\n\r,\u2028\u2029]*,.*$/i.test(e),wf=e=>{switch(e){case"SCALAR":return 1;case"VEC2":return 2;case"VEC3":default:return 3;case"VEC4":case"MAT2":return 4;case"MAT3":return 9;case"MAT4":return 16}},bf=e=>{switch(e){case 5120:default:return 0;case 5121:return 1;case 5122:return 2;case 5123:return 3;case 5124:return 4;case 5125:return 5;case 5126:return 6}},Cf=e=>{switch(e){case 5120:case 5121:return 1;case 5122:case 5123:return 2;case 5124:case 5125:case 5126:return 4;default:return 0}},Sf={POSITION:ms,NORMAL:fs,TANGENT:gs,COLOR_0:ys,JOINTS_0:_s,WEIGHTS_0:vs,TEXCOORD_0:ws,TEXCOORD_1:bs,TEXCOORD_2:Cs,TEXCOORD_3:Ss,TEXCOORD_4:As,TEXCOORD_5:Ts,TEXCOORD_6:Ps,TEXCOORD_7:Es},Af={[ms]:0,[fs]:1,[gs]:2,[ys]:3,[_s]:4,[vs]:5,[ws]:6,[bs]:7,[Cs]:8,[Ss]:9,[As]:10,[Ts]:11,[Ps]:12,[Es]:13},Tf=(e,t,s)=>{for(var i=(e=>{switch(e){case 0:return e=>Math.max(e/127,-1);case 1:return e=>e/255;case 2:return e=>Math.max(e/32767,-1);case 3:return e=>e/65535;default:return e=>e}})(s),n=t.length,a=0;a<n;++a)e[a]=i(t[a]);return e},Pf=(e,t,s)=>{void 0===s&&(s=!1);var i,n=wf(e.type),a=(e=>{switch(e){case 5120:return Int8Array;case 5121:return Uint8Array;case 5122:return Int16Array;case 5123:return Uint16Array;case 5124:return Int32Array;case 5125:return Uint32Array;case 5126:return Float32Array;default:return null}})(e.componentType);if(!a)return null;if(e.sparse){var r=e.sparse,o={count:r.count,type:"SCALAR"},l=Pf(Object.assign(o,r.indices),t,!0),h={count:r.count,type:e.type,componentType:e.componentType},c=Pf(Object.assign(h,r.values),t,!0);if(e.hasOwnProperty("bufferView")){var d={bufferView:e.bufferView,byteOffset:e.byteOffset,componentType:e.componentType,count:e.count,type:e.type};i=Pf(d,t,!0).slice()}else i=new a(e.count*n);for(var u=0;u<r.count;++u)for(var p=l[u],m=0;m<n;++m)i[p*n+m]=c[u*n+m]}else if(e.hasOwnProperty("bufferView")){var f=t[e.bufferView];if(s&&f.hasOwnProperty("byteStride")){for(var g=n*a.BYTES_PER_ELEMENT,v=new ArrayBuffer(e.count*g),_=new Uint8Array(v),y=0,x=0;x<e.count;++x)for(var w=(e.byteOffset||0)+x*f.byteStride,b=0;b<g;++b)_[y++]=f[w++];i=new a(v)}else i=new a(f.buffer,f.byteOffset+(e.byteOffset||0),e.count*n)}else i=new a(e.count*n);return i},Ef=(e,t)=>{var s=Pf(e,t,!0);if(s instanceof Float32Array||!e.normalized)return s;var i=new Float32Array(s.length);return Tf(i,s,bf(e.componentType)),i},kf=e=>{var t=e.min,s=e.max;if(!t||!s)return null;if(e.normalized){var i=bf(e.componentType);t=Tf([],t,i),s=Tf([],s,i)}return new Ft(new yt(.5*(s[0]+t[0]),.5*(s[1]+t[1]),.5*(s[2]+t[2])),new yt(.5*(s[0]-t[0]),.5*(s[1]-t[1]),.5*(s[2]-t[2])))},Mf=e=>{if(!e.hasOwnProperty("mode"))return 4;switch(e.mode){case 0:return 0;case 1:return 1;case 2:return 2;case 3:return 3;case 4:default:return 4;case 5:return 5;case 6:return 6}},If=(e,t)=>{var s=e[ms];if(s&&3===s.components){var i;if(s.size!==s.stride){var n=s.stride/mi[s.type],a=new pi[s.type](s.buffer,s.offset,s.count*n);i=new pi[s.type](3*s.count);for(var r=0;r<s.count;++r)i[3*r+0]=a[r*n+0],i[3*r+1]=a[r*n+1],i[3*r+2]=a[r*n+2]}else i=new pi[s.type](s.buffer,s.offset,3*s.count);var o=s.count;t||(t=(e=>{for(var t=new Uint16Array(e),s=0;s<e;s++)t[s]=s;return t})(o));var l=Yc(i,t),h=new Float32Array(l.length);h.set(l),e[fs]={buffer:h.buffer,size:12,offset:0,stride:12,count:o,components:3,type:6}}},Df=e=>{var t=new dp(e.name+"_clone",e.type,e.file,e.data,e.options);return t.loaded=!0,t.resource=(e=>{var t=new ki(e.device,e);return t._levels=(e=>{for(var t=[],s=0;s<e._levels.length;++s){var i=[];if(e.cubemap)for(var n=0;n<6;++n)i.push(e._levels[s][n]);else i=e._levels[s];t.push(i)}return t})(e),t})(e.resource),e.registry.add(t),t},Rf=(e,t,s,i,n,a)=>{var r={},o=[];for(var l in t)t.hasOwnProperty(l)&&Sf.hasOwnProperty(l)&&(r[l]=t[l],o.push(l+":"+t[l]));o.sort();var h=o.join(),c=a[h];if(!c){var d={};for(var u in r){var p=i[t[u]],m=Pf(p,n),f=n[p.bufferView],g=Sf[u],v=wf(p.type)*Cf(p.componentType),_=f&&f.hasOwnProperty("byteStride")?f.byteStride:v;d[g]={buffer:m.buffer,size:v,offset:m.byteOffset,stride:_,count:p.count,components:wf(p.type),type:bf(p.componentType),normalize:p.normalized}}d.hasOwnProperty(fs)||If(d,s),c=((e,t)=>{var s=t[ms];if(!s)return null;var i,n,a,r,o,l,h=s.count,c=[];for(var d in t)if(t.hasOwnProperty(d)){var u={semantic:d,components:t[d].components,type:t[d].type,normalize:!!t[d].normalize};tn.isElementValid(e,u)||u.components++,c.push(u)}c.sort(((e,t)=>Af[e.semantic]-Af[t.semantic]));var p=new tn(e,c),m=!0;for(i=0;i<p.elements.length;++i)if(l=(r=t[(o=p.elements[i]).name]).offset-s.offset,r.buffer!==s.buffer||r.stride!==o.stride||r.size!==o.size||l!==o.offset){m=!1;break}var f,g,v,_=new $i(e,p,h),y=_.lock(),x=new Uint32Array(y);if(m)f=new Uint32Array(s.buffer,s.offset,h*_.format.size/4),x.set(f);else for(i=0;i<_.format.elements.length;++i){g=(o=_.format.elements[i]).stride/4,v=(r=t[o.name]).stride/4,f=new Uint32Array(r.buffer,r.offset,(r.count-1)*v+(r.size+3)/4);var w=0,b=o.offset/4,C=Math.floor((r.size+3)/4);for(n=0;n<h;++n){for(a=0;a<C;++a)x[b+a]=f[w+a];w+=v,b+=g}}return _.unlock(),_})(e,d),a[h]=c}return c},Lf=(e,t,s,i,n,a,r,o,l)=>{var h=[];return t.primitives.forEach((c=>{var d;if(null==(d=c.extensions)?void 0:d.KHR_draco_mesh_compression)h.push(((e,t,s,i,n,a,r)=>{var o,l=new Wo(e);l.aabb=kf(s[t.attributes.POSITION]);var h=[];for(var[c,d]of Object.entries(t.attributes)){var u,p=s[d],m=Sf[c],f=bf(p.componentType);h.push({semantic:m,components:wf(p.type),type:f,normalize:null!=(u=p.normalized)?u:m===ys&&(1===f||3===f)})}if(r.push(new Promise(((s,n)=>{var a=t.extensions.KHR_draco_mesh_compression;gf(i[a.bufferView].slice().buffer,((i,r)=>{if(i)console.log(i),n(i);else{var o,c={};for(var[d,u]of Object.entries(a.attributes))c[Sf[d]]=r.attributes.indexOf(u);h.sort(((e,t)=>c[e.semantic]-c[t.semantic])),(null==(o=t.attributes)?void 0:o.NORMAL)||h.splice(1,0,{semantic:"NORMAL",components:3,type:6});var p=new tn(e,h),m=r.vertices.byteLength/p.size,f=m<=65535?1:2,g=r.indices.byteLength/(m<=65535?2:4),v=new $i(e,p,m,{data:r.vertices}),_=new Lr(e,f,g,0,r.indices);l.vertexBuffer=v,l.indexBuffer[0]=_,l.primitive[0].type=Mf(t),l.primitive[0].base=0,l.primitive[0].count=_?g:m,l.primitive[0].indexed=!!_,s()}}))}))),null==t||null==(o=t.extensions)?void 0:o.KHR_materials_variants){var g=t.extensions.KHR_materials_variants,v={};g.mappings.forEach((e=>{e.variants.forEach((t=>{v[t]=e.material}))})),n[l.id]=v}return a[l.id]=t.material,l})(e,c,s,i,a,r,l));else{var u=c.hasOwnProperty("indices")?Pf(s[c.indices],i,!0):null,p=Rf(e,c.attributes,u,s,i,n),m=Mf(c),f=new Wo(e);if(f.vertexBuffer=p,f.primitive[0].type=m,f.primitive[0].base=0,f.primitive[0].indexed=null!==u,null!==u){var g;0===(g=u instanceof Uint8Array?0:u instanceof Uint16Array?1:2)&&e.isWebGPU&&(g=1,u=new Uint16Array(u));var v=new Lr(e,g,u.length,0,u);f.indexBuffer[0]=v,f.primitive[0].count=u.length}else f.primitive[0].count=p.numVertices;if(c.hasOwnProperty("extensions")&&c.extensions.hasOwnProperty("KHR_materials_variants")){var _=c.extensions.KHR_materials_variants,y={};_.mappings.forEach((e=>{e.variants.forEach((t=>{y[t]=e.material}))})),a[f.id]=y}r[f.id]=c.material;var x=s[c.attributes.POSITION];if(f.aabb=kf(x),c.hasOwnProperty("targets")){var w=[];c.targets.forEach(((e,n)=>{var a={};e.hasOwnProperty("POSITION")&&(x=s[e.POSITION],a.deltaPositions=Ef(x,i),a.aabb=kf(x)),e.hasOwnProperty("NORMAL")&&(x=s[e.NORMAL],a.deltaNormals=Ef(x,i)),t.hasOwnProperty("extras")&&t.extras.hasOwnProperty("targetNames")?a.name=t.extras.targetNames[n]:a.name=n.toString(10),t.hasOwnProperty("weights")&&(a.defaultWeight=t.weights[n]),a.preserveData=o.morphPreserveData,w.push(new Nc(a))})),f.morph=new Vc(w,e,{preferHighPrecision:o.morphPreferHighPrecision})}h.push(f)}})),h},Ff=(e,t,s)=>{var i,n,a=e.texCoord;if(a)for(n=0;n<s.length;++n)t[s[n]+"MapUv"]=a;var r=null==(i=e.extensions)?void 0:i.KHR_texture_transform;if(r){var o=r.offset||[0,0],l=r.scale||[1,1],h=r.rotation?-r.rotation*pt.RAD_TO_DEG:0,c=new wt(l[0],l[1]),d=new wt(o[0],1-l[1]-o[1]);for(n=0;n<s.length;++n)t[s[n]+"MapTiling"]=c,t[s[n]+"MapOffset"]=d,t[s[n]+"MapRotation"]=h}},Bf=(e,t,s)=>{var i,n;if(e.hasOwnProperty("diffuseFactor")?(i=e.diffuseFactor,t.diffuse.set(Math.pow(i[0],1/2.2),Math.pow(i[1],1/2.2),Math.pow(i[2],1/2.2)),t.opacity=i[3]):(t.diffuse.set(1,1,1),t.opacity=1),e.hasOwnProperty("diffuseTexture")){var a=e.diffuseTexture;n=s[a.index],t.diffuseMap=n,t.diffuseMapChannel="rgb",t.opacityMap=n,t.opacityMapChannel="a",Ff(a,t,["diffuse","opacity"])}if(t.useMetalness=!1,e.hasOwnProperty("specularFactor")?(i=e.specularFactor,t.specular.set(Math.pow(i[0],1/2.2),Math.pow(i[1],1/2.2),Math.pow(i[2],1/2.2))):t.specular.set(1,1,1),e.hasOwnProperty("glossinessFactor")?t.gloss=e.glossinessFactor:t.gloss=1,e.hasOwnProperty("specularGlossinessTexture")){var r=e.specularGlossinessTexture;t.specularEncoding="srgb",t.specularMap=t.glossMap=s[r.index],t.specularMapChannel="rgb",t.glossMapChannel="a",Ff(r,t,["gloss","metalness"])}},Of=(e,t,s)=>{if(e.hasOwnProperty("clearcoatFactor")?t.clearCoat=.25*e.clearcoatFactor:t.clearCoat=0,e.hasOwnProperty("clearcoatTexture")){var i=e.clearcoatTexture;t.clearCoatMap=s[i.index],t.clearCoatMapChannel="r",Ff(i,t,["clearCoat"])}if(e.hasOwnProperty("clearcoatRoughnessFactor")?t.clearCoatGloss=e.clearcoatRoughnessFactor:t.clearCoatGloss=0,e.hasOwnProperty("clearcoatRoughnessTexture")){var n=e.clearcoatRoughnessTexture;t.clearCoatGlossMap=s[n.index],t.clearCoatGlossMapChannel="g",Ff(n,t,["clearCoatGloss"])}if(e.hasOwnProperty("clearcoatNormalTexture")){var a=e.clearcoatNormalTexture;t.clearCoatNormalMap=s[a.index],Ff(a,t,["clearCoatNormal"]),a.hasOwnProperty("scale")&&(t.clearCoatBumpiness=a.scale)}t.clearCoatGlossInvert=!0},zf=(e,t,s)=>{t.useLighting=!1,t.emissive.copy(t.diffuse),t.emissiveMap=t.diffuseMap,t.emissiveMapUv=t.diffuseMapUv,t.emissiveMapTiling.copy(t.diffuseMapTiling),t.emissiveMapOffset.copy(t.diffuseMapOffset),t.emissiveMapRotation=t.diffuseMapRotation,t.emissiveMapChannel=t.diffuseMapChannel,t.emissiveVertexColor=t.diffuseVertexColor,t.emissiveVertexColorChannel=t.diffuseVertexColorChannel,t.useLighting=!1,t.useSkybox=!1,t.diffuse.set(1,1,1),t.diffuseMap=null,t.diffuseVertexColor=!1},Vf=(e,t,s)=>{if(t.useMetalnessSpecularColor=!0,e.hasOwnProperty("specularColorTexture")&&(t.specularEncoding="srgb",t.specularMap=s[e.specularColorTexture.index],t.specularMapChannel="rgb",Ff(e.specularColorTexture,t,["specular"])),e.hasOwnProperty("specularColorFactor")){var i=e.specularColorFactor;t.specular.set(Math.pow(i[0],1/2.2),Math.pow(i[1],1/2.2),Math.pow(i[2],1/2.2))}else t.specular.set(1,1,1);e.hasOwnProperty("specularFactor")?t.specularityFactor=e.specularFactor:t.specularityFactor=1,e.hasOwnProperty("specularTexture")&&(t.specularityFactorMapChannel="a",t.specularityFactorMap=s[e.specularTexture.index],Ff(e.specularTexture,t,["specularityFactor"]))},Nf=(e,t,s)=>{e.hasOwnProperty("ior")&&(t.refractionIndex=1/e.ior)},Uf=(e,t,s)=>{e.hasOwnProperty("dispersion")&&(t.dispersion=e.dispersion)},Hf=(e,t,s)=>{t.blendType=2,t.useDynamicRefraction=!0,e.hasOwnProperty("transmissionFactor")&&(t.refraction=e.transmissionFactor),e.hasOwnProperty("transmissionTexture")&&(t.refractionMapChannel="r",t.refractionMap=s[e.transmissionTexture.index],Ff(e.transmissionTexture,t,["refraction"]))},Gf=(e,t,s)=>{if(t.useSheen=!0,e.hasOwnProperty("sheenColorFactor")){var i=e.sheenColorFactor;t.sheen.set(Math.pow(i[0],1/2.2),Math.pow(i[1],1/2.2),Math.pow(i[2],1/2.2))}else t.sheen.set(1,1,1);e.hasOwnProperty("sheenColorTexture")&&(t.sheenMap=s[e.sheenColorTexture.index],t.sheenEncoding="srgb",Ff(e.sheenColorTexture,t,["sheen"])),t.sheenGloss=e.hasOwnProperty("sheenRoughnessFactor")?e.sheenRoughnessFactor:0,e.hasOwnProperty("sheenRoughnessTexture")&&(t.sheenGlossMap=s[e.sheenRoughnessTexture.index],t.sheenGlossMapChannel="a",Ff(e.sheenRoughnessTexture,t,["sheenGloss"])),t.sheenGlossInvert=!0},Wf=(e,t,s)=>{if(t.blendType=2,t.useDynamicRefraction=!0,e.hasOwnProperty("thicknessFactor")&&(t.thickness=e.thicknessFactor),e.hasOwnProperty("thicknessTexture")&&(t.thicknessMap=s[e.thicknessTexture.index],t.thicknessMapChannel="g",Ff(e.thicknessTexture,t,["thickness"])),e.hasOwnProperty("attenuationDistance")&&(t.attenuationDistance=e.attenuationDistance),e.hasOwnProperty("attenuationColor")){var i=e.attenuationColor;t.attenuation.set(Math.pow(i[0],1/2.2),Math.pow(i[1],1/2.2),Math.pow(i[2],1/2.2))}},jf=(e,t,s)=>{e.hasOwnProperty("emissiveStrength")&&(t.emissiveIntensity=e.emissiveStrength)},qf=(e,t,s)=>{t.useIridescence=!0,e.hasOwnProperty("iridescenceFactor")&&(t.iridescence=e.iridescenceFactor),e.hasOwnProperty("iridescenceTexture")&&(t.iridescenceMapChannel="r",t.iridescenceMap=s[e.iridescenceTexture.index],Ff(e.iridescenceTexture,t,["iridescence"])),e.hasOwnProperty("iridescenceIor")&&(t.iridescenceRefractionIndex=e.iridescenceIor),e.hasOwnProperty("iridescenceThicknessMinimum")&&(t.iridescenceThicknessMin=e.iridescenceThicknessMinimum),e.hasOwnProperty("iridescenceThicknessMaximum")&&(t.iridescenceThicknessMax=e.iridescenceThicknessMaximum),e.hasOwnProperty("iridescenceThicknessTexture")&&(t.iridescenceThicknessMapChannel="g",t.iridescenceThicknessMap=s[e.iridescenceThicknessTexture.index],Ff(e.iridescenceThicknessTexture,t,["iridescenceThickness"]))},Xf=(e,t)=>{var s,i,n=new au;if(e.hasOwnProperty("name")&&(n.name=e.name),n.occludeSpecular=1,n.diffuseVertexColor=!0,n.specularTint=!0,n.specularVertexColor=!0,n.specular.set(1,1,1),n.gloss=1,n.glossInvert=!0,n.useMetalness=!0,e.hasOwnProperty("pbrMetallicRoughness")){var a=e.pbrMetallicRoughness;if(a.hasOwnProperty("baseColorFactor")&&(s=a.baseColorFactor,n.diffuse.set(Math.pow(s[0],1/2.2),Math.pow(s[1],1/2.2),Math.pow(s[2],1/2.2)),n.opacity=s[3]),a.hasOwnProperty("baseColorTexture")){var r=a.baseColorTexture;i=t[r.index],n.diffuseMap=i,n.diffuseMapChannel="rgb",n.opacityMap=i,n.opacityMapChannel="a",Ff(r,n,["diffuse","opacity"])}if(a.hasOwnProperty("metallicFactor")&&(n.metalness=a.metallicFactor),a.hasOwnProperty("roughnessFactor")&&(n.gloss=a.roughnessFactor),a.hasOwnProperty("metallicRoughnessTexture")){var o=a.metallicRoughnessTexture;n.metalnessMap=n.glossMap=t[o.index],n.metalnessMapChannel="b",n.glossMapChannel="g",Ff(o,n,["gloss","metalness"])}}if(e.hasOwnProperty("normalTexture")){var l=e.normalTexture;n.normalMap=t[l.index],Ff(l,n,["normal"]),l.hasOwnProperty("scale")&&(n.bumpiness=l.scale)}if(e.hasOwnProperty("occlusionTexture")){var h=e.occlusionTexture;n.aoMap=t[h.index],n.aoMapChannel="r",Ff(h,n,["ao"])}if(e.hasOwnProperty("emissiveFactor")&&(s=e.emissiveFactor,n.emissive.set(Math.pow(s[0],1/2.2),Math.pow(s[1],1/2.2),Math.pow(s[2],1/2.2))),e.hasOwnProperty("emissiveTexture")){var c=e.emissiveTexture;n.emissiveMap=t[c.index],Ff(c,n,["emissive"])}if(e.hasOwnProperty("alphaMode"))switch(e.alphaMode){case"MASK":n.blendType=3,e.hasOwnProperty("alphaCutoff")?n.alphaTest=e.alphaCutoff:n.alphaTest=.5;break;case"BLEND":n.blendType=2,n.depthWrite=!1;break;default:n.blendType=3}else n.blendType=3;e.hasOwnProperty("doubleSided")?(n.twoSidedLighting=e.doubleSided,n.cull=e.doubleSided?0:1):(n.twoSidedLighting=!1,n.cull=1);var d={KHR_materials_clearcoat:Of,KHR_materials_emissive_strength:jf,KHR_materials_ior:Nf,KHR_materials_dispersion:Uf,KHR_materials_iridescence:qf,KHR_materials_pbrSpecularGlossiness:Bf,KHR_materials_sheen:Gf,KHR_materials_specular:Vf,KHR_materials_transmission:Hf,KHR_materials_unlit:zf,KHR_materials_volume:Wf};if(e.hasOwnProperty("extensions"))for(var u in e.extensions){var p=d[u];void 0!==p&&p(e.extensions[u],n,t)}return n.update(),n},Yf=new Et,$f=new yt,Kf=(e,t,s)=>{var i=new Il;if(e.hasOwnProperty("name")&&e.name.length>0?i.name=e.name:i.name="node_"+t,e.hasOwnProperty("matrix")&&(Yf.data.set(e.matrix),Yf.getTranslation($f),i.setLocalPosition($f),Yf.getEulerAngles($f),i.setLocalEulerAngles($f),Yf.getScale($f),i.setLocalScale($f)),e.hasOwnProperty("rotation")){var n=e.rotation;i.setLocalRotation(n[0],n[1],n[2],n[3])}if(e.hasOwnProperty("translation")){var a=e.translation;i.setLocalPosition(a[0],a[1],a[2])}if(e.hasOwnProperty("scale")){var r=e.scale;i.setLocalScale(r[0],r[1],r[2])}return e.hasOwnProperty("extensions")&&e.extensions.EXT_mesh_gpu_instancing&&s.set(e,{ext:e.extensions.EXT_mesh_gpu_instancing}),i},Zf=(e,t)=>{var s="orthographic"===e.type?1:0,i=1===s?e.orthographic:e.perspective,n={enabled:!1,projection:s,nearClip:i.znear,aspectRatioMode:0};i.zfar&&(n.farClip=i.zfar),1===s?(n.orthoHeight=.5*i.ymag,i.ymag&&(n.aspectRatioMode=1,n.aspectRatio=i.xmag/i.ymag)):(n.fov=i.yfov*pt.RAD_TO_DEG,i.aspectRatio&&(n.aspectRatioMode=1,n.aspectRatio=i.aspectRatio));var a=new Ep(e.name);return a.addComponent("camera",n),a},Jf=(e,t)=>{var s={enabled:!1,type:"point"===e.type?"omni":e.type,color:e.hasOwnProperty("color")?new mt(e.color):mt.WHITE,range:e.hasOwnProperty("range")?e.range:9999,falloffMode:1,intensity:e.hasOwnProperty("intensity")?pt.clamp(e.intensity,0,2):1};e.hasOwnProperty("spot")&&(s.innerConeAngle=e.spot.hasOwnProperty("innerConeAngle")?e.spot.innerConeAngle*pt.RAD_TO_DEG:0,s.outerConeAngle=e.spot.hasOwnProperty("outerConeAngle")?e.spot.outerConeAngle*pt.RAD_TO_DEG:Math.PI/4),e.hasOwnProperty("intensity")&&(s.luminance=e.intensity*Lc.getLightUnitConversion(Mc[s.type],s.outerConeAngle,s.innerConeAngle));var i=new Ep(t.name);return i.rotateLocal(90,0,0),i.addComponent("light",s),i},Qf=(e,t,s,i)=>{if(!t.hasOwnProperty("skins")||0===t.skins.length)return[];var n=new Map;return t.skins.map((a=>((e,t,s,i,n,a)=>{var r,o,l,h=t.joints,c=h.length,d=[];if(t.hasOwnProperty("inverseBindMatrices")){var u=t.inverseBindMatrices,p=Pf(s[u],i,!0),m=[];for(r=0;r<c;r++){for(o=0;o<16;o++)m[o]=p[16*r+o];(l=new Et).set(m),d.push(l)}}else for(r=0;r<c;r++)l=new Et,d.push(l);var f=[];for(r=0;r<c;r++)f[r]=n[h[r]].name;var g=f.join("#"),v=a.get(g);return v||(v=new Rd(e,d,f),a.set(g,v)),v})(e,a,t.accessors,i,s,n)))},eg=(e,t,s,i)=>{var n,a;if(!e.hasOwnProperty("animations")||0===e.animations.length)return[];var r=null==i||null==(n=i.animation)?void 0:n.preprocess,o=null==i||null==(a=i.animation)?void 0:a.postprocess;return e.animations.map(((i,n)=>{r&&r(i);var a=((e,t,s,i,n,a,r)=>{var o,l=e=>new cf(wf(e.type),Ef(e,i)),h={STEP:0,LINEAR:1,CUBICSPLINE:2},c={},d={},u={},p=1;for(o=0;o<e.samplers.length;++o){var m=e.samplers[o];c.hasOwnProperty(m.input)||(c[m.input]=l(s[m.input])),d.hasOwnProperty(m.output)||(d[m.output]=l(s[m.output]));var f=m.hasOwnProperty("interpolation")&&h.hasOwnProperty(m.interpolation)?h[m.interpolation]:1,g={paths:[],input:m.input,output:m.output,interpolation:f};u[o]=g}var v=[],_={translation:"localPosition",rotation:"localRotation",scale:"localScale"},y=e=>{for(var t=[];e;)t.unshift(e.name),e=e.parent;return t},x=(e,t,s)=>{var i=d[e.output];if(i){var n;if(a&&a[t.mesh]){var r=a[t.mesh];r.hasOwnProperty("extras")&&r.extras.hasOwnProperty("targetNames")&&(n=r.extras.targetNames)}for(var l=i.data,h=l.length/c[e.input].data.length,m=l.length/h,f=4*m,g=new ArrayBuffer(f*h),v=0;v<h;v++){for(var _=new Float32Array(g,f*v,m),y=0;y<m;y++)_[y]=l[y*h+v];var x=new cf(1,_),w=(null==n?void 0:n[v])?"name."+n[v]:v;d[-p]=x;var b={paths:[{entityPath:s,component:"graph",propertyPath:["weight."+w]}],input:e.input,output:-p,interpolation:e.interpolation};p++,u["morphCurve-"+o+"-"+v]=b}}};for(o=0;o<e.channels.length;++o){var w=e.channels[o],b=w.target,C=u[w.sampler],S=n[b.node],A=r[b.node],T=y(S);b.path.startsWith("weights")?(x(C,A,T),u[w.sampler].morphCurve=!0):C.paths.push({entityPath:T,component:"graph",propertyPath:[_[b.path]]})}var P=[],E=[],k=[];for(var M in c)P.push(c[M]),c[M]=P.length-1;for(var I in d)E.push(d[I]),d[I]=E.length-1;for(var D in u){var R=u[D];R.morphCurve||(k.push(new hf(R.paths,c[R.input],d[R.output],R.interpolation)),R.paths.length>0&&"localRotation"===R.paths[0].propertyPath[0]&&2!==R.interpolation&&v.push(k[k.length-1].output))}v.sort();var L,F=null;for(o=0;o<v.length;++o){var B=v[o];if(0===o||B!==F){if(4===(L=E[B]).components)for(var O=L.data,z=O.length-4,V=0;V<z;V+=4)O[V+0]*O[V+4]+O[V+1]*O[V+5]+O[V+2]*O[V+6]+O[V+3]*O[V+7]<0&&(O[V+4]*=-1,O[V+5]*=-1,O[V+6]*=-1,O[V+7]*=-1);F=B}}var N=0;for(o=0;o<P.length;o++)L=P[o]._data,N=Math.max(N,0===L.length?0:L[L.length-1]);return new nm(e.hasOwnProperty("name")?e.name:"animation_"+t,N,P,E,k)})(i,n,e.accessors,s,t,e.meshes,e.nodes);return o&&o(i,a),a}))},tg=_f((function*(e,t,s,i,n){var a,r,o=null==n||null==(a=n.global)?void 0:a.preprocess,l=null==n||null==(r=n.global)?void 0:r.postprocess;o&&o(t);var h=new Map,c=((e,t,s)=>{var i,n,a;if(!e.hasOwnProperty("nodes")||0===e.nodes.length)return[];for(var r,o=null==t||null==(i=t.node)?void 0:i.preprocess,l=null!=(r=null==t||null==(n=t.node)?void 0:n.process)?r:Kf,h=null==t||null==(a=t.node)?void 0:a.postprocess,c=e.nodes.map(((e,t)=>{o&&o(e);var i=l(e,t,s);return h&&h(e,i),i})),d=0;d<e.nodes.length;++d){var u=e.nodes[d];if(u.hasOwnProperty("children"))for(var p=c[d],m={},f=0;f<u.children.length;++f){var g=c[u.children[f]];g.parent||(m.hasOwnProperty(g.name)?g.name+=m[g.name]++:m[g.name]=1,p.addChild(g))}}return c})(t,n,h),d=((e,t)=>{var s,i=[],n=e.scenes.length;if(1===n&&1===(null==(s=e.scenes[0].nodes)?void 0:s.length)){var a=e.scenes[0].nodes[0];i.push(t[a])}else for(var r=0;r<n;r++){var o=e.scenes[r];if(o.nodes){for(var l=new Il(o.name),h=0;h<o.nodes.length;h++){var c=t[o.nodes[h]];l.addChild(c)}i.push(l)}}return i})(t,c),u=((e,t,s)=>{var i=null;if(e.hasOwnProperty("nodes")&&e.hasOwnProperty("extensions")&&e.extensions.hasOwnProperty("KHR_lights_punctual")&&e.extensions.KHR_lights_punctual.hasOwnProperty("lights")){var n=e.extensions.KHR_lights_punctual.lights;if(n.length){var a,r,o,l,h=null==s||null==(a=s.light)?void 0:a.preprocess,c=null!=(l=null==s||null==(r=s.light)?void 0:r.process)?l:Jf,d=null==s||null==(o=s.light)?void 0:o.postprocess;e.nodes.forEach(((e,s)=>{if(e.hasOwnProperty("extensions")&&e.extensions.hasOwnProperty("KHR_lights_punctual")&&e.extensions.KHR_lights_punctual.hasOwnProperty("light")){var a=e.extensions.KHR_lights_punctual.light,r=n[a];if(r){h&&h(r);var o=c(r,t[s]);d&&d(r,o),o&&(i||(i=new Map),i.set(e,o))}}}))}}return i})(t,c,n),p=((e,t,s)=>{var i=null;if(e.hasOwnProperty("nodes")&&e.hasOwnProperty("cameras")&&e.cameras.length>0){var n,a,r,o,l=null==s||null==(n=s.camera)?void 0:n.preprocess,h=null!=(o=null==s||null==(a=s.camera)?void 0:a.process)?o:Zf,c=null==s||null==(r=s.camera)?void 0:r.postprocess;e.nodes.forEach(((s,n)=>{if(s.hasOwnProperty("camera")){var a=e.cameras[s.camera];if(a){l&&l(a);var r=h(a,t[n]);c&&c(a,r),r&&(i||(i=new Map),i.set(s,r))}}}))}return i})(t,c,n),m=(e=>{if(!e.hasOwnProperty("extensions")||!e.extensions.hasOwnProperty("KHR_materials_variants"))return null;for(var t=e.extensions.KHR_materials_variants.variants,s={},i=0;i<t.length;i++)s[t[i].name]=i;return s})(t),f=yield Promise.all(s),{meshes:g,meshVariants:v,meshDefaultMaterials:_,promises:y}=((e,t,s,i)=>{var n,a,r,o={},l={},h={},c=[];return{meshes:!i.skipMeshes&&(null==t||null==(n=t.meshes)?void 0:n.length)&&(null==t||null==(a=t.accessors)?void 0:a.length)&&(null==t||null==(r=t.bufferViews)?void 0:r.length)?t.meshes.map((n=>Lf(e,n,t.accessors,s,o,l,h,i,c))):[],meshVariants:l,meshDefaultMaterials:h,promises:c}})(e,t,f,n),x=eg(t,c,f,n);((e,t,s,i)=>{var n=t.accessors;s.forEach(((e,t)=>{var s,a,r,o=e.ext.attributes;if(o.hasOwnProperty("TRANSLATION")){var l=n[o.TRANSLATION];s=Ef(l,i)}if(o.hasOwnProperty("ROTATION")){var h=n[o.ROTATION];a=Ef(h,i)}if(o.hasOwnProperty("SCALE")){var c=n[o.SCALE];r=Ef(c,i)}var d=(s?s.length/3:0)||(a?a.length/4:0)||(r?r.length/3:0);if(d){for(var u=new Float32Array(16*d),p=new yt,m=new kt,f=new yt(1,1,1),g=new Et,v=0,_=0;_<d;_++){var y=3*_;if(s&&p.set(s[y],s[y+1],s[y+2]),a){var x=4*_;m.set(a[x],a[x+1],a[x+2],a[x+3])}r&&f.set(r[y],r[y+1],r[y+2]),g.setTRS(p,m,f);for(var w=0;w<16;w++)u[v++]=g.data[w]}e.matrices=u}}))})(0,t,h,f);for(var w=yield Promise.all(i),b=((e,t,s)=>{var i,n,a;if(!e.hasOwnProperty("materials")||0===e.materials.length)return[];var r,o=null==s||null==(i=s.material)?void 0:i.preprocess,l=null!=(r=null==s||null==(n=s.material)?void 0:n.process)?r:Xf,h=null==s||null==(a=s.material)?void 0:a.postprocess;return e.materials.map((e=>{o&&o(e);var s=l(e,t);return h&&h(e,s),s}))})(t,w.map((e=>e.resource)),n),C=Qf(e,t,c,f),S=[],A=0;A<g.length;A++)S[A]=new nf,S[A].meshes=g[A];((e,t,s)=>{e.nodes.forEach((e=>{e.hasOwnProperty("mesh")&&e.hasOwnProperty("skin")&&t[e.mesh].meshes.forEach((t=>{t.skin=s[e.skin]}))}))})(t,S,C);var T=new yf;return T.gltf=t,T.nodes=c,T.scenes=d,T.animations=x,T.textures=w,T.materials=b,T.variants=m,T.meshVariants=v,T.meshDefaultMaterials=_,T.renders=S,T.skins=C,T.lights=u,T.cameras=p,T.nodeInstancingMap=h,l&&l(t,T),yield Promise.all(y),T})),sg=0,ig=e=>{var t,s,i,n,a,r;return null!=(r=null!=(a=null==(s=e.extensions)||null==(t=s.KHR_texture_basisu)?void 0:t.source)?a:null==(n=e.extensions)||null==(i=n.EXT_texture_webp)?void 0:i.source)?r:e.source},ng=(e,t,s)=>{e&&e.toLowerCase().endsWith(".glb")||(()=>{var e=new Uint8Array(t);return 103===e[0]&&108===e[1]&&84===e[2]&&70===e[3]})()?((e,t)=>{var s=e instanceof ArrayBuffer?new DataView(e):new DataView(e.buffer,e.byteOffset,e.byteLength),i=s.getUint32(0,!0),n=s.getUint32(4,!0),a=s.getUint32(8,!0);if(1179937895===i)if(2===n)if(a<=0||a>s.byteLength)t("Invalid length found in glb header. Found "+a);else{for(var r=[],o=12;o<a;){var l=s.getUint32(o,!0);o+l+8>s.byteLength&&t("Invalid chunk length found in glb. Found "+l);var h=s.getUint32(o+4,!0),c=new Uint8Array(s.buffer,s.byteOffset+o+8,l);r.push({length:l,type:h,data:c}),o+=l+8}1===r.length||2===r.length?1313821514===r[0].type?r.length>1&&5130562!==r[1].type?t("Invalid chunk type found in glb file. Expected 0x004E4942, found 0x"+r[1].type.toString(16)):t(null,{gltfChunk:r[0].data,binaryChunk:2===r.length?r[1].data:null}):t("Invalid chunk type found in glb file. Expected 0x4E4F534A, found 0x"+r[0].type.toString(16)):t("Invalid number of chunks found in glb file.")}else t("Invalid version number found in glb header. Expected 2, found "+n);else t("Invalid magic number found in glb header. Expected 0x46546C67, found 0x"+i.toString(16))})(t,s):s(null,{gltfChunk:t,binaryChunk:null})};class ag{static parse(e,t,s,i,n,a,r){ng(e,s,((e,s)=>{e?r(e):((e,t)=>{var s=JSON.parse((e=>{if("undefined"!=typeof TextDecoder)return(new TextDecoder).decode(e);for(var t="",s=0;s<e.length;s++)t+=String.fromCharCode(e[s]);return decodeURIComponent(escape(t))})(e));s.asset&&s.asset.version&&parseFloat(s.asset.version)<2?t("Invalid gltf version. Expected version 2.0 or above but found version '"+s.asset.version+"'."):t(null,s)})(s.gltfChunk,((e,o)=>{if(e)r(e);else{var l=((e,t,s,i)=>{var n,a,r;if(!e.buffers||0===e.buffers.length)return[];var o=null==i||null==(n=i.buffer)?void 0:n.preprocess,l=null==i||null==(a=i.buffer)?void 0:a.processAsync,h=null==i||null==(r=i.buffer)?void 0:r.postprocess;return e.buffers.map(((i,n)=>{var a;return o&&o(i),a=new Promise(l?(e,t)=>{l(i,((s,i)=>{s?t(s):e(i)}))}:e=>{e(null)}),a=a.then((e=>{if(e)return e;if(i.hasOwnProperty("uri")){if(xf(i.uri)){for(var n=atob(i.uri.split(",")[1]),a=new Uint8Array(n.length),r=0;r<n.length;r++)a[r]=n.charCodeAt(r);return a}return new Promise(((e,t)=>{Qr.get(rp.test(i.uri)?i.uri:Ye.join(s,i.uri),{cache:!0,responseType:"arraybuffer",retry:!1},((s,i)=>{s?t(s):e(new Uint8Array(i))}))}))}return t})),h&&(a=a.then((t=>(h(e.buffers[n],t),t)))),a}))})(o,s.binaryChunk,t,a),h=((e,t,s)=>{var i,n,a,r,o=function(s){var i=e.bufferViews[s];h&&h(i);var n=void 0;n=new Promise(c?(e,s)=>{c(i,t,((t,i)=>{t?s(t):e(i)}))}:e=>{e(null)}),n=n.then((e=>e||t[i.buffer].then((e=>new Uint8Array(e.buffer,e.byteOffset+(i.byteOffset||0),i.byteLength))))),i.hasOwnProperty("byteStride")&&(n=n.then((e=>(e.byteStride=i.byteStride,e)))),d&&(n=n.then((e=>(d(i,e),e)))),l.push(n)},l=[],h=null==s||null==(i=s.bufferView)?void 0:i.preprocess,c=null==s||null==(n=s.bufferView)?void 0:n.processAsync,d=null==s||null==(a=s.bufferView)?void 0:a.postprocess;if(!(null==(r=e.bufferViews)?void 0:r.length))return l;for(var u=0;u<e.bufferViews.length;++u)o(u);return l})(o,l,a),c=((e,t,s,i,n)=>{var a,r,o;if(!e.images||0===e.images.length)return[];var l=null==n||null==(a=n.image)?void 0:a.preprocess,h=null==n||null==(r=n.image)?void 0:r.processAsync,c=null==n||null==(o=n.image)?void 0:o.postprocess,d={"image/png":"png","image/jpeg":"jpg","image/basis":"basis","image/ktx":"ktx","image/ktx2":"ktx2","image/vnd-ms.dds":"dds"},u=(e,t,s,n,a,r)=>new Promise(((o,l)=>{var h=s=>{var h=(e.name||"gltf-texture")+"-"+sg++,c={url:t||h};if(s&&(c.contents=s.slice(0).buffer),n){var u=d[n];u&&(c.filename=c.url+"."+u)}var p=new dp(h,"texture",c,{srgb:r},a);p.on("load",(e=>o(e))),p.on("error",(e=>l(e))),i.add(p),i.load(p)};s?s.then((e=>h(e))):h(null)})),p=(e=>{var t=new Set;return e.hasOwnProperty("materials")&&e.materials.forEach((s=>{if(s.hasOwnProperty("pbrMetallicRoughness")){var i=s.pbrMetallicRoughness;if(i.hasOwnProperty("baseColorTexture")){var n=e.textures[i.baseColorTexture.index];t.add(ig(n))}}if(s.hasOwnProperty("emissiveTexture")){var a=e.textures[s.emissiveTexture.index];t.add(ig(a))}})),t})(e);return e.images.map(((e,i)=>{var n;return l&&l(e),n=new Promise(h?(t,s)=>{h(e,((e,i)=>{e?s(e):t(i)}))}:e=>{e(null)}),n=n.then((n=>{var a,r=p.has(i);return n||(e.hasOwnProperty("uri")?xf(e.uri)?u(e,e.uri,null,(a=e.uri).substring(a.indexOf(":")+1,a.indexOf(";")),null,r):u(e,rp.test(e.uri)?e.uri:Ye.join(s,e.uri),null,null,{crossOrigin:"anonymous"},r):e.hasOwnProperty("bufferView")&&e.hasOwnProperty("mimeType")?u(e,null,t[e.bufferView],e.mimeType,null,r):Promise.reject(new Error("Invalid image found in gltf (neither uri or bufferView found). index="+i)))})),c&&(n=n.then((t=>(c(e,t),t)))),n}))})(o,h,t,n,a),d=((e,t,s)=>{var i,n,a,r,o;if(!(null==e||null==(i=e.images)?void 0:i.length)||!(null==e||null==(n=e.textures)?void 0:n.length))return[];var l=null==s||null==(a=s.texture)?void 0:a.preprocess,h=null==s||null==(r=s.texture)?void 0:r.processAsync,c=null==s||null==(o=s.texture)?void 0:o.postprocess,d=new Set;return e.textures.map((s=>{var i;return l&&l(s),i=new Promise(h?(t,i)=>{h(s,e.images,((e,s)=>{e?i(e):t(s)}))}:e=>{e(null)}),i=i.then((i=>{i=null!=i?i:ig(s);var n=d.has(i);return d.add(i),t[i].then((t=>{var i,a,r,o,l,h=n?Df(t):t;return a=h.resource,r=(null!=(i=e.samplers)?i:[])[s.sampler],o=(e,t)=>{switch(e){case 9728:return 0;case 9729:return 1;case 9984:return 2;case 9985:return 4;case 9986:return 3;case 9987:return 5;default:return t}},l=(e,t)=>{switch(e){case 33071:return 1;case 33648:return 2;case 10497:return 0;default:return t}},a&&(r=null!=r?r:{},a.minFilter=o(r.minFilter,5),a.magFilter=o(r.magFilter,1),a.addressU=l(r.wrapS,0),a.addressV=l(r.wrapT,0)),h}))})),c&&(i=i.then((e=>(c(s,e),e)))),i}))})(o,c,a);tg(i,o,h,d,a).then((e=>r(null,e))).catch((e=>r(e)))}}))}))}static createDefaultMaterial(){return Xf({name:"defaultGlbMaterial"},[])}}class rg extends _p{load(e,t){"string"==typeof e&&(e={load:e,original:e});var s={retry:this.maxRetries>0,maxRetries:this.maxRetries};e.load.startsWith("blob:")&&(s.responseType=Jr.ResponseType.JSON),Qr.get(e.load,s,((s,i)=>{s?t("Error loading animation clip resource: "+e.original+" ["+s+"]"):t(null,i)}))}open(e,t){var s=t.name,i=t.duration,n=t.inputs.map((e=>new cf(1,e))),a=t.outputs.map((e=>new cf(e.components,e.data))),r=t.curves.map((e=>new hf([e.path],e.inputIndex,e.outputIndex,e.interpolation)));return new nm(s,i,n,a,r)}constructor(e){super(e,"animclip")}}class og extends _p{load(e,t){"string"==typeof e&&(e={load:e,original:e});var s={retry:this.maxRetries>0,maxRetries:this.maxRetries};e.load.startsWith("blob:")&&(s.responseType=Jr.ResponseType.JSON),Qr.get(e.load,s,((s,i)=>{s?t("Error loading animation state graph resource: "+e.original+" ["+s+"]"):t(null,i)}))}open(e,t){return new Am(t)}constructor(e){super(e,"animstategraph")}}class lg{get model(){if(!this._model){var e=lg.createModel(this.data,this._defaultMaterial),t=lg.createAsset(this._assetName,"model",e,0);this._assets.add(t),this._model=t}return this._model}static createAsset(e,t,s,i){var n=new dp(e+"/"+t+"/"+i,t,{url:""});return n.resource=s,n.loaded=!0,n}instantiateModelEntity(e){var t=new Ep;return t.addComponent("model",Object.assign({type:"asset",asset:this.model},e)),t}instantiateRenderEntity(e){var t=this._defaultMaterial,s=[],i=function(e,i,n,a,r,o,l,h){var c=r[n.id],d=void 0===c?t:a[c],u=new sl(n,d);n.morph&&(u.morphInstance=new Oc(n.morph)),l.hasOwnProperty("skin")&&s.push({meshInstance:u,rootBone:e,entity:i});var p=h.get(l);if(p){var m=p.matrices,f=tn.getDefaultInstancingFormat(n.device),g=new $i(n.device,f,m.length/16,{data:m});u.setInstancing(g),u.instancingData._destroyVertexBuffer=!0}return u},n=(t,s,a)=>{var r=new Ep;s._cloneInternal(r),t||(t=r);for(var o=null,l=null,h=0;h<a.nodes.length;h++){if(a.nodes[h]===s){var c=a.gltf.nodes[h];if(c.hasOwnProperty("mesh")){var d=a.renders[c.mesh].meshes;l=this.renders[c.mesh];for(var u=0;u<d.length;u++){var p=d[u];if(p){var m=i(t,r,p,a.materials,a.meshDefaultMaterials,a.skins,c,a.nodeInstancingMap);o||(o=[]),o.push(m)}}}if(a.lights){var f=a.lights.get(c);f&&r.addChild(f.clone())}if(a.cameras){var g=a.cameras.get(c);g&&g.camera.system.cloneComponent(g,r)}}}o&&(r.addComponent("render",Object.assign({type:"asset",meshInstances:o},e)),r.render.assignAsset(l));for(var v=s.children,_=0;_<v.length;_++){var y=n(t,v[_],a);r.addChild(y)}return r},a=[];for(var r of this.data.scenes)a.push(n(null,r,this.data));return s.forEach((e=>{e.meshInstance.skinInstance=Lm.createCachedSkinInstance(e.meshInstance.mesh.skin,e.rootBone,e.entity),e.meshInstance.node.render.rootBone=e.rootBone})),lg.createSceneHierarchy(a,Ep)}getMaterialVariants(){return this.data.variants?Object.keys(this.data.variants):[]}applyMaterialVariant(e,t){var s=t?this.data.variants[t]:null;if(void 0!==s)for(var i=e.findComponents("render"),n=0;n<i.length;n++){var a=i[n];this._applyMaterialVariant(s,a.meshInstances)}}applyMaterialVariantInstances(e,t){var s=t?this.data.variants[t]:null;void 0!==s&&this._applyMaterialVariant(s,e)}_applyMaterialVariant(e,t){t.forEach((t=>{if(null===e)t.material=this._defaultMaterial;else{var s=this.data.meshVariants[t.mesh.id];s&&(t.material=this.data.materials[s[e]])}}))}static createSceneHierarchy(e,t){var s=null;if(1===e.length)s=e[0];else for(var i of(s=new t("SceneGroup"),e))s.addChild(i);return s}static createModel(e,t){var s=function(s,i,n,a,r,o,l){var h=e.meshDefaultMaterials[i.id],c=void 0===h?t:r[h],d=new sl(i,c,o);if(i.morph){var u=new Oc(i.morph);d.morphInstance=u,s.morphInstances.push(u)}if(l.hasOwnProperty("skin")){var p=l.skin,m=n[p];i.skin=m;var f=a[p];d.skinInstance=f,s.skinInstances.push(f)}s.meshInstances.push(d)},i=new zc,n=[];for(var a of e.skins){var r=new No(a);r.bones=a.bones,n.push(r)}i.graph=lg.createSceneHierarchy(e.scenes,Il);for(var o=0;o<e.nodes.length;o++){var l=e.nodes[o];if(l.root===i.graph){var h=e.gltf.nodes[o];if(h.hasOwnProperty("mesh"))for(var c=e.renders[h.mesh].meshes,d=0;d<c.length;d++){var u=c[d];u&&s(i,u,e.skins,n,e.materials,l,h)}}}return i}destroy(){var e=this._assets,t=function(t){e.remove(t),t.unload()},s=function(e){e.forEach((e=>{t(e)}))};this.animations&&(s(this.animations),this.animations=null),this.textures&&(s(this.textures),this.textures=null),this.materials&&(s(this.materials),this.materials=null),this.renders&&(s(this.renders),this.renders=null),this._model&&(t(this._model),this._model=null),this.data=null,this.assets=null}constructor(e,t,s,i){for(var n=function(e,i,n){var a=lg.createAsset(t.name,e,i,n);return s.add(a),a},a=[],r=0;r<e.renders.length;++r)a.push(n("render",e.renders[r],r));for(var o=[],l=0;l<e.materials.length;++l)o.push(n("material",e.materials[l],l));for(var h=[],c=0;c<e.animations.length;++c)h.push(n("animation",e.animations[c],c));this.data=e,this._model=null,this._assetName=t.name,this._assets=s,this._defaultMaterial=i,this.renders=a,this.materials=o,this.textures=e.textures,this.animations=h}}class hg{_getUrlWithoutParams(e){return e.indexOf("?")>=0?e.split("?")[0]:e}load(e,t,s){dp.fetchArrayBuffer(e.load,((i,n)=>{i?t(i):ag.parse(this._getUrlWithoutParams(e.original),Ye.extractPath(e.load),n,this._device,s.registry,s.options,((e,i)=>{e?t(e):t(null,new lg(i,s,this._assets,this._defaultMaterial))}))}),s,this.maxRetries)}open(e,t,s){return t}patch(e,t){}constructor(e,t,s){this._device=e,this._assets=t,this._defaultMaterial=ag.createDefaultMaterial(),this.maxRetries=s}}class cg extends _p{set maxRetries(e){for(var t in this.glbContainerParser.maxRetries=e,this.parsers)this.parsers.hasOwnProperty(t)&&(this.parsers[t].maxRetries=e)}get maxRetries(){return this.glbContainerParser.maxRetries}_getUrlWithoutParams(e){return e.indexOf("?")>=0?e.split("?")[0]:e}_getParser(e){var t=e?Ye.getExtension(this._getUrlWithoutParams(e)).toLowerCase().replace(".",""):null;return this.parsers[t]||this.glbContainerParser}load(e,t,s){"string"==typeof e&&(e={load:e,original:e}),this._getParser(e.original).load(e,t,s)}open(e,t,s){return this._getParser(e).open(e,t,s)}constructor(e){super(e,"container"),this.glbContainerParser=new hg(e.graphicsDevice,e.assets,0),this.parsers={}}}class dg extends _p{load(e,t,s){this.loadAssets(s,t)}open(e,t,s){return s?s.resource:null}patch(e,t){this.loadAssets(e,((s,i)=>{s&&(t.fire("error",e),t.fire("error:"+e.id,s,e),e.fire("error",e))}))}getAssetIds(e){var t=[];if(t[0]=e.file,(e.loadFaces||!e.file)&&e.data&&e.data.textures)for(var s=0;s<6;++s)t[s+1]=e.data.textures[s];else t[1]=t[2]=t[3]=t[4]=t[5]=t[6]=null;return t}compareAssetIds(e,t){return e&&t?parseInt(e,10)===e||"string"==typeof e?e===t:e.url===t.url:null!==e==(null!==t)}update(e,t,s){var i,n,a,r=e.data||{},o=e._handlerState.assets,l=e._resources,h=[null,null,null,null,null,null,null],c=function(){return r.hasOwnProperty("type")?r.type:r.hasOwnProperty("rgbm")?r.rgbm?Bs:Fs:null};if(e.loaded&&s[0]===o[0])h[1]=l[1]||null,h[2]=l[2]||null,h[3]=l[3]||null,h[4]=l[4]||null,h[5]=l[5]||null,h[6]=l[6]||null;else if(s[0])if((i=s[0].resource).cubemap)for(a=0;a<6;++a)h[a+1]=new ki(this._device,{name:e.name+"_prelitCubemap"+(i.width>>a),cubemap:!0,type:c()||i.type,width:i.width>>a,height:i.height>>a,format:i.format,levels:[i._levels[a]],addressU:1,addressV:1,mipmaps:0===a});else h[1]=i;var d=s.slice(1);if(e.loaded&&this.cmpArrays(d,o.slice(1)))h[0]=l[0]||null;else if(-1===d.indexOf(null)){var u=d.map((e=>e.resource)),p=[];for(n=0;n<u[0]._levels.length;++n)p.push(u.map((e=>e._levels[n])));var m,f=u[0].format,g=new ki(this._device,{name:e.name+"_faces",cubemap:!0,type:c()||u[0].type,width:u[0].width,height:u[0].height,format:6===f?7:f,mipmaps:null==(m=r.mipmaps)||m,levels:p,minFilter:r.hasOwnProperty("minFilter")?r.minFilter:u[0].minFilter,magFilter:r.hasOwnProperty("magFilter")?r.magFilter:u[0].magFilter,anisotropy:r.hasOwnProperty("anisotropy")?r.anisotropy:1,addressU:1,addressV:1});h[0]=g}if(!this.cmpArrays(h,l))for(e.resources=h,e._handlerState.assetIds=t,e._handlerState.assets=s,a=0;a<l.length;++a)null!==l[a]&&-1===h.indexOf(l[a])&&l[a].destroy();for(a=0;a<o.length;++a)null!==o[a]&&-1===s.indexOf(o[a])&&o[a].unload()}cmpArrays(e,t){if(e.length!==t.length)return!1;for(var s=0;s<e.length;++s)if(e[s]!==t[s])return!1;return!0}resolveId(e){var t=parseInt(e,10);return t===e||t.toString()===e?t:e}loadAssets(e,t){e.hasOwnProperty("_handlerState")||(e._handlerState={assetIds:[null,null,null,null,null,null,null],assets:[null,null,null,null,null,null,null]});for(var s,i=this,n=i.getAssetIds(e),a=[null,null,null,null,null,null,null],r=e._handlerState.assetIds,o=e._handlerState.assets,l=i._registry,h=7,c=function(s,r){a[s]=r,0===--h&&(i.update(e,n,a),t(null,e.resources))},d=function(e,s,i){t(s)},u=function(e,t){t.loaded?c(e,t):(l.once("load:"+t.id,c.bind(i,e)),l.once("error:"+t.id,d.bind(i,e)),t.loading||l.load(t))},p=0;p<7;++p){var m=this.resolveId(n[p]);if(m)if(i.compareAssetIds(m,r[p]))u(p,o[p]);else if(parseInt(m,10)===m)(s=l.get(m))?u(p,s):setTimeout(((e,t)=>{var s=l.get(t);s?u(e,s):d(0,"failed to find dependent cubemap asset="+t)}).bind(null,p,m));else{var f="string"==typeof m?{url:m,filename:m}:m,g=-1===f.url.search(".dds")?{type:"rgbp",addressu:"clamp",addressv:"clamp",mipmaps:!1}:null;s=new dp(e.name+"_part_"+p,"texture",f,g),l.add(s),u(p,s)}else c(p,null)}}constructor(e){super(e,"cubemap"),this._device=e.graphicsDevice,this._registry=e.assets,this._loader=e.loader}}var ug=.28209479177387814;class pg{constructor(e,t,s,i,n,a){var r=(e,t)=>{var s=(1<<t)-1;return(e&s)/s},o=(e,t)=>{e.x=r(t>>>21,11),e.y=r(t>>>11,10),e.z=r(t,11)},l=(e,t,s)=>e*(1-s)+t*s,{chunkData:h,chunkSize:c,vertexData:d,shData:u,shBands:p}=e,m=[3,8,15][p-1];this.read=e=>{var f=Math.floor(e/256)*c;if(t&&(o(t,d[4*e+0]),t.x=l(h[f+0],h[f+3],t.x),t.y=l(h[f+1],h[f+4],t.y),t.z=l(h[f+2],h[f+5],t.z)),s&&((e,t)=>{var s=1/(.5*Math.sqrt(2)),i=(r(t>>>20,10)-.5)*s,n=(r(t>>>10,10)-.5)*s,a=(r(t,10)-.5)*s,o=Math.sqrt(1-(i*i+n*n+a*a));switch(t>>>30){case 0:e.set(i,n,a,o);break;case 1:e.set(o,n,a,i);break;case 2:e.set(n,o,a,i);break;case 3:e.set(n,a,o,i)}})(s,d[4*e+1]),i&&(o(i,d[4*e+2]),i.x=l(h[f+6],h[f+9],i.x),i.y=l(h[f+7],h[f+10],i.y),i.z=l(h[f+8],h[f+11],i.z)),n&&(((e,t)=>{e.x=r(t>>>24,8),e.y=r(t>>>16,8),e.z=r(t>>>8,8),e.w=r(t,8)})(n,d[4*e+3]),c>12&&(n.x=l(h[f+12],h[f+15],n.x),n.y=l(h[f+13],h[f+16],n.y),n.z=l(h[f+14],h[f+17],n.z))),a&&p>0)for(var g=0;g<3;++g)for(var v=0;v<15;++v)a[15*g+v]=v<m?u[(3*e+g)*m+v]*(8/255)-4:0}}}class mg{createIter(e,t,s,i,n){return new pg(this,e,t,s,i,n)}calcAabb(e){for(var{chunkData:t,numChunks:s,chunkSize:i}=this,n=Math.exp(Math.max(t[9],t[10],t[11])),a=t[0]-n,r=t[1]-n,o=t[2]-n,l=t[3]+n,h=t[4]+n,c=t[5]+n,d=1;d<s;++d){var u=d*i;n=Math.exp(Math.max(t[u+9],t[u+10],t[u+11])),a=Math.min(a,t[u+0]-n),r=Math.min(r,t[u+1]-n),o=Math.min(o,t[u+2]-n),l=Math.max(l,t[u+3]+n),h=Math.max(h,t[u+4]+n),c=Math.max(c,t[u+5]+n)}return e.center.set(.5*(a+l),.5*(r+h),.5*(o+c)),e.halfExtents.set(.5*(l-a),.5*(h-r),.5*(c-o)),!0}getCenters(e){for(var t,s,i,n,a,r,{vertexData:o,chunkData:l,numChunks:h,chunkSize:c}=this,d=0;d<h;++d){var u=d*c;t=l[u+0],s=l[u+1],i=l[u+2],n=l[u+3],a=l[u+4],r=l[u+5];for(var p=Math.min(this.numSplats,256*(d+1)),m=256*d;m<p;++m){var f=o[4*m],g=(f>>>21)/2047,v=(f>>>11&1023)/1023,_=(2047&f)/2047;e[3*m+0]=(1-g)*t+g*n,e[3*m+1]=(1-v)*s+v*a,e[3*m+2]=(1-_)*i+_*r}}}calcFocalPoint(e){var{chunkData:t,numChunks:s,chunkSize:i}=this;e.x=0,e.y=0,e.z=0;for(var n=0;n<s;++n){var a=n*i;e.x+=t[a+0]+t[a+3],e.y+=t[a+1]+t[a+4],e.z+=t[a+2]+t[a+5]}e.mulScalar(.5/s)}get isCompressed(){return!0}get numChunks(){return Math.ceil(this.numSplats/256)}get chunkSize(){return this.chunkData.length/this.numChunks}get shBands(){var e,t;return null!=(t={3:1,8:2,15:3}[(null==(e=this.shData)?void 0:e.length)/this.numSplats/3])?t:0}decompress(){var e=["x","y","z","f_dc_0","f_dc_1","f_dc_2","opacity","scale_0","scale_1","scale_2","rot_0","rot_1","rot_2","rot_3"],{shBands:t}=this;if(t>0){for(var s=[],i=0;i<45;++i)s.push("f_rest_"+i);e.splice(e.indexOf("f_dc_0")+1,0,...s)}var n={};e.forEach((e=>{n[e]=new Float32Array(this.numSplats)}));for(var a=new yt,r=new kt,o=new yt,l=new bt,h=t>0?new Float32Array(45):null,c=this.createIter(a,r,o,l,h),d=0;d<this.numSplats;++d)if(c.read(d),n.x[d]=a.x,n.y[d]=a.y,n.z[d]=a.z,n.rot_1[d]=r.x,n.rot_2[d]=r.y,n.rot_3[d]=r.z,n.rot_0[d]=r.w,n.scale_0[d]=o.x,n.scale_1[d]=o.y,n.scale_2[d]=o.z,n.f_dc_0[d]=(l.x-.5)/ug,n.f_dc_1[d]=(l.y-.5)/ug,n.f_dc_2[d]=(l.z-.5)/ug,n.opacity[d]=l.w<=0?-40:l.w>=1?40:-Math.log(1/l.w-1),h)for(var u=0;u<45;++u)n["f_rest_"+u][d]=h[u];return new Ru([{name:"vertex",count:this.numSplats,properties:e.map((e=>({name:e,type:"float",byteSize:4,storage:n[e]})))}])}}function fg(){return fg=Object.assign||function(e){for(var t=1;t<arguments.length;t++){var s=arguments[t];for(var i in s)Object.prototype.hasOwnProperty.call(s,i)&&(e[i]=s[i])}return e},fg.apply(this,arguments)}class gg{destroy(){var e,t,s,i,n;null==(e=this.packedTexture)||e.destroy(),null==(t=this.chunkTexture)||t.destroy(),null==(s=this.shTexture0)||s.destroy(),null==(i=this.shTexture1)||i.destroy(),null==(n=this.shTexture2)||n.destroy()}createMaterial(e){var t=Lu(e);return t.setDefine("GSPLAT_COMPRESSED_DATA",!0),t.setParameter("packedTexture",this.packedTexture),t.setParameter("chunkTexture",this.chunkTexture),t.setParameter("numSplats",this.numSplatsVisible),this.shTexture0?(t.setDefine("SH_BANDS",3),t.setParameter("shTexture0",this.shTexture0),t.setParameter("shTexture1",this.shTexture1),t.setParameter("shTexture2",this.shTexture2)):t.setDefine("SH_BANDS",0),t}evalTextureSize(e){var t=Math.ceil(Math.sqrt(e)),s=Math.ceil(e/t);return new wt(t,s)}createTexture(e,t,s,i){return new ki(this.device,fg({name:e,width:s.x,height:s.y,format:t,cubemap:!1,mipmaps:!1,minFilter:0,magFilter:0,addressU:1,addressV:1},i?{levels:[i]}:{}))}constructor(e,t){var{chunkData:s,chunkSize:i,numChunks:n,numSplats:a,vertexData:r,shBands:o}=t;this.device=e,this.numSplats=a,this.numVisibleSplats=a,this.aabb=new Ft,t.calcAabb(this.aabb),this.centers=new Float32Array(3*a),t.getCenters(this.centers),this.packedTexture=this.createTexture("packedData",rs,this.evalTextureSize(a),r);var l=this.evalTextureSize(n);l.x*=5,this.chunkTexture=this.createTexture("chunkData",Zt,l);var h=this.chunkTexture.lock();if(((e,t,s,i,n)=>{for(var a=0;a<n;++a)for(var r=0;r<i;++r)e[a*t+r]=s[a*i+r]})(h,20,s,i,n),12===i)for(var c=0;c<n;++c)h[20*c+15]=1,h[20*c+16]=1,h[20*c+17]=1;if(this.chunkTexture.unlock(),o>0){for(var{shData:d}=t,u=this.evalTextureSize(a),p=this.createTexture("shTexture0",rs,u),m=this.createTexture("shTexture1",rs,u),f=this.createTexture("shTexture2",rs,u),g=p.lock(),v=m.lock(),_=f.lock(),y=new Uint8Array(g.buffer),x=new Uint8Array(v.buffer),w=new Uint8Array(_.buffer),b=[3,8,15][o-1],C=0;C<a;++C)for(var S=0;S<15;++S)y[16*C+S]=S<b?d[(3*C+0)*b+S]:127,x[16*C+S]=S<b?d[(3*C+1)*b+S]:127,w[16*C+S]=S<b?d[(3*C+2)*b+S]:127;p.unlock(),m.unlock(),f.unlock(),this.shTexture0=p,this.shTexture1=m,this.shTexture2=f}else this.shTexture0=null,this.shTexture1=null,this.shTexture2=null}}class vg{destroy(){var e;this.device=null,this.splatData=null,null==(e=this.splat)||e.destroy(),this.splat=null}createSplat(){return this.splat||(this.splat=this.splatData.isCompressed?new gg(this.device,this.splatData):new Fu(this.device,this.splatData)),this.splat}instantiate(e){void 0===e&&(e={});var t=this.createInstance(e),s=new Ep,i=s.addComponent("gsplat",{instance:t});return s.setLocalEulerAngles(0,0,180),i.customAabb=t.splat.aabb.clone(),s}createInstance(e){void 0===e&&(e={});var t=this.createSplat();return new Hu(t,e)}constructor(e,t,s){this.splat=null,this.comments=null,this.device=e,this.splatData=t,this.comments=s}}function _g(e,t,s,i,n,a,r){try{var o=e[a](r),l=o.value}catch(e){return void s(e)}o.done?t(l):Promise.resolve(l).then(i,n)}function yg(e){return function(){var t=this,s=arguments;return new Promise((function(i,n){var a=e.apply(t,s);function r(e){_g(a,i,n,r,o,"next",e)}function o(e){_g(a,i,n,r,o,"throw",e)}r(void 0)}))}}var xg=new Uint8Array([112,108,121,10]),wg=new Uint8Array([10,101,110,100,95,104,101,97,100,101,114,10]),bg=new Map([["char",Int8Array],["uchar",Uint8Array],["short",Int16Array],["ushort",Uint16Array],["int",Int32Array],["uint",Uint32Array],["float",Float32Array],["double",Float64Array]]);class Cg{read(){var e=this;return yg((function*(){var{value:t,done:s}=yield e.reader.read();if(s)throw new Error("Stream finished before end of header");e.push(t),null==e.progressFunc||e.progressFunc.call(e,t.byteLength)}))()}push(e){if(this.data){var t=this.tail-this.head,s=t+e.length;if(this.data.length>=s)this.head>0?(this.data.copyWithin(0,this.head,this.tail),this.data.set(e,t),this.head=0,this.tail=s):(this.data.set(e,this.tail),this.tail+=e.length);else{var i=new Uint8Array(s);this.head>0||this.tail<this.data.length?i.set(this.data.subarray(this.head,this.tail),0):i.set(this.data,0),i.set(e,t),this.data=i,this.view=new DataView(this.data.buffer),this.head=0,this.tail=s}}else this.data=e,this.view=new DataView(this.data.buffer),this.tail=e.length}compact(){this.head>0&&(this.data.copyWithin(0,this.head,this.tail),this.tail-=this.head,this.head=0)}get remaining(){return this.tail-this.head}getInt8(){var e=this.view.getInt8(this.head);return this.head++,e}getUint8(){var e=this.view.getUint8(this.head);return this.head++,e}getInt16(){var e=this.view.getInt16(this.head,!0);return this.head+=2,e}getUint16(){var e=this.view.getUint16(this.head,!0);return this.head+=2,e}getInt32(){var e=this.view.getInt32(this.head,!0);return this.head+=4,e}getUint32(){var e=this.view.getUint32(this.head,!0);return this.head+=4,e}getFloat32(){var e=this.view.getFloat32(this.head,!0);return this.head+=4,e}getFloat64(){var e=this.view.getFloat64(this.head,!0);return this.head+=8,e}constructor(e,t){this.head=0,this.tail=0,this.reader=e,this.progressFunc=t}}var Sg=yg((function*(e,t){var s=new mg,i=t[0].count,n=t[0].properties.length,a=t[1].count;s.numSplats=a,s.chunkData=new Float32Array(i*n),s.vertexData=new Uint32Array(4*(e=>{var t=Math.ceil(Math.sqrt(e));return t*Math.ceil(e/t)})(a));var r=yg((function*(t,s){for(var i=new Uint8Array(t),n=0;n<s;){for(;0===e.remaining;)yield e.read();for(var a=Math.min(s-n,e.remaining),r=e.data,o=0;o<a;++o)i[n++]=r[e.head++]}}));return yield r(s.chunkData.buffer,i*n*4),yield r(s.vertexData.buffer,4*a*4),3===t.length&&(s.shData=new Uint8Array(t[2].count*t[2].properties.length),yield r(s.shData.buffer,s.shData.byteLength)),s})),Ag=yg((function*(e,t){var s,i=t[0],n=i.properties,a=n.length,r=n.map((e=>e.storage)),o=n.reduce(((e,t)=>e+t.byteSize),0),l=0,h=()=>{var t=e.data.buffer;(null==s?void 0:s.buffer)!==t&&(s=new Float32Array(t,0,t.byteLength/4))};for(h();l<i.count;){for(;e.remaining<o;)yield e.read(),h();for(var c=Math.min(i.count-l,Math.floor(e.remaining/o)),d=0;d<a;++d)for(var u=r[d],p=0;p<c;++p)u[p+l]=s[p*a+d];l+=c,e.head+=c*o}return new Ru(t)})),Tg=yg((function*(e,t){for(var s=0;s<t.length;++s)for(var i=t[s],n=i.properties.reduce(((e,t)=>e+t.byteSize),0),a=i.properties.map((e=>{if(!e.storage)return t=>{t.head+=e.byteSize};switch(e.type){case"char":return(t,s)=>{e.storage[s]=t.getInt8()};case"uchar":return(t,s)=>{e.storage[s]=t.getUint8()};case"short":return(t,s)=>{e.storage[s]=t.getInt16()};case"ushort":return(t,s)=>{e.storage[s]=t.getUint16()};case"int":return(t,s)=>{e.storage[s]=t.getInt32()};case"uint":return(t,s)=>{e.storage[s]=t.getUint32()};case"float":return(t,s)=>{e.storage[s]=t.getFloat32()};case"double":return(t,s)=>{e.storage[s]=t.getFloat64()};default:throw new Error("Unsupported property data type '"+e.type+"' in ply header")}})),r=0;r<i.count;){for(;e.remaining<n;)yield e.read();for(var o=Math.min(i.count-r,Math.floor(e.remaining/n)),l=0;l<o;++l){for(var h=0;h<i.properties.length;++h)a[h](e,r);r++}}return new Ru(t)})),Pg=yg((function*(e,t,s){void 0===t&&(t=null),void 0===s&&(s=null);for(var i,n=(e,t)=>{var s,i,n=e.length-t.length;for(s=0;s<=n;++s){for(i=0;i<t.length&&e[s+i]===t[i];++i);if(i===t.length)return s}return-1},a=(e,t)=>{if(e.length<t.length)return!1;for(var s=0;s<t.length;++s)if(e[s]!==t[s])return!1;return!0},r=new Cg(e,s);;){if(yield r.read(),r.tail>=xg.length&&!a(r.data,xg))throw new Error("Invalid ply header");if(-1!==(i=n(r.data,wg)))break}var o=new TextDecoder("ascii").decode(r.data.subarray(0,i)).split("\n"),{elements:l,format:h,comments:c}=(e=>{for(var t,s=[],i=[],n=1;n<e.length;++n){var a=e[n].split(" ");switch(a[0]){case"comment":i.push(a.slice(1).join(" "));break;case"format":t=a[1];break;case"element":s.push({name:a[1],count:parseInt(a[2],10),properties:[]});break;case"property":if(!bg.has(a[1]))throw new Error("Unrecognized property data type '"+a[1]+"' in ply header");s[s.length-1].properties.push({type:a[1],name:a[2],storage:null,byteSize:bg.get(a[1]).BYTES_PER_ELEMENT});break;default:throw new Error("Unrecognized header value '"+a[0]+"' in ply header")}}return{elements:s,format:t,comments:i}})(o);if("binary_little_endian"!==h)throw new Error("Unsupported ply format");r.head=i+wg.length,r.compact();var d=yg((function*(){return(e=>{var t=["min_x","min_y","min_z","max_x","max_y","max_z","min_scale_x","min_scale_y","min_scale_z","max_scale_x","max_scale_y","max_scale_z","min_r","min_g","min_b","max_r","max_g","max_b"],s=["packed_position","packed_rotation","packed_scale","packed_color"],i=new Array(45).fill("").map(((e,t)=>"f_rest_"+t)),n=()=>"chunk"===e[0].name&&e[0].properties.every(((e,s)=>e.name===t[s]&&"float"===e.type))&&"vertex"===e[1].name&&e[1].properties.every(((e,t)=>e.name===s[t]&&"uint"===e.type));return 2===e.length&&n()||3===e.length&&n()&&"sh"===e[2].name&&-1!==[9,24,45].indexOf(e[2].properties.length)&&e[2].properties.every(((e,t)=>e.name===i[t]&&"uchar"===e.type))})(l)?yield Sg(r,l):(l.forEach((e=>{e.properties.forEach((s=>{var i=bg.get(s.type);if(i){var n=!t||t(s.name)?new i(e.count):null;s.storage=n}}))})),(e=>1===e.length&&"vertex"===e[0].name&&e[0].properties.every((e=>"float"===e.type)))(l)?yield Ag(r,l):yield Tg(r,l))}));return{data:yield d(),comments:c}})),Eg=e=>!0;class kg{load(e,t,s){var i=this;return yg((function*(){try{var n=yield fetch(e.load);if(n&&n.body){var a,r,o,l=parseInt(null!=(a=n.headers.get("content-length"))?a:"0",10),h=0,{data:c,comments:d}=yield Pg(n.body.getReader(),null!=(r=s.data.elementFilter)?r:Eg,(e=>{h+=e,s&&s.fire("progress",h,l)}));if(!c.isCompressed)(null==(o=s.data.reorder)||o)&&c.reorderData();var u=new vg(i.device,c.isCompressed&&s.data.decompress?c.decompress():c,d);t(null,u)}else t("Error loading resource",null)}catch(e){t(e,null)}}))()}open(e,t){return t}constructor(e,t,s){this.device=e,this.assets=t,this.maxRetries=s}}class Mg extends _p{load(e,t,s){"string"==typeof e&&(e={load:e,original:e}),this.parser.load(e,t,s)}open(e,t,s){return this.parser.open(e,t,s)}constructor(e){super(e,"gsplat"),this.parser=new kg(e.graphicsDevice,e.assets,3)}}function Ig(){var e,t,s,i=0,n=1,a=2,r=3,o=8,l=9,h=10,c=11,d=12,u=13,p=14,m=16,f={astc:h,dxt:a,etc1:i,etc2:i,pvr:o,atc:c,none:p},g={astc:h,dxt:r,etc1:m,etc2:n,pvr:l,atc:d,none:m},v=21,_=22,y=23,x=8,w=10,b=26,C=27,S=28,A=29,T=30,P=7,E=3,k=5,M=(e,t)=>{switch(e){case i:return t.formats.etc2?_:v;case n:return y;case a:return x;case r:return w;case o:return b;case l:return C;case h:return S;case c:return A;case d:return T;case u:return P;case p:return E;case m:return k}},I=e=>{for(var t=function(e,t){var s=e*(2/255)-1,i=t*(2/255)-1,n=Math.sqrt(1-Math.min(1,s*s+i*i));return Math.max(0,Math.min(255,Math.floor(.5*(n+1)*255)))},s=0;s<e.length;s+=4){var i=e[s+3],n=e[s+1];e[s+0]=i,e[s+2]=t(i,n),e[s+3]=255}return e},D=e=>{for(var t=new Uint16Array(e.length/4),s=0;s<e.length;s+=4){var i=e[s+0],n=e[s+1],a=e[s+2];t[s/4]=(248&i)<<8|(252&n)<<3|a>>3}return t},R=()=>"undefined"!=typeof performance?performance.now():0,L=(e,i,n)=>{if(n){if(e.formats.astc)return"astc"}else if(i){if(e.formats.etc2)return"etc2"}else{if(e.formats.etc2)return"etc2";if(e.formats.etc1)return"etc1"}return(t=>{for(var s=0;s<t.length;++s){var i=t[s];if(e.formats[i])return i}return"none"})(i?s:t)},F=(e,t,s)=>{switch(s){case i:case n:return!0;case a:case r:return!(3&e||3&t);case o:case l:return((e,t)=>!(e&e-1||t&t-1))(e,t);case h:case c:case d:return!0}return!1},B=(t,s,i)=>i.isKTX2?((t,s,i)=>{if(!e.KTX2File)throw new Error("Basis transcoder module does not include support for KTX2.");var n=R(),a=new e.KTX2File(new Uint8Array(s)),r=a.getWidth(),o=a.getHeight(),l=a.getLevels(),h=!!a.getHasAlpha(),c=a.isUASTC&&a.isUASTC();if(!r||!o||!l)throw a.close(),a.delete(),new Error("Invalid image dimensions url="+t+" width="+r+" height="+o+" levels="+l);var d,v,_=L(i.deviceDetails,h,c),y=!!i.isGGGR&&"pvr"===_;if(y?d=u:F(r,o,d=h?g[_]:f[_])||(d=h?u:p),!a.startTranscoding())throw a.close(),a.delete(),new Error("Failed to start transcoding url="+t);for(var x=[],w=0;w<l;++w){var b=a.getImageTranscodedSizeInBytes(w,0,0,d),C=new Uint8Array(b);if(!a.transcodeImage(C,w,0,0,d,0,-1,-1))throw a.close(),a.delete(),new Error("Failed to transcode image url="+t);var S=d===p||d===m;x.push(S?new Uint16Array(C.buffer):C)}if(a.close(),a.delete(),y)for(d=p,v=0;v<x.length;++v)x[v]=D(I(x[v]));return{format:M(d,i.deviceDetails),width:r,height:o,levels:x,cubemap:!1,transcodeTime:R()-n,url:t,unswizzledGGGR:y}})(t,s,i):((t,s,i)=>{var n=R(),a=new e.BasisFile(new Uint8Array(s)),r=a.getImageWidth(0,0),o=a.getImageHeight(0,0),l=a.getNumImages(),h=a.getNumLevels(0),c=!!a.getHasAlpha(),d=a.isUASTC&&a.isUASTC();if(!(r&&o&&l&&h))throw a.close(),a.delete(),new Error("Invalid image dimensions url="+t+" width="+r+" height="+o+" images="+l+" levels="+h);var v,_,y=L(i.deviceDetails,c,d),x=!!i.isGGGR&&"pvr"===y;if(x?v=u:F(r,o,v=c?g[y]:f[y])||(v=c?u:p),!a.startTranscoding())throw a.close(),a.delete(),new Error("Failed to start transcoding url="+t);for(var w=[],b=0;b<h;++b){var C=a.getImageTranscodedSizeInBytes(0,b,v),S=new Uint8Array(C);if(!a.transcodeImage(S,0,b,v,0,0)){if(b!==h-1||C!==w[b-1].buffer.byteLength)throw a.close(),a.delete(),new Error("Failed to transcode image url="+t);S.set(new Uint8Array(w[b-1].buffer)),console.warn("Failed to transcode last mipmap level, using previous level instead url="+t)}var A=v===p||v===m;w.push(A?new Uint16Array(S.buffer):S)}if(a.close(),a.delete(),x)for(v=p,_=0;_<w.length;++_)w[_]=D(I(w[_]));return{format:M(v,i.deviceDetails),width:r,height:o,levels:w,cubemap:!1,transcodeTime:R()-n,url:t,unswizzledGGGR:x}})(t,s,i),O=(e,t,s)=>{try{var i=B(e,t,s);i.levels=i.levels.map((e=>e.buffer)),self.postMessage({url:e,data:i},i.levels)}catch(t){self.postMessage({url:e,err:t},null)}},z=[];self.onmessage=i=>{var n,a,r=i.data;switch(r.type){case"init":n=r.config,a=()=>{for(var e=0;e<z.length;++e)O(z[e].url,z[e].data,z[e].options);z.length=0},self.BASIS(n.module?{instantiateWasm:(e,t)=>(WebAssembly.instantiate(n.module,e).then((e=>{t(e)})).catch((e=>{console.error("instantiate failed + "+e)})),{})}:null).then((i=>{i.initializeBasis(),e=i,t=n.rgbPriority,s=n.rgbaPriority,a(null)}));break;case"transcode":e?O(r.url,r.data,r.options):z.push(r)}}}var Dg=e=>({astc:!!e.extCompressedTextureASTC,atc:!!e.extCompressedTextureATC,dxt:!!e.extCompressedTextureS3TC,etc1:!!e.extCompressedTextureETC1,etc2:!!e.extCompressedTextureETC,pvr:!!e.extCompressedTexturePVRTC});class Rg{run(e){var t=[];e.data instanceof ArrayBuffer&&t.push(e.data),this.worker.postMessage({type:"transcode",url:e.url,format:e.format,data:e.data,options:e.options},t),this.eager&&this.queue.enqueueClient(this)}constructor(e,t,s){this.queue=e,this.worker=new Worker(t.workerUrl),this.worker.addEventListener("message",(e=>{var t=e.data;this.queue.handleResponse(t.url,t.err,t.data),this.eager||this.queue.enqueueClient(this)})),this.worker.postMessage({type:"init",config:t}),this.eager=s}}var Lg=["etc2","etc1","astc","dxt","pvr","atc"],Fg=["astc","dxt","etc2","pvr","atc"],Bg=new class{enqueueJob(e,t,s,i){if(this.callbacks.hasOwnProperty(e))this.callbacks[e].push(s);else{this.callbacks[e]=[s];var n={url:e,data:t,options:i};this.clients.length>0?this.clients.shift().run(n):this.queue.push(n)}}enqueueClient(e){this.queue.length>0?e.run(this.queue.shift()):this.clients.push(e)}handleResponse(e,t,s){var i=this.callbacks[e];if(t)for(var n=0;n<i.length;++n)i[n](t);else{3===s.format||5===s.format?s.levels=s.levels.map((e=>new Uint16Array(e))):s.levels=s.levels.map((e=>new Uint8Array(e)));for(var a=0;a<i.length;++a)i[a](null,s)}delete this.callbacks[e]}constructor(){this.callbacks={},this.queue=[],this.clients=[]}},Og=null,zg=!1;function Vg(e){if(!zg){if(e){if(e.lazyInit)return void(Og=e)}else e=Og||{};if(!e.glueUrl||!e.wasmUrl||!e.fallbackUrl){var t=rt.getConfig("BASIS");t&&(e={glueUrl:t.glueUrl,wasmUrl:t.wasmUrl,fallbackUrl:t.fallbackUrl,numWorkers:t.numWorkers})}if(e.glueUrl||e.wasmUrl||e.fallbackUrl){zg=!0;var s=Math.max(1,Math.min(16,e.numWorkers||1)),i=1===e.numWorkers||!e.hasOwnProperty("eagerWorkers")||e.eagerWorkers;e.rgbPriority=e.rgbPriority||Lg,e.rgbaPriority=e.rgbaPriority||Fg,e.maxRetries=e.hasOwnProperty("maxRetries")?e.maxRetries:5,((e,t)=>{var s=e=>{var t=["/* basis */",e,"","("+Ig.toString()+")()\n\n"].join("\n");return new Blob([t],{type:"application/javascript"})},i=(i,n)=>{t(null,{workerUrl:URL.createObjectURL(s(i)),module:n,rgbPriority:e.rgbPriority,rgbaPriority:e.rgbaPriority})},n={cache:!0,responseType:"text",retry:e.maxRetries>0,maxRetries:e.maxRetries};if(e.glueUrl&&e.wasmUrl&&(()=>{try{if("object"==typeof WebAssembly&&"function"==typeof WebAssembly.instantiate){var e=new WebAssembly.Module(Uint8Array.of(0,97,115,109,1,0,0,0));if(e instanceof WebAssembly.Module)return new WebAssembly.Instance(e)instanceof WebAssembly.Instance}}catch(e){}return!1})()){var a=null,r=null;Qr.get(e.glueUrl,n,((e,s)=>{e?t(e):r?i(s,r):a=s}));var o=fetch(e.wasmUrl),l=()=>{o.then((e=>e.arrayBuffer())).then((e=>WebAssembly.compile(e))).then((e=>{a?i(a,e):r=e})).catch((e=>{t(e,null)}))};WebAssembly.compileStreaming?WebAssembly.compileStreaming(o).then((e=>{a?i(a,e):r=e})).catch((e=>{l()})):l()}else Qr.get(e.fallbackUrl,n,((e,s)=>{e?t(e,null):i(s,null)}))})(e,((e,t)=>{if(e)console.error("failed to initialize basis worker: "+e);else for(var n=0;n<s;++n)Bg.enqueueClient(new Rg(Bg,t,i))}))}}}var Ng=null;function Ug(e,t,s,i,n){return Vg(),Ng||(Ng={formats:Dg(e)}),Bg.enqueueJob(t,s,i,{deviceDetails:Ng,isGGGR:!!(null==n?void 0:n.isGGGR),isKTX2:!!(null==n?void 0:n.isKTX2)}),zg}class Hg{load(e,t,s){throw new Error("not implemented")}open(e,t,s){throw new Error("not implemented")}}function Gg(){return Gg=Object.assign||function(e){for(var t=1;t<arguments.length;t++){var s=arguments[t];for(var i in s)Object.prototype.hasOwnProperty.call(s,i)&&(e[i]=s[i])}return e},Gg.apply(this,arguments)}class Wg extends Hg{load(e,t,s){var i=this.device;dp.fetchArrayBuffer(e.load,((n,a)=>{n?t(n):(n=>{var a,r,o;Ug(i,e.load,n,t,{isGGGR:!!(8&(null==s||null==(o=s.file)||null==(r=o.variants)||null==(a=r.basis)?void 0:a.opt))})||t("Basis module not found. Asset ["+s.name+"]("+s.getFileUrl()+") basis texture variant will not be loaded.")})(a)}),s,this.maxRetries)}open(e,t,s,i){void 0===i&&(i={});var n=i.srgb?us(t.format):t.format,a=new ki(s,Gg({name:e,addressU:t.cubemap?1:0,addressV:t.cubemap?1:0,width:t.width,height:t.height,format:n,cubemap:t.cubemap,levels:t.levels},i));return a.upload(),a}constructor(e,t){super(),this.device=t,this.maxRetries=0}}function jg(){return jg=Object.assign||function(e){for(var t=1;t<arguments.length;t++){var s=arguments[t];for(var i in s)Object.prototype.hasOwnProperty.call(s,i)&&(e[i]=s[i])}return e},jg.apply(this,arguments)}class qg extends Hg{load(e,t,s){var i,n=!!(null==s||null==(i=s.file)?void 0:i.contents);if(n){if(this.device.supportsImageBitmap)return void this._loadImageBitmapFromBlob(new Blob([s.file.contents]),t);e={load:URL.createObjectURL(new Blob([s.file.contents])),original:e.original}}var a,r=(s,i)=>{n&&URL.revokeObjectURL(e.load),t(s,i)};s&&s.options&&s.options.hasOwnProperty("crossOrigin")?a=s.options.crossOrigin:rp.test(e.load)&&(a=this.crossOrigin),this.device.supportsImageBitmap?this._loadImageBitmap(e.load,e.original,a,r):this._loadImage(e.load,e.original,a,r)}open(e,t,s,i){void 0===i&&(i={});var n=new ki(s,jg({name:e,width:t.width,height:t.height,format:i.srgb?ss:7},i));return n.setSource(t),n}_loadImage(e,t,s,i){var n=new Image;s&&(n.crossOrigin=s);var a,r=0,o=this.maxRetries;n.onload=function(){i(null,n)},n.onerror=function(){if(!a)if(o>0&&++r<=o){var s=100*Math.pow(2,r);console.log("Error loading Texture from: '"+t+"' - Retrying in "+s+"ms...");var l=e.indexOf("?")>=0?"&":"?";a=setTimeout((()=>{n.src=e+l+"retry="+Date.now(),a=null}),s)}else i("Error loading Texture from: '"+t+"'")},n.src=e}_loadImageBitmap(e,t,s,i){var n={cache:!0,responseType:"blob",retry:this.maxRetries>0,maxRetries:this.maxRetries};Qr.get(e,n,((e,t)=>{e?i(e):this._loadImageBitmapFromBlob(t,i)}))}_loadImageBitmapFromBlob(e,t){createImageBitmap(e,{premultiplyAlpha:"none",colorSpaceConversion:"none"}).then((e=>t(null,e))).catch((e=>t(e)))}constructor(e,t){super(),this.crossOrigin=e.prefix?"anonymous":null,this.maxRetries=0,this.device=t}}function Xg(){return Xg=Object.assign||function(e){for(var t=1;t<arguments.length;t++){var s=arguments[t];for(var i in s)Object.prototype.hasOwnProperty.call(s,i)&&(e[i]=s[i])}return e},Xg.apply(this,arguments)}var Yg=[1481919403,3140563232,169478669],$g={33776:8,33778:9,33779:$t,36196:21,37492:22,37496:23,35840:26,35841:is,35842:27,35843:ns,32849:6,32856:7,35905:19,35907:ss,35898:ts,34843:11,34842:Kt};class Kg extends Hg{load(e,t,s){dp.fetchArrayBuffer(e.load,t,s,this.maxRetries)}open(e,t,s,i){void 0===i&&(i={});var n=this.parse(t);if(!n)return null;var a=i.srgb?us(n.format):n.format,r=new ki(s,Xg({name:e,addressU:n.cubemap?1:0,addressV:n.cubemap?1:0,width:n.width,height:n.height,format:a,cubemap:n.cubemap,levels:n.levels},i));return r.upload(),r}parse(e){var t=new Uint32Array(e);if(Yg[0]!==t[0]||Yg[1]!==t[1]||Yg[2]!==t[2])return null;var s={glInternalFormat:t[7],pixelWidth:t[9],pixelHeight:t[10],pixelDepth:t[11],numberOfArrayElements:t[12],numberOfFaces:t[13],numberOfMipmapLevels:t[14],bytesOfKeyValueData:t[15]};if(s.pixelDepth>1)return null;if(0!==s.numberOfArrayElements)return null;var i=$g[s.glInternalFormat];if(void 0===i)return null;for(var n,a,r,o=16+s.bytesOfKeyValueData/4,l=s.numberOfFaces>1,h=[],c=0;c<(s.numberOfMipmapLevels||1);c++){var d=t[o++];l&&h.push([]);for(var u=l?h[c]:h,p=0;p<(l?6:1);++p)u.push((n=e,a=4*o,r=d,i===ts?new Uint32Array(n,a,r/4):new Uint8Array(n,a,r))),o+=d+3>>2}return{format:i,width:s.pixelWidth,height:s.pixelHeight,levels:h,cubemap:l}}constructor(e){super(),this.maxRetries=0}}function Zg(){return Zg=Object.assign||function(e){for(var t=1;t<arguments.length;t++){var s=arguments[t];for(var i in s)Object.prototype.hasOwnProperty.call(s,i)&&(e[i]=s[i])}return e},Zg.apply(this,arguments)}var Jg=166;class Qg extends Hg{load(e,t,s){dp.fetchArrayBuffer(e.load,((i,n)=>{i?t(i,n):this.parse(n,e,t,s)}),s,this.maxRetries)}open(e,t,s,i){void 0===i&&(i={});var n=i.srgb?us(t.format):t.format,a=new ki(s,Zg({name:e,addressU:t.cubemap?1:0,addressV:t.cubemap?1:0,width:t.width,height:t.height,format:n,cubemap:t.cubemap,levels:t.levels},i));return a.upload(),a}parse(e,t,s,i){var n=new ot(e),a=[n.readU32be(),n.readU32be(),n.readU32be()];if(2873840728!==a[0]||540160187!==a[1]||218765834!==a[2])return null;for(var r={vkFormat:n.readU32(),typeSize:n.readU32(),pixelWidth:n.readU32(),pixelHeight:n.readU32(),pixelDepth:n.readU32(),layerCount:n.readU32(),faceCount:n.readU32(),levelCount:n.readU32(),supercompressionScheme:n.readU32()},o={dfdByteOffset:n.readU32(),dfdByteLength:n.readU32(),kvdByteOffset:n.readU32(),kvdByteLength:n.readU32(),sgdByteOffset:n.readU64(),sgdByteLength:n.readU64()},l=[],h=0;h<Math.max(1,r.levelCount);++h)l.push({byteOffset:n.readU64(),byteLength:n.readU64(),uncompressedByteLength:n.readU64()});if(n.readU32()!==o.kvdByteOffset-o.dfdByteOffset)return null;n.skip(8);var c,d,u,p=n.readU8();(n.skip(o.dfdByteLength-9),n.skip(o.kvdByteLength),1===r.supercompressionScheme||p===Jg)?Ug(this.device,t.load,e,s,{isGGGR:!!(8&(null==i||null==(u=i.file)||null==(d=u.variants)||null==(c=d.basis)?void 0:c.opt)),isKTX2:!0})||s("Basis module not found. Asset ["+i.name+"]("+i.getFileUrl()+") basis texture variant will not be loaded."):s("unsupported KTX2 pixel format")}constructor(e,t){super(),this.maxRetries=0,this.device=t}}function ev(){return ev=Object.assign||function(e){for(var t=1;t<arguments.length;t++){var s=arguments[t];for(var i in s)Object.prototype.hasOwnProperty.call(s,i)&&(e[i]=s[i])}return e},ev.apply(this,arguments)}class tv extends Hg{load(e,t,s){dp.fetchArrayBuffer(e.load,t,s,this.maxRetries)}open(e,t,s,i){void 0===i&&(i={});var n,a=new Uint32Array(t,0,32),r=a[4],o=a[3],l=Math.max(a[7],1),h=4===a[20],c=a[21],d=a[22],u=65024===a[28],p=827611204,m=825438800,f=825439312,g=!1,v=!1,_=!1,y=!1,x=null,w=1;if(h?c===p?(x=8,g=!0):894720068===c?(x=$t,g=!0):113===c?(x=Kt,w=2):116===c?(x=Zt,w=4):826496069===c?(x=21,g=!0,v=!0):c===m||825504336===c?(x=c===m?is:ns,g=!0,_=!0):c!==f&&825504848!==c||(x=c===f?26:27,g=!0,y=!0):32===d&&(x=7),!x)return n=new ki(s,{width:4,height:4,format:6,name:"dds-legacy-empty"});n=new ki(s,ev({name:e,addressU:u?1:0,addressV:u?1:0,width:r,height:o,format:x,cubemap:u,mipmaps:l>1},i));for(var b,C=128,S=u?6:1,A=c===p?8:16,T=0;T<S;T++)for(var P=r,E=o,k=0;k<l;k++){b=g?v?Math.floor((P+3)/4)*Math.floor((E+3)/4)*8:_?Math.max(P,16)*Math.max(E,8)/4:y?Math.max(P,8)*Math.max(E,8)/2:Math.floor((P+4-1)/4)*Math.floor((E+4-1)/4)*A:P*E*4;var M=x===Zt?new Float32Array(t,C,b):x===Kt?new Uint16Array(t,C,b):new Uint8Array(t,C,b);u?(n._levels[k]||(n._levels[k]=[]),n._levels[k][T]=M):n._levels[k]=M,C+=b*w,P=Math.max(.5*P,1),E=Math.max(.5*E,1)}return n.upload(),n}constructor(e){super(),this.maxRetries=0}}function sv(){return sv=Object.assign||function(e){for(var t=1;t<arguments.length;t++){var s=arguments[t];for(var i in s)Object.prototype.hasOwnProperty.call(s,i)&&(e[i]=s[i])}return e},sv.apply(this,arguments)}class iv extends Hg{load(e,t,s){dp.fetchArrayBuffer(e.load,t,s,this.maxRetries)}open(e,t,s,i){void 0===i&&(i={});var n=this.parse(t);if(!n)return null;var a=new ki(s,sv({name:e,addressU:0,addressV:1,minFilter:0,magFilter:0,width:n.width,height:n.height,levels:n.levels,format:7,type:Os,mipmaps:!1},i));return a.upload(),a}parse(e){var t=new ot(e);if(!t.readLine().startsWith("#?RADIANCE"))return null;for(var s={};;){var i=t.readLine();if(0===i.length)break;var n=i.split("=");2===n.length&&(s[n[0]]=n[1])}if(!s.hasOwnProperty("FORMAT"))return null;var a=t.readLine().split(" ");if(4!==a.length)return null;var r=parseInt(a[1],10),o=parseInt(a[3],10),l=this._readPixels(t,o,r,"-Y"===a[0]);return l?{width:o,height:r,levels:[l]}:null}_readPixels(e,t,s,i){if(t<8||t>32767)return this._readPixelsFlat(e,t,s);var n=[0,0,0,0];if(e.readArray(n),2!==n[0]||2!==n[1]||128&n[2])return e.skip(-4),this._readPixelsFlat(e,t,s);var a,r,o,l,h,c,d=new ArrayBuffer(t*s*4),u=new Uint8Array(d),p=i?0:4*t*(s-1);for(r=0;r<s;++r){if(r&&e.readArray(n),(n[2]<<8)+n[3]!==t)return null;for(l=0;l<4;++l)for(a=0;a<t;)if((h=e.readU8())>128){if(a+(h-=128)>t)return null;for(c=e.readU8(),o=0;o<h;++o)u[p+l+4*a++]=c}else{if(0===h||a+h>t)return null;for(o=0;o<h;++o)u[p+l+4*a++]=e.readU8()}p+=4*t*(i?1:-1)}return u}_readPixelsFlat(e,t,s){return e.remainingBytes===t*s*4?new Uint8Array(e.arraybuffer,e.offset):null}constructor(e){super(),this.maxRetries=0}}var nv={repeat:0,clamp:1,mirror:2},av={nearest:0,linear:1,nearest_mip_nearest:2,linear_mip_nearest:4,nearest_mip_linear:3,linear_mip_linear:5},rv={default:Fs,rgbm:Bs,rgbe:Os,rgbp:zs,swizzleGGGR:Vs};class ov extends _p{set crossOrigin(e){this.imgParser.crossOrigin=e}get crossOrigin(){return this.imgParser.crossOrigin}set maxRetries(e){for(var t in this.imgParser.maxRetries=e,this.parsers)this.parsers.hasOwnProperty(t)&&(this.parsers[t].maxRetries=e)}get maxRetries(){return this.imgParser.maxRetries}_getUrlWithoutParams(e){return e.indexOf("?")>=0?e.split("?")[0]:e}_getParser(e){var t=Ye.getExtension(this._getUrlWithoutParams(e)).toLowerCase().replace(".","");return this.parsers[t]||this.imgParser}_getTextureOptions(e){var t={};if(e){var s;(null==(s=e.name)?void 0:s.length)>0&&(t.name=e.name);var i=e.data;i.hasOwnProperty("minfilter")&&(t.minFilter=av[i.minfilter]),i.hasOwnProperty("magfilter")&&(t.magFilter=av[i.magfilter]),i.hasOwnProperty("addressu")&&(t.addressU=nv[i.addressu]),i.hasOwnProperty("addressv")&&(t.addressV=nv[i.addressv]),i.hasOwnProperty("mipmaps")&&(t.mipmaps=i.mipmaps),i.hasOwnProperty("anisotropy")&&(t.anisotropy=i.anisotropy),i.hasOwnProperty("flipY")&&(t.flipY=!!i.flipY),i.hasOwnProperty("srgb")&&(t.srgb=!!i.srgb),i.hasOwnProperty("type")?t.type=rv[i.type]:i.hasOwnProperty("rgbm")&&i.rgbm?t.type=Bs:e.file&&8&e.file.opt&&(t.type=Vs)}return t}load(e,t,s){"string"==typeof e&&(e={load:e,original:e}),this._getParser(e.original).load(e,t,s)}open(e,t,s){if(e){var i=this._getTextureOptions(s),n=this._getParser(e).open(e,t,this._device,i);return null===n?n=new ki(this._device,{width:4,height:4,format:6}):(!function(e){var t=Pi.calcMipLevelsCount(e._width,e._height);if(!(7!==e._format&&e._format!==Zt||e._volume||e._compressed||1===e._levels.length||e._levels.length===t||(s=e._cubemap?e._levels[0][0]:e._levels[0],s instanceof HTMLCanvasElement||s instanceof HTMLImageElement||s instanceof HTMLVideoElement))){for(var s,i=function(e,t,s){for(var i=Math.max(1,e>>1),n=Math.max(1,t>>1),a=new s.constructor(i*n*4),r=Math.floor(e/i),o=Math.floor(t/n),l=r*o,h=0;h<n;++h)for(var c=0;c<i;++c)for(var d=0;d<4;++d){for(var u=0,p=0;p<o;++p)for(var m=0;m<r;++m)u+=s[4*(c*r+m+(h*o+p)*e)+d];a[4*(c+h*i)+d]=u/l}return a},n=e._levels.length;n<t;++n){var a=Math.max(1,e._width>>n-1),r=Math.max(1,e._height>>n-1);if(e._cubemap){for(var o=[],l=0;l<6;++l)o.push(i(a,r,e._levels[n-1][l]));e._levels.push(o)}else e._levels.push(i(a,r,e._levels[n-1]))}e._levelsUpdated=e._cubemap?[[!0,!0,!0,!0,!0,!0]]:[!0]}}(n),t.unswizzledGGGR&&(s.file.variants.basis.opt&=-9)),n}}patch(e,t){var s=e.resource;if(s){var i=this._getTextureOptions(e);for(var n of Object.keys(i))s[n]=i[n]}}constructor(e){super(e,"texture");var t=e.assets,s=e.graphicsDevice;this._device=s,this._assets=t,this.imgParser=new qg(t,s),this.parsers={dds:new tv(t),ktx:new Kg(t),ktx2:new Qg(t,s),basis:new Wg(t,s),hdr:new iv(t)}}}var lv=[],hv=[[],[],[]];class cv extends Or{destroy(){this.viewBindGroups.forEach((e=>{e.defaultUniformBuffer.destroy(),e.destroy()})),this.viewBindGroups.length=0}update(e,t,s,i){this.camera=e,this.scene=t,this.layers=s,this.mapping=i}execute(){for(var e=this.device,{renderer:t,camera:s,scene:i,layers:n,mapping:a,renderTarget:r}=this,o=i.layers.layerList,l=i.layers.subLayerEnabled,h=i.layers.subLayerList,c=0;c<o.length;c++){var d=o[c];if(!(n&&n.indexOf(d)<0)&&(d.enabled&&l[c]&&d.camerasSet.has(s.camera))){var u=h[c];d._clearDepthBuffer&&t.clear(s.camera,!1,!0,!1);for(var p=d.meshInstances,m=0;m<p.length;m++){var f=p[m];f.pick&&f.transparent===u&&(lv.push(f),a.set(f.id,f))}if(lv.length>0){if(i.clusteredLightingEnabled)t.worldClustersAllocator.empty.activate();t.setCameraUniforms(s.camera,r),e.supportsUniformBuffers&&t.setupViewUniformBuffers(this.viewBindGroups,t.viewUniformFormat,t.viewBindGroupFormat,1),t.renderForward(s.camera,r,lv,hv,3,(t=>{e.setBlendState(Vi.NOBLEND)})),lv.length=0}}}}constructor(e,t){super(e),this.viewBindGroups=[],this.renderer=t}}var dv=new Set,uv=new bt;class pv{getSelection(e,t,s,i){void 0===s&&(s=1),void 0===i&&(i=1);var n=this.device;if(n.isWebGPU)return[];t=this.renderTarget.height-(t+i);var a=this.sanitizeRect(e,t,s,i);n.setRenderTarget(this.renderTarget),n.updateBegin();var r=new Uint8Array(4*a.z*a.w);return n.readPixels(a.x,a.y,a.z,a.w,r),n.updateEnd(),this.decodePixels(r,this.mapping)}getSelectionAsync(e,t,s,i){var n;void 0===s&&(s=1),void 0===i&&(i=1),(null==(n=this.device)?void 0:n.isWebGL2)&&(t=this.renderTarget.height-(t+i));var a=this.sanitizeRect(e,t,s,i);return this.renderTarget.colorBuffer.read(a.x,a.y,a.z,a.w,{renderTarget:this.renderTarget,immediate:!0}).then((e=>this.decodePixels(e,this.mapping)))}sanitizeRect(e,t,s,i){var n=this.renderTarget.width,a=this.renderTarget.height;return e=pt.clamp(Math.floor(e),0,n-1),t=pt.clamp(Math.floor(t),0,a-1),s=Math.floor(Math.max(s,1)),s=Math.min(s,n-e),i=Math.floor(Math.max(i,1)),i=Math.min(i,a-t),uv.set(e,t,s,i)}decodePixels(e,t){var s=[];if(this.deviceValid){for(var i=e.length,n=0;n<i;n+=4){var a=e[n+0],r=e[n+1],o=e[n+2],l=e[n+3]<<24|a<<16|r<<8|o;-1!==l&&dv.add(t.get(l))}dv.forEach((e=>{e&&s.push(e)})),dv.clear()}return s}allocateRenderTarget(){var e=new ki(this.device,{format:7,width:this.width,height:this.height,mipmaps:!1,minFilter:0,magFilter:0,addressU:1,addressV:1,name:"pick"});this.renderTarget=new ln({colorBuffer:e,depth:!0})}releaseRenderTarget(){this.renderTarget&&(this.renderTarget.destroyTextureBuffers(),this.renderTarget.destroy(),this.renderTarget=null)}prepare(e,t,s){s instanceof bc&&(s=[s]),this.renderTarget&&this.width===this.renderTarget.width&&this.height===this.renderTarget.height||(this.releaseRenderTarget(),this.allocateRenderTarget()),this.mapping.clear();var i=this.renderPass;i.init(this.renderTarget),i.colorOps.clearValue=mt.WHITE,i.colorOps.clear=!0,i.depthStencilOps.clearDepth=!0,i.update(e,t,s,this.mapping),i.render()}resize(e,t){this.width=Math.floor(e),this.height=Math.floor(t)}constructor(e,t,s){this.renderTarget=null,this.mapping=new Map,this.deviceValid=!0,this.renderer=e.renderer,this.device=e.graphicsDevice,this.renderPass=new cv(this.device,e.renderer),this.width=0,this.height=0,this.resize(t,s),this.device.on("destroy",(()=>{this.deviceValid=!1}))}}var mv="local",fv="world",gv="x",vv="y",_v="z",yv="xyz",xv="face",wv=new yt,bv=new yt,Cv=new Et,Sv=new Et,Av=new Ut,Tv=1e-6;class Pv extends tt{static createLayer(e,t,s){void 0===t&&(t="Gizmo");var i=new bc({name:t,clearDepthBuffer:!0,opaqueSortMode:0,transparentSortMode:0});return e.scene.layers.insert(i,null!=s?s:e.scene.layers.layerList.length),i}get layer(){return this._layer}set coordSpace(e){this._coordSpace=null!=e?e:fv,this._updateRotation()}get coordSpace(){return this._coordSpace}set size(e){this._size=e,this._updateScale()}get size(){return this._size}get facing(){if(0===this._camera.projection){var e=this.root.getPosition(),t=this._camera.entity.getPosition();return bv.sub2(t,e).normalize()}return bv.copy(this._camera.entity.forward).mulScalar(-1)}_onPointerDown(e){if(this.root.enabled&&!document.pointerLockElement){var t=this._getSelection(e.offsetX,e.offsetY);t[0]&&(e.preventDefault(),e.stopPropagation());var{canvas:s}=this._device;s.setPointerCapture(e.pointerId),this.fire(Pv.EVENT_POINTERDOWN,e.offsetX,e.offsetY,t[0])}}_onPointerMove(e){if(this.root.enabled&&!document.pointerLockElement){var t=this._getSelection(e.offsetX,e.offsetY);t[0]&&(e.preventDefault(),e.stopPropagation()),this.fire(Pv.EVENT_POINTERMOVE,e.offsetX,e.offsetY,t[0])}}_onPointerUp(e){if(this.root.enabled&&!document.pointerLockElement){var t=this._getSelection(e.offsetX,e.offsetY);t[0]&&(e.preventDefault(),e.stopPropagation());var{canvas:s}=this._device;s.releasePointerCapture(e.pointerId),this.fire(Pv.EVENT_POINTERUP,e.offsetX,e.offsetY,t[0])}}_updatePosition(){wv.set(0,0,0);for(var e=0;e<this.nodes.length;e++){var t=this.nodes[e];wv.add(t.getPosition())}wv.mulScalar(1/(this.nodes.length||1)),wv.distance(this.root.getPosition())<Tv||(this.root.setPosition(wv),this.fire(Pv.EVENT_POSITIONUPDATE,wv))}_updateRotation(){wv.set(0,0,0),this._coordSpace===mv&&0!==this.nodes.length&&wv.copy(this.nodes[this.nodes.length-1].getEulerAngles()),wv.distance(this.root.getEulerAngles())<Tv||(this.root.setEulerAngles(wv),this.fire(Pv.EVENT_ROTATIONUPDATE,wv))}_updateScale(){if(0===this._camera.projection){var e=this.root.getPosition(),t=this._camera.entity.getPosition(),s=e.distance(t);this._scale=Math.tan(.5*this._camera.fov*pt.DEG_TO_RAD)*s*.3}else this._scale=.32*this._camera.orthoHeight;this._scale=Math.max(this._scale*this._size,1e-4),Math.abs(this._scale-this.root.getLocalScale().x)<Tv||(this.root.setLocalScale(this._scale,this._scale,this._scale),this.fire(Pv.EVENT_SCALEUPDATE,this._scale))}_getSelection(e,t){for(var s=this._camera.screenToWorld(e,t,0),i=this._camera.screenToWorld(e,t,this._camera.farClip-this._camera.nearClip),n=wv.copy(i).sub(s).normalize(),a=[],r=0;r<this.intersectShapes.length;r++){var o=this.intersectShapes[r];if(!o.disabled&&o.entity.enabled)for(var l=o.entity.getWorldTransform(),h=0;h<o.triData.length;h++){var{tris:c,transform:d,priority:u}=o.triData[h],p=Cv.copy(l).mul(d),m=Sv.copy(p).invert(),f=Av;m.transformPoint(s,f.origin),m.transformVector(n,f.direction),f.direction.normalize();for(var g=0;g<c.length;g++)c[g].intersectsRay(f,wv)&&a.push({dist:p.transformPoint(wv).sub(s).length(),meshInstances:o.meshInstances,priority:u})}}return a.length?(a.sort(((e,t)=>0!==e.priority&&0!==t.priority?t.priority-e.priority:e.dist-t.dist)),a[0].meshInstances):[]}attach(e){if(void 0===e&&(e=[]),Array.isArray(e)){if(0===e.length)return;this.nodes=e}else this.nodes=[e];this._updatePosition(),this._updateRotation(),this._updateScale(),this.fire(Pv.EVENT_NODESATTACH),this.root.enabled=!0,this.fire(Pv.EVENT_RENDERUPDATE)}detach(){this.root.enabled=!1,this.fire(Pv.EVENT_RENDERUPDATE),this.fire(Pv.EVENT_NODESDETACH),this.nodes=[]}destroy(){this.detach(),this._device.canvas.removeEventListener("pointerdown",this._onPointerDown),this._device.canvas.removeEventListener("pointermove",this._onPointerMove),this._device.canvas.removeEventListener("pointerup",this._onPointerUp),this.root.destroy()}constructor(e,t){super(),this._size=1,this._scale=1,this._coordSpace=fv,this.nodes=[],this.intersectShapes=[],this._camera=e,this._app=e.system.app,this._device=this._app.graphicsDevice,this._layer=t,e.layers=e.layers.concat(t.id),this.root=new Ep("gizmo"),this._app.root.addChild(this.root),this.root.enabled=!1,this._updateScale(),this._onPointerDown=this._onPointerDown.bind(this),this._onPointerMove=this._onPointerMove.bind(this),this._onPointerUp=this._onPointerUp.bind(this),this._device.canvas.addEventListener("pointerdown",this._onPointerDown),this._device.canvas.addEventListener("pointermove",this._onPointerMove),this._device.canvas.addEventListener("pointerup",this._onPointerUp),this._app.on("update",(()=>{this._updatePosition(),this._updateRotation(),this._updateScale()})),this._app.on("destroy",(()=>this.destroy()))}}Pv.EVENT_POINTERDOWN="pointer:down",Pv.EVENT_POINTERMOVE="pointer:move",Pv.EVENT_POINTERUP="pointer:up",Pv.EVENT_POSITIONUPDATE="position:update",Pv.EVENT_ROTATIONUPDATE="rotation:update",Pv.EVENT_SCALEUPDATE="scale:update",Pv.EVENT_NODESATTACH="nodes:attach",Pv.EVENT_NODESDETACH="nodes:detach",Pv.EVENT_RENDERUPDATE="render:update";var Ev=Object.freeze(new mt(1,.3,.3)),kv=Object.freeze(new mt(.3,1,.3)),Mv=Object.freeze(new mt(.3,.3,1)),Iv=Object.freeze(new mt(1,1,.5)),Dv=Object.freeze(new mt(.5,.5,.5,.5)),Rv=new yt,Lv=new yt,Fv=new kt,Bv=new Ut,Ov=new Vt,zv=Object.keys(Rv);class Vv extends Pv{set shading(e){for(var t in this._shading=this.root.enabled&&e,this._shapes)this._shapes[t].shading=this._shading}get shading(){return this._shading}set snap(e){this._snap=this.root.enabled&&e}get snap(){return this._snap}set xAxisColor(e){this._updateAxisColor(gv,e)}get xAxisColor(){return this._meshColors.axis.x}set yAxisColor(e){this._updateAxisColor(vv,e)}get yAxisColor(){return this._meshColors.axis.y}set zAxisColor(e){this._updateAxisColor(_v,e)}get zAxisColor(){return this._meshColors.axis.z}set colorAlpha(e){for(var t in this._colorAlpha=pt.clamp(e,0,1),this._meshColors.axis.x.copy(this._colorSemi(this._meshColors.axis.x)),this._meshColors.axis.y.copy(this._colorSemi(this._meshColors.axis.y)),this._meshColors.axis.z.copy(this._colorSemi(this._meshColors.axis.z)),this._meshColors.axis.xyz.copy(this._colorSemi(this._meshColors.axis.xyz)),this._meshColors.axis.f.copy(this._colorSemi(this._meshColors.axis.f)),this._shapes)this._shapes[t].hover(!!this._hoverAxis)}get colorAlpha(){return this._colorAlpha}_colorSemi(e){return((e,t)=>new mt(e.r,e.g,e.b,t))(e,this._colorAlpha)}_updateAxisColor(e,t){var s,i=new mt((s=t).r,s.g,s.b),n=this._colorSemi(t);for(var a in this._guideColors[e].copy(i),this._meshColors.axis[e].copy(n),this._meshColors.hover[e].copy(i),this._shapes)this._shapes[a].hover(!!this._hoverAxis)}_getAxis(e){return e?e.node.name.split(":")[1]:""}_getIsPlane(e){return!!e&&-1!==e.node.name.indexOf("plane")}_hover(e){if(!this._dragging){var t;this._hoverAxis=this._getAxis(e),this._hoverIsPlane=this._getIsPlane(e);var s=e&&null!=(t=this._shapeMap.get(e))?t:null;s!==this._hoverShape&&(this._hoverShape&&(this._hoverShape.hover(!1),this._hoverShape=null),s&&(s.hover(!0),this._hoverShape=s),this.fire(Pv.EVENT_RENDERUPDATE))}}_createRay(e){if(0===this._camera.projection)return Bv.origin.copy(this._camera.entity.getPosition()),Bv.direction.sub2(e,Bv.origin).normalize(),Bv;var t=this._camera.farClip-this._camera.nearClip;return Bv.origin.sub2(e,Rv.copy(this._camera.entity.forward).mulScalar(t)),Bv.direction.copy(this._camera.entity.forward),Bv}_createPlane(e,t,s){var i=Rv.copy(this.facing),n=Ov.normal.set(0,0,0);return t?n.copy(i):(n[e]=1,this._rootStartRot.transformVector(n,n),s&&(Lv.cross(n,i).normalize(),n.cross(Lv,n).normalize())),Ov.setFromPointNormal(this._rootStartPos,n)}_dirFromAxis(e,t){return e===xv?t.copy(this._camera.entity.forward).mulScalar(-1):(t.set(0,0,0),t[e]=1),t}_projectToAxis(e,t){Rv.set(0,0,0),Rv[t]=1,e.copy(Rv.mulScalar(Rv.dot(e)));var s=e[t];e.set(0,0,0),e[t]=s}_screenToPoint(e,t,s,i){void 0===s&&(s=!1),void 0===i&&(i=!1);var n=this._camera.screenToWorld(e,t,1),a=this._selectedAxis,r=this._createRay(n),o=this._createPlane(a,s,i),l=new yt;return o.intersectsRay(r,l),l}_drawGuideLines(){for(var e=this.root.getPosition(),t=Fv.copy(this.root.getRotation()),s=this._hoverAxis||this._selectedAxis,i=this._hoverIsPlane||this._selectedIsPlane,n=0;n<zv.length;n++){var a=zv[n];s!==yv?i?a!==s&&this._drawSpanLine(e,t,a):a===s&&this._drawSpanLine(e,t,a):this._drawSpanLine(e,t,a)}}_drawSpanLine(e,t,s){Rv.set(0,0,0),Rv[s]=1,Rv.mulScalar(this._camera.farClip-this._camera.nearClip),Lv.copy(Rv).mulScalar(-1),t.transformVector(Rv,Rv),t.transformVector(Lv,Lv),this._app.drawLine(Rv.add(e),Lv.add(e),this._guideColors[s],!0)}_createTransform(){for(var e in this._shapes){var t=this._shapes[e];this.root.addChild(t.entity),this.intersectShapes.push(t);for(var s=0;s<t.meshInstances.length;s++)this._shapeMap.set(t.meshInstances[s],t)}}enableShape(e,t){this._shapes.hasOwnProperty(e)&&(this._shapes[e].disabled=!t)}isShapeEnabled(e){return!!this._shapes.hasOwnProperty(e)&&!this._shapes[e].disabled}destroy(){for(var e in super.destroy(),this._shapes)this._shapes[e].destroy()}constructor(e,t){super(e,t),this._colorAlpha=.6,this._meshColors={axis:{x:this._colorSemi(Ev),y:this._colorSemi(kv),z:this._colorSemi(Mv),xyz:this._colorSemi(mt.WHITE),f:this._colorSemi(mt.WHITE)},hover:{x:Ev.clone(),y:kv.clone(),z:Mv.clone(),xyz:mt.WHITE.clone(),f:Iv.clone()},disabled:Dv.clone()},this._guideColors={x:Ev.clone(),y:kv.clone(),z:Mv.clone(),f:Iv.clone()},this._rootStartPos=new yt,this._rootStartRot=new kt,this._shading=!1,this._shapes={},this._shapeMap=new Map,this._hoverShape=null,this._hoverAxis="",this._hoverIsPlane=!1,this._noSelection=!1,this._selectedAxis="",this._selectedIsPlane=!1,this._selectionStartPoint=new yt,this._dragging=!1,this._snap=!1,this.snapIncrement=1,this._app.on("prerender",(()=>{this.root.enabled&&this._drawGuideLines()})),this.on(Pv.EVENT_POINTERDOWN,((e,t,s)=>{var i=this._shapeMap.get(s);if(!(null==i?void 0:i.disabled)&&!this._dragging)if(s){this._selectedAxis=this._getAxis(s),this._selectedIsPlane=this._getIsPlane(s),this._rootStartPos.copy(this.root.getPosition()),this._rootStartRot.copy(this.root.getRotation());var n=this._screenToPoint(e,t);this._selectionStartPoint.copy(n),this._dragging=!0,this.fire(Vv.EVENT_TRANSFORMSTART,n,e,t)}else this._noSelection=!0})),this.on(Pv.EVENT_POINTERMOVE,((e,t,s)=>{var i=this._shapeMap.get(s);if(!(null==i?void 0:i.disabled)&&(this._noSelection||this._hover(s),this._dragging)){var n=this._screenToPoint(e,t);this.fire(Vv.EVENT_TRANSFORMMOVE,n,e,t),this._hoverAxis="",this._hoverIsPlane=!1}})),this.on(Pv.EVENT_POINTERUP,((e,t,s)=>{this._noSelection=!1,this._hover(s),this._dragging&&(this._dragging=!1,this.fire(Vv.EVENT_TRANSFORMEND),this._selectedAxis="",this._selectedIsPlane=!1)})),this.on(Pv.EVENT_NODESDETACH,(()=>{this.snap=!1,this._hoverAxis="",this._hoverIsPlane=!1,this._hover(),this.fire(Pv.EVENT_POINTERUP)}))}}Vv.EVENT_TRANSFORMSTART="transform:start",Vv.EVENT_TRANSFORMMOVE="transform:move",Vv.EVENT_TRANSFORMEND="transform:end";var Nv=new yt,Uv=new yt,Hv=new yt;class Gv{get transform(){return this._transform}get priority(){return this._priority}setTransform(e,t,s){void 0===e&&(e=new yt),void 0===t&&(t=new kt),void 0===s&&(s=new yt),this.transform.setTRS(e,t,s)}fromGeometry(e){if(!(e&&e instanceof Kc))throw new Error("No geometry provided.");var t,s,i=null!=(t=e.positions)?t:[],n=null!=(s=e.indices)?s:[];this.tris=[];for(var a=0;a<n.length;a+=3){var r=n[a],o=n[a+1],l=n[a+2];Nv.set(i[3*r],i[3*r+1],i[3*r+2]),Uv.set(i[3*o],i[3*o+1],i[3*o+2]),Hv.set(i[3*l],i[3*l+1],i[3*l+2]);var h=new Yt(Nv,Uv,Hv);this.tris.push(h)}}constructor(e,t=0){this._priority=0,this._transform=new Et,this.tris=[],this.fromGeometry(e),this._priority=t}}var Wv=new yt(1,2,3),jv={box:Jc,cone:xu,cylinder:wu,plane:bu,sphere:Qc,torus:Cu},qv={uniqueName:"axis-shape",attributes:{vertex_position:ms,vertex_color:ys},vertexCode:"\n\t\tattribute vec3 vertex_position;\n\t\tattribute vec4 vertex_color;\n\t\tvarying vec4 vColor;\n\t\tuniform mat4 matrix_model;\n\t\tuniform mat4 matrix_viewProjection;\n\t\tvoid main(void) {\n\t\t\tgl_Position = matrix_viewProjection * matrix_model * vec4(vertex_position, 1.0);\n\t\t\tgl_Position.z = clamp(gl_Position.z, -abs(gl_Position.w), abs(gl_Position.w));\n\t\t\tvColor = vertex_color;\n\t\t}\n\t",fragmentCode:'\n\t\t#include "gammaPS"\n\t\tprecision highp float;\n\t\tvarying vec4 vColor;\n\t\tvoid main(void) {\n\t\t\tgl_FragColor = vec4(gammaCorrectOutput(decodeGamma(vColor)), vColor.w);\n\t\t}\n\t'},Xv=new Map,Yv=new yt,$v=new yt,Kv=new Et,Zv=new Kc;Zv.positions=[],Zv.normals=[];var Jv=(e,t,s)=>{if(!e.normals||!e.positions)return[];var i;s&&(i=Kv.copy(s).invert().transformVector(Yv.copy(Wv),Yv).normalize()),e.colors=[];for(var n=[],a=e.positions.length/3,r=0;r<a;r++){var o=1;if(i){var l=e.normals[3*r],h=e.normals[3*r+1],c=e.normals[3*r+2],d=$v.set(l,h,c);o=.25*i.dot(d)+.75}n.push(o),e.colors.push(o*t.r*255,o*t.g*255,o*t.b*255,255*t.a)}return n},Qv=(e,t)=>{for(var s=Xv.get(e),i=[],n=0;n<s.length;n++)i.push(s[n]*t.r*255,s[n]*t.g*255,s[n]*t.b*255,255*t.a);e.setColors32(i),e.update()};class e_{set disabled(e){for(var t=0;t<this.meshInstances.length;t++)Qv(this.meshInstances[t].mesh,e?this._disabledColor:this._defaultColor);this._disabled=null!=e&&e}get disabled(){return this._disabled}set shading(e){this._shading=null==e||e;for(var t=this._disabled?this._disabledColor:this._defaultColor,s=0;s<this.meshInstances.length;s++){var i=this.meshInstances[s].mesh;i.getPositions(Zv.positions),i.getNormals(Zv.normals);var n=Jv(Zv,t,this._shading?this.entity.getWorldTransform():void 0);Xv.set(i,n),Qv(i,t)}}get shading(){return this._shading}_createRoot(e){this.entity=new Ep(e+":"+this.axis),this.entity.setLocalPosition(this._position),this.entity.setLocalEulerAngles(this._rotation),this.entity.setLocalScale(this._scale)}_createMesh(e,t){void 0===t&&(t=!0);var s=this._disabled?this._disabledColor:this._defaultColor,i=Jv(e,s,t?this.entity.getWorldTransform():void 0),n=Wo.fromGeometry(this.device,e);return Xv.set(n,i),n}_createRenderComponent(e,t){var s=new Wc(qv);s.cull=this._cull,s.blendType=2,s.update();for(var i=[],n=0;n<t.length;n++){var a=new sl(t[n],s);a.cull=!1,i.push(a),this.meshInstances.push(a)}e.addComponent("render",{meshInstances:i,layers:this._layers,castShadows:!1})}_addRenderMesh(e,t,s){var i=jv[t];if(!i)throw new Error("Invalid primitive type.");this._createRenderComponent(e,[this._createMesh(new i,s)])}hover(e){if(!this._disabled)for(var t=0;t<this.meshInstances.length;t++){var s=e?this._hoverColor:this._defaultColor,i=this.meshInstances[t].mesh;Qv(i,s)}}destroy(){this.entity.destroy()}constructor(e,t){var s,i,n,a,r,o,l;this._layers=[],this._shading=!0,this._defaultColor=mt.WHITE,this._hoverColor=mt.BLACK,this._disabledColor=Dv,this._cull=1,this.triData=[],this.meshInstances=[],this.device=e,this.axis=null!=(s=t.axis)?s:"x",this._position=null!=(i=t.position)?i:new yt,this._rotation=null!=(n=t.rotation)?n:new yt,this._scale=null!=(a=t.scale)?a:new yt(1,1,1),this._disabled=null!=(r=t.disabled)&&r,this._layers=null!=(o=t.layers)?o:this._layers,this._shading=null!=(l=t.shading)?l:this._shading,t.defaultColor instanceof mt&&(this._defaultColor=t.defaultColor),t.hoverColor instanceof mt&&(this._hoverColor=t.hoverColor),t.disabledColor instanceof mt&&(this._disabledColor=t.disabledColor)}}class t_ extends e_{set size(e){this._size=null!=e?e:1,this._updateTransform()}get size(){return this._size}set gap(e){this._gap=null!=e?e:0,this._updateTransform()}get gap(){return this._gap}set flipped(e){this._flipped.distance(e)<1e-6||(this._flipped.copy(e),this.entity.setLocalPosition(this._getPosition()))}get flipped(){return this._flipped}_getPosition(){var e=this._size/2+this._gap,t=new yt(this._flipped.x?-e:e,this._flipped.y?-e:e,this._flipped.z?-e:e);return t[this.axis]=0,t}_createPlane(){this._createRoot("plane"),this._updateTransform(),this._addRenderMesh(this.entity,"plane",this._shading)}_updateTransform(){this.entity.setLocalPosition(this._getPosition()),this.entity.setLocalEulerAngles(this._rotation),this.entity.setLocalScale(this._size,this._size,this._size)}constructor(e,t={}){super(e,t),this._cull=0,this._size=.2,this._gap=.1,this._flipped=new yt,this.triData=[new Gv(new bu)],this._createPlane()}}var s_=new yt,i_=new yt,n_=new kt;class a_ extends e_{set gap(e){this._gap=null!=e?e:0,this._updateHead(),this._updateLine()}get gap(){return this._gap}set lineThickness(e){this._lineThickness=null!=e?e:1,this._updateHead(),this._updateLine()}get lineThickness(){return this._lineThickness}set lineLength(e){this._lineLength=null!=e?e:1,this._updateHead(),this._updateLine()}get lineLength(){return this._lineLength}set arrowThickness(e){this._arrowThickness=null!=e?e:1,this._updateHead()}get arrowThickness(){return this._arrowThickness}set arrowLength(e){this._arrowLength=null!=e?e:1,this._updateHead()}get arrowLength(){return this._arrowLength}set tolerance(e){this._tolerance=e,this._updateLine()}get tolerance(){return this._tolerance}set flipped(e){this._flipped!==e&&(this._flipped=e,this._rotation.equals(yt.ZERO)?s_.set(0,0,this._flipped?180:0):s_.copy(this._rotation).mulScalar(this._flipped?-1:1),this._line.enabled=!this._flipped,this.entity.setLocalEulerAngles(s_))}get flipped(){return this._flipped}_createArrow(){this._createRoot("arrow"),this._head=new Ep("head:"+this.axis),this.entity.addChild(this._head),this._updateHead(),this._addRenderMesh(this._head,"cone",this._shading),this._line=new Ep("line:"+this.axis),this.entity.addChild(this._line),this._updateLine(),this._addRenderMesh(this._line,"cylinder",this._shading)}_updateHead(){s_.set(0,this._gap+.5*this._arrowLength+this._lineLength,0),n_.set(0,0,0,1),i_.set(this._arrowThickness,this._arrowLength,this._arrowThickness),this.triData[0].setTransform(s_,n_,i_),this._head.setLocalPosition(0,this._gap+.5*this._arrowLength+this._lineLength,0),this._head.setLocalScale(this._arrowThickness,this._arrowLength,this._arrowThickness)}_updateLine(){s_.set(0,this._gap+.5*this._lineLength,0),n_.set(0,0,0,1),i_.set(this._lineThickness+this._tolerance,this._lineLength,this._lineThickness+this._tolerance),this.triData[1].setTransform(s_,n_,i_),this._line.setLocalPosition(0,this._gap+.5*this._lineLength,0),this._line.setLocalScale(this._lineThickness,this._lineLength,this._lineThickness)}constructor(e,t={}){super(e,t),this._gap=0,this._lineThickness=.02,this._lineLength=.5,this._arrowThickness=.12,this._arrowLength=.18,this._tolerance=.1,this._flipped=!1,this.triData=[new Gv(new xu),new Gv(new wu,1)],this._createArrow()}}let r_=class extends e_{_createCenter(){this._createRoot("sphereCenter"),this._updateTransform(),this._addRenderMesh(this.entity,"sphere",this._shading)}set size(e){this._size=null!=e?e:1,this._updateTransform()}get size(){return this._size}set tolerance(e){this._tolerance=e,this._updateTransform()}get tolerance(){return this._tolerance}_updateTransform(){this.entity.setLocalScale(this._size,this._size,this._size)}constructor(e,t={}){super(e,t),this._size=.12,this._tolerance=.05,this.triData=[new Gv(new Qc,2)],this._createCenter()}};var o_=new yt,l_=new yt,h_=new yt,c_=new kt,d_=.98;class u_ extends Vv{set axisGap(e){this._setArrowProp("gap",e)}get axisGap(){return this._shapes.x.gap}set axisLineThickness(e){this._setArrowProp("lineThickness",e)}get axisLineThickness(){return this._shapes.x.lineThickness}set axisLineLength(e){this._setArrowProp("lineLength",e)}get axisLineLength(){return this._shapes.x.lineLength}set axisLineTolerance(e){this._setArrowProp("tolerance",e)}get axisLineTolerance(){return this._shapes.x.tolerance}set axisArrowThickness(e){this._setArrowProp("arrowThickness",e)}get axisArrowThickness(){return this._shapes.x.arrowThickness}set axisArrowLength(e){this._setArrowProp("arrowLength",e)}get axisArrowLength(){return this._shapes.x.arrowLength}set axisPlaneSize(e){this._setPlaneProp("size",e)}get axisPlaneSize(){return this._shapes.yz.size}set axisPlaneGap(e){this._setPlaneProp("gap",e)}get axisPlaneGap(){return this._shapes.yz.gap}set axisCenterSize(e){this._shapes.face.size=e}get axisCenterSize(){return this._shapes.face.size}set axisCenterTolerance(e){this._shapes.face.tolerance=e}get axisCenterTolerance(){return this._shapes.face.tolerance}_setArrowProp(e,t){this._shapes.x[e]=t,this._shapes.y[e]=t,this._shapes.z[e]=t}_setPlaneProp(e,t){this._shapes.yz[e]=t,this._shapes.xz[e]=t,this._shapes.xy[e]=t}_shapesLookAtCamera(){var e=this.facing,t=e.dot(this.root.right);this._shapes.x.entity.enabled=Math.abs(t)<d_,this.flipShapes&&(this._shapes.x.flipped=t<0),t=e.dot(this.root.up),this._shapes.y.entity.enabled=Math.abs(t)<d_,this.flipShapes&&(this._shapes.y.flipped=t<0),t=e.dot(this.root.forward),this._shapes.z.entity.enabled=Math.abs(t)<d_,this.flipShapes&&(this._shapes.z.flipped=t>0),o_.cross(e,this.root.right),this._shapes.yz.entity.enabled=o_.length()<d_,this.flipShapes&&(this._shapes.yz.flipped=l_.set(0,+(o_.dot(this.root.forward)<0),+(o_.dot(this.root.up)<0))),o_.cross(e,this.root.forward),this._shapes.xy.entity.enabled=o_.length()<d_,this.flipShapes&&(this._shapes.xy.flipped=l_.set(+(o_.dot(this.root.up)<0),+(o_.dot(this.root.right)>0),0)),o_.cross(e,this.root.up),this._shapes.xz.entity.enabled=o_.length()<d_,this.flipShapes&&(this._shapes.xz.flipped=l_.set(+(o_.dot(this.root.forward)>0),0,+(o_.dot(this.root.right)>0)))}_storeNodePositions(){for(var e=0;e<this.nodes.length;e++){var t=this.nodes[e];this._nodeLocalPositions.set(t,t.getLocalPosition().clone()),this._nodePositions.set(t,t.getPosition().clone())}}_setNodePositions(e){for(var t=0;t<this.nodes.length;t++){var s=this.nodes[t];if(this._coordSpace===mv){var i,n=this._nodeLocalPositions.get(s);if(!n)continue;o_.copy(e),null==(i=s.parent)||i.getWorldTransform().getScale(l_),l_.x=1/l_.x,l_.y=1/l_.y,l_.z=1/l_.z,c_.copy(s.getLocalRotation()).transformVector(o_,o_),o_.mul(l_),s.setLocalPosition(o_.add(n))}else{var a=this._nodePositions.get(s);if(!a)continue;s.setPosition(o_.copy(e).add(a))}}this._updatePosition()}_screenToPoint(e,t){var s=this._camera.screenToWorld(e,t,1),i=this._selectedAxis,n=this._selectedIsPlane,a=this._createRay(s),r=this._createPlane(i,i===xv,!n),o=new yt;return r.intersectsRay(a,o),c_.copy(this._rootStartRot).invert().transformVector(o,o),n||i===xv||this._projectToAxis(o,i),o}constructor(e,t){super(e,t),this._shapes={face:new r_(this._device,{axis:xv,layers:[this._layer.id],shading:this._shading,defaultColor:this._meshColors.axis.xyz,hoverColor:this._meshColors.hover.xyz}),yz:new t_(this._device,{axis:gv,layers:[this._layer.id],shading:this._shading,rotation:new yt(0,0,-90),defaultColor:this._meshColors.axis.x,hoverColor:this._meshColors.hover.x}),xz:new t_(this._device,{axis:vv,layers:[this._layer.id],shading:this._shading,rotation:new yt(0,0,0),defaultColor:this._meshColors.axis.y,hoverColor:this._meshColors.hover.y}),xy:new t_(this._device,{axis:_v,layers:[this._layer.id],shading:this._shading,rotation:new yt(90,0,0),defaultColor:this._meshColors.axis.z,hoverColor:this._meshColors.hover.z}),x:new a_(this._device,{axis:gv,layers:[this._layer.id],shading:this._shading,rotation:new yt(0,0,-90),defaultColor:this._meshColors.axis.x,hoverColor:this._meshColors.hover.x}),y:new a_(this._device,{axis:vv,layers:[this._layer.id],shading:this._shading,rotation:new yt(0,0,0),defaultColor:this._meshColors.axis.y,hoverColor:this._meshColors.hover.y}),z:new a_(this._device,{axis:_v,layers:[this._layer.id],shading:this._shading,rotation:new yt(90,0,0),defaultColor:this._meshColors.axis.z,hoverColor:this._meshColors.hover.z})},this._nodeLocalPositions=new Map,this._nodePositions=new Map,this.snapIncrement=1,this.flipShapes=!0,this._createTransform(),this.on(Vv.EVENT_TRANSFORMSTART,(()=>{this._storeNodePositions()})),this.on(Vv.EVENT_TRANSFORMMOVE,(e=>{var t=h_.copy(e).sub(this._selectionStartPoint);this.snap&&(t.mulScalar(1/this.snapIncrement),t.round(),t.mulScalar(this.snapIncrement)),this._setNodePositions(t)})),this.on(Vv.EVENT_NODESDETACH,(()=>{this._nodeLocalPositions.clear(),this._nodePositions.clear()})),this._app.on("prerender",(()=>{this._shapesLookAtCamera()}))}}class p_ extends e_{_createTorusGeometry(){return new Cu({tubeRadius:this._tubeRadius+this._tolerance,ringRadius:this._ringRadius,sectorAngle:this._sectorAngle,segments:20})}_createTorusMesh(e){var t=new Cu({tubeRadius:this._tubeRadius,ringRadius:this._ringRadius,sectorAngle:e,segments:80});return this._createMesh(t,this._shading)}_createDisk(){this._createRoot("disk"),this._createRenderComponent(this.entity,[this._createTorusMesh(this._sectorAngle),this._createTorusMesh(360)]),this.drag(!1)}set tubeRadius(e){this._tubeRadius=null!=e?e:.1,this._updateTransform()}get tubeRadius(){return this._tubeRadius}set ringRadius(e){this._ringRadius=null!=e?e:.1,this._updateTransform()}get ringRadius(){return this._ringRadius}set tolerance(e){this._tolerance=e,this._updateTransform()}get tolerance(){return this._tolerance}_updateTransform(){this.triData[0].fromGeometry(this._createTorusGeometry()),this.meshInstances[0].mesh=this._createTorusMesh(this._sectorAngle),this.meshInstances[1].mesh=this._createTorusMesh(360)}drag(e){this.meshInstances[0].visible=!e,this.meshInstances[1].visible=e}hide(e){if(e)return this.meshInstances[0].visible=!1,void(this.meshInstances[1].visible=!1);this.drag(!1)}constructor(e,t={}){var s,i,n;super(e,t),this._tubeRadius=.01,this._ringRadius=.5,this._tolerance=.05,this._tubeRadius=null!=(s=t.tubeRadius)?s:this._tubeRadius,this._ringRadius=null!=(i=t.ringRadius)?i:this._ringRadius,this._sectorAngle=null!=(n=t.sectorAngle)?n:this._sectorAngle,this.triData=[new Gv(this._createTorusGeometry())],this._createDisk()}}var m_=new yt,f_=new yt,g_=new yt,v_=new yt,__=new Et,y_=new kt,x_=new kt,w_=new mt(0,0,0,.3);class b_ extends Vv{set xyzTubeRadius(e){this._setDiskProp("tubeRadius",e)}get xyzTubeRadius(){return this._shapes.x.tubeRadius}set xyzRingRadius(e){this._setDiskProp("ringRadius",e)}get xyzRingRadius(){return this._shapes.x.ringRadius}set faceTubeRadius(e){this._shapes.face.tubeRadius=e}get faceTubeRadius(){return this._shapes.face.tubeRadius}set faceRingRadius(e){this._shapes.face.ringRadius=e}get faceRingRadius(){return this._shapes.face.ringRadius}set ringTolerance(e){this._setDiskProp("tolerance",e),this._shapes.face.tolerance=e}get ringTolerance(){return this._shapes.x.tolerance}_setDiskProp(e,t){this._shapes.x[e]=t,this._shapes.y[e]=t,this._shapes.z[e]=t}_storeGuidePoints(){var e=this.root.getPosition(),t=this._selectedAxis===xv?this.faceRingRadius:this.xyzRingRadius;this._guideAngleStart.copy(this._selectionStartPoint).sub(e).normalize(),this._guideAngleStart.mulScalar(t),this._guideAngleEnd.copy(this._guideAngleStart)}_updateGuidePoints(e){var t=this._selectedAxis;t===xv?m_.copy(this.facing):(m_.set(0,0,0),m_[t]=1,this._rootStartRot.transformVector(m_,m_)),y_.setFromAxisAngle(m_,e),y_.transformVector(this._guideAngleStart,this._guideAngleEnd)}_drawGuideAngleLine(e,t,s,i){void 0===i&&(i=this._guideColors[t]),m_.set(0,0,0),f_.copy(s).mulScalar(this._scale),this._app.drawLine(m_.add(e),f_.add(e),i,!1,this._layer)}_getLookAtEulerAngles(e){return m_.set(0,0,0),__.setLookAt(m_,e,yt.UP),y_.setFromMat4(__),y_.getEulerAngles(m_),m_.x+=90,m_}_shapesLookAtCamera(){0===this._camera.projection?(this._shapes.face.entity.lookAt(this._camera.entity.getPosition()),this._shapes.face.entity.rotateLocal(90,0,0)):(y_.copy(this._camera.entity.getRotation()).getEulerAngles(m_),this._shapes.face.entity.setEulerAngles(m_),this._shapes.face.entity.rotateLocal(-90,0,0));var e=m_.copy(this.facing);y_.copy(this.root.getRotation()).invert().transformVector(e,e);var t=Math.atan2(e.z,e.y)*pt.RAD_TO_DEG;this._shapes.x.entity.setLocalEulerAngles(0,t-90,-90),t=Math.atan2(e.x,e.z)*pt.RAD_TO_DEG,this._shapes.y.entity.setLocalEulerAngles(0,t,0),t=Math.atan2(e.y,e.x)*pt.RAD_TO_DEG,this._shapes.z.entity.setLocalEulerAngles(90,0,t+90)}_drag(e){for(var t in this._shapes){var s=this._shapes[t];t===this._selectedAxis?s.drag(e):s.hide(e)}this.fire(Vv.EVENT_RENDERUPDATE)}_storeNodeRotations(){for(var e=this.root.getPosition(),t=0;t<this.nodes.length;t++){var s=this.nodes[t];this._nodeLocalRotations.set(s,s.getLocalRotation().clone()),this._nodeRotations.set(s,s.getRotation().clone()),this._nodeOffsets.set(s,s.getPosition().clone().sub(e))}}_setNodeRotations(e,t){var s=this.root.getPosition(),i=e===xv;y_.setFromAxisAngle(this._dirFromAxis(e,m_),t);for(var n=0;n<this.nodes.length;n++){var a=this.nodes[n];if(i||this._coordSpace!==mv){var r=this._nodeRotations.get(a);if(!r)continue;var o=this._nodeOffsets.get(a);if(!o)continue;m_.copy(o),y_.transformVector(m_,m_),x_.copy(y_).mul(r),a.setEulerAngles(x_.getEulerAngles()),a.setPosition(m_.add(s))}else{var l=this._nodeLocalRotations.get(a);if(!l)continue;x_.copy(l).mul(y_),a.setLocalRotation(x_)}}this._coordSpace===mv&&this._updateRotation()}_screenToPoint(e,t){var s=this._camera.screenToWorld(e,t,1),i=this._selectedAxis,n=this._createRay(s),a=this._createPlane(i,i===xv,!1),r=new yt;return a.intersectsRay(n,r),r}_calculateAngle(e,t,s){var i=this.root.getPosition(),n=this._selectedAxis,a=this._createPlane(n,n===xv,!1),r=0,o=f_.copy(this.facing),l=a.normal.dot(o);return this.orbitRotation||Math.abs(l)>.9?(m_.sub2(e,i),y_.copy(this._camera.entity.getRotation()).invert().transformVector(m_,m_),r=Math.sign(l)*Math.atan2(m_.y,m_.x)*pt.RAD_TO_DEG):(m_.copy(i),f_.cross(a.normal,o).normalize().add(i),this._camera.worldToScreen(m_,g_),this._camera.worldToScreen(f_,v_),m_.sub2(v_,g_).normalize(),f_.set(t,s,0),r=m_.dot(f_)),r}constructor(e,t){super(e,t),this._shapes={z:new p_(this._device,{axis:_v,layers:[this._layer.id],shading:this._shading,rotation:new yt(90,0,90),defaultColor:this._meshColors.axis.z,hoverColor:this._meshColors.hover.z,sectorAngle:180}),x:new p_(this._device,{axis:gv,layers:[this._layer.id],shading:this._shading,rotation:new yt(0,0,-90),defaultColor:this._meshColors.axis.x,hoverColor:this._meshColors.hover.x,sectorAngle:180}),y:new p_(this._device,{axis:vv,layers:[this._layer.id],shading:this._shading,rotation:new yt(0,0,0),defaultColor:this._meshColors.axis.y,hoverColor:this._meshColors.hover.y,sectorAngle:180}),face:new p_(this._device,{axis:xv,layers:[this._layer.id],shading:this._shading,rotation:this._getLookAtEulerAngles(this._camera.entity.getPosition()),defaultColor:this._meshColors.axis.f,hoverColor:this._meshColors.hover.f,ringRadius:.55})},this._selectionStartAngle=0,this._nodeLocalRotations=new Map,this._nodeRotations=new Map,this._nodeOffsets=new Map,this._guideAngleStartColor=w_.clone(),this._guideAngleStart=new yt,this._guideAngleEnd=new yt,this.snapIncrement=5,this.orbitRotation=!1,this._createTransform(),this.on(Vv.EVENT_TRANSFORMSTART,((e,t,s)=>{this._selectionStartAngle=this._calculateAngle(e,t,s),this._storeNodeRotations(),this._storeGuidePoints(),this._drag(!0)})),this.on(Vv.EVENT_TRANSFORMMOVE,((e,t,s)=>{var i=this._selectedAxis,n=this._calculateAngle(e,t,s)-this._selectionStartAngle;this.snap&&(n=Math.round(n/this.snapIncrement)*this.snapIncrement),this._setNodeRotations(i,n),this._updateGuidePoints(n)})),this.on(Vv.EVENT_TRANSFORMEND,(()=>{this._drag(!1)})),this.on(Vv.EVENT_NODESDETACH,(()=>{this._nodeLocalRotations.clear(),this._nodeRotations.clear(),this._nodeOffsets.clear()})),this._app.on("prerender",(()=>{if(this._shapesLookAtCamera(),this._dragging){var e=this.root.getPosition();this._drawGuideAngleLine(e,this._selectedAxis,this._guideAngleStart,this._guideAngleStartColor),this._drawGuideAngleLine(e,this._selectedAxis,this._guideAngleEnd)}}))}}class C_ extends e_{_createCenter(){this._createRoot("boxCenter"),this._updateTransform(),this._addRenderMesh(this.entity,"box",this._shading)}set size(e){this._size=null!=e?e:1,this._updateTransform()}get size(){return this._size}set tolerance(e){this._tolerance=e,this._updateTransform()}get tolerance(){return this._tolerance}_updateTransform(){this.entity.setLocalScale(this._size,this._size,this._size)}constructor(e,t={}){super(e,t),this._size=.12,this._tolerance=.05,this.triData=[new Gv(new Jc,2)],this._createCenter()}}var S_=new yt,A_=new yt,T_=new kt;class P_ extends e_{set gap(e){this._gap=null!=e?e:0,this._updateLine(),this._updateBox()}get gap(){return this._gap}set lineThickness(e){this._lineThickness=null!=e?e:1,this._updateLine(),this._updateBox()}get lineThickness(){return this._lineThickness}set lineLength(e){this._lineLength=null!=e?e:1,this._updateLine(),this._updateBox()}get lineLength(){return this._lineLength}set boxSize(e){this._boxSize=null!=e?e:1,this._updateBox()}get boxSize(){return this._boxSize}set tolerance(e){this._tolerance=e,this._updateLine()}get tolerance(){return this._tolerance}set flipped(e){this._flipped!==e&&(this._flipped=e,this._rotation.equals(yt.ZERO)?S_.set(0,0,this._flipped?180:0):S_.copy(this._rotation).mulScalar(this._flipped?-1:1),this._line.enabled=!this._flipped,this.entity.setLocalEulerAngles(S_))}get flipped(){return this._flipped}_createBoxLine(){this._createRoot("boxLine"),this._box=new Ep("box:"+this.axis),this.entity.addChild(this._box),this._updateBox(),this._addRenderMesh(this._box,"box",this._shading),this._line=new Ep("line:"+this.axis),this.entity.addChild(this._line),this._updateLine(),this._addRenderMesh(this._line,"cylinder",this._shading)}_updateBox(){S_.set(0,this._gap+.5*this._boxSize+this._lineLength,0),T_.set(0,0,0,1),A_.set(this._boxSize,this._boxSize,this._boxSize),this.triData[0].setTransform(S_,T_,A_),this._box.setLocalPosition(0,this._gap+.5*this._boxSize+this._lineLength,0),this._box.setLocalScale(this._boxSize,this._boxSize,this._boxSize)}_updateLine(){S_.set(0,this._gap+.5*this._lineLength,0),T_.set(0,0,0,1),A_.set(this._lineThickness+this._tolerance,this._lineLength,this._lineThickness+this._tolerance),this.triData[1].setTransform(S_,T_,A_),this._line.setLocalPosition(0,this._gap+.5*this._lineLength,0),this._line.setLocalScale(this._lineThickness,this._lineLength,this._lineThickness)}constructor(e,t={}){super(e,t),this._gap=0,this._lineThickness=.02,this._lineLength=.5,this._boxSize=.12,this._tolerance=.1,this._flipped=!1,this.triData=[new Gv(new Jc),new Gv(new wu,1)],this._createBoxLine()}}var E_=new yt,k_=new yt,M_=new yt,I_=new kt,D_=.98;class R_ extends Vv{set coordSpace(e){}get coordSpace(){return this._coordSpace}set uniform(e){this._useUniformScaling=null==e||e}get uniform(){return this._useUniformScaling}set axisGap(e){this._setArrowProp("gap",e)}get axisGap(){return this._shapes.x.gap}set axisLineThickness(e){this._setArrowProp("lineThickness",e)}get axisLineThickness(){return this._shapes.x.lineThickness}set axisLineLength(e){this._setArrowProp("lineLength",e)}get axisLineLength(){return this._shapes.x.lineLength}set axisLineTolerance(e){this._setArrowProp("tolerance",e)}get axisLineTolerance(){return this._shapes.x.tolerance}set axisBoxSize(e){this._setArrowProp("boxSize",e)}get axisBoxSize(){return this._shapes.x.boxSize}set axisPlaneSize(e){this._setPlaneProp("size",e)}get axisPlaneSize(){return this._shapes.yz.size}set axisPlaneGap(e){this._setPlaneProp("gap",e)}get axisPlaneGap(){return this._shapes.yz.gap}set axisCenterSize(e){this._shapes.xyz.size=e}get axisCenterSize(){return this._shapes.xyz.size}set axisCenterTolerance(e){this._shapes.xyz.tolerance=e}get axisCenterTolerance(){return this._shapes.xyz.tolerance}_setArrowProp(e,t){this._shapes.x[e]=t,this._shapes.y[e]=t,this._shapes.z[e]=t}_setPlaneProp(e,t){this._shapes.yz[e]=t,this._shapes.xz[e]=t,this._shapes.xy[e]=t}_shapesLookAtCamera(){var e=this.facing,t=e.dot(this.root.right);this._shapes.x.entity.enabled=Math.abs(t)<D_,this.flipShapes&&(this._shapes.x.flipped=t<0),t=e.dot(this.root.up),this._shapes.y.entity.enabled=Math.abs(t)<D_,this.flipShapes&&(this._shapes.y.flipped=t<0),t=e.dot(this.root.forward),this._shapes.z.entity.enabled=Math.abs(t)<D_,this.flipShapes&&(this._shapes.z.flipped=t>0),E_.cross(e,this.root.right),this._shapes.yz.entity.enabled=E_.length()<D_,this.flipShapes&&(this._shapes.yz.flipped=k_.set(0,+(E_.dot(this.root.forward)<0),+(E_.dot(this.root.up)<0))),E_.cross(e,this.root.forward),this._shapes.xy.entity.enabled=E_.length()<D_,this.flipShapes&&(this._shapes.xy.flipped=k_.set(+(E_.dot(this.root.up)<0),+(E_.dot(this.root.right)>0),0)),E_.cross(e,this.root.up),this._shapes.xz.entity.enabled=E_.length()<D_,this.flipShapes&&(this._shapes.xz.flipped=k_.set(+(E_.dot(this.root.forward)>0),0,+(E_.dot(this.root.right)>0)))}_storeNodeScales(){for(var e=0;e<this.nodes.length;e++){var t=this.nodes[e];this._nodeScales.set(t,t.getLocalScale().clone())}}_setNodeScales(e){for(var t=0;t<this.nodes.length;t++){var s=this.nodes[t],i=this._nodeScales.get(s);i&&s.setLocalScale(E_.copy(i).mul(e).max(this.lowerBoundScale))}}_screenToPoint(e,t){var s=this.root.getPosition(),i=this._camera.screenToWorld(e,t,1),n=this._selectedAxis,a=this._selectedIsPlane,r=this._useUniformScaling&&a||n===yv,o=this._createRay(i),l=this._createPlane(n,r,!a),h=new yt;if(l.intersectsRay(o,h),r){switch(n){case gv:E_.copy(this.root.up),k_.copy(this.root.forward).mulScalar(-1);break;case vv:E_.copy(this.root.right),k_.copy(this.root.forward).mulScalar(-1);break;case _v:E_.copy(this.root.up),k_.copy(this.root.right);break;default:E_.copy(this._camera.entity.up),k_.copy(this._camera.entity.right)}k_.add(E_).normalize(),E_.sub2(h,s);var c=E_.length()*E_.normalize().dot(k_);return h.set(c,c,c),n!==yv&&(h[n]=1),h}return I_.copy(this._rootStartRot).invert().transformVector(h,h),a||this._projectToAxis(h,n),h}constructor(e,t){super(e,t),this._shapes={xyz:new C_(this._device,{axis:yv,layers:[this._layer.id],shading:this._shading,defaultColor:this._meshColors.axis.xyz,hoverColor:this._meshColors.hover.xyz}),yz:new t_(this._device,{axis:gv,layers:[this._layer.id],shading:this._shading,rotation:new yt(0,0,-90),defaultColor:this._meshColors.axis.x,hoverColor:this._meshColors.hover.x}),xz:new t_(this._device,{axis:vv,layers:[this._layer.id],shading:this._shading,rotation:new yt(0,0,0),defaultColor:this._meshColors.axis.y,hoverColor:this._meshColors.hover.y}),xy:new t_(this._device,{axis:_v,layers:[this._layer.id],shading:this._shading,rotation:new yt(90,0,0),defaultColor:this._meshColors.axis.z,hoverColor:this._meshColors.hover.z}),x:new P_(this._device,{axis:gv,layers:[this._layer.id],shading:this._shading,rotation:new yt(0,0,-90),defaultColor:this._meshColors.axis.x,hoverColor:this._meshColors.hover.x}),y:new P_(this._device,{axis:vv,layers:[this._layer.id],shading:this._shading,rotation:new yt(0,0,0),defaultColor:this._meshColors.axis.y,hoverColor:this._meshColors.hover.y}),z:new P_(this._device,{axis:_v,layers:[this._layer.id],shading:this._shading,rotation:new yt(90,0,0),defaultColor:this._meshColors.axis.z,hoverColor:this._meshColors.hover.z})},this._coordSpace=mv,this._nodeScales=new Map,this._useUniformScaling=!1,this.snapIncrement=1,this.flipShapes=!0,this.lowerBoundScale=new yt(-1/0,-1/0,-1/0),this._createTransform(),this.on(Vv.EVENT_TRANSFORMSTART,(()=>{this._storeNodeScales()})),this.on(Vv.EVENT_TRANSFORMMOVE,(e=>{var t=M_.copy(e).sub(this._selectionStartPoint);this.snap&&(t.mulScalar(1/this.snapIncrement),t.round(),t.mulScalar(this.snapIncrement)),t.mulScalar(1/this._scale),this._setNodeScales(t.add(yt.ONE))})),this.on(Vv.EVENT_NODESDETACH,(()=>{this._nodeScales.clear()})),this._app.on("prerender",(()=>{this._shapesLookAtCamera()}))}}class L_{times;knots;dim;constructor(e,t){this.times=e,this.knots=t,this.dim=t.length/e.length/3}evaluate(e,t){const{times:s}=this,i=s.length-1;if(e<=s[0])this.getKnot(0,t);else{if(!(e>=s[i])){let i=0;for(;e>=s[i+1];)i++;return this.evaluateSegment(i,(e-s[i])/(s[i+1]-s[i]),t)}this.getKnot(i,t)}}getKnot(e,t){const{knots:s,dim:i}=this,n=3*e*i;for(let e=0;e<i;++e)t[e]=s[n+3*e+1]}evaluateSegment(e,t,s){const{knots:i,dim:n}=this,a=t*t,r=t+t,o=1-t,l=o*o;let h=e*n*3;for(let e=0;e<n;++e){const o=i[h+1],c=i[h+2],d=i[h+3*n],u=i[h+3*n+1];h+=3,s[e]=o*((1+r)*l)+c*(t*l)+u*(a*(3-r))+d*(a*(t-1))}}static fromPoints(e,t,s=0){const i=t.length/e.length,n=new Array(e.length*i*3);for(let a=0;a<e.length;a++){const r=e[a];for(let o=0;o<i;o++){const l=a*i+o,h=t[l];let c;c=0===a?(t[l+i]-h)/(e[a+1]-r):a===e.length-1?(h-t[l-i])/(r-e[a-1]):.5*((t[l+i]-h)/(e[a+1]-r)+(h-t[l-i])/(r-e[a-1])),c*=1-s,n[3*l]=c,n[3*l+1]=h,n[3*l+2]=c}}return new L_(e,n)}static fromPointsLooping(e,t,s,i=0){if(t.length<2)return L_.fromPoints(t,s,i);const n=s.length/t.length,a=t.slice(),r=s.slice();return a.push(e+t[0],e+t[1]),r.push(...s.slice(0,2*n)),a.splice(0,0,t[t.length-2]-e,t[t.length-1]-e),r.splice(0,0,...s.slice(s.length-2*n)),L_.fromPoints(a,r,i)}}const F_=e=>{const t=[];let s;const i=()=>{const i=t.slice().sort(((e,t)=>e.frame-t.frame)),n=i.map((e=>e.frame)),a=[];for(let e=0;e<i.length;++e){const t=i[e];a.push(t.position.x,t.position.y,t.position.z),a.push(t.target.x,t.target.y,t.target.z)}if(i.length>1){const t=e.invoke("timeline.frames"),i=L_.fromPointsLooping(t,n,a,-1),r=[],o={position:new yt,target:new yt};s=t=>{const s=t;i.evaluate(s,r),o.position.set(r[0],r[1],r[2]),o.target.set(r[3],r[4],r[5]),e.fire("camera.setPose",o,0)}}else s=null};e.on("timeline.time",(e=>{s?.(e)})),e.on("timeline.frame",(e=>{s?.(e)}));const n=s=>{if(void 0===s.frame)return!1;const n=t.findIndex((e=>e.frame===s.frame));-1!==n?t[n]=s:(t.push(s),e.fire("timeline.addKey",s.frame)),i()};e.function("camera.poses",(()=>t)),e.on("camera.addPose",(e=>{n(e)})),e.on("timeline.add",(s=>{const i=e.invoke("camera.getPose");n({name:`camera_${t.length}`,frame:s,position:i.position,target:i.target})})),e.on("timeline.remove",(s=>{(s=>{t.splice(s,1),i(),e.fire("timeline.removeKey",s)})(s)})),e.on("timeline.frames",(()=>{i()})),e.function("docSerialize.poseSets",(()=>{const e=e=>[e.x,e.y,e.z];return 0===t.length?[]:[{name:"set0",poses:t.map((t=>({name:t.name,frame:t.frame,position:e(t.position),target:e(t.target)})))}]})),e.function("docDeserialize.poseSets",(t=>{if(0===t.length)return;const s=e.invoke("timeline.frameRate");t[0].poses.forEach(((e,t)=>{n({name:e.name,frame:e.frame??t*s,position:new yt(e.position),target:new yt(e.target)})}))}))};class B_{write;close;constructor(e){let t=0;e.seek(0),this.write=async(s,i)=>{t+=s.byteLength,await e.write(s)},this.close=async()=>{await e.truncate(t),await e.close()}}}class O_{write;close;constructor(){let e,t=0;this.write=(s,i)=>{if(e){if(e.byteLength<t+s.byteLength){let i=2*e.byteLength;for(;i<t+s.byteLength;)i*=2;const n=new Uint8Array(i);n.set(e),e=n}e.set(s,t),t+=s.byteLength}else e=i?s:s.slice(),t=s.byteLength},this.close=()=>t===e.buffer.byteLength?e:new Uint8Array(e.buffer,0,t)}}class z_{write;close;constructor(e){const t=new O_;this.write=(e,s)=>{t.write(e,s)},this.close=()=>{const s=t.close(),i=new Blob([s],{type:"octet/stream"}),n=window.URL.createObjectURL(i),a=document.createElement("a");if(a.download=e,a.href=n,document.createEvent){const e=document.createEvent("MouseEvents");e.initMouseEvent("click",!0,!0,window,0,0,0,0,0,!1,!1,!1,!1,0,null),a.dispatchEvent(e)}else a.fireEvent?.("onclick");window.URL.revokeObjectURL(n)}}}class V_{write;close;constructor(e){const t=new CompressionStream("gzip"),s=t.writable.getWriter(),i=t.readable.getReader(),n=(async()=>{for(;;){const{done:t,value:s}=await i.read();if(t)break;await e.write(s)}})();this.write=async(e,t)=>{await s.write(e)},this.close=async()=>{await s.close(),await n}}}const N_=(()=>{const e=[];let t;for(let s=0;s<256;s++){t=s;for(let e=0;e<8;e++)t=1&t?3988292384^t>>>1:t>>>1;e[s]=t}return e})();class U_{reset;update;value;constructor(){let e=-1;this.update=t=>{for(let s=0;s<t.length;s++)e=e>>>8^N_[255&(e^t[s])]},this.value=()=>~e>>>0}}class H_{start;write;close;async file(e,t){await this.start(e),await this.write("string"==typeof t?(new TextEncoder).encode(t):t)}constructor(e){const t=new TextEncoder,s=[],i=async()=>{const t=s[s.length-1],{crc:i,sizeBytes:n}=t,a=new Uint8Array(16),r=new DataView(a.buffer);r.setUint32(0,134695760,!0),r.setUint32(4,i.value(),!0),r.setUint32(8,n,!0),r.setUint32(12,n,!0),await e.write(a)};this.start=async n=>{s.length>0&&await i(),await(async i=>{const n=new Uint8Array(30+i.length),a=new DataView(n.buffer),r=t.encode(i);a.setUint32(0,67324752,!0),a.setUint16(6,8,!0),a.setUint16(26,i.length,!0),n.set(r,30),await e.write(n),s.push({filename:r,crc:new U_,sizeBytes:0})})(n)},this.write=async(t,i)=>{const n=s[s.length-1];n.sizeBytes+=t.length,n.crc.update(t),await e.write(t,i)},this.close=async()=>{await i();let t=0;for(let i=0;i<s.length;i++){const n=s[i],{filename:a,crc:r,sizeBytes:o}=n,l=new Uint8Array(46+a.length),h=new DataView(l.buffer);h.setUint32(0,33639248,!0),h.setUint32(16,r.value(),!0),h.setUint32(20,o,!0),h.setUint32(24,o,!0),h.setUint16(28,a.length,!0),h.setUint32(42,t,!0),l.set(a,46),await e.write(l),t+=30+a.length+o+16}const n=s.reduce(((e,t)=>e+t.filename.length),0),a=s.reduce(((e,t)=>e+t.sizeBytes),0),r=new Uint8Array(22),o=new DataView(r.buffer);o.setUint32(0,101010256,!0),o.setUint16(8,s.length,!0),o.setUint16(10,s.length,!0),o.setUint32(12,n+46*s.length,!0),o.setUint32(16,n+46*s.length+a,!0),await e.write(r)}}}const G_=Math.sqrt(1.5),W_=Math.sqrt(1/3),j_=Math.sqrt(2/3),q_=Math.sqrt(4/3),X_=Math.sqrt(1/4),Y_=Math.sqrt(3/4),$_=Math.sqrt(.2),K_=Math.sqrt(.6),Z_=Math.sqrt(1.2),J_=Math.sqrt(1.6),Q_=Math.sqrt(1.8),ey=Math.sqrt(1/6),ty=Math.sqrt(5/6),sy=Math.sqrt(3/8),iy=Math.sqrt(5/8),ny=Math.sqrt(9/8),ay=Math.sqrt(5/9),ry=Math.sqrt(8/9),oy=Math.sqrt(.1),ly=Math.sqrt(.3),hy=Math.sqrt(1/12),cy=Math.sqrt(4/15),dy=Math.sqrt(1/16),uy=Math.sqrt(15/16),py=Math.sqrt(1/18),my=Math.sqrt(1/60),fy=(e,t,s,i)=>{let n=0;for(let a=0;a<e;a++)n+=s[t+a]*i[a];return n},gy=new Float32Array(15);class vy{apply;constructor(e){const t=e.data,s=[[t[4],-t[7],t[1]],[-t[5],t[8],-t[2]],[t[3],-t[6],t[0]]],i=[[X_*(s[2][2]*s[0][0]+s[2][0]*s[0][2]+(s[0][2]*s[2][0]+s[0][0]*s[2][2])),s[2][1]*s[0][0]+s[0][1]*s[2][0],Y_*(s[2][1]*s[0][1]+s[0][1]*s[2][1]),s[2][1]*s[0][2]+s[0][1]*s[2][2],X_*(s[2][2]*s[0][2]-s[2][0]*s[0][0]+(s[0][2]*s[2][2]-s[0][0]*s[2][0]))],[X_*(s[1][2]*s[0][0]+s[1][0]*s[0][2]+(s[0][2]*s[1][0]+s[0][0]*s[1][2])),s[1][1]*s[0][0]+s[0][1]*s[1][0],Y_*(s[1][1]*s[0][1]+s[0][1]*s[1][1]),s[1][1]*s[0][2]+s[0][1]*s[1][2],X_*(s[1][2]*s[0][2]-s[1][0]*s[0][0]+(s[0][2]*s[1][2]-s[0][0]*s[1][0]))],[W_*(s[1][2]*s[1][0]+s[1][0]*s[1][2])-hy*(s[2][2]*s[2][0]+s[2][0]*s[2][2]+(s[0][2]*s[0][0]+s[0][0]*s[0][2])),q_*s[1][1]*s[1][0]-W_*(s[2][1]*s[2][0]+s[0][1]*s[0][0]),s[1][1]*s[1][1]-X_*(s[2][1]*s[2][1]+s[0][1]*s[0][1]),q_*s[1][1]*s[1][2]-W_*(s[2][1]*s[2][2]+s[0][1]*s[0][2]),W_*(s[1][2]*s[1][2]-s[1][0]*s[1][0])-hy*(s[2][2]*s[2][2]-s[2][0]*s[2][0]+(s[0][2]*s[0][2]-s[0][0]*s[0][0]))],[X_*(s[1][2]*s[2][0]+s[1][0]*s[2][2]+(s[2][2]*s[1][0]+s[2][0]*s[1][2])),s[1][1]*s[2][0]+s[2][1]*s[1][0],Y_*(s[1][1]*s[2][1]+s[2][1]*s[1][1]),s[1][1]*s[2][2]+s[2][1]*s[1][2],X_*(s[1][2]*s[2][2]-s[1][0]*s[2][0]+(s[2][2]*s[1][2]-s[2][0]*s[1][0]))],[X_*(s[2][2]*s[2][0]+s[2][0]*s[2][2]-(s[0][2]*s[0][0]+s[0][0]*s[0][2])),s[2][1]*s[2][0]-s[0][1]*s[0][0],Y_*(s[2][1]*s[2][1]-s[0][1]*s[0][1]),s[2][1]*s[2][2]-s[0][1]*s[0][2],X_*(s[2][2]*s[2][2]-s[2][0]*s[2][0]-(s[0][2]*s[0][2]-s[0][0]*s[0][0]))]],n=[[X_*(s[2][2]*i[0][0]+s[2][0]*i[0][4]+(s[0][2]*i[4][0]+s[0][0]*i[4][4])),G_*(s[2][1]*i[0][0]+s[0][1]*i[4][0]),uy*(s[2][1]*i[0][1]+s[0][1]*i[4][1]),ty*(s[2][1]*i[0][2]+s[0][1]*i[4][2]),uy*(s[2][1]*i[0][3]+s[0][1]*i[4][3]),G_*(s[2][1]*i[0][4]+s[0][1]*i[4][4]),X_*(s[2][2]*i[0][4]-s[2][0]*i[0][0]+(s[0][2]*i[4][4]-s[0][0]*i[4][0]))],[ey*(s[1][2]*i[0][0]+s[1][0]*i[0][4])+ey*(s[2][2]*i[1][0]+s[2][0]*i[1][4]+(s[0][2]*i[3][0]+s[0][0]*i[3][4])),s[1][1]*i[0][0]+(s[2][1]*i[1][0]+s[0][1]*i[3][0]),iy*s[1][1]*i[0][1]+iy*(s[2][1]*i[1][1]+s[0][1]*i[3][1]),ay*s[1][1]*i[0][2]+ay*(s[2][1]*i[1][2]+s[0][1]*i[3][2]),iy*s[1][1]*i[0][3]+iy*(s[2][1]*i[1][3]+s[0][1]*i[3][3]),s[1][1]*i[0][4]+(s[2][1]*i[1][4]+s[0][1]*i[3][4]),ey*(s[1][2]*i[0][4]-s[1][0]*i[0][0])+ey*(s[2][2]*i[1][4]-s[2][0]*i[1][0]+(s[0][2]*i[3][4]-s[0][0]*i[3][0]))],[cy*(s[1][2]*i[1][0]+s[1][0]*i[1][4])+$_*(s[0][2]*i[2][0]+s[0][0]*i[2][4])-my*(s[2][2]*i[0][0]+s[2][0]*i[0][4]-(s[0][2]*i[4][0]+s[0][0]*i[4][4])),J_*s[1][1]*i[1][0]+Z_*s[0][1]*i[2][0]-oy*(s[2][1]*i[0][0]-s[0][1]*i[4][0]),s[1][1]*i[1][1]+Y_*s[0][1]*i[2][1]-dy*(s[2][1]*i[0][1]-s[0][1]*i[4][1]),ry*s[1][1]*i[1][2]+j_*s[0][1]*i[2][2]-py*(s[2][1]*i[0][2]-s[0][1]*i[4][2]),s[1][1]*i[1][3]+Y_*s[0][1]*i[2][3]-dy*(s[2][1]*i[0][3]-s[0][1]*i[4][3]),J_*s[1][1]*i[1][4]+Z_*s[0][1]*i[2][4]-oy*(s[2][1]*i[0][4]-s[0][1]*i[4][4]),cy*(s[1][2]*i[1][4]-s[1][0]*i[1][0])+$_*(s[0][2]*i[2][4]-s[0][0]*i[2][0])-my*(s[2][2]*i[0][4]-s[2][0]*i[0][0]-(s[0][2]*i[4][4]-s[0][0]*i[4][0]))],[ly*(s[1][2]*i[2][0]+s[1][0]*i[2][4])-oy*(s[2][2]*i[3][0]+s[2][0]*i[3][4]+(s[0][2]*i[1][0]+s[0][0]*i[1][4])),Q_*s[1][1]*i[2][0]-K_*(s[2][1]*i[3][0]+s[0][1]*i[1][0]),ny*s[1][1]*i[2][1]-sy*(s[2][1]*i[3][1]+s[0][1]*i[1][1]),s[1][1]*i[2][2]-W_*(s[2][1]*i[3][2]+s[0][1]*i[1][2]),ny*s[1][1]*i[2][3]-sy*(s[2][1]*i[3][3]+s[0][1]*i[1][3]),Q_*s[1][1]*i[2][4]-K_*(s[2][1]*i[3][4]+s[0][1]*i[1][4]),ly*(s[1][2]*i[2][4]-s[1][0]*i[2][0])-oy*(s[2][2]*i[3][4]-s[2][0]*i[3][0]+(s[0][2]*i[1][4]-s[0][0]*i[1][0]))],[cy*(s[1][2]*i[3][0]+s[1][0]*i[3][4])+$_*(s[2][2]*i[2][0]+s[2][0]*i[2][4])-my*(s[2][2]*i[4][0]+s[2][0]*i[4][4]+(s[0][2]*i[0][0]+s[0][0]*i[0][4])),J_*s[1][1]*i[3][0]+Z_*s[2][1]*i[2][0]-oy*(s[2][1]*i[4][0]+s[0][1]*i[0][0]),s[1][1]*i[3][1]+Y_*s[2][1]*i[2][1]-dy*(s[2][1]*i[4][1]+s[0][1]*i[0][1]),ry*s[1][1]*i[3][2]+j_*s[2][1]*i[2][2]-py*(s[2][1]*i[4][2]+s[0][1]*i[0][2]),s[1][1]*i[3][3]+Y_*s[2][1]*i[2][3]-dy*(s[2][1]*i[4][3]+s[0][1]*i[0][3]),J_*s[1][1]*i[3][4]+Z_*s[2][1]*i[2][4]-oy*(s[2][1]*i[4][4]+s[0][1]*i[0][4]),cy*(s[1][2]*i[3][4]-s[1][0]*i[3][0])+$_*(s[2][2]*i[2][4]-s[2][0]*i[2][0])-my*(s[2][2]*i[4][4]-s[2][0]*i[4][0]+(s[0][2]*i[0][4]-s[0][0]*i[0][0]))],[ey*(s[1][2]*i[4][0]+s[1][0]*i[4][4])+ey*(s[2][2]*i[3][0]+s[2][0]*i[3][4]-(s[0][2]*i[1][0]+s[0][0]*i[1][4])),s[1][1]*i[4][0]+(s[2][1]*i[3][0]-s[0][1]*i[1][0]),iy*s[1][1]*i[4][1]+iy*(s[2][1]*i[3][1]-s[0][1]*i[1][1]),ay*s[1][1]*i[4][2]+ay*(s[2][1]*i[3][2]-s[0][1]*i[1][2]),iy*s[1][1]*i[4][3]+iy*(s[2][1]*i[3][3]-s[0][1]*i[1][3]),s[1][1]*i[4][4]+(s[2][1]*i[3][4]-s[0][1]*i[1][4]),ey*(s[1][2]*i[4][4]-s[1][0]*i[4][0])+ey*(s[2][2]*i[3][4]-s[2][0]*i[3][0]-(s[0][2]*i[1][4]-s[0][0]*i[1][0]))],[X_*(s[2][2]*i[4][0]+s[2][0]*i[4][4]-(s[0][2]*i[0][0]+s[0][0]*i[0][4])),G_*(s[2][1]*i[4][0]-s[0][1]*i[0][0]),uy*(s[2][1]*i[4][1]-s[0][1]*i[0][1]),ty*(s[2][1]*i[4][2]-s[0][1]*i[0][2]),uy*(s[2][1]*i[4][3]-s[0][1]*i[0][3]),G_*(s[2][1]*i[4][4]-s[0][1]*i[0][4]),X_*(s[2][2]*i[4][4]-s[2][0]*i[4][0]-(s[0][2]*i[0][4]-s[0][0]*i[0][0]))]];this.apply=(e,t)=>{t&&t!==e||(gy.set(e),t=gy),e.length<3||(e[0]=fy(3,0,t,s[0]),e[1]=fy(3,0,t,s[1]),e[2]=fy(3,0,t,s[2]),e.length<8||(e[3]=fy(5,3,t,i[0]),e[4]=fy(5,3,t,i[1]),e[5]=fy(5,3,t,i[2]),e[6]=fy(5,3,t,i[3]),e[7]=fy(5,3,t,i[4]),e.length<15||(e[8]=fy(7,8,t,n[0]),e[9]=fy(7,8,t,n[1]),e[10]=fy(7,8,t,n[2]),e[11]=fy(7,8,t,n[3]),e[12]=fy(7,8,t,n[4]),e[13]=fy(7,8,t,n[5]),e[14]=fy(7,8,t,n[6]))))}}}var _y;!function(e){e[e.selected=1]="selected",e[e.hidden=2]="hidden",e[e.deleted=4]="deleted"}(_y||(_y={}));var yy="2.2.3",xy="* {\n    margin: 0;\n    padding: 0;\n    touch-action: none;\n}\nbody {\n    overflow: hidden;\n}\n.hidden {\n    display: none !important;\n}\n#infoPanel {\n    font-family: 'Arial', sans-serif;\n    color: #2c3e50;\n    position: fixed;\n    top: 0;\n    left: 0;\n    width: 100%;\n    height: 100%;\n    background: rgba(0, 0, 0, 0.3);\n    z-index: 999;\n    display: flex;\n    align-items: center;\n    justify-content: center;\n}\n#infoPanelContent {\n    background: rgba(255, 255, 255, 0.95);\n    padding: 20px;\n    border-radius: 8px;\n    border: 1px solid #ddd;\n    box-shadow: 0 4px 8px rgba(0, 0, 0, 0.1);\n    backdrop-filter: blur(8px);\n    -webkit-backdrop-filter: blur(8px);\n}\n#infoPanelContent h3 {\n    margin: 0 0 12px 0;\n    color: #2c3e50;\n}\n.control-item {\n    display: flex;\n    justify-content: space-between;\n    gap: 24px;\n    line-height: 1.5;\n}\n.control-action {\n    text-align: left;\n}\n.control-key {\n    text-align: right;\n    color: #666;\n}\n#loadingWrap {\n    position: fixed;\n    bottom: 120px;\n    left: 50%;\n    transform: translate(-50%, 0);\n    width: 380px;\n\n    display: flex;\n    flex-direction: column;\n\n    z-index: 1000;\n    padding: 16px;\n    border-radius: 8px;\n    backdrop-filter: blur(8px);\n    -webkit-backdrop-filter: blur(8px);\n}\n#loadingWrap > #loadingText {\n    font-family: 'Arial', sans-serif;\n    font-size: 18px;\n    color: white;\n    text-align: center;\n    text-shadow: 0 0 4px rgba(0, 0, 0, 0.5);\n}\n#loadingWrap > #loadingBar {\n    width: 100%;\n    height: 10px;\n    margin-top: 8px;\n    border-radius: 4px;\n    overflow: hidden;\n}\n#buttonContainer {\n    position: absolute;\n    display: flex;\n    bottom: max(16px, env(safe-area-inset-bottom));\n    right: max(16px, env(safe-area-inset-right));\n    gap: 8px;\n}\n.button {\n    display: flex;\n    position: relative;\n    width: 40px;\n    height: 40px;\n    color: white;\n    background-color: #b3aaac;\n    border: 0;\n    border-radius: 8px;\n    cursor: pointer;\n    align-items: center;\n    justify-content: center;\n    padding: 0;\n    margin: 0;\n}\n.buttonSvg {\n    display: block;\n    margin: auto;\n}\n#poster {\n    display: none;\n    position: absolute;\n    top: 0;\n    left: 0;\n    width: 100%;\n    height: 100%;\n    background-size: cover;\n    background-position: center;\n    background-repeat: no-repeat;\n}",wy='<!DOCTYPE html>\n<html lang="en">\n    <head>\n        <title>SuperSplat Viewer</title>\n        <meta charset="UTF-8">\n        <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">\n        <base href="">\n        <link rel="stylesheet" href="./index.css">\n        <script async src="https://docs.opencv.org/4.x/opencv.js" type="text/javascript"><\/script>\n        <script type="importmap">\n            {\n                "imports": {\n                    "playcanvas": "https://cdn.jsdelivr.net/npm/playcanvas@2.4.2/build/playcanvas.mjs",\n                    "spline": "./spline.js"\n                }\n            }\n        <\/script>\n        <script type="module" src="https://cdn.jsdelivr.net/npm/@playcanvas/web-components@0.1.13/dist/pwc.mjs"><\/script>\n        <script type="module">\n            window.settings = fetch("./settings.json").then(response => response.json());\n        <\/script>\n    </head>\n    <body>\n        <pc-app antialias="false" depth="false" high-resolution="true" stencil="false">\n            <pc-asset src="https://cdn.jsdelivr.net/npm/playcanvas@2.4.2/scripts/esm/camera-controls.mjs"></pc-asset>\n            <pc-asset src="https://cdn.jsdelivr.net/npm/playcanvas@2.4.2/scripts/esm/xr-controllers.mjs"></pc-asset>\n            <pc-asset src="https://cdn.jsdelivr.net/npm/playcanvas@2.4.2/scripts/esm/xr-navigation.mjs"></pc-asset>\n            <pc-asset id="ply" type="gsplat" lazy src="./scene.compressed.ply"></pc-asset>\n            <pc-scene>\n                \x3c!-- Camera (with XR support) --\x3e\n                <pc-entity name="camera root">\n                    <pc-entity name="camera">\n                        <pc-camera near-clip="0.01" far-clip="1000" horizontal-fov="true" tonemap="none"></pc-camera>\n                        <pc-scripts>\n                            <pc-script name="cameraControls"></pc-script>\n                        </pc-scripts>\n                    </pc-entity>\n                    <pc-scripts>\n                        <pc-script name="xrControllers"></pc-script>\n                        <pc-script name="xrNavigation"></pc-script>\n                    </pc-scripts>\n                </pc-entity>\n                \x3c!-- Light (for XR controllers) --\x3e\n                <pc-entity name="light" rotation="35 45 0">\n                    <pc-light color="white" intensity="1.5"></pc-light>\n                </pc-entity>\n                \x3c!-- Splat --\x3e\n                <pc-entity name="splat" rotation="0 0 180">\n                    <pc-splat asset="ply"></pc-splat>\n                </pc-entity>\n            </pc-scene>\n        </pc-app>\n\n        \x3c!-- Loading Indicator --\x3e\n        <div id="loadingWrap">\n            <div id="loadingText"></div>\n            <div id="loadingBar"></div>\n        </div>\n\n        \x3c!-- Info Panel --\x3e\n        <div id="infoPanel" class="hidden" onclick="document.getElementById(\'infoPanel\').classList.add(\'hidden\')">\n            <div id="infoPanelContent" onclick="event.stopPropagation()">\n                <h3>Controls</h3>\n                <div class="control-item">\n                    <span class="control-action">Orbit</span>\n                    <span class="control-key">Left Mouse Button</span>\n                </div>\n                <div class="control-item">\n                    <span class="control-action">Pan</span>\n                    <span class="control-key">Middle Mouse Button</span>\n                </div>\n                <div class="control-item">\n                    <span class="control-action">Look around</span>\n                    <span class="control-key">Right Mouse Button</span>\n                </div>\n                <div class="control-item">\n                    <span class="control-action">Zoom</span>\n                    <span class="control-key">Mouse Wheel</span>\n                </div>\n                <div class="control-item">\n                    <span class="control-action">Fly</span>\n                    <span class="control-key">W,S,A,D</span>\n                </div>\n                <div class="control-item">\n                    <span class="control-action">Fly faster</span>\n                    <span class="control-key">Shift</span>\n                </div>\n                <div class="control-item">\n                    <span class="control-action">Fly slower</span>\n                    <span class="control-key">Ctrl</span>\n                </div>\n                <div class="control-item">\n                    <span class="control-action">Frame Scene</span>\n                    <span class="control-key">F</span>\n                </div>\n                <div class="control-item">\n                    <span class="control-action">Reset Camera</span>\n                    <span class="control-key">R</span>\n                </div>\n            </div>\n        </div>\n\n        <div id="poster"></div>\n\n        \x3c!-- Buttons Panel --\x3e\n        <div id="buttonContainer">\n            <button id="arMode" class="button hidden">\n                <svg class="buttonSvg" xmlns="http://www.w3.org/2000/svg" height="24px" viewBox="0 -960 960 960" width="24px" fill="currentColor"><path d="M440-181 240-296q-19-11-29.5-29T200-365v-230q0-22 10.5-40t29.5-29l200-115q19-11 40-11t40 11l200 115q19 11 29.5 29t10.5 40v230q0 22-10.5 40T720-296L520-181q-19 11-40 11t-40-11Zm0-92v-184l-160-93v185l160 92Zm80 0 160-92v-185l-160 93v184ZM80-680v-120q0-33 23.5-56.5T160-880h120v80H160v120H80ZM280-80H160q-33 0-56.5-23.5T80-160v-120h80v120h120v80Zm400 0v-80h120v-120h80v120q0 33-23.5 56.5T800-80H680Zm120-600v-120H680v-80h120q33 0 56.5 23.5T880-800v120h-80ZM480-526l158-93-158-91-158 91 158 93Zm0 45Zm0-45Zm40 69Zm-80 0Z"/></svg>\n            </button>\n            <button id="vrMode" class="button hidden">\n                <svg class="buttonSvg" xmlns="http://www.w3.org/2000/svg" height="24px" viewBox="0 -960 960 960" width="24px" fill="currentColor"><path d="M300-240q-66 0-113-47t-47-113v-163q0-51 32-89.5t82-47.5q57-11 113-15.5t113-4.5q57 0 113.5 4.5T706-700q50 10 82 48t32 89v163q0 66-47 113t-113 47h-40q-13 0-26-1.5t-25-6.5l-64-22q-12-5-25-5t-25 5l-64 22q-12 5-25 6.5t-26 1.5h-40Zm0-80h40q7 0 13.5-1t12.5-3q29-9 56.5-19t57.5-10q30 0 58 9.5t56 19.5q6 2 12.5 3t13.5 1h40q33 0 56.5-23.5T740-400v-163q0-22-14-38t-35-21q-52-11-104.5-14.5T480-640q-54 0-106 4t-105 14q-21 4-35 20.5T220-563v163q0 33 23.5 56.5T300-320ZM40-400v-160h60v160H40Zm820 0v-160h60v160h-60Zm-380-80Z"/></svg>\n            </button>\n            <button id="enterFullscreen" class="button hidden">\n                <svg class="buttonSvg" xmlns="http://www.w3.org/2000/svg" height="24px" viewBox="0 -960 960 960" width="24px" fill="currentColor"><path d="M120-120v-200h80v120h120v80H120Zm520 0v-80h120v-120h80v200H640ZM120-640v-200h200v80H200v120h-80Zm640 0v-120H640v-80h200v200h-80Z"/></svg>\n            </button>\n            <button id="exitFullscreen" class="button hidden">\n                <svg class="buttonSvg" xmlns="http://www.w3.org/2000/svg" height="24px" viewBox="0 -960 960 960" width="24px" fill="currentColor"><path d="M240-120v-120H120v-80h200v200h-80Zm400 0v-200h200v80H720v120h-80ZM120-640v-80h120v-120h80v200H120Zm520 0v-200h80v120h120v80H640Z"/></svg>\n            </button>\n            <button id="info" class="button">\n                <svg class="buttonSvg" xmlns="http://www.w3.org/2000/svg" height="24px" viewBox="0 -960 960 960" width="24px" fill="currentColor"><path d="M440-280h80v-240h-80v240Zm40-320q17 0 28.5-11.5T520-640q0-17-11.5-28.5T480-680q-17 0-28.5 11.5T440-640q0 17 11.5 28.5T480-600Zm0 520q-83 0-156-31.5T197-197q-54-54-85.5-127T80-480q0-83 31.5-156T197-763q54-54 127-85.5T480-880q83 0 156 31.5T763-763q54 54 85.5 127T880-480q0 83-31.5 156T763-197q-54 54-127 85.5T480-80Zm0-80q134 0 227-93t93-227q0-134-93-227t-227-93q-134 0-227 93t-93 227q0 134 93 227t227 93Zm0-320Z"/></svg>\n            </button>\n        </div>\n\n        <script type="module" src="./index.js"><\/script>\n    </body>\n</html>\n',by="import { BoundingBox, Color, Mat4, Script, Vec3, Entity, StandardMaterial, Quat, BLEND_NONE, BLEND_NORMAL, LAYER_WORLD, Ray } from 'playcanvas';\nimport { CubicSpline } from 'spline';\n\n//  AABB  Ray intersection helper \nfunction intersectAABB(ray, aabb) {\n    // Inverse of ray direction\n    const inv = new Vec3(1 / ray.direction.x, 1 / ray.direction.y, 1 / ray.direction.z);\n    // Min/max corners\n    const mn = aabb.center.clone().sub(aabb.halfExtents);\n    const mx = aabb.center.clone().add(aabb.halfExtents);\n\n    let tmin = (mn.x - ray.origin.x) * inv.x;\n    let tmax = (mx.x - ray.origin.x) * inv.x;\n    if (inv.x < 0) [tmin, tmax] = [tmax, tmin];\n\n    let tymin = (mn.y - ray.origin.y) * inv.y;\n    let tymax = (mx.y - ray.origin.y) * inv.y;\n    if (inv.y < 0) [tymin, tymax] = [tymax, tymin];\n\n    if (tmin > tymax || tymin > tmax) return null;\n    tmin = Math.max(tmin, tymin);\n    tmax = Math.min(tmax, tymax);\n\n    let tzmin = (mn.z - ray.origin.z) * inv.z;\n    let tzmax = (mx.z - ray.origin.z) * inv.z;\n    if (inv.z < 0) [tzmin, tzmax] = [tzmax, tzmin];\n\n    if (tmin > tzmax || tzmin > tmax) return null;\n    tmin = Math.max(tmin, tzmin);\n\n    // Only care about the first entry (front face)\n    return tmin >= 0 ? tmin : null;\n}\n\nconst nearlyEquals = (a, b, epsilon = 1e-4) => {\n    return !a.some((v, i) => Math.abs(v - b[i]) >= epsilon);\n};\n\nconst url = new URL(location.href);\n\nconst params = {\n    noui: url.searchParams.has('noui'),\n    noanim: url.searchParams.has('noanim'),\n    posterUrl: url.searchParams.get('poster')\n};\n\n// display a blurry poster image which resolves to sharp during loading\nclass Poster {\n    constructor(url) {\n        const blur = (progress) => blur(\"${Math.floor((100 - progress) * 0.4)}px\");\n        const element = document.getElementById('poster');\n        element.style.backgroundImage = url(\"${url}\");\n        element.style.display = 'block';\n        element.style.filter = blur(0);\n        this.progress = (progress) => {\n            element.style.filter = blur(progress);\n        };\n        this.hide = () => {\n            element.style.display = 'none';\n        };\n    }\n}\n\nconst poster = params.posterUrl && new Poster(params.posterUrl);\n\nclass FrameScene extends Script {\n    initialize() {\n        const { settings } = this;\n        const { camera, animTracks } = settings;\n        const { position, target } = camera;\n        this.position = position && new Vec3(position);\n        this.target = target && new Vec3(target);\n        // construct camera animation track\n        if (animTracks?.length > 0 && settings.camera.startAnim === 'animTrack') {\n            const track = animTracks.find(track => track.name === camera.animTrack);\n            if (track) {\n                const { keyframes, duration } = track;\n                const { times, values } = keyframes;\n                const { position, target } = values;\n                // construct the points array containing position and target\n                const points = [];\n                for (let i = 0; i < times.length; i++) {\n                    points.push(position[i * 3], position[i * 3 + 1], position[i * 3 + 2]);\n                    points.push(target[i * 3], target[i * 3 + 1], target[i * 3 + 2]);\n                }\n                this.cameraAnim = {\n                    time: 0,\n                    spline: CubicSpline.fromPointsLooping(duration, times, points),\n                    track,\n                    result: []\n                };\n            }\n        }\n    }\n\n    frameScene(bbox, smooth = true) {\n        const sceneSize = bbox.halfExtents.length();\n        const distance = sceneSize / Math.sin(this.entity.camera.fov / 180 * Math.PI * 0.5);\n        this.entity.script.cameraControls.sceneSize = sceneSize;\n        this.entity.script.cameraControls.focus(bbox.center, new Vec3(2, 1, 2).normalize().mulScalar(distance).add(bbox.center), smooth);\n    }\n\n    resetCamera(bbox, smooth = true) {\n        const sceneSize = bbox.halfExtents.length();\n        this.entity.script.cameraControls.sceneSize = sceneSize * 0.2;\n        this.entity.script.cameraControls.focus(this.target ?? Vec3.ZERO, this.position ?? new Vec3(2, 1, 2), smooth);\n    }\n\n    initCamera() {\n        const { app } = this;\n        const { graphicsDevice } = app;\n        let animating = false;\n        let animationTimer = 0;\n        // get the gsplat component\n        const gsplatComponent = app.root.findComponent('gsplat');\n        // calculate the bounding box\n        const bbox = gsplatComponent?.instance?.meshInstance?.aabb ?? new BoundingBox();\n        if (bbox.halfExtents.length() > 100 || this.position || this.target) {\n            this.resetCamera(bbox, false);\n        } else {\n            this.frameScene(bbox, false);\n        }\n        const cancelAnimation = () => {\n            if (animating) {\n                animating = false;\n                // copy current camera position and target\n                const r = this.cameraAnim.result;\n                this.entity.script.cameraControls.focus(\n                    new Vec3(r[3], r[4], r[5]),\n                    new Vec3(r[0], r[1], r[2]),\n                    false\n                );\n            }\n        };\n        // listen for interaction events\n        const events = ['wheel', 'pointerdown', 'contextmenu'];\n        const handler = (e) => {\n            cancelAnimation();\n            events.forEach(event => app.graphicsDevice.canvas.removeEventListener(event, handler));\n        };\n        events.forEach(event => app.graphicsDevice.canvas.addEventListener(event, handler));\n        window.addEventListener('keydown', (e) => {\n            if (e.ctrlKey || e.altKey || e.metaKey) return;\n            switch (e.key) {\n                case 'f':\n                    cancelAnimation();\n                    this.frameScene(bbox);\n                    break;\n                case 'r':\n                    cancelAnimation();\n                    this.resetCamera(bbox);\n                    break;\n            }\n        });\n        app.on('update', (deltaTime) => {\n            // handle camera animation\n            if (this.cameraAnim && animating && !params.noanim) {\n                const { cameraAnim } = this;\n                const { spline, track, result } = cameraAnim;\n                // update animation timer\n                animationTimer += deltaTime;\n                // update the track cursor\n                if (animationTimer < 5) {\n                    // ease in\n                    cameraAnim.time += deltaTime * Math.pow(animationTimer / 5, 0.5);\n                } else {\n                    cameraAnim.time += deltaTime;\n                }\n                if (cameraAnim.time >= track.duration) {\n                    switch (track.loopMode) {\n                        case 'none': cameraAnim.time = track.duration; break;\n                        case 'repeat': cameraAnim.time = cameraAnim.time % track.duration; break;\n                        case 'pingpong': cameraAnim.time = cameraAnim.time % (track.duration * 2); break;\n                    }\n                }\n                // evaluate the spline\n                spline.evaluate(cameraAnim.time > track.duration ? track.duration - cameraAnim.time : cameraAnim.time, result);\n                // set camera\n                this.entity.setPosition(result[0], result[1], result[2]);\n                this.entity.lookAt(result[3], result[4], result[5]);\n            }\n        });\n        const prevProj = new Mat4();\n        const prevWorld = new Mat4();\n        app.on('framerender', () => {\n            if (!app.autoRender && !app.renderNextFrame) {\n                const world = this.entity.getWorldTransform();\n                if (!nearlyEquals(world.data, prevWorld.data)) {\n                    app.renderNextFrame = true;\n                }\n                const proj = this.entity.camera.projectionMatrix;\n                if (!nearlyEquals(proj.data, prevProj.data)) {\n                    app.renderNextFrame = true;\n                }\n                if (app.renderNextFrame) {\n                    prevWorld.copy(world);\n                    prevProj.copy(proj);\n                }\n            }\n        });\n        // wait for first gsplat sort\n        const handle = gsplatComponent?.instance?.sorter?.on('updated', () => {\n            handle.off();\n            // request frame render\n            app.renderNextFrame = true;\n            // wait for first render to complete\n            const frameHandle = app.on('frameend', () => {\n                frameHandle.off();\n                // hide loading indicator\n                document.getElementById('loadingWrap').classList.add('hidden');\n                // fade out poster\n                poster?.hide();\n                // start animating once the first frame is rendered\n                if (this.cameraAnim) {\n                    animating = true;\n                }\n                // emit first frame event on window\n                window.firstFrame?.();\n            });\n        });\n        const updateHorizontalFov = (width, height) => {\n            this.entity.camera.horizontalFov = width > height;\n        };\n        // handle fov on canvas resize\n        graphicsDevice.on('resizecanvas', (width, height) => {\n            updateHorizontalFov(width, height);\n            app.renderNextFrame = true;\n        });\n        // configure on-demand rendering\n        app.autoRender = false;\n        updateHorizontalFov(graphicsDevice.width, graphicsDevice.height);\n    }\n    postInitialize() {\n        const assets = this.app.assets.filter(asset => asset.type === 'gsplat');\n        if (assets.length > 0) {\n            const asset = assets[0];\n            if (asset.loaded) {\n                this.initCamera();\n            } else {\n                asset.on('load', () => {\n                    this.initCamera();\n                });\n            }\n        }\n    }\n}\n\ndocument.addEventListener('DOMContentLoaded', async () => {\n    const appElement = await document.querySelector('pc-app').ready();\n    const cameraElement = await document.querySelector('pc-entity[name=\"camera\"]').ready();\n    const app = await appElement.app;\n    const camera = cameraElement.entity;\n    const settings = await window.settings;\n\n    // Store references to all mesh objects for toggling\n    const meshObjects = {\n        debugObjects: [],\n        cameraMarkers: []\n    };\n\n    // Function to create a button\n    const createButton = (text, position, onClick) => {\n        const button = document.createElement('button');\n        button.textContent = text;\n        button.style.position = 'absolute';\n        button.style.zIndex = '1000';\n        button.style.padding = '8px 16px';\n        button.style.backgroundColor = '#007bff';\n        button.style.color = 'white';\n        button.style.border = 'none';\n        button.style.borderRadius = '4px';\n        button.style.cursor = 'pointer';\n        if (position === 'top-left') {\n            button.style.top = '10px';\n            button.style.left = '10px';\n        } else if (position === 'top-right') {\n            button.style.top = '10px';\n            button.style.right = '10px';\n        } else if (position === 'bottom-left') {\n            button.style.bottom = '10px';\n            button.style.left = '10px';\n        } else if (position === 'bottom-right') {\n            button.style.bottom = '10px';\n            button.style.right = '10px';\n        }\n        button.addEventListener('click', onClick);\n        document.body.appendChild(button);\n        return button;\n    };\n\n    // Function to create a debug box\n    const createDebugBox = (app, position, color, scale) => {\n        try {\n            const box = new Entity(`DebugBox_${position.toString()}`);\n            box.addComponent(\"model\", { type: \"box\" });\n            box.setPosition(position.x, position.y, position.z);\n            box.setLocalScale(scale, scale, scale);\n            const material = new StandardMaterial();\n            material.diffuse = color;\n            material.emissive = color;\n            material.emissiveIntensity = 0.5;\n            material.opacity = 1.0;\n            material.blendType = BLEND_NORMAL;\n            material.depthWrite = false;\n            material.depthTest = true;\n            material.cull = 0;\n            material.update();\n            if (box.model) {\n                box.model.material = material;\n                if (box.model.meshInstances && box.model.meshInstances.length > 0) {\n                    box.model.meshInstances.forEach(meshInstance => {\n                        meshInstance.layer = LAYER_WORLD + 1;\n                        meshInstance.drawOrder = 9999;\n                    });\n                }\n            }\n            return box;\n        } catch (err) {\n            console.error(`Error creating debug box at ${position.toString()}:`, err);\n            return null;\n        }\n    };\n\n    // Function to add debug objects to the scene\n    const addDebugObjects = (app) => {\n        console.log(\"Adding debug objects to the scene\");\n        try {\n            const debugParent = new Entity('DebugObjects');\n            app.root.addChild(debugParent);\n            const originBox = createDebugBox(app, new Vec3(0, 0, 0), new Color(1, 0, 1), 0.5);\n            debugParent.addChild(originBox);\n            meshObjects.debugObjects.push(originBox);\n            const xAxisBox = createDebugBox(app, new Vec3(5, 0, 0), new Color(1, 0, 0), 0.3);\n            const yAxisBox = createDebugBox(app, new Vec3(0, 5, 0), new Color(0, 1, 0), 0.3);\n            const zAxisBox = createDebugBox(app, new Vec3(0, 0, 5), new Color(0, 0, 1), 0.3);\n            debugParent.addChild(xAxisBox);\n            debugParent.addChild(yAxisBox);\n            debugParent.addChild(zAxisBox);\n            meshObjects.debugObjects.push(xAxisBox, yAxisBox, zAxisBox);\n            app.renderNextFrame = true;\n            return debugParent;\n        } catch (err) {\n            console.error(\"Error adding debug objects:\", err);\n            return null;\n        }\n    };\n\n    // Modified createCameraMarkers: now stores the original color on each marker.\n    const createCameraMarkers = (app, cameraData) => {\n        if (!cameraData || !Array.isArray(cameraData)) {\n            console.log(\"No camera data provided\");\n            return;\n        }\n        console.log(`Creating ${cameraData.length} camera markers`);\n        try {\n            const existingMarkers = [];\n            app.root.findByName('CameraMarkers', existingMarkers);\n            existingMarkers.forEach(marker => {\n                try {\n                    if (marker && marker.parent) {\n                        marker.parent.removeChild(marker);\n                    }\n                } catch (err) {\n                    console.error(\"Error removing existing marker:\", err);\n                }\n            });\n            meshObjects.cameraMarkers = [];\n            const markersParent = new Entity('CameraMarkers');\n            app.root.addChild(markersParent);\n            \n            // Define fixed colors for clusters 0, 1, and 2.\n            const clusterColors = [\n                new Color(1, 1, 0), // Red for cluster 0\n                new Color(0, 1, 0), // Green for cluster 1\n                new Color(0, 0, 1)  // Blue for cluster 2\n            ];\n            \n            cameraData.forEach((data, index) => {\n                try {\n                    const sphere = new Entity(`CameraMarker_${index}`);\n                    sphere.addComponent(\"model\", { type: \"sphere\" });\n                    sphere.setLocalScale(0.2, 0.2, 0.2);\n                    \n                    // Determine the marker color based on the cluster.\n                    const cluster = data.cluster;\n                    const markerColor = (cluster !== undefined && cluster >= 0)\n                        ? clusterColors[cluster % clusterColors.length]\n                        : new Color(Math.random(), Math.random(), Math.random());\n                        \n                    // Save the original color for later reversion.\n                    sphere.originalColor = markerColor.clone();\n                    const material = new StandardMaterial();\n                    material.diffuse = markerColor;\n                    material.emissive = markerColor;\n                    material.emissiveIntensity = 0.5;\n                    material.opacity = 1.0;\n                    material.blendType = BLEND_NORMAL;\n                    material.depthWrite = false;\n                    material.depthTest = true;\n                    material.cull = 0;\n                    material.update();\n                    if (sphere.model) {\n                        sphere.model.material = material;\n                        if (sphere.model.meshInstances && sphere.model.meshInstances.length > 0) {\n                            sphere.model.meshInstances.forEach(meshInstance => {\n                                meshInstance.layer = LAYER_WORLD + 1;\n                                meshInstance.drawOrder = 9999;\n                            });\n                        }\n                    }\n                    // Save the camera data on the marker.\n                    sphere.cameraData = data;\n                    sphere.setPosition(data.position.x, data.position.y, data.position.z);\n                    markersParent.addChild(sphere);\n                    meshObjects.cameraMarkers.push(sphere);\n                    console.log(`Camera marker ${index} added at position: ${sphere.getPosition().toString()} with image: ${data.imageName} and cluster: ${data.cluster}`);\n                } catch (err) {\n                    console.error(`Error creating camera marker ${index}:`, err);\n                }\n            });\n            app.renderNextFrame = true;\n            return markersParent;\n        } catch (err) {\n            console.error(\"Error in createCameraMarkers:\", err);\n            return null;\n        }\n    };\n    \n    // Modified parse function for the converted file with 6 tokens per line.\n    const parseCameraPositions = (text) => {\n        const lines = text.split(\"\\n\").filter(line => line.trim() && line[0] !== \"#\");\n        const cameras = [];\n        lines.forEach(line => {\n            const parts = line.trim().split(/\\s+/);\n            // If there are at least 7 tokens:\n            // IMAGE_ID, Cx, Cy, Cz, CAMERA_ID, NAME (possibly with spaces), CLUSTER_LABEL\n            if (parts.length >= 7) {\n                const imageId = parseInt(parts[0], 10);\n                const qw = parseFloat(parts[1]);\n                const qx = parseFloat(parts[2]);\n                const qy = parseFloat(parts[3]);\n                const qz = parseFloat(parts[4]);\n                const Cx = parseFloat(parts[5]);\n                const Cy = parseFloat(parts[6]);\n                const Cz = parseFloat(parts[7]);\n                // Assume the file name occupies tokens 5 to second last token\n                // const imageName = parts.slice(5, parts.length - 1).join(\" \");\n                // const cluster = parseInt(parts[parts.length - 1], 10);\n                cameras.push({\n                    imageId: parseInt(parts[0], 10),\n                    position: { x: Cx, y: Cy, z: Cz },\n                    quaternion: { qw, qx, qy, qz },\n                    cameraId: parseInt(parts[8], 10),\n                    imageName: parts.slice(9, parts.length - 1).join(\" \"),\n                    cluster: parseInt(parts[parts.length - 1], 10)\n                });\n            } else if (parts.length >= 6) {\n                // Fallback for older files without a cluster label.\n                const imageId = parseInt(parts[0], 10);\n                const Cx = parseFloat(parts[1]);\n                const Cy = parseFloat(parts[2]);\n                const Cz = parseFloat(parts[3]);\n                const cameraId = parseInt(parts[4], 10);\n                const imageName = parts.slice(5).join(\" \");\n                cameras.push({\n                    imageId,\n                    position: { x: Cx, y: Cy, z: Cz },\n                    quaternion: { qw: 1, qx: 0, qy: 0, qz: 0 },\n                    cameraId,\n                    imageName,\n                    cluster: -1  // or any default value for ungrouped images\n                });\n            }\n        });\n        return cameras;\n    };\n    \n\n    // Function to load camera data from file\n    const loadCameraData = () => {\n        try {\n            const input = document.createElement('input');\n            input.type = 'file';\n            input.accept = '.txt';\n            input.style.display = 'none';\n            document.body.appendChild(input);\n            let fileInput = input;\n            \n            input.addEventListener('change', async (event) => {\n                try {\n                    if (event.target.files && event.target.files.length > 0) {\n                        const file = event.target.files[0];\n                        try {\n                            const fileText = await file.text();\n                            const cameras = parseCameraPositions(fileText);\n                            console.log('Parsed cameras:', cameras);\n                            // Create camera markers using existing functionality.\n                            createCameraMarkers(app, cameras);\n                            // Determine how many unique clusters exist.\n                            const clusters = new Set(cameras.map(cam => cam.cluster));\n                            window.numClusters = clusters.size;\n                            console.log(\"Detected unique clusters:\", window.numClusters);\n                            const center = computeMarkersCenter();\n                            window.meshObjects.cameraMarkers.forEach(marker => {\n                                const pos = marker.getPosition();\n                                // Calculate offset relative to the group's center.\n                                const offset = pos.clone().sub(center);\n                                // Flip the X and Y components of the offset.\n                                const flippedOffset = new Vec3(-offset.x, -offset.y, offset.z);\n                                // Set the new position as the center plus the flipped offset.\n                                const newPos = center.clone().add(flippedOffset);\n                                marker.setPosition(newPos.x, newPos.y, newPos.z);\n                            });\n                            app.renderNextFrame = true;\n                        } catch (error) {\n                            console.error(\"Error reading file:\", error);\n                        }\n                    }\n                    if (fileInput && fileInput.parentNode === document.body) {\n                        document.body.removeChild(fileInput);\n                    }\n                    fileInput = null;\n                } catch (err) {\n                    console.error(\"Error in file input change handler:\", err);\n                }\n            });\n            \n            const loadButton = createButton('Load Camera Data', 'bottom-right', () => {\n                if (fileInput) {\n                    fileInput.click();\n                } else {\n                    const newInput = document.createElement('input');\n                    newInput.type = 'file';\n                    newInput.accept = '.txt';\n                    newInput.style.display = 'none';\n                    document.body.appendChild(newInput);\n                    fileInput = newInput;\n                    newInput.addEventListener('change', async (event) => {\n                        try {\n                            if (event.target.files && event.target.files.length > 0) {\n                                const file = event.target.files[0];\n                                try {\n                                    const fileText = await file.text();\n                                    const cameras = parseCameraPositions(fileText);\n                                    console.log('Parsed cameras:', cameras);\n                                    createCameraMarkers(app, cameras);\n                                    // Determine how many unique clusters exist.\n                                    const clusters = new Set(cameras.map(cam => cam.cluster));\n                                    window.numClusters = clusters.size;\n                                    console.log(\"Detected unique clusters:\", window.numClusters);\n                                    const center = computeMarkersCenter();\n                                    window.meshObjects.cameraMarkers.forEach(marker => {\n                                        const pos = marker.getPosition();\n                                        // Calculate offset relative to the group's center.\n                                        const offset = pos.clone().sub(center);\n                                        // Flip the X and Y components of the offset.\n                                        const flippedOffset = new Vec3(-offset.x, -offset.y, offset.z);\n                                        // Set the new position as the center plus the flipped offset.\n                                        const newPos = center.clone().add(flippedOffset);\n                                        marker.setPosition(newPos.x, newPos.y, newPos.z);\n                                    });\n                                    app.renderNextFrame = true;\n                                } catch (error) {\n                                    console.error(\"Error reading file:\", error);\n                                }\n                            }\n                            if (newInput && newInput.parentNode === document.body) {\n                                document.body.removeChild(newInput);\n                            }\n                            fileInput = null;\n                        } catch (err) {\n                            console.error(\"Error in file input change handler:\", err);\n                        }\n                    });\n                    newInput.click();\n                }\n            });\n            app.renderNextFrame = true;\n        } catch (err) {\n            console.error(\"Error in loadCameraData:\", err);\n        }\n    };\n\n    // Function to toggle mesh objects visibility\n    const toggleMeshObjects = (visible) => {\n        meshObjects.debugObjects.forEach(obj => {\n            if (obj && obj.enabled !== undefined) {\n                obj.enabled = visible;\n            }\n        });\n        meshObjects.cameraMarkers.forEach(marker => {\n            if (marker && marker.enabled !== undefined) {\n                marker.enabled = visible;\n            }\n        });\n        app.renderNextFrame = true;\n    };\n\n    // Add toggle button for mesh objects (top-left)\n    let meshObjectsVisible = true;\n    const toggleMeshButton = createButton('Toggle Mesh Objects', 'top-left', () => {\n        meshObjectsVisible = !meshObjectsVisible;\n        toggleMeshObjects(meshObjectsVisible);\n        toggleMeshButton.textContent = meshObjectsVisible ? 'Hide Mesh Objects' : 'Show Mesh Objects';\n    });\n    toggleMeshButton.textContent = 'Hide Mesh Objects';\n\n    // ---------------------------\n    // NEW: Toggle for Camera Detection\n    // ---------------------------\n    let cameraDetectionEnabled = false;\n    const cameraDetectButton = createButton('Enable Camera Detection', 'top-left', () => {\n        cameraDetectionEnabled = !cameraDetectionEnabled;\n        cameraDetectButton.textContent = cameraDetectionEnabled ? 'Disable Camera Detection' : 'Enable Camera Detection';\n        // If detection is disabled, reset any highlighted marker\n        if (!cameraDetectionEnabled && currentHighlightedMarker) {\n            currentHighlightedMarker.model.material.diffuse = currentHighlightedMarker.originalColor;\n            currentHighlightedMarker.model.material.emissive = currentHighlightedMarker.originalColor;\n            currentHighlightedMarker.model.material.update();\n            currentHighlightedMarker.isHighlighted = false;\n            currentHighlightedMarker = null;\n            app.renderNextFrame = true;\n        }\n    });\n    cameraDetectButton.style.top = '50px';\n\n    // ---------------------------\n    // NEW: Button to Flip Imported Cameras in X and Y Axis\n    // ---------------------------\n    // const flipCamerasButton = createButton(\"Flip Cameras\", \"top-left\", () => {\n    //     // Iterate over each imported camera marker and flip the X and Y coordinates.\n    //     const center = computeMarkersCenter();\n    //     window.meshObjects.cameraMarkers.forEach(marker => {\n    //         const pos = marker.getPosition();\n    //         // Calculate offset relative to the group's center.\n    //         const offset = pos.clone().sub(center);\n    //         // Flip the X and Y components of the offset.\n    //         const flippedOffset = new Vec3(-offset.x, -offset.y, offset.z);\n    //         // Set the new position as the center plus the flipped offset.\n    //         const newPos = center.clone().add(flippedOffset);\n    //         marker.setPosition(newPos.x, newPos.y, newPos.z);\n    //     });\n    //     app.renderNextFrame = true;\n    // });\n    // flipCamerasButton.style.top = '90px';\n    // flipCamerasButton.style.left = '10px';\n\n\n    // ---------------------------\n    // NEW: Function to parse key_images.txt file and return a Set of valid image IDs\n    // ---------------------------\n    function parseKeyImageFile(text) {\n        const lines = text.split(\"\\n\");\n        const keyIDs = new Set();\n        lines.forEach(line => {\n            if (!line.trim() || line.startsWith(\"#\")) return;\n            const tokens = line.trim().split(/\\s+/);\n            if (tokens.length >= 1) {\n                const id = parseInt(tokens[0], 10);\n                keyIDs.add(id);\n            }\n        });\n        return keyIDs;\n    }\n\n    // ---------------------------\n    // NEW: Function to prompt for key_images.txt file and fix the camera markers\n    // ---------------------------\n    function fixCameras() {\n        const input = document.createElement('input');\n        input.type = 'file';\n        input.accept = '.txt';\n        input.style.display = 'none';\n        document.body.appendChild(input);\n        \n        input.addEventListener('change', async (event) => {\n            try {\n                if (event.target.files && event.target.files.length > 0) {\n                    const file = event.target.files[0];\n                    const text = await file.text();\n                    const keyIDs = parseKeyImageFile(text);\n                    console.log(\"Key image IDs from selected file:\", keyIDs);\n                    // Remove markers that are not in the key set.\n                    window.meshObjects.cameraMarkers.forEach(marker => {\n                        if (!keyIDs.has(marker.cameraData.imageId)) {\n                            if (marker.parent) {\n                                marker.parent.removeChild(marker);\n                            }\n                        }\n                    });\n                    // Update the array to include only markers that remain.\n                    window.meshObjects.cameraMarkers = window.meshObjects.cameraMarkers.filter(marker => marker.parent !== null);\n                    app.renderNextFrame = true;\n                }\n            } catch (err) {\n                console.error(\"Error processing key_images file:\", err);\n            } finally {\n                document.body.removeChild(input);\n            }\n        });\n        input.click();\n    }\n    // Create the Fix Cameras button below the rotation buttons.\n    const fixCamerasButton = createButton(\"Fix Cameras\", \"bottom-left\", fixCameras);\n    fixCamerasButton.style.left = \"290px\";\n    fixCamerasButton.style.bottom = \"60px\";\n\n    // Function to create a visual origin gizmo at (0,0,0)\n    function addOriginGizmo(app) {\n        // X-axis: red bar\n        const xAxis = new Entity(\"gizmo_x\");\n        xAxis.addComponent(\"model\", { type: \"box\" });\n        // Create a thin box along X: length of 1, thickness of 0.02 in Y and Z.\n        xAxis.setLocalScale(1, 0.02, 0.02);\n        // Position the box so that its left end is at the origin (centered at 0.5,0,0)\n        xAxis.setPosition(0.5, 0, 0);\n        const xMaterial = new StandardMaterial();\n        xMaterial.diffuse = new Color(1, 0, 0);\n        xMaterial.emissive = new Color(1, 0, 0);\n        xMaterial.update();\n        xAxis.model.material = xMaterial;\n\n        // Y-axis: green bar\n        const yAxis = new Entity(\"gizmo_y\");\n        yAxis.addComponent(\"model\", { type: \"box\" });\n        // Thin box along Y: length 1, thickness 0.02 in X and Z.\n        yAxis.setLocalScale(0.02, 1, 0.02);\n        yAxis.setPosition(0, 0.5, 0);\n        const yMaterial = new StandardMaterial();\n        yMaterial.diffuse = new Color(0, 1, 0);\n        yMaterial.emissive = new Color(0, 1, 0);\n        yMaterial.update();\n        yAxis.model.material = yMaterial;\n\n        // Z-axis: blue bar\n        const zAxis = new Entity(\"gizmo_z\");\n        zAxis.addComponent(\"model\", { type: \"box\" });\n        // Thin box along Z: length 1, thickness 0.02 in X and Y.\n        zAxis.setLocalScale(0.02, 0.02, 1);\n        zAxis.setPosition(0, 0, 0.5);\n        const zMaterial = new StandardMaterial();\n        zMaterial.diffuse = new Color(0, 0, 1);\n        zMaterial.emissive = new Color(0, 0, 1);\n        zMaterial.update();\n        zAxis.model.material = zMaterial;\n\n        // Optional: a small sphere to emphasize the true origin at (0,0,0)\n        const originSphere = new Entity(\"gizmo_origin\");\n        originSphere.addComponent(\"model\", { type: \"sphere\" });\n        // A small sphere (adjust scale as needed)\n        originSphere.setLocalScale(0.05, 0.05, 0.05);\n        originSphere.setPosition(0, 0, 0);\n        const sphereMaterial = new StandardMaterial();\n        // Here we use yellow to highlight the exact origin\n        sphereMaterial.diffuse = new Color(1, 1, 0);\n        sphereMaterial.emissive = new Color(1, 1, 0);\n        sphereMaterial.update();\n        originSphere.model.material = sphereMaterial;\n\n        // Create a parent entity for the gizmo and add all parts to it.\n        const originGizmo = new Entity(\"originGizmo\");\n        originGizmo.addChild(xAxis);\n        originGizmo.addChild(yAxis);\n        originGizmo.addChild(zAxis);\n        originGizmo.addChild(originSphere);\n\n        // Finally, add the gizmo to the scene.\n        app.root.addChild(originGizmo);\n    }\n\n    addOriginGizmo(app);\n\n\n    // Load camera data\n    loadCameraData();\n\n    addExportButton(app);\n\n    camera.camera.clearColor = new Color(settings.background.color);\n    camera.camera.fov = settings.camera.fov;\n    camera.script.create(FrameScene, { properties: { settings } });\n\n    // Update loading indicator\n    const assets = app.assets.filter(asset => asset.type === 'gsplat');\n    if (assets.length > 0) {\n        const asset = assets[0];\n        const loadingText = document.getElementById('loadingText');\n        const loadingBar = document.getElementById('loadingBar');\n        asset.on('progress', (received, length) => {\n            const v = (Math.min(1, received / length) * 100).toFixed(0);\n            loadingText.textContent = \"${v}%\";\n            loadingBar.style.backgroundImage = 'linear-gradient(90deg, #F60 0%, #F60 ' + v + '%, white ' + v + '%, white 100%)';\n            poster?.progress(v);\n        });\n    }\n\n    const dom = ['arMode', 'vrMode', 'enterFullscreen', 'exitFullscreen', 'info', 'infoPanel', 'buttonContainer'].reduce((acc, id) => {\n        acc[id] = document.getElementById(id);\n        return acc;\n    }, {});\n\n    // AR\n    if (app.xr.isAvailable('immersive-ar')) {\n        dom.arMode.classList.remove('hidden');\n        dom.arMode.addEventListener('click', () => app.xr.start(app.root.findComponent('camera'), 'immersive-ar', 'local-floor'));\n    }\n    // VR\n    if (app.xr.isAvailable('immersive-vr')) {\n        dom.vrMode.classList.remove('hidden');\n        dom.vrMode.addEventListener('click', () => app.xr.start(app.root.findComponent('camera'), 'immersive-vr', 'local-floor'));\n    }\n    // Fullscreen\n    if (document.documentElement.requestFullscreen && document.exitFullscreen) {\n        dom.enterFullscreen.classList.remove('hidden');\n        dom.enterFullscreen.addEventListener('click', () => document.documentElement.requestFullscreen());\n        dom.exitFullscreen.addEventListener('click', () => document.exitFullscreen());\n        document.addEventListener('fullscreenchange', () => {\n            dom.enterFullscreen.classList[document.fullscreenElement ? 'add' : 'remove']('hidden');\n            dom.exitFullscreen.classList[document.fullscreenElement ? 'remove' : 'add']('hidden');\n        });\n    }\n    // Info\n    dom.info.addEventListener('click', () => {\n        dom.infoPanel.classList.toggle('hidden');\n    });\n    // Hide UI\n    if (params.noui) {\n        dom.buttonContainer.classList.add('hidden');\n    }\n\n    window.meshObjects = meshObjects;\n\n    // ---------------------------\n    // NEW: Highlight Closest Camera Marker on Mouse Move\n    // ---------------------------\n    const canvas = document.querySelector('canvas');\n    let currentHighlightedMarker = null;\n    if (!canvas) {\n        console.error(\"Canvas element not found.\");\n    } else {\n        //  Replace your existing mousemove handler with this block \n        canvas.addEventListener('mousemove', (event) => {\n            if (!cameraDetectionEnabled) return;\n        \n            // 1) compute mouseX, mouseY\n            const rect   = canvas.getBoundingClientRect();\n            const mouseX = event.clientX - rect.left;\n            const mouseY = event.clientY - rect.top;\n        \n            // 2) build pickray\n            const nearPoint = new Vec3();\n            const farPoint  = new Vec3();\n            camera.camera.screenToWorld(mouseX, mouseY, camera.camera.nearClip, nearPoint);\n            camera.camera.screenToWorld(mouseX, mouseY, camera.camera.farClip,  farPoint);\n            const direction = farPoint.sub(nearPoint).normalize();\n            const ray       = new Ray(nearPoint, direction);\n        \n            // 3) intersect the AABB\n            const gs = app.root.findComponent('gsplat');\n            if (!gs?.instance?.meshInstance?.aabb) {\n                if (currentHighlightedMarker) {\n                    const m = currentHighlightedMarker.model.material;\n                    m.diffuse  = currentHighlightedMarker.originalColor;\n                    m.emissive = currentHighlightedMarker.originalColor;\n                    m.update();\n                    currentHighlightedMarker.isHighlighted = false;\n                    currentHighlightedMarker = null;\n                    app.renderNextFrame = true;\n                }\n                return;\n            }\n            const tNear = intersectAABB(ray, gs.instance.meshInstance.aabb);\n            if (tNear === null) {\n                if (currentHighlightedMarker) {\n                    const m = currentHighlightedMarker.model.material;\n                    m.diffuse  = currentHighlightedMarker.originalColor;\n                    m.emissive = currentHighlightedMarker.originalColor;\n                    m.update();\n                    currentHighlightedMarker.isHighlighted = false;\n                    currentHighlightedMarker = null;\n                    app.renderNextFrame = true;\n                }\n                return;\n            }\n        \n            // 4) compute hoverPoint on that AABB face\n            const hoverPoint = direction.mulScalar(tNear).add(nearPoint);\n        \n            // 5) move your purple debug sphere\n            if (!window.debugSphere) {\n                window.debugSphere = new Entity('debugSphere');\n                window.debugSphere.addComponent('model', { type: 'sphere' });\n                window.debugSphere.setLocalScale(0.1, 0.1, 0.1);\n                const mat = new StandardMaterial();\n                mat.diffuse           = new Color(0.5, 0, 0.5);\n                mat.emissive          = new Color(0.5, 0, 0.5);\n                mat.emissiveIntensity = 0.8;\n                mat.depthTest         = false;\n                mat.depthWrite        = false;\n                mat.update();\n                window.debugSphere.model.material = mat;\n                window.debugSphere.model.meshInstances.forEach(mi => {\n                    mi.layer     = LAYER_WORLD + 1;\n                    mi.drawOrder = 9999;\n                });\n                app.root.addChild(window.debugSphere);\n            }\n            window.debugSphere.setPosition(hoverPoint.x, hoverPoint.y, hoverPoint.z);\n        \n            // 6) find closest by weighteddistance alone\n            const horizontalWeight = 0.05;\n            let   minDist = Infinity;\n            let   best   = null;\n            window.meshObjects.cameraMarkers.forEach(marker => {\n                const mp = marker.getPosition();\n                const dx = mp.x - hoverPoint.x;\n                const dy = mp.y - hoverPoint.y;\n                const dz = mp.z - hoverPoint.z;\n                const dist = Math.sqrt(\n                    horizontalWeight * (dx*dx + dz*dz) + (dy*dy)\n                );\n                if (dist < minDist) {\n                    minDist = dist;\n                    best    = marker;\n                }\n            });\n        \n            // 7) highlight only that one\n            window.meshObjects.cameraMarkers.forEach(marker => {\n                const m = marker.model.material;\n                if (marker === best) {\n                    if (!marker.isHighlighted) {\n                        m.diffuse   = new Color(1, 0, 0);\n                        m.emissive  = new Color(1, 0, 0);\n                        m.update();\n                        marker.isHighlighted = true;\n                        currentHighlightedMarker = marker;\n                    }\n                } else if (marker.isHighlighted) {\n                    m.diffuse   = marker.originalColor;\n                    m.emissive  = marker.originalColor;\n                    m.update();\n                    marker.isHighlighted = false;\n                }\n            });\n        \n            app.renderNextFrame = true;\n        });\n        \n        canvas.addEventListener('click', (event) => {\n            if (!cameraDetectionEnabled) return;\n        \n            // 1) mousecanvas coords\n            const rect = canvas.getBoundingClientRect();\n            const mouseX = event.clientX - rect.left;\n            const mouseY = event.clientY - rect.top;\n        \n            // 2) build pick ray\n            const nearPoint = new Vec3();\n            const farPoint = new Vec3();\n            camera.camera.screenToWorld(mouseX, mouseY, camera.camera.nearClip, nearPoint);\n            camera.camera.screenToWorld(mouseX, mouseY, camera.camera.farClip, farPoint);\n            const direction = farPoint.sub(nearPoint).normalize();\n            const ray = new Ray(nearPoint, direction);\n        \n            // 3) intersect AABB\n            const gs = app.root.findComponent('gsplat');\n            if (!gs?.instance?.meshInstance?.aabb) return;\n            const tNear = intersectAABB(ray, gs.instance.meshInstance.aabb);\n            \n            // CHANGE: Return early if no intersection is found\n            if (tNear === null) {\n                // Remove any existing popup when clicking empty space\n                const old = document.getElementById('cameraPopup');\n                if (old) old.remove();\n                return; // Don't render a frame when clicking on empty space\n            }\n        \n            // 4) compute clickPoint\n            const clickPoint = direction.mulScalar(tNear).add(nearPoint);\n        \n            // 5) move debug sphere\n            if (window.debugSphere) {\n                window.debugSphere.setPosition(clickPoint.x, clickPoint.y, clickPoint.z);\n            }\n        \n            // 6) pick purely on distance\n            const horizontalWeight = 0.05;\n            let minDist = Infinity;\n            let best = null;\n            window.meshObjects.cameraMarkers.forEach(marker => {\n                const mp = marker.getPosition();\n                const dx = mp.x - clickPoint.x;\n                const dy = mp.y - clickPoint.y;\n                const dz = mp.z - clickPoint.z;\n                const dist = Math.sqrt(\n                    horizontalWeight * (dx*dx + dz*dz) + (dy*dy)\n                );\n                if (dist < minDist) {\n                    minDist = dist;\n                    best = marker;\n                }\n            });\n        \n            // CODE FOR THE POPUP IMAGE\n            if (best) {\n                console.log(\n                    \"Selected camera marker:\", best.name,\n                    \"with image:\", best.cameraData.imageName\n                );\n\n                // 1. remove old popup (if any)\n                const old = document.getElementById('cameraPopup');\n                if (old) old.remove();\n\n                // 2. build new <img> container with expand button\n                const container = document.createElement('div');\n                container.id = 'cameraPopup';\n                container.style.position = 'absolute';\n                container.style.left = `${event.clientX}px`;\n                container.style.top = `${event.clientY}px`;\n                container.style.display = 'flex';\n                container.style.flexDirection = 'column';\n                container.style.border = '1px solid rgba(0,0,0,0.5)';\n                container.style.boxShadow = '0 0 6px rgba(0,0,0,0.3)';\n                container.style.background = 'white';\n                \n                // Add the thumbnail image\n                const img = document.createElement('img');\n                img.src = `images/${best.cameraData.imageName}`;\n                img.style.width = '100px';\n                img.style.height = 'auto';\n                img.style.pointerEvents = 'none';\n                container.appendChild(img);\n                \n                // Add expand button\n                const expandBtn = document.createElement('button');\n                expandBtn.textContent = 'View Full Size';\n                expandBtn.style.padding = '4px';\n                expandBtn.style.margin = '4px';\n                expandBtn.style.cursor = 'pointer';\n                expandBtn.style.background = '#007bff';\n                expandBtn.style.color = 'white';\n                expandBtn.style.border = 'none';\n                expandBtn.style.borderRadius = '4px';\n                \n                // Function to find nearest camera marker in a direction\n                const findNearestMarkerInDirection = (currentMarker, isRightDirection) => {\n                    const currentPos = currentMarker.getPosition();\n                    // Get all markers except the current one\n                    const otherMarkers = window.meshObjects.cameraMarkers.filter(m => m !== currentMarker);\n                    \n                    if (otherMarkers.length === 0) return null;\n                    \n                    // Sort markers by angular position relative to the center\n                    const center = computeMarkersCenter();\n                    \n                    // Calculate current marker's angle from center\n                    const currentDx = currentPos.x - center.x;\n                    const currentDz = currentPos.z - center.z;\n                    const currentAngle = Math.atan2(currentDz, currentDx);\n                    \n                    // Calculate angles for all other markers\n                    const markersWithAngles = otherMarkers.map(marker => {\n                        const pos = marker.getPosition();\n                        const dx = pos.x - center.x;\n                        const dz = pos.z - center.z;\n                        let angle = Math.atan2(dz, dx);\n                        \n                        // Calculate angular difference (considering circular wrap-around)\n                        let diff = angle - currentAngle;\n                        if (diff > Math.PI) diff -= 2 * Math.PI;\n                        if (diff < -Math.PI) diff += 2 * Math.PI;\n                        \n                        return {\n                            marker,\n                            angle,\n                            diff\n                        };\n                    });\n                    \n                    // Filter markers based on direction (positive diff is right/clockwise)\n                    const filteredMarkers = markersWithAngles.filter(m => \n                        isRightDirection ? m.diff > 0 : m.diff < 0\n                    );\n                    \n                    // If no markers in desired direction, wrap around (take the furthest in opposite direction)\n                    if (filteredMarkers.length === 0) {\n                        const oppositeDirMarkers = markersWithAngles.filter(m => \n                            isRightDirection ? m.diff < 0 : m.diff > 0\n                        );\n                        \n                        if (oppositeDirMarkers.length === 0) return null;\n                        \n                        // Sort by abs angle difference in descending order (furthest first)\n                        oppositeDirMarkers.sort((a, b) => Math.abs(b.diff) - Math.abs(a.diff));\n                        return oppositeDirMarkers[0].marker;\n                    }\n                    \n                    // Sort by abs angle difference in ascending order (nearest first)\n                    filteredMarkers.sort((a, b) => Math.abs(a.diff) - Math.abs(b.diff));\n                    return filteredMarkers[0].marker;\n                };\n                \n                // Add click handler for the expand button\n                expandBtn.addEventListener('click', (e) => {\n                    e.stopPropagation();\n                    \n                    // Create fullscreen overlay\n                    const overlay = document.createElement('div');\n                    overlay.id = 'fullscreenOverlay';\n                    overlay.style.position = 'fixed';\n                    overlay.style.top = '0';\n                    overlay.style.left = '0';\n                    overlay.style.width = '100%';\n                    overlay.style.height = '100%';\n                    overlay.style.backgroundColor = 'rgba(0,0,0,0.9)';\n                    overlay.style.zIndex = '10000';\n                    overlay.style.display = 'flex';\n                    overlay.style.alignItems = 'center';\n                    overlay.style.justifyContent = 'center';\n                    \n                    // Create close button\n                    const closeBtn = document.createElement('button');\n                    closeBtn.textContent = 'Close';\n                    closeBtn.style.position = 'absolute';\n                    closeBtn.style.top = '20px';\n                    closeBtn.style.right = '20px';\n                    closeBtn.style.padding = '10px 20px';\n                    closeBtn.style.background = '#007bff';\n                    closeBtn.style.color = 'white';\n                    closeBtn.style.border = 'none';\n                    closeBtn.style.borderRadius = '4px';\n                    closeBtn.style.cursor = 'pointer';\n                    closeBtn.style.fontSize = '16px';\n                    closeBtn.addEventListener('click', () => {\n                        document.body.removeChild(overlay);\n                    });\n                    \n                    // Create image container for zoom functionality\n                    const imgContainer = document.createElement('div');\n                    imgContainer.style.position = 'relative';\n                    imgContainer.style.width = '80%';\n                    imgContainer.style.height = '80%';\n                    imgContainer.style.display = 'flex';\n                    imgContainer.style.justifyContent = 'center';\n                    imgContainer.style.alignItems = 'center';\n                    imgContainer.style.overflow = 'hidden';\n                    \n                    // Current marker reference for navigation\n                    let currentMarker = best;\n                    \n                    // Create image wrapper for panning\n                    const imgWrapper = document.createElement('div');\n                    imgWrapper.style.position = 'relative';\n                    imgWrapper.style.overflow = 'hidden';\n                    imgWrapper.style.width = '100%';\n                    imgWrapper.style.height = '100%';\n                    imgWrapper.style.display = 'flex';\n                    imgWrapper.style.justifyContent = 'center';\n                    imgWrapper.style.alignItems = 'center';\n                    \n                    // Create fullsize image\n                    const fullImg = document.createElement('img');\n                    fullImg.src = `images/${currentMarker.cameraData.imageName}`;\n                    fullImg.style.maxWidth = '100%';\n                    fullImg.style.maxHeight = '100%';\n                    fullImg.style.objectFit = 'contain';\n                    fullImg.style.transformOrigin = 'center center';\n                    \n                    // Zoom and pan variables\n                    let scale = 1;\n                    let posX = 0;\n                    let posY = 0;\n                    let startPosX = 0;\n                    let startPosY = 0;\n                    let startClientX = 0;\n                    let startClientY = 0;\n                    let isDragging = false;\n                    \n                    // Function to update transform\n                    const updateTransform = () => {\n                        fullImg.style.transform = `translate(${posX}px, ${posY}px) scale(${scale})`;\n                    };\n                    \n                    // Function to update image when changing\n                    const updateFullImage = () => {\n                        fullImg.src = `images/${currentMarker.cameraData.imageName}`;\n                        // Reset zoom and position\n                        scale = 1;\n                        posX = 0;\n                        posY = 0;\n                        updateTransform();\n                    };\n                    \n                    // Mouse wheel zoom\n                    imgWrapper.addEventListener('wheel', (e) => {\n                        e.preventDefault();\n                        \n                        // Get mouse position relative to image\n                        const rect = fullImg.getBoundingClientRect();\n                        const mouseX = e.clientX - rect.left;\n                        const mouseY = e.clientY - rect.top;\n                        \n                        // Calculate zoom change\n                        const delta = e.deltaY > 0 ? 0.9 : 1.1;\n                        const newScale = Math.max(1, Math.min(5, scale * delta));\n                        \n                        if (newScale !== scale) {\n                            // Calculate new position to zoom at mouse point\n                            const scaleRatio = newScale / scale;\n                            const newPosX = mouseX - (mouseX - posX) * scaleRatio;\n                            const newPosY = mouseY - (mouseY - posY) * scaleRatio;\n                            \n                            // Update state\n                            scale = newScale;\n                            \n                            // Only allow panning when zoomed in\n                            if (scale > 1) {\n                                posX = newPosX;\n                                posY = newPosY;\n                            } else {\n                                posX = 0;\n                                posY = 0;\n                            }\n                            \n                            updateTransform();\n                        }\n                    });\n                    \n                    // Mouse down for panning\n                    imgWrapper.addEventListener('mousedown', (e) => {\n                        // Only allow panning when zoomed in\n                        if (scale <= 1) return;\n                        \n                        isDragging = true;\n                        startClientX = e.clientX;\n                        startClientY = e.clientY;\n                        startPosX = posX;\n                        startPosY = posY;\n                        imgWrapper.style.cursor = 'grabbing';\n                    });\n                    \n                    // Mouse move for panning\n                    document.addEventListener('mousemove', (e) => {\n                        if (!isDragging) return;\n                        \n                        // Calculate new position\n                        posX = startPosX + (e.clientX - startClientX);\n                        posY = startPosY + (e.clientY - startClientY);\n                        \n                        updateTransform();\n                    });\n                    \n                    // Mouse up to end panning\n                    document.addEventListener('mouseup', () => {\n                        isDragging = false;\n                        imgWrapper.style.cursor = scale > 1 ? 'grab' : 'default';\n                    });\n                    \n                    // Double click to reset zoom\n                    imgWrapper.addEventListener('dblclick', () => {\n                        scale = 1;\n                        posX = 0;\n                        posY = 0;\n                        updateTransform();\n                        imgWrapper.style.cursor = 'default';\n                    });\n                    \n                    // Fix: Completely revise the findNearestMarkerInDirection function\n                    const findNearestMarkerInDirection = (currentMarker, isRightDirection) => {\n                        const currentPos = currentMarker.getPosition();\n                        // Get all markers except the current one\n                        const otherMarkers = window.meshObjects.cameraMarkers.filter(m => m !== currentMarker);\n                        \n                        if (otherMarkers.length === 0) return null;\n                        \n                        // Get camera viewing direction (assuming forward is negative Z in world space)\n                        // Use the center of all markers as the central reference point\n                        const center = computeMarkersCenter();\n                        \n                        // Vector from center to current marker\n                        const markerVec = new Vec3(\n                            currentPos.x - center.x,\n                            0, // Ignore Y for horizontal navigation\n                            currentPos.z - center.z\n                        ).normalize();\n                        \n                        // Compute a right vector (perpendicular to marker vector)\n                        // Assuming Y is up, cross with world up to get right vector\n                        const worldUp = new Vec3(0, 1, 0);\n                        const rightVec = new Vec3().cross(worldUp, markerVec).normalize();\n                        \n                        // For each marker, compute how far it is in the right or left direction\n                        const markersWithDirectionality = otherMarkers.map(marker => {\n                            const pos = marker.getPosition();\n                            \n                            // Vector from current marker to other marker\n                            const toMarkerVec = new Vec3(\n                                pos.x - currentPos.x,\n                                0, // Ignore Y for horizontal navigation\n                                pos.z - currentPos.z\n                            );\n                            \n                            // If toMarkerVec is zero length, skip this marker\n                            if (toMarkerVec.length() < 0.001) return { marker, score: -Infinity };\n                            \n                            toMarkerVec.normalize();\n                            \n                            // Dot product with right vector gives how far right the marker is\n                            // Positive is right, negative is left\n                            const rightAmount = rightVec.dot(toMarkerVec);\n                            \n                            // Only consider markers that are in the correct half-space\n                            const forwardAmount = markerVec.dot(toMarkerVec);\n                            \n                            // Distance factor (prefer closer markers)\n                            const distance = Math.sqrt(\n                                Math.pow(pos.x - currentPos.x, 2) +\n                                Math.pow(pos.z - currentPos.z, 2)\n                            );\n                            \n                            // Score combines direction and distance\n                            // Higher score = better match (more in the right direction and closer)\n                            const directionScore = isRightDirection ? rightAmount : -rightAmount;\n                            \n                            // We want markers that are:\n                            // 1. In the correct direction (right or left)\n                            // 2. More forward than backward\n                            // 3. Closer rather than farther\n                            const score = directionScore * 3 + forwardAmount * 2 - (distance * 0.1);\n                            \n                            return { marker, score };\n                        });\n                        \n                        // Find the marker with the highest score\n                        markersWithDirectionality.sort((a, b) => b.score - a.score);\n                        \n                        // Return the best marker, or null if none found\n                        return markersWithDirectionality.length > 0 && \n                            markersWithDirectionality[0].score > -1 ? \n                            markersWithDirectionality[0].marker : null;\n                    };\n                    \n                    // Add navigation arrows\n                    const createArrow = (direction) => {\n                        const arrow = document.createElement('div');\n                        arrow.style.position = 'absolute';\n                        arrow.style.top = '50%';\n                        arrow.style[direction === 'left' ? 'left' : 'right'] = '20px';\n                        arrow.style.width = '50px';\n                        arrow.style.height = '50px';\n                        arrow.style.background = 'rgba(255, 255, 255, 0.3)';\n                        arrow.style.borderRadius = '50%';\n                        arrow.style.display = 'flex';\n                        arrow.style.alignItems = 'center';\n                        arrow.style.justifyContent = 'center';\n                        arrow.style.cursor = 'pointer';\n                        arrow.style.transform = 'translateY(-50%)';\n                        arrow.style.fontSize = '24px';\n                        arrow.style.fontWeight = 'bold';\n                        arrow.style.color = 'white';\n                        arrow.style.userSelect = 'none';\n                        arrow.textContent = direction === 'left' ? '' : '';\n                        \n                        arrow.addEventListener('mouseenter', () => {\n                            arrow.style.background = 'rgba(255, 255, 255, 0.5)';\n                        });\n                        \n                        arrow.addEventListener('mouseleave', () => {\n                            arrow.style.background = 'rgba(255, 255, 255, 0.3)';\n                        });\n                        \n                        arrow.addEventListener('click', () => {\n                            // Left means go to marker on the left, right means go to marker on the right\n                            const nextMarker = findNearestMarkerInDirection(currentMarker, direction === 'right');\n                            \n                            if (nextMarker) {\n                                // Also highlight the selected marker in the 3D view\n                                window.meshObjects.cameraMarkers.forEach(marker => {\n                                    if (marker.isHighlighted && marker !== nextMarker) {\n                                        const m = marker.model.material;\n                                        m.diffuse = marker.originalColor;\n                                        m.emissive = marker.originalColor;\n                                        m.update();\n                                        marker.isHighlighted = false;\n                                    }\n                                });\n                                \n                                // Highlight the new marker\n                                const m = nextMarker.model.material;\n                                m.diffuse = new Color(1, 0, 0);\n                                m.emissive = new Color(1, 0, 0);\n                                m.update();\n                                nextMarker.isHighlighted = true;\n                                \n                                // Update current marker and image\n                                currentMarker = nextMarker;\n                                updateFullImage();\n                                \n                                // Force a render to show the highlighted marker\n                                app.renderNextFrame = true;\n                            }\n                        });\n                        \n                        return arrow;\n                    };\n                    \n                    const leftArrow = createArrow('left');\n                    const rightArrow = createArrow('right');\n                    \n                    // Add keyboard navigation\n                    const handleKeyDown = (e) => {\n                        switch (e.key) {\n                            case 'ArrowLeft':\n                                const leftMarker = findNearestMarkerInDirection(currentMarker, false);\n                                if (leftMarker) {\n                                    // Update highlighted marker\n                                    window.meshObjects.cameraMarkers.forEach(marker => {\n                                        if (marker.isHighlighted && marker !== leftMarker) {\n                                            const m = marker.model.material;\n                                            m.diffuse = marker.originalColor;\n                                            m.emissive = marker.originalColor;\n                                            m.update();\n                                            marker.isHighlighted = false;\n                                        }\n                                    });\n                                    \n                                    const m = leftMarker.model.material;\n                                    m.diffuse = new Color(1, 0, 0);\n                                    m.emissive = new Color(1, 0, 0);\n                                    m.update();\n                                    leftMarker.isHighlighted = true;\n                                    \n                                    currentMarker = leftMarker;\n                                    updateFullImage();\n                                    app.renderNextFrame = true;\n                                }\n                                break;\n                            case 'ArrowRight':\n                                const rightMarker = findNearestMarkerInDirection(currentMarker, true);\n                                if (rightMarker) {\n                                    // Update highlighted marker\n                                    window.meshObjects.cameraMarkers.forEach(marker => {\n                                        if (marker.isHighlighted && marker !== rightMarker) {\n                                            const m = marker.model.material;\n                                            m.diffuse = marker.originalColor;\n                                            m.emissive = marker.originalColor;\n                                            m.update();\n                                            marker.isHighlighted = false;\n                                        }\n                                    });\n                                    \n                                    const m = rightMarker.model.material;\n                                    m.diffuse = new Color(1, 0, 0);\n                                    m.emissive = new Color(1, 0, 0);\n                                    m.update();\n                                    rightMarker.isHighlighted = true;\n                                    \n                                    currentMarker = rightMarker;\n                                    updateFullImage();\n                                    app.renderNextFrame = true;\n                                }\n                                break;\n                            case 'Escape':\n                                document.body.removeChild(overlay);\n                                document.removeEventListener('keydown', handleKeyDown);\n                                break;\n                            case '0':\n                            case 'r':\n                                // Reset zoom\n                                scale = 1;\n                                posX = 0;\n                                posY = 0;\n                                updateTransform();\n                                break;\n                        }\n                    };\n                    \n                    document.addEventListener('keydown', handleKeyDown);\n                    \n                    // Clean up event listeners when overlay is removed\n                    overlay.addEventListener('remove', () => {\n                        document.removeEventListener('keydown', handleKeyDown);\n                        document.removeEventListener('mousemove', null);\n                        document.removeEventListener('mouseup', null);\n                    });\n                    \n                    // Assemble the components\n                    imgWrapper.appendChild(fullImg);\n                    imgContainer.appendChild(imgWrapper);\n                    \n                    overlay.appendChild(closeBtn);\n                    overlay.appendChild(imgContainer);\n                    overlay.appendChild(leftArrow);\n                    overlay.appendChild(rightArrow);\n                    \n                    // Add zoom instructions\n                    const instructions = document.createElement('div');\n                    instructions.textContent = 'Use mouse wheel to zoom, drag to pan when zoomed in, double-click to reset zoom';\n                    instructions.style.position = 'absolute';\n                    instructions.style.bottom = '20px';\n                    instructions.style.left = '50%';\n                    instructions.style.transform = 'translateX(-50%)';\n                    instructions.style.color = 'white';\n                    instructions.style.background = 'rgba(0, 0, 0, 0.5)';\n                    instructions.style.padding = '8px 16px';\n                    instructions.style.borderRadius = '4px';\n                    instructions.style.fontSize = '14px';\n                    overlay.appendChild(instructions);\n                    \n                    document.body.appendChild(overlay);\n                });\n                \n                container.appendChild(expandBtn);\n                document.body.appendChild(container);\n                \n                // Only request a render frame if we actually found a marker\n                app.renderNextFrame = true;\n            }\n        });\n    }\n\n    // ---------------------------\n    // ROTATION FUNCTIONALITY FOR CAMERA MARKERS\n    // ---------------------------\n    function computeMarkersCenter() {\n        const markers = window.meshObjects.cameraMarkers;\n        if (!markers || markers.length === 0) return new Vec3(0, 0, 0);\n        const center = new Vec3(0, 0, 0);\n        markers.forEach(marker => {\n            center.add(marker.getPosition());\n        });\n        center.scale(1 / markers.length);\n        return center;\n    }\n    \n    function rotateCameraMarkers(angle) {\n        const markers = window.meshObjects.cameraMarkers;\n        if (!markers || markers.length === 0) return;\n        const center = computeMarkersCenter();\n        markers.forEach(marker => {\n            const pos = marker.getPosition();\n            const offset = pos.clone().sub(center);\n            const cos = Math.cos(angle);\n            const sin = Math.sin(angle);\n            const newX = offset.x * cos - offset.z * sin;\n            const newZ = offset.x * sin + offset.z * cos;\n            const newPos = new Vec3(newX, offset.y, newZ).add(center);\n            marker.setPosition(newPos.x, newPos.y, newPos.z);\n        });\n        app.renderNextFrame = true;\n    }\n\n    function scaleCameraMarkers(scaleFactor) {\n        const markers = window.meshObjects.cameraMarkers;\n        if (!markers || markers.length === 0) return;\n        const center = computeMarkersCenter();\n        markers.forEach(marker => {\n            const pos = marker.getPosition(); // current position as a Vec3\n            const offset = pos.clone().sub(center); // vector from center to marker\n            // Compute the new position: center + (offset * scaleFactor)\n            const newOffset = offset.clone().mulScalar(scaleFactor);\n            const newPos = center.clone().add(newOffset);\n            marker.setPosition(newPos.x, newPos.y, newPos.z);\n        });\n        app.renderNextFrame = true;\n    }\n    \n    const rotateLeftButton = createButton(\"Rotate Left\", \"bottom-left\", () => {\n        const angle = -10 * Math.PI / 180;\n        rotateCameraMarkers(angle);\n    });\n    rotateLeftButton.style.left = \"10px\";\n    rotateLeftButton.style.bottom = \"60px\";\n    \n    const rotateRightButton = createButton(\"Rotate Right\", \"bottom-left\", () => {\n        const angle = 10 * Math.PI / 180;\n        rotateCameraMarkers(angle);\n    });\n    rotateRightButton.style.left = \"150px\";\n    rotateRightButton.style.bottom = \"60px\";\n\n\n\n    const scaleUpButton = createButton(\"Scale +\", \"bottom-left\", () => {\n        // Increase scale by 10%\n        scaleCameraMarkers(1.1);\n    });\n    scaleUpButton.style.left = \"10px\";\n    scaleUpButton.style.bottom = \"10px\";  // Adjust as needed so they are below the rotate buttons\n    \n    const scaleDownButton = createButton(\"Scale -\", \"bottom-left\", () => {\n        // Decrease scale by 10%\n        scaleCameraMarkers(0.9);\n    });\n    scaleDownButton.style.left = \"150px\";\n    scaleDownButton.style.bottom = \"10px\";  // Adjust as needed so they are below the rotate buttons\n    \n    // Function to export camera positions to a JSON file\n    function exportCameraPositions() {\n        try {\n            // Get all camera markers\n            const markers = window.meshObjects.cameraMarkers;\n            if (!markers || markers.length === 0) {\n                console.error(\"No camera markers to export\");\n                alert(\"No camera markers to export!\");\n                return;\n            }\n\n            // Build the export data structure\n            const exportData = markers.map(marker => {\n                const pos = marker.getPosition();\n                const cameraData = marker.cameraData;\n                \n                return {\n                    imageId: cameraData.imageId,\n                    position: {\n                        x: pos.x,\n                        y: pos.y,\n                        z: pos.z\n                    },\n                    quaternion: cameraData.quaternion || { qw: 1, qx: 0, qy: 0, qz: 0 },\n                    cameraId: cameraData.cameraId,\n                    imageName: cameraData.imageName,\n                    cluster: cameraData.cluster || -1\n                };\n            });\n\n            // Convert to JSON string with nice formatting\n            const jsonString = JSON.stringify(exportData, null, 2);\n            \n            // Create a blob and download link\n            const blob = new Blob([jsonString], { type: 'application/json' });\n            const url = URL.createObjectURL(blob);\n            \n            // Create and trigger download\n            const a = document.createElement('a');\n            a.href = url;\n            a.download = 'camera_positions.json';\n            document.body.appendChild(a);\n            a.click();\n            \n            // Clean up\n            setTimeout(() => {\n                document.body.removeChild(a);\n                URL.revokeObjectURL(url);\n            }, 100);\n            \n            console.log(`Exported ${exportData.length} camera positions`);\n        } catch (err) {\n            console.error(\"Error exporting camera positions:\", err);\n            alert(\"Error exporting camera positions: \" + err.message);\n        }\n    }\n\n    // Add export button to the UI (JSON only)\n    function addExportButton(app) {\n        // Export as JSON button\n        const exportJsonButton = document.createElement('button');\n        exportJsonButton.textContent = 'Export Cameras';\n        exportJsonButton.style.position = 'absolute';\n        exportJsonButton.style.zIndex = '1000';\n        exportJsonButton.style.padding = '8px 16px';\n        exportJsonButton.style.backgroundColor = '#007bff';\n        exportJsonButton.style.color = 'white';\n        exportJsonButton.style.border = 'none';\n        exportJsonButton.style.borderRadius = '4px';\n        exportJsonButton.style.cursor = 'pointer';\n        exportJsonButton.style.bottom = '60px';\n        exportJsonButton.style.right = '10px';\n        exportJsonButton.addEventListener('click', exportCameraPositions);\n        document.body.appendChild(exportJsonButton);\n        \n        app.renderNextFrame = true;\n    }\n\n});",Cy="import { BoundingBox, Color, Mat4, Script, Vec3, Entity, StandardMaterial, Quat, BLEND_NONE, BLEND_NORMAL, LAYER_WORLD, Ray } from 'playcanvas';\n\nimport { CubicSpline } from 'spline';\n\nfunction logWithTimestamp(message) {\n    const now = new Date();\n    const timestamp = `${now.getHours()}:${now.getMinutes()}:${now.getSeconds()}.${now.getMilliseconds()}`;\n    console.log(`[${timestamp}] ${message}`);\n}\n\n//  AABB  Ray intersection helper \nfunction intersectAABB(ray, aabb) {\n    // Inverse of ray direction\n    const inv = new Vec3(1 / ray.direction.x, 1 / ray.direction.y, 1 / ray.direction.z);\n    // Min/max corners\n    const mn = aabb.center.clone().sub(aabb.halfExtents);\n    const mx = aabb.center.clone().add(aabb.halfExtents);\n\n    let tmin = (mn.x - ray.origin.x) * inv.x;\n    let tmax = (mx.x - ray.origin.x) * inv.x;\n    if (inv.x < 0) [tmin, tmax] = [tmax, tmin];\n\n    let tymin = (mn.y - ray.origin.y) * inv.y;\n    let tymax = (mx.y - ray.origin.y) * inv.y;\n    if (inv.y < 0) [tymin, tymax] = [tymax, tymin];\n\n    if (tmin > tymax || tymin > tmax) return null;\n    tmin = Math.max(tmin, tymin);\n    tmax = Math.min(tmax, tymax);\n\n    let tzmin = (mn.z - ray.origin.z) * inv.z;\n    let tzmax = (mx.z - ray.origin.z) * inv.z;\n    if (inv.z < 0) [tzmin, tzmax] = [tzmax, tzmin];\n\n    if (tmin > tzmax || tzmin > tmax) return null;\n    tmin = Math.max(tmin, tzmin);\n\n    // Only care about the first entry (front face)\n    return tmin >= 0 ? tmin : null;\n}\n\nconst nearlyEquals = (a, b, epsilon = 1e-4) => {\n    return !a.some((v, i) => Math.abs(v - b[i]) >= epsilon);\n};\n\nconst url = new URL(location.href);\n\nconst params = {\n    noui: url.searchParams.has('noui'),\n    noanim: url.searchParams.has('noanim'),\n    posterUrl: url.searchParams.get('poster')\n};\n\n// display a blurry poster image which resolves to sharp during loading\nclass Poster {\n    constructor(url) {\n        const blur = (progress) => `blur(${Math.floor((100 - progress) * 0.4)}px)`;\n\n        const element = document.getElementById('poster');\n        element.style.backgroundImage = `url(${url})`;\n        element.style.display = 'block';\n        element.style.filter = blur(0);\n\n        this.progress = (progress) => {\n            element.style.filter = blur(progress);\n        };\n\n        this.hide = () => {\n            element.style.display = 'none';\n        };\n    }\n}\n\nconst poster = params.posterUrl && new Poster(params.posterUrl);\n\nclass FrameScene extends Script {\n    initialize() {\n        const { settings } = this;\n        const { camera, animTracks } = settings;\n        const { position, target } = camera;\n\n        this.position = position && new Vec3(position);\n        this.target = target && new Vec3(target);\n\n        // construct camera animation track\n        if (animTracks?.length > 0 && settings.camera.startAnim === 'animTrack') {\n            const track = animTracks.find(track => track.name === camera.animTrack);\n            if (track) {\n                const { keyframes, duration } = track;\n                const { times, values } = keyframes;\n                const { position, target } = values;\n\n                // construct the points array containing position and target\n                const points = [];\n                for (let i = 0; i < times.length; i++) {\n                    points.push(position[i * 3], position[i * 3 + 1], position[i * 3 + 2]);\n                    points.push(target[i * 3], target[i * 3 + 1], target[i * 3 + 2]);\n                }\n\n                this.cameraAnim = {\n                    time: 0,\n                    spline: CubicSpline.fromPointsLooping(duration, times, points),\n                    track,\n                    result: []\n                };\n            }\n        }\n    }\n\n    frameScene(bbox, smooth = true) {\n        const sceneSize = bbox.halfExtents.length();\n        const distance = sceneSize / Math.sin(this.entity.camera.fov / 180 * Math.PI * 0.5);\n        this.entity.script.cameraControls.sceneSize = sceneSize;\n        this.entity.script.cameraControls.focus(bbox.center, new Vec3(2, 1, 2).normalize().mulScalar(distance).add(bbox.center), smooth);\n    }\n\n    resetCamera(bbox, smooth = true) {\n        const sceneSize = bbox.halfExtents.length();\n        this.entity.script.cameraControls.sceneSize = sceneSize * 0.2;\n        this.entity.script.cameraControls.focus(this.target ?? Vec3.ZERO, this.position ?? new Vec3(2, 1, 2), smooth);\n    }\n\n    initCamera() {\n        const { app } = this;\n        const { graphicsDevice } = app;\n        let animating = false;\n        let animationTimer = 0;\n\n        // get the gsplat component\n        const gsplatComponent = app.root.findComponent('gsplat');\n\n        // calculate the bounding box\n        const bbox = gsplatComponent?.instance?.meshInstance?.aabb ?? new BoundingBox();\n        if (bbox.halfExtents.length() > 100 || this.position || this.target) {\n            this.resetCamera(bbox, false);\n        } else {\n            this.frameScene(bbox, false);\n        }\n\n        const cancelAnimation = () => {\n            if (animating) {\n                animating = false;\n\n                // copy current camera position and target\n                const r = this.cameraAnim.result;\n                this.entity.script.cameraControls.focus(\n                    new Vec3(r[3], r[4], r[5]),\n                    new Vec3(r[0], r[1], r[2]),\n                    false\n                );\n            }\n        };\n\n        // listen for interaction events\n        const events = [ 'wheel', 'pointerdown', 'contextmenu' ];\n        const handler = (e) => {\n            cancelAnimation();\n            events.forEach(event => app.graphicsDevice.canvas.removeEventListener(event, handler));\n        };\n        events.forEach(event => app.graphicsDevice.canvas.addEventListener(event, handler));\n\n        window.addEventListener('keydown', (e) => {\n            if (e.ctrlKey || e.altKey || e.metaKey) return;\n\n            switch (e.key) {\n                case 'f':\n                    cancelAnimation();\n                    this.frameScene(bbox);\n                    break;\n                case 'r':\n                    cancelAnimation();\n                    this.resetCamera(bbox);\n                    break;\n            }\n        });\n\n        app.on('update', (deltaTime) => {\n            // handle camera animation\n            if (this.cameraAnim && animating && !params.noanim) {\n                const { cameraAnim } = this;\n                const { spline, track, result } = cameraAnim;\n\n                // update animation timer\n                animationTimer += deltaTime;\n\n                // update the track cursor\n                if (animationTimer < 5) {\n                    // ease in\n                    cameraAnim.time += deltaTime * Math.pow(animationTimer / 5, 0.5);\n                } else {\n                    cameraAnim.time += deltaTime;\n                }\n\n                if (cameraAnim.time >= track.duration) {\n                    switch (track.loopMode) {\n                        case 'none': cameraAnim.time = track.duration; break;\n                        case 'repeat': cameraAnim.time = cameraAnim.time % track.duration; break;\n                        case 'pingpong': cameraAnim.time = cameraAnim.time % (track.duration * 2); break;\n                    }\n                }\n\n                // evaluate the spline\n                spline.evaluate(cameraAnim.time > track.duration ? track.duration - cameraAnim.time : cameraAnim.time, result);\n\n                // set camera\n                this.entity.setPosition(result[0], result[1], result[2]);\n                this.entity.lookAt(result[3], result[4], result[5]);\n            }\n        });\n\n        const prevProj = new Mat4();\n        const prevWorld = new Mat4();\n\n        app.on('framerender', () => {\n            if (!app.autoRender && !app.renderNextFrame) {\n                const world = this.entity.getWorldTransform();\n                if (!nearlyEquals(world.data, prevWorld.data)) {\n                    app.renderNextFrame = true;\n                }\n\n                const proj = this.entity.camera.projectionMatrix;\n                if (!nearlyEquals(proj.data, prevProj.data)) {\n                    app.renderNextFrame = true;\n                }\n\n                if (app.renderNextFrame) {\n                    prevWorld.copy(world);\n                    prevProj.copy(proj);\n                }\n            }\n        });\n\n        // wait for first gsplat sort\n        const handle = gsplatComponent?.instance?.sorter?.on('updated', () => {\n            handle.off();\n\n            // request frame render\n            app.renderNextFrame = true;\n\n            // wait for first render to complete\n            const frameHandle = app.on('frameend', () => {\n                frameHandle.off();\n\n                // hide loading indicator\n                document.getElementById('loadingWrap').classList.add('hidden');\n\n                // fade out poster\n                poster?.hide();\n\n                // start animating once the first frame is rendered\n                if (this.cameraAnim) {\n                    animating = true;\n                }\n\n                // emit first frame event on window\n                window.firstFrame?.();\n            });\n        });\n\n        const updateHorizontalFov = (width, height) => {\n            this.entity.camera.horizontalFov = width > height;\n        };\n\n        // handle fov on canvas resize\n        graphicsDevice.on('resizecanvas', (width, height) => {\n            updateHorizontalFov(width, height);\n            app.renderNextFrame = true;\n        });\n\n        // configure on-demand rendering\n        app.autoRender = false;\n        updateHorizontalFov(graphicsDevice.width, graphicsDevice.height);\n    }\n\n    postInitialize() {\n        const assets = this.app.assets.filter(asset => asset.type === 'gsplat');\n        if (assets.length > 0) {\n            const asset = assets[0];\n            if (asset.loaded) {\n                this.initCamera();\n            } else {\n                asset.on('load', () => {\n                    this.initCamera();\n                });\n            }\n        }\n    }\n}\n\ndocument.addEventListener('DOMContentLoaded', async () => {\n    const appElement = await document.querySelector('pc-app').ready();\n    const cameraElement = await document.querySelector('pc-entity[name=\"camera\"]').ready();\n\n    const app = await appElement.app;\n    const camera = cameraElement.entity;\n    const settings = await window.settings;\n\n    // Store reference to camera for later use with click detection\n    window.appCamera = camera;\n\n    camera.camera.clearColor = new Color(settings.background.color);\n    camera.camera.fov = settings.camera.fov;\n    camera.script.create(FrameScene, {\n        properties: { settings }\n    });\n\n    // Initialize structure to store camera markers\n    window.cameraData = [];\n\n    // Auto-load camera positions from camera_positions.json\n    loadCameraPositions();\n\n    // Add click-to-view functionality\n    setupClickToView(app, camera);\n\n    // Update loading indicator\n    const assets = app.assets.filter(asset => asset.type === 'gsplat');\n    if (assets.length > 0) {\n        const asset = assets[0];\n        const loadingText = document.getElementById('loadingText');\n        const loadingBar = document.getElementById('loadingBar');\n        asset.on('progress', (received, length) => {\n            const v = (Math.min(1, received / length) * 100).toFixed(0);\n            loadingText.textContent = `${v}%`;\n            loadingBar.style.backgroundImage = 'linear-gradient(90deg, #F60 0%, #F60 ' + v + '%, white ' + v + '%, white 100%)';\n            poster?.progress(v);\n        });\n    }\n\n    // On entering/exiting AR, we need to set the camera clear color to transparent black\n    let cameraEntity, skyType = null;\n    const clearColor = new Color();\n\n    app.xr.on('start', () => {\n        if (app.xr.type === 'immersive-ar') {\n            cameraEntity = app.xr.camera;\n            clearColor.copy(cameraEntity.camera.clearColor);\n            cameraEntity.camera.clearColor = new Color(0, 0, 0, 0);\n\n            const sky = document.querySelector('pc-sky');\n            if (sky && sky.type !== 'none') {\n                skyType = sky.type;\n                sky.type = 'none';\n            }\n\n            app.autoRender = true;\n        }\n    });\n\n    app.xr.on('end', () => {\n        if (app.xr.type === 'immersive-ar') {\n            cameraEntity.camera.clearColor = clearColor;\n\n            const sky = document.querySelector('pc-sky');\n            if (sky) {\n                if (skyType) {\n                    sky.type = skyType;\n                    skyType = null;\n                } else {\n                    sky.removeAttribute('type');\n                }\n            }\n\n            app.autoRender = false;\n        }\n    });\n\n    // Get button and info panel elements\n    const dom = ['arMode', 'vrMode', 'enterFullscreen', 'exitFullscreen', 'info', 'infoPanel', 'buttonContainer'].reduce((acc, id) => {\n        acc[id] = document.getElementById(id);\n        return acc;\n    }, {});\n\n    // AR\n    if (app.xr.isAvailable('immersive-ar')) {\n        dom.arMode.classList.remove('hidden');\n        dom.arMode.addEventListener('click', () => app.xr.start(app.root.findComponent('camera'), 'immersive-ar', 'local-floor'));\n    }\n\n    // VR\n    if (app.xr.isAvailable('immersive-vr')) {\n        dom.vrMode.classList.remove('hidden');\n        dom.vrMode.addEventListener('click', () => app.xr.start(app.root.findComponent('camera'), 'immersive-vr', 'local-floor'));\n    }\n\n    // Fullscreen\n    if (document.documentElement.requestFullscreen && document.exitFullscreen) {\n        dom.enterFullscreen.classList.remove('hidden');\n        dom.enterFullscreen.addEventListener('click', () => document.documentElement.requestFullscreen());\n        dom.exitFullscreen.addEventListener('click', () => document.exitFullscreen());\n        document.addEventListener('fullscreenchange', () => {\n            dom.enterFullscreen.classList[document.fullscreenElement ? 'add' : 'remove']('hidden');\n            dom.exitFullscreen.classList[document.fullscreenElement ? 'remove' : 'add']('hidden');\n        });\n    }\n\n    // Info\n    dom.info.addEventListener('click', () => {\n        dom.infoPanel.classList.toggle('hidden');\n    });\n\n    // Keyboard handler\n    window.addEventListener('keydown', (event) => {\n        if (event.key === 'Escape') {\n            if (app.xr.active) {\n                app.xr.end();\n            }\n            dom.infoPanel.classList.add('hidden');\n            \n            // Also close any open image viewer\n            const overlay = document.getElementById('fullscreenOverlay');\n            if (overlay) {\n                document.body.removeChild(overlay);\n            }\n        }\n    });\n\n    // Hide UI\n    if (params.noui) {\n        dom.buttonContainer.classList.add('hidden');\n    }\n});\n\n// Function to load camera positions from JSON file\nasync function loadCameraPositions() {\n    try {\n        const response = await fetch('camera_positions.json');\n        if (!response.ok) {\n            console.warn('Camera positions file not found, click-to-view functionality will be disabled');\n            return;\n        }\n        \n        const cameraPositions = await response.json();\n        console.log(`Loaded ${cameraPositions.length} camera positions`);\n        \n        // Store camera positions in global variable for access by click handler\n        window.cameraData = cameraPositions;\n        \n        // Create a \"View HD Images\" button to inform users about the functionality\n        createViewHDButton();\n    } catch (err) {\n        console.error('Error loading camera positions:', err);\n    }\n}\n\n// Function to create a button informing users about click-to-view functionality\nfunction createViewHDButton() {\n    if (!window.cameraData || window.cameraData.length === 0) return;\n    \n    const button = document.createElement('button');\n    button.textContent = 'Click Model to View HD Images';\n    button.style.position = 'absolute';\n    button.style.zIndex = '1000';\n    button.style.padding = '8px 16px';\n    button.style.backgroundColor = '#007bff';\n    button.style.color = 'white';\n    button.style.border = 'none';\n    button.style.borderRadius = '4px';\n    button.style.cursor = 'pointer';\n    button.style.top = '10px';\n    button.style.left = '50%';\n    button.style.transform = 'translateX(-50%)';\n    button.style.opacity = '0.8';\n    \n    // Fade out button after 5 seconds\n    setTimeout(() => {\n        button.style.transition = 'opacity 1s ease-out';\n        button.style.opacity = '0';\n        // Remove from DOM after fade out\n        setTimeout(() => {\n            if (button.parentNode) {\n                button.parentNode.removeChild(button);\n            }\n        }, 1000);\n    }, 5000);\n    \n    document.body.appendChild(button);\n}\n\n// Function to setup click-to-view functionality\nfunction setupClickToView(app, camera) {\n    logWithTimestamp(\"Setting up click-to-view functionality\");\n    \n    // Check if camera data is loaded\n    if (!window.cameraData) {\n        console.error(\"No cameraData available in global scope\");\n    } else {\n        logWithTimestamp(`Found ${window.cameraData.length} camera positions`);\n    }\n    \n    // Create debug sphere for indicating click point (invisible initially)\n    window.debugSphere = new Entity('debugSphere');\n    window.debugSphere.addComponent('model', { type: 'sphere' });\n    window.debugSphere.setLocalScale(0.1, 0.1, 0.1);\n    \n    const mat = new StandardMaterial();\n    mat.diffuse = new Color(0.5, 0, 0.5);\n    mat.emissive = new Color(0.5, 0, 0.5);\n    mat.emissiveIntensity = 0.8;\n    mat.depthTest = false;\n    mat.depthWrite = false;\n    mat.update();\n    \n    window.debugSphere.model.material = mat;\n    window.debugSphere.model.meshInstances.forEach(mi => {\n        mi.layer = LAYER_WORLD + 1;\n        mi.drawOrder = 9999;\n    });\n    \n    window.debugSphere.enabled = false; // Hide initially\n    app.root.addChild(window.debugSphere);\n    logWithTimestamp(\"Debug sphere created\");\n    \n    // Setup click handler\n    const canvas = document.querySelector('canvas');\n    if (!canvas) {\n        console.error('Canvas element not found, click-to-view functionality will be disabled');\n        return;\n    }\n    \n    logWithTimestamp(\"Adding click listener to canvas\");\n    canvas.addEventListener('click', (event) => {\n        logWithTimestamp(\"Canvas clicked\");\n        \n        if (!window.cameraData || window.cameraData.length === 0) {\n            console.error(\"No camera data available for click detection\");\n            return;\n        }\n        \n        // Mouse coords relative to canvas\n        const rect = canvas.getBoundingClientRect();\n        const mouseX = event.clientX - rect.left;\n        const mouseY = event.clientY - rect.top;\n        logWithTimestamp(`Click at canvas coordinates: (${mouseX}, ${mouseY})`);\n        \n        // Build pick ray\n        const nearPoint = new Vec3();\n        const farPoint = new Vec3();\n        camera.camera.screenToWorld(mouseX, mouseY, camera.camera.nearClip, nearPoint);\n        camera.camera.screenToWorld(mouseX, mouseY, camera.camera.farClip, farPoint);\n        const direction = farPoint.sub(nearPoint).normalize();\n        const ray = new Ray(nearPoint, direction);\n        \n        logWithTimestamp(`Ray origin: ${nearPoint.toString()}, direction: ${direction.toString()}`);\n        \n        // Intersect with AABB\n        const gs = app.root.findComponent('gsplat');\n        if (!gs) {\n            console.error(\"No gsplat component found\");\n            return;\n        }\n        \n        if (!gs.instance) {\n            console.error(\"gsplat instance not found\");\n            return;\n        }\n        \n        if (!gs.instance.meshInstance) {\n            console.error(\"gsplat meshInstance not found\");\n            return;\n        }\n        \n        if (!gs.instance.meshInstance.aabb) {\n            console.error(\"gsplat aabb not found\");\n            return;\n        }\n        \n        logWithTimestamp(`AABB center: ${gs.instance.meshInstance.aabb.center.toString()}, half extents: ${gs.instance.meshInstance.aabb.halfExtents.toString()}`);\n        \n        const tNear = intersectAABB(ray, gs.instance.meshInstance.aabb);\n        logWithTimestamp(`Ray intersection result: ${tNear}`);\n        \n        if (tNear === null) {\n            logWithTimestamp(\"No intersection with model, removing any existing popup\");\n            // Remove any existing popup when clicking empty space\n            const popup = document.getElementById('cameraPopup');\n            if (popup) popup.remove();\n            \n            return;\n        }\n        \n        // Compute click point\n        const clickPoint = direction.mulScalar(tNear).add(nearPoint);\n        logWithTimestamp(`Click point in 3D space: ${clickPoint.toString()}`);\n        \n        // Show debug sphere at click point\n        window.debugSphere.setPosition(clickPoint.x, clickPoint.y, clickPoint.z);\n        window.debugSphere.enabled = true;\n        app.renderNextFrame = true;\n        logWithTimestamp(\"Debug sphere positioned at click point and enabled\");\n        \n        // Find closest camera by weighted distance\n        const horizontalWeight = 0.05;\n        let minDist = Infinity;\n        let bestCamera = null;\n        \n        window.cameraData.forEach((cameraInfo, index) => {\n            if (!cameraInfo.position) {\n                console.error(`Camera at index ${index} is missing position data:`, cameraInfo);\n                return;\n            }\n            \n            const pos = cameraInfo.position;\n            const dx = pos.x - clickPoint.x;\n            const dy = pos.y - clickPoint.y;\n            const dz = pos.z - clickPoint.z;\n            \n            const dist = Math.sqrt(\n                horizontalWeight * (dx*dx + dz*dz) + (dy*dy)\n            );\n            \n            if (dist < minDist) {\n                minDist = dist;\n                bestCamera = cameraInfo;\n            }\n        });\n        \n        logWithTimestamp(`Best camera search result - distance: ${minDist}, found: ${!!bestCamera}`);\n        \n        if (bestCamera) {\n            logWithTimestamp(`Selected camera: ${JSON.stringify(bestCamera, null, 2)}`);\n            \n            // Remove any existing popup\n            const oldPopup = document.getElementById('cameraPopup');\n            if (oldPopup) {\n                logWithTimestamp(\"Removing existing popup\");\n                oldPopup.remove();\n            }\n            \n            // Create popup with thumbnail and expand button\n            const container = document.createElement('div');\n            container.id = 'cameraPopup';\n            container.style.position = 'absolute';\n            container.style.left = `${event.clientX}px`;\n            container.style.top = `${event.clientY}px`;\n            container.style.display = 'flex';\n            container.style.flexDirection = 'column';\n            container.style.border = '1px solid rgba(0,0,0,0.5)';\n            container.style.boxShadow = '0 0 6px rgba(0,0,0,0.3)';\n            container.style.background = 'white';\n            container.style.zIndex = '9000';\n            container.style.overflow = 'hidden'; // Prevent content from overflowing\n            container.style.padding = '0'; // Remove any padding\n            container.style.maxWidth = '100px'; // Match image width exactly\n\n            // Add thumbnail\n            const img = document.createElement('img');\n            img.src = `images/${bestCamera.imageName}`;\n            img.style.width = '100%'; // Fill the container width completely\n            img.style.height = 'auto';\n            img.style.display = 'block'; // Remove any inline spacing issues\n            img.style.pointerEvents = 'none';\n            img.style.margin = '0'; // Remove any margins\n            container.appendChild(img);\n\n            // Add expand button with better touch target but thinner height\n            const expandBtn = document.createElement('button');\n            expandBtn.textContent = 'View Full Size';\n            expandBtn.style.padding = '6px 0'; // Reduced vertical padding\n            expandBtn.style.margin = '0'; // Remove margins\n            expandBtn.style.cursor = 'pointer';\n            expandBtn.style.background = '#007bff';\n            expandBtn.style.color = 'white';\n            expandBtn.style.border = 'none';\n            expandBtn.style.fontSize = '12px'; // Slightly smaller font\n            expandBtn.style.width = '100%'; // Full width of container\n            expandBtn.style.minHeight = '32px'; // Reduced height, still reasonable for touch\n\n            // Handle expand button click and touch\n            const openFullScreenViewer = (e) => {\n                e.stopPropagation();\n                openFullsizeViewer(bestCamera);\n            };\n\n            expandBtn.addEventListener('click', openFullScreenViewer);\n            expandBtn.addEventListener('touchend', (e) => {\n                e.preventDefault(); // Prevent ghost clicks\n                openFullScreenViewer(e);\n            });\n\n            container.appendChild(expandBtn);\n            document.body.appendChild(container);\n\n            // THE KEY FIX: Use setTimeout to add the document click listener on the next tick\n            // This prevents the current click from immediately closing the popup\n            setTimeout(() => {\n                // Make the popup automatically close when clicking outside of it\n                document.addEventListener('click', function closePopup(e) {\n                    if (!container.contains(e.target) && e.target !== container) {\n                        if (container.parentNode) {\n                            container.parentNode.removeChild(container);\n                        }\n                        document.removeEventListener('click', closePopup);\n                    }\n                });\n            }, 0);\n\n            // Close popup after 10 seconds to prevent lingering popups\n            setTimeout(() => {\n                if (container.parentNode) {\n                    container.parentNode.removeChild(container);\n                }\n            }, 10000);\n        } else {\n            console.error(\"Could not find a camera close to click point\");\n        }\n    });\n    \n    logWithTimestamp(\"Click-to-view setup complete\");\n}\n\n// Add this diagnostic function to check the camera_positions.json file\nasync function checkCameraPositionsFile() {\n    try {\n        const response = await fetch('camera_positions.json');\n        if (!response.ok) {\n            console.error(`Error fetching camera_positions.json: ${response.status} ${response.statusText}`);\n            return;\n        }\n        \n        const data = await response.json();\n        console.log(`Successfully loaded camera_positions.json with ${data.length} entries`);\n        \n        // Check a sample entry\n        if (data.length > 0) {\n            console.log(\"Sample camera entry:\", data[0]);\n            console.log(\"Position data type check:\", \n                typeof data[0].position === 'object',\n                data[0].position !== null,\n                data[0].position.hasOwnProperty('x'),\n                data[0].position.hasOwnProperty('y'),\n                data[0].position.hasOwnProperty('z')\n            );\n        }\n        \n        // Check if image files exist\n        if (data.length > 0 && data[0].imageName) {\n            const testImg = new Image();\n            testImg.onload = () => console.log(`Test image found: images/${data[0].imageName}`);\n            testImg.onerror = () => console.error(`Test image NOT found: images/${data[0].imageName}`);\n            testImg.src = `images/${data[0].imageName}`;\n        }\n        \n    } catch (err) {\n        console.error(\"Error checking camera positions file:\", err);\n    }\n}\n\n// Function to find nearest camera in a direction\nfunction findNearestCameraInDirection(currentCamera, isRightDirection) {\n    if (!window.cameraData || window.cameraData.length <= 1) return null;\n    \n    const currentPos = currentCamera.position;\n    \n    // Calculate center of all cameras\n    const center = calculateCamerasCenter();\n    \n    // Vector from center to current camera\n    const markerVec = new Vec3(\n        currentPos.x - center.x,\n        0, // Ignore Y for horizontal navigation\n        currentPos.z - center.z\n    ).normalize();\n    \n    // Compute right vector (perpendicular to marker vector)\n    const worldUp = new Vec3(0, 1, 0);\n    const rightVec = new Vec3().cross(worldUp, markerVec).normalize();\n    \n    // For each camera, compute how far it is in right or left direction\n    const camerasWithDirectionality = window.cameraData\n        .filter(camera => camera !== currentCamera)\n        .map(camera => {\n            const pos = camera.position;\n            \n            // Vector from current camera to other camera\n            const toMarkerVec = new Vec3(\n                pos.x - currentPos.x,\n                0, // Ignore Y for horizontal navigation\n                pos.z - currentPos.z\n            );\n            \n            // If toMarkerVec is zero length, skip this marker\n            if (toMarkerVec.length() < 0.001) return { camera, score: -Infinity };\n            \n            toMarkerVec.normalize();\n            \n            // Dot product with right vector gives how far right the camera is\n            // Positive is right, negative is left\n            const rightAmount = rightVec.dot(toMarkerVec);\n            \n            // Forward amount\n            const forwardAmount = markerVec.dot(toMarkerVec);\n            \n            // Distance factor\n            const distance = Math.sqrt(\n                Math.pow(pos.x - currentPos.x, 2) +\n                Math.pow(pos.z - currentPos.z, 2)\n            );\n            \n            // Score combines direction and distance\n            const directionScore = isRightDirection ? rightAmount : -rightAmount;\n            \n            // Higher score = better match (more in right direction, more forward, closer)\n            const score = directionScore * 3 + forwardAmount * 2 - (distance * 0.1);\n            \n            return { camera, score };\n        });\n    \n    // Find the camera with highest score\n    camerasWithDirectionality.sort((a, b) => b.score - a.score);\n    \n    // Return best camera or null if none found\n    return camerasWithDirectionality.length > 0 && \n        camerasWithDirectionality[0].score > -1 ? \n        camerasWithDirectionality[0].camera : null;\n}\n\n// Function to calculate center of all cameras\nfunction calculateCamerasCenter() {\n    if (!window.cameraData || window.cameraData.length === 0) {\n        return new Vec3(0, 0, 0);\n    }\n    \n    const center = new Vec3(0, 0, 0);\n    let count = 0;\n    \n    window.cameraData.forEach(camera => {\n        if (camera.position) {\n            center.x += camera.position.x;\n            center.y += camera.position.y;\n            center.z += camera.position.z;\n            count++;\n        }\n    });\n    \n    if (count > 0) {\n        center.x /= count;\n        center.y /= count;\n        center.z /= count;\n    }\n    \n    return center;\n}\n\n// Simpler, more direct pinch-to-zoom implementation\nfunction openFullsizeViewer(initialCamera) {\n    // Create fullscreen overlay\n    const overlay = document.createElement('div');\n    overlay.id = 'fullscreenOverlay';\n    overlay.style.position = 'fixed';\n    overlay.style.top = '0';\n    overlay.style.left = '0';\n    overlay.style.width = '100%';\n    overlay.style.height = '100%';\n    overlay.style.backgroundColor = 'rgba(0,0,0,0.9)';\n    overlay.style.zIndex = '10000';\n    overlay.style.display = 'flex';\n    overlay.style.alignItems = 'center';\n    overlay.style.justifyContent = 'center';\n    \n    // Create close button\n    const closeBtn = document.createElement('button');\n    closeBtn.textContent = 'Close';\n    closeBtn.style.position = 'absolute';\n    closeBtn.style.top = '20px';\n    closeBtn.style.right = '20px';\n    closeBtn.style.padding = '10px 20px';\n    closeBtn.style.background = '#007bff';\n    closeBtn.style.color = 'white';\n    closeBtn.style.border = 'none';\n    closeBtn.style.borderRadius = '4px';\n    closeBtn.style.cursor = 'pointer';\n    closeBtn.style.fontSize = '16px';\n    closeBtn.addEventListener('click', () => {\n        document.body.removeChild(overlay);\n    });\n    \n    // Current camera reference for navigation\n    let currentCamera = initialCamera;\n    \n    // Create image container - simpler structure to avoid positioning complexities\n    const imgContainer = document.createElement('div');\n    imgContainer.style.position = 'relative';\n    imgContainer.style.width = '80%';\n    imgContainer.style.height = '80%';\n    imgContainer.style.display = 'flex';\n    imgContainer.style.justifyContent = 'center';\n    imgContainer.style.alignItems = 'center';\n    \n    // Create fullsize image with direct transforms\n    const fullImg = document.createElement('img');\n    fullImg.src = `images/${currentCamera.imageName}`;\n    fullImg.style.maxWidth = '100%';\n    fullImg.style.maxHeight = '100%';\n    fullImg.style.objectFit = 'contain';\n    fullImg.style.touchAction = 'none'; // Prevent default touch actions\n    \n    // Zoom and pan variables \n    let scale = 1;\n    let translateX = 0;\n    let translateY = 0;\n    let lastX = 0;\n    let lastY = 0;\n    let lastDistance = 0;\n    \n    // Function to update image when changing\n    const updateFullImage = () => {\n        fullImg.src = `images/${currentCamera.imageName}`;\n        // Reset zoom and position\n        scale = 1;\n        translateX = 0;\n        translateY = 0;\n        updateTransform();\n    };\n    \n    // Function to update transform\n    const updateTransform = () => {\n        fullImg.style.transform = `translate(${translateX}px, ${translateY}px) scale(${scale})`;\n    };\n    \n    // --------- TOUCH EVENTS ---------\n    \n    // Touch move handler with direct pinch-to-zoom implementation\n    imgContainer.addEventListener('touchmove', function(e) {\n        e.preventDefault();\n        \n        // Get touch points\n        const touches = e.touches;\n        \n        // Handle pinch-to-zoom (2 fingers)\n        if (touches.length === 2) {\n            // Calculate current distance between touch points\n            const touch1 = touches[0];\n            const touch2 = touches[1];\n            const currentDistance = Math.sqrt(\n                Math.pow(touch2.clientX - touch1.clientX, 2) + \n                Math.pow(touch2.clientY - touch1.clientY, 2)\n            );\n            \n            // Calculate midpoint (center) of the two touches\n            const midpointX = (touch1.clientX + touch2.clientX) / 2;\n            const midpointY = (touch1.clientY + touch2.clientY) / 2;\n            \n            // Get image position relative to viewport\n            const rect = fullImg.getBoundingClientRect();\n            const imgCenterX = rect.left + rect.width / 2;\n            const imgCenterY = rect.top + rect.height / 2;\n            \n            // If first move in this gesture, initialize lastDistance\n            if (lastDistance === 0) {\n                lastDistance = currentDistance;\n                lastX = midpointX;\n                lastY = midpointY;\n                return;\n            }\n            \n            // Calculate scale change based on finger distance change\n            const scaleChange = currentDistance / lastDistance;\n            const newScale = Math.max(1, Math.min(5, scale * scaleChange));\n            \n            if (newScale !== scale) {\n                // Calculate translation to keep the pinch center fixed\n                const dx = midpointX - lastX;\n                const dy = midpointY - lastY;\n                \n                // Update scale and translation\n                scale = newScale;\n                translateX += dx;\n                translateY += dy;\n                \n                // Apply transform\n                updateTransform();\n                \n                // Update last positions\n                lastX = midpointX;\n                lastY = midpointY;\n                lastDistance = currentDistance;\n            }\n        }\n        // Handle pan (1 finger)\n        else if (touches.length === 1 && scale > 1) {\n            const touch = touches[0];\n            \n            // If first touch in this gesture, initialize lastX/Y\n            if (lastX === 0 && lastY === 0) {\n                lastX = touch.clientX;\n                lastY = touch.clientY;\n                return;\n            }\n            \n            // Calculate change in position\n            const dx = touch.clientX - lastX;\n            const dy = touch.clientY - lastY;\n            \n            // Update translation\n            translateX += dx;\n            translateY += dy;\n            \n            // Apply transform\n            updateTransform();\n            \n            // Update last position\n            lastX = touch.clientX;\n            lastY = touch.clientY;\n        }\n    }, { passive: false });\n    \n    // Touch start handler\n    imgContainer.addEventListener('touchstart', function(e) {\n        e.preventDefault();\n        \n        const touches = e.touches;\n        \n        if (touches.length === 2) {\n            // Initialize for pinch-to-zoom\n            const touch1 = touches[0];\n            const touch2 = touches[1];\n            lastDistance = Math.sqrt(\n                Math.pow(touch2.clientX - touch1.clientX, 2) + \n                Math.pow(touch2.clientY - touch1.clientY, 2)\n            );\n            lastX = (touch1.clientX + touch2.clientX) / 2;\n            lastY = (touch1.clientY + touch2.clientY) / 2;\n        } \n        else if (touches.length === 1 && scale > 1) {\n            // Initialize for pan\n            lastX = touches[0].clientX;\n            lastY = touches[0].clientY;\n        }\n    }, { passive: false });\n    \n    // Touch end handler\n    imgContainer.addEventListener('touchend', function(e) {\n        // Reset tracking variables when touch ends\n        if (e.touches.length === 0) {\n            lastDistance = 0;\n            lastX = 0;\n            lastY = 0;\n        }\n        // Handle transition from two fingers to one finger\n        else if (e.touches.length === 1) {\n            lastDistance = 0;\n            lastX = e.touches[0].clientX;\n            lastY = e.touches[0].clientY;\n        }\n    });\n    \n    // Double tap to reset zoom\n    let lastTapTime = 0;\n    imgContainer.addEventListener('touchend', function(e) {\n        const currentTime = new Date().getTime();\n        const tapLength = currentTime - lastTapTime;\n        \n        if (tapLength < 300 && tapLength > 0) {\n            // Double tap detected\n            scale = 1;\n            translateX = 0;\n            translateY = 0;\n            updateTransform();\n            e.preventDefault();\n        }\n        \n        lastTapTime = currentTime;\n    });\n    \n    // --------- MOUSE EVENTS (KEPT FOR DESKTOP) ---------\n    \n    // Variables for mouse interaction\n    let isDragging = false;\n    let startX = 0;\n    let startY = 0;\n    \n    // Mouse wheel zoom\n    imgContainer.addEventListener('wheel', function(e) {\n        e.preventDefault();\n        \n        // Calculate zoom change\n        const delta = e.deltaY > 0 ? 0.9 : 1.1;\n        const newScale = Math.max(1, Math.min(5, scale * delta));\n        \n        if (newScale !== scale) {\n            // Get mouse position\n            const mouseX = e.clientX;\n            const mouseY = e.clientY;\n            \n            // Get image position\n            const rect = fullImg.getBoundingClientRect();\n            \n            // Calculate relative mouse position to image center\n            const imageCenterX = rect.left + rect.width / 2;\n            const imageCenterY = rect.top + rect.height / 2;\n            \n            // Calculate zoom direction vector from center\n            const zoomDirX = mouseX - imageCenterX;\n            const zoomDirY = mouseY - imageCenterY;\n            \n            // Update scale\n            scale = newScale;\n            \n            // Update transform\n            updateTransform();\n        }\n    });\n    \n    // Mouse down for panning\n    imgContainer.addEventListener('mousedown', function(e) {\n        // Only allow panning when zoomed in\n        if (scale <= 1) return;\n        \n        isDragging = true;\n        startX = e.clientX - translateX;\n        startY = e.clientY - translateY;\n        imgContainer.style.cursor = 'grabbing';\n    });\n    \n    // Mouse move for panning\n    document.addEventListener('mousemove', function(e) {\n        if (!isDragging) return;\n        \n        translateX = e.clientX - startX;\n        translateY = e.clientY - startY;\n        updateTransform();\n    });\n    \n    // Mouse up to end panning\n    document.addEventListener('mouseup', function() {\n        isDragging = false;\n        imgContainer.style.cursor = scale > 1 ? 'grab' : 'default';\n    });\n    \n    // Double click to reset zoom\n    imgContainer.addEventListener('dblclick', function() {\n        scale = 1;\n        translateX = 0;\n        translateY = 0;\n        updateTransform();\n    });\n    \n    // --------- NAVIGATION ---------\n    \n    // Add navigation arrows\n    const createArrow = (direction) => {\n        const arrow = document.createElement('div');\n        arrow.style.position = 'absolute';\n        arrow.style.top = '50%';\n        arrow.style[direction === 'left' ? 'left' : 'right'] = '20px';\n        arrow.style.width = '50px';\n        arrow.style.height = '50px';\n        arrow.style.background = 'rgba(255, 255, 255, 0.3)';\n        arrow.style.borderRadius = '50%';\n        arrow.style.display = 'flex';\n        arrow.style.alignItems = 'center';\n        arrow.style.justifyContent = 'center';\n        arrow.style.cursor = 'pointer';\n        arrow.style.transform = 'translateY(-50%)';\n        arrow.style.fontSize = '24px';\n        arrow.style.fontWeight = 'bold';\n        arrow.style.color = 'white';\n        arrow.style.userSelect = 'none';\n        arrow.textContent = direction === 'left' ? '' : '';\n        \n        arrow.addEventListener('mouseenter', () => {\n            arrow.style.background = 'rgba(255, 255, 255, 0.5)';\n        });\n        \n        arrow.addEventListener('mouseleave', () => {\n            arrow.style.background = 'rgba(255, 255, 255, 0.3)';\n        });\n        \n        // Support for both mouse and touch events\n        const navigateImage = () => {\n            // Find next camera - left means go to camera on the left, right means go to camera on the right\n            const nextCamera = findNearestCameraInDirection(currentCamera, direction === 'right');\n            \n            if (nextCamera) {\n                // Update current camera and image\n                currentCamera = nextCamera;\n                updateFullImage();\n            }\n        };\n        \n        arrow.addEventListener('click', navigateImage);\n        arrow.addEventListener('touchend', (e) => {\n            e.preventDefault();\n            navigateImage();\n        });\n        \n        return arrow;\n    };\n    \n    const leftArrow = createArrow('left');\n    const rightArrow = createArrow('right');\n    \n    // Add keyboard navigation\n    const handleKeyDown = (e) => {\n        switch (e.key) {\n            case 'ArrowLeft':\n                const leftCamera = findNearestCameraInDirection(currentCamera, false);\n                if (leftCamera) {\n                    currentCamera = leftCamera;\n                    updateFullImage();\n                }\n                break;\n            case 'ArrowRight':\n                const rightCamera = findNearestCameraInDirection(currentCamera, true);\n                if (rightCamera) {\n                    currentCamera = rightCamera;\n                    updateFullImage();\n                }\n                break;\n            case 'Escape':\n                document.body.removeChild(overlay);\n                document.removeEventListener('keydown', handleKeyDown);\n                break;\n            case '0':\n            case 'r':\n                // Reset zoom\n                scale = 1;\n                translateX = 0;\n                translateY = 0;\n                updateTransform();\n                break;\n        }\n    };\n    \n    document.addEventListener('keydown', handleKeyDown);\n    \n    // Clean up event listeners when overlay is removed\n    overlay.addEventListener('remove', () => {\n        document.removeEventListener('keydown', handleKeyDown);\n        document.removeEventListener('mousemove', null);\n        document.removeEventListener('mouseup', null);\n    });\n    \n    // Assemble the components\n    imgContainer.appendChild(fullImg);\n    \n    overlay.appendChild(closeBtn);\n    overlay.appendChild(imgContainer);\n    overlay.appendChild(leftArrow);\n    overlay.appendChild(rightArrow);\n    \n    // Add instructions - show different instructions for touch devices\n    const isTouchDevice = 'ontouchstart' in window || navigator.maxTouchPoints > 0;\n    const instructionText = isTouchDevice ? \n        'Pinch to zoom, drag to pan when zoomed in, double-tap to reset zoom' : \n        'Use mouse wheel to zoom, drag to pan when zoomed in, double-click to reset zoom';\n    \n    const instructions = document.createElement('div');\n    instructions.textContent = instructionText;\n    instructions.style.position = 'absolute';\n    instructions.style.bottom = '20px';\n    instructions.style.left = '50%';\n    instructions.style.transform = 'translateX(-50%)';\n    instructions.style.color = 'white';\n    instructions.style.background = 'rgba(0, 0, 0, 0.5)';\n    instructions.style.padding = '8px 16px';\n    instructions.style.borderRadius = '4px';\n    instructions.style.fontSize = '14px';\n    instructions.style.textAlign = 'center';\n    instructions.style.maxWidth = '90%';\n    overlay.appendChild(instructions);\n    \n    document.body.appendChild(overlay);\n}",Sy="class CubicSpline {\n    // control times\n    times;\n\n    // control data: in-tangent, point, out-tangent\n    knots;\n\n    // dimension of the knot points\n    dim;\n\n    constructor(times, knots) {\n        this.times = times;\n        this.knots = knots;\n        this.dim = knots.length / times.length / 3;\n    }\n\n    evaluate(time, result) {\n        const { times } = this;\n        const last = times.length - 1;\n\n        if (time <= times[0]) {\n            this.getKnot(0, result);\n        } else if (time >= times[last]) {\n            this.getKnot(last, result);\n        } else {\n            let seg = 0;\n            while (time >= times[seg + 1]) {\n                seg++;\n            }\n            return this.evaluateSegment(seg, (time - times[seg]) / (times[seg + 1] - times[seg]), result);\n        }\n    }\n\n    getKnot(index, result) {\n        const { knots, dim } = this;\n        const idx = index * 3 * dim;\n        for (let i = 0; i < dim; ++i) {\n            result[i] = knots[idx + i * 3 + 1];\n        }\n    }\n\n    // evaluate the spline segment at the given normalized time t\n    evaluateSegment(segment, t, result) {\n        const { knots, dim } = this;\n\n        const t2 = t * t;\n        const twot = t + t;\n        const omt = 1 - t;\n        const omt2 = omt * omt;\n\n        let idx = segment * dim * 3;\n        for (let i = 0; i < dim; ++i) {\n            const p0 = knots[idx + 1];\n            const m0 = knots[idx + 2];\n            const m1 = knots[idx + dim * 3];\n            const p1 = knots[idx + dim * 3 + 1];\n            idx += 3;\n\n            result[i] =\n                p0 * ((1 + twot) * omt2) +\n                m0 * (t * omt2) +\n                p1 * (t2 * (3 - twot)) +\n                m1 * (t2 * (t - 1));\n        }\n    }\n\n    // create cubic spline data from a set of control points to be interpolated\n    // times: time values for each control point\n    // points: control point values to be interpolated (n dimensional)\n    // tension: level of smoothness, 0 = smooth, 1 = linear interpolation\n    static fromPoints(times, points, tension = 0) {\n        const dim = points.length / times.length;\n        const knots = new Array(times.length * dim * 3);\n\n        for (let i = 0; i < times.length; i++) {\n            const t = times[i];\n\n            for (let j = 0; j < dim; j++) {\n                const idx = i * dim + j;\n                const p = points[idx];\n\n                let tangent;\n                if (i === 0) {\n                    tangent = (points[idx + dim] - p) / (times[i + 1] - t);\n                } else if (i === times.length - 1) {\n                    tangent = (p - points[idx - dim]) / (t - times[i - 1]);\n                } else {\n                    // finite difference tangents\n                    tangent = 0.5 * ((points[idx + dim] - p) / (times[i + 1] - t) + (p - points[idx - dim]) / (t - times[i - 1]));\n\n                    // cardinal spline tangents\n                    // tangent = (points[idx + dim] - points[idx - dim]) / (times[i + 1] - times[i - 1]);\n                }\n\n                // apply tension\n                tangent *= (1.0 - tension);\n\n                knots[idx * 3] = tangent;\n                knots[idx * 3 + 1] = p;\n                knots[idx * 3 + 2] = tangent;\n            }\n        }\n\n        return new CubicSpline(times, knots);\n    }\n\n    // create a looping spline by duplicating animation points at the end and beginning\n    static fromPointsLooping(length, times, points, tension) {\n        if (times.length < 2) {\n            return CubicSpline.fromPoints(times, points, tension);\n        }\n\n        const dim = points.length / times.length;\n        const newTimes = times.slice();\n        const newPoints = points.slice();\n\n        // append first two points\n        newTimes.push(length + times[0], length + times[1]);\n        newPoints.push(...points.slice(0, dim * 2));\n\n        // prepend last two points\n        newTimes.splice(0, 0, times[times.length - 2] - length, times[times.length - 1] - length);\n        newPoints.splice(0, 0, ...points.slice(points.length - dim * 2));\n\n        return CubicSpline.fromPoints(newTimes, newPoints, tension);\n    }\n}\n\nexport { CubicSpline };\n";const Ay=`Generated by SuperSplat ${yy}`,Ty=e=>1/(1+Math.exp(-e));class Py{set;test;constructor(e){let t=null,s=null,i=null;this.set=e=>{t=e,s=t.splatData.getProp("state"),i=t.splatData.getProp("opacity")};const n=e.selected??!1,a=e.minOpacity??0,r=e.removeInvalid??!1;this.test=e=>{if(s[e]&_y.deleted)return!1;if(n&&!(s[e]&_y.selected))return!1;if(a>0&&Ty(i[e])<a)return!1;if(r){const{splatData:s}=t;for(let t=0;t<s.elements.length;++t){const i=s.elements[t];for(let t=0;t<i.properties.length;++t){const s=i.properties[t],{storage:n}=s;if(n&&!Number.isFinite(n[e]))return!1}}}return!0}}}const Ey=(e,t)=>e.reduce(((e,s)=>{t.set(s);for(let i=0;i<s.splatData.numSplats;++i)e+=t.test(i)?1:0;return e}),0),ky=e=>new Set(e.getElement("vertex").properties.filter((e=>e.storage)).map((e=>e.name))),My=new Array(45).fill("").map(((e,t)=>`f_rest_${t}`)),Iy=[0,3,8,15],Dy=e=>({9:1,24:2,"-1":3}[My.findIndex((t=>!e.has(t)))]??0),Ry=new yt,Ly=new kt;class Fy{getMat;getRot;getScale;getSHRot;constructor(e,t=!1){const s=new Map,i=e.transformTexture.getSource(),n=new Et,a=new xt,r=new kt,o=e=>{const t=i?.[e]??0;let n=s.get(t);return n||(n={transformIndex:t,mat:null,rot:null,scale:null,shRot:null},s.set(t,n)),n};this.getMat=s=>{const i=o(s);if(!i.mat){const s=new Et;t||(s.setFromEulerAngles(0,0,-180),s.mul2(s,e.entity.getWorldTransform())),i.transformIndex>0&&(e.transformPalette.getTransform(i.transformIndex,n),s.mul2(s,n)),i.mat=s}return i.mat},this.getRot=e=>{const t=o(e);return t.rot||(t.rot=(new kt).setFromMat4(this.getMat(e))),t.rot},this.getScale=e=>{const t=o(e);if(!t.scale){const s=new yt;this.getMat(e).getScale(s),t.scale=s}return t.scale},this.getSHRot=e=>{const t=o(e);return t.shRot||(r.setFromMat4(this.getMat(e)),a.setFromQuat(r),t.shRot=new vy(a)),t.shRot}}}class By{data={};read;constructor(e,t){const s={};e.forEach((e=>{s[e]=0}));const i=["x","y","z"].every((e=>s.hasOwnProperty(e))),n=["rot_0","rot_1","rot_2","rot_3"].every((e=>s.hasOwnProperty(e))),a=["scale_0","scale_1","scale_2"].every((e=>s.hasOwnProperty(e))),r=["f_dc_0","f_dc_1","f_dc_2"].every((e=>s.hasOwnProperty(e))),o=s.hasOwnProperty("opacity"),l=Dy(new Set(Object.keys(s))),h=Iy[l],c=l?new Float32Array(h):null,d=new Map;let u;this.data=s,this.read=(p,m)=>{if(p!==u?.splat)if(d.has(p))u=d.get(p);else{const s=new Fy(p,t.keepWorldTransform),i=ky(p.splatData),n=Dy(i),a=Iy[n],r={};e.forEach((e=>{const t=My.indexOf(e);if(t>=0){const s=Math.floor(t/h),i=t%h;r[e]=i<a?p.splatData.getProp(My[s*a+i]):null}else r[e]=p.splatData.getProp(e)}));const{blackPoint:o,whitePoint:l,brightness:c,tintClr:m}=p,f=!m.equals(mt.WHITE)||0!==o||1!==l||1!==c;u={splat:p,transformCache:s,srcProps:r,hasTint:f},d.set(p,u)}const{transformCache:f,srcProps:g,hasTint:v}=u;e.forEach((e=>{s[e]=g[e]?.[m]??0}));const _=f.getMat(m);if(i&&(Ry.set(s.x,s.y,s.z),_.transformPoint(Ry,Ry),[s.x,s.y,s.z]=[Ry.x,Ry.y,Ry.z]),n){const e=f.getRot(m);Ly.set(s.rot_1,s.rot_2,s.rot_3,s.rot_0).mul2(e,Ly),[s.rot_1,s.rot_2,s.rot_3,s.rot_0]=[Ly.x,Ly.y,Ly.z,Ly.w]}if(a){const e=f.getScale(m);s.scale_0=Math.log(Math.exp(s.scale_0)*e.x),s.scale_1=Math.log(Math.exp(s.scale_1)*e.y),s.scale_2=Math.log(Math.exp(s.scale_2)*e.z)}if(l>0)for(let e=0;e<3;++e){for(let t=0;t<h;++t)c[t]=s[My[e*h+t]];f.getSHRot(m).apply(c);for(let t=0;t<h;++t)s[My[e*h+t]]=c[t]}if(!t.keepColorTint&&r&&v){const{blackPoint:e,whitePoint:t,brightness:i,tintClr:n}=p,a=.28209479177387814,r=e=>e*a+.5,o=e=>(e-.5)/a,c=-e+i,d=1/(t-e),u=n.r*d,m=n.g*d,f=n.b*d;if(s.f_dc_0=o(c+r(s.f_dc_0)*u),s.f_dc_1=o(c+r(s.f_dc_1)*m),s.f_dc_2=o(c+r(s.f_dc_2)*f),l>0)for(let e=0;e<h;++e)s[My[e]]*=u,s[My[e+h]]*=m,s[My[e+2*h]]*=f}const{transparency:y}=p;if(!t.keepColorTint&&o&&1!==y){const e=e=>e<=0?-400:e>=1?400:-Math.log(1/e-1);s.opacity=e(Ty(s.opacity)*y)}}}}const Oy=async(e,t,s)=>{const{maxSHBands:i,keepStateData:n}=t,a=new Py(t),r=Ey(e,a);if(0===r)return;const o=n?["transform"]:["state","transform"],l=(e=>{const t=new Map;for(let s=0;s<e.length;++s)e[s].splatData.getElement("vertex").properties.filter((e=>e.storage)).forEach((e=>{t.has(e.name)?t.get(e.name).add(e.type):t.set(e.name,new Set([e.type]))}));return[...t].filter((([e,t])=>1===t.size)).map((([e,t])=>({name:e,type:t.values().next().value})))})(e).filter((e=>!o.includes(e.name))).filter((e=>{if(!e.name.startsWith("f_rest_"))return!0;return parseInt(e.name.slice(7),10)<[0,9,24,45][i??3]})),h=["ply","format binary_little_endian 1.0",`element vertex ${r}`,l.map((e=>`property ${e.type} ${e.name}`)),"end_header",""].flat().join("\n");await s.write((new TextEncoder).encode(h));const c=new By(l.map((e=>e.name)),t),d=new Uint8Array(1024*l.reduce(((e,t)=>e+{char:1,uchar:1,short:2,ushort:2,int:4,uint:4,float:4,double:8}[t.type]),0)),u=new DataView(d.buffer);let p=0;for(let t=0;t<e.length;++t){const i=e[t],{splatData:n}=i;a.set(i);for(let e=0;e<n.numSplats;++e)if(a.test(e)){c.read(i,e);for(let e=0;e<l.length;++e)"uchar"===l[e].type?(u.setUint8(p,c.data[l[e].name]),p+=1):(u.setFloat32(p,c.data[l[e].name],!0),p+=4);p===d.byteLength&&(await s.write(d),p=0)}}p>0&&await s.write(new Uint8Array(d.buffer,0,p))};class zy{static members=["x","y","z","scale_0","scale_1","scale_2","f_dc_0","f_dc_1","f_dc_2","opacity","rot_0","rot_1","rot_2","rot_3"];size;data={};position;rotation;scale;color;constructor(e=256){this.size=e,zy.members.forEach((t=>{this.data[t]=new Float32Array(e)})),this.position=new Uint32Array(e),this.rotation=new Uint32Array(e),this.scale=new Uint32Array(e),this.color=new Uint32Array(e)}set(e,t){zy.members.forEach((s=>{this.data[s][e]=t.data[s]}))}pack(){const e=e=>{let t,s;t=s=e[0];for(let i=1;i<e.length;++i){const n=e[i];t=Math.min(t,n),s=Math.max(s,n)}return{min:t,max:s}},t=(e,t,s)=>e<=t?0:e>=s?1:s-t<1e-5?0:(e-t)/(s-t),s=this.data,i=s.x,n=s.y,a=s.z,r=s.scale_0,o=s.scale_1,l=s.scale_2,h=s.rot_0,c=s.rot_1,d=s.rot_2,u=s.rot_3,p=s.f_dc_0,m=s.f_dc_1,f=s.f_dc_2,g=s.opacity,v=e(i),_=e(n),y=e(a),x=e(r),w=e(o),b=e(l),C=(e,t,s)=>Math.max(t,Math.min(s,e));x.min=C(x.min,-20,20),x.max=C(x.max,-20,20),w.min=C(w.min,-20,20),w.max=C(w.max,-20,20),b.min=C(b.min,-20,20),b.max=C(b.max,-20,20);const S=.28209479177387814;for(let e=0;e<p.length;++e)p[e]=p[e]*S+.5,m[e]=m[e]*S+.5,f[e]=f[e]*S+.5;const A=e(p),T=e(m),P=e(f),E=(e,t)=>{const s=(1<<t)-1;return Math.max(0,Math.min(s,Math.floor(e*s+.5)))},k=(e,t,s)=>E(e,11)<<21|E(t,10)<<11|E(s,11),M=(e,t,s,i)=>E(e,8)<<24|E(t,8)<<16|E(s,8)<<8|E(i,8),I=(e,t,s,i)=>{Ly.set(e,t,s,i).normalize();const n=[Ly.x,Ly.y,Ly.z,Ly.w],a=n.reduce(((e,t,s)=>Math.abs(t)>Math.abs(n[e])?s:e),0);n[a]<0&&(n[0]=-n[0],n[1]=-n[1],n[2]=-n[2],n[3]=-n[3]);const r=.5*Math.sqrt(2);let o=a;for(let e=0;e<4;++e)e!==a&&(o=o<<10|E(n[e]*r+.5,10));return o};for(let e=0;e<this.size;++e)this.position[e]=k(t(i[e],v.min,v.max),t(n[e],_.min,_.max),t(a[e],y.min,y.max)),this.rotation[e]=I(h[e],c[e],d[e],u[e]),this.scale[e]=k(t(r[e],x.min,x.max),t(o[e],w.min,w.max),t(l[e],b.min,b.max)),this.color[e]=M(t(p[e],A.min,A.max),t(m[e],T.min,T.max),t(f[e],P.min,P.max),1/(1+Math.exp(-g[e])));return{px:v,py:_,pz:y,sx:x,sy:w,sz:b,cr:A,cg:T,cb:P}}}const Vy=async(e,t,s)=>{const{maxSHBands:i}=t,n=new Py(t),a=[];for(let t=0;t<e.length;++t){const s=e[t].splatData;n.set(e[t]);for(let e=0;e<s.numSplats;++e)n.test(e)&&a.push({splatIndex:t,i:e,globalIndex:a.length})}if(0===a.length)return void console.error("nothing to export");const r=a.length,o=Math.ceil(r/256),l=["min_x","min_y","min_z","max_x","max_y","max_z","min_scale_x","min_scale_y","min_scale_z","max_scale_x","max_scale_y","max_scale_z","min_r","min_g","min_b","max_r","max_g","max_b"],h=["packed_position","packed_rotation","packed_scale","packed_color"],c=(()=>{const t=e.map((e=>Dy(ky(e.splatData))));return Math.min(i??3,Math.max(...t))})(),d=Iy[c],u=c?[`element sh ${r}`,new Array(3*d).fill("").map(((e,t)=>`property uchar f_rest_${t}`))].flat():[],p=["ply","format binary_little_endian 1.0",`comment ${Ay}`,`element chunk ${o}`,l.map((e=>`property float ${e}`)),`element vertex ${r}`,h.map((e=>`property uint ${e}`)),u,"end_header\n"].flat().join("\n"),m=(new TextEncoder).encode(p),f=new Uint8Array(m.byteLength+o*l.length*4+r*h.length*4+3*d*r),g=new DataView(f.buffer);f.set(m);const v=m.byteLength,_=v+o*l.length*4,y=_+4*r*4;((e,t)=>{const s=(e,t,s)=>{const i=e=>153391689&((e=51130563&((e=50393103&((e=4278190335&((e&=1023)^e<<16))^e<<8))^e<<4))^e<<2);return(i(s)<<2)+(i(t)<<1)+i(e)};let i,n,a,r,o,l;for(let t=0;t<e.length;++t){const s=e[t],h=s.splatData,c=h.getProp("state"),{centers:d}=s.entity.gsplat.instance.sorter;for(let e=0;e<h.numSplats;++e)if(!(c[e]&_y.deleted)){const t=d[3*e+0],s=d[3*e+1],h=d[3*e+2];void 0===i?(i=r=t,n=o=s,a=l=h):(t<i?i=t:t>r&&(r=t),s<n?n=s:s>o&&(o=s),h<a?a=h:h>l&&(l=h))}}const h=r-i,c=o-n,d=l-a,u=new Uint32Array(t.length);let p=0;for(let t=0;t<e.length;++t){const r=e[t],o=r.splatData,l=o.getProp("state"),{centers:m}=r.entity.gsplat.instance.sorter;for(let e=0;e<o.numSplats;++e)if(!(l[e]&_y.deleted)){const t=m[3*e+0],r=m[3*e+1],o=m[3*e+2],l=Math.floor(1024*(t-i)/h),f=Math.floor(1024*(r-n)/c),g=Math.floor(1024*(o-a)/d);u[p++]=s(l,f,g)}}t.sort(((e,t)=>u[e.globalIndex]-u[t.globalIndex]))})(e,a);const x=new zy,w=new By(["x","y","z","scale_0","scale_1","scale_2","f_dc_0","f_dc_1","f_dc_2","opacity","rot_0","rot_1","rot_2","rot_3"].concat(My.slice(0,3*d)),t);for(let t=0;t<o;++t){const s=Math.min(r,256*(t+1))-256*t;for(let i=0;i<s;++i){const s=a[256*t+i];w.read(e[s.splatIndex],s.i),x.set(i,w);let n=y+(256*t+i)*d*3;for(let e=0;e<3*d;++e){const t=w.data[My[e]]/8+.5;g.setUint8(n++,Math.max(0,Math.min(255,Math.trunc(256*t))))}}const i=x.pack(),n=v+18*t*4;g.setFloat32(n+0,i.px.min,!0),g.setFloat32(n+4,i.py.min,!0),g.setFloat32(n+8,i.pz.min,!0),g.setFloat32(n+12,i.px.max,!0),g.setFloat32(n+16,i.py.max,!0),g.setFloat32(n+20,i.pz.max,!0),g.setFloat32(n+24,i.sx.min,!0),g.setFloat32(n+28,i.sy.min,!0),g.setFloat32(n+32,i.sz.min,!0),g.setFloat32(n+36,i.sx.max,!0),g.setFloat32(n+40,i.sy.max,!0),g.setFloat32(n+44,i.sz.max,!0),g.setFloat32(n+48,i.cr.min,!0),g.setFloat32(n+52,i.cg.min,!0),g.setFloat32(n+56,i.cb.min,!0),g.setFloat32(n+60,i.cr.max,!0),g.setFloat32(n+64,i.cg.max,!0),g.setFloat32(n+68,i.cb.max,!0);const o=_+256*t*4*4,l=Math.min(r,256*(t+1))-256*t;for(let e=0;e<l;++e)g.setUint32(o+4*e*4+0,x.position[e],!0),g.setUint32(o+4*e*4+4,x.rotation[e],!0),g.setUint32(o+4*e*4+8,x.scale[e],!0),g.setUint32(o+4*e*4+12,x.color[e],!0)}await s.write(f,!0)},Ny=async(e,t,s)=>{const{experienceSettings:i,versionType:n}=t,a=new O_;await Vy(e,t.serializeSettings,a);const r=a.close();if("html"===t.type){const e=(e,t)=>{const s=" ".repeat(t);return e.split("\n").map((e=>s+e)).join("\n")};let t;t="dev"===n?by:Cy;const a='<script type="module" src="./index.js"><\/script>',o='"spline": "./spline.js"',l='window.settings = fetch("./settings.json").then(response => response.json());',h='<pc-asset id="ply" type="gsplat" lazy src="./scene.compressed.ply"></pc-asset>',c=wy.replace('<link rel="stylesheet" href="./index.css">',`<style>\n${e(xy,12)}\n        </style>`).replace(a,`<script type="module">\n${e(t,12)}\n        <\/script>`).replace(o,`"spline": "data:application/javascript;,${encodeURIComponent(Sy)}"`).replace(l,`window.settings = ${JSON.stringify(i)};`).replace(h,`<pc-asset id="ply" type="gsplat" lazy src="data:application/ply;base64,${(e=>{let t="";const s=e.byteLength;for(let i=0;i<s;i++)t+=String.fromCharCode(e[i]);return window.btoa(t)})(r)}"></pc-asset>`);await s.write((new TextEncoder).encode(c),!0)}else{const e=new H_(s);let t;t="dev"===n?by:Cy,await e.file("index.html",wy),await e.file("index.css",xy),await e.file("index.js",t),await e.file("spline.js",Sy),await e.file("settings.json",JSON.stringify(i,null,4)),await e.file("scene.compressed.ply",r),await e.close()}},Uy=(e,t)=>{const s=new Blob([t],{type:"octet/stream"}),i=window.URL.createObjectURL(s),n=document.createElement("a");if(n.download=e,n.href=i,document.createEvent){const e=document.createEvent("MouseEvents");e.initMouseEvent("click",!0,!0,window,0,0,0,0,0,!1,!1,!1,!1,0,null),n.dispatchEvent(e)}else n.fireEvent?.("onclick");window.URL.revokeObjectURL(i)},Hy=e=>"string"==typeof e,Gy=()=>{let e,t;const s=new Promise(((s,i)=>{e=s,t=i}));return s.resolve=e,s.reject=t,s},Wy=e=>null==e?"":""+e,jy=/###/g,qy=e=>e&&e.indexOf("###")>-1?e.replace(jy,"."):e,Xy=e=>!e||Hy(e),Yy=(e,t,s)=>{const i=Hy(t)?t.split("."):t;let n=0;for(;n<i.length-1;){if(Xy(e))return{};const t=qy(i[n]);!e[t]&&s&&(e[t]=new s),e=Object.prototype.hasOwnProperty.call(e,t)?e[t]:{},++n}return Xy(e)?{}:{obj:e,k:qy(i[n])}},$y=(e,t,s)=>{const{obj:i,k:n}=Yy(e,t,Object);if(void 0!==i||1===t.length)return void(i[n]=s);let a=t[t.length-1],r=t.slice(0,t.length-1),o=Yy(e,r,Object);for(;void 0===o.obj&&r.length;)a=`${r[r.length-1]}.${a}`,r=r.slice(0,r.length-1),o=Yy(e,r,Object),o?.obj&&void 0!==o.obj[`${o.k}.${a}`]&&(o.obj=void 0);o.obj[`${o.k}.${a}`]=s},Ky=(e,t)=>{const{obj:s,k:i}=Yy(e,t);if(s&&Object.prototype.hasOwnProperty.call(s,i))return s[i]},Zy=(e,t,s)=>{for(const i in t)"__proto__"!==i&&"constructor"!==i&&(i in e?Hy(e[i])||e[i]instanceof String||Hy(t[i])||t[i]instanceof String?s&&(e[i]=t[i]):Zy(e[i],t[i],s):e[i]=t[i]);return e},Jy=e=>e.replace(/[\-\[\]\/\{\}\(\)\*\+\?\.\\\^\$\|]/g,"\\$&");var Qy={"&":"&amp;","<":"&lt;",">":"&gt;",'"':"&quot;","'":"&#39;","/":"&#x2F;"};const ex=e=>Hy(e)?e.replace(/[&<>"'\/]/g,(e=>Qy[e])):e;const tx=[" ",",","?","!",";"],sx=new class{constructor(e){this.capacity=e,this.regExpMap=new Map,this.regExpQueue=[]}getRegExp(e){const t=this.regExpMap.get(e);if(void 0!==t)return t;const s=new RegExp(e);return this.regExpQueue.length===this.capacity&&this.regExpMap.delete(this.regExpQueue.shift()),this.regExpMap.set(e,s),this.regExpQueue.push(e),s}}(20),ix=function(e,t){let s=arguments.length>2&&void 0!==arguments[2]?arguments[2]:".";if(!e)return;if(e[t]){if(!Object.prototype.hasOwnProperty.call(e,t))return;return e[t]}const i=t.split(s);let n=e;for(let e=0;e<i.length;){if(!n||"object"!=typeof n)return;let t,a="";for(let r=e;r<i.length;++r)if(r!==e&&(a+=s),a+=i[r],t=n[a],void 0!==t){if(["string","number","boolean"].indexOf(typeof t)>-1&&r<i.length-1)continue;e+=r-e+1;break}n=t}return n},nx=e=>e?.replace("_","-"),ax={type:"logger",log(e){this.output("log",e)},warn(e){this.output("warn",e)},error(e){this.output("error",e)},output(e,t){console?.[e]?.apply?.(console,t)}};class rx{constructor(e){let t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:{};this.init(e,t)}init(e){let t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:{};this.prefix=t.prefix||"i18next:",this.logger=e||ax,this.options=t,this.debug=t.debug}log(){for(var e=arguments.length,t=new Array(e),s=0;s<e;s++)t[s]=arguments[s];return this.forward(t,"log","",!0)}warn(){for(var e=arguments.length,t=new Array(e),s=0;s<e;s++)t[s]=arguments[s];return this.forward(t,"warn","",!0)}error(){for(var e=arguments.length,t=new Array(e),s=0;s<e;s++)t[s]=arguments[s];return this.forward(t,"error","")}deprecate(){for(var e=arguments.length,t=new Array(e),s=0;s<e;s++)t[s]=arguments[s];return this.forward(t,"warn","WARNING DEPRECATED: ",!0)}forward(e,t,s,i){return i&&!this.debug?null:(Hy(e[0])&&(e[0]=`${s}${this.prefix} ${e[0]}`),this.logger[t](e))}create(e){return new rx(this.logger,{prefix:`${this.prefix}:${e}:`,...this.options})}clone(e){return(e=e||this.options).prefix=e.prefix||this.prefix,new rx(this.logger,e)}}var ox=new rx;class lx{constructor(){this.observers={}}on(e,t){return e.split(" ").forEach((e=>{this.observers[e]||(this.observers[e]=new Map);const s=this.observers[e].get(t)||0;this.observers[e].set(t,s+1)})),this}off(e,t){this.observers[e]&&(t?this.observers[e].delete(t):delete this.observers[e])}emit(e){for(var t=arguments.length,s=new Array(t>1?t-1:0),i=1;i<t;i++)s[i-1]=arguments[i];if(this.observers[e]){Array.from(this.observers[e].entries()).forEach((e=>{let[t,i]=e;for(let e=0;e<i;e++)t(...s)}))}if(this.observers["*"]){Array.from(this.observers["*"].entries()).forEach((t=>{let[i,n]=t;for(let t=0;t<n;t++)i.apply(i,[e,...s])}))}}}class hx extends lx{constructor(e){let t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:{ns:["translation"],defaultNS:"translation"};super(),this.data=e||{},this.options=t,void 0===this.options.keySeparator&&(this.options.keySeparator="."),void 0===this.options.ignoreJSONStructure&&(this.options.ignoreJSONStructure=!0)}addNamespaces(e){this.options.ns.indexOf(e)<0&&this.options.ns.push(e)}removeNamespaces(e){const t=this.options.ns.indexOf(e);t>-1&&this.options.ns.splice(t,1)}getResource(e,t,s){let i=arguments.length>3&&void 0!==arguments[3]?arguments[3]:{};const n=void 0!==i.keySeparator?i.keySeparator:this.options.keySeparator,a=void 0!==i.ignoreJSONStructure?i.ignoreJSONStructure:this.options.ignoreJSONStructure;let r;e.indexOf(".")>-1?r=e.split("."):(r=[e,t],s&&(Array.isArray(s)?r.push(...s):Hy(s)&&n?r.push(...s.split(n)):r.push(s)));const o=Ky(this.data,r);return!o&&!t&&!s&&e.indexOf(".")>-1&&(e=r[0],t=r[1],s=r.slice(2).join(".")),!o&&a&&Hy(s)?ix(this.data?.[e]?.[t],s,n):o}addResource(e,t,s,i){let n=arguments.length>4&&void 0!==arguments[4]?arguments[4]:{silent:!1};const a=void 0!==n.keySeparator?n.keySeparator:this.options.keySeparator;let r=[e,t];s&&(r=r.concat(a?s.split(a):s)),e.indexOf(".")>-1&&(r=e.split("."),i=t,t=r[1]),this.addNamespaces(t),$y(this.data,r,i),n.silent||this.emit("added",e,t,s,i)}addResources(e,t,s){let i=arguments.length>3&&void 0!==arguments[3]?arguments[3]:{silent:!1};for(const i in s)(Hy(s[i])||Array.isArray(s[i]))&&this.addResource(e,t,i,s[i],{silent:!0});i.silent||this.emit("added",e,t,s)}addResourceBundle(e,t,s,i,n){let a=arguments.length>5&&void 0!==arguments[5]?arguments[5]:{silent:!1,skipCopy:!1},r=[e,t];e.indexOf(".")>-1&&(r=e.split("."),i=s,s=t,t=r[1]),this.addNamespaces(t);let o=Ky(this.data,r)||{};a.skipCopy||(s=JSON.parse(JSON.stringify(s))),i?Zy(o,s,n):o={...o,...s},$y(this.data,r,o),a.silent||this.emit("added",e,t,s)}removeResourceBundle(e,t){this.hasResourceBundle(e,t)&&delete this.data[e][t],this.removeNamespaces(t),this.emit("removed",e,t)}hasResourceBundle(e,t){return void 0!==this.getResource(e,t)}getResourceBundle(e,t){return t||(t=this.options.defaultNS),this.getResource(e,t)}getDataByLanguage(e){return this.data[e]}hasLanguageSomeTranslations(e){const t=this.getDataByLanguage(e);return!!(t&&Object.keys(t)||[]).find((e=>t[e]&&Object.keys(t[e]).length>0))}toJSON(){return this.data}}var cx={processors:{},addPostProcessor(e){this.processors[e.name]=e},handle(e,t,s,i,n){return e.forEach((e=>{t=this.processors[e]?.process(t,s,i,n)??t})),t}};const dx={},ux=e=>!Hy(e)&&"boolean"!=typeof e&&"number"!=typeof e;class px extends lx{constructor(e){let t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:{};super(),((e,t,s)=>{e.forEach((e=>{t[e]&&(s[e]=t[e])}))})(["resourceStore","languageUtils","pluralResolver","interpolator","backendConnector","i18nFormat","utils"],e,this),this.options=t,void 0===this.options.keySeparator&&(this.options.keySeparator="."),this.logger=ox.create("translator")}changeLanguage(e){e&&(this.language=e)}exists(e){let t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:{interpolation:{}};if(null==e)return!1;const s=this.resolve(e,t);return void 0!==s?.res}extractFromKey(e,t){let s=void 0!==t.nsSeparator?t.nsSeparator:this.options.nsSeparator;void 0===s&&(s=":");const i=void 0!==t.keySeparator?t.keySeparator:this.options.keySeparator;let n=t.ns||this.options.defaultNS||[];const a=s&&e.indexOf(s)>-1,r=!(this.options.userDefinedKeySeparator||t.keySeparator||this.options.userDefinedNsSeparator||t.nsSeparator||((e,t,s)=>{t=t||"",s=s||"";const i=tx.filter((e=>t.indexOf(e)<0&&s.indexOf(e)<0));if(0===i.length)return!0;const n=sx.getRegExp(`(${i.map((e=>"?"===e?"\\?":e)).join("|")})`);let a=!n.test(e);if(!a){const t=e.indexOf(s);t>0&&!n.test(e.substring(0,t))&&(a=!0)}return a})(e,s,i));if(a&&!r){const t=e.match(this.interpolator.nestingRegexp);if(t&&t.length>0)return{key:e,namespaces:Hy(n)?[n]:n};const a=e.split(s);(s!==i||s===i&&this.options.ns.indexOf(a[0])>-1)&&(n=a.shift()),e=a.join(i)}return{key:e,namespaces:Hy(n)?[n]:n}}translate(e,t,s){if("object"!=typeof t&&this.options.overloadTranslationOptionHandler&&(t=this.options.overloadTranslationOptionHandler(arguments)),"object"==typeof t&&(t={...t}),t||(t={}),null==e)return"";Array.isArray(e)||(e=[String(e)]);const i=void 0!==t.returnDetails?t.returnDetails:this.options.returnDetails,n=void 0!==t.keySeparator?t.keySeparator:this.options.keySeparator,{key:a,namespaces:r}=this.extractFromKey(e[e.length-1],t),o=r[r.length-1],l=t.lng||this.language,h=t.appendNamespaceToCIMode||this.options.appendNamespaceToCIMode;if("cimode"===l?.toLowerCase()){if(h){const e=t.nsSeparator||this.options.nsSeparator;return i?{res:`${o}${e}${a}`,usedKey:a,exactUsedKey:a,usedLng:l,usedNS:o,usedParams:this.getUsedParamsDetails(t)}:`${o}${e}${a}`}return i?{res:a,usedKey:a,exactUsedKey:a,usedLng:l,usedNS:o,usedParams:this.getUsedParamsDetails(t)}:a}const c=this.resolve(e,t);let d=c?.res;const u=c?.usedKey||a,p=c?.exactUsedKey||a,m=void 0!==t.joinArrays?t.joinArrays:this.options.joinArrays,f=!this.i18nFormat||this.i18nFormat.handleAsObject,g=void 0!==t.count&&!Hy(t.count),v=px.hasDefaultValue(t),_=g?this.pluralResolver.getSuffix(l,t.count,t):"",y=t.ordinal&&g?this.pluralResolver.getSuffix(l,t.count,{ordinal:!1}):"",x=g&&!t.ordinal&&0===t.count,w=x&&t[`defaultValue${this.options.pluralSeparator}zero`]||t[`defaultValue${_}`]||t[`defaultValue${y}`]||t.defaultValue;let b=d;f&&!d&&v&&(b=w);const C=ux(b),S=Object.prototype.toString.apply(b);if(!(f&&b&&C&&["[object Number]","[object Function]","[object RegExp]"].indexOf(S)<0)||Hy(m)&&Array.isArray(b))if(f&&Hy(m)&&Array.isArray(d))d=d.join(m),d&&(d=this.extendTranslation(d,e,t,s));else{let i=!1,r=!1;!this.isValidLookup(d)&&v&&(i=!0,d=w),this.isValidLookup(d)||(r=!0,d=a);const h=(t.missingKeyNoValueFallbackToKey||this.options.missingKeyNoValueFallbackToKey)&&r?void 0:d,u=v&&w!==d&&this.options.updateMissing;if(r||i||u){if(this.logger.log(u?"updateKey":"missingKey",l,o,a,u?w:d),n){const e=this.resolve(a,{...t,keySeparator:!1});e&&e.res&&this.logger.warn("Seems the loaded translations were in flat JSON format instead of nested. Either set keySeparator: false on init or make sure your translations are published in nested format.")}let e=[];const s=this.languageUtils.getFallbackCodes(this.options.fallbackLng,t.lng||this.language);if("fallback"===this.options.saveMissingTo&&s&&s[0])for(let t=0;t<s.length;t++)e.push(s[t]);else"all"===this.options.saveMissingTo?e=this.languageUtils.toResolveHierarchy(t.lng||this.language):e.push(t.lng||this.language);const i=(e,s,i)=>{const n=v&&i!==d?i:h;this.options.missingKeyHandler?this.options.missingKeyHandler(e,o,s,n,u,t):this.backendConnector?.saveMissing&&this.backendConnector.saveMissing(e,o,s,n,u,t),this.emit("missingKey",e,o,s,d)};this.options.saveMissing&&(this.options.saveMissingPlurals&&g?e.forEach((e=>{const s=this.pluralResolver.getSuffixes(e,t);x&&t[`defaultValue${this.options.pluralSeparator}zero`]&&s.indexOf(`${this.options.pluralSeparator}zero`)<0&&s.push(`${this.options.pluralSeparator}zero`),s.forEach((s=>{i([e],a+s,t[`defaultValue${s}`]||w)}))})):i(e,a,w))}d=this.extendTranslation(d,e,t,c,s),r&&d===a&&this.options.appendNamespaceToMissingKey&&(d=`${o}:${a}`),(r||i)&&this.options.parseMissingKeyHandler&&(d=this.options.parseMissingKeyHandler(this.options.appendNamespaceToMissingKey?`${o}:${a}`:a,i?d:void 0))}else{if(!t.returnObjects&&!this.options.returnObjects){this.options.returnedObjectHandler||this.logger.warn("accessing an object - but returnObjects options is not enabled!");const e=this.options.returnedObjectHandler?this.options.returnedObjectHandler(u,b,{...t,ns:r}):`key '${a} (${this.language})' returned an object instead of string.`;return i?(c.res=e,c.usedParams=this.getUsedParamsDetails(t),c):e}if(n){const e=Array.isArray(b),s=e?[]:{},i=e?p:u;for(const e in b)if(Object.prototype.hasOwnProperty.call(b,e)){const a=`${i}${n}${e}`;s[e]=v&&!d?this.translate(a,{...t,defaultValue:ux(w)?w[e]:void 0,joinArrays:!1,ns:r}):this.translate(a,{...t,joinArrays:!1,ns:r}),s[e]===a&&(s[e]=b[e])}d=s}}return i?(c.res=d,c.usedParams=this.getUsedParamsDetails(t),c):d}extendTranslation(e,t,s,i,n){var a=this;if(this.i18nFormat?.parse)e=this.i18nFormat.parse(e,{...this.options.interpolation.defaultVariables,...s},s.lng||this.language||i.usedLng,i.usedNS,i.usedKey,{resolved:i});else if(!s.skipInterpolation){s.interpolation&&this.interpolator.init({...s,interpolation:{...this.options.interpolation,...s.interpolation}});const r=Hy(e)&&(void 0!==s?.interpolation?.skipOnVariables?s.interpolation.skipOnVariables:this.options.interpolation.skipOnVariables);let o;if(r){const t=e.match(this.interpolator.nestingRegexp);o=t&&t.length}let l=s.replace&&!Hy(s.replace)?s.replace:s;if(this.options.interpolation.defaultVariables&&(l={...this.options.interpolation.defaultVariables,...l}),e=this.interpolator.interpolate(e,l,s.lng||this.language||i.usedLng,s),r){const t=e.match(this.interpolator.nestingRegexp);o<(t&&t.length)&&(s.nest=!1)}!s.lng&&i&&i.res&&(s.lng=this.language||i.usedLng),!1!==s.nest&&(e=this.interpolator.nest(e,(function(){for(var e=arguments.length,i=new Array(e),r=0;r<e;r++)i[r]=arguments[r];return n?.[0]!==i[0]||s.context?a.translate(...i,t):(a.logger.warn(`It seems you are nesting recursively key: ${i[0]} in key: ${t[0]}`),null)}),s)),s.interpolation&&this.interpolator.reset()}const r=s.postProcess||this.options.postProcess,o=Hy(r)?[r]:r;return null!=e&&o?.length&&!1!==s.applyPostProcessor&&(e=cx.handle(o,e,t,this.options&&this.options.postProcessPassResolved?{i18nResolved:{...i,usedParams:this.getUsedParamsDetails(s)},...s}:s,this)),e}resolve(e){let t,s,i,n,a,r=arguments.length>1&&void 0!==arguments[1]?arguments[1]:{};return Hy(e)&&(e=[e]),e.forEach((e=>{if(this.isValidLookup(t))return;const o=this.extractFromKey(e,r),l=o.key;s=l;let h=o.namespaces;this.options.fallbackNS&&(h=h.concat(this.options.fallbackNS));const c=void 0!==r.count&&!Hy(r.count),d=c&&!r.ordinal&&0===r.count,u=void 0!==r.context&&(Hy(r.context)||"number"==typeof r.context)&&""!==r.context,p=r.lngs?r.lngs:this.languageUtils.toResolveHierarchy(r.lng||this.language,r.fallbackLng);h.forEach((e=>{this.isValidLookup(t)||(a=e,dx[`${p[0]}-${e}`]||!this.utils?.hasLoadedNamespace||this.utils?.hasLoadedNamespace(a)||(dx[`${p[0]}-${e}`]=!0,this.logger.warn(`key "${s}" for languages "${p.join(", ")}" won't get resolved as namespace "${a}" was not yet loaded`,"This means something IS WRONG in your setup. You access the t function before i18next.init / i18next.loadNamespace / i18next.changeLanguage was done. Wait for the callback or Promise to resolve before accessing it!!!")),p.forEach((s=>{if(this.isValidLookup(t))return;n=s;const a=[l];if(this.i18nFormat?.addLookupKeys)this.i18nFormat.addLookupKeys(a,l,s,e,r);else{let e;c&&(e=this.pluralResolver.getSuffix(s,r.count,r));const t=`${this.options.pluralSeparator}zero`,i=`${this.options.pluralSeparator}ordinal${this.options.pluralSeparator}`;if(c&&(a.push(l+e),r.ordinal&&0===e.indexOf(i)&&a.push(l+e.replace(i,this.options.pluralSeparator)),d&&a.push(l+t)),u){const s=`${l}${this.options.contextSeparator}${r.context}`;a.push(s),c&&(a.push(s+e),r.ordinal&&0===e.indexOf(i)&&a.push(s+e.replace(i,this.options.pluralSeparator)),d&&a.push(s+t))}}let o;for(;o=a.pop();)this.isValidLookup(t)||(i=o,t=this.getResource(s,e,o,r))})))}))})),{res:t,usedKey:s,exactUsedKey:i,usedLng:n,usedNS:a}}isValidLookup(e){return!(void 0===e||!this.options.returnNull&&null===e||!this.options.returnEmptyString&&""===e)}getResource(e,t,s){let i=arguments.length>3&&void 0!==arguments[3]?arguments[3]:{};return this.i18nFormat?.getResource?this.i18nFormat.getResource(e,t,s,i):this.resourceStore.getResource(e,t,s,i)}getUsedParamsDetails(){let e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:{};const t=["defaultValue","ordinal","context","replace","lng","lngs","fallbackLng","ns","keySeparator","nsSeparator","returnObjects","returnDetails","joinArrays","postProcess","interpolation"],s=e.replace&&!Hy(e.replace);let i=s?e.replace:e;if(s&&void 0!==e.count&&(i.count=e.count),this.options.interpolation.defaultVariables&&(i={...this.options.interpolation.defaultVariables,...i}),!s){i={...i};for(const e of t)delete i[e]}return i}static hasDefaultValue(e){const t="defaultValue";for(const s in e)if(Object.prototype.hasOwnProperty.call(e,s)&&t===s.substring(0,12)&&void 0!==e[s])return!0;return!1}}class mx{constructor(e){this.options=e,this.supportedLngs=this.options.supportedLngs||!1,this.logger=ox.create("languageUtils")}getScriptPartFromCode(e){if(!(e=nx(e))||e.indexOf("-")<0)return null;const t=e.split("-");return 2===t.length?null:(t.pop(),"x"===t[t.length-1].toLowerCase()?null:this.formatLanguageCode(t.join("-")))}getLanguagePartFromCode(e){if(!(e=nx(e))||e.indexOf("-")<0)return e;const t=e.split("-");return this.formatLanguageCode(t[0])}formatLanguageCode(e){if(Hy(e)&&e.indexOf("-")>-1){let t;try{t=Intl.getCanonicalLocales(e)[0]}catch(e){}return t&&this.options.lowerCaseLng&&(t=t.toLowerCase()),t||(this.options.lowerCaseLng?e.toLowerCase():e)}return this.options.cleanCode||this.options.lowerCaseLng?e.toLowerCase():e}isSupportedCode(e){return("languageOnly"===this.options.load||this.options.nonExplicitSupportedLngs)&&(e=this.getLanguagePartFromCode(e)),!this.supportedLngs||!this.supportedLngs.length||this.supportedLngs.indexOf(e)>-1}getBestMatchFromCodes(e){if(!e)return null;let t;return e.forEach((e=>{if(t)return;const s=this.formatLanguageCode(e);this.options.supportedLngs&&!this.isSupportedCode(s)||(t=s)})),!t&&this.options.supportedLngs&&e.forEach((e=>{if(t)return;const s=this.getLanguagePartFromCode(e);if(this.isSupportedCode(s))return t=s;t=this.options.supportedLngs.find((e=>e===s?e:e.indexOf("-")<0&&s.indexOf("-")<0?void 0:e.indexOf("-")>0&&s.indexOf("-")<0&&e.substring(0,e.indexOf("-"))===s||0===e.indexOf(s)&&s.length>1?e:void 0))})),t||(t=this.getFallbackCodes(this.options.fallbackLng)[0]),t}getFallbackCodes(e,t){if(!e)return[];if("function"==typeof e&&(e=e(t)),Hy(e)&&(e=[e]),Array.isArray(e))return e;if(!t)return e.default||[];let s=e[t];return s||(s=e[this.getScriptPartFromCode(t)]),s||(s=e[this.formatLanguageCode(t)]),s||(s=e[this.getLanguagePartFromCode(t)]),s||(s=e.default),s||[]}toResolveHierarchy(e,t){const s=this.getFallbackCodes(t||this.options.fallbackLng||[],e),i=[],n=e=>{e&&(this.isSupportedCode(e)?i.push(e):this.logger.warn(`rejecting language code not found in supportedLngs: ${e}`))};return Hy(e)&&(e.indexOf("-")>-1||e.indexOf("_")>-1)?("languageOnly"!==this.options.load&&n(this.formatLanguageCode(e)),"languageOnly"!==this.options.load&&"currentOnly"!==this.options.load&&n(this.getScriptPartFromCode(e)),"currentOnly"!==this.options.load&&n(this.getLanguagePartFromCode(e))):Hy(e)&&n(this.formatLanguageCode(e)),s.forEach((e=>{i.indexOf(e)<0&&n(this.formatLanguageCode(e))})),i}}const fx={zero:0,one:1,two:2,few:3,many:4,other:5},gx={select:e=>1===e?"one":"other",resolvedOptions:()=>({pluralCategories:["one","other"]})};class vx{constructor(e){let t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:{};this.languageUtils=e,this.options=t,this.logger=ox.create("pluralResolver"),this.pluralRulesCache={}}addRule(e,t){this.rules[e]=t}clearCache(){this.pluralRulesCache={}}getRule(e){let t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:{};const s=nx("dev"===e?"en":e),i=t.ordinal?"ordinal":"cardinal",n=JSON.stringify({cleanedCode:s,type:i});if(n in this.pluralRulesCache)return this.pluralRulesCache[n];let a;try{a=new Intl.PluralRules(s,{type:i})}catch(s){if(!Intl)return this.logger.error("No Intl support, please use an Intl polyfill!"),gx;if(!e.match(/-|_/))return gx;const i=this.languageUtils.getLanguagePartFromCode(e);a=this.getRule(i,t)}return this.pluralRulesCache[n]=a,a}needsPlural(e){let t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:{},s=this.getRule(e,t);return s||(s=this.getRule("dev",t)),s?.resolvedOptions().pluralCategories.length>1}getPluralFormsOfKey(e,t){let s=arguments.length>2&&void 0!==arguments[2]?arguments[2]:{};return this.getSuffixes(e,s).map((e=>`${t}${e}`))}getSuffixes(e){let t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:{},s=this.getRule(e,t);return s||(s=this.getRule("dev",t)),s?s.resolvedOptions().pluralCategories.sort(((e,t)=>fx[e]-fx[t])).map((e=>`${this.options.prepend}${t.ordinal?`ordinal${this.options.prepend}`:""}${e}`)):[]}getSuffix(e,t){let s=arguments.length>2&&void 0!==arguments[2]?arguments[2]:{};const i=this.getRule(e,s);return i?`${this.options.prepend}${s.ordinal?`ordinal${this.options.prepend}`:""}${i.select(t)}`:(this.logger.warn(`no plural rule found for: ${e}`),this.getSuffix("dev",t,s))}}const _x=function(e,t,s){let i=arguments.length>3&&void 0!==arguments[3]?arguments[3]:".",n=!(arguments.length>4&&void 0!==arguments[4])||arguments[4],a=((e,t,s)=>{const i=Ky(e,s);return void 0!==i?i:Ky(t,s)})(e,t,s);return!a&&n&&Hy(s)&&(a=ix(e,s,i),void 0===a&&(a=ix(t,s,i))),a},yx=e=>e.replace(/\$/g,"$$$$");class xx{constructor(){let e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:{};this.logger=ox.create("interpolator"),this.options=e,this.format=e?.interpolation?.format||(e=>e),this.init(e)}init(){let e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:{};e.interpolation||(e.interpolation={escapeValue:!0});const{escape:t,escapeValue:s,useRawValueToEscape:i,prefix:n,prefixEscaped:a,suffix:r,suffixEscaped:o,formatSeparator:l,unescapeSuffix:h,unescapePrefix:c,nestingPrefix:d,nestingPrefixEscaped:u,nestingSuffix:p,nestingSuffixEscaped:m,nestingOptionsSeparator:f,maxReplaces:g,alwaysFormat:v}=e.interpolation;this.escape=void 0!==t?t:ex,this.escapeValue=void 0===s||s,this.useRawValueToEscape=void 0!==i&&i,this.prefix=n?Jy(n):a||"{{",this.suffix=r?Jy(r):o||"}}",this.formatSeparator=l||",",this.unescapePrefix=h?"":c||"-",this.unescapeSuffix=this.unescapePrefix?"":h||"",this.nestingPrefix=d?Jy(d):u||Jy("$t("),this.nestingSuffix=p?Jy(p):m||Jy(")"),this.nestingOptionsSeparator=f||",",this.maxReplaces=g||1e3,this.alwaysFormat=void 0!==v&&v,this.resetRegExp()}reset(){this.options&&this.init(this.options)}resetRegExp(){const e=(e,t)=>e?.source===t?(e.lastIndex=0,e):new RegExp(t,"g");this.regexp=e(this.regexp,`${this.prefix}(.+?)${this.suffix}`),this.regexpUnescape=e(this.regexpUnescape,`${this.prefix}${this.unescapePrefix}(.+?)${this.unescapeSuffix}${this.suffix}`),this.nestingRegexp=e(this.nestingRegexp,`${this.nestingPrefix}(.+?)${this.nestingSuffix}`)}interpolate(e,t,s,i){let n,a,r;const o=this.options&&this.options.interpolation&&this.options.interpolation.defaultVariables||{},l=e=>{if(e.indexOf(this.formatSeparator)<0){const n=_x(t,o,e,this.options.keySeparator,this.options.ignoreJSONStructure);return this.alwaysFormat?this.format(n,void 0,s,{...i,...t,interpolationkey:e}):n}const n=e.split(this.formatSeparator),a=n.shift().trim(),r=n.join(this.formatSeparator).trim();return this.format(_x(t,o,a,this.options.keySeparator,this.options.ignoreJSONStructure),r,s,{...i,...t,interpolationkey:a})};this.resetRegExp();const h=i?.missingInterpolationHandler||this.options.missingInterpolationHandler,c=void 0!==i?.interpolation?.skipOnVariables?i.interpolation.skipOnVariables:this.options.interpolation.skipOnVariables;return[{regex:this.regexpUnescape,safeValue:e=>yx(e)},{regex:this.regexp,safeValue:e=>this.escapeValue?yx(this.escape(e)):yx(e)}].forEach((t=>{for(r=0;n=t.regex.exec(e);){const s=n[1].trim();if(a=l(s),void 0===a)if("function"==typeof h){const t=h(e,n,i);a=Hy(t)?t:""}else if(i&&Object.prototype.hasOwnProperty.call(i,s))a="";else{if(c){a=n[0];continue}this.logger.warn(`missed to pass in variable ${s} for interpolating ${e}`),a=""}else Hy(a)||this.useRawValueToEscape||(a=Wy(a));const o=t.safeValue(a);if(e=e.replace(n[0],o),c?(t.regex.lastIndex+=a.length,t.regex.lastIndex-=n[0].length):t.regex.lastIndex=0,r++,r>=this.maxReplaces)break}})),e}nest(e,t){let s,i,n,a=arguments.length>2&&void 0!==arguments[2]?arguments[2]:{};const r=(e,t)=>{const s=this.nestingOptionsSeparator;if(e.indexOf(s)<0)return e;const i=e.split(new RegExp(`${s}[ ]*{`));let a=`{${i[1]}`;e=i[0],a=this.interpolate(a,n);const r=a.match(/'/g),o=a.match(/"/g);((r?.length??0)%2==0&&!o||o.length%2!=0)&&(a=a.replace(/'/g,'"'));try{n=JSON.parse(a),t&&(n={...t,...n})}catch(t){return this.logger.warn(`failed parsing options string in nesting for key ${e}`,t),`${e}${s}${a}`}return n.defaultValue&&n.defaultValue.indexOf(this.prefix)>-1&&delete n.defaultValue,e};for(;s=this.nestingRegexp.exec(e);){let o=[];n={...a},n=n.replace&&!Hy(n.replace)?n.replace:n,n.applyPostProcessor=!1,delete n.defaultValue;let l=!1;if(-1!==s[0].indexOf(this.formatSeparator)&&!/{.*}/.test(s[1])){const e=s[1].split(this.formatSeparator).map((e=>e.trim()));s[1]=e.shift(),o=e,l=!0}if(i=t(r.call(this,s[1].trim(),n),n),i&&s[0]===e&&!Hy(i))return i;Hy(i)||(i=Wy(i)),i||(this.logger.warn(`missed to resolve ${s[1]} for nesting ${e}`),i=""),l&&(i=o.reduce(((e,t)=>this.format(e,t,a.lng,{...a,interpolationkey:s[1].trim()})),i.trim())),e=e.replace(s[0],i),this.regexp.lastIndex=0}return e}}const wx=e=>{const t={};return(s,i,n)=>{let a=n;n&&n.interpolationkey&&n.formatParams&&n.formatParams[n.interpolationkey]&&n[n.interpolationkey]&&(a={...a,[n.interpolationkey]:void 0});const r=i+JSON.stringify(a);let o=t[r];return o||(o=e(nx(i),n),t[r]=o),o(s)}};class bx{constructor(){let e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:{};this.logger=ox.create("formatter"),this.options=e,this.formats={number:wx(((e,t)=>{const s=new Intl.NumberFormat(e,{...t});return e=>s.format(e)})),currency:wx(((e,t)=>{const s=new Intl.NumberFormat(e,{...t,style:"currency"});return e=>s.format(e)})),datetime:wx(((e,t)=>{const s=new Intl.DateTimeFormat(e,{...t});return e=>s.format(e)})),relativetime:wx(((e,t)=>{const s=new Intl.RelativeTimeFormat(e,{...t});return e=>s.format(e,t.range||"day")})),list:wx(((e,t)=>{const s=new Intl.ListFormat(e,{...t});return e=>s.format(e)}))},this.init(e)}init(e){let t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:{interpolation:{}};this.formatSeparator=t.interpolation.formatSeparator||","}add(e,t){this.formats[e.toLowerCase().trim()]=t}addCached(e,t){this.formats[e.toLowerCase().trim()]=wx(t)}format(e,t,s){let i=arguments.length>3&&void 0!==arguments[3]?arguments[3]:{};const n=t.split(this.formatSeparator);if(n.length>1&&n[0].indexOf("(")>1&&n[0].indexOf(")")<0&&n.find((e=>e.indexOf(")")>-1))){const e=n.findIndex((e=>e.indexOf(")")>-1));n[0]=[n[0],...n.splice(1,e)].join(this.formatSeparator)}const a=n.reduce(((e,t)=>{const{formatName:n,formatOptions:a}=(e=>{let t=e.toLowerCase().trim();const s={};if(e.indexOf("(")>-1){const i=e.split("(");t=i[0].toLowerCase().trim();const n=i[1].substring(0,i[1].length-1);"currency"===t&&n.indexOf(":")<0?s.currency||(s.currency=n.trim()):"relativetime"===t&&n.indexOf(":")<0?s.range||(s.range=n.trim()):n.split(";").forEach((e=>{if(e){const[t,...i]=e.split(":"),n=i.join(":").trim().replace(/^'+|'+$/g,""),a=t.trim();s[a]||(s[a]=n),"false"===n&&(s[a]=!1),"true"===n&&(s[a]=!0),isNaN(n)||(s[a]=parseInt(n,10))}}))}return{formatName:t,formatOptions:s}})(t);if(this.formats[n]){let t=e;try{const r=i?.formatParams?.[i.interpolationkey]||{},o=r.locale||r.lng||i.locale||i.lng||s;t=this.formats[n](e,o,{...a,...i,...r})}catch(e){this.logger.warn(e)}return t}return this.logger.warn(`there was no format function for ${n}`),e}),e);return a}}class Cx extends lx{constructor(e,t,s){let i=arguments.length>3&&void 0!==arguments[3]?arguments[3]:{};super(),this.backend=e,this.store=t,this.services=s,this.languageUtils=s.languageUtils,this.options=i,this.logger=ox.create("backendConnector"),this.waitingReads=[],this.maxParallelReads=i.maxParallelReads||10,this.readingCalls=0,this.maxRetries=i.maxRetries>=0?i.maxRetries:5,this.retryTimeout=i.retryTimeout>=1?i.retryTimeout:350,this.state={},this.queue=[],this.backend?.init?.(s,i.backend,i)}queueLoad(e,t,s,i){const n={},a={},r={},o={};return e.forEach((e=>{let i=!0;t.forEach((t=>{const r=`${e}|${t}`;!s.reload&&this.store.hasResourceBundle(e,t)?this.state[r]=2:this.state[r]<0||(1===this.state[r]?void 0===a[r]&&(a[r]=!0):(this.state[r]=1,i=!1,void 0===a[r]&&(a[r]=!0),void 0===n[r]&&(n[r]=!0),void 0===o[t]&&(o[t]=!0)))})),i||(r[e]=!0)})),(Object.keys(n).length||Object.keys(a).length)&&this.queue.push({pending:a,pendingCount:Object.keys(a).length,loaded:{},errors:[],callback:i}),{toLoad:Object.keys(n),pending:Object.keys(a),toLoadLanguages:Object.keys(r),toLoadNamespaces:Object.keys(o)}}loaded(e,t,s){const i=e.split("|"),n=i[0],a=i[1];t&&this.emit("failedLoading",n,a,t),!t&&s&&this.store.addResourceBundle(n,a,s,void 0,void 0,{skipCopy:!0}),this.state[e]=t?-1:2,t&&s&&(this.state[e]=0);const r={};this.queue.forEach((s=>{((e,t,s)=>{const{obj:i,k:n}=Yy(e,t,Object);i[n]=i[n]||[],i[n].push(s)})(s.loaded,[n],a),((e,t)=>{void 0!==e.pending[t]&&(delete e.pending[t],e.pendingCount--)})(s,e),t&&s.errors.push(t),0!==s.pendingCount||s.done||(Object.keys(s.loaded).forEach((e=>{r[e]||(r[e]={});const t=s.loaded[e];t.length&&t.forEach((t=>{void 0===r[e][t]&&(r[e][t]=!0)}))})),s.done=!0,s.errors.length?s.callback(s.errors):s.callback())})),this.emit("loaded",r),this.queue=this.queue.filter((e=>!e.done))}read(e,t,s){let i=arguments.length>3&&void 0!==arguments[3]?arguments[3]:0,n=arguments.length>4&&void 0!==arguments[4]?arguments[4]:this.retryTimeout,a=arguments.length>5?arguments[5]:void 0;if(!e.length)return a(null,{});if(this.readingCalls>=this.maxParallelReads)return void this.waitingReads.push({lng:e,ns:t,fcName:s,tried:i,wait:n,callback:a});this.readingCalls++;const r=(r,o)=>{if(this.readingCalls--,this.waitingReads.length>0){const e=this.waitingReads.shift();this.read(e.lng,e.ns,e.fcName,e.tried,e.wait,e.callback)}r&&o&&i<this.maxRetries?setTimeout((()=>{this.read.call(this,e,t,s,i+1,2*n,a)}),n):a(r,o)},o=this.backend[s].bind(this.backend);if(2!==o.length)return o(e,t,r);try{const s=o(e,t);s&&"function"==typeof s.then?s.then((e=>r(null,e))).catch(r):r(null,s)}catch(e){r(e)}}prepareLoading(e,t){let s=arguments.length>2&&void 0!==arguments[2]?arguments[2]:{},i=arguments.length>3?arguments[3]:void 0;if(!this.backend)return this.logger.warn("No backend was added via i18next.use. Will not load resources."),i&&i();Hy(e)&&(e=this.languageUtils.toResolveHierarchy(e)),Hy(t)&&(t=[t]);const n=this.queueLoad(e,t,s,i);if(!n.toLoad.length)return n.pending.length||i(),null;n.toLoad.forEach((e=>{this.loadOne(e)}))}load(e,t,s){this.prepareLoading(e,t,{},s)}reload(e,t,s){this.prepareLoading(e,t,{reload:!0},s)}loadOne(e){let t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:"";const s=e.split("|"),i=s[0],n=s[1];this.read(i,n,"read",void 0,void 0,((s,a)=>{s&&this.logger.warn(`${t}loading namespace ${n} for language ${i} failed`,s),!s&&a&&this.logger.log(`${t}loaded namespace ${n} for language ${i}`,a),this.loaded(e,s,a)}))}saveMissing(e,t,s,i,n){let a=arguments.length>5&&void 0!==arguments[5]?arguments[5]:{},r=arguments.length>6&&void 0!==arguments[6]?arguments[6]:()=>{};if(!this.services?.utils?.hasLoadedNamespace||this.services?.utils?.hasLoadedNamespace(t)){if(null!=s&&""!==s){if(this.backend?.create){const o={...a,isUpdate:n},l=this.backend.create.bind(this.backend);if(l.length<6)try{let n;n=5===l.length?l(e,t,s,i,o):l(e,t,s,i),n&&"function"==typeof n.then?n.then((e=>r(null,e))).catch(r):r(null,n)}catch(e){r(e)}else l(e,t,s,i,r,o)}e&&e[0]&&this.store.addResource(e[0],t,s,i)}}else this.logger.warn(`did not save key "${s}" as the namespace "${t}" was not yet loaded`,"This means something IS WRONG in your setup. You access the t function before i18next.init / i18next.loadNamespace / i18next.changeLanguage was done. Wait for the callback or Promise to resolve before accessing it!!!")}}const Sx=()=>({debug:!1,initAsync:!0,ns:["translation"],defaultNS:["translation"],fallbackLng:["dev"],fallbackNS:!1,supportedLngs:!1,nonExplicitSupportedLngs:!1,load:"all",preload:!1,simplifyPluralSuffix:!0,keySeparator:".",nsSeparator:":",pluralSeparator:"_",contextSeparator:"_",partialBundledLanguages:!1,saveMissing:!1,updateMissing:!1,saveMissingTo:"fallback",saveMissingPlurals:!0,missingKeyHandler:!1,missingInterpolationHandler:!1,postProcess:!1,postProcessPassResolved:!1,returnNull:!1,returnEmptyString:!0,returnObjects:!1,joinArrays:!1,returnedObjectHandler:!1,parseMissingKeyHandler:!1,appendNamespaceToMissingKey:!1,appendNamespaceToCIMode:!1,overloadTranslationOptionHandler:e=>{let t={};if("object"==typeof e[1]&&(t=e[1]),Hy(e[1])&&(t.defaultValue=e[1]),Hy(e[2])&&(t.tDescription=e[2]),"object"==typeof e[2]||"object"==typeof e[3]){const s=e[3]||e[2];Object.keys(s).forEach((e=>{t[e]=s[e]}))}return t},interpolation:{escapeValue:!0,format:e=>e,prefix:"{{",suffix:"}}",formatSeparator:",",unescapePrefix:"-",nestingPrefix:"$t(",nestingSuffix:")",nestingOptionsSeparator:",",maxReplaces:1e3,skipOnVariables:!0}}),Ax=e=>(Hy(e.ns)&&(e.ns=[e.ns]),Hy(e.fallbackLng)&&(e.fallbackLng=[e.fallbackLng]),Hy(e.fallbackNS)&&(e.fallbackNS=[e.fallbackNS]),e.supportedLngs?.indexOf?.("cimode")<0&&(e.supportedLngs=e.supportedLngs.concat(["cimode"])),"boolean"==typeof e.initImmediate&&(e.initAsync=e.initImmediate),e),Tx=()=>{};class Px extends lx{constructor(){let e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:{},t=arguments.length>1?arguments[1]:void 0;var s;if(super(),this.options=Ax(e),this.services={},this.logger=ox,this.modules={external:[]},s=this,Object.getOwnPropertyNames(Object.getPrototypeOf(s)).forEach((e=>{"function"==typeof s[e]&&(s[e]=s[e].bind(s))})),t&&!this.isInitialized&&!e.isClone){if(!this.options.initAsync)return this.init(e,t),this;setTimeout((()=>{this.init(e,t)}),0)}}init(){var e=this;let t=arguments.length>0&&void 0!==arguments[0]?arguments[0]:{},s=arguments.length>1?arguments[1]:void 0;this.isInitializing=!0,"function"==typeof t&&(s=t,t={}),null==t.defaultNS&&t.ns&&(Hy(t.ns)?t.defaultNS=t.ns:t.ns.indexOf("translation")<0&&(t.defaultNS=t.ns[0]));const i=Sx();this.options={...i,...this.options,...Ax(t)},this.options.interpolation={...i.interpolation,...this.options.interpolation},void 0!==t.keySeparator&&(this.options.userDefinedKeySeparator=t.keySeparator),void 0!==t.nsSeparator&&(this.options.userDefinedNsSeparator=t.nsSeparator);const n=e=>e?"function"==typeof e?new e:e:null;if(!this.options.isClone){let t;this.modules.logger?ox.init(n(this.modules.logger),this.options):ox.init(null,this.options),t=this.modules.formatter?this.modules.formatter:bx;const s=new mx(this.options);this.store=new hx(this.options.resources,this.options);const a=this.services;a.logger=ox,a.resourceStore=this.store,a.languageUtils=s,a.pluralResolver=new vx(s,{prepend:this.options.pluralSeparator,simplifyPluralSuffix:this.options.simplifyPluralSuffix}),!t||this.options.interpolation.format&&this.options.interpolation.format!==i.interpolation.format||(a.formatter=n(t),a.formatter.init(a,this.options),this.options.interpolation.format=a.formatter.format.bind(a.formatter)),a.interpolator=new xx(this.options),a.utils={hasLoadedNamespace:this.hasLoadedNamespace.bind(this)},a.backendConnector=new Cx(n(this.modules.backend),a.resourceStore,a,this.options),a.backendConnector.on("*",(function(t){for(var s=arguments.length,i=new Array(s>1?s-1:0),n=1;n<s;n++)i[n-1]=arguments[n];e.emit(t,...i)})),this.modules.languageDetector&&(a.languageDetector=n(this.modules.languageDetector),a.languageDetector.init&&a.languageDetector.init(a,this.options.detection,this.options)),this.modules.i18nFormat&&(a.i18nFormat=n(this.modules.i18nFormat),a.i18nFormat.init&&a.i18nFormat.init(this)),this.translator=new px(this.services,this.options),this.translator.on("*",(function(t){for(var s=arguments.length,i=new Array(s>1?s-1:0),n=1;n<s;n++)i[n-1]=arguments[n];e.emit(t,...i)})),this.modules.external.forEach((e=>{e.init&&e.init(this)}))}if(this.format=this.options.interpolation.format,s||(s=Tx),this.options.fallbackLng&&!this.services.languageDetector&&!this.options.lng){const e=this.services.languageUtils.getFallbackCodes(this.options.fallbackLng);e.length>0&&"dev"!==e[0]&&(this.options.lng=e[0])}this.services.languageDetector||this.options.lng||this.logger.warn("init: no languageDetector is used and no lng is defined");["getResource","hasResourceBundle","getResourceBundle","getDataByLanguage"].forEach((t=>{this[t]=function(){return e.store[t](...arguments)}}));["addResource","addResources","addResourceBundle","removeResourceBundle"].forEach((t=>{this[t]=function(){return e.store[t](...arguments),e}}));const a=Gy(),r=()=>{const e=(e,t)=>{this.isInitializing=!1,this.isInitialized&&!this.initializedStoreOnce&&this.logger.warn("init: i18next is already initialized. You should call init just once!"),this.isInitialized=!0,this.options.isClone||this.logger.log("initialized",this.options),this.emit("initialized",this.options),a.resolve(t),s(e,t)};if(this.languages&&!this.isInitialized)return e(null,this.t.bind(this));this.changeLanguage(this.options.lng,e)};return this.options.resources||!this.options.initAsync?r():setTimeout(r,0),a}loadResources(e){let t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:Tx;const s=Hy(e)?e:this.language;if("function"==typeof e&&(t=e),!this.options.resources||this.options.partialBundledLanguages){if("cimode"===s?.toLowerCase()&&(!this.options.preload||0===this.options.preload.length))return t();const e=[],i=t=>{if(!t)return;if("cimode"===t)return;this.services.languageUtils.toResolveHierarchy(t).forEach((t=>{"cimode"!==t&&e.indexOf(t)<0&&e.push(t)}))};if(s)i(s);else{this.services.languageUtils.getFallbackCodes(this.options.fallbackLng).forEach((e=>i(e)))}this.options.preload?.forEach?.((e=>i(e))),this.services.backendConnector.load(e,this.options.ns,(e=>{e||this.resolvedLanguage||!this.language||this.setResolvedLanguage(this.language),t(e)}))}else t(null)}reloadResources(e,t,s){const i=Gy();return"function"==typeof e&&(s=e,e=void 0),"function"==typeof t&&(s=t,t=void 0),e||(e=this.languages),t||(t=this.options.ns),s||(s=Tx),this.services.backendConnector.reload(e,t,(e=>{i.resolve(),s(e)})),i}use(e){if(!e)throw new Error("You are passing an undefined module! Please check the object you are passing to i18next.use()");if(!e.type)throw new Error("You are passing a wrong module! Please check the object you are passing to i18next.use()");return"backend"===e.type&&(this.modules.backend=e),("logger"===e.type||e.log&&e.warn&&e.error)&&(this.modules.logger=e),"languageDetector"===e.type&&(this.modules.languageDetector=e),"i18nFormat"===e.type&&(this.modules.i18nFormat=e),"postProcessor"===e.type&&cx.addPostProcessor(e),"formatter"===e.type&&(this.modules.formatter=e),"3rdParty"===e.type&&this.modules.external.push(e),this}setResolvedLanguage(e){if(e&&this.languages&&!(["cimode","dev"].indexOf(e)>-1))for(let e=0;e<this.languages.length;e++){const t=this.languages[e];if(!(["cimode","dev"].indexOf(t)>-1)&&this.store.hasLanguageSomeTranslations(t)){this.resolvedLanguage=t;break}}}changeLanguage(e,t){var s=this;this.isLanguageChangingTo=e;const i=Gy();this.emit("languageChanging",e);const n=e=>{this.language=e,this.languages=this.services.languageUtils.toResolveHierarchy(e),this.resolvedLanguage=void 0,this.setResolvedLanguage(e)},a=(e,a)=>{a?(n(a),this.translator.changeLanguage(a),this.isLanguageChangingTo=void 0,this.emit("languageChanged",a),this.logger.log("languageChanged",a)):this.isLanguageChangingTo=void 0,i.resolve((function(){return s.t(...arguments)})),t&&t(e,(function(){return s.t(...arguments)}))},r=t=>{e||t||!this.services.languageDetector||(t=[]);const s=Hy(t)?t:this.services.languageUtils.getBestMatchFromCodes(t);s&&(this.language||n(s),this.translator.language||this.translator.changeLanguage(s),this.services.languageDetector?.cacheUserLanguage?.(s)),this.loadResources(s,(e=>{a(e,s)}))};return e||!this.services.languageDetector||this.services.languageDetector.async?!e&&this.services.languageDetector&&this.services.languageDetector.async?0===this.services.languageDetector.detect.length?this.services.languageDetector.detect().then(r):this.services.languageDetector.detect(r):r(e):r(this.services.languageDetector.detect()),i}getFixedT(e,t,s){var i=this;const n=function(e,t){let a;if("object"!=typeof t){for(var r=arguments.length,o=new Array(r>2?r-2:0),l=2;l<r;l++)o[l-2]=arguments[l];a=i.options.overloadTranslationOptionHandler([e,t].concat(o))}else a={...t};a.lng=a.lng||n.lng,a.lngs=a.lngs||n.lngs,a.ns=a.ns||n.ns,""!==a.keyPrefix&&(a.keyPrefix=a.keyPrefix||s||n.keyPrefix);const h=i.options.keySeparator||".";let c;return c=a.keyPrefix&&Array.isArray(e)?e.map((e=>`${a.keyPrefix}${h}${e}`)):a.keyPrefix?`${a.keyPrefix}${h}${e}`:e,i.t(c,a)};return Hy(e)?n.lng=e:n.lngs=e,n.ns=t,n.keyPrefix=s,n}t(){for(var e=arguments.length,t=new Array(e),s=0;s<e;s++)t[s]=arguments[s];return this.translator?.translate(...t)}exists(){for(var e=arguments.length,t=new Array(e),s=0;s<e;s++)t[s]=arguments[s];return this.translator?.exists(...t)}setDefaultNamespace(e){this.options.defaultNS=e}hasLoadedNamespace(e){let t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:{};if(!this.isInitialized)return this.logger.warn("hasLoadedNamespace: i18next was not initialized",this.languages),!1;if(!this.languages||!this.languages.length)return this.logger.warn("hasLoadedNamespace: i18n.languages were undefined or empty",this.languages),!1;const s=t.lng||this.resolvedLanguage||this.languages[0],i=!!this.options&&this.options.fallbackLng,n=this.languages[this.languages.length-1];if("cimode"===s.toLowerCase())return!0;const a=(e,t)=>{const s=this.services.backendConnector.state[`${e}|${t}`];return-1===s||0===s||2===s};if(t.precheck){const e=t.precheck(this,a);if(void 0!==e)return e}return!!this.hasResourceBundle(s,e)||(!(this.services.backendConnector.backend&&(!this.options.resources||this.options.partialBundledLanguages))||!(!a(s,e)||i&&!a(n,e)))}loadNamespaces(e,t){const s=Gy();return this.options.ns?(Hy(e)&&(e=[e]),e.forEach((e=>{this.options.ns.indexOf(e)<0&&this.options.ns.push(e)})),this.loadResources((e=>{s.resolve(),t&&t(e)})),s):(t&&t(),Promise.resolve())}loadLanguages(e,t){const s=Gy();Hy(e)&&(e=[e]);const i=this.options.preload||[],n=e.filter((e=>i.indexOf(e)<0&&this.services.languageUtils.isSupportedCode(e)));return n.length?(this.options.preload=i.concat(n),this.loadResources((e=>{s.resolve(),t&&t(e)})),s):(t&&t(),Promise.resolve())}dir(e){if(e||(e=this.resolvedLanguage||(this.languages?.length>0?this.languages[0]:this.language)),!e)return"rtl";const t=this.services?.languageUtils||new mx(Sx());return["ar","shu","sqr","ssh","xaa","yhd","yud","aao","abh","abv","acm","acq","acw","acx","acy","adf","ads","aeb","aec","afb","ajp","apc","apd","arb","arq","ars","ary","arz","auz","avl","ayh","ayl","ayn","ayp","bbz","pga","he","iw","ps","pbt","pbu","pst","prp","prd","ug","ur","ydd","yds","yih","ji","yi","hbo","men","xmn","fa","jpr","peo","pes","prs","dv","sam","ckb"].indexOf(t.getLanguagePartFromCode(e))>-1||e.toLowerCase().indexOf("-arab")>1?"rtl":"ltr"}static createInstance(){return new Px(arguments.length>0&&void 0!==arguments[0]?arguments[0]:{},arguments.length>1?arguments[1]:void 0)}cloneInstance(){let e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:{},t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:Tx;const s=e.forkResourceStore;s&&delete e.forkResourceStore;const i={...this.options,...e,isClone:!0},n=new Px(i);void 0===e.debug&&void 0===e.prefix||(n.logger=n.logger.clone(e));if(["store","services","language"].forEach((e=>{n[e]=this[e]})),n.services={...this.services},n.services.utils={hasLoadedNamespace:n.hasLoadedNamespace.bind(n)},s){const e=Object.keys(this.store.data).reduce(((e,t)=>(e[t]={...this.store.data[t]},Object.keys(e[t]).reduce(((s,i)=>(s[i]={...e[t][i]},s)),{}))),{});n.store=new hx(e,i),n.services.resourceStore=n.store}return n.translator=new px(n.services,i),n.translator.on("*",(function(e){for(var t=arguments.length,s=new Array(t>1?t-1:0),i=1;i<t;i++)s[i-1]=arguments[i];n.emit(e,...s)})),n.init(i,t),n.translator.options=i,n.translator.backendConnector.services.utils={hasLoadedNamespace:n.hasLoadedNamespace.bind(n)},n}toJSON(){return{options:this.options,store:this.store,language:this.language,languages:this.languages,resolvedLanguage:this.resolvedLanguage}}}const Ex=Px.createInstance();Ex.createInstance=Px.createInstance;const{slice:kx,forEach:Mx}=[];const Ix=/^[\u0009\u0020-\u007e\u0080-\u00ff]+$/,Dx={create(e,t,s,i){let n=arguments.length>4&&void 0!==arguments[4]?arguments[4]:{path:"/",sameSite:"strict"};s&&(n.expires=new Date,n.expires.setTime(n.expires.getTime()+60*s*1e3)),i&&(n.domain=i),document.cookie=function(e,t){const s=arguments.length>2&&void 0!==arguments[2]?arguments[2]:{path:"/"};let i=`${e}=${encodeURIComponent(t)}`;if(s.maxAge>0){const e=s.maxAge-0;if(Number.isNaN(e))throw new Error("maxAge should be a Number");i+=`; Max-Age=${Math.floor(e)}`}if(s.domain){if(!Ix.test(s.domain))throw new TypeError("option domain is invalid");i+=`; Domain=${s.domain}`}if(s.path){if(!Ix.test(s.path))throw new TypeError("option path is invalid");i+=`; Path=${s.path}`}if(s.expires){if("function"!=typeof s.expires.toUTCString)throw new TypeError("option expires is invalid");i+=`; Expires=${s.expires.toUTCString()}`}if(s.httpOnly&&(i+="; HttpOnly"),s.secure&&(i+="; Secure"),s.sameSite)switch("string"==typeof s.sameSite?s.sameSite.toLowerCase():s.sameSite){case!0:i+="; SameSite=Strict";break;case"lax":i+="; SameSite=Lax";break;case"strict":i+="; SameSite=Strict";break;case"none":i+="; SameSite=None";break;default:throw new TypeError("option sameSite is invalid")}return i}(e,encodeURIComponent(t),n)},read(e){const t=`${e}=`,s=document.cookie.split(";");for(let e=0;e<s.length;e++){let i=s[e];for(;" "===i.charAt(0);)i=i.substring(1,i.length);if(0===i.indexOf(t))return i.substring(t.length,i.length)}return null},remove(e){this.create(e,"",-1)}};var Rx={name:"cookie",lookup(e){let{lookupCookie:t}=e;if(t&&"undefined"!=typeof document)return Dx.read(t)||void 0},cacheUserLanguage(e,t){let{lookupCookie:s,cookieMinutes:i,cookieDomain:n,cookieOptions:a}=t;s&&"undefined"!=typeof document&&Dx.create(s,e,i,n,a)}},Lx={name:"querystring",lookup(e){let t,{lookupQuerystring:s}=e;if("undefined"!=typeof window){let{search:e}=window.location;!window.location.search&&window.location.hash?.indexOf("?")>-1&&(e=window.location.hash.substring(window.location.hash.indexOf("?")));const i=e.substring(1).split("&");for(let e=0;e<i.length;e++){const n=i[e].indexOf("=");if(n>0){i[e].substring(0,n)===s&&(t=i[e].substring(n+1))}}}return t}};let Fx=null;const Bx=()=>{if(null!==Fx)return Fx;try{if(Fx="undefined"!=typeof window&&null!==window.localStorage,!Fx)return!1;const e="i18next.translate.boo";window.localStorage.setItem(e,"foo"),window.localStorage.removeItem(e)}catch(e){Fx=!1}return Fx};var Ox={name:"localStorage",lookup(e){let{lookupLocalStorage:t}=e;if(t&&Bx())return window.localStorage.getItem(t)||void 0},cacheUserLanguage(e,t){let{lookupLocalStorage:s}=t;s&&Bx()&&window.localStorage.setItem(s,e)}};let zx=null;const Vx=()=>{if(null!==zx)return zx;try{if(zx="undefined"!=typeof window&&null!==window.sessionStorage,!zx)return!1;const e="i18next.translate.boo";window.sessionStorage.setItem(e,"foo"),window.sessionStorage.removeItem(e)}catch(e){zx=!1}return zx};var Nx={name:"sessionStorage",lookup(e){let{lookupSessionStorage:t}=e;if(t&&Vx())return window.sessionStorage.getItem(t)||void 0},cacheUserLanguage(e,t){let{lookupSessionStorage:s}=t;s&&Vx()&&window.sessionStorage.setItem(s,e)}},Ux={name:"navigator",lookup(e){const t=[];if("undefined"!=typeof navigator){const{languages:e,userLanguage:s,language:i}=navigator;if(e)for(let s=0;s<e.length;s++)t.push(e[s]);s&&t.push(s),i&&t.push(i)}return t.length>0?t:void 0}},Hx={name:"htmlTag",lookup(e){let t,{htmlTag:s}=e;const i=s||("undefined"!=typeof document?document.documentElement:null);return i&&"function"==typeof i.getAttribute&&(t=i.getAttribute("lang")),t}},Gx={name:"path",lookup(e){let{lookupFromPathIndex:t}=e;if("undefined"==typeof window)return;const s=window.location.pathname.match(/\/([a-zA-Z-]*)/g);if(!Array.isArray(s))return;const i="number"==typeof t?t:0;return s[i]?.replace("/","")}},Wx={name:"subdomain",lookup(e){let{lookupFromSubdomainIndex:t}=e;const s="number"==typeof t?t+1:1,i="undefined"!=typeof window&&window.location?.hostname?.match(/^(\w{2,5})\.(([a-z0-9-]{1,63}\.[a-z]{2,6})|localhost)/i);if(i)return i[s]}};let jx=!1;try{jx=!0}catch(e){}const qx=["querystring","cookie","localStorage","sessionStorage","navigator","htmlTag"];jx||qx.splice(1,1);class Xx{constructor(e){let t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:{};this.type="languageDetector",this.detectors={},this.init(e,t)}init(){let e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:{languageUtils:{}},t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:{},s=arguments.length>2&&void 0!==arguments[2]?arguments[2]:{};this.services=e,this.options=function(e){return Mx.call(kx.call(arguments,1),(t=>{if(t)for(const s in t)void 0===e[s]&&(e[s]=t[s])})),e}(t,this.options||{},{order:qx,lookupQuerystring:"lng",lookupCookie:"i18next",lookupLocalStorage:"i18nextLng",lookupSessionStorage:"i18nextLng",caches:["localStorage"],excludeCacheFor:["cimode"],convertDetectedLanguage:e=>e}),"string"==typeof this.options.convertDetectedLanguage&&this.options.convertDetectedLanguage.indexOf("15897")>-1&&(this.options.convertDetectedLanguage=e=>e.replace("-","_")),this.options.lookupFromUrlIndex&&(this.options.lookupFromPathIndex=this.options.lookupFromUrlIndex),this.i18nOptions=s,this.addDetector(Rx),this.addDetector(Lx),this.addDetector(Ox),this.addDetector(Nx),this.addDetector(Ux),this.addDetector(Hx),this.addDetector(Gx),this.addDetector(Wx)}addDetector(e){return this.detectors[e.name]=e,this}detect(){let e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:this.options.order,t=[];return e.forEach((e=>{if(this.detectors[e]){let s=this.detectors[e].lookup(this.options);s&&"string"==typeof s&&(s=[s]),s&&(t=t.concat(s))}})),t=t.map((e=>this.options.convertDetectedLanguage(e))),this.services&&this.services.languageUtils&&this.services.languageUtils.getBestMatchFromCodes?t:t.length>0?t[0]:null}cacheUserLanguage(e){let t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:this.options.caches;t&&(this.options.excludeCacheFor&&this.options.excludeCacheFor.indexOf(e)>-1||t.forEach((t=>{this.detectors[t]&&this.detectors[t].cacheUserLanguage(e,this.options)})))}}Xx.type="languageDetector";const Yx=e=>Ex.t(e),$x=[{description:"SuperSplat document",accept:{"application/x-supersplat":[".ssproj"]}}];class Kx{show;constructor(){const e=document.createElement("input");e.setAttribute("id","document-file-selector"),e.setAttribute("type","file"),e.setAttribute("accept",".ssproj"),e.setAttribute("multiple","false"),document.body.append(e);let t=null;e.addEventListener("change",(()=>{t(e.files[0])})),e.addEventListener("cancel",(()=>{t(null)})),this.show=s=>{t=s,e.click()}}}const Zx=(e,t)=>{const s=window.showOpenFilePicker?null:new Kx;let i=null;const n=async()=>"yes"===(await t.invoke("showPopup",{type:"yesno",header:Yx("doc.reset"),message:Yx(t.invoke("scene.dirty")?"doc.unsaved-message":"doc.reset-message")})).action,a=()=>{t.fire("scene.clear"),t.fire("camera.reset"),t.fire("doc.setName",null),i=null},r=async s=>{t.fire("startSpinner");try{a();const i=new JSZip;await i.loadAsync(s);const n=JSON.parse(await i.file("document.json").async("text"));for(let t=0;t<n.splats.length;++t){const s=`splat_${t}.ply`,a=n.splats[t],r=await i.file(`splat_${t}.ply`).async("blob"),o=URL.createObjectURL(r),l=await e.assetLoader.loadModel({url:o,filename:s});URL.revokeObjectURL(o),e.add(l),l.docDeserialize(a)}null===e.bound&&console.error("this should never fire"),t.invoke("docDeserialize.timeline",n.timeline),t.invoke("docDeserialize.poseSets",n.poseSets),t.invoke("docDeserialize.view",n.view),e.camera.docDeserialize(n.camera)}catch(e){await t.invoke("showPopup",{type:"error",header:Yx("doc.load-failed"),message:`'${e.message??e}'`})}finally{t.fire("stopSpinner")}},o=async s=>{t.fire("startSpinner");try{const i=t.invoke("scene.allSplats"),n={version:0,camera:e.camera.docSerialize(),view:t.invoke("docSerialize.view"),poseSets:t.invoke("docSerialize.poseSets"),timeline:t.invoke("docSerialize.timeline"),splats:i.map((e=>e.docSerialize()))},a={keepStateData:!1,keepWorldTransform:!0,keepColorTint:!0},r=s.stream?new B_(s.stream):new z_(s.filename),o=new H_(r);await o.file("document.json",JSON.stringify(n));for(let e=0;e<i.length;++e)await o.start(`splat_${e}.ply`),await Oy([i[e]],a,o);await o.close(),await r.close()}catch(e){await t.invoke("showPopup",{type:"error",header:Yx("doc.save-failed"),message:`'${e.message??e}'`})}finally{t.fire("stopSpinner")}};t.function("doc.new",(async()=>!!await n()&&(a(),!0))),t.function("doc.dropped",(async e=>{if(!t.invoke("scene.empty")&&!await n())return!1;await r(e),t.fire("doc.setName",e.name)})),t.function("doc.open",(async()=>{if(!t.invoke("scene.empty")&&!await n())return!1;if(s)s.show((async e=>{e&&await r(e)}));else try{const e=await window.showOpenFilePicker({id:"SuperSplatDocumentOpen",multiple:!1,types:$x});if(1===e?.length){const s=e[0];await r(await s.getFile()),i=s,t.fire("doc.setName",s.name)}}catch(e){"AbortError"!==e.name&&console.error(e)}})),t.function("doc.save",(async()=>{if(i)try{await o({stream:await i.createWritable()}),t.fire("doc.saved")}catch(e){"AbortError"!==e.name&&"NotAllowedError"!==e.name&&console.error(e)}else await t.invoke("doc.saveAs")})),t.function("doc.saveAs",(async()=>{if(window.showSaveFilePicker)try{const e=await window.showSaveFilePicker({id:"SuperSplatDocumentSave",types:$x,suggestedName:"scene.ssproj"});await o({stream:await e.createWritable()}),i=e,t.fire("doc.setName",e.name),t.fire("doc.saved")}catch(e){"AbortError"!==e.name&&console.error(e)}else await o({filename:"scene.ssproj"}),t.fire("doc.saved")}));let l=null;t.function("doc.name",(()=>l)),t.on("doc.setName",(e=>{(e=>{e!==l&&(l=e,t.fire("doc.name",l))})(e)}))};class Jx{history=[];cursor=0;events;constructor(e){this.events=e,e.on("edit.undo",(()=>{this.canUndo()&&this.undo()})),e.on("edit.redo",(()=>{this.canRedo()&&this.redo()})),e.on("edit.add",((e,t=!1)=>{this.add(e,t)}))}add(e,t=!1){for(;this.cursor<this.history.length;)this.history.pop().destroy?.();this.history.push(e),this.redo(t)}canUndo(){return this.cursor>0}canRedo(){return this.cursor<this.history.length}undo(){const e=this.history[--this.cursor];e.undo(),this.events.fire("edit.apply",e),this.fireEvents()}redo(e=!1){const t=this.history[this.cursor++];e||t.do(),this.events.fire("edit.apply",t),this.fireEvents()}fireEvents(){this.events.fire("edit.canUndo",this.canUndo()),this.events.fire("edit.canRedo",this.canRedo())}clear(){this.history.forEach((e=>{e.destroy?.()})),this.history=[],this.cursor=0}}class Qx{splat;indices;doIt;undoIt;updateFlags;constructor(e,t,s,i,n=_y.selected){const a=e.splatData,r=a.getProp("state"),o=((e,t)=>{let s=0;for(let i=0;i<e;++i)t(i)&&s++;const i=new Uint32Array(s);let n=0;for(let s=0;s<e;++s)t(s)&&(i[n++]=s);return i})(a.numSplats,(e=>t(r[e],e)));this.splat=e,this.indices=o,this.doIt=s,this.undoIt=i,this.updateFlags=n}do(){const e=this.splat.splatData.getProp("state");for(let t=0;t<this.indices.length;++t){const s=this.indices[t];e[s]=this.doIt(e[s])}this.splat.updateState(this.updateFlags)}undo(){const e=this.splat.splatData.getProp("state");for(let t=0;t<this.indices.length;++t){const s=this.indices[t];e[s]=this.undoIt(e[s])}this.splat.updateState(this.updateFlags)}destroy(){this.splat=null,this.indices=null}}class ew extends Qx{name="selectAll";constructor(e){super(e,(e=>0===e),(e=>e|_y.selected),(e=>e&~_y.selected))}}class tw extends Qx{name="selectNone";constructor(e){super(e,(e=>e===_y.selected),(e=>e&~_y.selected),(e=>e|_y.selected))}}class sw extends Qx{name="selectInvert";constructor(e){super(e,(e=>!(e&(_y.hidden|_y.deleted))),(e=>e^_y.selected),(e=>e^_y.selected))}}class iw extends Qx{name="selectOp";constructor(e,t,s){super(e,{add:(e,t)=>0===e&&s(t),remove:(e,t)=>e===_y.selected&&s(t),set:(e,t)=>e===_y.selected!==s(t)}[t],{add:e=>e|_y.selected,remove:e=>e&~_y.selected,set:e=>e^_y.selected}[t],{add:e=>e&~_y.selected,remove:e=>e|_y.selected,set:e=>e^_y.selected}[t])}}class nw extends Qx{name="hideSelection";constructor(e){super(e,(e=>e===_y.selected),(e=>e|_y.hidden),(e=>e&~_y.hidden),_y.hidden)}}class aw extends Qx{name="unhideAll";constructor(e){super(e,(e=>(e&(_y.hidden|_y.deleted))===_y.hidden),(e=>e&~_y.hidden),(e=>e|_y.hidden),_y.hidden)}}class rw extends Qx{name="deleteSelection";constructor(e){super(e,(e=>e===_y.selected),(e=>e|_y.deleted),(e=>e&~_y.deleted),_y.deleted)}}class ow extends Qx{name="reset";constructor(e){super(e,(e=>!!(e&_y.deleted)),(e=>e&~_y.deleted),(e=>e|_y.deleted),_y.deleted)}}class lw{name="entityTransform";splat;oldt;newt;constructor(e){this.splat=e.splat,this.oldt=e.oldt,this.newt=e.newt}do(){this.splat.move(this.newt.position,this.newt.rotation,this.newt.scale)}undo(){this.splat.move(this.oldt.position,this.oldt.rotation,this.oldt.scale)}destroy(){this.splat=null,this.oldt=null,this.newt=null}}const hw=new Et;class cw{name="splatsTransform";splat;transform;paletteMap;constructor(e){this.splat=e.splat,this.transform=e.transform,this.paletteMap=e.paletteMap}do(){const{splat:e,transform:t,paletteMap:s}=this,i=e.splatData.getProp("state"),n=e.transformTexture.lock();for(let e=0;e<i.length;++e)i[e]===_y.selected&&(n[e]=s.get(n[e]));e.transformTexture.unlock(),e.transformPalette.alloc(s.size);const{transformPalette:a}=e;this.paletteMap.forEach(((e,s)=>{a.getTransform(s,hw),hw.mul2(t,hw),a.setTransform(e,hw)})),e.makeSelectionBoundDirty(),e.updatePositions()}undo(){const{splat:e,paletteMap:t}=this,s=e.splatData.getProp("state"),i=e.transformTexture.lock(),n=new Map;t.forEach(((e,t)=>{n.set(e,t)})),e.transformTexture.unlock();for(let e=0;e<s.length;++e)s[e]===_y.selected&&(i[e]=n.get(i[e]));e.transformPalette.free(t.size),e.makeSelectionBoundDirty(),e.updatePositions()}destroy(){this.splat=null,this.transform=null,this.paletteMap=null}}class dw{name="setPivot";pivot;oldt;newt;constructor(e){this.pivot=e.pivot,this.oldt=e.oldt,this.newt=e.newt}do(){this.pivot.place(this.newt)}undo(){this.pivot.place(this.oldt)}}class uw{name;splat;newState;oldState;constructor(e){const{splat:t,oldState:s,newState:i}=e;this.splat=t,this.oldState=s,this.newState=i}do(){const{splat:e}=this,{tintClr:t,brightness:s,blackPoint:i,whitePoint:n,transparency:a}=this.newState;t&&(e.tintClr=t),null!==s&&(e.brightness=s),null!==i&&(e.blackPoint=i),null!==n&&(e.whitePoint=n),null!==a&&(e.transparency=a)}undo(){const{splat:e}=this,{tintClr:t,brightness:s,blackPoint:i,whitePoint:n,transparency:a}=this.oldState;t&&(e.tintClr=t),null!==s&&(e.brightness=s),null!==i&&(e.blackPoint=i),null!==n&&(e.whitePoint=n),null!==a&&(e.transparency=a)}}class pw{name="multiOp";ops;constructor(e){this.ops=e}do(){this.ops.forEach((e=>e.do()))}undo(){this.ops.forEach((e=>e.undo()))}}class mw{name;scene;splat;constructor(e,t){this.scene=e,this.splat=t}do(){this.scene.add(this.splat)}undo(){this.scene.remove(this.splat)}destroy(){this.splat.destroy()}}const fw=(e,t,s)=>{const i=new yt,n=new yt,a=new bt,r=new Et,o=()=>{const t=e.invoke("selection");return t?.visible?[t]:[]};let l=0;window.addEventListener("beforeunload",(t=>{if(!e.invoke("scene.dirty"))return;const s="You have unsaved changes. Are you sure you want to leave?";return t.returnValue=s,s})),e.on("scene.clear",(()=>{s.clear(),t.clear(),l=0})),e.function("scene.dirty",(()=>t.cursor!==l)),e.on("doc.saved",(()=>{l=t.cursor})),e.on("camera.mode",(()=>{s.forceRender=!0})),e.on("camera.overlay",(()=>{s.forceRender=!0})),e.on("camera.splatSize",(()=>{s.forceRender=!0})),e.on("view.outlineSelection",(()=>{s.forceRender=!0})),e.on("view.bands",(e=>{s.forceRender=!0})),e.on("camera.bound",(()=>{s.forceRender=!0}));const h=t=>{t!==s.grid.visible&&(s.grid.visible=t,e.fire("grid.visible",t))};e.function("grid.visible",(()=>s.grid.visible)),e.on("grid.setVisible",(e=>{h(e)})),e.on("grid.toggleVisible",(()=>{h(!s.grid.visible)})),h(s.config.show.grid);e.function("camera.fov",(()=>s.camera.fov)),e.on("camera.setFov",(t=>{(t=>{t!==s.camera.fov&&(s.camera.fov=t,e.fire("camera.fov",s.camera.fov))})(t)})),e.function("camera.tonemapping",(()=>s.camera.tonemapping)),e.on("camera.setTonemapping",(e=>{s.camera.tonemapping=e}));let c=s.config.show.bound;const d=t=>{t!==c&&(c=t,e.fire("camera.bound",c))};e.function("camera.bound",(()=>c)),e.on("camera.setBound",(e=>{d(e)})),e.on("camera.toggleBound",(()=>{d(!e.invoke("camera.bound"))})),e.on("camera.focus",(()=>{const e=o()[0];if(e){const t=e.numSelected>0?e.selectionBound:e.localBound;i.copy(t.center);const a=e.worldTransform;a.transformPoint(i,i),a.getScale(n),s.camera.focus({focalPoint:i,radius:t.halfExtents.length()*n.x,speed:1})}})),e.on("camera.reset",(()=>{const{initialAzim:e,initialElev:t,initialZoom:i}=s.config.controls,n=Math.sin(e*Math.PI/180)*Math.cos(t*Math.PI/180),a=-Math.sin(t*Math.PI/180),r=Math.cos(e*Math.PI/180)*Math.cos(t*Math.PI/180),o=i;s.camera.setPose(new yt(n*o,a*o,r*o),new yt(0,0,0))})),e.on("camera.align",(e=>{switch(e){case"px":s.camera.setAzimElev(90,0);break;case"py":s.camera.setAzimElev(0,-90);break;case"pz":s.camera.setAzimElev(0,0);break;case"nx":s.camera.setAzimElev(270,0);break;case"ny":s.camera.setAzimElev(0,90);break;case"nz":s.camera.setAzimElev(180,0)}s.camera.ortho=!0})),e.function("selection.splats",(()=>{const t=e.invoke("selection");return t?.numSelected>0})),e.on("select.all",(()=>{o().forEach((t=>{e.fire("edit.add",new ew(t))}))})),e.on("select.none",(()=>{o().forEach((t=>{e.fire("edit.add",new tw(t))}))})),e.on("select.invert",(()=>{o().forEach((t=>{e.fire("edit.add",new sw(t))}))})),e.on("select.pred",((t,s)=>{o().forEach((i=>{e.fire("edit.add",new iw(i,t,s))}))}));const u=(t,i,n)=>{const a=s.dataProcessor.intersect(n,t);e.fire("edit.add",new iw(t,i,(e=>255===a[e])))};e.on("select.bySphere",((e,t)=>{o().forEach((s=>{u(s,e,{sphere:{x:t[0],y:t[1],z:t[2],radius:t[3]}})}))})),e.on("select.rect",((t,i)=>{const n=e.invoke("camera.mode");o().forEach((a=>{if("centers"===n)u(a,t,{rect:{x1:i.start.x,y1:i.start.y,x2:i.end.x,y2:i.end.y}});else if("rings"===n){const{width:n,height:r}=s.targetSize;s.camera.pickPrep(a,t);const o=s.camera.pickRect(Math.floor(i.start.x*n),Math.floor(i.start.y*r),Math.floor((i.end.x-i.start.x)*n),Math.floor((i.end.y-i.start.y)*r)),l=new Set(o),h=e=>l.has(e);e.fire("edit.add",new iw(a,t,h))}}))}));let p=null;e.on("select.byMask",((t,i,n)=>{const a=e.invoke("camera.mode");o().forEach((r=>{if("centers"===a)p&&p.width===i.width&&p.height===i.height||(p&&p.destroy(),p=new ki(s.graphicsDevice)),p.setSource(i),u(r,t,{mask:p});else if("rings"===a){const a=n.getImageData(0,0,i.width,i.height);let o=a.width-1,l=a.height-1,h=0,c=0;for(let e=0;e<a.height;++e)for(let t=0;t<a.width;++t)255===a.data[4*(e*a.width+t)+3]&&(o=Math.min(o,t),l=Math.min(l,e),h=Math.max(h,t),c=Math.max(c,e));const{width:d,height:u}=s.targetSize,p=Math.floor(o/a.width*d),m=Math.floor(l/a.height*u),f=Math.floor(h/a.width*d)-p+1,g=Math.floor(c/a.height*u)-m+1;s.camera.pickPrep(r,t);const v=s.camera.pickRect(p,m,f,g),_=new Set;for(let e=0;e<g;++e)for(let t=0;t<f;++t){const s=Math.floor((p+t)/d*a.width),i=Math.floor((m+e)/u*a.height);255===a.data[4*(i*a.width+s)]&&_.add(v[(g-e)*f+t])}const y=e=>_.has(e);e.fire("edit.add",new iw(r,t,y))}}))})),e.on("select.point",((t,i)=>{const{width:n,height:l}=s.targetSize,h=e.invoke("camera.mode");o().forEach((o=>{const c=o.splatData;if("centers"===h){const h=c.getProp("x"),d=c.getProp("y"),u=c.getProp("z"),p=e.invoke("camera.splatSize"),m=s.camera.entity.camera,f=i.x*n,g=i.y*l;r.mul2(m.camera._viewProjMat,o.worldTransform);const v=e=>{a.set(h[e],d[e],u[e],1),r.transformVec4(a,a);const t=(a.x/a.w*.5+.5)*n,s=(-a.y/a.w*.5+.5)*l;return Math.abs(t-f)<p&&Math.abs(s-g)<p};e.fire("edit.add",new iw(o,t,v))}else if("rings"===h){s.camera.pickPrep(o,t);const a=s.camera.pickRect(Math.floor(i.x*n),Math.floor(i.y*l),1,1)[0],r=e=>e===a;e.fire("edit.add",new iw(o,t,r))}}))})),e.on("select.hide",(()=>{o().forEach((t=>{e.fire("edit.add",new nw(t))}))})),e.on("select.unhide",(()=>{o().forEach((t=>{e.fire("edit.add",new aw(t))}))})),e.on("select.delete",(()=>{o().forEach((e=>{t.add(new rw(e))}))}));const m=async e=>{const i=o(),n=new O_;await Oy(i,{maxSHBands:3,selected:!0},n);const a=n.close();if(a){const n=i[0],r=new Blob([a],{type:"octet/stream"}),o=URL.createObjectURL(r),{filename:l}=n,h=await s.assetLoader.loadPly({url:o,filename:l});"separate"===e?t.add(new pw([new rw(n),new mw(s,h)])):t.add(new mw(s,h)),URL.revokeObjectURL(o)}};e.on("select.duplicate",(async()=>{await m("duplicate")})),e.on("select.separate",(async()=>{await m("separate")})),e.on("scene.reset",(()=>{o().forEach((e=>{t.add(new ow(e))}))}));e.function("allData",(()=>s.assetLoader.loadAllData)),e.on("toggleAllData",(t=>{(t=>{t!==s.assetLoader.loadAllData&&(s.assetLoader.loadAllData=t,e.fire("allData",s.assetLoader.loadAllData))})(!e.invoke("allData"))}));let f="centers";const g=t=>{t!==f&&(f=t,e.fire("camera.mode",f))};e.function("camera.mode",(()=>f)),e.on("camera.setMode",(e=>{g(e)})),e.on("camera.toggleMode",(()=>{g("centers"===e.invoke("camera.mode")?"rings":"centers")}));let v=s.config.camera.overlay;const _=t=>{t!==v&&(v=t,e.fire("camera.overlay",v))};e.function("camera.overlay",(()=>v)),e.on("camera.setOverlay",(e=>{_(e)})),e.on("camera.toggleOverlay",(()=>{_(!e.invoke("camera.overlay"))}));let y=2;e.function("camera.splatSize",(()=>y)),e.on("camera.setSplatSize",(t=>{(t=>{t!==y&&(y=t,e.fire("camera.splatSize",y))})(t)}));e.function("camera.flySpeed",(()=>s.camera.flySpeed)),e.on("camera.setFlySpeed",(t=>{(t=>{t!==s.camera.flySpeed&&(s.camera.flySpeed=t,e.fire("camera.flySpeed",t))})(t)}));let x=!1;e.function("view.outlineSelection",(()=>x)),e.on("view.setOutlineSelection",(t=>{(t=>{t!==x&&(x=t,e.fire("view.outlineSelection",x))})(t)}));let w=s.config.show.shBands;e.function("view.bands",(()=>w)),e.on("view.setBands",(t=>{(t=>{t!==w&&(w=t,e.fire("view.bands",w))})(t)})),e.function("camera.getPose",(()=>{const e=s.camera,t=e.entity.getPosition(),i=e.focalPoint;return{position:{x:t.x,y:t.y,z:t.z},target:{x:i.x,y:i.y,z:i.z}}})),e.on("camera.setPose",((e,t=1)=>{s.camera.setPose(e.position,e.target,t)})),e.fire("camera.fov",s.camera.fov),e.fire("camera.overlay",v),e.fire("view.bands",w),e.function("docSerialize.view",(()=>{const t=e=>[e.r,e.g,e.b,e.a];return{bgColor:t(e.invoke("bgClr")),selectedColor:t(e.invoke("selectedClr")),unselectedColor:t(e.invoke("unselectedClr")),lockedColor:t(e.invoke("lockedClr")),shBands:e.invoke("view.bands"),centersSize:e.invoke("camera.splatSize"),outlineSelection:e.invoke("view.outlineSelection"),showGrid:e.invoke("grid.visible"),showBound:e.invoke("camera.bound"),flySpeed:e.invoke("camera.flySpeed")}})),e.function("docDeserialize.view",(t=>{e.fire("setBgClr",new mt(t.bgColor)),e.fire("setSelectedClr",new mt(t.selectedColor)),e.fire("setUnselectedClr",new mt(t.unselectedColor)),e.fire("setLockedClr",new mt(t.lockedColor)),e.fire("view.setBands",t.shBands),e.fire("camera.setSplatSize",t.centersSize),e.fire("view.setOutlineSelection",t.outlineSelection),e.fire("grid.setVisible",t.showGrid),e.fire("camera.setBound",t.showBound),e.fire("camera.setFlySpeed",t.flySpeed)}))};class gw extends tt{functions=new Map;function(e,t){if(this.functions.has(e))throw new Error(`error: function ${e} already exists`);this.functions.set(e,t)}invoke(e,...t){const s=this.functions.get(e);if(s)return s(...t);console.log(`error: function not found '${e}'`)}}class vw{filename;file;constructor(e,t){this.filename=e,this.file=t}}const _w=e=>{const t=[],s=[];return e.forEach((e=>{e.isFile?s.push(e):e.isDirectory&&t.push(new Promise(((t,s)=>{const i=e.createReader(),n=[],a=()=>{i.readEntries((e=>{e.length>0?(n.push(_w(e)),a()):Promise.all(n).then((e=>{t(e.flat())}))}))};a()})))})),Promise.all(t).then((e=>s.concat(...e)))},yw=(e,t)=>{e.addEventListener("dragstart",(e=>{e.preventDefault(),e.stopPropagation(),e.dataTransfer.effectAllowed="all"}),!0),e.addEventListener("dragover",(e=>{e.preventDefault(),e.stopPropagation(),e.dataTransfer.effectAllowed="all"}),!0),e.addEventListener("drop",(async e=>{e.preventDefault();const s=Array.from(e.dataTransfer.items).map((e=>e.webkitGetAsEntry())).filter((e=>e)),i=await _w(s),n=await Promise.all(i.map((e=>new Promise(((t,s)=>{e.file((s=>{t(new vw(e.fullPath.substring(1),s))}))})))));n.length>1&&(e=>{const t=e=>{const t=e.split(Ye.delimiter);return[t[0],t.slice(1).join(Ye.delimiter)]};for(;;){const s=t(e[0].filename);if(0===s[1].length)return;for(let i=1;i<e.length;++i){const n=t(e[i].filename);if(s[0]!==n[0])return}for(let s=0;s<e.length;++s)e[s].filename=t(e[s].filename)[1]}})(n),t(n,e.shiftKey)}),!0)};var xw;!function(e){e.camera="camera",e.model="model",e.splat="splat",e.shadow="shadow",e.debug="debug",e.other="other"}(xw||(xw={}));const ww=[xw.camera,xw.model,xw.splat,xw.shadow,xw.debug,xw.other];let bw=1;class Cw{type;scene=null;uid;constructor(e){this.type=e,this.uid=bw++}destroy(){this.scene&&this.scene.remove(this)}add(){}remove(){}serialize(e){}onUpdate(e){}onPostUpdate(){}onPreRender(){}onPostRender(){}onAdded(e){}onRemoved(e){}move(e,t,s){}get worldBound(){return null}}const Sw={ply:{description:"Gaussian Splat PLY File",accept:{"application/ply":[".ply"]}},"compressed-ply":{description:"Compressed Gaussian Splat PLY File",accept:{"application/ply":[".ply"]}},splat:{description:"Gaussian Splat File",accept:{"application/x-gaussian-splat":[".splat"]}},htmlViewer:{description:"Viewer HTML",accept:{"text/html":[".html"]}},packageViewer:{description:"Viewer ZIP",accept:{"application/zip":[".zip"]}}},Aw=new yt,Tw=(e,t,s,i)=>{const n=async(s,i,n=!0,a=!1)=>{try{if(!i)try{i=new URL(s,document.baseURI).pathname.split("/").pop()}catch(e){i=s}const r=(i||s).toLowerCase();if(r.endsWith(".ssproj"))await t.invoke("doc.dropped",new File([await(await fetch(s)).blob()],i));else{if(!r.endsWith(".json")){if(r.endsWith(".ply")||r.endsWith(".splat")){const t=await e.assetLoader.loadModel({url:s,filename:i,animationFrame:a});return e.add(t),n&&e.camera.focus(),t}throw new Error("Unsupported file type")}await(async(e,t,s)=>{const i=await fetch(e),n=await i.json();if(n.length>0){const e=new yt(0,0,0);n.forEach((t=>{Aw.set(t.position[0],t.position[1],t.position[2]),e.add(Aw)})),e.mulScalar(1/n.length);const i=(e,t)=>{const s=e.img_name?.match(/\d*$/)?.[0],i=t.img_name?.match(/\d*$/)?.[0];return s&&i?parseInt(s,10)-parseInt(i,10):0};n.sort(i).forEach(((i,n)=>{if(i.hasOwnProperty("position")&&i.hasOwnProperty("rotation")){const a=new yt(i.position),r=new yt(i.rotation[0][2],i.rotation[1][2],i.rotation[2][2]),o=Aw.sub2(e,a).dot(r);Aw.copy(r).mulScalar(o).add(a),s.fire("camera.addPose",{name:i.img_name??`${t}_${n}`,position:new yt(-a.x,-a.y,a.z),target:new yt(-Aw.x,-Aw.y,Aw.z)})}}))}})(s,i,t)}}catch(e){await t.invoke("showPopup",{type:"error",header:Yx("popup.error-loading"),message:`${e.message??e} while loading '${i}'`})}};let a;t.function("import",((e,t,s=!0,i=!1)=>n(e,t,s,i))),window.showOpenFilePicker||(a=document.createElement("input"),a.setAttribute("id","file-selector"),a.setAttribute("type","file"),a.setAttribute("accept",".ply,.splat"),a.setAttribute("multiple","true"),a.onchange=async()=>{const e=a.files;for(let t=0;t<e.length;t++){const e=a.files[t],s=URL.createObjectURL(e);await n(s,e.name),URL.revokeObjectURL(s)}},document.body.append(a)),yw(s,(async(e,s)=>{if(1===e.length&&e[0].file?.name?.toLowerCase().endsWith(".ssproj"))await t.invoke("doc.dropped",e[0].file);else if(0===(e=e.filter((e=>{const t=e.file?.name;if(!t)return!1;const s=t.toLowerCase();return s.endsWith(".ply")||s.endsWith(".splat")||s.endsWith(".json")}))).length)await t.invoke("showPopup",{type:"error",header:Yx("popup.error-loading"),message:Yx("popup.drop-files")});else{const s=()=>{const t=/(.*?)(\d+).ply$/,s=e[0].file.name?.toLowerCase().match(t);if(!s)return!1;for(let i=1;i<e.length;i++){const n=e[i].file.name?.toLowerCase().match(t);if(!n||n[1]!==s[1])return!1}return!0};if(e.length>1&&s())t.fire("plysequence.setFrames",e.map((e=>e.file))),t.fire("timeline.frame",0);else for(let t=0;t<e.length;t++){const s=e[t],i=URL.createObjectURL(s.file);await n(i,s.filename),URL.revokeObjectURL(i)}}}));const r=()=>e.getElementsByType(xw.splat).filter((e=>e.visible)).filter((e=>e.numSplats>0));t.function("scene.allSplats",(()=>e.getElementsByType(xw.splat))),t.function("scene.splats",(()=>r())),t.function("scene.empty",(()=>0===r().length)),t.function("scene.import",(async()=>{if(a)a.click();else try{const e=await window.showOpenFilePicker({id:"SuperSplatFileOpen",multiple:!0,types:[Sw.ply,Sw.splat]});for(let t=0;t<e.length;t++){const s=e[t],i=await s.getFile(),a=URL.createObjectURL(i);await n(a,i.name),URL.revokeObjectURL(a)}}catch(e){"AbortError"!==e.name&&console.error(e)}})),t.function("scene.openAnimation",(async()=>{try{const e=await window.showDirectoryPicker({id:"SuperSplatFileOpenAnimation",mode:"readwrite"});if(e){const s=[];for await(const t of e.values())if("file"===t.kind){const e=await t.getFile();e.name.toLowerCase().endsWith(".ply")&&s.push(e)}t.fire("plysequence.setFrames",s),t.fire("timeline.frame",0)}}catch(e){"AbortError"!==e.name&&console.error(e)}})),t.function("scene.export",(async(e,s=null,i="export")=>{const n=(e,t)=>`${(e=>e.substring(0,e.length-Ye.getExtension(e).length))(e)}${t}`,a=r()[0];let o=s??n(a.filename,{ply:".ply","compressed-ply":".compressed.ply",splat:".splat",viewer:"-viewer.html"}[e]);const l=window.showSaveFilePicker;let h;if("viewer"===e){if(h=await t.invoke("show.viewerExportPopup",l?null:o),!h)return;o=l?n(o,"html"===h.type?".html":".zip"):h.filename}if(l)try{const s="viewer"===e?"html"===h.type?Sw.htmlViewer:Sw.packageViewer:Sw[e],i=await window.showSaveFilePicker({id:"SuperSplatFileExport",types:[s],suggestedName:o});await t.invoke("scene.write",{type:e,stream:await i.createWritable(),viewerExportSettings:h})}catch(e){"AbortError"!==e.name&&console.error(e)}else await t.invoke("scene.write",{type:e,filename:o,viewerExportSettings:h})}));const o=async(e,t,s)=>{const i=r(),n={maxSHBands:i[0].scene.events.invoke("view.bands")};switch(e){case"ply":await Oy(i,n,t);break;case"compressed-ply":n.minOpacity=1/255,n.removeInvalid=!0,await Vy(i,n,t);break;case"splat":await(async(e,t,s)=>{const i=new Py(t),n=Ey(e,i);if(0===n)return;const a=new Uint8Array(32*n),r=new DataView(a.buffer);let o=0;const l=new By(["x","y","z","opacity","rot_0","rot_1","rot_2","rot_3","f_dc_0","f_dc_1","f_dc_2","scale_0","scale_1","scale_2"],t),{data:h}=l,c=e=>Math.max(0,Math.min(255,e)),d=.28209479177387814;for(let t=0;t<e.length;++t){const s=e[t],{splatData:n}=s;i.set(s);for(let e=0;e<n.numSplats;++e){if(!i.test(e))continue;l.read(s,e);const t=32*o++;r.setFloat32(t+0,h.x,!0),r.setFloat32(t+4,h.y,!0),r.setFloat32(t+8,h.z,!0),r.setFloat32(t+12,Math.exp(h.scale_0),!0),r.setFloat32(t+16,Math.exp(h.scale_1),!0),r.setFloat32(t+20,Math.exp(h.scale_2),!0),r.setUint8(t+24,c(255*(.5+d*h.f_dc_0))),r.setUint8(t+25,c(255*(.5+d*h.f_dc_1))),r.setUint8(t+26,c(255*(.5+d*h.f_dc_2))),r.setUint8(t+27,c(1/(1+Math.exp(-h.opacity))*255)),r.setUint8(t+28,c(128*h.rot_0+128)),r.setUint8(t+29,c(128*h.rot_1+128)),r.setUint8(t+30,c(128*h.rot_2+128)),r.setUint8(t+31,c(128*h.rot_3+128))}}await s.write(a,!0)})(i,n,t);break;case"viewer":await(async(e,t,s)=>{if("both"===t.versionType){const i={...t,versionType:"dev",filename:t.filename?.replace(".html","-dev.html")},n=new O_,a={...t,versionType:"client",filename:t.filename?.replace(".html","-client.html")};if(await Ny(e,i,s),await Ny(e,a,n),"html"===t.type){const e=n.close();Uy(a.filename,e)}}else{const i=t.versionType||"dev";await Ny(e,{...t,versionType:i},s)}})(i,s,t)}};t.function("scene.write",(async e=>{t.fire("startSpinner");try{await new Promise((e=>{setTimeout(e)}));const{stream:t,filename:s,type:i,viewerExportSettings:n}=e,a=t?new B_(t):new z_(s);await o(i,a,n),await a.close()}catch(e){await t.invoke("showPopup",{type:"error",header:Yx("popup.error-loading"),message:`${e.message??e} while saving file`})}finally{t.fire("stopSpinner")}}))},Pw=e=>{let t=[],s=null,i=-1,n=!1,a=-1;const r=async o=>{if(o<0||o>=t.length)return;if(n)return void(a=o);if(o===i)return;if(e.invoke("scene.dirty")){if("yes"!==(await e.invoke("showPopup",{type:"yesno",header:"RESET SCENE",message:"You have unsaved changes. Are you sure you want to reset the scene?"})).action)return;e.fire("scene.clear"),s=null}n=!0;const l=t[o],h=URL.createObjectURL(l),c=await e.invoke("import",h,l.name,!s,!0);var d;if(URL.revokeObjectURL(h),await(d=c,new Promise((e=>{d.entity.gsplat.instance.sorter.on("updated",(t=>{e()}))}))),s&&s.destroy(),i=o,s=c,n=!1,-1!==a){const e=a;a=-1,r(e)}};e.on("plysequence.setFrames",(s=>{(s=>{const i=/(.*?)(\d+).ply$/;t=s.slice(),t.sort(((e,t)=>{const s=e.name?.match(i)?.[2],n=t.name?.match(i)?.[2];return s&&n?parseInt(s,10)-parseInt(n,10):0})),e.fire("timeline.frames",t.length)})(s)})),e.on("timeline.frame",(async e=>{await r(e)}))},Ew=location.origin,kw=async()=>{try{const e=await fetch(`${Ew}/api/id`);return e.ok&&await e.json()}catch(e){return null}},Mw=e=>{e.function("publish.enabled",(async()=>!!await kw())),e.function("scene.publish",(async t=>{const s=await kw();if(!s||!t)return!1;try{e.fire("startSpinner"),await new Promise((e=>{setTimeout(e,10)}));const i=e.invoke("scene.splats"),n=new O_,a=new V_(n);await Vy(i,t.serializeSettings,a),await a.close();const r=n.close(),o=await(async(e,t,s)=>{const i=await fetch(`${s.apiServer}/upload/signed-url`,{method:"POST",body:JSON.stringify({filename:"scene.ply"}),headers:{"Content-Type":"application/json",Authorization:`Bearer ${s.token}`}});if(!i.ok)throw new Error(`failed to get signed url (${i.statusText})`);const n=await i.json();if(!(await fetch(n.signedUrl,{method:"PUT",body:e,headers:{"Content-Type":"binary/octet-stream"}})).ok)throw new Error("failed to upload blob");const a=await fetch(`${s.apiServer}/splats/publish`,{method:"POST",body:JSON.stringify({s3Key:n.s3Key,title:t.title,description:t.description,listed:t.listed,settings:t.experienceSettings}),headers:{"Content-Type":"application/json",Authorization:`Bearer ${s.token}`}});if(!a.ok){let e;try{e=(await a.json()).error??e}catch(t){e="Failed to publish"}throw new Error(e)}return await a.json()})(r,t,s);o?await e.invoke("showPopup",{type:"info",header:Yx("publish.succeeded"),message:Yx("publish.message"),link:o.url}):await e.invoke("showPopup",{type:"error",header:Yx("publish.failed"),message:Yx("publish.please-try-again")})}catch(t){await e.invoke("showPopup",{type:"error",header:Yx("publish.failed"),message:`'${t.message??t}'`})}finally{e.fire("stopSpinner")}}))};var Iw,Dw,Rw,Lw,Fw,Bw,Ow,zw,Vw=(e,t,s)=>{if(!t.has(e))throw TypeError("Cannot "+s)},Nw=(e,t,s)=>(Vw(e,t,"read from private field"),t.get(e)),Uw=(e,t,s)=>{if(t.has(e))throw TypeError("Cannot add the same private member more than once");t instanceof WeakSet?t.add(e):t.set(e,s)},Hw=(e,t,s,i)=>(Vw(e,t,"write to private field"),t.set(e,s),s),Gw=(e,t,s)=>(Vw(e,t,"access private method"),s),Ww=new Uint8Array(8),jw=new DataView(Ww.buffer),qw=e=>[(e%256+256)%256],Xw=e=>(jw.setUint16(0,e,!1),[Ww[0],Ww[1]]),Yw=e=>(jw.setUint32(0,e,!1),[Ww[1],Ww[2],Ww[3]]),$w=e=>(jw.setUint32(0,e,!1),[Ww[0],Ww[1],Ww[2],Ww[3]]),Kw=e=>(jw.setUint32(0,Math.floor(e/2**32),!1),jw.setUint32(4,e,!1),[Ww[0],Ww[1],Ww[2],Ww[3],Ww[4],Ww[5],Ww[6],Ww[7]]),Zw=e=>(jw.setInt16(0,256*e,!1),[Ww[0],Ww[1]]),Jw=e=>(jw.setInt32(0,65536*e,!1),[Ww[0],Ww[1],Ww[2],Ww[3]]),Qw=e=>(jw.setInt32(0,2**30*e,!1),[Ww[0],Ww[1],Ww[2],Ww[3]]),eb=(e,t=!1)=>{let s=Array(e.length).fill(null).map(((t,s)=>e.charCodeAt(s)));return t&&s.push(0),s},tb=e=>e&&e[e.length-1],sb=e=>{let t;for(let s of e)(!t||s.presentationTimestamp>t.presentationTimestamp)&&(t=s);return t},ib=(e,t,s=!0)=>{let i=e*t;return s?Math.round(i):i},nb=e=>{let t=e*(Math.PI/180),s=Math.cos(t),i=Math.sin(t);return[s,i,0,-i,s,0,0,0,1]},ab=nb(0),rb=e=>[Jw(e[0]),Jw(e[1]),Qw(e[2]),Jw(e[3]),Jw(e[4]),Qw(e[5]),Jw(e[6]),Jw(e[7]),Qw(e[8])],ob=e=>e?"object"!=typeof e?e:Array.isArray(e)?e.map(ob):Object.fromEntries(Object.entries(e).map((([e,t])=>[e,ob(t)]))):e,lb=e=>e>=0&&e<2**32,hb=(e,t,s)=>({type:e,contents:t&&new Uint8Array(t.flat(10)),children:s}),cb=(e,t,s,i,n)=>hb(e,[qw(t),Yw(s),i??[]],n),db=e=>({type:"mdat",largeSize:e}),ub=(e,t,s=!1)=>hb("moov",null,[pb(t,e),...e.map((e=>mb(e,t))),s?Vb(e):null]),pb=(e,t)=>{let s=ib(Math.max(0,...t.filter((e=>e.samples.length>0)).map((e=>{const t=sb(e.samples);return t.presentationTimestamp+t.duration}))),nS),i=Math.max(...t.map((e=>e.id)))+1,n=!lb(e)||!lb(s),a=n?Kw:$w;return cb("mvhd",+n,0,[a(e),a(e),$w(nS),a(s),Jw(1),Zw(1),Array(10).fill(0),rb(ab),Array(24).fill(0),$w(i)])},mb=(e,t)=>hb("trak",null,[fb(e,t),gb(e,t)]),fb=(e,t)=>{let s,i=sb(e.samples),n=ib(i?i.presentationTimestamp+i.duration:0,nS),a=!lb(t)||!lb(n),r=a?Kw:$w;return s="video"===e.info.type?"number"==typeof e.info.rotation?nb(e.info.rotation):e.info.rotation:ab,cb("tkhd",+a,3,[r(t),r(t),$w(e.id),$w(0),r(n),Array(8).fill(0),Xw(0),Xw(0),Zw("audio"===e.info.type?1:0),Xw(0),rb(s),Jw("video"===e.info.type?e.info.width:0),Jw("video"===e.info.type?e.info.height:0)])},gb=(e,t)=>hb("mdia",null,[vb(e,t),_b("video"===e.info.type?"vide":"soun"),yb(e)]),vb=(e,t)=>{let s=sb(e.samples),i=ib(s?s.presentationTimestamp+s.duration:0,e.timescale),n=!lb(t)||!lb(i),a=n?Kw:$w;return cb("mdhd",+n,0,[a(t),a(t),$w(e.timescale),a(i),Xw(21956),Xw(0)])},_b=e=>cb("hdlr",0,0,[eb("mhlr"),eb(e),$w(0),$w(0),$w(0),eb("mp4-muxer-hdlr",!0)]),yb=e=>hb("minf",null,["video"===e.info.type?xb():wb(),bb(),Ab(e)]),xb=()=>cb("vmhd",0,1,[Xw(0),Xw(0),Xw(0),Xw(0)]),wb=()=>cb("smhd",0,0,[Xw(0),Xw(0)]),bb=()=>hb("dinf",null,[Cb()]),Cb=()=>cb("dref",0,0,[$w(1)],[Sb()]),Sb=()=>cb("url ",0,1),Ab=e=>{const t=e.compositionTimeOffsetTable.length>1||e.compositionTimeOffsetTable.some((e=>0!==e.sampleCompositionTimeOffset));return hb("stbl",null,[Tb(e),Rb(e),Lb(e),Fb(e),Bb(e),Ob(e),t?zb(e):null])},Tb=e=>cb("stsd",0,0,[$w(1)],["video"===e.info.type?Pb(Kb[e.info.codec],e):Db(Jb[e.info.codec],e)]),Pb=(e,t)=>{return hb(e,[Array(6).fill(0),Xw(1),Xw(0),Xw(0),Array(12).fill(0),Xw(t.info.width),Xw(t.info.height),$w(4718592),$w(4718592),$w(0),Xw(1),Array(32).fill(0),Xw(24),(s=65535,jw.setInt16(0,s,!1),[Ww[0],Ww[1]])],[Zb[t.info.codec](t),t.info.decoderConfig.colorSpace?Ib(t):null]);var s},Eb={bt709:1,bt470bg:5,smpte170m:6},kb={bt709:1,smpte170m:6,"iec61966-2-1":13},Mb={rgb:0,bt709:1,bt470bg:5,smpte170m:6},Ib=e=>hb("colr",[eb("nclx"),Xw(Eb[e.info.decoderConfig.colorSpace.primaries]),Xw(kb[e.info.decoderConfig.colorSpace.transfer]),Xw(Mb[e.info.decoderConfig.colorSpace.matrix]),qw((e.info.decoderConfig.colorSpace.fullRange?1:0)<<7)]),Db=(e,t)=>hb(e,[Array(6).fill(0),Xw(1),Xw(0),Xw(0),$w(0),Xw(t.info.numberOfChannels),Xw(16),Xw(0),Xw(0),Jw(t.info.sampleRate)],[Qb[t.info.codec](t)]),Rb=e=>cb("stts",0,0,[$w(e.timeToSampleTable.length),e.timeToSampleTable.map((e=>[$w(e.sampleCount),$w(e.sampleDelta)]))]),Lb=e=>{if(e.samples.every((e=>"key"===e.type)))return null;let t=[...e.samples.entries()].filter((([,e])=>"key"===e.type));return cb("stss",0,0,[$w(t.length),t.map((([e])=>$w(e+1)))])},Fb=e=>cb("stsc",0,0,[$w(e.compactlyCodedChunkTable.length),e.compactlyCodedChunkTable.map((e=>[$w(e.firstChunk),$w(e.samplesPerChunk),$w(1)]))]),Bb=e=>cb("stsz",0,0,[$w(0),$w(e.samples.length),e.samples.map((e=>$w(e.size)))]),Ob=e=>e.finalizedChunks.length>0&&tb(e.finalizedChunks).offset>=2**32?cb("co64",0,0,[$w(e.finalizedChunks.length),e.finalizedChunks.map((e=>Kw(e.offset)))]):cb("stco",0,0,[$w(e.finalizedChunks.length),e.finalizedChunks.map((e=>$w(e.offset)))]),zb=e=>cb("ctts",0,0,[$w(e.compositionTimeOffsetTable.length),e.compositionTimeOffsetTable.map((e=>[$w(e.sampleCount),$w(e.sampleCompositionTimeOffset)]))]),Vb=e=>hb("mvex",null,e.map(Nb)),Nb=e=>cb("trex",0,0,[$w(e.id),$w(1),$w(0),$w(0),$w(0)]),Ub=(e,t)=>hb("moof",null,[Hb(e),...t.map(Wb)]),Hb=e=>cb("mfhd",0,0,[$w(e)]),Gb=e=>{let t=0,s=0,i="delta"===e.type;return s|=+i,t|=i?1:2,t<<24|s<<16},Wb=e=>hb("traf",null,[jb(e),qb(e),Xb(e)]),jb=e=>{let t=0;t|=8,t|=16,t|=32,t|=131072;let s=e.currentChunk.samples[1]??e.currentChunk.samples[0],i={duration:s.timescaleUnitsToNextSample,size:s.size,flags:Gb(s)};return cb("tfhd",0,131128,[$w(e.id),$w(i.duration),$w(i.size),$w(i.flags)])},qb=e=>cb("tfdt",1,0,[Kw(ib(e.currentChunk.startTimestamp,e.timescale))]),Xb=e=>{let t=e.currentChunk.samples.map((e=>e.timescaleUnitsToNextSample)),s=e.currentChunk.samples.map((e=>e.size)),i=e.currentChunk.samples.map(Gb),n=e.currentChunk.samples.map((t=>ib(t.presentationTimestamp-t.decodeTimestamp,e.timescale))),a=new Set(t),r=new Set(s),o=new Set(i),l=new Set(n),h=2===o.size&&i[0]!==i[1],c=a.size>1,d=r.size>1,u=!h&&o.size>1,p=l.size>1||[...l].some((e=>0!==e)),m=0;return m|=1,m|=4*+h,m|=256*+c,m|=512*+d,m|=1024*+u,m|=2048*+p,cb("trun",1,m,[$w(e.currentChunk.samples.length),$w(e.currentChunk.offset-e.currentChunk.moofOffset||0),h?$w(i[0]):[],e.currentChunk.samples.map(((e,a)=>{return[c?$w(t[a]):[],d?$w(s[a]):[],u?$w(i[a]):[],p?(r=n[a],jw.setInt32(0,r,!1),[Ww[0],Ww[1],Ww[2],Ww[3]]):[]];var r}))])},Yb=(e,t)=>cb("tfra",1,0,[$w(e.id),$w(63),$w(e.finalizedChunks.length),e.finalizedChunks.map((s=>[Kw(ib(s.startTimestamp,e.timescale)),Kw(s.moofOffset),$w(t+1),$w(1),$w(1)]))]),$b=()=>cb("mfro",0,0,[$w(0)]),Kb={avc:"avc1",hevc:"hvc1",vp9:"vp09",av1:"av01"},Zb={avc:e=>e.info.decoderConfig&&hb("avcC",[...new Uint8Array(e.info.decoderConfig.description)]),hevc:e=>e.info.decoderConfig&&hb("hvcC",[...new Uint8Array(e.info.decoderConfig.description)]),vp9:e=>{if(!e.info.decoderConfig)return null;let t=e.info.decoderConfig;if(!t.colorSpace)throw new Error("'colorSpace' is required in the decoder config for VP9.");let s=t.codec.split("."),i=Number(s[1]),n=Number(s[2]),a=0+(Number(s[3])<<4)+Number(t.colorSpace.fullRange);return cb("vpcC",1,0,[qw(i),qw(n),qw(a),qw(2),qw(2),qw(2),Xw(0)])},av1:()=>hb("av1C",[129,0,0,0])},Jb={aac:"mp4a",opus:"Opus"},Qb={aac:e=>{let t=new Uint8Array(e.info.decoderConfig.description);return cb("esds",0,0,[$w(58753152),qw(32+t.byteLength),Xw(1),qw(0),$w(75530368),qw(18+t.byteLength),qw(64),qw(21),Yw(0),$w(130071),$w(130071),$w(92307584),qw(t.byteLength),...t,$w(109084800),qw(1),qw(2)])},opus:e=>{let t=3840,s=0;const i=e.info.decoderConfig?.description;if(i){if(i.byteLength<18)throw new TypeError("Invalid decoder description provided for Opus; must be at least 18 bytes long.");const e=ArrayBuffer.isView(i)?new DataView(i.buffer,i.byteOffset,i.byteLength):new DataView(i);t=e.getUint16(10,!0),s=e.getInt16(14,!0)}return hb("dOps",[qw(0),qw(e.info.numberOfChannels),Xw(t),$w(e.info.sampleRate),Zw(s),qw(0)])}},eC=class{},tC=class extends eC{constructor(){super(...arguments),this.buffer=null}},sC=class extends eC{constructor(e){if(super(),this.options=e,"object"!=typeof e)throw new TypeError("StreamTarget requires an options object to be passed to its constructor.");if(e.onData){if("function"!=typeof e.onData)throw new TypeError("options.onData, when provided, must be a function.");if(e.onData.length<2)throw new TypeError("options.onData, when provided, must be a function that takes in at least two arguments (data and position). Ignoring the position argument, which specifies the byte offset at which the data is to be written, can lead to broken outputs.")}if(void 0!==e.chunked&&"boolean"!=typeof e.chunked)throw new TypeError("options.chunked, when provided, must be a boolean.");if(void 0!==e.chunkSize&&(!Number.isInteger(e.chunkSize)||e.chunkSize<=0))throw new TypeError("options.chunkSize, when provided, must be a positive integer.")}},iC=class extends eC{constructor(e,t){if(super(),this.stream=e,this.options=t,!(e instanceof FileSystemWritableFileStream))throw new TypeError("FileSystemWritableFileStreamTarget requires a FileSystemWritableFileStream instance.");if(void 0!==t&&"object"!=typeof t)throw new TypeError("FileSystemWritableFileStreamTarget's options, when provided, must be an object.");if(t&&void 0!==t.chunkSize&&(!Number.isInteger(t.chunkSize)||t.chunkSize<=0))throw new TypeError("options.chunkSize, when provided, must be a positive integer")}},nC=class{constructor(){this.pos=0,Uw(this,Iw,new Uint8Array(8)),Uw(this,Dw,new DataView(Nw(this,Iw).buffer)),this.offsets=new WeakMap}seek(e){this.pos=e}writeU32(e){Nw(this,Dw).setUint32(0,e,!1),this.write(Nw(this,Iw).subarray(0,4))}writeU64(e){Nw(this,Dw).setUint32(0,Math.floor(e/2**32),!1),Nw(this,Dw).setUint32(4,e,!1),this.write(Nw(this,Iw).subarray(0,8))}writeAscii(e){for(let t=0;t<e.length;t++)Nw(this,Dw).setUint8(t%8,e.charCodeAt(t)),t%8==7&&this.write(Nw(this,Iw));e.length%8!=0&&this.write(Nw(this,Iw).subarray(0,e.length%8))}writeBox(e){if(this.offsets.set(e,this.pos),e.contents&&!e.children)this.writeBoxHeader(e,e.size??e.contents.byteLength+8),this.write(e.contents);else{let t=this.pos;if(this.writeBoxHeader(e,0),e.contents&&this.write(e.contents),e.children)for(let t of e.children)t&&this.writeBox(t);let s=this.pos,i=e.size??s-t;this.seek(t),this.writeBoxHeader(e,i),this.seek(s)}}writeBoxHeader(e,t){this.writeU32(e.largeSize?1:t),this.writeAscii(e.type),e.largeSize&&this.writeU64(t)}measureBoxHeader(e){return 8+(e.largeSize?8:0)}patchBox(e){let t=this.pos;this.seek(this.offsets.get(e)),this.writeBox(e),this.seek(t)}measureBox(e){if(e.contents&&!e.children){return this.measureBoxHeader(e)+e.contents.byteLength}{let t=this.measureBoxHeader(e);if(e.contents&&(t+=e.contents.byteLength),e.children)for(let s of e.children)s&&(t+=this.measureBox(s));return t}}};Iw=new WeakMap,Dw=new WeakMap;var aC,rC,oC=class extends nC{constructor(e){super(),Uw(this,Ow),Uw(this,Rw,void 0),Uw(this,Lw,new ArrayBuffer(65536)),Uw(this,Fw,new Uint8Array(Nw(this,Lw))),Uw(this,Bw,0),Hw(this,Rw,e)}write(e){Gw(this,Ow,zw).call(this,this.pos+e.byteLength),Nw(this,Fw).set(e,this.pos),this.pos+=e.byteLength,Hw(this,Bw,Math.max(Nw(this,Bw),this.pos))}finalize(){Gw(this,Ow,zw).call(this,this.pos),Nw(this,Rw).buffer=Nw(this,Lw).slice(0,Math.max(Nw(this,Bw),this.pos))}};Rw=new WeakMap,Lw=new WeakMap,Fw=new WeakMap,Bw=new WeakMap,Ow=new WeakSet,zw=function(e){let t=Nw(this,Lw).byteLength;for(;t<e;)t*=2;if(t===Nw(this,Lw).byteLength)return;let s=new ArrayBuffer(t),i=new Uint8Array(s);i.set(Nw(this,Fw),0),Hw(this,Lw,s),Hw(this,Fw,i)};var lC=class extends nC{constructor(e){super(),Uw(this,aC,void 0),Uw(this,rC,[]),Hw(this,aC,e)}write(e){Nw(this,rC).push({data:e.slice(),start:this.pos}),this.pos+=e.byteLength}flush(){if(0===Nw(this,rC).length)return;let e=[],t=[...Nw(this,rC)].sort(((e,t)=>e.start-t.start));e.push({start:t[0].start,size:t[0].data.byteLength});for(let s=1;s<t.length;s++){let i=e[e.length-1],n=t[s];n.start<=i.start+i.size?i.size=Math.max(i.size,n.start+n.data.byteLength-i.start):e.push({start:n.start,size:n.data.byteLength})}for(let t of e){t.data=new Uint8Array(t.size);for(let e of Nw(this,rC))t.start<=e.start&&e.start<t.start+t.size&&t.data.set(e.data,e.start-t.start);Nw(this,aC).options.onData?.(t.data,t.start)}Nw(this,rC).length=0}finalize(){}};aC=new WeakMap,rC=new WeakMap;var hC,cC,dC,uC,pC,mC,fC,gC,vC,_C,yC,xC=class extends nC{constructor(e){if(super(),Uw(this,uC),Uw(this,mC),Uw(this,gC),Uw(this,_C),Uw(this,hC,void 0),Uw(this,cC,void 0),Uw(this,dC,[]),Hw(this,hC,e),Hw(this,cC,e.options?.chunkSize??16777216),!Number.isInteger(Nw(this,cC))||Nw(this,cC)<1024)throw new Error("Invalid StreamTarget options: chunkSize must be an integer not smaller than 1024.")}write(e){Gw(this,uC,pC).call(this,e,this.pos),Gw(this,_C,yC).call(this),this.pos+=e.byteLength}finalize(){Gw(this,_C,yC).call(this,!0)}};hC=new WeakMap,cC=new WeakMap,dC=new WeakMap,uC=new WeakSet,pC=function(e,t){let s=Nw(this,dC).findIndex((e=>e.start<=t&&t<e.start+Nw(this,cC)));-1===s&&(s=Gw(this,gC,vC).call(this,t));let i=Nw(this,dC)[s],n=t-i.start,a=e.subarray(0,Math.min(Nw(this,cC)-n,e.byteLength));i.data.set(a,n);let r={start:n,end:n+a.byteLength};if(Gw(this,mC,fC).call(this,i,r),0===i.written[0].start&&i.written[0].end===Nw(this,cC)&&(i.shouldFlush=!0),Nw(this,dC).length>2){for(let e=0;e<Nw(this,dC).length-1;e++)Nw(this,dC)[e].shouldFlush=!0;Gw(this,_C,yC).call(this)}a.byteLength<e.byteLength&&Gw(this,uC,pC).call(this,e.subarray(a.byteLength),t+a.byteLength)},mC=new WeakSet,fC=function(e,t){let s=0,i=e.written.length-1,n=-1;for(;s<=i;){let a=Math.floor(s+(i-s+1)/2);e.written[a].start<=t.start?(s=a+1,n=a):i=a-1}for(e.written.splice(n+1,0,t),(-1===n||e.written[n].end<t.start)&&n++;n<e.written.length-1&&e.written[n].end>=e.written[n+1].start;)e.written[n].end=Math.max(e.written[n].end,e.written[n+1].end),e.written.splice(n+1,1)},gC=new WeakSet,vC=function(e){let t={start:Math.floor(e/Nw(this,cC))*Nw(this,cC),data:new Uint8Array(Nw(this,cC)),written:[],shouldFlush:!1};return Nw(this,dC).push(t),Nw(this,dC).sort(((e,t)=>e.start-t.start)),Nw(this,dC).indexOf(t)},_C=new WeakSet,yC=function(e=!1){for(let t=0;t<Nw(this,dC).length;t++){let s=Nw(this,dC)[t];if(s.shouldFlush||e){for(let e of s.written)Nw(this,hC).options.onData?.(s.data.subarray(e.start,e.end),s.start+e.start);Nw(this,dC).splice(t--,1)}}};var wC,bC,CC,SC,AC,TC,PC,EC,kC,MC,IC,DC,RC,LC,FC,BC,OC,zC,VC,NC,UC,HC,GC,WC,jC,qC,XC,YC,$C,KC,ZC,JC,QC,eS,tS,sS,iS=class extends xC{constructor(e){super(new sC({onData:(t,s)=>e.stream.write({type:"write",data:t,position:s}),chunkSize:e.options?.chunkSize}))}},nS=1e3,aS=["avc","hevc","vp9","av1"],rS=["aac","opus"],oS=["strict","offset","cross-track-offset"],lS=class{constructor(e){if(Uw(this,RC),Uw(this,FC),Uw(this,OC),Uw(this,VC),Uw(this,UC),Uw(this,GC),Uw(this,jC),Uw(this,XC),Uw(this,$C),Uw(this,ZC),Uw(this,QC),Uw(this,tS),Uw(this,wC,void 0),Uw(this,bC,void 0),Uw(this,CC,void 0),Uw(this,SC,void 0),Uw(this,AC,null),Uw(this,TC,null),Uw(this,PC,Math.floor(Date.now()/1e3)+2082844800),Uw(this,EC,[]),Uw(this,kC,1),Uw(this,MC,[]),Uw(this,IC,[]),Uw(this,DC,!1),Gw(this,RC,LC).call(this,e),e.video=ob(e.video),e.audio=ob(e.audio),e.fastStart=ob(e.fastStart),this.target=e.target,Hw(this,wC,{firstTimestampBehavior:"strict",...e}),e.target instanceof tC)Hw(this,bC,new oC(e.target));else if(e.target instanceof sC)Hw(this,bC,e.target.options?.chunked?new xC(e.target):new lC(e.target));else{if(!(e.target instanceof iC))throw new Error(`Invalid target: ${e.target}`);Hw(this,bC,new iS(e.target))}Gw(this,VC,NC).call(this),Gw(this,FC,BC).call(this)}addVideoChunk(e,t,s,i){if(!(e instanceof EncodedVideoChunk))throw new TypeError("addVideoChunk's first argument (sample) must be of type EncodedVideoChunk.");if(t&&"object"!=typeof t)throw new TypeError("addVideoChunk's second argument (meta), when provided, must be an object.");if(void 0!==s&&(!Number.isFinite(s)||s<0))throw new TypeError("addVideoChunk's third argument (timestamp), when provided, must be a non-negative real number.");if(void 0!==i&&!Number.isFinite(i))throw new TypeError("addVideoChunk's fourth argument (compositionTimeOffset), when provided, must be a real number.");let n=new Uint8Array(e.byteLength);e.copyTo(n),this.addVideoChunkRaw(n,e.type,s??e.timestamp,e.duration,t,i)}addVideoChunkRaw(e,t,s,i,n,a){if(!(e instanceof Uint8Array))throw new TypeError("addVideoChunkRaw's first argument (data) must be an instance of Uint8Array.");if("key"!==t&&"delta"!==t)throw new TypeError("addVideoChunkRaw's second argument (type) must be either 'key' or 'delta'.");if(!Number.isFinite(s)||s<0)throw new TypeError("addVideoChunkRaw's third argument (timestamp) must be a non-negative real number.");if(!Number.isFinite(i)||i<0)throw new TypeError("addVideoChunkRaw's fourth argument (duration) must be a non-negative real number.");if(n&&"object"!=typeof n)throw new TypeError("addVideoChunkRaw's fifth argument (meta), when provided, must be an object.");if(void 0!==a&&!Number.isFinite(a))throw new TypeError("addVideoChunkRaw's sixth argument (compositionTimeOffset), when provided, must be a real number.");if(Gw(this,tS,sS).call(this),!Nw(this,wC).video)throw new Error("No video track declared.");if("object"==typeof Nw(this,wC).fastStart&&Nw(this,AC).samples.length===Nw(this,wC).fastStart.expectedVideoChunks)throw new Error(`Cannot add more video chunks than specified in 'fastStart' (${Nw(this,wC).fastStart.expectedVideoChunks}).`);let r=Gw(this,GC,WC).call(this,Nw(this,AC),e,t,s,i,n,a);if("fragmented"===Nw(this,wC).fastStart&&Nw(this,TC)){for(;Nw(this,IC).length>0&&Nw(this,IC)[0].decodeTimestamp<=r.decodeTimestamp;){let e=Nw(this,IC).shift();Gw(this,jC,qC).call(this,Nw(this,TC),e)}r.decodeTimestamp<=Nw(this,TC).lastDecodeTimestamp?Gw(this,jC,qC).call(this,Nw(this,AC),r):Nw(this,MC).push(r)}else Gw(this,jC,qC).call(this,Nw(this,AC),r)}addAudioChunk(e,t,s){if(!(e instanceof EncodedAudioChunk))throw new TypeError("addAudioChunk's first argument (sample) must be of type EncodedAudioChunk.");if(t&&"object"!=typeof t)throw new TypeError("addAudioChunk's second argument (meta), when provided, must be an object.");if(void 0!==s&&(!Number.isFinite(s)||s<0))throw new TypeError("addAudioChunk's third argument (timestamp), when provided, must be a non-negative real number.");let i=new Uint8Array(e.byteLength);e.copyTo(i),this.addAudioChunkRaw(i,e.type,s??e.timestamp,e.duration,t)}addAudioChunkRaw(e,t,s,i,n){if(!(e instanceof Uint8Array))throw new TypeError("addAudioChunkRaw's first argument (data) must be an instance of Uint8Array.");if("key"!==t&&"delta"!==t)throw new TypeError("addAudioChunkRaw's second argument (type) must be either 'key' or 'delta'.");if(!Number.isFinite(s)||s<0)throw new TypeError("addAudioChunkRaw's third argument (timestamp) must be a non-negative real number.");if(!Number.isFinite(i)||i<0)throw new TypeError("addAudioChunkRaw's fourth argument (duration) must be a non-negative real number.");if(n&&"object"!=typeof n)throw new TypeError("addAudioChunkRaw's fifth argument (meta), when provided, must be an object.");if(Gw(this,tS,sS).call(this),!Nw(this,wC).audio)throw new Error("No audio track declared.");if("object"==typeof Nw(this,wC).fastStart&&Nw(this,TC).samples.length===Nw(this,wC).fastStart.expectedAudioChunks)throw new Error(`Cannot add more audio chunks than specified in 'fastStart' (${Nw(this,wC).fastStart.expectedAudioChunks}).`);let a=Gw(this,GC,WC).call(this,Nw(this,TC),e,t,s,i,n);if("fragmented"===Nw(this,wC).fastStart&&Nw(this,AC)){for(;Nw(this,MC).length>0&&Nw(this,MC)[0].decodeTimestamp<=a.decodeTimestamp;){let e=Nw(this,MC).shift();Gw(this,jC,qC).call(this,Nw(this,AC),e)}a.decodeTimestamp<=Nw(this,AC).lastDecodeTimestamp?Gw(this,jC,qC).call(this,Nw(this,TC),a):Nw(this,IC).push(a)}else Gw(this,jC,qC).call(this,Nw(this,TC),a)}finalize(){if(Nw(this,DC))throw new Error("Cannot finalize a muxer more than once.");if("fragmented"===Nw(this,wC).fastStart){for(let e of Nw(this,MC))Gw(this,jC,qC).call(this,Nw(this,AC),e);for(let e of Nw(this,IC))Gw(this,jC,qC).call(this,Nw(this,TC),e);Gw(this,ZC,JC).call(this,!1)}else Nw(this,AC)&&Gw(this,$C,KC).call(this,Nw(this,AC)),Nw(this,TC)&&Gw(this,$C,KC).call(this,Nw(this,TC));let e=[Nw(this,AC),Nw(this,TC)].filter(Boolean);if("in-memory"===Nw(this,wC).fastStart){let t;for(let s=0;s<2;s++){let s=ub(e,Nw(this,PC)),i=Nw(this,bC).measureBox(s);t=Nw(this,bC).measureBox(Nw(this,SC));let n=Nw(this,bC).pos+i+t;for(let e of Nw(this,EC)){e.offset=n;for(let{data:s}of e.samples)n+=s.byteLength,t+=s.byteLength}if(n<2**32)break;t>=2**32&&(Nw(this,SC).largeSize=!0)}let s=ub(e,Nw(this,PC));Nw(this,bC).writeBox(s),Nw(this,SC).size=t,Nw(this,bC).writeBox(Nw(this,SC));for(let e of Nw(this,EC))for(let t of e.samples)Nw(this,bC).write(t.data),t.data=null}else if("fragmented"===Nw(this,wC).fastStart){let t=Nw(this,bC).pos,s=(e=>hb("mfra",null,[...e.map(Yb),$b()]))(e);Nw(this,bC).writeBox(s);let i=Nw(this,bC).pos-t;Nw(this,bC).seek(Nw(this,bC).pos-4),Nw(this,bC).writeU32(i)}else{let t=Nw(this,bC).offsets.get(Nw(this,SC)),s=Nw(this,bC).pos-t;Nw(this,SC).size=s,Nw(this,SC).largeSize=s>=2**32,Nw(this,bC).patchBox(Nw(this,SC));let i=ub(e,Nw(this,PC));if("object"==typeof Nw(this,wC).fastStart){Nw(this,bC).seek(Nw(this,CC)),Nw(this,bC).writeBox(i);let e=t-Nw(this,bC).pos;Nw(this,bC).writeBox({type:"free",size:e})}else Nw(this,bC).writeBox(i)}Gw(this,QC,eS).call(this),Nw(this,bC).finalize(),Hw(this,DC,!0)}};wC=new WeakMap,bC=new WeakMap,CC=new WeakMap,SC=new WeakMap,AC=new WeakMap,TC=new WeakMap,PC=new WeakMap,EC=new WeakMap,kC=new WeakMap,MC=new WeakMap,IC=new WeakMap,DC=new WeakMap,RC=new WeakSet,LC=function(e){if("object"!=typeof e)throw new TypeError("The muxer requires an options object to be passed to its constructor.");if(!(e.target instanceof eC))throw new TypeError("The target must be provided and an instance of Target.");if(e.video){if(!aS.includes(e.video.codec))throw new TypeError(`Unsupported video codec: ${e.video.codec}`);if(!Number.isInteger(e.video.width)||e.video.width<=0)throw new TypeError(`Invalid video width: ${e.video.width}. Must be a positive integer.`);if(!Number.isInteger(e.video.height)||e.video.height<=0)throw new TypeError(`Invalid video height: ${e.video.height}. Must be a positive integer.`);const t=e.video.rotation;if("number"==typeof t&&![0,90,180,270].includes(t))throw new TypeError(`Invalid video rotation: ${t}. Has to be 0, 90, 180 or 270.`);if(Array.isArray(t)&&(9!==t.length||t.some((e=>"number"!=typeof e))))throw new TypeError(`Invalid video transformation matrix: ${t.join()}`);if(void 0!==e.video.frameRate&&(!Number.isInteger(e.video.frameRate)||e.video.frameRate<=0))throw new TypeError(`Invalid video frame rate: ${e.video.frameRate}. Must be a positive integer.`)}if(e.audio){if(!rS.includes(e.audio.codec))throw new TypeError(`Unsupported audio codec: ${e.audio.codec}`);if(!Number.isInteger(e.audio.numberOfChannels)||e.audio.numberOfChannels<=0)throw new TypeError(`Invalid number of audio channels: ${e.audio.numberOfChannels}. Must be a positive integer.`);if(!Number.isInteger(e.audio.sampleRate)||e.audio.sampleRate<=0)throw new TypeError(`Invalid audio sample rate: ${e.audio.sampleRate}. Must be a positive integer.`)}if(e.firstTimestampBehavior&&!oS.includes(e.firstTimestampBehavior))throw new TypeError(`Invalid first timestamp behavior: ${e.firstTimestampBehavior}`);if("object"==typeof e.fastStart){if(e.video){if(void 0===e.fastStart.expectedVideoChunks)throw new TypeError("'fastStart' is an object but is missing property 'expectedVideoChunks'.");if(!Number.isInteger(e.fastStart.expectedVideoChunks)||e.fastStart.expectedVideoChunks<0)throw new TypeError("'expectedVideoChunks' must be a non-negative integer.")}if(e.audio){if(void 0===e.fastStart.expectedAudioChunks)throw new TypeError("'fastStart' is an object but is missing property 'expectedAudioChunks'.");if(!Number.isInteger(e.fastStart.expectedAudioChunks)||e.fastStart.expectedAudioChunks<0)throw new TypeError("'expectedAudioChunks' must be a non-negative integer.")}}else if(![!1,"in-memory","fragmented"].includes(e.fastStart))throw new TypeError("'fastStart' option must be false, 'in-memory', 'fragmented' or an object.");if(void 0!==e.minFragmentDuration&&(!Number.isFinite(e.minFragmentDuration)||e.minFragmentDuration<0))throw new TypeError("'minFragmentDuration' must be a non-negative number.")},FC=new WeakSet,BC=function(){var e;if(Nw(this,bC).writeBox((e={holdsAvc:"avc"===Nw(this,wC).video?.codec,fragmented:"fragmented"===Nw(this,wC).fastStart}).fragmented?hb("ftyp",[eb("iso5"),$w(512),eb("iso5"),eb("iso6"),eb("mp41")]):hb("ftyp",[eb("isom"),$w(512),eb("isom"),e.holdsAvc?eb("avc1"):[],eb("mp41")])),Hw(this,CC,Nw(this,bC).pos),"in-memory"===Nw(this,wC).fastStart)Hw(this,SC,db(!1));else if("fragmented"===Nw(this,wC).fastStart);else{if("object"==typeof Nw(this,wC).fastStart){let e=Gw(this,OC,zC).call(this);Nw(this,bC).seek(Nw(this,bC).pos+e)}Hw(this,SC,db(!0)),Nw(this,bC).writeBox(Nw(this,SC))}Gw(this,QC,eS).call(this)},OC=new WeakSet,zC=function(){if("object"!=typeof Nw(this,wC).fastStart)return;let e=0,t=[Nw(this,wC).fastStart.expectedVideoChunks,Nw(this,wC).fastStart.expectedAudioChunks];for(let s of t)s&&(e+=8*Math.ceil(2/3*s),e+=4*s,e+=12*Math.ceil(2/3*s),e+=4*s,e+=8*s);return e+=4096,e},VC=new WeakSet,NC=function(){if(Nw(this,wC).video&&Hw(this,AC,{id:1,info:{type:"video",codec:Nw(this,wC).video.codec,width:Nw(this,wC).video.width,height:Nw(this,wC).video.height,rotation:Nw(this,wC).video.rotation??0,decoderConfig:null},timescale:Nw(this,wC).video.frameRate??57600,samples:[],finalizedChunks:[],currentChunk:null,firstDecodeTimestamp:void 0,lastDecodeTimestamp:-1,timeToSampleTable:[],compositionTimeOffsetTable:[],lastTimescaleUnits:null,lastSample:null,compactlyCodedChunkTable:[]}),Nw(this,wC).audio&&(Hw(this,TC,{id:Nw(this,wC).video?2:1,info:{type:"audio",codec:Nw(this,wC).audio.codec,numberOfChannels:Nw(this,wC).audio.numberOfChannels,sampleRate:Nw(this,wC).audio.sampleRate,decoderConfig:null},timescale:Nw(this,wC).audio.sampleRate,samples:[],finalizedChunks:[],currentChunk:null,firstDecodeTimestamp:void 0,lastDecodeTimestamp:-1,timeToSampleTable:[],compositionTimeOffsetTable:[],lastTimescaleUnits:null,lastSample:null,compactlyCodedChunkTable:[]}),"aac"===Nw(this,wC).audio.codec)){let e=Gw(this,UC,HC).call(this,2,Nw(this,wC).audio.sampleRate,Nw(this,wC).audio.numberOfChannels);Nw(this,TC).info.decoderConfig={codec:Nw(this,wC).audio.codec,description:e,numberOfChannels:Nw(this,wC).audio.numberOfChannels,sampleRate:Nw(this,wC).audio.sampleRate}}},UC=new WeakSet,HC=function(e,t,s){let i=[96e3,88200,64e3,48e3,44100,32e3,24e3,22050,16e3,12e3,11025,8e3,7350].indexOf(t),n=s,a="";a+=e.toString(2).padStart(5,"0"),a+=i.toString(2).padStart(4,"0"),15===i&&(a+=t.toString(2).padStart(24,"0")),a+=n.toString(2).padStart(4,"0");let r=8*Math.ceil(a.length/8);a=a.padEnd(r,"0");let o=new Uint8Array(a.length/8);for(let e=0;e<a.length;e+=8)o[e/8]=parseInt(a.slice(e,e+8),2);return o},GC=new WeakSet,WC=function(e,t,s,i,n,a,r){let o=i/1e6,l=(i-(r??0))/1e6,h=n/1e6,c=Gw(this,XC,YC).call(this,o,l,e);return o=c.presentationTimestamp,l=c.decodeTimestamp,a?.decoderConfig&&(null===e.info.decoderConfig?e.info.decoderConfig=a.decoderConfig:Object.assign(e.info.decoderConfig,a.decoderConfig)),{presentationTimestamp:o,decodeTimestamp:l,duration:h,data:t,size:t.byteLength,type:s,timescaleUnitsToNextSample:ib(h,e.timescale)}},jC=new WeakSet,qC=function(e,t){"fragmented"!==Nw(this,wC).fastStart&&e.samples.push(t);const s=ib(t.presentationTimestamp-t.decodeTimestamp,e.timescale);if(null!==e.lastTimescaleUnits){let i=ib(t.decodeTimestamp,e.timescale,!1),n=Math.round(i-e.lastTimescaleUnits);if(e.lastTimescaleUnits+=n,e.lastSample.timescaleUnitsToNextSample=n,"fragmented"!==Nw(this,wC).fastStart){let t=tb(e.timeToSampleTable);1===t.sampleCount?(t.sampleDelta=n,t.sampleCount++):t.sampleDelta===n?t.sampleCount++:(t.sampleCount--,e.timeToSampleTable.push({sampleCount:2,sampleDelta:n}));const i=tb(e.compositionTimeOffsetTable);i.sampleCompositionTimeOffset===s?i.sampleCount++:e.compositionTimeOffsetTable.push({sampleCount:1,sampleCompositionTimeOffset:s})}}else e.lastTimescaleUnits=0,"fragmented"!==Nw(this,wC).fastStart&&(e.timeToSampleTable.push({sampleCount:1,sampleDelta:ib(t.duration,e.timescale)}),e.compositionTimeOffsetTable.push({sampleCount:1,sampleCompositionTimeOffset:s}));e.lastSample=t;let i=!1;if(e.currentChunk){let s=t.presentationTimestamp-e.currentChunk.startTimestamp;if("fragmented"===Nw(this,wC).fastStart){let n=Nw(this,AC)??Nw(this,TC);const a=Nw(this,wC).minFragmentDuration??1;e===n&&"key"===t.type&&s>=a&&(i=!0,Gw(this,ZC,JC).call(this))}else i=s>=.5}else i=!0;i&&(e.currentChunk&&Gw(this,$C,KC).call(this,e),e.currentChunk={startTimestamp:t.presentationTimestamp,samples:[]}),e.currentChunk.samples.push(t)},XC=new WeakSet,YC=function(e,t,s){const i="strict"===Nw(this,wC).firstTimestampBehavior,n=-1===s.lastDecodeTimestamp;if(i&&n&&0!==t)throw new Error(`The first chunk for your media track must have a timestamp of 0 (received DTS=${t}).Non-zero first timestamps are often caused by directly piping frames or audio data from a MediaStreamTrack into the encoder. Their timestamps are typically relative to the age of thedocument, which is probably what you want.\n\nIf you want to offset all timestamps of a track such that the first one is zero, set firstTimestampBehavior: 'offset' in the options.\n`);if("offset"===Nw(this,wC).firstTimestampBehavior||"cross-track-offset"===Nw(this,wC).firstTimestampBehavior){let i;void 0===s.firstDecodeTimestamp&&(s.firstDecodeTimestamp=t),i="offset"===Nw(this,wC).firstTimestampBehavior?s.firstDecodeTimestamp:Math.min(Nw(this,AC)?.firstDecodeTimestamp??1/0,Nw(this,TC)?.firstDecodeTimestamp??1/0),t-=i,e-=i}if(t<s.lastDecodeTimestamp)throw new Error(`Timestamps must be monotonically increasing (DTS went from ${1e6*s.lastDecodeTimestamp} to ${1e6*t}).`);return s.lastDecodeTimestamp=t,{presentationTimestamp:e,decodeTimestamp:t}},$C=new WeakSet,KC=function(e){if("fragmented"===Nw(this,wC).fastStart)throw new Error("Can't finalize individual chunks if 'fastStart' is set to 'fragmented'.");if(e.currentChunk)if(e.finalizedChunks.push(e.currentChunk),Nw(this,EC).push(e.currentChunk),0!==e.compactlyCodedChunkTable.length&&tb(e.compactlyCodedChunkTable).samplesPerChunk===e.currentChunk.samples.length||e.compactlyCodedChunkTable.push({firstChunk:e.finalizedChunks.length,samplesPerChunk:e.currentChunk.samples.length}),"in-memory"!==Nw(this,wC).fastStart){e.currentChunk.offset=Nw(this,bC).pos;for(let t of e.currentChunk.samples)Nw(this,bC).write(t.data),t.data=null;Gw(this,QC,eS).call(this)}else e.currentChunk.offset=0},ZC=new WeakSet,JC=function(e=!0){if("fragmented"!==Nw(this,wC).fastStart)throw new Error("Can't finalize a fragment unless 'fastStart' is set to 'fragmented'.");let t=[Nw(this,AC),Nw(this,TC)].filter((e=>e&&e.currentChunk));if(0===t.length)return;let s=(i=this,n=kC,{set _(e){Hw(i,n,e)},get _(){return Nw(i,n)}})._++;var i,n;if(1===s){let e=ub(t,Nw(this,PC),!0);Nw(this,bC).writeBox(e)}let a=Nw(this,bC).pos,r=Ub(s,t);Nw(this,bC).writeBox(r);{let e=db(!1),s=0;for(let e of t)for(let t of e.currentChunk.samples)s+=t.size;let i=Nw(this,bC).measureBox(e)+s;i>=2**32&&(e.largeSize=!0,i=Nw(this,bC).measureBox(e)+s),e.size=i,Nw(this,bC).writeBox(e)}for(let e of t){e.currentChunk.offset=Nw(this,bC).pos,e.currentChunk.moofOffset=a;for(let t of e.currentChunk.samples)Nw(this,bC).write(t.data),t.data=null}let o=Nw(this,bC).pos;Nw(this,bC).seek(Nw(this,bC).offsets.get(r));let l=Ub(s,t);Nw(this,bC).writeBox(l),Nw(this,bC).seek(o);for(let e of t)e.finalizedChunks.push(e.currentChunk),Nw(this,EC).push(e.currentChunk),e.currentChunk=null;e&&Gw(this,QC,eS).call(this)},QC=new WeakSet,eS=function(){Nw(this,bC)instanceof lC&&Nw(this,bC).flush()},tS=new WeakSet,sS=function(){if(Nw(this,DC))throw new Error("Cannot add new video or audio chunks after the file has been finalized.")};const hS=function(e){new Promise((t=>{self.importScripts(`${e}/lodepng.js`),t(self.lodepng({locateFile:()=>`${e}/lodepng.wasm`}))})).then((e=>{self.onmessage=t=>{const{data:s}=t,{token:i,pixels:n,width:a,height:r}=s,o=((e,t,s,i)=>{const n=e._malloc(4),a=e._malloc(4),r=e._malloc(s*i*4);for(let n=0;n<i;++n){let a=n*s,o=r/4+(i-1-n)*s;for(let i=0;i<s;++i)e.HEAPU32[o++]=t[a++]}e._lodepng_encode32(n,a,r,s,i);const o=e.HEAPU8.slice(e.HEAPU32[n/4],e.HEAPU32[n/4]+e.HEAPU32[a/4]);return e._free(n),e._free(a),e._free(r),o})(e,n,a,r);self.postMessage({token:i,result:o},void 0,[o.buffer])},self.postMessage("ready")}))}.toString();class cS{resolver;promise;constructor(){this.promise=new Promise((e=>{this.resolver=e}))}}class dS{compress;constructor(){const e=new URL("static/lib/lodepng",document.baseURI),t=new Blob([`(${hS})('${e}')\n\n`],{type:"application/javascript"}),s=new Worker(URL.createObjectURL(t)),i=new cS,n=new Map;let a=1;s.addEventListener("message",(e=>{if("ready"===e.data)i.resolver();else{const{token:t,result:s}=e.data;n.get(t)(s),n.delete(t)}})),this.compress=async(e,t,r)=>{await i.promise;const o=new cS;return n.set(a,o.resolver),s.postMessage({token:a,pixels:e,width:t,height:r},[e.buffer]),a++,await o.promise}}}const uS=e=>e.substring(0,e.length-Ye.getExtension(e).length),pS=(e,t)=>{const s=new Blob([e],{type:"octet/stream"}),i=window.URL.createObjectURL(s),n=document.createElement("a");n.download=t,n.href=i,n.click(),window.URL.revokeObjectURL(i)},mS=[0,4,8,12,1,5,9,13,2,6,10,14],fS=1536;class gS{getTransform;setTransform;alloc;free;texture;constructor(e,t=4096){let s,i;const n=(t,n)=>{const a=new ki(e,{name:"transformPalette",width:t,height:n,format:Zt,mipmaps:!1,addressU:1,addressV:1}),r=a.lock();a.unlock(),s&&(r.set(i),s.destroy()),s=a,i=r};this.getTransform=(e,t)=>{const s=t.data;for(let t=0;t<12;++t)s[mS[t]]=i[12*e+t]},this.setTransform=(e,t)=>{const n=t.data;for(let t=0;t<12;++t)i[12*e+t]=n[mS[t]];s.upload()};let a=1;this.alloc=(e=1)=>{const t=a;for(;a+e>i.length/12;)n(fS,2*s.height);return a+=e,t},this.free=(e=1)=>{a-=e},Object.defineProperty(this,"texture",{get:()=>s}),n(fS,Math.ceil(t/512)),this.setTransform(0,Et.IDENTITY)}}const vS=new yt,_S=new yt,yS=new yt,xS=[-1,1].map((e=>[-1,1].map((t=>[-1,1].map((s=>[new yt(e,t,s),new yt(.75*e,t,s),new yt(e,t,s),new yt(e,.75*t,s),new yt(e,t,s),new yt(e,t,.75*s)])))))).flat(3);class wS extends Cw{asset;splatData;numSplats=0;numDeleted=0;numHidden=0;numSelected=0;entity;changedCounter=0;stateTexture;transformTexture;selectionBoundStorage;localBoundStorage;worldBoundStorage;selectionBoundDirty=!0;localBoundDirty=!0;worldBoundDirty=!0;_visible=!0;transformPalette;selectionAlpha=1;_name="";_tintClr=new mt(1,1,1);_brightness=0;_blackPoint=0;_whitePoint=1;_transparency=1;rebuildMaterial;constructor(e){super(xw.splat);const t=e.resource,s=t.splatData,i={vertex:'\n#include "gsplatCommonVS"\n\nuniform sampler2D splatState;\n\nuniform vec4 selectedClr;\nuniform vec4 lockedClr;\n\nuniform vec3 clrOffset;\nuniform vec4 clrScale;\n\nvarying mediump vec3 texCoordIsLocked;          // store locked flat in z\nvarying mediump vec4 color;\n\n#if PICK_PASS\n    uniform uint pickMode;                      // 0: add, 1: remove, 2: set\n#endif\n\nmediump vec4 discardVec = vec4(0.0, 0.0, 2.0, 1.0);\n\nvoid main(void) {\n    // read gaussian details\n    SplatSource source;\n    if (!initSource(source)) {\n        gl_Position = discardVec;\n        return;\n    }\n\n    // get per-gaussian edit state, discard if deleted\n    uint vertexState = uint(texelFetch(splatState, source.uv, 0).r * 255.0 + 0.5) & 7u;\n\n    #if OUTLINE_PASS\n        if (vertexState != 1u) {\n            gl_Position = discardVec;\n            return;\n        }\n    #elif UNDERLAY_PASS\n        if (vertexState != 1u) {\n            gl_Position = discardVec;\n            return;\n        }\n    #elif PICK_PASS\n        if (pickMode == 0u) {\n            // add: skip deleted, hidden and selected splats\n            if (vertexState != 0u) {\n                gl_Position = discardVec;\n                return;\n            }\n        } else if (pickMode == 1u) {\n            // remove: skip deleted, hidden and unselected splats\n            if (vertexState != 1u) {\n                gl_Position = discardVec;\n                return;\n            }\n        } else {\n            // set: skip deleted and hidden splats\n            if ((vertexState & 6u) != 0u) {\n                gl_Position = discardVec;\n                return;\n            }\n        }\n    #else\n        if ((vertexState & 4u) != 0u) {\n            gl_Position = discardVec;\n            return;\n        }\n    #endif\n\n    // get center\n    vec3 modelCenter = readCenter(source);\n\n    SplatCenter center;\n    if (!initCenter(source, modelCenter, center)) {\n        gl_Position = discardVec;\n        return;\n    }\n\n    SplatCorner corner;\n    if (!initCorner(source, center, corner)) {\n        gl_Position = discardVec;\n        return;\n    }\n\n    gl_Position = center.proj + vec4(corner.offset, 0.0, 0.0);\n\n    // store texture coord and locked state\n    texCoordIsLocked = vec3(corner.uv, (vertexState & 2u) != 0u ? 1.0 : 0.0);\n\n    #if UNDERLAY_PASS\n        color = readColor(source);\n        color.xyz = mix(color.xyz, selectedClr.xyz * 0.2, selectedClr.a) * selectedClr.a;\n    #elif PICK_PASS\n        uvec3 bits = (uvec3(source.id) >> uvec3(0u, 8u, 16u)) & uvec3(255u);\n        color = vec4(vec3(bits) / 255.0, readColor(source).a);\n    // handle splat color\n    #elif FORWARD_PASS\n        // read color\n        color = readColor(source);\n\n        // evaluate spherical harmonics\n        #if SH_BANDS > 0\n            vec3 dir = normalize(center.view * mat3(center.modelView));\n            color.xyz += evalSH(source, dir);\n        #endif\n\n        // apply tint/brightness\n        color = color * clrScale + vec4(clrOffset, 0.0);\n\n        // don\'t allow out-of-range alpha\n        color.a = clamp(color.a, 0.0, 1.0);\n\n        // apply tonemapping\n        color = vec4(prepareOutputFromGamma(max(color.xyz, 0.0)), color.w);\n\n        // apply locked/selected colors\n        if ((vertexState & 2u) != 0u) {\n            // locked\n            color *= lockedClr;\n        } else if ((vertexState & 1u) != 0u) {\n            // selected\n            color.xyz = mix(color.xyz, selectedClr.xyz * 0.8, selectedClr.a);\n        }\n    \n    #endif\n}\n',fragment:"\nvarying mediump vec3 texCoordIsLocked;\nvarying mediump vec4 color;\n\nuniform int mode;               // 0: centers, 1: rings\nuniform float pickerAlpha;\nuniform float ringSize;\n\nvoid main(void) {\n    mediump float A = dot(texCoordIsLocked.xy, texCoordIsLocked.xy);\n\n    if (A > 1.0) {\n        discard;\n    }\n\n    #if OUTLINE_PASS\n        gl_FragColor = vec4(1.0, 1.0, 1.0, mode == 0 ? exp(-A * 4.0) * color.a : 1.0);\n    #else\n        mediump float alpha = exp(-A * 4.0) * color.a;\n\n        #ifdef PICK_PASS\n            if (alpha < pickerAlpha) {\n                discard;\n            }\n            gl_FragColor = vec4(color.xyz, 0.0);\n        #else\n            if (texCoordIsLocked.z == 0.0 && ringSize > 0.0) {\n                // rings mode\n                if (A < 1.0 - ringSize) {\n                    alpha = max(0.05, alpha);\n                } else {\n                    alpha = 0.6;\n                }\n            }\n\n            gl_FragColor = vec4(color.xyz * alpha, alpha);\n        #endif\n    #endif\n}\n"};this._name=e.file.filename,this.asset=e,this.splatData=s,this.numSplats=s.numSplats,this.entity=t.instantiate(i);const n=this.entity.gsplat.instance;n.meshInstance.calculateSortDistance=(e,t,s)=>{const i=this.localBound,n=this.entity.getWorldTransform();let a;for(let e=0;e<8;++e){vS.x=i.center.x+i.halfExtents.x*(1&e?1:-1),vS.y=i.center.y+i.halfExtents.y*(2&e?1:-1),vS.z=i.center.z+i.halfExtents.z*(4&e?1:-1),n.transformPoint(vS,vS);const r=vS.sub(t).dot(s);(0===e||r>a)&&(a=r)}return a},this.splatData.getProp("state")||this.splatData.getElement("vertex").properties.push({type:"uchar",name:"state",storage:new Uint8Array(this.splatData.numSplats),byteSize:1}),this.splatData.getElement("vertex").properties.push({type:"ushort",name:"transform",storage:new Uint16Array(this.splatData.numSplats),byteSize:2});const{width:a,height:r}=n.splat.colorTexture,o=(e,s)=>new ki(t.device,{name:e,width:a,height:r,format:s,mipmaps:!1,minFilter:0,magFilter:0,addressU:1,addressV:1});this.stateTexture=o("splatState",52),this.transformTexture=o("splatTransform",35),this.transformPalette=new gS(t.device);const l=new Vi(!0,0,1,8);this.rebuildMaterial=e=>{n.createMaterial(i);const{material:t}=n;t.chunks={gsplatCenterVS:"\nuniform mat4 matrix_model;\nuniform mat4 matrix_view;\nuniform mat4 matrix_projection;\n\nuniform highp usampler2D splatTransform;        // per-splat index into transform palette\nuniform sampler2D transformPalette;             // palette of transform matrices\n\nmat4 applyPaletteTransform(SplatSource source, mat4 model) {\n    uint transformIndex = texelFetch(splatTransform, source.uv, 0).r;\n    if (transformIndex == 0u) {\n        return model;\n    }\n\n    // read transform matrix\n    int u = int(transformIndex % 512u) * 3;\n    int v = int(transformIndex / 512u);\n\n    mat4 t;\n    t[0] = texelFetch(transformPalette, ivec2(u, v), 0);\n    t[1] = texelFetch(transformPalette, ivec2(u + 1, v), 0);\n    t[2] = texelFetch(transformPalette, ivec2(u + 2, v), 0);\n    t[3] = vec4(0.0, 0.0, 0.0, 1.0);\n\n    return model * transpose(t);\n}\n\n// project the model space gaussian center to view and clip space\nbool initCenter(SplatSource source, vec3 modelCenter, out SplatCenter center) {\n    mat4 modelView = matrix_view * applyPaletteTransform(source, matrix_model);\n    vec4 centerView = modelView * vec4(modelCenter, 1.0);\n\n    // early out if splat is behind the camera\n    if (centerView.z > 0.0) {\n        return false;\n    }\n\n    vec4 centerProj = matrix_projection * centerView;\n\n    // ensure gaussians are not clipped by camera near and far\n    centerProj.z = clamp(centerProj.z, -abs(centerProj.w), abs(centerProj.w));\n\n    center.view = centerView.xyz / centerView.w;\n    center.proj = centerProj;\n    center.projMat00 = matrix_projection[0][0];\n    center.modelView = modelView;\n    return true;\n}\n"},t.blendState=l,t.setDefine("SH_BANDS",`${Math.min(e,n.splat.shBands)}`),t.setParameter("splatState",this.stateTexture),t.setParameter("splatTransform",this.transformTexture),t.setParameter("transformPalette",this.transformPalette.texture),t.update()},this.selectionBoundStorage=new Ft,this.localBoundStorage=n.splat.aabb,this.worldBoundStorage=n.meshInstance._aabb,n.meshInstance._updateAabb=!1,n.sorter.on("updated",(()=>{this.changedCounter++}))}destroy(){super.destroy(),this.entity.destroy(),this.asset.registry.remove(this.asset),this.asset.unload()}updateState(e=_y.selected){const t=this.splatData.getProp("state");this.stateTexture.lock().set(t),this.stateTexture.unlock();let s=0,i=0,n=0;for(let e=0;e<t.length;++e){const a=t[e];a&_y.deleted?n++:a&_y.hidden?i++:a&_y.selected&&s++}this.numSplats=t.length-n,this.numHidden=i,this.numSelected=s,this.numDeleted=n,this.makeSelectionBoundDirty(),e&_y.deleted&&this.updateSorting(),this.scene.forceRender=!0,this.scene.events.fire("splat.stateChanged",this)}updatePositions(){const e=this.scene.dataProcessor.calcPositions(this),t=this.splatData.getProp("state"),{sorter:s}=this.entity.gsplat.instance,{centers:i}=s;for(let s=0;s<this.splatData.numSplats;++s)t[s]===_y.selected&&(i[3*s+0]=e[4*s],i[3*s+1]=e[4*s+1],i[3*s+2]=e[4*s+2]);this.updateSorting(),this.scene.forceRender=!0,this.scene.events.fire("splat.positionsChanged",this)}updateSorting(){const e=this.splatData.getProp("state");let t;if(this.makeLocalBoundDirty(),this.numSplats!==e.length){t=new Uint32Array(this.numSplats);let s=0;for(let i=0;i<e.length;++i)e[i]&_y.deleted||(t[s++]=i)}this.entity.gsplat.instance.sorter.setMapping(t)}get worldTransform(){return this.entity.getWorldTransform()}set name(e){e!==this.name&&(this._name=e,this.scene.events.fire("splat.name",this))}get name(){return this._name}get filename(){return this.asset.file.filename}calcSplatWorldPosition(e,t){if(e>=this.splatData.numSplats)return!1;const{sorter:s}=this.entity.gsplat.instance,{centers:i}=s;return t.set(i[3*e+0],i[3*e+1],i[3*e+2]),this.worldTransform.transformPoint(t,t),!0}add(){this.scene.contentRoot.addChild(this.entity),this.scene.events.on("view.bands",this.rebuildMaterial,this),this.rebuildMaterial(this.scene.events.invoke("view.bands")),this.updateState()}remove(){this.scene.events.off("view.bands",this.rebuildMaterial,this),this.scene.contentRoot.removeChild(this.entity),this.scene.boundDirty=!0}serialize(e){e.packa(this.entity.getWorldTransform().data),e.pack(this.changedCounter),e.pack(this.visible),e.pack(this.tintClr.r,this.tintClr.g,this.tintClr.b),e.pack(this.brightness,this.blackPoint,this.whitePoint,this.transparency)}onPreRender(){const e=this.scene.events,t=this.scene.camera.renderOverlays&&e.invoke("selection")===this,s=e.invoke("camera.mode"),i=e.invoke("camera.overlay"),n=this.entity.gsplat.instance.material;n.setParameter("mode","rings"===s?1:0),n.setParameter("ringSize",t&&i&&"rings"===s?.04:0);const a=t&&!e.invoke("view.outlineSelection")?this.selectionAlpha:0,r=e.invoke("selectedClr"),o=e.invoke("unselectedClr"),l=e.invoke("lockedClr");n.setParameter("selectedClr",[r.r,r.g,r.b,r.a*a]),n.setParameter("unselectedClr",[o.r,o.g,o.b,o.a]),n.setParameter("lockedClr",[l.r,l.g,l.b,l.a]);const h=-this.blackPoint+this.brightness,c=1/(this.whitePoint-this.blackPoint);if(n.setParameter("clrOffset",[h,h,h]),n.setParameter("clrScale",[this.tintClr.r*c,this.tintClr.g*c,this.tintClr.b*c,this.transparency]),this.visible&&t&&e.invoke("camera.bound")){const e=this.localBound,t=(new Et).setTRS(e.center,kt.IDENTITY,e.halfExtents);t.mul2(this.entity.getWorldTransform(),t);for(let e=0;e<xS.length/2;e++){const s=xS[2*e],i=xS[2*e+1];t.transformPoint(s,_S),t.transformPoint(i,yS),this.scene.app.drawLine(_S,yS,mt.WHITE,!0,this.scene.debugLayer)}}this.entity.enabled=this.visible;const d=this.scene.camera.entity.camera.renderTarget;this.entity.gsplat.instance.meshInstance.setParameter("viewport",[d.width,d.height])}focalPoint(){return this.worldBound.center}move(e,t,s){const i=this.entity;e&&i.setLocalPosition(e),t&&i.setLocalRotation(t),s&&i.setLocalScale(s),this.makeWorldBoundDirty(),this.scene.events.fire("splat.moved",this)}makeSelectionBoundDirty(){this.selectionBoundDirty=!0,this.makeLocalBoundDirty()}makeLocalBoundDirty(){this.localBoundDirty=!0,this.makeWorldBoundDirty()}makeWorldBoundDirty(){this.worldBoundDirty=!0,this.scene.boundDirty=!0}get selectionBound(){const e=this.selectionBoundStorage;return this.selectionBoundDirty&&(this.scene.dataProcessor.calcBound(this,e,!0),this.selectionBoundDirty=!1),e}get localBound(){const e=this.localBoundStorage;return this.localBoundDirty&&(this.scene.dataProcessor.calcBound(this,e,!1),this.localBoundDirty=!1,this.entity.getWorldTransform().transformPoint(e.center,vS)),e}get worldBound(){const e=this.worldBoundStorage;return this.worldBoundDirty&&(e.setFromTransformedAabb(this.localBound,this.entity.getWorldTransform()),this.worldBoundDirty=!1),e}set visible(e){e!==this.visible&&(this._visible=e,this.scene.events.fire("splat.visibility",this))}get visible(){return this._visible}set tintClr(e){this._tintClr.equals(e)||(this._tintClr.set(e.r,e.g,e.b),this.scene.events.fire("splat.tintClr",this))}get tintClr(){return this._tintClr}set brightness(e){e!==this._brightness&&(this._brightness=e,this.scene.events.fire("splat.brightness",this))}get brightness(){return this._brightness}set blackPoint(e){e!==this._blackPoint&&(this._blackPoint=e,this.scene.events.fire("splat.blackPoint",this))}get blackPoint(){return this._blackPoint}set whitePoint(e){e!==this._whitePoint&&(this._whitePoint=e,this.scene.events.fire("splat.whitePoint",this))}get whitePoint(){return this._whitePoint}set transparency(e){e!==this._transparency&&(this._transparency=e,this.scene.events.fire("splat.transparency",this))}get transparency(){return this._transparency}getPivot(e,t,s){const{entity:i}=this;switch(e){case"center":s.set(i.getLocalPosition(),i.getLocalRotation(),i.getLocalScale());break;case"boundCenter":i.getLocalTransform().transformPoint((t?this.selectionBound:this.localBound).center,vS),s.set(vS,i.getLocalRotation(),i.getLocalScale())}}docSerialize(){const e=e=>[e.x,e.y,e.z];return{name:this.name,position:e(this.entity.getLocalPosition()),rotation:(e=>[e.x,e.y,e.z,e.w])(this.entity.getLocalRotation()),scale:e(this.entity.getLocalScale()),visible:this.visible,tintClr:(e=>[e.r,e.g,e.b,e.a])(this.tintClr),brightness:this.brightness,blackPoint:this.blackPoint,whitePoint:this.whitePoint,transparency:this.transparency}}docDeserialize(e){const{name:t,position:s,rotation:i,scale:n,visible:a,tintClr:r,brightness:o,blackPoint:l,whitePoint:h,transparency:c}=e;this.name=t,this.move(new yt(s),new kt(i),new yt(n)),this.visible=a,this.tintClr=new mt(r[0],r[1],r[2],r[3]),this.brightness=o,this.blackPoint=l,this.whitePoint=h,this.transparency=c}}class bS{device;registry;events;defaultAnisotropy;loadAllData=!0;constructor(e,t,s,i){this.device=e,this.registry=t,this.events=s,this.defaultAnisotropy=i||1}loadPly(e){return e.animationFrame||this.events.fire("startSpinner"),new Promise(((t,s)=>{const i=new dp(e.filename||e.url,"gsplat",{url:e.url,filename:e.filename,contents:e.contents},{decompress:!0,reorder:!e.animationFrame});i.on("load",(()=>{const e=i.resource.splatData;if(e.getProp("scale_0")&&e.getProp("scale_1")&&!e.getProp("scale_2")){const t=new Float32Array(e.numSplats).fill(Math.log(1e-6));e.addProp("scale_2",t);const s=e.getElement("vertex").properties;s.splice(s.findIndex((e=>"scale_1"===e.name))+1,0,s.splice(s.length-1,1)[0])}const n=["x","y","z","scale_0","scale_1","scale_2","rot_0","rot_1","rot_2","rot_3","f_dc_0","f_dc_1","f_dc_2","opacity"].filter((t=>!e.getProp(t)));n.length>0?s(new Error(`This file does not contain gaussian splatting data. The following properties are missing: ${n.join(", ")}`)):t(new wS(i))})),i.on("error",(e=>{s(e)})),this.registry.add(i),this.registry.load(i)})).finally((()=>{e.animationFrame||this.events.fire("stopSpinner")}))}loadSplat(e){return this.events.fire("startSpinner"),new Promise(((t,s)=>{fetch(e.url||e.filename).then((e=>{if(e&&e.ok&&e.body)return e.arrayBuffer();s(new Error("Failed to fetch splat data"))})).then((e=>(e=>{const t=e.byteLength/32,s=new DataView(e),i=new Float32Array(t),n=new Float32Array(t),a=new Float32Array(t),r=new Float32Array(t),o=new Float32Array(t),l=new Float32Array(t),h=new Float32Array(t),c=new Float32Array(t),d=new Float32Array(t),u=new Float32Array(t),p=new Float32Array(t),m=new Float32Array(t),f=new Float32Array(t),g=new Float32Array(t),v=new Uint8Array(t),_=.28209479177387814;let y;for(let e=0;e<t;e++)y=32*e,i[e]=s.getFloat32(y+0,!0),n[e]=s.getFloat32(y+4,!0),a[e]=s.getFloat32(y+8,!0),m[e]=Math.log(s.getFloat32(y+12,!0)),f[e]=Math.log(s.getFloat32(y+16,!0)),g[e]=Math.log(s.getFloat32(y+20,!0)),d[e]=(s.getUint8(y+24)/255-.5)/_,u[e]=(s.getUint8(y+25)/255-.5)/_,p[e]=(s.getUint8(y+26)/255-.5)/_,r[e]=-Math.log(255/s.getUint8(y+27)-1),o[e]=(s.getUint8(y+28)-128)/128,l[e]=(s.getUint8(y+29)-128)/128,h[e]=(s.getUint8(y+30)-128)/128,c[e]=(s.getUint8(y+31)-128)/128;return new Ru([{name:"vertex",count:t,properties:[{type:"float",name:"x",storage:i,byteSize:4},{type:"float",name:"y",storage:n,byteSize:4},{type:"float",name:"z",storage:a,byteSize:4},{type:"float",name:"opacity",storage:r,byteSize:4},{type:"float",name:"rot_0",storage:o,byteSize:4},{type:"float",name:"rot_1",storage:l,byteSize:4},{type:"float",name:"rot_2",storage:h,byteSize:4},{type:"float",name:"rot_3",storage:c,byteSize:4},{type:"float",name:"f_dc_0",storage:d,byteSize:4},{type:"float",name:"f_dc_1",storage:u,byteSize:4},{type:"float",name:"f_dc_2",storage:p,byteSize:4},{type:"float",name:"scale_0",storage:m,byteSize:4},{type:"float",name:"scale_1",storage:f,byteSize:4},{type:"float",name:"scale_2",storage:g,byteSize:4},{type:"float",name:"state",storage:v,byteSize:4}]}])})(e))).then((s=>{const i=new dp(e.filename||e.url,"gsplat",{url:e.url,filename:e.filename});i.resource=new vg(this.device,s,[]),t(new wS(i))})).catch((e=>{console.error(e),s(new Error("Failed to load splat data"))}))})).finally((()=>{this.events.fire("stopSpinner")}))}loadModel(e){const t=(e.filename||e.url).toLowerCase();return t.endsWith(".ply")?this.loadPly(e):t.endsWith(".splat")?this.loadSplat(e):void 0}}const CS=new yt,SS=new yt,AS=new yt,TS=(e,t,s,i)=>Math.sqrt((s-e)**2+(i-t)**2);class PS{update;destroy;constructor(e,t){const s=(t,s)=>{const i=e.azim-t*e.scene.config.controls.orbitSensitivity,n=e.elevation-s*e.scene.config.controls.orbitSensitivity;e.setAzimElev(i,n)},i=(t,s,i,n)=>{const a=e.entity.camera,r=e.distanceTween.value.distance*e.sceneRadius/e.fovFactor;a.screenToWorld(t,s,r,CS),a.screenToWorld(t-i,s-n,r,SS),AS.sub2(SS,CS),AS.add(e.focalPoint),e.setFocalPoint(AS)},n=t=>{e.setDistance(e.distance-(.999*e.distance+.001)*t*e.scene.config.controls.zoomSensitivity,2)},a=[!1,!1,!1];let r,o,l,h,c,d=[];const u=e.scene.app.graphicsDevice.canvas,p={ArrowUp:0,ArrowDown:0,ArrowLeft:0,ArrowRight:0};this.update=t=>{const s=p.ArrowRight-p.ArrowLeft,i=p.ArrowDown-p.ArrowUp;if(s||i){const n=t*e.flySpeed,a=e.entity.getWorldTransform(),r=a.getX().mulScalar(s*n),o=a.getZ().mulScalar(i*n),l=e.focalPoint.add(r).add(o);e.setFocalPoint(l)}};let m=null;const f=(t,s,i,n)=>{const a=t=>{e.scene.events.fire("camera.controller",s),i(t)};t.addEventListener(s,a,n),m=()=>{m?.(),t.removeEventListener(s,a)}};f(t,"pointerdown",(e=>{"mouse"===e.pointerType?(a.every((e=>!e))&&t.setPointerCapture(e.pointerId),a[e.button]=!0,r=e.offsetX,o=e.offsetY):"touch"===e.pointerType&&(0===d.length&&t.setPointerCapture(e.pointerId),d.push({x:e.offsetX,y:e.offsetY,id:e.pointerId}),2===d.length&&(l=.5*(d[0].x+d[1].x),h=.5*(d[0].y+d[1].y),c=TS(d[0].x,d[0].y,d[1].x,d[1].y)))})),f(t,"pointerup",(e=>{"mouse"===e.pointerType?(a[e.button]=!1,a.every((e=>!e))&&t.releasePointerCapture(e.pointerId)):(d=d.filter((t=>t.id!==e.pointerId)),0===d.length&&t.releasePointerCapture(e.pointerId))})),f(t,"pointermove",(e=>{if("mouse"===e.pointerType){const t=e.offsetX-r,l=e.offsetY-o;r=e.offsetX,o=e.offsetY;const h=a[2]?e.shiftKey||e.ctrlKey?"orbit":e.altKey||e.metaKey?"zoom":null:null;"orbit"===h||null===h&&a[0]?s(t,l):"zoom"===h||null===h&&a[1]?n(-.02*l):("pan"===h||null===h&&a[2])&&i(r,o,t,l)}else if(1===d.length){const t=d[0],i=e.offsetX-t.x,n=e.offsetY-t.y;t.x=e.offsetX,t.y=e.offsetY,s(i,n)}else if(2===d.length){const t=d[d.map((e=>e.id)).indexOf(e.pointerId)];t.x=e.offsetX,t.y=e.offsetY;const s=.5*(d[0].x+d[1].x),a=.5*(d[0].y+d[1].y),r=TS(d[0].x,d[0].y,d[1].x,d[1].y);i(s,a,s-l,a-h),n(.01*(r-c)),l=s,h=a,c=r}})),f(t,"wheel",(e=>{const{deltaX:t,deltaY:a}=e;((e,t)=>Math.abs(e)>50&&0===t||Math.abs(t)>50&&0===e||0===e&&0!==t&&!Number.isInteger(t))(t,a)?n(-.002*a):e.ctrlKey||e.metaKey?n(-.02*a):e.shiftKey?i(e.offsetX,e.offsetY,t,a):s(t,a),e.preventDefault()}),{passive:!1}),f(t,"dblclick",(s=>{s.target!==t&&s.target!==u||e.pickFocalPoint(s.offsetX,s.offsetY)})),f(document,"keydown",(e=>{p.hasOwnProperty(e.key)&&e.target===document.body&&(p[e.key]=e.shiftKey?10:e.ctrlKey||e.metaKey||e.altKey?.1:1)})),f(document,"keyup",(e=>{p.hasOwnProperty(e.key)&&(p[e.key]=0)})),this.destroy=m}}const ES=e=>Math.pow(e-1,5)+1;class kS{keys;constructor(e){this.keys=Object.keys(e)}clone(e){const t={};return this.keys.forEach((s=>{t[s]=e[s]})),t}copy(e,t){this.keys.forEach((s=>{e[s]=t[s]}))}lerp(e,t,s,i){this.keys.forEach((n=>{e[n]=t[n]+i*(s[n]-t[n])}))}}class MS{ops;value;source;target;timer;transitionTime;constructor(e){this.ops=new kS(e),this.value=e,this.source=this.ops.clone(e),this.target=this.ops.clone(e),this.timer=0,this.transitionTime=0}goto(e,t=.25){0===t&&this.ops.copy(this.value,e),this.ops.copy(this.source,this.value),this.ops.copy(this.target,e),this.timer=0,this.transitionTime=t}update(e){this.timer<this.transitionTime?(this.timer=Math.min(this.timer+e,this.transitionTime),this.ops.lerp(this.value,this.source,this.target,ES(this.timer/this.transitionTime))):this.ops.copy(this.value,this.target)}}const IS=new yt,DS=new yt,RS=new Vt,LS=new Ut,FS=new yt,BS=new yt,OS=new yt;class zS extends Cw{controller;entity;focalPointTween=new MS({x:0,y:.5,z:0});azimElevTween=new MS({azim:30,elev:-15});distanceTween=new MS({distance:1});minElev=-90;maxElev=90;sceneRadius=1;flySpeed=5;picker;workRenderTarget;targetSize=null;suppressFinalBlit=!1;renderOverlays=!0;updateCameraUniforms;constructor(){super(xw.camera),this.entity=new Ep("Camera"),this.entity.addComponent("camera")}set ortho(e){e!==this.ortho&&(this.entity.camera.projection=e?1:0,this.scene.events.fire("camera.ortho",e))}get ortho(){return 1===this.entity.camera.projection}set fov(e){this.entity.camera.fov=e}get fov(){return this.entity.camera.fov}set tonemapping(e){const t={none:6,linear:0,neutral:5,aces:3,aces2:4,filmic:1,hejl:2}[e];void 0!==t&&t!==this.entity.camera.toneMapping&&(this.entity.camera.toneMapping=t,this.scene.events.fire("camera.tonemapping",e))}get tonemapping(){switch(this.entity.camera.toneMapping){case 6:return"none";case 0:return"linear";case 5:return"neutral";case 3:return"aces";case 4:return"aces2";case 1:return"filmic";case 2:return"hejl"}return"none"}set near(e){this.entity.camera.nearClip=e}get near(){return this.entity.camera.nearClip}set far(e){this.entity.camera.farClip=e}get far(){return this.entity.camera.farClip}get focalPoint(){const e=this.focalPointTween.target;return new yt(e.x,e.y,e.z)}get azimElev(){return this.azimElevTween.target}get azim(){return this.azimElev.azim}get elevation(){return this.azimElev.elev}get distance(){return this.distanceTween.target.distance}setFocalPoint(e,t=1){this.focalPointTween.goto(e,t*this.scene.config.controls.dampingFactor)}setAzimElev(e,t,s=1){var i;e=(e%(i=360)+i)%i,t=Math.max(this.minElev,Math.min(this.maxElev,t));const n=this.azimElevTween;n.goto({azim:e,elev:t},s*this.scene.config.controls.dampingFactor),n.source.azim-e<-180?n.source.azim+=360:n.source.azim-e>180&&(n.source.azim-=360),this.ortho=!1}setDistance(e,t=1){const s=this.scene.config.controls;e=Math.max(s.minZoom,Math.min(s.maxZoom,e));this.distanceTween.goto({distance:e},t*s.dampingFactor)}setPose(e,t,s=1){FS.sub2(t,e);const i=FS.length(),n=Math.atan2(-FS.x/i,-FS.z/i)*pt.RAD_TO_DEG,a=Math.asin(FS.y/i)*pt.RAD_TO_DEG;this.setFocalPoint(t,s),this.setAzimElev(n,a,s),this.setDistance(i/this.sceneRadius*this.fovFactor,s)}worldToScreen(e,t){this.entity.camera.worldToScreen(e,t)}add(){this.scene.cameraRoot.addChild(this.entity),this.entity.camera.layers=this.entity.camera.layers.concat([this.scene.shadowLayer.id,this.scene.debugLayer.id,this.scene.gizmoLayer.id]),this.scene.config.camera.debugRender&&this.entity.camera.setShaderPass(`debug_${this.scene.config.camera.debugRender}`);const e=document.getElementById("canvas-container");this.controller=new PS(this,e);const t=this.scene.config,s=t.controls;this.entity.camera.clearColor.set(0,0,0,0),this.minElev=180*s.minPolarAngle/Math.PI-90,this.maxElev=180*s.maxPolarAngle/Math.PI-90,this.scene.camera.entity.camera.toneMapping={linear:0,filmic:1,hejl:2,aces:3,aces2:4,neutral:5}[t.camera.toneMapping],this.scene.app.scene.exposure=t.camera.exposure,this.fov=t.camera.fov,this.setAzimElev(s.initialAzim,s.initialElev,0),this.setDistance(s.initialZoom,0);const{width:i,height:n}=this.scene.targetSize;this.picker=new pv(this.scene.app,i,n),this.picker.allocateRenderTarget=()=>{},this.picker.releaseRenderTarget=()=>{},this.scene.events.on("scene.boundChanged",this.onBoundChanged,this),this.updateCameraUniforms=()=>{const e=this.scene.graphicsDevice,t=this.entity,s=t.camera,i=(t,s)=>{e.scope.resolve(t).setValue([s.x,s.y,s.z])},n=s.camera.getFrustumCorners(-100),a=t.getWorldTransform();for(let e=0;e<n.length;e++)a.transformPoint(n[e],n[e]);0===s.projection?(i("near_origin",a.getTranslation()),i("near_x",yt.ZERO),i("near_y",yt.ZERO)):(i("near_origin",n[3]),i("near_x",OS.sub2(n[0],n[3])),i("near_y",OS.sub2(n[2],n[3]))),i("far_origin",n[7]),i("far_x",OS.sub2(n[4],n[7])),i("far_y",OS.sub2(n[6],n[7]))}}remove(){this.controller.destroy(),this.controller=null,this.entity.camera.layers=this.entity.camera.layers.filter((e=>e!==this.scene.shadowLayer.id)),this.scene.cameraRoot.removeChild(this.entity),this.picker=null,this.scene.events.off("scene.boundChanged",this.onBoundChanged,this)}onBoundChanged(e){const t=this.distanceTween.value.distance*this.sceneRadius;this.sceneRadius=Math.max(.001,e.halfExtents.length()),this.setDistance(t/this.sceneRadius,0)}serialize(e){e.packa(this.entity.getWorldTransform().data),e.pack(this.fov,this.tonemapping,this.entity.camera.renderTarget?.width,this.entity.camera.renderTarget?.height)}rebuildRenderTargets(){const e=this.scene.graphicsDevice,{width:t,height:s}=this.targetSize??this.scene.targetSize,i=this.entity.camera.renderTarget;if(i&&i.width===t&&i.height===s)return;i&&(i.destroyTextureBuffers(),i.destroy(),this.workRenderTarget.destroy(),this.workRenderTarget=null);const n=(t,s,i,n)=>new ki(e,{name:t,width:s,height:i,format:n,mipmaps:!1,minFilter:0,magFilter:0,addressU:1,addressV:1}),a=n("cameraColor",t,s,7),r=n("cameraDepth",t,s,Qt),o=new ln({colorBuffer:a,depthBuffer:r,flipY:!1,autoResolve:!1});this.entity.camera.renderTarget=o,this.entity.camera.horizontalFov=t>s;const l=n("workColor",t,s,7);this.workRenderTarget=new ln({colorBuffer:l,depth:!1,autoResolve:!1}),this.picker.renderTarget=this.workRenderTarget,this.scene.events.fire("camera.resize",{width:t,height:s})}onUpdate(e){this.controller.update(e),this.focalPointTween.update(e),this.azimElevTween.update(e),this.distanceTween.update(e);const t=this.azimElevTween.value,s=this.distanceTween.value;((e,t,s)=>{const i=s*pt.DEG_TO_RAD,n=t*pt.DEG_TO_RAD,a=Math.sin(-i),r=Math.cos(-i),o=Math.sin(-n),l=Math.cos(-n);e.set(-r*o,a,r*l)})(IS,t.azim,t.elev),DS.copy(IS),DS.mulScalar(s.distance*this.sceneRadius/this.fovFactor),DS.add(this.focalPointTween.value),this.entity.setLocalPosition(DS),this.entity.setLocalEulerAngles(t.elev,t.azim,0),this.fitClippingPlanes(this.entity.getLocalPosition(),this.entity.forward);const{camera:i}=this.entity;i.orthoHeight=this.distanceTween.value.distance*this.sceneRadius/this.fovFactor*(this.fov/90)*(i.horizontalFov?this.scene.targetSize.height/this.scene.targetSize.width:1),i.camera._updateViewProjMat()}fitClippingPlanes(e,t){const s=this.scene.bound,i=s.halfExtents.length();FS.sub2(s.center,e);const n=FS.dot(t);n>0?(this.far=n+i,this.near=Math.max(1e-6,n<i?this.far/16384:n-i)):(this.far=2*i,this.near=this.far/16384)}onPreRender(){this.rebuildRenderTargets(),this.updateCameraUniforms()}onPostRender(){const e=this.scene.graphicsDevice,t=this.entity.camera.renderTarget;t.samples>1&&t.resolve(!0,!1),this.suppressFinalBlit||e.copyRenderTarget(t,null,!0,!1)}focus(e){const t=e?e.focalPoint:(()=>{for(const e of this.scene.elements)if(e.type===xw.splat){const t=e.focalPoint?.();if(t)return t}})()??this.scene.bound.center,s=(e?e.radius:this.scene.bound.halfExtents.length())/this.sceneRadius;this.setDistance(isNaN(s)?1:s,e?.speed??0),this.setFocalPoint(t,e?.speed??0)}get fovFactor(){const{width:e,height:t}=this.scene.targetSize,s=e&&t?this.entity.camera.horizontalFov?t/e:e/t:1,i=2*Math.atan(Math.tan(this.fov*pt.DEG_TO_RAD*.5)*s);return Math.sin(.5*i)}pickFocalPoint(e,t){const s=this.scene,i=this.entity.getPosition(),n=s.canvas,a=e/n.clientWidth*s.targetSize.width,r=t/n.clientHeight*s.targetSize.height,o=s.getElementsByType(xw.splat);let l=0;const h=new yt;let c=null;for(let s=0;s<o.length;++s){const n=o[s];this.pickPrep(n,"set");const d=this.pick(a,r);if(-1!==d&&(n.calcSplatWorldPosition(d,FS),RS.setFromPointNormal(FS,this.entity.forward),this.ortho?(this.entity.camera.screenToWorld(e,t,-1,FS),this.entity.camera.screenToWorld(e,t,1,BS),BS.sub(FS).normalize(),LS.set(FS,BS)):(this.entity.camera.screenToWorld(e,t,1,FS),FS.sub(i).normalize(),LS.set(i,FS)),RS.intersectsRay(LS,FS))){const e=BS.sub2(FS,LS.origin).length();(!c||e<l)&&(l=e,h.copy(FS),c=n)}}c&&(this.setFocalPoint(h),this.setDistance(l/this.sceneRadius*this.fovFactor),s.events.fire("camera.focalPointPicked",{camera:this,splat:c,position:h}))}pickPrep(e,t){const{width:s,height:i}=this.scene.targetSize,n=this.scene.app.scene.layers.getLayerByName("World"),a=this.scene.graphicsDevice,r="rings"===this.scene.events.invoke("camera.mode")?0:.2,o=this.scene.getElementsByType(xw.splat);o.forEach((t=>{t.entity.enabled=t===e})),a.scope.resolve("pickerAlpha").setValue(r),a.scope.resolve("pickMode").setValue(["add","remove","set"].indexOf(t)),this.picker.resize(s,i),this.picker.prepare(this.entity.camera,this.scene.app.scene,[n]),o.forEach((e=>{e.entity.enabled=!0}))}pick(e,t){return this.pickRect(e,t,1,1)[0]}pickRect(e,t,s,i){const n=this.scene.graphicsDevice,a=new Uint8Array(s*i*4);n.setRenderTarget(this.picker.renderTarget),n.updateBegin(),n.readPixels(e,this.picker.renderTarget.height-t-i,s,i,a),n.updateEnd();const r=[];for(let e=0;e<s*i;e++)r.push(a[4*e]|a[4*e+1]<<8|a[4*e+2]<<16|a[4*e+3]<<24);return r}docSerialize(){return{focalPoint:(e=>[e.x,e.y,e.z])(this.focalPointTween.target),azim:this.azim,elev:this.elevation,distance:this.distance,fov:this.fov,tonemapping:this.tonemapping}}docDeserialize(e){this.setFocalPoint(new yt(e.focalPoint),0),this.setAzimElev(e.azim,e.elev,0),this.setDistance(e.distance,0),this.fov=e.fov,this.tonemapping=e.tonemapping}startOffscreenMode(e,t){this.targetSize={width:e,height:t},this.suppressFinalBlit=!0}endOffscreenMode(){this.targetSize=null,this.suppressFinalBlit=!1}}const VS=new yt,NS=new yt,US=(e,t)=>{for(const s in t)e.resolve(s).setValue(t[s])};class HS{device;dummyTexture;viewProjectionMat=new Et;splatParams=new Int32Array(3);getIntersectResources;getBoundResources;getPositionResources;constructor(e){this.device=e,this.dummyTexture=new ki(e,{width:1,height:1,format:7});const t=(t,s,i,n)=>new ki(e,{name:t,width:s,height:i,format:n,mipmaps:!1,addressU:1,addressV:1});this.getIntersectResources=(()=>{let s=null,i=null,n=null,a=null;return(r,o)=>{s||(s=Po(e,"\n    attribute vec2 vertex_position;\n    void main(void) {\n        gl_Position = vec4(vertex_position, 0.0, 1.0);\n    }\n","\n    uniform highp usampler2D transformA;            // splat center x, y, z\n    uniform highp usampler2D splatTransform;        // transform palette index\n    uniform sampler2D transformPalette;             // palette of transforms\n    uniform uvec2 splat_params;                     // splat texture width, num splats\n\n    uniform mat4 matrix_model;\n    uniform mat4 matrix_viewProjection;\n\n    uniform uvec2 output_params;                    // output width, height\n\n    // 0: mask, 1: rect, 2: sphere\n    uniform int mode;\n\n    // mask params\n    uniform sampler2D mask;                         // mask in alpha channel\n    uniform vec2 mask_params;                       // mask width, height\n\n    // rect params\n    uniform vec4 rect_params;                       // rect x, y, width, height\n\n    // sphere params\n    uniform vec4 sphere_params;                     // sphere x, y, z, radius\n\n    void main(void) {\n        // calculate output id\n        uvec2 outputUV = uvec2(gl_FragCoord);\n        uint outputId = (outputUV.x + outputUV.y * output_params.x) * 4u;\n\n        vec4 clr = vec4(0.0);\n\n        for (uint i = 0u; i < 4u; i++) {\n            uint id = outputId + i;\n\n            if (id >= splat_params.y) {\n                continue;\n            }\n\n            // calculate splatUV\n            ivec2 splatUV = ivec2(\n                int(id % splat_params.x),\n                int(id / splat_params.x)\n            );\n\n            // read splat center\n            vec3 center = uintBitsToFloat(texelFetch(transformA, splatUV, 0).xyz);\n\n            // apply optional per-splat transform\n            uint transformIndex = texelFetch(splatTransform, splatUV, 0).r;\n            if (transformIndex > 0u) {\n                // read transform matrix\n                int u = int(transformIndex % 512u) * 3;\n                int v = int(transformIndex / 512u);\n\n                mat3x4 t;\n                t[0] = texelFetch(transformPalette, ivec2(u, v), 0);\n                t[1] = texelFetch(transformPalette, ivec2(u + 1, v), 0);\n                t[2] = texelFetch(transformPalette, ivec2(u + 2, v), 0);\n\n                center = vec4(center, 1.0) * t;\n            }\n\n            // transform to clip space and discard if outside\n            vec3 world = (matrix_model * vec4(center, 1.0)).xyz;\n            vec4 clip = matrix_viewProjection * vec4(world, 1.0);\n            vec3 ndc = clip.xyz / clip.w;\n\n            // skip offscreen fragments\n            if (!any(greaterThan(abs(ndc), vec3(1.0)))) {\n                if (mode == 0) {\n                    // select by mask\n                    ivec2 maskUV = ivec2((ndc.xy * vec2(0.5, -0.5) + 0.5) * mask_params);\n                    clr[i] = texelFetch(mask, maskUV, 0).a < 1.0 ? 0.0 : 1.0;\n                } else if (mode == 1) {\n                    // select by rect\n                    clr[i] = all(greaterThan(ndc.xy * vec2(1.0, -1.0), rect_params.xy)) && all(lessThan(ndc.xy * vec2(1.0, -1.0), rect_params.zw)) ? 1.0 : 0.0;\n                } else if (mode == 2) {\n                    // select by sphere\n                    clr[i] = length(world - sphere_params.xyz) < sphere_params.w ? 1.0 : 0.0;\n                }\n            }\n        }\n\n        gl_FragColor = clr;\n    }\n","intersectByMaskShader",{vertex_position:ms}));const l=Math.max(1,Math.floor(r/2)),h=Math.ceil(o/(4*l));return i&&i.width===l&&i.height===h||(i&&(i.destroy(),n.destroy()),i=t("intersectTexture",l,h,7),n=new ln({colorBuffer:i,depth:!1}),a=new Uint8Array(l*h*4)),{shader:s,texture:i,renderTarget:n,data:a}}})(),this.getBoundResources=(()=>{let s=null,i=null,n=null,a=null,r=null,o=null,l=null,h=null;return c=>(s||(s=Po(e,"\n    attribute vec2 vertex_position;\n    void main(void) {\n        gl_Position = vec4(vertex_position, 0.0, 1.0);\n    }\n","\n    uniform highp usampler2D transformA;                // splat center x, y, z\n    uniform highp usampler2D splatTransform;            // transform palette index\n    uniform sampler2D transformPalette;                 // palette of transforms\n    uniform sampler2D splatState;                       // per-splat state\n    uniform highp ivec3 splat_params;                   // texture width, texture height, num splats\n    uniform highp uint mode;                            // 0: selected, 1: visible\n\n    // calculate min and max for a single column of splats\n    void main(void) {\n\n        vec3 boundMin = vec3(100000.0);\n        vec3 boundMax = vec3(-100000.0);\n\n        for (int id = 0; id < splat_params.y; id++) {\n            // calculate splatUV\n            ivec2 splatUV = ivec2(gl_FragCoord.x, id);\n\n            // skip out-of-range splats\n            if ((splatUV.x + splatUV.y * splat_params.x) >= splat_params.z) {\n                continue;\n            }\n\n            // read splat state\n            uint state = uint(texelFetch(splatState, splatUV, 0).r * 255.0);\n\n            // skip deleted or hidden splats\n            if (((mode == 0u) && (state != 1u)) || ((mode == 1u) && ((state & 4u) != 0u))) {\n                continue;\n            }\n\n            // read splat center\n            vec3 center = uintBitsToFloat(texelFetch(transformA, splatUV, 0).xyz);\n\n            // apply optional per-splat transform\n            uint transformIndex = texelFetch(splatTransform, splatUV, 0).r;\n            if (transformIndex > 0u) {\n                // read transform matrix\n                int u = int(transformIndex % 512u) * 3;\n                int v = int(transformIndex / 512u);\n\n                mat3x4 t;\n                t[0] = texelFetch(transformPalette, ivec2(u, v), 0);\n                t[1] = texelFetch(transformPalette, ivec2(u + 1, v), 0);\n                t[2] = texelFetch(transformPalette, ivec2(u + 2, v), 0);\n\n                center = vec4(center, 1.0) * t;\n            }\n\n            boundMin = min(boundMin, center);\n            boundMax = max(boundMax, center);\n        }\n\n        pcFragColor0 = vec4(boundMin, 0.0);\n        pcFragColor1 = vec4(boundMax, 0.0);\n    }\n","calcBoundShader",{vertex_position:ms})),i&&i.width===c||(i&&(i.destroy(),n.destroy(),a.destroy(),r.destroy(),o.destroy()),i=t("calcBoundMin",c,1,Zt),n=t("calcBoundMax",c,1,Zt),a=new ln({colorBuffers:[i,n],depth:!1}),o=new ln({colorBuffer:n,depth:!1}),r=new ln({colorBuffer:i,depth:!1}),l=new Float32Array(4*c),h=new Float32Array(4*c)),{shader:s,minTexture:i,maxTexture:n,renderTarget:a,minRenderTarget:r,maxRenderTarget:o,minData:l,maxData:h})})(),this.getPositionResources=(()=>{let s=null,i=null,n=null,a=null;return(r,o,l)=>(s||(s=Po(e,"\n    attribute vec2 vertex_position;\n    void main(void) {\n        gl_Position = vec4(vertex_position, 0.0, 1.0);\n    }\n","\n    uniform highp usampler2D transformA;            // splat center x, y, z\n    uniform highp usampler2D splatTransform;        // transform palette index\n    uniform sampler2D transformPalette;             // palette of transforms\n    uniform ivec2 splat_params;                     // splat texture width, num splats\n\n    void main(void) {\n        // calculate output id\n        ivec2 splatUV = ivec2(gl_FragCoord);\n\n        // skip if splat index is out of bounds\n        if (splatUV.x + splatUV.y * splat_params.x >= splat_params.y) {\n            discard;\n        }\n\n        // read splat center\n        vec3 center = uintBitsToFloat(texelFetch(transformA, splatUV, 0).xyz);\n\n        // apply optional per-splat transform\n        uint transformIndex = texelFetch(splatTransform, splatUV, 0).r;\n        if (transformIndex > 0u) {\n            // read transform matrix\n            int u = int(transformIndex % 512u) * 3;\n            int v = int(transformIndex / 512u);\n\n            mat3x4 t;\n            t[0] = texelFetch(transformPalette, ivec2(u, v), 0);\n            t[1] = texelFetch(transformPalette, ivec2(u + 1, v), 0);\n            t[2] = texelFetch(transformPalette, ivec2(u + 2, v), 0);\n\n            center = vec4(center, 1.0) * t;\n        }\n\n        gl_FragColor = vec4(center, 0.0);\n    }\n","calcPositionShader",{vertex_position:ms})),i&&i.width===r&&i.height===o||(i&&(i.destroy(),n.destroy()),i=t("positionTex",r,o,Zt),n=new ln({colorBuffer:i,depth:!1}),a=new Float32Array(r*o*4)),{shader:s,texture:i,renderTarget:n,data:a})})()}intersect(e,t){const{device:s}=this,{scope:i}=s,n=t.splatData.numSplats,a=t.entity.gsplat.instance.splat.transformATexture,r=t.transformTexture,o=t.transformPalette.texture,l=t.scene.camera.entity.camera;this.viewProjectionMat.mul2(l.projectionMatrix,l.viewMatrix);const h=this.getIntersectResources(a.width,n);US(i,{transformA:a,splatTransform:r,transformPalette:o,splat_params:[a.width,n],matrix_model:t.entity.getWorldTransform().data,matrix_viewProjection:this.viewProjectionMat.data,output_params:[h.texture.width,h.texture.height]});const c=e;c.mask?US(i,{mode:0,mask:c.mask,mask_params:[c.mask.width,c.mask.height]}):US(i,{mask:this.dummyTexture,mask_params:[0,0]});const d=e;d.rect?US(i,{mode:1,rect_params:[2*d.rect.x1-1,2*d.rect.y1-1,2*d.rect.x2-1,2*d.rect.y2-1]}):US(i,{rect_params:[0,0,0,0]});const u=e;u.sphere?US(i,{mode:2,sphere_params:[u.sphere.x,u.sphere.y,u.sphere.z,u.sphere.radius]}):US(i,{sphere_params:[0,0,0,0]}),s.setBlendState(Vi.NOBLEND),Oo(s,h.renderTarget,h.shader);return s.readPixels(0,0,h.texture.width,h.texture.height,h.data),h.data}calcBound(e,t,s){const i=e.scene.graphicsDevice,{scope:n}=i,a=e.splatData.numSplats,r=e.entity.gsplat.instance.splat.transformATexture,o=e.transformTexture,l=e.transformPalette.texture,h=e.stateTexture;this.splatParams[0]=r.width,this.splatParams[1]=r.height,this.splatParams[2]=a;const c=this.getBoundResources(r.width);US(n,{transformA:r,splatTransform:o,transformPalette:l,splatState:h,splat_params:this.splatParams,mode:s?0:1});const d=i;i.setBlendState(Vi.NOBLEND),Oo(i,c.renderTarget,c.shader),d.gl.readPixels(0,0,r.width,1,c.minTexture.impl._glFormat,c.minTexture.impl._glPixelType,c.minData),d.setRenderTarget(c.maxRenderTarget),d.updateBegin(),d.gl.readPixels(0,0,r.width,1,c.maxTexture.impl._glFormat,c.maxTexture.impl._glPixelType,c.maxData),d.updateEnd();const{minData:u,maxData:p}=c;VS.set(u[0],u[1],u[2]),NS.set(p[0],p[1],p[2]);for(let e=1;e<r.width;e++)VS.x=Math.min(VS.x,u[4*e]),VS.y=Math.min(VS.y,u[4*e+1]),VS.z=Math.min(VS.z,u[4*e+2]),NS.x=Math.max(NS.x,p[4*e]),NS.y=Math.max(NS.y,p[4*e+1]),NS.z=Math.max(NS.z,p[4*e+2]);t.setMinMax(VS,NS)}calcPositions(e){const{device:t}=this,{scope:s}=t,i=e.splatData.numSplats,n=e.entity.gsplat.instance.splat.transformATexture,a=e.transformTexture,r=e.transformPalette.texture,o=this.getPositionResources(n.width,n.height,i);US(s,{transformA:n,splatTransform:a,transformPalette:r,splat_params:[n.width,i]}),t.setBlendState(Vi.NOBLEND),Oo(t,o.renderTarget,o.shader);return t.gl.readPixels(0,0,o.texture.width,o.texture.height,o.texture.impl._glFormat,o.texture.impl._glPixelType,o.data),o.data}}class GS extends Cw{shader;quadRender;blendState=new Vi(!1);depthState=new Hi(3,!0);visible=!0;constructor(){super(xw.debug)}add(){const e=this.scene.app.graphicsDevice;this.shader=Po(e,"\n    uniform vec3 near_origin;\n    uniform vec3 near_x;\n    uniform vec3 near_y;\n\n    uniform vec3 far_origin;\n    uniform vec3 far_x;\n    uniform vec3 far_y;\n\n    attribute vec2 vertex_position;\n\n    varying vec3 worldFar;\n    varying vec3 worldNear;\n\n    void main(void) {\n        gl_Position = vec4(vertex_position, 0.0, 1.0);\n\n        vec2 p = vertex_position * 0.5 + 0.5;\n        worldNear = near_origin + near_x * p.x + near_y * p.y;\n        worldFar = far_origin + far_x * p.x + far_y * p.y;\n    }\n","\n    uniform vec3 view_position;\n    uniform mat4 matrix_viewProjection;\n    uniform sampler2D blueNoiseTex32;\n\n    uniform int plane;  // 0: x (yz), 1: y (xz), 2: z (xy)\n\n    vec4 planes[3] = vec4[3](\n        vec4(1.0, 0.0, 0.0, 0.0),\n        vec4(0.0, 1.0, 0.0, 0.0),\n        vec4(0.0, 0.0, 1.0, 0.0)\n    );\n\n    vec3 colors[3] = vec3[3](\n        vec3(1.0, 0.2, 0.2),\n        vec3(0.2, 1.0, 0.2),\n        vec3(0.2, 0.2, 1.0)\n    );\n\n    int axis0[3] = int[3](1, 0, 0);\n    int axis1[3] = int[3](2, 2, 1);\n\n    varying vec3 worldNear;\n    varying vec3 worldFar;\n\n    bool intersectPlane(inout float t, vec3 pos, vec3 dir, vec4 plane) {\n        float d = dot(dir, plane.xyz);\n        if (abs(d) < 1e-06) {\n            return false;\n        }\n\n        float n = -(dot(pos, plane.xyz) + plane.w) / d;\n        if (n < 0.0) {\n            return false;\n        }\n\n        t = n;\n\n        return true;\n    }\n\n    // https://bgolus.medium.com/the-best-darn-grid-shader-yet-727f9278b9d8#1e7c\n    float pristineGrid(in vec2 uv, in vec2 ddx, in vec2 ddy, vec2 lineWidth) {\n        vec2 uvDeriv = vec2(length(vec2(ddx.x, ddy.x)), length(vec2(ddx.y, ddy.y)));\n        bvec2 invertLine = bvec2(lineWidth.x > 0.5, lineWidth.y > 0.5);\n        vec2 targetWidth = vec2(\n            invertLine.x ? 1.0 - lineWidth.x : lineWidth.x,\n            invertLine.y ? 1.0 - lineWidth.y : lineWidth.y\n        );\n        vec2 drawWidth = clamp(targetWidth, uvDeriv, vec2(0.5));\n        vec2 lineAA = uvDeriv * 1.5;\n        vec2 gridUV = abs(fract(uv) * 2.0 - 1.0);\n        gridUV.x = invertLine.x ? gridUV.x : 1.0 - gridUV.x;\n        gridUV.y = invertLine.y ? gridUV.y : 1.0 - gridUV.y;\n        vec2 grid2 = smoothstep(drawWidth + lineAA, drawWidth - lineAA, gridUV);\n\n        grid2 *= clamp(targetWidth / drawWidth, 0.0, 1.0);\n        grid2 = mix(grid2, targetWidth, clamp(uvDeriv * 2.0 - 1.0, 0.0, 1.0));\n        grid2.x = invertLine.x ? 1.0 - grid2.x : grid2.x;\n        grid2.y = invertLine.y ? 1.0 - grid2.y : grid2.y;\n\n        return mix(grid2.x, 1.0, grid2.y);\n    }\n\n    float calcDepth(vec3 p) {\n        vec4 v = matrix_viewProjection * vec4(p, 1.0);\n        return (v.z / v.w) * 0.5 + 0.5;\n    }\n\n    bool writeDepth(float alpha) {\n        vec2 uv = fract(gl_FragCoord.xy / 32.0);\n        float noise = texture2DLod(blueNoiseTex32, uv, 0.0).y;\n        return alpha > noise;\n    }\n\n    void main(void) {\n        vec3 p = worldNear;\n        vec3 v = normalize(worldFar - worldNear);\n\n        // intersect ray with the world xz plane\n        float t;\n        if (!intersectPlane(t, p, v, planes[plane])) {\n            discard;\n        }\n\n        // calculate grid intersection\n        vec3 worldPos = p + v * t;\n        vec2 pos = plane == 0 ? worldPos.yz : (plane == 1 ? worldPos.xz : worldPos.xy);\n        vec2 ddx = dFdx(pos);\n        vec2 ddy = dFdy(pos);\n\n        float epsilon = 1.0 / 255.0;\n\n        // calculate fade\n        float fade = 1.0 - smoothstep(400.0, 1000.0, length(worldPos - view_position));\n        if (fade < epsilon) {\n            discard;\n        }\n\n        vec2 levelPos;\n        float levelSize;\n        float levelAlpha;\n\n        // 10m grid with colored main axes\n        levelPos = pos * 0.1;\n        levelSize = 2.0 / 1000.0;\n        levelAlpha = pristineGrid(levelPos, ddx * 0.1, ddy * 0.1, vec2(levelSize)) * fade;\n        if (levelAlpha > epsilon) {\n            vec3 color;\n            vec2 loc = abs(levelPos);\n            if (loc.x < levelSize) {\n                if (loc.y < levelSize) {\n                    color = vec3(1.0);\n                } else {\n                    color = colors[axis1[plane]];\n                }\n            } else if (loc.y < levelSize) {\n                color = colors[axis0[plane]];\n            } else {\n                color = vec3(0.9);\n            }\n            gl_FragColor = vec4(color, levelAlpha);\n            gl_FragDepth = writeDepth(levelAlpha) ? calcDepth(worldPos) : 1.0;\n            return;\n        }\n\n        // 1m grid\n        levelPos = pos;\n        levelSize = 1.0 / 100.0;\n        levelAlpha = pristineGrid(levelPos, ddx, ddy, vec2(levelSize)) * fade;\n        if (levelAlpha > epsilon) {\n            gl_FragColor = vec4(vec3(0.7), levelAlpha);\n            gl_FragDepth = writeDepth(levelAlpha) ? calcDepth(worldPos) : 1.0;\n            return;\n        }\n\n        // 0.1m grid\n        levelPos = pos * 10.0;\n        levelSize = 1.0 / 100.0;\n        levelAlpha = pristineGrid(levelPos, ddx * 10.0, ddy * 10.0, vec2(levelSize)) * fade;\n        if (levelAlpha > epsilon) {\n            gl_FragColor = vec4(vec3(0.7), levelAlpha);\n            gl_FragDepth = writeDepth(levelAlpha) ? calcDepth(worldPos) : 1.0;\n            return;\n        }\n\n        discard;\n    }\n","infinite-grid",{vertex_position:ms}),this.quadRender=new Lo(this.shader);const t=new Vi(!0,0,6,8,0,1,8);this.scene.camera.entity.camera.on("preRenderLayer",((s,i)=>{if(this.visible&&s===this.scene.debugLayer&&!i&&this.scene.camera.renderOverlays){e.setBlendState(t),e.setCullMode(0),e.setDepthState(Hi.WRITEDEPTH),e.setStencilState(null,null);const{camera:s}=this.scene;if(s.ortho){const t=(e,t)=>1-Math.abs(e.dot(t))<.001,i=s.entity.getWorldTransform().getZ(),n=t(i,yt.RIGHT)?0:t(i,yt.BACK)?2:1;e.scope.resolve("plane").setValue(n)}else e.scope.resolve("plane").setValue(1);this.quadRender.render()}}))}remove(){this.shader.destroy(),this.quadRender.destroy()}serialize(e){e.pack(this.visible)}}class WS extends Cw{entity;shader;quadRender;enabled=!0;clr=new mt(1,1,1,.5);constructor(){super(xw.other),this.entity=new Ep("outlineCamera"),this.entity.addComponent("camera"),this.entity.camera.setShaderPass("OUTLINE"),this.entity.camera.clearColor=new mt(0,0,0,0)}add(){const e=this.scene.app.graphicsDevice,t=this.scene.overlayLayer.id;this.scene.events.on("selection.changed",((e,s)=>{s&&(s.entity.gsplat.layers=s.entity.gsplat.layers.filter((e=>e!==t))),e&&(e.entity.gsplat.layers=e.entity.gsplat.layers.concat([t]))})),this.entity.camera.layers=[t],this.scene.camera.entity.addChild(this.entity),this.shader=Po(e,"\n    attribute vec2 vertex_position;\n    void main(void) {\n        gl_Position = vec4(vertex_position, 0.0, 1.0);\n    }\n","\n    uniform sampler2D outlineTexture;\n    uniform float alphaCutoff;\n    uniform vec4 clr;\n\n    void main(void) {\n        ivec2 texel = ivec2(gl_FragCoord.xy);\n\n        // skip solid pixels\n        if (texelFetch(outlineTexture, texel, 0).a > alphaCutoff) {\n            discard;\n        }\n\n        for (int x = -2; x <= 2; x++) {\n            for (int y = -2; y <= 2; y++) {\n                if ((x != 0) && (y != 0) && (texelFetch(outlineTexture, texel + ivec2(x, y), 0).a > alphaCutoff)) {\n                    gl_FragColor = clr;\n                    return;\n                }\n            }\n        }\n\n        discard;\n    }\n","apply-outline",{vertex_position:ms}),this.quadRender=new Lo(this.shader);const s=e.scope.resolve("outlineTexture"),i=e.scope.resolve("alphaCutoff"),n=e.scope.resolve("clr"),a=[1,1,1,1],r=this.scene.events;this.entity.camera.on("postRenderLayer",((t,o)=>{if(!this.entity.enabled||t!==this.scene.overlayLayer||!o)return;e.setBlendState(Vi.ALPHABLEND),e.setCullMode(0),e.setDepthState(Hi.NODEPTH),e.setStencilState(null,null);const l=r.invoke("selectedClr");a[0]=l.r,a[1]=l.g,a[2]=l.b,a[3]=l.a,s.setValue(this.entity.camera.renderTarget.colorBuffer),i.setValue("rings"===r.invoke("camera.mode")?0:.4),n.setValue(a);const h=e;h.setRenderTarget(this.scene.camera.entity.camera.renderTarget),h.updateBegin(),this.quadRender.render(),h.updateEnd()}))}remove(){this.scene.camera.entity.removeChild(this.entity)}onPreRender(){const e=this.scene.camera.entity.camera,t=this.entity.camera;t.projection=e.projection,t.horizontalFov=e.horizontalFov,t.fov=e.fov,t.nearClip=e.nearClip,t.farClip=e.farClip,t.orthoHeight=e.orthoHeight,this.entity.enabled=this.enabled&&this.scene.events.invoke("view.outlineSelection"),this.entity.camera.renderTarget=this.scene.camera.workRenderTarget}}class jS extends Rp{constructor(e,t){super(e);const s=new Bp;s.graphicsDevice=t.graphicsDevice,this.addComponentSystems(s),this.addResourceHandles(s),s.elementInput=t.elementInput,s.keyboard=t.keyboard,s.mouse=t.mouse,s.touch=t.touch,s.gamepads=t.gamepads,s.scriptPrefix=t.scriptPrefix,s.assetPrefix=t.assetPrefix,s.scriptsOrder=t.scriptsOrder,this.init(s)}addComponentSystems(e){e.componentSystems=[Mm,Nm,qm,Zm,sf]}addResourceHandles(e){e.resourceHandlers=[lf,rg,og,ov,dg,cg,Mg]}}class qS{constructor(e){this.packValue=e}packValue;pack(...e){for(let t=0;t<e.length;++t)this.packValue(e[t])}packa(e){for(let t=0;t<e.length;++t)this.packValue(e[t])}packVec3(e){this.pack(e.x,e.y,e.z)}packColor(e){this.pack(e.r,e.g,e.b,e.a)}}const XS=new Set;class YS{states={};activeValues;serializer=new qS((e=>{this.activeValues.push(e)}));constructor(){for(let e=0;e<ww.length;++e)this.states[ww[e]]={elements:new Map,valueStart:[],valueCount:[],values:[]}}reset(){ww.forEach((e=>{const t=this.states[e];t.elements.clear(),t.valueStart.length=0,t.valueCount.length=0,t.values.length=0}))}pack(e){const t=this.states[e.type],s=t.values.length;this.activeValues=t.values,e.serialize(this.serializer),t.elements.set(e,t.elements.size),t.valueStart.push(s),t.valueCount.push(t.values.length-s)}compare(e){function t(e,t){for(const s of e.keys())if(!t.has(s))return!0}function s(e,t){for(const s of e)if(t(s))return!0;return!1}const i={added:new Array,removed:new Array,moved:new Array,changed:new Array};return ww.forEach((n=>{const a=e.states[n],r=this.states[n],o=a.elements,l=r.elements;!function(e,t,s){e.clear();for(const i of t.keys())s.has(i)&&e.add(i)}(XS,o,l),t(l,XS)&&i.added.push(n),t(o,XS)&&i.removed.push(n),s(XS.values(),(e=>o.get(e)!==l.get(e)))&&i.moved.push(n),s(XS.values(),(e=>{const t=o.get(e),s=l.get(e),i=a.valueCount[t];if(i!==r.valueCount[s])return!0;const n=a.valueStart[t],h=r.valueStart[s],c=a.values,d=r.values;for(let e=0;e<i;++e)if(c[n+e]!==d[h+e])return!0;return!1}))&&i.changed.push(n)})),i}}class $S extends Cw{meshInstance;constructor(){super(xw.debug)}add(){const e=this.scene.graphicsDevice,t=new Wc({uniqueName:"splatOverlayMaterial",attributes:{vertex_id:ms},vertexCode:"\n    attribute uint vertex_id;\n\n    uniform mat4 matrix_model;\n    uniform mat4 matrix_viewProjection;\n\n    uniform sampler2D splatState;\n    uniform highp usampler2D splatPosition;\n    uniform highp usampler2D splatTransform;        // per-splat index into transform palette\n    uniform sampler2D transformPalette;             // palette of transform matrices\n\n    uniform uvec2 texParams;\n\n    uniform float splatSize;\n    uniform vec4 selectedClr;\n    uniform vec4 unselectedClr;\n\n    varying vec4 varying_color;\n\n    // calculate the current splat index and uv\n    ivec2 calcSplatUV(uint index, uint width) {\n        return ivec2(int(index % width), int(index / width));\n    }\n\n    void main(void) {\n        ivec2 splatUV = calcSplatUV(vertex_id, texParams.x);\n        uint splatState = uint(texelFetch(splatState, splatUV, 0).r * 255.0);\n\n        if ((splatState & 6u) != 0u) {\n            // deleted or hidden (4 or 2)\n            gl_Position = vec4(0.0, 0.0, 2.0, 1.0);\n            gl_PointSize = 0.0;\n        } else {\n            mat4 model = matrix_model;\n        \n            // handle per-splat transform\n            uint transformIndex = texelFetch(splatTransform, splatUV, 0).r;\n            if (transformIndex > 0u) {\n                // read transform matrix\n                int u = int(transformIndex % 512u) * 3;\n                int v = int(transformIndex / 512u);\n\n                mat4 t;\n                t[0] = texelFetch(transformPalette, ivec2(u, v), 0);\n                t[1] = texelFetch(transformPalette, ivec2(u + 1, v), 0);\n                t[2] = texelFetch(transformPalette, ivec2(u + 2, v), 0);\n                t[3] = vec4(0.0, 0.0, 0.0, 1.0);\n\n                model = matrix_model * transpose(t);\n            }\n\n            varying_color = (splatState == 1u) ? selectedClr : unselectedClr;\n\n            vec3 center = uintBitsToFloat(texelFetch(splatPosition, splatUV, 0).xyz);\n\n            gl_Position = matrix_viewProjection * model * vec4(center, 1.0);\n            gl_PointSize = splatSize;\n        }\n    }\n",fragmentCode:"\n    varying vec4 varying_color;\n\n    void main(void) {\n        gl_FragColor = varying_color;\n    }\n"});t.blendType=2;const s=new Wo(e),i=new sl(s,t,null),n=this.scene.events;n.on("selection.changed",(n=>{(n=>{if(!n)return void(i.node=null);const a=n.splatData,r=new tn(e,[{semantic:ms,components:1,type:5,asInt:!0}]),o=new Uint32Array(a.numSplats);for(let e=0;e<a.numSplats;++e)o[e]=e;const l=new $i(e,r,a.numSplats,{usage:0,data:o});s.vertexBuffer&&(s.vertexBuffer.destroy(),s.vertexBuffer=null),s.vertexBuffer=l,s.primitive[0]={type:0,base:0,count:a.numSplats},t.setParameter("splatState",n.stateTexture),t.setParameter("splatPosition",n.entity.gsplat.instance.splat.transformATexture),t.setParameter("splatTransform",n.transformTexture),t.setParameter("transformPalette",n.transformPalette.texture),t.setParameter("texParams",[n.stateTexture.width,n.stateTexture.height]),t.update(),i.node=n.entity})(n)})),this.meshInstance=i}destroy(){this.meshInstance.material.destroy(),this.meshInstance.destroy()}onPreRender(){const e=this.scene.events,t=e.invoke("camera.splatSize");if(this.meshInstance.node&&this.scene.camera.renderOverlays&&t>0&&e.invoke("camera.overlay")&&"centers"===e.invoke("camera.mode")){const s=e.invoke("selectedClr"),i=e.invoke("unselectedClr");this.meshInstance.material.setParameter("splatSize",t*window.devicePixelRatio),this.meshInstance.material.setParameter("selectedClr",[s.r,s.g,s.b,s.a]),this.meshInstance.material.setParameter("unselectedClr",[i.r,i.g,i.b,i.a]),this.scene.app.drawMeshInstance(this.meshInstance)}}}class KS extends Cw{entity;shader;quadRender;enabled=!0;constructor(){super(xw.other),this.entity=new Ep("underlayCamera"),this.entity.addComponent("camera"),this.entity.camera.setShaderPass("UNDERLAY"),this.entity.camera.clearColor=new mt(0,0,0,0)}add(){const e=this.scene.app.graphicsDevice;this.entity.camera.layers=[this.scene.overlayLayer.id],this.scene.camera.entity.addChild(this.entity),this.shader=Po(e,"\n    attribute vec2 vertex_position;\n    void main(void) {\n        gl_Position = vec4(vertex_position, 0.0, 1.0);\n    }\n","\n    uniform sampler2D blitTexture;\n    void main(void) {\n        ivec2 texel = ivec2(gl_FragCoord.xy);\n\n        gl_FragColor = texelFetch(blitTexture, texel, 0);\n    }\n","apply-underlay",{vertex_position:ms}),this.quadRender=new Lo(this.shader);const t=e.scope.resolve("blitTexture"),s=new Vi(!0,0,1,1,0,0,1);this.entity.camera.on("postRenderLayer",((i,n)=>{if(!this.entity.enabled||i!==this.scene.overlayLayer||!n)return;e.setBlendState(s),t.setValue(this.entity.camera.renderTarget.colorBuffer);const a=e;a.setRenderTarget(this.scene.camera.entity.camera.renderTarget),a.updateBegin(),this.quadRender.render(),a.updateEnd()}))}remove(){this.scene.camera.entity.removeChild(this.entity)}onPreRender(){const e=this.scene.camera.entity.camera,t=this.entity.camera;t.projection=e.projection,t.horizontalFov=e.horizontalFov,t.fov=e.fov,t.nearClip=e.nearClip,t.farClip=e.farClip,t.orthoHeight=e.orthoHeight,this.entity.enabled=this.enabled&&!this.scene.events.invoke("view.outlineSelection"),this.entity.camera.renderTarget=this.scene.camera.workRenderTarget}}class ZS{events;config;canvas;app;backgroundLayer;shadowLayer;debugLayer;overlayLayer;gizmoLayer;sceneState=[new YS,new YS];elements=[];boundStorage=new Ft;boundDirty=!0;forceRender=!1;lockedRenderMode=!1;lockedRender=!1;canvasResize=null;targetSize={width:0,height:0};dataProcessor;assetLoader;camera;splatOverlay;grid;outline;underlay;contentRoot;cameraRoot;constructor(e,t,s,i){this.events=e,this.config=t,this.canvas=s,this.app=new jS(s,{graphicsDevice:i}),this.app.autoRender=!1,this.app._allowResize=!1,this.app.scene.clusteredLightingEnabled=!1,this.app.off("prerender",this.app._firstBake,this.app),this.app.loader.getHandler("texture").imgParser.crossOrigin="anonymous",this.app.graphicsDevice.maxPixelRatio=window.devicePixelRatio;new ResizeObserver((e=>{if(e.length>0){const t=e[0];if(t)if(t.devicePixelContentBoxSize)this.canvasResize={width:t.devicePixelContentBoxSize[0].inlineSize,height:t.devicePixelContentBoxSize[0].blockSize};else if(t.contentBoxSize.length>0){const e=window.devicePixelRatio;this.canvasResize={width:Math.ceil(t.contentBoxSize[0].inlineSize*e),height:Math.ceil(t.contentBoxSize[0].blockSize*e)}}this.forceRender=!0}})).observe(window.document.getElementById("canvas-container"));const n=this.app.scene.layers.getLayerById(1);this.app.scene.layers.remove(n),this.app.scene.layers.insertOpaque(n,2),this.app.on("update",(e=>this.onUpdate(e))),this.app.on("prerender",(()=>this.onPreRender())),this.app.on("postrender",(()=>this.onPostRender())),this.app.graphicsDevice.on("devicerestored",(()=>{this.forceRender=!0})),this.app.scene.on(mo,((e,t,s)=>{e.fire("preRenderLayer",t,s)})),this.app.scene.on(fo,((e,t,s)=>{e.fire("postRenderLayer",t,s)})),this.backgroundLayer=new bc({enabled:!0,name:"Background Layer",opaqueSortMode:0,transparentSortMode:0}),this.shadowLayer=new bc({name:"Shadow Layer"}),this.debugLayer=new bc({enabled:!0,name:"Debug Layer",opaqueSortMode:0,transparentSortMode:0}),this.overlayLayer=new bc({name:"Overlay",clearDepthBuffer:!1,opaqueSortMode:0,transparentSortMode:0}),this.gizmoLayer=new bc({name:"Gizmo",clearDepthBuffer:!0,opaqueSortMode:0,transparentSortMode:0});const a=this.app.scene.layers,r=a.getLayerByName("World"),o=a.getOpaqueIndex(r);a.insert(this.backgroundLayer,o),a.insert(this.shadowLayer,o+1),a.insert(this.debugLayer,o+1),a.push(this.overlayLayer),a.push(this.gizmoLayer),this.dataProcessor=new HS(this.app.graphicsDevice),this.assetLoader=new bS(i,this.app.assets,e,this.app.graphicsDevice.maxAnisotropy),this.contentRoot=new Ep("contentRoot"),this.app.root.addChild(this.contentRoot),this.cameraRoot=new Ep("cameraRoot"),this.app.root.addChild(this.cameraRoot),this.camera=new zS,this.add(this.camera),this.splatOverlay=new $S,this.add(this.splatOverlay),this.grid=new GS,this.add(this.grid),this.outline=new WS,this.add(this.outline),this.underlay=new KS,this.add(this.underlay)}start(){this.app.start()}clear(){this.getElementsByType(xw.splat).forEach((e=>{this.remove(e),e.destroy()}))}add(e){e.scene||(e.scene=this,e.add(),this.elements.push(e),this.forEachElement((t=>t!==e&&t.onAdded(e))),this.events.fire("scene.elementAdded",e))}remove(e){e.scene===this&&(this.elements.splice(this.elements.indexOf(e),1),this.events.fire("scene.elementRemoved",e),this.forEachElement((t=>t.onRemoved(e))),e.remove(),e.scene=null)}get bound(){if(this.boundDirty){let e=!1;this.forEachElement((t=>{const s=t.worldBound;s&&(e?this.boundStorage.add(s):(e=!0,this.boundStorage.copy(s)))})),this.boundDirty=!1,this.events.fire("scene.boundChanged",this.boundStorage)}return this.boundStorage}getElementsByType(e){return this.elements.filter((t=>t.type===e))}get graphicsDevice(){return this.app.graphicsDevice}forEachElement(e){this.elements.forEach(e)}onUpdate(e){this.forEachElement((t=>t.onUpdate(e))),this.events.fire("update",e);const t=this.app.frame%2,s=this.sceneState[t];s.reset(),this.forEachElement((e=>s.pack(e)));const i=s.compare(this.sceneState[1-t]),n=new Set([...i.added,...i.removed,...i.moved,...i.changed]);this.lockedRenderMode?(this.app.renderNextFrame=this.lockedRender,this.lockedRender=!1):this.app.renderNextFrame||(this.app.renderNextFrame=this.forceRender||n.size>0),this.forceRender=!1,ww.forEach((e=>{n.has(e)&&this.events.fire(`updated:${e}`)})),this.forEachElement((e=>e.onPostUpdate()))}onPreRender(){this.canvasResize&&(this.canvas.width=this.canvasResize.width,this.canvas.height=this.canvasResize.height,this.canvasResize=null),this.targetSize.width=Math.ceil(this.app.graphicsDevice.width/this.config.camera.pixelScale),this.targetSize.height=Math.ceil(this.app.graphicsDevice.height/this.config.camera.pixelScale),this.forEachElement((e=>e.onPreRender())),this.events.fire("prerender",this.camera.entity.getWorldTransform()),this.config.debug.showBound&&(this.forEachElement((e=>{if(e.type===xw.splat){const t=e,s=t.localBound;this.app.drawWireAlignedBox(s.getMin(),s.getMax(),mt.RED,!0,void 0,t.entity.getWorldTransform());const i=t.worldBound;this.app.drawWireAlignedBox(i.getMin(),i.getMax(),mt.GREEN)}})),this.app.drawWireAlignedBox(this.bound.getMin(),this.bound.getMax(),mt.BLUE))}onPostRender(){this.forEachElement((e=>e.onPostRender())),this.events.fire("postrender")}}const JS={bgClr:{r:.4,g:.4,b:.4,a:1},selectedClr:{r:1,g:1,b:0,a:1},unselectedClr:{r:0,g:0,b:1,a:.5},lockedClr:{r:0,g:0,b:0,a:.05},camera:{pixelScale:1,multisample:!1,fov:50,exposure:1,toneMapping:"linear",debugRender:"",overlay:!0},show:{grid:!0,bound:!0,shBands:3},controls:{dampingFactor:.2,minPolarAngle:0,maxPolarAngle:Math.PI,minZoom:1e-6,maxZoom:10,initialAzim:-45,initialElev:-10,initialZoom:1,orbitSensitivity:.3,zoomSensitivity:.4},debug:{showBound:!1}};class QS{sources;constructor(e){this.sources=e}resolve(e,t){const s=e=>{for(const s of t){if(!e.hasOwnProperty(s))return;e=e[s]}return e};for(const t of e){const e=s(t);if(void 0!==e)return e}}get(e){return this.resolve(this.sources,e.split(".").map((e=>e.replace(/[A-Z]+(?![a-z])|[A-Z]/g,((e,t)=>(t?"-":"")+e.toLowerCase())))))??this.resolve(this.sources,e.split("."))}getBool(e){const t=this.get(e);return"string"==typeof t?"true"===t.toLowerCase():void 0===t?void 0:!!t}getNumber(e){const t=this.get(e);return"string"==typeof t?parseFloat(t):t}getVec(e){const t=this.get(e);return"string"==typeof t?t.split(","):void 0}getVec3(e){const t=this.getVec(e);if(t){const e=t.map((e=>parseFloat(e)));if(1===t.length)return{x:e[0],y:e[0],z:e[0]};if(3===t.length)return{x:e[0],y:e[1],z:e[2]}}}getColor(e){const t=this.getVec(e);if(t){const e=t.map((e=>parseFloat(e)));if(1===t.length)return{r:e[0],g:e[0],b:e[0],a:1};if(3===t.length)return{r:e[0],g:e[1],b:e[2],a:1};if(4===t.length)return{r:e[0],g:e[1],b:e[2],a:e[3]}}}}const eA=e=>{const t=new QS(e),s=(e,t)=>e.length===t.length&&e.every(((e,s)=>e===t[s])),i=(e,n)=>{for(const a in e){const r=`${n}${n.length?".":""}${a}`,o=e[a];switch(typeof o){case"number":e[a]=t.getNumber(r)??o;break;case"boolean":e[a]=t.getBool(r)??o;break;case"string":e[a]=t.get(r)??o;break;case"object":{const n=Object.keys(o).sort();s(n,["a","b","g","r"])?e[a]=t.getColor(r)??o:s(n,["x","y","z"])?e[a]=t.getVec3(r)??o:i(o,r);break}default:i(o,r)}}};return i(JS,""),JS};class tA{shortcuts=[];constructor(e){const t=this.shortcuts,s=(s,i,n)=>{if(n||s.target===document.body)for(let a=0;a<t.length;a++){const r=t[a],o=r.options;if(r.keys.includes(s.key)&&(o.capture??!1)===n&&!!o.ctrl==!(!s.ctrlKey&&!s.metaKey)&&!!o.shift==!!s.shiftKey){if(s.stopPropagation(),s.preventDefault(),o.sticky){if(i&&(r.toggled=s.repeat),i===r.toggled)return}else if(!i)return;t[a].options.event?e.fire(t[a].options.event):t[a].options.func();break}}};document.addEventListener("keydown",(e=>{s(e,!0,!1)})),document.addEventListener("keyup",(e=>{s(e,!1,!1)})),document.addEventListener("keydown",(e=>{s(e,!0,!0)}),!0),document.addEventListener("keyup",(e=>{s(e,!1,!0)}),!0)}register(e,t){this.shortcuts.push({keys:e,options:t,toggled:!1})}}const sA=e=>{let t=180;e.function("timeline.frames",(()=>t)),e.on("timeline.setFrames",(s=>{(s=>{s!==t&&(t=s,e.fire("timeline.frames",t))})(s)}));let s=30;e.function("timeline.frameRate",(()=>s)),e.on("timeline.setFrameRate",(t=>{(t=>{t!==s&&(s=t,e.fire("timeline.frameRate",s))})(t)}));let i=0;const n=t=>{t!==i&&(i=t,e.fire("timeline.frame",i))};e.function("timeline.frame",(()=>i)),e.on("timeline.setFrame",(e=>{n(e)}));let a=null;let r=!1;const o=o=>{o!==r&&(r=o,e.fire("timeline.playing",r),r?(()=>{let r=i;a=e.on("update",(i=>{r=(r+i*s)%t,n(Math.floor(r)),e.fire("timeline.time",r)}))})():(a.off(),a=null))};e.function("timeline.playing",(()=>r)),e.on("timeline.setPlaying",(e=>{o(e)}));const l=[];e.function("timeline.keys",(()=>l)),e.on("timeline.addKey",(t=>{l.push(t),e.fire("timeline.keyAdded",t)})),e.on("timeline.removeKey",(t=>{l.splice(t,1),e.fire("timeline.keyRemoved",t)})),e.on("timeline.setKey",((t,s)=>{s!==l[t]&&(l[t]=s,e.fire("timeline.keySet",t,s))})),e.function("docSerialize.timeline",(()=>({frames:t,frameRate:s,frame:i}))),e.function("docDeserialize.timeline",((t={})=>{e.fire("timeline.setFrames",t.frames??180),e.fire("timeline.setFrameRate",t.frameRate??30),e.fire("timeline.setFrame",t.frame??0)}))};class iA{activate;deactivate;constructor(e,t,s){let i=40;const n=document.createElementNS("http://www.w3.org/2000/svg","svg");n.id="brush-select-svg",n.classList.add("select-svg");const a=document.createElementNS(n.namespaceURI,"circle");a.setAttribute("r",i.toString()),a.setAttribute("fill","rgba(255, 102, 0, 0.2)"),a.setAttribute("stroke","#f60"),a.setAttribute("stroke-width","1"),a.setAttribute("stroke-dasharray","5, 5");const{canvas:r,context:o}=s,l={x:0,y:0};let h;const c=e=>{const t=e.offsetX,s=e.offsetY;a.setAttribute("cx",t.toString()),a.setAttribute("cy",s.toString()),void 0!==h&&(o.beginPath(),o.strokeStyle="#f60",o.lineCap="round",o.lineWidth=2*i,o.moveTo(l.x,l.y),o.lineTo(t,s),o.stroke(),l.x=t,l.y=s)},d=e=>{void 0===h&&("mouse"===e.pointerType?0===e.button:e.isPrimary)&&(e.preventDefault(),e.stopPropagation(),h=e.pointerId,t.setPointerCapture(h),r.width===t.clientWidth&&r.height===t.clientHeight||(r.width=t.clientWidth,r.height=t.clientHeight),o.clearRect(0,0,r.width,r.height),r.style.display="inline",l.x=e.offsetX,l.y=e.offsetY,c(e))},u=e=>{void 0!==h&&(e.preventDefault(),e.stopPropagation()),c(e)},p=()=>{t.releasePointerCapture(h),h=void 0,r.style.display="none"},m=t=>{t.pointerId===h&&(t.preventDefault(),t.stopPropagation(),p(),e.fire("select.byMask",t.shiftKey?"add":t.ctrlKey?"remove":"set",r,o))},f=t=>{if(t.altKey||t.metaKey){const{deltaX:s,deltaY:i}=t;e.fire((Math.abs(s)>Math.abs(i)?s:i)>0?"tool.brushSelection.smaller":"tool.brushSelection.bigger"),t.preventDefault(),t.stopPropagation()}};this.activate=()=>{n.style.display="inline",t.style.display="block",t.addEventListener("pointerdown",d),t.addEventListener("pointermove",u),t.addEventListener("pointerup",m),t.addEventListener("wheel",f)},this.deactivate=()=>{void 0!==h&&p(),n.style.display="none",t.style.display="none",t.removeEventListener("pointerdown",d),t.removeEventListener("pointermove",u),t.removeEventListener("pointerup",m),t.removeEventListener("wheel",f)},e.on("tool.brushSelection.smaller",(()=>{i=Math.max(1,i/1.05),a.setAttribute("r",i.toString())})),e.on("tool.brushSelection.bigger",(()=>{i=Math.min(500,1.05*i),a.setAttribute("r",i.toString())})),n.appendChild(a),t.appendChild(n)}}class nA{activate;deactivate;constructor(e,t,s){let i=[],n=null,a=0;const r=document.createElementNS("http://www.w3.org/2000/svg","svg");r.id="lasso-select-svg",r.classList.add("select-svg");const o=document.createElementNS(r.namespaceURI,"polygon");o.setAttribute("fill","none"),o.setAttribute("stroke-width","1"),o.setAttribute("stroke-dasharray","5, 5"),o.setAttribute("stroke-dashoffset","0");const{canvas:l,context:h}=s,c=(e,t)=>Math.sqrt((e.x-t.x)**2+(e.y-t.y)**2),d=()=>{o.setAttribute("points",[...i,n].reduce(((e,t)=>`${e}${t.x}, ${t.y} `),"")),o.setAttribute("stroke",i.length>1&&c(n,i[0])<8?"#fa6":"#f60")};let u;const p=e=>{n={x:e.offsetX,y:e.offsetY};const t=0===i.length?0:c(n,i[i.length-1]),s=Date.now()-a,r=t>20,o=s>500&&t>2,l=s>200&&t>10,h=0===i.length;void 0!==u&&(r||o||l||h)&&(i.push(n),a=Date.now()),d()},m=e=>{void 0===u&&("mouse"===e.pointerType?0===e.button:e.isPrimary)&&(e.preventDefault(),e.stopPropagation(),u=e.pointerId,t.setPointerCapture(u),p(e))},f=e=>{void 0!==u&&(e.preventDefault(),e.stopPropagation()),p(e)},g=()=>{t.releasePointerCapture(u),u=void 0},v=s=>{s.pointerId===u&&(s.preventDefault(),s.stopPropagation(),g(),(s=>{l.width===t.clientWidth&&l.height===t.clientHeight||(l.width=t.clientWidth,l.height=t.clientHeight),h.clearRect(0,0,l.width,l.height),h.beginPath(),h.fillStyle="#f60",h.beginPath(),i.forEach(((e,t)=>{0===t?h.moveTo(e.x,e.y):h.lineTo(e.x,e.y)})),h.closePath(),h.fill(),e.fire("select.byMask",s.shiftKey?"add":s.ctrlKey?"remove":"set",l,h)})(s),i=[],d())};this.activate=()=>{r.style.display="inline",t.style.display="block",t.addEventListener("pointerdown",m),t.addEventListener("pointermove",f),t.addEventListener("pointerup",v)},this.deactivate=()=>{void 0!==u&&g(),r.style.display="none",t.style.display="none",t.removeEventListener("pointerdown",m),t.removeEventListener("pointermove",f),t.removeEventListener("pointerup",v)},r.appendChild(o),t.appendChild(r)}}class aA{activate;deactivate;constructor(e,t,s){let i,n=!1,a=!1;const r=new Ep("gizmoPivot");s.app.root.addChild(r),e.on("render:update",(()=>{s.forceRender=!0})),e.on("transform:start",(()=>{a=!0,i.start()})),e.on("transform:move",(()=>{i.moveTRS(r.getLocalPosition(),r.getLocalRotation(),r.getLocalScale())})),e.on("transform:end",(()=>{i.end(),a=!1}));const o=()=>{n&&t.invoke("selection")?a||(i=t.invoke("pivot"),r.setLocalPosition(i.transform.position),r.setLocalRotation(i.transform.rotation),r.setLocalScale(i.transform.scale),e.attach([r])):e.detach()};t.on("tool.coordSpace",(t=>{e.coordSpace=t,s.forceRender=!0})),t.on("pivot.placed",o),t.on("pivot.moved",o),t.on("selection.changed",o);const l=()=>{const{camera:t,canvas:i}=s;t.ortho?e.size=1125/i.clientHeight:e.size=1200/Math.max(i.clientWidth,i.clientHeight)};l(),t.on("camera.resize",l),t.on("camera.ortho",l),this.activate=()=>{n=!0,o()},this.deactivate=()=>{n=!1,o()},e.coordSpace=t.invoke("tool.coordSpace")}}class rA extends aA{constructor(e,t){super(new u_(t.camera.entity.camera,t.gizmoLayer),e,t)}}class oA{activate;deactivate;constructor(e,t,s){let i=[],n=null;const a=document.createElementNS("http://www.w3.org/2000/svg","svg");a.id="polygon-select-svg",a.classList.add("select-svg");const r=document.createElementNS(a.namespaceURI,"polyline");r.setAttribute("fill","none"),r.setAttribute("stroke-width","1"),r.setAttribute("stroke-dasharray","5, 5"),r.setAttribute("stroke-dashoffset","0");const{canvas:o,context:l}=s,h=(e,t)=>Math.sqrt((e.x-t.x)**2+(e.y-t.y)**2),c=()=>i.length>1&&h(n,i[0])<8,d=()=>{r.setAttribute("points",[...i,n].filter((e=>e)).reduce(((e,t)=>`${e}${t.x}, ${t.y} `),"")),r.setAttribute("stroke",c()?"#fa6":"#f60")},u=s=>{o.width===t.clientWidth&&o.height===t.clientHeight||(o.width=t.clientWidth,o.height=t.clientHeight),l.clearRect(0,0,o.width,o.height),l.beginPath(),l.fillStyle="#f60",l.beginPath(),i.forEach(((e,t)=>{0===t?l.moveTo(e.x,e.y):l.lineTo(e.x,e.y)})),l.closePath(),l.fill(),e.fire("select.byMask",s.shiftKey?"add":s.ctrlKey?"remove":"set",o,l),i=[],d()},p=e=>{n={x:e.offsetX,y:e.offsetY},i.length>0&&d()},m=e=>{(i.length>0||("mouse"===e.pointerType?0===e.button:e.isPrimary))&&(e.preventDefault(),e.stopPropagation())},f=e=>{("mouse"===e.pointerType?0===e.button:e.isPrimary)&&(e.preventDefault(),e.stopPropagation(),c()?u(e):(0===i.length||h(i[i.length-1],n)>0)&&i.push(n))},g=e=>{e.preventDefault(),e.stopPropagation(),i.length>2&&u(e)};this.activate=()=>{a.style.display="inline",t.style.display="block",t.addEventListener("pointerdown",m),t.addEventListener("pointermove",p),t.addEventListener("pointerup",f),t.addEventListener("dblclick",g)},this.deactivate=()=>{a.style.display="none",t.style.display="none",t.removeEventListener("pointerdown",m),t.removeEventListener("pointermove",p),t.removeEventListener("pointerup",f),t.removeEventListener("dblclick",g),i=[],d()},a.appendChild(r),t.appendChild(a)}}class lA{activate;deactivate;constructor(e,t){const s=document.createElementNS("http://www.w3.org/2000/svg","svg");s.id="rect-select-svg",s.classList.add("select-svg");const i=document.createElementNS(s.namespaceURI,"rect");i.setAttribute("fill","none"),i.setAttribute("stroke","#f60"),i.setAttribute("stroke-width","1"),i.setAttribute("stroke-dasharray","5, 5");const n={x:0,y:0},a={x:0,y:0};let r,o=!1;const l=()=>{const e=Math.min(n.x,a.x),t=Math.min(n.y,a.y),s=Math.abs(n.x-a.x),r=Math.abs(n.y-a.y);i.setAttribute("x",e.toString()),i.setAttribute("y",t.toString()),i.setAttribute("width",s.toString()),i.setAttribute("height",r.toString())},h=e=>{void 0===r&&("mouse"===e.pointerType?0===e.button:e.isPrimary)&&(e.preventDefault(),e.stopPropagation(),r=e.pointerId,o=!1,t.setPointerCapture(r),n.x=a.x=e.offsetX,n.y=a.y=e.offsetY,l(),s.style.display="inline")},c=e=>{e.pointerId===r&&(e.preventDefault(),e.stopPropagation(),o=!0,a.x=e.offsetX,a.y=e.offsetY,l())},d=()=>{t.releasePointerCapture(r),r=void 0,s.style.display="none"},u=s=>{if(s.pointerId===r){s.preventDefault(),s.stopPropagation();const i=t.clientWidth,r=t.clientHeight;d(),o?e.fire("select.rect",s.shiftKey?"add":s.ctrlKey?"remove":"set",{start:{x:Math.min(n.x,a.x)/i,y:Math.min(n.y,a.y)/r},end:{x:Math.max(n.x,a.x)/i,y:Math.max(n.y,a.y)/r}}):e.fire("select.point",s.shiftKey?"add":s.ctrlKey?"remove":"set",{x:s.offsetX/t.clientWidth,y:s.offsetY/t.clientHeight})}};this.activate=()=>{t.style.display="block",t.addEventListener("pointerdown",h),t.addEventListener("pointermove",c),t.addEventListener("pointerup",u)},this.deactivate=()=>{void 0!==r&&d(),t.style.display="none",t.removeEventListener("pointerdown",h),t.removeEventListener("pointermove",c),t.removeEventListener("pointerup",u)},t.appendChild(s),s.appendChild(i)}destroy(){}}class hA extends aA{constructor(e,t){super(new b_(t.camera.entity.camera,t.gizmoLayer),e,t)}}class cA extends aA{constructor(e,t){const s=new R_(t.camera.entity.camera,t.gizmoLayer);["x","y","z","yz","xz","xy"].forEach((e=>{s.enableShape(e,!1)})),super(s,e,t)}}const dA=new yt,uA=new Ft;class pA extends Cw{_radius=1;pivot;material;constructor(){super(xw.debug),this.pivot=new Ep("spherePivot"),this.pivot.addComponent("render",{type:"box"});const e=2*this._radius;this.pivot.setLocalScale(e,e,e)}add(){const e=new Wc({uniqueName:"sphereShape",vertexCode:"\n    attribute vec3 vertex_position;\n\n    uniform mat4 matrix_model;\n    uniform mat4 matrix_viewProjection;\n\n    void main() {\n        gl_Position = matrix_viewProjection * matrix_model * vec4(vertex_position, 1.0);\n    }\n",fragmentCode:"\n    bool intersectSphere(out float t0, out float t1, vec3 pos, vec3 dir, vec4 sphere) {\n        vec3 L = sphere.xyz - pos;\n        float tca = dot(L, dir);\n\n        float d2 = sphere.w * sphere.w - (dot(L, L) - tca * tca);\n        if (d2 <= 0.0) {\n            return false;\n        }\n\n        float thc = sqrt(d2);\n        t0 = tca - thc;\n        t1 = tca + thc;\n        if (t1 <= 0.0) {\n            return false;\n        }\n\n        return true;\n    }\n\n    float calcDepth(in vec3 pos, in mat4 viewProjection) {\n        vec4 v = viewProjection * vec4(pos, 1.0);\n        return (v.z / v.w) * 0.5 + 0.5;\n    }\n\n    vec2 calcAzimuthElev(in vec3 dir) {\n        float azimuth = atan(dir.z, dir.x);\n        float elev = asin(dir.y);\n        return vec2(azimuth, elev) * 180.0 / 3.14159;\n    }\n\n    uniform sampler2D blueNoiseTex32;\n    uniform mat4 matrix_viewProjection;\n    uniform vec4 sphere;\n\n    uniform vec3 near_origin;\n    uniform vec3 near_x;\n    uniform vec3 near_y;\n\n    uniform vec3 far_origin;\n    uniform vec3 far_x;\n    uniform vec3 far_y;\n\n    uniform vec2 targetSize;\n\n    bool writeDepth(float alpha) {\n        vec2 uv = fract(gl_FragCoord.xy / 32.0);\n        float noise = texture2DLod(blueNoiseTex32, uv, 0.0).y;\n        return alpha > noise;\n    }\n\n    bool strips(vec3 lp) {\n        vec2 ae = calcAzimuthElev(normalize(lp));\n\n        float spacing = 180.0 / (2.0 * 3.14159 * sphere.w);\n        float size = 0.03;\n        return fract(ae.x / spacing) < size ||\n               fract(ae.y / spacing) < size;\n    }\n\n    void main() {\n        vec2 clip = gl_FragCoord.xy / targetSize;\n        vec3 worldNear = near_origin + near_x * clip.x + near_y * clip.y;\n        vec3 worldFar = far_origin + far_x * clip.x + far_y * clip.y;\n\n        vec3 rayDir = normalize(worldFar - worldNear);\n\n        float t0, t1;\n        if (!intersectSphere(t0, t1, worldNear, rayDir, sphere)) {\n            discard;\n        }\n\n        vec3 frontPos = worldNear + rayDir * t0;\n        bool front = t0 > 0.0 && strips(frontPos - sphere.xyz);\n\n        vec3 backPos = worldNear + rayDir * t1;\n        bool back = strips(backPos - sphere.xyz);\n\n        if (front) {\n            gl_FragColor = vec4(1.0, 1.0, 1.0, 0.6);\n            gl_FragDepth = writeDepth(0.6) ? calcDepth(frontPos, matrix_viewProjection) : 1.0;\n        } else if (back) {\n            gl_FragColor = vec4(0.0, 0.0, 0.0, 0.6);\n            gl_FragDepth = writeDepth(0.6) ? calcDepth(backPos, matrix_viewProjection) : 1.0;\n        } else {\n            discard;\n        }\n    }\n"});e.cull=2,e.blendState=new Vi(!0,0,6,8,0,1,8),e.update(),this.pivot.render.meshInstances[0].material=e,this.pivot.render.layers=[this.scene.debugLayer.id],this.material=e,this.scene.contentRoot.addChild(this.pivot),this.updateBound()}remove(){this.scene.contentRoot.removeChild(this.pivot),this.scene.boundDirty=!0}destroy(){}serialize(e){e.packa(this.pivot.getWorldTransform().data),e.pack(this.radius)}onPreRender(){this.pivot.getWorldTransform().getTranslation(dA),this.material.setParameter("sphere",[dA.x,dA.y,dA.z,this.radius]);const e=this.scene.graphicsDevice;e.scope.resolve("targetSize").setValue([e.width,e.height])}moved(){this.updateBound()}updateBound(){uA.center.copy(this.pivot.getPosition()),uA.halfExtents.set(this.radius,this.radius,this.radius),this.scene.boundDirty=!0}get worldBound(){return uA}set radius(e){this._radius=e;const t=2*this._radius;this.pivot.setLocalScale(t,t,t),this.updateBound()}get radius(){return this._radius}}class mA{activate;deactivate;active=!1;constructor(e,t,s){const i=new pA,n=new u_(t.camera.entity.camera,t.gizmoLayer);n.on("render:update",(()=>{t.forceRender=!0})),n.on("transform:move",(()=>{i.moved()}));const a=new P({id:"select-toolbar",hidden:!0});a.dom.addEventListener("pointerdown",(e=>{e.stopPropagation()}));const r=new w({text:"Set",class:"select-toolbar-button"}),o=new w({text:"Add",class:"select-toolbar-button"}),l=new w({text:"Remove",class:"select-toolbar-button"}),h=new L({precision:2,value:i.radius,placeholder:"Radius",width:80,min:.01});a.append(r),a.append(o),a.append(l),a.append(h),s.append(a);const c=t=>{const s=i.pivot.getPosition();e.fire("select.bySphere",t,[s.x,s.y,s.z,i.radius])};r.dom.addEventListener("pointerdown",(e=>{e.stopPropagation(),c("set")})),o.dom.addEventListener("pointerdown",(e=>{e.stopPropagation(),c("add")})),l.dom.addEventListener("pointerdown",(e=>{e.stopPropagation(),c("remove")})),h.on("change",(()=>{i.radius=h.value})),e.on("camera.focalPointPicked",(e=>{this.active&&(i.pivot.setPosition(e.position),n.attach([i.pivot]))}));const d=()=>{const{camera:e,canvas:s}=t;e.ortho?n.size=1125/s.clientHeight:n.size=1200/Math.max(s.clientWidth,s.clientHeight)};d(),e.on("camera.resize",d),e.on("camera.ortho",d),this.activate=()=>{this.active=!0,t.add(i),n.attach([i.pivot]),a.hidden=!1},this.deactivate=()=>{a.hidden=!0,n.detach(),t.remove(i),this.active=!1}}}class fA{tools=new Map;events;active=null;constructor(e){this.events=e,this.events.on("tool.deactivate",(()=>{this.activate(null)})),this.events.function("tool.active",(()=>this.active));let t="world";const s=s=>{s!==t&&(t=s,e.fire("tool.coordSpace",t))};e.function("tool.coordSpace",(()=>t)),e.on("tool.setCoordSpace",(e=>{s(e)})),e.on("tool.toggleCoordSpace",(()=>{s("local"===t?"world":"local")}))}register(e,t){this.tools.set(e,t),this.events.on(`tool.${e}`,(()=>{this.activate(e)}))}get(e){return(e&&this.tools.get(e))??null}activate(e){if(e===this.active)e&&this.activate(null);else{if(this.active){this.tools.get(this.active).deactivate(),this.events.fire(`tool.${this.active}.deactivated`),this.events.fire("tool.deactivated",this.active)}if(this.active=e,this.active){this.tools.get(this.active).activate()}this.events.fire(`tool.${e}.activated`),this.events.fire("tool.activated",e)}}}let gA=class e{position=new yt;rotation=new kt;scale=new yt(1,1,1);constructor(e,t,s){this.set(e,t,s)}set(e,t,s){e&&this.position.copy(e),t&&this.rotation.copy(t),s&&this.scale.copy(s)}copy(e){this.position.copy(e.position),this.rotation.copy(e.rotation),this.scale.copy(e.scale)}clone(){return new e(this.position.clone(),this.rotation.clone(),this.scale.clone())}equals(e){return this.position.equals(e.position)&&this.rotation.equals(e.rotation)&&this.scale.equals(e.scale)}equalsApprox(e,t=1e-6){return this.position.equalsApprox(e.position,t)&&this.rotation.equalsApprox(e.rotation,t)&&this.scale.equalsApprox(e.scale,t)}equalsTRS(e,t,s){return this.position.equals(e)&&this.rotation.equals(t)&&this.scale.equals(s)}equalsApproxTRS(e,t,s,i=1e-6){return this.position.equalsApprox(e,i)&&this.rotation.equalsApprox(t,i)&&this.scale.equalsApprox(s,i)}};const vA=new Et,_A=new kt,yA=new gA;class xA{events;splat;top;pop;bindMat=new Et;constructor(e){this.events=e,e.on("pivot.started",(e=>{this.splat&&this.start()})),e.on("pivot.moved",(e=>{this.splat&&this.update(e.transform)})),e.on("pivot.ended",(e=>{this.splat&&this.end()})),e.on("pivot.origin",(e=>{this.splat&&this.placePivot()})),e.on("camera.focalPointPicked",(t=>{if(this.splat&&["move","rotate","scale"].includes(this.events.invoke("tool.active"))){const s=e.invoke("pivot"),i=new gA(t.position,s.transform.rotation,s.transform.scale),n=new dw({pivot:s,oldt:s.transform.clone(),newt:i});e.fire("edit.add",n)}}))}placePivot(){const e=this.events.invoke("pivot.origin");this.splat.getPivot("center"===e?"center":"boundCenter",!1,yA),this.events.fire("pivot.place",yA)}activate(){this.splat=this.events.invoke("selection"),this.splat&&this.placePivot()}deactivate(){this.splat=null}start(){const e=this.events.invoke("pivot"),{transform:t}=e,{entity:s}=this.splat;this.bindMat.setTRS(t.position,t.rotation,t.scale),this.bindMat.invert(),this.bindMat.mul2(this.bindMat,s.getLocalTransform());const i=s.getLocalPosition(),n=s.getLocalRotation(),a=s.getLocalScale();this.top=new lw({splat:this.splat,oldt:new gA(i,n,a),newt:new gA(i,n,a)}),this.pop=new dw({pivot:e,oldt:t.clone(),newt:t.clone()})}update(e){vA.setTRS(e.position,e.rotation,e.scale),vA.mul2(vA,this.bindMat),_A.setFromMat4(vA);const t=vA.getTranslation(),s=_A,i=vA.getScale();this.splat.move(t,s,i),this.top.newt.set(t,s,i),this.pop.newt.copy(e)}end(){const{oldt:e,newt:t}=this.top;e.equals(t)||this.events.fire("edit.add",new pw([this.top,this.pop])),this.top=null,this.pop=null}}class wA{transform=new gA;place;start;move;moveTRS;end;constructor(e){this.place=t=>{this.transform.equals(t)||(this.transform.copy(t),e.fire("pivot.placed",this))},this.start=()=>{e.fire("pivot.started",this)},this.move=t=>{this.transform.equals(t)||(this.transform.copy(t),e.fire("pivot.moved",this))},this.moveTRS=(t,s,i)=>{this.transform.equalsTRS(t,s,i)||(this.transform.set(t,s,i),e.fire("pivot.moved",this))},this.end=()=>{e.fire("pivot.ended",this)},e.on("pivot.place",this.place),e.on("pivot.start",this.start),e.on("pivot.moveTRS",this.moveTRS),e.on("pivot.end",this.end)}}const bA=new Et,CA=new Et,SA=new gA;class AA{events;splat;pivotStart=new gA;localToPivot=new Et;worldToLocal=new Et;transform=new Et;paletteMap=new Map;constructor(e){this.events=e,e.on("pivot.started",(e=>{this.splat&&this.start()})),e.on("pivot.moved",(e=>{this.splat&&this.update(e.transform)})),e.on("pivot.ended",(e=>{this.splat&&this.end()})),e.on("selection.changed",(e=>{this.splat&&e===this.splat&&this.placePivot()})),e.on("pivot.origin",(e=>{this.splat&&this.placePivot()})),e.on("camera.focalPointPicked",(t=>{if(this.splat&&["move","rotate","scale"].includes(this.events.invoke("tool.active"))){const s=e.invoke("pivot"),i=s.transform.clone(),n=new gA(t.position,s.transform.rotation,s.transform.scale),a=new dw({pivot:s,oldt:i,newt:n});e.fire("edit.add",a)}}))}placePivot(){const e=this.events.invoke("pivot.origin");this.splat.getPivot("center"===e?"center":"boundCenter",!0,SA),this.events.fire("pivot.place",SA)}activate(){this.splat=this.events.invoke("selection"),this.splat&&this.placePivot()}deactivate(){this.splat=null}start(){const e=this.events.invoke("pivot"),{transform:t}=e,{splat:s}=this,{transformPalette:i}=s;bA.setTRS(t.position,t.rotation,t.scale),this.localToPivot.invert(bA),this.localToPivot.mul2(this.localToPivot,s.entity.getLocalTransform()),this.worldToLocal.invert(s.entity.getLocalTransform()),this.pivotStart.copy(t);const n=s.splatData.getProp("state"),a=s.transformTexture.lock(),{paletteMap:r}=this;r.clear();for(let e=0;e<n.length;++e)if(n[e]===_y.selected){const t=a[e];let s;r.has(t)?s=r.get(t):(s=i.alloc(),r.set(t,s)),a[e]=s}s.transformTexture.unlock(),this.paletteMap.forEach(((e,t)=>{i.getTransform(t,bA),i.setTransform(e,bA)})),s.selectionAlpha=0,s.scene.outline.enabled=!1,s.scene.underlay.enabled=!1}update(e){bA.setTRS(e.position,e.rotation,e.scale),bA.mul2(bA,this.localToPivot),bA.mul2(this.worldToLocal,bA),this.transform.copy(bA);const{transformPalette:t}=this.splat;this.paletteMap.forEach(((e,s)=>{t.getTransform(s,CA),CA.mul2(bA,CA),t.setTransform(e,CA)})),this.splat.makeSelectionBoundDirty()}end(){const{splat:e,transform:t,paletteMap:s}=this;e.updatePositions(),e.selectionAlpha=1,e.scene.outline.enabled=!0,e.scene.underlay.enabled=!0;const i=new cw({splat:e,transform:t.clone(),paletteMap:new Map(s)}),n=this.events.invoke("pivot"),a=this.pivotStart.clone(),r=n.transform.clone(),o=new dw({pivot:n,newt:r,oldt:a});this.events.fire("edit.add",new pw([i,o]),!0)}}const TA=e=>{let t=null;const s=e=>{t&&t.deactivate(),t=e,t&&t.activate()},i=new xA(e),n=new AA(e),a=e=>{e?e.numSelected>0?s(n):s(i):s(null)};e.on("selection.changed",a),e.on("splat.stateChanged",a),(e=>{const t=new wA(e);e.function("pivot",(()=>t));let s="boundCenter";const i=t=>{t!==s&&(s=t,e.fire("pivot.origin",s))};e.function("pivot.origin",(()=>s)),e.on("pivot.setOrigin",(e=>{i("center"===e?"center":"boundCenter")})),e.on("pivot.toggleOrigin",(()=>{i("center"===s?"boundCenter":"center")}))})(e)},PA=e=>{const t=e.r,s=e.g,i=e.b,n=Math.max(t,s,i),a=n-Math.min(t,s,i),r=e=>(n-e)/6/a+.5;let o,l;if(0===a)o=l=0;else{l=a/n;const e=r(t),h=r(s),c=r(i);t===n?o=c-h:s===n?o=1/3+e-c:i===n&&(o=2/3+h-e),o<0?o+=1:o>1&&(o-=1)}return{h:o,s:l,v:n}};class EA{bins;numValues;minValue;maxValue;constructor(e){this.bins=[];for(let t=0;t<e;++t)this.bins.push({selected:0,unselected:0})}calc(e,t,s){const i=this.bins;for(let e=0;e<i.length;++e)i[e].selected=i[e].unselected=0;let n,a,r;for(r=0;r<e;r++){const e=t(r);if(void 0!==e&&!isNaN(e)){n=a=e;break}}if(r!==e){for(;r<e;r++){const e=t(r);void 0!==e&&(e<n?n=e:e>a&&(a=e))}for(let r=0;r<e;r++){const e=t(r);if(void 0!==e){const t=n===a?0:(e-n)/(a-n);if(isNaN(t))continue;const o=Math.min(i.length-1,Math.floor(t*i.length));s(r)?i[o].selected++:i[o].unselected++}}this.numValues=i.reduce(((e,t)=>e+t.selected+t.unselected),0),this.minValue=n,this.maxValue=a}}bucketValue(e){return this.minValue+e*this.bucketSize}get bucketSize(){return(this.maxValue-this.minValue)/this.bins.length}valueToBucket(e){const t=this.minValue===this.maxValue?0:(e-this.minValue)/(this.maxValue-this.minValue);return Math.min(this.bins.length-1,Math.floor(t*this.bins.length))}}class kA{canvas;context;histogram;pixelData;events=new gw;constructor(e,t){const s=document.createElement("canvas");s.setAttribute("id","histogram-canvas"),s.width=e,s.height=t,s.style.width="100%",s.style.height="100%";const i=s.getContext("2d");i.globalCompositeOperation="copy",i.fillStyle="black",i.fillRect(0,0,s.width,s.height),this.canvas=s,this.context=i,this.histogram=new EA(e),this.pixelData=i.createImageData(s.width,s.height);let n=!1,a=0,r=0;const o=e=>{const t=this.canvas.getBoundingClientRect(),s=this.histogram.bins.length;return Math.max(0,Math.min(s-1,Math.floor((e-t.left)/t.width*s)))},l=e=>{const t=this.canvas.getBoundingClientRect();return e/this.histogram.bins.length*t.width},h=()=>{const e=this.canvas.getBoundingClientRect(),t=Math.min(a,r),s=Math.max(a,r);this.events.fire("highlight",{x:l(t),y:0,width:(s-t+1)/this.histogram.bins.length*e.width,height:e.height})};this.canvas.addEventListener("pointerdown",(e=>{e.preventDefault(),e.stopPropagation();this.histogram.numValues&&(this.canvas.setPointerCapture(e.pointerId),n=!0,a=r=o(e.clientX),h())})),this.canvas.addEventListener("pointerup",(e=>{if(e.preventDefault(),e.stopPropagation(),n){this.canvas.releasePointerCapture(e.pointerId);const t=e.shiftKey?"add":e.ctrlKey?"remove":"set";this.events.fire("select",t,Math.min(a,r),Math.max(a,r)),n=!1}})),this.canvas.addEventListener("pointermove",(e=>{e.preventDefault(),e.stopPropagation();const t=this.histogram;if(t.numValues){n&&(r=o(e.clientX),h());const s=this.canvas.getBoundingClientRect(),i=Math.max(0,Math.min(1,(e.clientX-s.left)/s.width)),a=Math.min(t.bins.length-1,Math.floor(i*t.bins.length)),l=t.bins[a];this.events.fire("updateOverlay",{x:e.offsetX,y:e.offsetY,value:t.bucketValue(a),size:t.bucketSize,selected:l.selected,unselected:l.unselected,total:t.numValues})}})),this.canvas.addEventListener("pointerenter",(e=>{this.events.fire("showOverlay")})),this.canvas.addEventListener("pointerleave",(e=>{this.events.fire("hideOverlay")}))}update(e){this.histogram.calc(e.count,e.valueFunc,e.selectedFunc);const t=this.canvas,s=this.context,i=this.pixelData,n=new Uint32Array(i.data.buffer),a=e.logScale?e=>Math.log(e+1):e=>e,r=this.histogram.bins.map((e=>({selected:a(e.unselected+e.selected),unselected:a(e.unselected)}))),o=r.reduce(((e,t)=>Math.max(e,t.selected)),0);let l=0;for(let e=0;e<t.height;e++)for(let s=0;s<r.length;s++){const i=r[s],a=o/t.height*(t.height-1-e);if(a>=i.selected)n[l++]=4278190080;else{const e=a+o/t.height;i.selected===i.unselected||e<i.unselected?n[l++]=4294932343:n[l++]=4278255615}}s.putImageData(i,0,0)}}const MA=e=>Math.exp(e),IA=e=>.5+.28209479177387814*e,DA={scale_0:MA,scale_1:MA,scale_2:MA,f_dc_0:IA,f_dc_1:IA,f_dc_2:IA,opacity:e=>1/(1+Math.exp(-e))},RA=(e,t)=>{const s=new P({class:"control-parent"}),i=new F({class:"control-label",text:t}),n=new F({class:"control-element-expand"});return s.append(i),s.append(n),e.append(s),n};class LA extends G{constructor(e,t={}){super(t={...t,headerText:Yx("data"),id:"data-panel",resizable:"top",resizeMax:1e3,collapsed:!0,collapsible:!0,collapseHorizontally:!1,flex:!0,flexDirection:"row"});const s=new P({id:"data-controls-container"}),i=new P({id:"data-controls"}),n=new Pe({class:"control-element-expand",defaultValue:"surface-area",options:[]}),a=new P({class:"control-parent"}),r=new F({class:"control-label",text:Yx("data.log-scale")}),o=new X({class:"control-element",value:!1});a.append(r),a.append(o),i.append(n),i.append(a),i.append((e=>{const t=new P({class:"control-parent",id:"sep-container"});t.class.add("sep-container");const s=new F({class:"control-element-expand",text:e});return t.append(s),t})(Yx("data.totals")));const l=RA(i,Yx("data.totals.splats")),h=RA(i,Yx("data.totals.selected")),c=RA(i,Yx("data.totals.hidden")),d=RA(i,Yx("data.totals.deleted"));s.append(i);const u=new kA(256,128),p=new P({id:"histogram-container"});let m;p.dom.appendChild(u.canvas),this.content.append(s),this.content.append(p);const f=()=>{const e=DA[n.value],t=m.splatData.getProp(n.value);let s;if(e&&t)s=s=>e(t[s]);else switch(n.value){case"volume":{const e=m.splatData.getProp("scale_0"),t=m.splatData.getProp("scale_1"),i=m.splatData.getProp("scale_2");s=s=>MA(e[s])*MA(t[s])*MA(i[s]);break}case"distance":{const e=m.splatData.getProp("x"),t=m.splatData.getProp("y"),i=m.splatData.getProp("z");s=s=>Math.sqrt(e[s]**2+t[s]**2+i[s]**2);break}case"surface-area":{const e=m.splatData.getProp("scale_0"),t=m.splatData.getProp("scale_1"),i=m.splatData.getProp("scale_2");s=s=>MA(e[s])**2+MA(t[s])**2+MA(i[s])**2;break}case"hue":{const e=m.splatData.getProp("f_dc_0"),t=m.splatData.getProp("f_dc_1"),i=m.splatData.getProp("f_dc_2");s=s=>360*PA({r:IA(e[s]),g:IA(t[s]),b:IA(i[s])}).h;break}case"saturation":{const e=m.splatData.getProp("f_dc_0"),t=m.splatData.getProp("f_dc_1"),i=m.splatData.getProp("f_dc_2");s=s=>PA({r:IA(e[s]),g:IA(t[s]),b:IA(i[s])}).s;break}case"value":{const e=m.splatData.getProp("f_dc_0"),t=m.splatData.getProp("f_dc_1"),i=m.splatData.getProp("f_dc_2");s=s=>PA({r:IA(e[s]),g:IA(t[s]),b:IA(i[s])}).v;break}default:s=e=>t[e]}return s},g=()=>{if(!m||this.collapsed)return;const e=m.splatData.getProp("state");if(e){l.text=(e.length-m.numDeleted).toString(),h.text=m.numSelected.toString(),c.text=m.numHidden.toString(),d.text=m.numDeleted.toString();const t=f();u.update({count:e.length,valueFunc:s=>0===e[s]||e[s]===_y.selected?t(s):void 0,selectedFunc:t=>e[t]===_y.selected,logScale:o.value})}};this.on("expand",(()=>{g()})),e.on("splat.stateChanged",(e=>{m=e,g()})),e.on("selection.changed",(e=>{e instanceof wS&&(m=e,(e=>{const t={x:"X",y:"Y",z:"Z",distance:Yx("data.distance"),volume:Yx("data.volume"),"surface-area":Yx("data.surface-area"),scale_0:Yx("data.scale-x"),scale_1:Yx("data.scale-y"),scale_2:Yx("data.scale-z"),f_dc_0:Yx("data.red"),f_dc_1:Yx("data.green"),f_dc_2:Yx("data.blue"),opacity:Yx("data.opacity"),hue:Yx("data.hue"),saturation:Yx("data.saturation"),value:Yx("data.value")},s=e.splatData.getElement("vertex").properties.map((e=>e.name)),i=["state","transform"].concat(new Array(45).fill("").map(((e,t)=>`f_rest_${t}`))),a=s.concat(["distance","volume","surface-area","hue","saturation","value"]).filter((e=>!i.includes(e))).map((e=>({v:e,t:t[e]??e})));n.options=a})(m),g())})),e.on("dataPanel.toggle",(()=>{this.collapsed=!this.collapsed,g()})),n.on("change",g),o.on("change",g);const v=new P({id:"data-panel-popup-container",hidden:!0}),_=new F({id:"data-panel-popup-label",text:"",unsafe:!0});v.append(_),this.content.append(v),u.events.on("showOverlay",(()=>{v.hidden=!1})),u.events.on("hideOverlay",(()=>{v.hidden=!0})),u.events.on("updateOverlay",(e=>{v.style.left=`${e.x+14}px`,v.style.top=`${e.y}px`;const t=e.value.toFixed(2),s=e.selected+e.unselected,i=(e.total?s/e.total*100:0).toFixed(2);_.text=`value: ${t} cnt: ${s} (${i}%) sel: ${e.selected}`}));const y=document.createElementNS("http://www.w3.org/2000/svg","svg");y.setAttribute("id","histogram-svg");const x=document.createElementNS(y.namespaceURI,"rect");x.setAttribute("id","highlight-rect"),x.setAttribute("fill","rgba(255, 102, 0, 0.2)"),x.setAttribute("stroke","#f60"),x.setAttribute("stroke-width","1"),x.setAttribute("stroke-dasharray","5, 5"),y.appendChild(x),p.dom.appendChild(y),u.events.on("highlight",(e=>{x.setAttribute("x",e.x.toString()),x.setAttribute("y",e.y.toString()),x.setAttribute("width",e.width.toString()),x.setAttribute("height",e.height.toString()),y.style.display="inline"})),u.events.on("select",((t,s,i)=>{y.style.display="none";const n=m.splatData.getProp("state");n.some((e=>e===_y.selected));const a=f();e.fire("select.pred",t,(e=>{if(0!==n[e]&&n[e]!==_y.selected)return!1;const t=a(e),r=u.histogram.valueToBucket(t);return r>=s&&r<=i}))}))}}const FA=e=>{const t=decodeURIComponent(e.substring(19));return(new DOMParser).parseFromString(t,"image/svg+xml").documentElement};class BA extends P{constructor(e,t,s={}){super(s={...s,id:"bottom-toolbar"}),this.dom.addEventListener("pointerdown",(e=>{e.stopPropagation()}));const i=new w({id:"bottom-toolbar-undo",class:"bottom-toolbar-button",enabled:!1}),n=new w({id:"bottom-toolbar-redo",class:"bottom-toolbar-button",enabled:!1}),a=new w({id:"bottom-toolbar-picker",class:"bottom-toolbar-tool"}),r=new w({id:"bottom-toolbar-polygon",class:"bottom-toolbar-tool"}),o=new w({id:"bottom-toolbar-brush",class:"bottom-toolbar-tool"}),l=new w({id:"bottom-toolbar-lasso",class:"bottom-toolbar-tool"}),h=new w({id:"bottom-toolbar-sphere",class:"bottom-toolbar-tool"}),c=new w({id:"bottom-toolbar-translate",class:"bottom-toolbar-tool",icon:"E111"}),d=new w({id:"bottom-toolbar-rotate",class:"bottom-toolbar-tool",icon:"E113"}),u=new w({id:"bottom-toolbar-scale",class:"bottom-toolbar-tool",icon:"E112"}),p=new w({id:"bottom-toolbar-coord-space",class:"bottom-toolbar-toggle",icon:"E118"}),m=new w({id:"bottom-toolbar-origin",class:["bottom-toolbar-toggle","active"],icon:"E189"});i.dom.appendChild(FA("data:image/svg+xml,%3csvg width='38' height='38' viewBox='0 0 38 38' fill='none' xmlns='http://www.w3.org/2000/svg'%3e%3cpath fill-rule='evenodd' clip-rule='evenodd' d='M19.5597 13.3858L19.8547 13.0999C20.2319 12.7343 20.2319 12.1408 19.8547 11.7742C19.4765 11.4086 18.8642 11.4086 18.487 11.7742L16.5525 13.6493C16.1743 14.0159 16.1743 14.6093 16.5525 14.975L18.487 16.85C18.6756 17.0338 18.9232 17.1247 19.1708 17.1247C19.4185 17.1247 19.6651 17.0338 19.8547 16.85C20.2319 16.4844 20.2319 15.8909 19.8547 15.5243L19.5974 15.2759C22.1394 15.4128 24.1696 17.4407 24.1696 19.9373C24.1696 22.5221 21.9991 24.6249 19.3333 24.6249C16.6666 24.6249 14.497 22.5221 14.497 19.9373C14.497 19.4198 14.0637 18.9998 13.5298 18.9998C12.9949 18.9998 12.5625 19.4198 12.5625 19.9373C12.5625 23.5562 15.5997 26.5 19.3333 26.5C23.066 26.5 26.1042 23.5562 26.1042 19.9373C26.1042 16.3934 23.1869 13.503 19.5597 13.3858' fill='currentColor'/%3e%3c/svg%3e")),n.dom.appendChild(FA("data:image/svg+xml,%3csvg width='38' height='38' viewBox='0 0 38 38' fill='none' xmlns='http://www.w3.org/2000/svg'%3e%3cpath fill-rule='evenodd' clip-rule='evenodd' d='M25.1369 19.0001C24.602 19.0001 24.1696 19.4201 24.1696 19.9376C24.1696 22.5222 22.0001 24.625 19.3333 24.625C16.6666 24.625 14.497 22.5222 14.497 19.9376C14.497 17.4411 16.5273 15.4124 19.0693 15.2764L18.812 15.5249C18.4338 15.8914 18.4338 16.4839 18.812 16.8505C19.0006 17.0333 19.2482 17.1251 19.4958 17.1251C19.7435 17.1251 19.9911 17.0333 20.1797 16.8505L22.1142 14.9755C22.4924 14.6089 22.4924 14.0164 22.1142 13.6499L20.1797 11.7749C19.8015 11.4084 19.1902 11.4084 18.812 11.7749C18.4338 12.1415 18.4338 12.734 18.812 13.1005L19.107 13.3865C15.4798 13.5036 12.5625 16.393 12.5625 19.9376C12.5625 23.5563 15.6007 26.5 19.3333 26.5C23.066 26.5 26.1042 23.5563 26.1042 19.9376C26.1042 19.4201 25.6718 19.0001 25.1369 19.0001' fill='currentColor'/%3e%3c/svg%3e")),a.dom.appendChild(FA("data:image/svg+xml,%3csvg width='38' height='38' viewBox='0 0 38 38' fill='none' xmlns='http://www.w3.org/2000/svg'%3e %3cpath d='M21.6634 25.716C21.2372 26.5644 20.0524 26.5946 19.7797 25.764L17.0491 17.4463C16.7833 16.6367 17.6452 15.7799 18.4524 16.0512L26.7108 18.8274C27.5386 19.1056 27.501 20.2904 26.6511 20.7118L24.3958 21.6809L27.4216 24.7067C27.7978 25.083 27.7071 25.7837 27.219 26.2719C26.7308 26.76 26.0301 26.8507 25.6538 26.4745L22.5935 23.4142L21.6634 25.716Z' fill='currentColor'/%3e %3cpath d='M11 11H12.5V12.5H11V11Z' fill='currentColor'/%3e %3cpath d='M11 14H12.5V15.5H11V14Z' fill='currentColor'/%3e %3cpath d='M11 17H12.5V18.5H11V17Z' fill='currentColor'/%3e %3cpath d='M14 17H15.5V18.5H14V17Z' fill='currentColor'/%3e %3cpath d='M14 11H15.5V12.5H14V11Z' fill='currentColor'/%3e %3cpath d='M17 11H18.5V12.5H17V11Z' fill='currentColor'/%3e %3cpath d='M20 11H21.5V12.5H20V11Z' fill='currentColor'/%3e %3cpath d='M20 14H21.5V15.5H20V14Z' fill='currentColor'/%3e%3c/svg%3e")),r.dom.appendChild(FA("data:image/svg+xml,%3csvg width='38' height='38' viewBox='0 0 38 38' fill='none' xmlns='http://www.w3.org/2000/svg'%3e%3cpath d='M22.6649 26.2004C22.5798 26.1153 22.5157 26.0116 22.4777 25.8975L21.4002 22.6651C21.1396 21.8834 21.8834 21.1396 22.6651 21.4002L25.8975 22.4777C26.0117 22.5157 26.1154 22.5798 26.2004 22.6649V22.6649C26.503 22.9675 26.503 23.4581 26.2004 23.7607L23.7607 26.2004C23.4581 26.503 22.9675 26.503 22.6649 26.2004V26.2004Z' fill='currentColor'/%3e%3cpath fill-rule='evenodd' clip-rule='evenodd' d='m 8.7128906%2c11.257813 2.1542974%2c4.226562 1.158203%2c-0.589844 -1.150391%2c-2.255859 0.455078%2c0.01758 0.04883%2c-1.298828 z m 3.9648434%2c0.148437 -0.04883%2c1.298828 5.197266%2c0.195313 0.04883%2c-1.298828 z m 6.496094%2c0.244141 -0.04883%2c1.298828 5.195312%2c0.195312 0.04883%2c-1.298828 z m 6.496094%2c0.24414 -0.04883%2c1.298828 0.816406%2c0.03125 -1.117188%2c1.361329 1.003907%2c0.824218 2.779297%2c-3.386718 z m -1.175781%2c3.695313 -3.298829%2c4.021484 1.00586%2c0.824219 L 25.5%2c16.416016 Z m -11.878907%2c0.46289 -1.158203%2c0.589844 2.359375%2c4.634766 1.160157%2c-0.591797 z m 2.951172%2c5.791016 -1.158203%2c0.591797 2.359375%2c4.632812 1.158203%2c-0.589843 z' fill='currentColor'/%3e%3c/svg%3e")),o.dom.appendChild(FA("data:image/svg+xml,%3csvg width='38' height='38' viewBox='0 0 38 38' fill='none' xmlns='http://www.w3.org/2000/svg'%3e%3cpath d='M11 19C11 14.5817 14.5817 11 19 11V11C23.4183 11 27 14.5817 27 19V19C27 23.4183 23.4183 27 19 27V27C14.5817 27 11 23.4183 11 19V19Z' stroke='currentColor' stroke-width='1.5' stroke-dasharray='4 2' fill-opacity='0' /%3e%3cpath d='M15 19C15 16.7909 16.7909 15 19 15V15C21.2091 15 23 16.7909 23 19V19C23 21.2091 21.2091 23 19 23V23C16.7909 23 15 21.2091 15 19V19Z' fill='currentColor'/%3e%3c/svg%3e")),h.dom.appendChild(FA("data:image/svg+xml,%3csvg width='38' height='38' viewBox='0 0 38 38' fill='none' xmlns='http://www.w3.org/2000/svg'%3e%3cpath fill-rule='evenodd' clip-rule='evenodd' d='M16.3645 10.5293C17.0464 10.347 17.7625 10.25 18.5 10.25C19.2375 10.25 19.9536 10.347 20.6355 10.5293L20.2482 11.9784C19.6914 11.8296 19.1056 11.75 18.5 11.75C17.8944 11.75 17.3086 11.8296 16.7518 11.9784L16.3645 10.5293ZM11.3545 14.3738C12.0788 13.1221 13.1221 12.0788 14.3738 11.3545L15.125 12.6529C14.9598 12.7485 14.799 12.8509 14.643 12.9597C17.1237 13.9206 19.8763 13.9206 22.357 12.9597C22.201 12.8509 22.0402 12.7485 21.875 12.6529L22.6262 11.3545C23.8779 12.0788 24.9212 13.1221 25.6455 14.3738L24.3471 15.125C24.0398 14.5938 23.662 14.1083 23.2267 13.6812C20.2171 15.0134 16.7829 15.0134 13.7733 13.6812C13.338 14.1083 12.9602 14.5938 12.6529 15.125L11.3545 14.3738ZM10.25 18.5C10.25 17.7625 10.347 17.0464 10.5293 16.3645L11.9784 16.7518C11.8906 17.0803 11.8269 17.419 11.7894 17.7658C16.1247 19.3372 20.8753 19.3372 25.2106 17.7658C25.1731 17.419 25.1094 17.0803 25.0216 16.7518L26.4707 16.3645C26.653 17.0464 26.75 17.7625 26.75 18.5C26.75 19.2375 26.653 19.9536 26.4707 20.6355L25.0216 20.2482C25.1445 19.7885 25.2201 19.3091 25.2428 18.8151C20.8742 20.3208 16.1258 20.3208 11.7572 18.8151C11.7799 19.3091 11.8555 19.7885 11.9784 20.2482L10.5293 20.6355C10.347 19.9536 10.25 19.2375 10.25 18.5ZM14.3738 25.6455C13.1221 24.9212 12.0788 23.8779 11.3545 22.6262L12.6529 21.875C12.8207 22.165 13.0095 22.4415 13.2172 22.7022C16.6638 23.7308 20.3362 23.7308 23.7828 22.7022C23.9905 22.4415 24.1793 22.165 24.3471 21.875L25.6455 22.6262C24.9212 23.8779 23.8779 24.9212 22.6262 25.6455L21.875 24.3471C22.0058 24.2714 22.1338 24.1915 22.2589 24.1075C19.7769 24.5957 17.2231 24.5957 14.7411 24.1075C14.8662 24.1915 14.9942 24.2714 15.125 24.3471L14.3738 25.6455ZM18.5 26.75C17.7625 26.75 17.0464 26.653 16.3645 26.4707L16.7518 25.0216C17.3086 25.1704 17.8944 25.25 18.5 25.25C19.1056 25.25 19.6914 25.1704 20.2482 25.0216L20.6355 26.4707C19.9536 26.653 19.2375 26.75 18.5 26.75Z' fill='currentColor'/%3e%3c/svg%3e")),l.dom.appendChild(FA("data:image/svg+xml,%3csvg width='38' height='38' viewBox='0 0 38 38' fill='none' xmlns='http://www.w3.org/2000/svg'%3e%3cpath fill-rule='evenodd' clip-rule='evenodd' d='M22.0831 10.9413C23.1429 10.9357 24.0754 11.6408 24.3565 12.6603L24.6802 13.8339L23.4489 14.17L23.1252 12.9964C22.9974 12.5329 22.5736 12.2124 22.0919 12.215L20.0088 12.226L20 10.9524L22.0831 10.9413ZM16.3578 10.9751L18.4409 10.9641L18.4496 12.2377L16.3665 12.2488C15.8979 12.2513 15.4865 12.5592 15.3534 13.0072L14.892 14.5604L13.6675 14.1969L14.1289 12.6437C14.4217 11.6581 15.3267 10.9806 16.3578 10.9751ZM25.0038 15.0075L25.3275 16.1811C25.6147 17.2229 25.1486 18.3241 24.2002 18.8439L23.1295 19.4308L22.5131 18.3144L23.5838 17.7275C24.0148 17.4912 24.2268 16.9907 24.0962 16.5172L23.7725 15.3436L25.0038 15.0075ZM12.2833 18.8565L13.2061 15.7501L14.4306 16.1136L13.5078 19.22L12.2833 18.8565ZM11.3605 21.9628L11.8219 20.4096L13.0464 20.7732L12.585 22.3264C12.4506 22.7788 12.6321 23.2658 13.0304 23.5215L14.1207 24.2215L13.4306 25.2921L12.3404 24.5922C11.4641 24.0297 11.0649 22.9582 11.3605 21.9628ZM19.6953 24.1541L19.0164 25.6793C18.4343 26.9871 16.8191 27.4675 15.6112 26.692L14.5209 25.9921L15.211 24.9214L16.3012 25.6214C16.8503 25.9738 17.5845 25.7555 17.8491 25.161L18.5279 23.6358L19.6953 24.1541Z' fill='currentColor'/%3e%3cpath d='M22.6649 26.2004C22.5798 26.1153 22.5157 26.0116 22.4777 25.8975L21.4002 22.6651C21.1396 21.8834 21.8834 21.1396 22.6651 21.4002L25.8975 22.4777C26.0117 22.5157 26.1154 22.5798 26.2004 22.6649V22.6649C26.503 22.9675 26.503 23.4581 26.2004 23.7607L23.7607 26.2004C23.4581 26.503 22.9675 26.503 22.6649 26.2004V26.2004Z' fill='currentColor'/%3e%3c/svg%3e")),this.append(i),this.append(n),this.append(new x({class:"bottom-toolbar-separator"})),this.append(a),this.append(l),this.append(r),this.append(o),this.append(new x({class:"bottom-toolbar-separator"})),this.append(h),this.append(new x({class:"bottom-toolbar-separator"})),this.append(c),this.append(d),this.append(u),this.append(p),this.append(m),i.dom.addEventListener("click",(()=>e.fire("edit.undo"))),n.dom.addEventListener("click",(()=>e.fire("edit.redo"))),r.dom.addEventListener("click",(()=>e.fire("tool.polygonSelection"))),l.dom.addEventListener("click",(()=>e.fire("tool.lassoSelection"))),o.dom.addEventListener("click",(()=>e.fire("tool.brushSelection"))),a.dom.addEventListener("click",(()=>e.fire("tool.rectSelection"))),h.dom.addEventListener("click",(()=>e.fire("tool.sphereSelection"))),c.dom.addEventListener("click",(()=>e.fire("tool.move"))),d.dom.addEventListener("click",(()=>e.fire("tool.rotate"))),u.dom.addEventListener("click",(()=>e.fire("tool.scale"))),p.dom.addEventListener("click",(()=>e.fire("tool.toggleCoordSpace"))),m.dom.addEventListener("click",(()=>e.fire("pivot.toggleOrigin"))),e.on("edit.canUndo",(e=>{i.enabled=e})),e.on("edit.canRedo",(e=>{n.enabled=e})),e.on("tool.activated",(e=>{a.class["rectSelection"===e?"add":"remove"]("active"),o.class["brushSelection"===e?"add":"remove"]("active"),r.class["polygonSelection"===e?"add":"remove"]("active"),l.class["lassoSelection"===e?"add":"remove"]("active"),h.class["sphereSelection"===e?"add":"remove"]("active"),c.class["move"===e?"add":"remove"]("active"),d.class["rotate"===e?"add":"remove"]("active"),u.class["scale"===e?"add":"remove"]("active")})),e.on("tool.coordSpace",(e=>{p.dom.classList["local"===e?"add":"remove"]("active")})),e.on("pivot.origin",(e=>{m.dom.classList["boundCenter"===e?"add":"remove"]("active")})),t.register(i,Yx("tooltip.undo")),t.register(n,Yx("tooltip.redo")),t.register(a,Yx("tooltip.picker")),t.register(o,Yx("tooltip.brush")),t.register(r,Yx("tooltip.polygon")),t.register(l,"Lasso Select"),t.register(h,Yx("tooltip.sphere")),t.register(c,Yx("tooltip.translate")),t.register(d,Yx("tooltip.rotate")),t.register(u,Yx("tooltip.scale")),t.register(p,Yx("tooltip.local-space")),t.register(m,Yx("tooltip.bound-center"))}}class OA extends Fe{_onSlideStart(e){super._onSlideStart(e),this.emit("slide:start")}_onSlideEnd(e){super._onSlideEnd(e),this.emit("slide:end")}}class zA extends P{constructor(e,t,s={}){super(s={...s,id:"color-panel",class:"panel",hidden:!0}),["pointerdown","pointerup","pointermove","wheel","dblclick"].forEach((e=>{this.dom.addEventListener(e,(e=>e.stopPropagation()))}));const i=new P({class:"panel-header"}),n=new F({class:"panel-header-icon",text:""}),a=new F({class:"panel-header-label",text:Yx("colors")});i.append(n),i.append(a);const r=new P({class:"color-panel-row"}),o=new F({text:Yx("colors.tint"),class:"color-panel-row-label"}),l=new ie({class:"color-panel-row-picker",value:[1,1,1]});r.append(o),r.append(l);const h=new P({class:"color-panel-row"}),c=new F({text:Yx("colors.brightness"),class:"color-panel-row-label"}),d=new OA({class:"color-panel-row-slider",min:-1,max:1,step:.1,value:1});h.append(c),h.append(d);const u=new P({class:"color-panel-row"}),p=new F({text:Yx("colors.blackPoint"),class:"color-panel-row-label"}),m=new OA({class:"color-panel-row-slider",min:0,max:1,step:.01,value:0});u.append(p),u.append(m);const f=new P({class:"color-panel-row"}),g=new F({text:Yx("colors.whitePoint"),class:"color-panel-row-label"}),v=new OA({class:"color-panel-row-slider",min:0,max:1,step:.01,value:1});f.append(g),f.append(v);const _=new P({class:"color-panel-row"}),y=new F({text:Yx("colors.transparency"),class:"color-panel-row-label"}),x=new OA({class:"color-panel-row-slider",min:-6,max:6,step:.01,value:1});_.append(y),_.append(x);const w=new P({class:"color-panel-control-row"}),b=new F({class:"panel-header-button",text:""});w.append(new F({class:"panel-header-spacer"})),w.append(b),w.append(new F({class:"panel-header-spacer"})),this.append(i),this.append(r),this.append(h),this.append(u),this.append(f),this.append(_),this.append(new F({class:"panel-header-spacer"})),this.append(w);let C=!1,S=null,A=null;const T=e=>{C||(C=!0,l.value=e?[e.tintClr.r,e.tintClr.g,e.tintClr.b]:[1,1,1],d.value=e?e.brightness:0,m.value=e?e.blackPoint:0,v.value=e?e.whitePoint:1,x.value=e?Math.log(e.transparency):0,C=!1)},E=()=>{S&&(A=new uw({splat:S,newState:{tintClr:S.tintClr.clone(),brightness:S.brightness,blackPoint:S.blackPoint,whitePoint:S.whitePoint,transparency:S.transparency},oldState:{tintClr:S.tintClr.clone(),brightness:S.brightness,blackPoint:S.blackPoint,whitePoint:S.whitePoint,transparency:S.transparency}}))},k=()=>{if(A){const{newState:t}=A;t.tintClr.set(l.value[0],l.value[1],l.value[2]),t.brightness=d.value,t.blackPoint=m.value,t.whitePoint=v.value,t.transparency=Math.exp(x.value),e.fire("edit.add",A),A=null}},M=e=>{C||(C=!0,A?(e(A),A.do()):S&&(E(),e(A),A.do(),k()),C=!1)};[d,m,v,x].forEach((e=>{e.on("slide:start",E),e.on("slide:end",k)})),l.on("picker:color:start",E),l.on("picker:color:end",k),l.on("change",(e=>{M((t=>{t.newState.tintClr.set(e[0],e[1],e[2])}))})),d.on("change",(e=>{M((t=>{t.newState.brightness=e}))})),m.on("change",(e=>{M((t=>{t.newState.blackPoint=e})),e>v.value&&(v.value=e)})),v.on("change",(e=>{M((t=>{t.newState.whitePoint=e})),e<m.value&&(m.value=e)})),x.on("change",(e=>{M((t=>{t.newState.transparency=Math.exp(e)}))})),b.on("click",(()=>{if(S){const t=new uw({splat:S,newState:{tintClr:new mt(1,1,1),brightness:0,blackPoint:0,whitePoint:1,transparency:1},oldState:{tintClr:S.tintClr.clone(),brightness:S.brightness,blackPoint:S.blackPoint,whitePoint:S.whitePoint,transparency:S.transparency}});e.fire("edit.add",t)}})),e.on("selection.changed",(e=>{S=e,T(e)})),e.on("splat.tintClr",T),e.on("splat.brightness",T),e.on("splat.blackPoint",T),e.on("splat.whitePoint",T),e.on("splat.transparency",T),t.register(b,Yx("colors.reset"),"bottom");const I=t=>{t===this.hidden&&(this.hidden=!t,e.fire("colorPanel.visible",t))};e.function("colorPanel.visible",(()=>!this.hidden)),e.on("colorPanel.setVisible",(e=>{I(e)})),e.on("colorPanel.toggleVisible",(()=>{I(this.hidden)})),e.on("viewPanel.visible",(e=>{e&&I(!1)}))}}const VA=e=>{const t=e.parentNode;return"BODY"===t.tagName||"static"!==window.getComputedStyle(t).position?t:VA(t)},NA=e=>!e||"string"==typeof e||e instanceof String;class UA extends P{parentPanel=null;constructor(e,t={}){super(t={...t,class:"menu-panel",hidden:!0}),this.on("hide",(()=>{for(const t of e)t.subMenu&&(t.subMenu.hidden=!0)})),this.on("show",(()=>{for(let t=0;t<e.length;t++){const s=e[t];s.isEnabled&&(this.dom.children.item(t).ui.enabled=s.isEnabled()),s.isVisible&&(this.dom.children.item(t).ui.hidden=!s.isVisible())}}));for(const t of e){const e=t.subMenu?"menu":t.text?"button":"separator",s=e=>NA(t.icon)?new F({class:"menu-row-icon",text:t.icon&&String.fromCodePoint(parseInt(t.icon,16))}):t.icon;let i=null,n=null,a=null;switch(e){case"button":{i=new P({class:"menu-row"});const e=s(),n=new F({class:"menu-row-text",text:t.text}),a=NA(t.extra)?new F({class:"menu-row-postscript",text:t.extra}):t.extra;i.append(e),i.append(n),i.append(a);break}case"menu":{i=new P({class:"menu-row"});const e=s(),r=new F({class:"menu-row-text",text:t.text}),o=new F({class:"menu-row-postscript",text:""});i.append(e),i.append(r),i.append(o),t.subMenu.parentPanel=this;const l=t.subMenu;l&&(n=()=>{l.hidden&&(l.position(i.dom,"right",2),l.hidden=!l.hidden),a=()=>{l.hidden=!0}});break}case"separator":this.append(new P({class:"menu-row-separator"}))}if(i){let e=-1;i.dom.addEventListener("pointerenter",(()=>{e=window.setTimeout((()=>{a&&a(),n&&n()}),250)})),i.dom.addEventListener("pointerleave",(()=>{-1!==e&&(clearTimeout(e),e=-1)})),i.dom.addEventListener("pointerdown",(e=>{e.stopPropagation()})),i.dom.addEventListener("pointerup",(e=>{e.stopPropagation(),!i.disabled&&t.onSelect&&(this.rootPanel.hidden=!0,t.onSelect())})),this.append(i)}}}get rootPanel(){let e=this;for(;e.parentPanel;)e=e.parentPanel;return e}position(e,t,s=2){((e,t,s,i)=>{const n=t.getBoundingClientRect(),a=VA(e).getBoundingClientRect(),r=e.style;switch(s){case"left":case"top":break;case"right":r.left=`${n.right-a.left+i}px`,r.top=n.top-a.top+"px";break;case"bottom":r.left=n.left-a.left+"px",r.top=`${n.bottom-a.top+i}px`}})(this.dom,e,t,s)}}var HA="data:image/svg+xml,%3csvg width='16' height='16' viewBox='6 6 12 12' fill='none' xmlns='http://www.w3.org/2000/svg'%3e%3cpath fill-rule='evenodd' clip-rule='evenodd' d='M14.5 9H16V10H8V9L9.5 9C9.5 8.17157 10.1716 7.5 11 7.5H13C13.8284 7.5 14.5 8.17157 14.5 9ZM10.5 9L13.5 9C13.5 8.72386 13.2761 8.5 13 8.5L11 8.5C10.7239 8.5 10.5 8.72386 10.5 9ZM9.5 10.5V15.5C9.5 15.7761 9.72386 16 10 16H14C14.2761 16 14.5 15.7761 14.5 15.5V10.5H15.5V15.5C15.5 16.3284 14.8284 17 14 17H10C9.17157 17 8.5 16.3284 8.5 15.5V10.5H9.5ZM11.5 11.5C11.5 11.2239 11.2761 11 11 11C10.7239 11 10.5 11.2239 10.5 11.5V14.5C10.5 14.7761 10.7239 15 11 15C11.2761 15 11.5 14.7761 11.5 14.5V11.5ZM13 11C13.2761 11 13.5 11.2239 13.5 11.5V14.5C13.5 14.7761 13.2761 15 13 15C12.7239 15 12.5 14.7761 12.5 14.5V11.5C12.5 11.2239 12.7239 11 13 11Z' fill='currentColor'/%3e%3c/svg%3e",GA="data:image/svg+xml,%3csvg width='16' height='16' viewBox='0 0 12 12' fill='none' xmlns='http://www.w3.org/2000/svg'%3e%3cpath fill-rule='evenodd' clip-rule='evenodd' d='M3 11C2.17157 11 1.5 10.3284 1.5 9.5L1.5 3.5C1.5 2.67157 2.17157 2 3 2L6 2C6.82843 2 7.5 2.67157 7.5 3.5L7.5 4.5C7.5 4.77614 7.27614 5 7 5C6.72386 5 6.5 4.77614 6.5 4.5L6.5 3.5C6.5 3.22386 6.27614 3 6 3L3 3C2.72386 3 2.5 3.22386 2.5 3.5L2.5 9.5C2.5 9.77614 2.72386 10 3 10L6 10C6.27614 10 6.5 9.77614 6.5 9.5L6.5 8.5C6.5 8.22386 6.72386 8 7 8C7.27614 8 7.5 8.22386 7.5 8.5L7.5 9.5C7.5 10.3284 6.82843 11 6 11L3 11ZM9 7L8.2 7.6C7.97909 7.76568 7.93432 8.07908 8.1 8.3C8.26569 8.52091 8.57909 8.56568 8.8 8.4L10.3733 7.22C10.8533 6.86 10.8533 6.14 10.3733 5.78L8.8 4.6C8.57909 4.43431 8.26569 4.47909 8.1 4.7C7.93432 4.92091 7.97909 5.23431 8.2 5.4L9.00001 6L5.5 6C5.22386 6 5 6.22386 5 6.5C5 6.77614 5.22386 7 5.5 7L9 7Z' fill='currentColor'/%3e%3c/svg%3e",WA="data:image/svg+xml,%3csvg width='16' height='16' viewBox='0 0 12 12' fill='none' xmlns='http://www.w3.org/2000/svg'%3e%3cpath fill-rule='evenodd' clip-rule='evenodd' d='M1.5 3.5C1.5 2.67157 2.17157 2 3 2H9C9.82843 2 10.5 2.67157 10.5 3.5V8.5C10.5 9.32843 9.82843 10 9 10H8C7.72386 10 7.5 9.77614 7.5 9.5C7.5 9.22386 7.72386 9 8 9H9C9.27614 9 9.5 8.77614 9.5 8.5V3.5C9.5 3.22386 9.27614 3 9 3H3C2.72386 3 2.5 3.22386 2.5 3.5V8.5C2.5 8.77614 2.72386 9 3 9H4C4.27614 9 4.5 9.22386 4.5 9.5C4.5 9.77614 4.27614 10 4 10H3C2.17157 10 1.5 9.32843 1.5 8.5V3.5ZM6.5 7L7.1 7.8C7.26568 8.02091 7.57908 8.06568 7.8 7.9C8.02091 7.73431 8.06568 7.42091 7.9 7.2L6.72 5.62666C6.36 5.14666 5.64 5.14666 5.28 5.62666L4.1 7.2C3.93431 7.42091 3.97908 7.73431 4.2 7.9C4.42091 8.06568 4.73431 8.02091 4.9 7.8L5.5 6.99999V10.5C5.5 10.7761 5.72386 11 6 11C6.27614 11 6.5 10.7761 6.5 10.5V7Z' fill='currentColor'/%3e%3c/svg%3e",jA="data:image/svg+xml,%3csvg width='16' height='16' viewBox='0 0 12 12' fill='none' xmlns='http://www.w3.org/2000/svg'%3e%3cpath fill-rule='evenodd' clip-rule='evenodd' d='M9 2C9 1.72386 8.77614 1.5 8.5 1.5C8.22386 1.5 8 1.72386 8 2V3H7C6.72386 3 6.5 3.22386 6.5 3.5C6.5 3.77614 6.72386 4 7 4H8V5C8 5.27614 8.22386 5.5 8.5 5.5C8.77614 5.5 9 5.27614 9 5V4H10C10.2761 4 10.5 3.77614 10.5 3.5C10.5 3.22386 10.2761 3 10 3H9V2ZM3.5 3C3.22386 3 3 3.22386 3 3.5V8.5C3 8.77614 3.22386 9 3.5 9H8.5C8.77614 9 9 8.77614 9 8.5V6.5C9 6.22386 9.22386 6 9.5 6C9.77614 6 10 6.22386 10 6.5V8.5C10 9.32843 9.32843 10 8.5 10H3.5C2.67157 10 2 9.32843 2 8.5V3.5C2 2.67157 2.67157 2 3.5 2H5.5C5.77614 2 6 2.22386 6 2.5C6 2.77614 5.77614 3 5.5 3H3.5Z' fill='currentColor'/%3e%3c/svg%3e",qA="data:image/svg+xml,%3csvg width='16' height='16' viewBox='0 0 12 12' fill='none' xmlns='http://www.w3.org/2000/svg'%3e%3cpath fill-rule='evenodd' clip-rule='evenodd' d='M4.66421 2C4.26639 2 3.88486 2.15803 3.60355 2.43934L2.43934 3.60355C2.15804 3.88486 2 4.26639 2 4.66421V8.5C2 9.32843 2.67157 10 3.5 10H8.5C9.32843 10 10 9.32843 10 8.5V3.5C10 2.67157 9.32843 2 8.5 2H7.5H5.5H4.66421ZM5 3H4.66421C4.53161 3 4.40443 3.05268 4.31066 3.14645L3.14645 4.31066C3.05268 4.40443 3 4.53161 3 4.66421V8.5C3 8.77614 3.22386 9 3.5 9H8.5C8.77614 9 9 8.77614 9 8.5V3.5C9 3.22386 8.77614 3 8.5 3H8V4.5C8 4.77614 7.77614 5 7.5 5H5.5C5.22386 5 5 4.77614 5 4.5V3Z' fill='currentColor'/%3e%3c/svg%3e";const XA=e=>{const t=decodeURIComponent(e.substring(19));return new x({dom:(new DOMParser).parseFromString(t,"image/svg+xml").documentElement})};class YA extends P{constructor(e,t={}){super(t={...t,id:"menu"});const s=new P({id:"menu-bar"});s.dom.addEventListener("pointerdown",(e=>{e.stopPropagation()}));const i=document.createElement("img");i.src="data:image/svg+xml,%3csvg width='512' height='512' viewBox='0 0 512 512' fill='none' xmlns='http://www.w3.org/2000/svg'%3e %3cdefs%3e %3clinearGradient id='grad' x1='0' y1='0' x2='0' y2='512' gradientUnits='userSpaceOnUse'%3e %3cstop style='stop-color:%23f0662c' offset='0' /%3e %3cstop style='stop-color:%23ffac45' offset='1' /%3e %3c/linearGradient%3e %3c/defs%3e %3cg%3e %3crect style='fill:url(%23grad)' x='0' y='0' width='512' height='512' /%3e %3cpath style='fill:white' d='m 177%2c128 155%2c76 -155%2c76 v -37 l 76%2c-37 -76%2c-37 z' /%3e %3cpath style='fill:white' d='m 177%2c305 155%2c-76 v 37 l -76%2c37 76%2c37 v 37 z' /%3e %3c/g%3e%3c/svg%3e",i.setAttribute("id","app-icon"),i.addEventListener("pointerdown",(e=>{window.open("https://playcanvas.com","_blank").focus()}));const n=new x({dom:i}),a=new F({text:Yx("file"),class:"menu-option"}),r=new F({text:Yx("render"),class:"menu-option"}),o=new F({text:Yx("select"),class:"menu-option"}),l=new F({text:Yx("help"),class:"menu-option"}),h=()=>{document.body.classList.toggle("collapsed")};document.body.clientWidth<600&&h();const c=XA("data:image/svg+xml,%3csvg width='16' height='16' viewBox='0 0 16 16' fill='none' xmlns='http://www.w3.org/2000/svg'%3e %3cpath fill-rule='evenodd' clip-rule='evenodd' d='M2 5.33333C2 4.22876 2.89543 3.33333 4 3.33333H12C13.1046 3.33333 14 4.22876 14 5.33333V10.6667C14 11.7712 13.1046 12.6667 12 12.6667H4C2.89543 12.6667 2 11.7712 2 10.6667V5.33333ZM4 4.66666C3.63181 4.66666 3.33333 4.96514 3.33333 5.33333V10.6667C3.33333 11.0349 3.63181 11.3333 4 11.3333H12C12.3682 11.3333 12.6667 11.0349 12.6667 10.6667V5.33333C12.6667 4.96514 12.3682 4.66666 12 4.66666H4Z' fill='currentColor'/%3e %3cpath fill-rule='evenodd' clip-rule='evenodd' d='M6 12V4H7.33333V12H6Z' fill='currentColor'/%3e%3c/svg%3e");c.dom.classList.add("menu-icon"),c.dom.setAttribute("id","menu-collapse"),c.dom.addEventListener("click",h);const d=XA("data:image/svg+xml,%3csvg width='12' height='12' viewBox='0 0 12 12' fill='none' xmlns='http://www.w3.org/2000/svg'%3e %3cpath fill-rule='evenodd' clip-rule='evenodd' d='M3.10535 2.19302C3.27488 1.97505 3.58902 1.93578 3.80699 2.10532L7.29211 4.81596C8.06423 5.4165 8.06423 6.58348 7.29211 7.18402L3.80699 9.89467C3.58902 10.0642 3.27488 10.0249 3.10535 9.80696C2.93581 9.58899 2.97508 9.27485 3.19305 9.10532L6.67817 6.39467C6.93554 6.19449 6.93554 5.8055 6.67817 5.60532L3.19305 2.89467C2.97508 2.72513 2.93581 2.411 3.10535 2.19302Z' fill='currentColor'/%3e%3c/svg%3e");d.dom.classList.add("menu-icon"),d.dom.setAttribute("id","menu-arrow"),d.dom.addEventListener("click",h);const u=new P({id:"menu-bar-options"});u.append(a),u.append(o),u.append(r),u.append(l),u.append(c),u.append(d),s.append(n),s.append(u);const p=new UA([{text:Yx("file.export.ply"),icon:XA(GA),isEnabled:()=>!e.invoke("scene.empty"),onSelect:()=>e.invoke("scene.export","ply")},{text:Yx("file.export.compressed-ply"),icon:XA(GA),isEnabled:()=>!e.invoke("scene.empty"),onSelect:()=>e.invoke("scene.export","compressed-ply")},{text:Yx("file.export.splat"),icon:XA(GA),isEnabled:()=>!e.invoke("scene.empty"),onSelect:()=>e.invoke("scene.export","splat")},{},{text:Yx("file.export.viewer"),icon:XA(GA),isEnabled:()=>!e.invoke("scene.empty"),onSelect:()=>e.invoke("scene.export","viewer")}]),m=new UA([{text:Yx("file.new"),icon:XA(jA),isEnabled:()=>!e.invoke("scene.empty"),onSelect:()=>e.invoke("doc.new")},{text:Yx("file.open"),icon:XA("data:image/svg+xml,%3csvg width='16' height='16' viewBox='0 0 12 12' fill='none' xmlns='http://www.w3.org/2000/svg'%3e%3cpath d='M6 3V5C6 5.55228 6.44772 6 7 6H9M9.5 6.41421V8.5C9.5 9.05228 9.05228 9.5 8.5 9.5H3.5C2.94772 9.5 2.5 9.05228 2.5 8.5V3.5C2.5 2.94772 2.94772 2.5 3.5 2.5H5.58579C5.851 2.5 6.10536 2.60536 6.29289 2.79289L9.20711 5.70711C9.39464 5.89464 9.5 6.149 9.5 6.41421Z' stroke='currentColor'/%3e%3c/svg%3e"),onSelect:async()=>{await e.invoke("doc.open")}},{},{text:Yx("file.save"),icon:XA(qA),isEnabled:()=>e.invoke("doc.name"),onSelect:async()=>await e.invoke("doc.save")},{text:Yx("file.save-as"),icon:XA(qA),isEnabled:()=>!e.invoke("scene.empty"),onSelect:async()=>await e.invoke("doc.saveAs")},{},{text:Yx("file.import"),icon:XA(WA),onSelect:async()=>{await e.invoke("scene.import")}},{text:Yx("file.export"),icon:XA(GA),subMenu:p},{text:Yx("file.publish"),icon:XA("data:image/svg+xml,%3csvg xmlns='http://www.w3.org/2000/svg' width='16' height='16' viewBox='0 0 12 12' fill='none'%3e %3cg transform='translate(0%2c 12) scale(1%2c -1)'%3e %3cpath fill-rule='evenodd' clip-rule='evenodd' d='M2.5 9C2.5 8.72386 2.72386 8.5 3 8.5L9 8.5C9.27614 8.5 9.5 8.72386 9.5 9C9.5 9.27614 9.27614 9.5 9 9.5L3 9.5C2.72386 9.5 2.5 9.27614 2.5 9ZM5.50001 6L4.90001 5.2C4.73432 4.97909 4.42092 4.93432 4.20001 5.1C3.9791 5.26569 3.93432 5.57909 4.10001 5.8L5.28001 7.37334C5.64001 7.85334 6.36001 7.85334 6.72001 7.37334L7.90001 5.8C8.06569 5.57909 8.02092 5.26569 7.80001 5.1C7.57909 4.93432 7.26569 4.97909 7.10001 5.2L6.50001 6.00001L6.50001 2.5C6.50001 2.22386 6.27615 2 6.00001 2C5.72387 2 5.50001 2.22386 5.50001 2.5L5.50001 6Z' fill='currentColor'/%3e %3c/g%3e%3c/svg%3e"),isEnabled:()=>!e.invoke("scene.empty"),onSelect:async()=>await e.invoke("show.publishSettingsDialog")}]),f=new UA([{text:Yx("select.all"),icon:XA("data:image/svg+xml,%3csvg width='16' height='16' viewBox='0 0 12 12' fill='none' xmlns='http://www.w3.org/2000/svg'%3e%3cpath fill-rule='evenodd' clip-rule='evenodd' d='M2.5 3C2.5 2.72386 2.72386 2.5 3 2.5H4C4.27614 2.5 4.5 2.27614 4.5 2C4.5 1.72386 4.27614 1.5 4 1.5H3C2.17157 1.5 1.5 2.17157 1.5 3V4C1.5 4.27614 1.72386 4.5 2 4.5C2.27614 4.5 2.5 4.27614 2.5 4V3ZM8 1.5C7.72386 1.5 7.5 1.72386 7.5 2C7.5 2.27614 7.72386 2.5 8 2.5H9C9.27614 2.5 9.5 2.72386 9.5 3V4C9.5 4.27614 9.72386 4.5 10 4.5C10.2761 4.5 10.5 4.27614 10.5 4V3C10.5 2.17157 9.82843 1.5 9 1.5H8ZM2.5 8C2.5 7.72386 2.27614 7.5 2 7.5C1.72386 7.5 1.5 7.72386 1.5 8V9C1.5 9.82843 2.17157 10.5 3 10.5H4C4.27614 10.5 4.5 10.2761 4.5 10C4.5 9.72386 4.27614 9.5 4 9.5H3C2.72386 9.5 2.5 9.27614 2.5 9V8ZM10.5 8C10.5 7.72386 10.2761 7.5 10 7.5C9.72386 7.5 9.5 7.72386 9.5 8V9C9.5 9.27614 9.27614 9.5 9 9.5H8C7.72386 9.5 7.5 9.72386 7.5 10C7.5 10.2761 7.72386 10.5 8 10.5H9C9.82843 10.5 10.5 9.82843 10.5 9V8ZM4.5 3.5C3.94772 3.5 3.5 3.94772 3.5 4.5V7.5C3.5 8.05228 3.94772 8.5 4.5 8.5H7.5C8.05228 8.5 8.5 8.05228 8.5 7.5V4.5C8.5 3.94772 8.05228 3.5 7.5 3.5H4.5Z' fill='currentColor'/%3e%3c/svg%3e"),extra:"Ctrl + A",onSelect:()=>e.fire("select.all")},{text:Yx("select.none"),icon:XA("data:image/svg+xml,%3csvg width='16' height='16' viewBox='0 0 12 12' fill='none' xmlns='http://www.w3.org/2000/svg'%3e%3cpath fill-rule='evenodd' clip-rule='evenodd' d='M3 2.5C2.72386 2.5 2.5 2.72386 2.5 3V4C2.5 4.27614 2.27614 4.5 2 4.5C1.72386 4.5 1.5 4.27614 1.5 4V3C1.5 2.17157 2.17157 1.5 3 1.5H4C4.27614 1.5 4.5 1.72386 4.5 2C4.5 2.27614 4.27614 2.5 4 2.5H3ZM7.5 2C7.5 1.72386 7.72386 1.5 8 1.5H9C9.82843 1.5 10.5 2.17157 10.5 3V4C10.5 4.27614 10.2761 4.5 10 4.5C9.72386 4.5 9.5 4.27614 9.5 4V3C9.5 2.72386 9.27614 2.5 9 2.5H8C7.72386 2.5 7.5 2.27614 7.5 2ZM2 7.5C2.27614 7.5 2.5 7.72386 2.5 8V9C2.5 9.27614 2.72386 9.5 3 9.5H4C4.27614 9.5 4.5 9.72386 4.5 10C4.5 10.2761 4.27614 10.5 4 10.5H3C2.17157 10.5 1.5 9.82843 1.5 9V8C1.5 7.72386 1.72386 7.5 2 7.5ZM10 7.5C10.2761 7.5 10.5 7.72386 10.5 8V9C10.5 9.82843 9.82843 10.5 9 10.5H8C7.72386 10.5 7.5 10.2761 7.5 10C7.5 9.72386 7.72386 9.5 8 9.5H9C9.27614 9.5 9.5 9.27614 9.5 9V8C9.5 7.72386 9.72386 7.5 10 7.5Z' fill='currentColor'/%3e%3c/svg%3e"),extra:"Shift + A",onSelect:()=>e.fire("select.none")},{text:Yx("select.invert"),icon:XA("data:image/svg+xml,%3csvg width='16' height='16' viewBox='0 0 12 12' fill='none' xmlns='http://www.w3.org/2000/svg'%3e%3cpath fill-rule='evenodd' clip-rule='evenodd' d='M2.5 3C2.5 2.72386 2.72386 2.5 3 2.5H4C4.27614 2.5 4.5 2.27614 4.5 2C4.5 1.72386 4.27614 1.5 4 1.5H3C2.17157 1.5 1.5 2.17157 1.5 3V4C1.5 4.27614 1.72386 4.5 2 4.5C2.27614 4.5 2.5 4.27614 2.5 4V3ZM8 1.5C7.72386 1.5 7.5 1.72386 7.5 2C7.5 2.27614 7.72386 2.5 8 2.5H9C9.27614 2.5 9.5 2.72386 9.5 3V4C9.5 4.27614 9.72386 4.5 10 4.5C10.2761 4.5 10.5 4.27614 10.5 4V3C10.5 2.17157 9.82843 1.5 9 1.5H8ZM2.5 8C2.5 7.72386 2.27614 7.5 2 7.5C1.72386 7.5 1.5 7.72386 1.5 8V9C1.5 9.82843 2.17157 10.5 3 10.5H4C4.27614 10.5 4.5 10.2761 4.5 10C4.5 9.72386 4.27614 9.5 4 9.5H3C2.72386 9.5 2.5 9.27614 2.5 9V8ZM10.5 8C10.5 7.72386 10.2761 7.5 10 7.5C9.72386 7.5 9.5 7.72386 9.5 8V9C9.5 9.27614 9.27614 9.5 9 9.5H8C7.72386 9.5 7.5 9.72386 7.5 10C7.5 10.2761 7.72386 10.5 8 10.5H9C9.82843 10.5 10.5 9.82843 10.5 9V8ZM4.5 3.5C3.94772 3.5 3.5 3.94772 3.5 4.5V7.5C3.5 8.05228 3.94772 8.5 4.5 8.5H7.5C8.05228 8.5 8.5 8.05228 8.5 7.5V4.5C8.5 3.94772 8.05228 3.5 7.5 3.5H4.5ZM4.5 4.5H7.5V7.5H4.5V4.5Z' fill='currentColor'/%3e%3c/svg%3e"),extra:"Ctrl + I",onSelect:()=>e.fire("select.invert")},{},{text:Yx("select.lock"),icon:XA("data:image/svg+xml,%3csvg width='16' height='16' viewBox='0 0 12 12' fill='none' xmlns='http://www.w3.org/2000/svg'%3e%3crect x='3' y='6' width='6' height='4' rx='1' stroke='currentColor'/%3e%3cpath d='M8 6V4C8 2.89543 7.10457 2 6 2V2C4.89543 2 4 2.89543 4 4V6' stroke='currentColor'/%3e%3cpath d='M7 8C7 8.55228 6.55228 9 6 9V9C5.44772 9 5 8.55228 5 8V8C5 7.44772 5.44772 7 6 7V7C6.55228 7 7 7.44772 7 8V8Z' fill='currentColor'/%3e%3c/svg%3e"),extra:"H",isEnabled:()=>e.invoke("selection.splats"),onSelect:()=>e.fire("select.hide")},{text:Yx("select.unlock"),icon:XA("data:image/svg+xml,%3csvg width='16' height='16' viewBox='0 0 12 12' fill='none' xmlns='http://www.w3.org/2000/svg'%3e%3crect x='3' y='6' width='6' height='4' rx='1' stroke='currentColor'/%3e%3cpath d='M8 6V4C8 2.89543 7.10457 2 6 2V2C4.89543 2 4 2.89543 4 4V4' stroke='currentColor'/%3e%3cpath d='M7 8C7 8.55228 6.55228 9 6 9V9C5.44772 9 5 8.55228 5 8V8C5 7.44772 5.44772 7 6 7V7C6.55228 7 7 7.44772 7 8V8Z' fill='currentColor'/%3e%3c/svg%3e"),extra:"U",onSelect:()=>e.fire("select.unhide")},{text:Yx("select.delete"),icon:XA(HA),extra:"Delete",isEnabled:()=>e.invoke("selection.splats"),onSelect:()=>e.fire("select.delete")},{text:Yx("select.reset"),onSelect:()=>e.fire("scene.reset")},{},{text:Yx("select.duplicate"),icon:XA("data:image/svg+xml,%3csvg width='16' height='16' viewBox='0 0 12 12' fill='none' xmlns='http://www.w3.org/2000/svg'%3e%3cpath d='M4.49999 5H5.49999V6.5H6.99999V7.5H5.49999V9H4.49999V7.5H2.99999V6.5H4.49999V5Z' fill='currentColor'/%3e%3cpath fill-rule='evenodd' clip-rule='evenodd' d='M9 9H9.49999C10.3284 9 11 8.32843 11 7.5V2.5C11 1.67157 10.3284 1 9.49999 1H4.49999C3.67157 1 2.99999 1.67157 2.99999 2.5V3H2.5C1.67157 3 1 3.67157 1 4.5V9.5C1 10.3284 1.67157 11 2.5 11H7.5C8.32843 11 9 10.3284 9 9.5V9ZM4.49999 2C4.22385 2 3.99999 2.22386 3.99999 2.5V3H7.5C8.32843 3 9 3.67157 9 4.5V8H9.49999C9.77614 8 9.99999 7.77614 9.99999 7.5V2.5C9.99999 2.22386 9.77614 2 9.49999 2H4.49999ZM2 4.5C2 4.22386 2.22386 4 2.5 4H7.5C7.77614 4 8 4.22386 8 4.5V9.5C8 9.77614 7.77614 10 7.5 10H2.5C2.22386 10 2 9.77614 2 9.5V4.5Z' fill='currentColor'/%3e%3c/svg%3e"),isEnabled:()=>e.invoke("selection.splats"),onSelect:()=>e.fire("select.duplicate")},{text:Yx("select.separate"),icon:XA("data:image/svg+xml,%3csvg width='16' height='16' viewBox='-1 -1 11 11' fill='none' xmlns='http://www.w3.org/2000/svg'%3e%3cpath fill-rule='evenodd' clip-rule='evenodd' d='M2.66421 0C2.26639 0 1.88486 0.158035 1.60355 0.43934L0.43934 1.60355C0.158035 1.88486 0 2.26639 0 2.66421V6.5C0 7.32843 0.671573 8 1.5 8H6.5C7.32843 8 8 7.32843 8 6.5V1.5C8 0.671573 7.32843 0 6.5 0H5.5H3.5H2.66421ZM3 1H2.66421C2.53161 1 2.40443 1.05268 2.31066 1.14645L1.14645 2.31066C1.05268 2.40443 1 2.53161 1 2.66421V6.5C1 6.77614 1.22386 7 1.5 7H6.5C6.77614 7 7 6.77614 7 6.5V1.5C7 1.22386 6.77614 1 6.5 1H6V2.5C6 2.77614 5.77614 3 5.5 3H3.5C3.22386 3 3 2.77614 3 2.5V1Z' fill='currentColor'/%3e%3c/svg%3e"),isEnabled:()=>e.invoke("selection.splats"),onSelect:()=>e.fire("select.separate")}]),g=new UA([{text:Yx("render.image"),icon:XA(GA),onSelect:()=>e.invoke("render.image")},{text:Yx("render.video"),icon:XA(GA),onSelect:async()=>await e.invoke("show.videoSettingsDialog")}]),v=new UA([{text:Yx("help.shortcuts"),icon:"E136",onSelect:()=>e.fire("show.shortcuts")},{text:Yx("help.user-guide"),icon:"E232",onSelect:()=>window.open("https://github.com/playcanvas/supersplat/wiki","_blank").focus()},{text:Yx("help.log-issue"),icon:"E336",onSelect:()=>window.open("https://github.com/playcanvas/supersplat/issues","_blank").focus()},{text:Yx("help.github-repo"),icon:"E259",onSelect:()=>window.open("https://github.com/playcanvas/supersplat","_blank").focus()},{},{text:Yx("help.basics-video"),icon:"E261",onSelect:()=>window.open("https://youtu.be/MwzaEM2I55I","_blank").focus()},{},{text:Yx("help.discord"),icon:"E233",onSelect:()=>window.open("https://discord.gg/T3pnhRTTAY","_blank").focus()},{text:Yx("help.forum"),icon:"E432",onSelect:()=>window.open("https://forum.playcanvas.com","_blank").focus()},{},{text:Yx("help.about"),icon:"E138",onSelect:()=>e.invoke("show.about")}]);this.append(s),this.append(m),this.append(p),this.append(f),this.append(g),this.append(v);const _=[{dom:a.dom,menuPanel:m},{dom:o.dom,menuPanel:f},{dom:r.dom,menuPanel:g},{dom:l.dom,menuPanel:v}];_.forEach((e=>{const t=()=>{e.menuPanel.position(e.dom,"bottom",2),_.forEach((t=>{t.menuPanel.hidden=t!==e}))};e.dom.addEventListener("pointerdown",(s=>{e.menuPanel.hidden?t():e.menuPanel.hidden=!0})),e.dom.addEventListener("pointerenter",(e=>{_.every((e=>e.menuPanel.hidden))||t()}))}));const y=e=>{this.dom.contains(e.target)||_.forEach((e=>{e.menuPanel.hidden=!0}))};window.addEventListener("pointerdown",y,!0),window.addEventListener("pointerup",y,!0)}}var $A="data:image/svg+xml,%3csvg width='12' height='12' viewBox='0 0 12 12' fill='none' xmlns='http://www.w3.org/2000/svg'%3e %3cpath d='M2.70711 6.70711C2.31658 6.31658 2.31658 5.68342 2.70711 5.29289L5.29301 2.70699C5.68353 2.31647 6.3167 2.31647 6.70722 2.70699L9.29312 5.29289C9.68365 5.68342 9.68365 6.31658 9.29312 6.70711L6.70722 9.29301C6.3167 9.68353 5.68353 9.68353 5.29301 9.29301L2.70711 6.70711Z' fill='currentColor'/%3e%3c/svg%3e",KA="data:image/svg+xml,%3csvg width='12' height='12' viewBox='0 0 12 12' fill='none' xmlns='http://www.w3.org/2000/svg'%3e %3ccircle cx='6' cy='6' r='5' stroke='currentColor'/%3e %3cpath d='M3.70711 6.70711C3.31658 6.31658 3.31658 5.68342 3.70711 5.29289L5.29289 3.70711C5.68342 3.31658 6.31658 3.31658 6.70711 3.70711L8.29289 5.29289C8.68342 5.68342 8.68342 6.31658 8.29289 6.70711L6.70711 8.29289C6.31658 8.68342 5.68342 8.68342 5.29289 8.29289L3.70711 6.70711Z' fill='currentColor'/%3e%3c/svg%3e";const ZA=e=>{const t=decodeURIComponent(e.substring(19));return(new DOMParser).parseFromString(t,"image/svg+xml").documentElement};class JA extends P{constructor(e,t,s={}){super(s={id:"mode-toggle",class:"centers-mode",...s});const i=new x({id:"centers-icon",dom:ZA($A)}),n=new x({id:"rings-icon",dom:ZA(KA)}),a=new F({id:"centers-text",text:Yx("mode.centers")}),r=new F({id:"rings-text",text:Yx("mode.rings")});this.append(i),this.append(n),this.append(a),this.append(r),this.dom.addEventListener("pointerdown",(t=>{t.stopPropagation(),e.fire("camera.toggleMode"),e.fire("camera.setOverlay",!0)})),e.on("camera.mode",(e=>{this.class["centers"===e?"add":"remove"]("centers-mode"),this.class["rings"===e?"add":"remove"]("rings-mode")})),t.register(this,Yx("tooltip.splat-mode"))}}class QA extends P{show;hide;destroy;constructor(e,t={}){super(t={id:"popup",hidden:!0,tabIndex:-1,...t});const s=new P({id:"popup-dialog"}),i=new F({id:"popup-header"}),n=new F({id:"popup-text"}),a=new F({id:"popup-link-text"}),r=new w({id:"popup-link-copy",icon:"E351"}),o=new P({id:"popup-link-row"});o.append(a),o.append(r);const l=new w({class:"popup-button",text:Yx("popup.ok")}),h=new w({class:"popup-button",text:Yx("popup.cancel")}),c=new w({class:"popup-button",text:Yx("popup.yes")}),d=new w({class:"popup-button",text:Yx("popup.no")}),u=new P({id:"popup-buttons"});let p,m,f,g,v,_;u.append(l),u.append(h),u.append(c),u.append(d),s.append(i),s.append(n),s.append(o),s.append(u),this.append(s),l.on("click",(()=>{p()})),h.on("click",(()=>{m()})),c.on("click",(()=>{f()})),d.on("click",(()=>{g()})),this.on("click",(()=>{v()})),s.on("click",(e=>{e.stopPropagation()})),r.on("click",(()=>{_()})),this.show=e=>{i.text=e.header,n.text=e.message;const{type:t,link:s}=e;return["error","info","yesno","okcancel"].forEach((e=>{n.class[e===t?"add":"remove"](e)})),l.hidden="yesno"===t,h.hidden="okcancel"!==t,c.hidden="yesno"!==t,d.hidden="yesno"!==t,this.hidden=!1,o.hidden=void 0===s,void 0!==s&&(a.dom.innerHTML=`<a href='${s}' target='_blank'>${s}</a>`,r.icon="E352"),this.dom.focus(),new Promise((e=>{p=()=>{this.hide(),e({action:"ok"})},m=()=>{this.hide(),e({action:"cancel"})},f=()=>{this.hide(),e({action:"yes"})},g=()=>{this.hide(),e({action:"no"})},v=()=>{"info"===t&&void 0===s&&m()},_=()=>{navigator.clipboard.writeText(s),r.icon="E348"}}))},this.hide=()=>{this.hidden=!0},this.destroy=()=>{this.hide(),super.destroy()},e.register(r,Yx("popup.copy-to-clipboard"))}}class eT extends P{show;hide;destroy;constructor(e,t={}){super(t={...t,id:"publish-settings-dialog",class:"settings-dialog",hidden:!0,tabIndex:-1});const s=new P({id:"dialog"}),i=((e,t={})=>{const s=decodeURIComponent(e.substring(19));return new x({dom:(new DOMParser).parseFromString(s,"image/svg+xml").documentElement,...t})})(GA,{id:"icon"}),n=new F({id:"text",text:Yx("publish.header")}),a=new P({id:"header"});a.append(i),a.append(n);const r=new F({class:"label",text:Yx("publish.title")}),o=new se({class:"text-input"}),l=new P({class:"row"});l.append(r),l.append(o);const h=new F({class:"label",text:Yx("publish.description")}),c=new He({class:"text-area"}),d=new P({class:"row"});d.append(h),d.append(c);const u=new F({class:"label",text:Yx("publish.listed")}),p=new X({class:"boolean",value:!0}),m=new P({class:"row"});m.append(u),m.append(p);const f=new F({class:"label",text:Yx("export.start-position")}),g=new Pe({class:"select",defaultValue:"viewport",options:[{v:"default",t:Yx("export.default")},{v:"viewport",t:Yx("export.viewport")},{v:"pose",t:Yx("export.pose-camera")}]}),v=new P({class:"row"});v.append(f),v.append(g);const _=new F({class:"label",text:Yx("export.animation")}),y=new Pe({class:"select",defaultValue:"none",options:[{v:"none",t:Yx("export.animation-none")},{v:"track",t:Yx("export.animation-track")}]}),b=new P({class:"row"});b.append(_),b.append(y);const C=new F({class:"label",text:Yx("export.background-color")}),S=new ie({class:"color-picker",value:[1,1,1,1]}),A=new P({class:"row"});A.append(C),A.append(S);const T=new F({class:"label",text:Yx("export.fov")}),E=new Fe({class:"slider",min:10,max:120,precision:0,value:60}),k=new P({class:"row"});k.append(T),k.append(E);const M=new F({class:"label",text:Yx("export.sh-bands")}),I=new Fe({class:"slider",min:0,max:3,precision:0,value:3}),D=new P({class:"row"});D.append(M),D.append(I);const R=new P({id:"content"});R.append(l),R.append(d),R.append(m),R.append(v),R.append(b),R.append(A),R.append(k),R.append(D);const L=new P({id:"footer"}),B=new w({class:"button",text:Yx("publish.cancel")}),O=new w({class:"button",text:Yx("publish.ok")});let z,V;L.append(B),L.append(O),s.append(a),s.append(R),s.append(L),this.append(s),B.on("click",(()=>z())),O.on("click",(()=>V()));const N=e=>{switch(e.key){case"Escape":z();break;case"Enter":e.shiftKey||V();break;default:e.stopPropagation()}};this.show=()=>((()=>{const t=e.invoke("scene.splats"),s=t[0].filename,i=t[0].filename.lastIndexOf("."),n=e.invoke("camera.poses").length>0,a=e.invoke("bgClr");o.value=s.slice(0,i>0?i:void 0),c.value="",p.value=!0,g.value=n?"pose":"viewport",g.disabledOptions=n?{}:{pose:g.options[2].t},y.value=n?"track":"none",y.disabledOptions=n?{}:{track:y.options[1].t},S.value=[a.r,a.g,a.b],E.value=e.invoke("camera.fov"),I.value=e.invoke("view.bands")})(),this.hidden=!1,this.dom.addEventListener("keydown",N),this.dom.focus(),new Promise((t=>{z=()=>{t(null)},V=()=>{const s=e.invoke("timeline.frames"),i=e.invoke("timeline.frameRate"),n=e.invoke("camera.poses").slice().filter((e=>e.frame>=0&&e.frame<s)).sort(((e,t)=>e.frame-t.frame));let a;switch(g.value){case"pose":a=n?.[0];break;case"viewport":a=e.invoke("camera.getPose")}const r=a?.position,l=a?.target,h=(()=>{switch(y.value){case"none":return"none";case"track":return"animTrack"}})(),d=[];switch(h){case"none":break;case"animTrack":{const e=[],t=[],a=[];for(let s=0;s<n.length;++s){const i=n[s];e.push(i.frame),t.push(i.position.x,i.position.y,i.position.z),a.push(i.target.x,i.target.y,i.target.z)}d.push({name:"cameraAnim",duration:s/i,frameRate:i,target:"camera",loopMode:"repeat",interpolation:"spline",keyframes:{times:e,values:{position:t,target:a}}});break}}const u={camera:{fov:E.value,position:r?[r.x,r.y,r.z]:null,target:l?[l.x,l.y,l.z]:null,startAnim:h,animTrack:"animTrack"===h?"cameraAnim":null},background:{color:S.value.slice()},animTracks:d},m={maxSHBands:I.value,minOpacity:1/255,removeInvalid:!0};t({title:o.value,description:c.value,listed:p.value,serializeSettings:m,experienceSettings:u})}})).finally((()=>{this.dom.removeEventListener("keydown",N),this.hide()}))),this.hide=()=>{this.hidden=!0},this.destroy=()=>{this.hide(),super.destroy()}}}const tT=e=>{const t=decodeURIComponent(e.substring(19));return(new DOMParser).parseFromString(t,"image/svg+xml").documentElement};class sT extends P{constructor(e,t,s={}){super(s={...s,id:"right-toolbar"}),this.dom.addEventListener("pointerdown",(e=>{e.stopPropagation()}));const i=new w({id:"right-toolbar-mode-toggle",class:"right-toolbar-toggle"}),n=new w({id:"right-toolbar-show-hide",class:["right-toolbar-toggle","active"]}),a=new w({id:"right-toolbar-frame-selection",class:"right-toolbar-button"}),r=new w({id:"right-toolbar-camera-origin",class:"right-toolbar-button"}),o=new w({id:"right-toolbar-color-panel",class:"right-toolbar-toggle"}),l=new w({id:"right-toolbar-options",class:"right-toolbar-toggle",icon:"E283"}),h=tT($A),c=tT(KA);c.style.display="none",i.dom.appendChild(h),i.dom.appendChild(c),n.dom.appendChild(tT("data:image/svg+xml,%3csvg width='38' height='38' viewBox='0 0 38 38' fill='none' xmlns='http://www.w3.org/2000/svg'%3e%3cpath d='M12.5 14C12.5 12.8954 13.3954 12 14.5 12H24.5C25.6046 12 26.5 12.8954 26.5 14V24C26.5 25.1046 25.6046 26 24.5 26H14.5C13.3954 26 12.5 25.1046 12.5 24V14Z' stroke='currentColor' stroke-width='1.5' stroke-dasharray='4 2' fill-opacity='0' /%3e%3cpath fill-rule='evenodd' clip-rule='evenodd' d='M19.5 18C18.9477 18 18.5 18.4477 18.5 19C18.5 19.5523 18.9477 20 19.5 20C20.0523 20 20.5 19.5523 20.5 19C20.5 18.4477 20.0523 18 19.5 18ZM17.5 19C17.5 17.8954 18.3954 17 19.5 17C20.6046 17 21.5 17.8954 21.5 19C21.5 20.1046 20.6046 21 19.5 21C18.3954 21 17.5 20.1046 17.5 19Z' fill='currentColor'/%3e%3c/svg%3e")),a.dom.appendChild(tT("data:image/svg+xml,%3csvg width='38' height='38' viewBox='0 0 38 38' fill='none' xmlns='http://www.w3.org/2000/svg'%3e%3cpath d='M12 14C12 12.8954 12.8954 12 14 12H24C25.1046 12 26 12.8954 26 14V24C26 25.1046 25.1046 26 24 26H14C12.8954 26 12 25.1046 12 24V14Z' stroke='currentColor' stroke-width='1.5' stroke-dasharray='4 3' fill-opacity='0'/%3e%3cpath d='M15 16C15 15.4477 15.4477 15 16 15H22C22.5523 15 23 15.4477 23 16V22C23 22.5523 22.5523 23 22 23H16C15.4477 23 15 22.5523 15 22V16Z' fill='currentColor'/%3e%3c/svg%3e")),r.dom.appendChild(tT("data:image/svg+xml,%3csvg xmlns='http://www.w3.org/2000/svg' width='38' height='38' viewBox='0 0 38 38' fill='none'%3e%3cg transform='scale(2) translate(3.5%2c 3.25)'%3e %3cpath fill-rule='evenodd' clip-rule='evenodd' d='M6 1.5C6.27614 1.5 6.5 1.72386 6.5 2V6.22288L10.265 8.576C10.4992 8.72236 10.5704 9.03083 10.424 9.265C10.2776 9.49917 9.96917 9.57035 9.735 9.424L6 7.08962L2.265 9.424C2.03083 9.57035 1.72235 9.49917 1.576 9.265C1.42964 9.03083 1.50083 8.72236 1.735 8.576L5.5 6.22288V2C5.5 1.72386 5.72386 1.5 6 1.5Z' fill='currentColor'/%3e%3c/g%3e%3c/svg%3e")),o.dom.appendChild(tT("data:image/svg+xml,%3csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 24 24' fill='none'%3e %3cg transform='scale(0.5) translate(12 12)'%3e %3crect fill-rule='nonzero' x='0' y='0' width='24' height='24'%3e%3c/rect%3e %3cline x1='4' y1='7' x2='12' y2='7' stroke='currentColor' stroke-width='2' stroke-linecap='round'%3e%3c/line%3e %3cline x1='4' y1='17' x2='6' y2='17' stroke='currentColor' stroke-width='2' stroke-linecap='round'%3e%3c/line%3e %3cline x1='18' y1='7' x2='20' y2='7' stroke='currentColor' stroke-width='2' stroke-linecap='round'%3e%3c/line%3e %3cline x1='13' y1='17' x2='20' y2='17' stroke='currentColor' stroke-width='2' stroke-linecap='round'%3e%3c/line%3e %3ccircle stroke='currentColor' stroke-width='2' stroke-linecap='round' cx='15' cy='7' r='3'%3e%3c/circle%3e %3ccircle stroke='currentColor' stroke-width='2' stroke-linecap='round' cx='9' cy='17' r='3'%3e%3c/circle%3e %3c/g%3e%3c/svg%3e")),this.append(i),this.append(n),this.append(new x({class:"right-toolbar-separator"})),this.append(a),this.append(r),this.append(o),this.append(new x({class:"right-toolbar-separator"})),this.append(l),t.register(i,Yx("tooltip.splat-mode"),"left"),t.register(n,Yx("tooltip.show-hide"),"left"),t.register(a,Yx("tooltip.frame-selection"),"left"),t.register(r,Yx("tooltip.camera-reset"),"left"),t.register(o,Yx("tooltip.color-panel"),"left"),t.register(l,Yx("tooltip.view-options"),"left"),i.on("click",(()=>{e.fire("camera.toggleMode"),e.fire("camera.setOverlay",!0)})),n.on("click",(()=>e.fire("camera.toggleOverlay"))),a.on("click",(()=>e.fire("camera.focus"))),r.on("click",(()=>e.fire("camera.reset"))),o.on("click",(()=>e.fire("colorPanel.toggleVisible"))),l.on("click",(()=>e.fire("viewPanel.toggleVisible"))),e.on("camera.mode",(e=>{i.class["rings"===e?"add":"remove"]("active"),h.style.display="rings"===e?"none":"block",c.style.display="rings"===e?"block":"none"})),e.on("camera.overlay",(e=>{n.class[e?"add":"remove"]("active")})),e.on("colorPanel.visible",(e=>{o.class[e?"add":"remove"]("active")})),e.on("viewPanel.visible",(e=>{l.class[e?"add":"remove"]("active")}))}}const iT=e=>{const t=decodeURIComponent(e.substring(19));return(new DOMParser).parseFromString(t,"image/svg+xml").documentElement};class nT extends P{getName;setName;getSelected;setSelected;getVisible;setVisible;destroy;constructor(e,t={}){super(t={...t,class:["splat-item","visible"]});const s=new F({class:"splat-item-text",text:e}),i=new x({dom:iT("data:image/svg+xml,%3csvg width='16' height='16' viewBox='4 4 16 16' fill='none' xmlns='http://www.w3.org/2000/svg'%3e%3cpath fill-rule='evenodd' clip-rule='evenodd' d='M12 11C11.4477 11 11 11.4477 11 12C11 12.5523 11.4477 13 12 13C12.5523 13 13 12.5523 13 12C13 11.4477 12.5523 11 12 11ZM10 12C10 10.8954 10.8954 10 12 10C13.1046 10 14 10.8954 14 12C14 13.1046 13.1046 14 12 14C10.8954 14 10 13.1046 10 12Z' fill='currentColor'/%3e%3cpath fill-rule='evenodd' clip-rule='evenodd' d='M11.9999 9.5C9.64477 9.5 8.00887 10.9874 7.28843 11.8087C7.18771 11.9235 7.18771 12.0765 7.28843 12.1913C8.00887 13.0126 9.64477 14.5 11.9999 14.5C14.3551 14.5 15.991 13.0126 16.7114 12.1913C16.8121 12.0765 16.8121 11.9235 16.7114 11.8087C15.991 10.9874 14.3551 9.5 11.9999 9.5ZM6.53667 11.1492C7.32348 10.2523 9.21141 8.5 11.9999 8.5C14.7884 8.5 16.6764 10.2523 17.4632 11.1492C17.8949 11.6414 17.8949 12.3586 17.4632 12.8508C16.6764 13.7477 14.7884 15.5 11.9999 15.5C9.21141 15.5 7.32348 13.7477 6.53667 12.8508C6.10496 12.3586 6.10496 11.6414 6.53667 11.1492Z' fill='currentColor'/%3e%3c/svg%3e"),class:"splat-item-visible"}),n=new x({dom:iT("data:image/svg+xml,%3csvg width='16' height='16' viewBox='4 4 16 16' fill='none' xmlns='http://www.w3.org/2000/svg'%3e%3cpath fill-rule='evenodd' clip-rule='evenodd' d='M7.33313 10.6271C7.1272 10.4432 6.81112 10.461 6.62714 10.6669C6.44316 10.8728 6.4615 11.1894 6.66743 11.3734L6.66819 11.374L6.67032 11.3759L6.67705 11.3818L6.70021 11.4019C6.71991 11.4188 6.74808 11.4426 6.7843 11.4724C6.85671 11.5318 6.96148 11.6151 7.09523 11.7142C7.1782 11.7757 7.27253 11.8434 7.37741 11.9155L6.64645 12.6465C6.45118 12.8417 6.45118 13.1583 6.64645 13.3536C6.84171 13.5488 7.15829 13.5488 7.35355 13.3536L8.25285 12.4543C8.73378 12.7179 9.31351 12.9846 9.96266 13.1827L9.6318 15.1678C9.58641 15.4402 9.77042 15.6978 10.0428 15.7432C10.3152 15.7886 10.5728 15.6046 10.6182 15.3322L10.9382 13.4119C11.2804 13.468 11.6354 13.5 12 13.5C12.3646 13.5 12.7196 13.468 13.0618 13.4119L13.3818 15.3322C13.4272 15.6046 13.6848 15.7886 13.9572 15.7432C14.2296 15.6978 14.4136 15.4402 14.3682 15.1678L14.0373 13.1827C14.6865 12.9846 15.2662 12.7179 15.7472 12.4543L16.6464 13.3536C16.8417 13.5488 17.1583 13.5488 17.3536 13.3536C17.5488 13.1583 17.5488 12.8417 17.3536 12.6465L16.6226 11.9155C16.7275 11.8434 16.8218 11.7757 16.9048 11.7142C17.0385 11.6151 17.1433 11.5318 17.2157 11.4724C17.2519 11.4426 17.2801 11.4188 17.2998 11.4019L17.323 11.3818L17.3297 11.3759L17.3318 11.374L17.3331 11.3729C17.3333 11.3728 17.3331 11.3729 17 11L17.3331 11.3729C17.5391 11.1889 17.5568 10.8728 17.3729 10.6669C17.1889 10.461 16.8728 10.4433 16.6669 10.6271L16.664 10.6296L16.6486 10.643C16.6341 10.6554 16.6115 10.6746 16.5811 10.6995C16.5203 10.7494 16.4286 10.8224 16.3094 10.9108C16.0705 11.0878 15.7231 11.3251 15.2937 11.5624C14.4289 12.0403 13.2643 12.5 12 12.5C10.7357 12.5 9.57108 12.0403 8.7063 11.5624C8.27693 11.3251 7.92953 11.0878 7.69063 10.9108C7.57136 10.8224 7.47967 10.7494 7.41888 10.6995C7.38849 10.6746 7.36587 10.6554 7.35143 10.643L7.33598 10.6296L7.33313 10.6271ZM7.00028 10.9997C7.33313 10.6271 7.33323 10.6272 7.33313 10.6271L7.00028 10.9997ZM7 11L6.66743 11.3734C6.6673 11.3732 6.66688 11.3729 7 11Z' fill='currentColor'/%3e%3c/svg%3e"),class:"splat-item-visible",hidden:!0}),a=new x({dom:iT(HA),class:"splat-item-delete"});this.append(s),this.append(i),this.append(n),this.append(a),this.getName=()=>s.value,this.setName=e=>{s.value=e},this.getSelected=()=>this.class.contains("selected"),this.setSelected=e=>{e!==this.selected&&(e?(this.class.add("selected"),this.emit("select",this)):(this.class.remove("selected"),this.emit("unselect",this)))},this.getVisible=()=>this.class.contains("visible"),this.setVisible=e=>{e!==this.visible&&(i.hidden=!e,n.hidden=e,e?(this.class.add("visible"),this.emit("visible",this)):(this.class.remove("visible"),this.emit("invisible",this)))};const r=e=>{e.stopPropagation(),this.visible=!this.visible},o=e=>{e.stopPropagation(),this.emit("removeClicked",this)};i.dom.addEventListener("click",r),n.dom.addEventListener("click",r),a.dom.addEventListener("click",o),this.destroy=()=>{i.dom.removeEventListener("click",r),n.dom.removeEventListener("click",r),a.dom.removeEventListener("click",o)}}set name(e){this.setName(e)}get name(){return this.getName()}set selected(e){this.setSelected(e)}get selected(){return this.getSelected()}set visible(e){this.setVisible(e)}get visible(){return this.getVisible()}}class aT extends P{constructor(e,t={}){super(t={...t,class:"splat-list"});const s=new Map;e.on("scene.elementAdded",(t=>{if(t.type===xw.splat){const i=t,n=new nT(i.name);this.append(n),s.set(i,n),n.on("visible",(()=>{i.visible=!0,e.invoke("selection")||e.fire("selection",i)})),n.on("invisible",(()=>{i.visible=!1}))}})),e.on("scene.elementRemoved",(e=>{if(e.type===xw.splat){const t=e,i=s.get(t);i&&(this.remove(i),s.delete(t))}})),e.on("selection.changed",(e=>{s.forEach(((t,s)=>{t.selected=s===e}))})),e.on("splat.name",(e=>{const t=s.get(e);t&&(t.name=e.name)})),e.on("splat.visibility",(e=>{const t=s.get(e);t&&(t.visible=e.visible)})),this.on("click",(t=>{for(const[i,n]of s)if(t===n){e.fire("selection",i);break}})),this.on("removeClicked",(async t=>{let i;for(const[e,n]of s)if(t===n){i=e;break}if(!i)return;const n=await e.invoke("showPopup",{type:"yesno",header:"Remove Splat",message:`Are you sure you want to remove '${i.name}' from the scene? This operation can not be undone.`});"yes"===n?.action&&i.destroy()}))}_onAppendChild(e){super._onAppendChild(e),e instanceof nT&&(e.on("click",(()=>{this.emit("click",e)})),e.on("removeClicked",(()=>{this.emit("removeClicked",e)})))}_onRemoveChild(e){e instanceof nT&&(e.unbind("click"),e.unbind("removeClicked")),super._onRemoveChild(e)}}const rT=new yt;class oT extends P{constructor(e,t={}){super(t={...t,id:"transform"});const s=new P({class:"transform-row"}),i=new F({class:"transform-label",text:""}),n=new F({class:["transform-expand","transform-label","transform-axis-label"],text:"x"}),a=new F({class:["transform-expand","transform-label","transform-axis-label"],text:"y"}),r=new F({class:["transform-expand","transform-label","transform-axis-label"],text:"z"});s.append(i),s.append(n),s.append(a),s.append(r);const o=new P({class:"transform-row"}),l=new F({class:"transform-label",text:Yx("position")}),h=new Ge({class:"transform-expand",precision:3,dimensions:3,value:[0,0,0],enabled:!1});o.append(l),o.append(h);const c=new P({class:"transform-row"}),d=new F({class:"transform-label",text:Yx("rotation")}),u=new Ge({class:"transform-expand",precision:2,dimensions:3,value:[0,0,0],enabled:!1});c.append(d),c.append(u);const p=new P({class:"transform-row"}),m=new F({class:"transform-label",text:Yx("scale")}),f=new L({class:"transform-expand",precision:3,value:1,min:.001,max:1e4,enabled:!1});p.append(m),p.append(f),this.append(s),this.append(o),this.append(c),this.append(p);const g=e=>[e.x,e.y,e.z];let v=!1,_=!1;const y=e=>{v=!0;const t=e.transform;t.rotation.getEulerAngles(rT),h.value=g(t.position),u.value=g(rT),f.value=t.scale.x,v=!1},x=e=>{const t=h.value,s=u.value,i=(new kt).setFromEulerAngles(s[0],s[1],s[2]),n=f.value;i.w<0&&i.mulScalar(-1),e.moveTRS(new yt(t[0],t[1],t[2]),i,new yt(n,n,n))},w=()=>{if(!v){const t=e.invoke("pivot");_?x(t):(t.start(),x(t),t.end())}},b=()=>{_=!0;e.invoke("pivot").start()},C=()=>{const t=e.invoke("pivot");x(t),_=!1,t.end()};[h.inputs,u.inputs,f].flat().forEach((e=>{e.on("change",w),e.on("slider:mousedown",b),e.on("slider:mouseup",C)})),e.on("selection.changed",(e=>{h.enabled=u.enabled=f.enabled=!!e})),e.on("pivot.placed",(e=>{y(e)})),e.on("pivot.moved",(e=>{_||y(e)})),e.on("pivot.ended",(e=>{y(e)}))}}const lT=e=>{const t=decodeURIComponent(e.substring(19));return(new DOMParser).parseFromString(t,"image/svg+xml").documentElement};class hT extends P{constructor(e,t,s={}){super(s={...s,id:"scene-panel",class:"panel"}),["pointerdown","pointerup","pointermove","wheel","dblclick"].forEach((e=>{this.dom.addEventListener(e,(e=>e.stopPropagation()))}));const i=new P({class:"panel-header"}),n=new F({text:"",class:"panel-header-icon"}),a=new F({text:Yx("scene-manager"),class:"panel-header-label"}),r=new P({class:"panel-header-button"});r.dom.appendChild(lT(WA));const o=new P({class:"panel-header-button"});o.dom.appendChild(lT(jA)),i.append(n),i.append(a),i.append(r),i.append(o),r.on("click",(async()=>{await e.invoke("scene.import")})),o.on("click",(()=>{e.invoke("doc.new")})),t.register(r,"Import Scene","top"),t.register(o,"New Scene","top");const l=new aT(e),h=new P({class:"splat-list-container"});h.append(l);const c=new P({class:"panel-header"}),d=new F({text:"",class:"panel-header-icon"}),u=new F({text:Yx("transform"),class:"panel-header-label"});c.append(d),c.append(u),this.append(i),this.append(h),this.append(c),this.append(new oT(e)),this.append(new x({class:"panel-header",height:20}))}}const cT=[{header:"tools"},{key:"1",action:"move"},{key:"2",action:"rotate"},{key:"3",action:"scale"},{key:"R",action:"rect-selection"},{key:"B",action:"brush-selection"},{key:"P",action:"picker-selection"},{key:"[ ]",action:"brush-size"},{key:"Esc",action:"deactivate-tool"},{header:"selection"},{key:"Ctrl + A",action:"select-all"},{key:"Shift + A",action:"deselect-all"},{key:"Ctrl + I",action:"invert-selection"},{key:"Shift",action:"add-to-selection"},{key:"Ctrl",action:"remove-from-selection"},{key:"Delete",action:"delete-selected-splats"},{header:"show"},{key:"H",action:"hide-selected-splats"},{key:"U",action:"unhide-all-splats"},{key:"D",action:"toggle-data-panel"},{header:"other"},{key:"Tab",action:"select-next-splat"},{key:"Ctrl + Z",action:"undo"},{key:"Ctrl + Shift + Z",action:"redo"},{key:"Space",action:"toggle-splat-overlay"},{key:"F",action:"focus-camera"},{key:"M",action:"toggle-camera-mode"},{key:"G",action:"toggle-grid"},{key:"C",action:"toggle-gizmo-coordinate-space"}];class dT extends te{constructor(e={}){super(e={...e,id:"shortcuts-popup",clickable:!0,hidden:!0});const t=new P({id:"shortcuts-container"});cT.forEach((e=>{if(e.header){const s=new F({class:"shortcut-header-label",text:Yx(`shortcuts.${e.header}`)}),i=new P({class:"shortcut-header"});i.append(s),t.append(i)}else{const s=new F({class:"shortcut-key",text:e.key}),i=new F({class:"shortcut-action",text:Yx(`shortcuts.${e.action}`)}),n=new P({class:"shortcut-entry"});n.append(s),n.append(i),t.append(n)}}));const s=new G({id:"shortcuts-panel",headerText:Yx("shortcuts.title")});s.append(t),this.append(s)}}class uT extends P{constructor(e={}){super(e={...e,id:"spinner-container",hidden:!0}),this.dom.tabIndex=0;const t=new x({dom:"div",class:"spinner"});this.append(t),this.dom.addEventListener("keydown",(e=>{this.hidden||(e.stopPropagation(),e.preventDefault())}))}}class pT extends P{constructor(e,t,s={}){super(s={...s,id:"ticks"});const i=new P({id:"ticks-area"});let n,a,r,o;this.append(i);const l=()=>{i.dom.innerHTML="";const t=e.invoke("timeline.frames"),s=e.invoke("timeline.frame"),l=this.dom.getBoundingClientRect().width-40,h=Math.max(1,Math.floor(t/Math.max(1,Math.floor(l/50)))),c=Math.max(1,Math.ceil(t/h)),d=e=>20+Math.floor(e/(t-1)*l);r=e=>Math.max(0,Math.min(t-1,Math.floor((e-20)/l*(t-1))));for(let e=0;e<c;e++){const t=Math.floor(e*h),s=document.createElement("div");s.classList.add("time-label"),s.style.left=`${d(t)}px`,s.textContent=t.toString(),i.dom.appendChild(s)}const u=[],p=e=>{const t=document.createElement("div");t.classList.add("time-label","key"),t.style.left=`${d(e)}px`,i.dom.appendChild(t),u.push(t)};e.invoke("timeline.keys").forEach(p),n=e=>{p(e)},a=e=>{i.dom.removeChild(u[e]),u.splice(e,1)};const m=document.createElement("div");m.classList.add("time-label","cursor"),m.style.left=`${d(s)}px`,m.textContent=s.toString(),i.dom.appendChild(m),o=e=>{m.style.left=`${d(e)}px`,m.textContent=e.toString()}};let h=!1;i.dom.addEventListener("pointerdown",(t=>{!h&&t.isPrimary&&(h=!0,i.dom.setPointerCapture(t.pointerId),e.fire("timeline.setFrame",r(t.offsetX)))})),i.dom.addEventListener("pointermove",(t=>{h&&e.fire("timeline.setFrame",r(t.offsetX))})),i.dom.addEventListener("pointerup",(e=>{h&&e.isPrimary&&(i.dom.releasePointerCapture(e.pointerId),h=!1)})),new ResizeObserver((()=>l())).observe(i.dom),e.on("timeline.frames",(()=>{l()})),e.on("timeline.frame",(e=>{o(e)})),e.on("timeline.keyAdded",(e=>{n(e)})),e.on("timeline.keyRemoved",(e=>{a(e)}))}}class mT extends P{constructor(e,t,s={}){super(s={...s,id:"timeline-panel"});const i=new w({class:"button",text:""}),n=new w({class:"button",text:""}),a=new w({class:"button",text:""}),r=new w({class:"button",text:""}),o=new w({class:"button",text:"",enabled:!1}),l=new P({id:"button-controls"});l.append(i),l.append(n),l.append(a),l.append(r),l.append(o);const h=new Pe({id:"speed",defaultValue:30,options:[{v:1,t:"1 fps"},{v:6,t:"6 fps"},{v:12,t:"12 fps"},{v:24,t:"24 fps"},{v:30,t:"30 fps"},{v:60,t:"60 fps"}]});h.on("change",(t=>{e.fire("timeline.setFrameRate",parseInt(t,10))})),e.on("timeline.frameRate",(e=>{h.value=e.toString()}));const c=new L({id:"totalFrames",value:180,min:1,max:1e4,precision:0});c.on("change",(t=>{e.fire("timeline.setFrames",t)})),e.on("timeline.frames",(e=>{c.value=e}));const d=new P({id:"settings-controls"});d.append(h),d.append(c);const u=new P({id:"controls-wrap"}),p=new P({class:"spacer"}),m=new P({class:"spacer"});m.append(d),u.append(p),u.append(l),u.append(m);const f=new pT(e,t);this.append(u),this.append(f);const g=t=>{const s=e.invoke("timeline.keys").map(((e,t)=>({frame:e,index:t}))).sort(((e,t)=>e.frame-t.frame));if(s.length>0){const i=e.invoke("timeline.frame"),n=s.findIndex((e=>"back"===t?e.frame>=i:e.frame>i)),a=s.length;-1===n?e.fire("timeline.setFrame",s["back"===t?a-1:0].frame):e.fire("timeline.setFrame",s["back"===t?(n+a-1)%a:n].frame)}else"back"===t?e.fire("timeline.setFrame",0):e.fire("timeline.setFrame",e.invoke("timeline.frames")-1)};i.on("click",(()=>{g("back")})),n.on("click",(()=>{e.invoke("timeline.playing")?(e.fire("timeline.setPlaying",!1),n.text=""):(e.fire("timeline.setPlaying",!0),n.text="")})),a.on("click",(()=>{g("forward")})),r.on("click",(()=>{e.fire("timeline.add",e.invoke("timeline.frame"))})),o.on("click",(()=>{const t=e.invoke("timeline.keys").indexOf(e.invoke("timeline.frame"));-1!==t&&e.fire("timeline.remove",t)}));const v=t=>e.invoke("timeline.keys").includes(t);e.on("timeline.frame",(e=>{o.enabled=v(e)})),e.on("timeline.keyRemoved",(t=>{o.enabled=v(e.invoke("timeline.frame"))})),e.on("timeline.keyAdded",(e=>{o.enabled=v(e)})),e.on("camera.controller",(t=>{e.invoke("timeline.playing")}))}}class fT extends P{register;unregister;destroy;constructor(e={}){super(e={...e,class:"tooltips",hidden:!0});const t=new F({class:"tooltips-content"});this.append(t);const s=new Map,i=this.dom.style;let n=0;this.register=(e,a,r="bottom")=>{const o=()=>{const s=e.dom.getBoundingClientRect(),n=Math.floor(.5*(s.left+s.right)),o=Math.floor(.5*(s.top+s.bottom));switch(r){case"left":i.left=`${s.left}px`,i.top=`${o}px`,i.transform="translate(calc(-100% - 10px), -50%)";break;case"right":i.left=`${s.right}px`,i.top=`${o}px`,i.transform="translate(10px, -50%)";break;case"top":i.left=`${n}px`,i.top=`${s.top}px`,i.transform="translate(-50%, calc(-100% - 10px))";break;case"bottom":i.left=`${n}px`,i.top=`${s.bottom}px`,i.transform="translate(-50%, 10px)"}t.text=a,i.display="inline"},l=e=>{n=window.setTimeout((()=>{e(),n=-1}),250)},h=()=>{n>=0&&(clearTimeout(n),n=-1)},c=()=>{h(),"inline"===i.display?o():l((()=>o()))},d=()=>{h(),"inline"===i.display&&l((()=>{i.display="none"}))};e.dom.addEventListener("pointerenter",c),e.dom.addEventListener("pointerleave",d),e.on("destroy",(()=>{this.unregister(e)})),s.set(e,{enter:c,leave:d})},this.unregister=e=>{const t=s.get(e);t&&(e.dom.removeEventListener("pointerenter",t.enter),e.dom.removeEventListener("pointerleave",t.leave),s.delete(e))},this.destroy=()=>{for(const e of s.keys())this.unregister(e)}}}class gT extends P{show;hide;destroy;constructor(e,t={}){super(t={...t,id:"video-settings-dialog",class:"settings-dialog",hidden:!0,tabIndex:-1});const s=new P({id:"dialog"}),i=((e,t={})=>{const s=decodeURIComponent(e.substring(19));return new x({dom:(new DOMParser).parseFromString(s,"image/svg+xml").documentElement,...t})})(GA,{id:"icon"}),n=new F({id:"text",text:Yx("video.header")}),a=new P({id:"header"});a.append(i),a.append(n);const r=new F({class:"label",text:Yx("video.resolution")}),o=new Pe({class:"select",defaultValue:"1080",options:[{v:"540",t:"960x540"},{v:"720",t:"1280x720"},{v:"1080",t:"1920x1080"},{v:"1440",t:"2560x1440"},{v:"4k",t:"3840x2160"}]}),l=new P({class:"row"});l.append(r),l.append(o);const h=new F({class:"label",text:Yx("video.bitrate")}),c=new Pe({class:"select",defaultValue:"high",options:[{v:"low",t:"Low"},{v:"medium",t:"Medium"},{v:"high",t:"High"},{v:"ultra",t:"Ultra"}]}),d=new P({class:"row"});d.append(h),d.append(c);const u=new F({class:"label",text:Yx("video.portrait")}),p=new X({class:"boolean",value:!1}),m=new P({class:"row"});m.append(u),m.append(p);const f=new F({class:"label",text:Yx("video.transparentBg")}),g=new X({class:"boolean",value:!1}),v=new P({class:"row"});v.append(f),v.append(g),v.hidden=!0;const _=new F({class:"label",text:Yx("video.showDebug")}),y=new X({class:"boolean",value:!1}),b=new P({class:"row"});b.append(_),b.append(y);const C=new P({id:"content"});C.append(l),C.append(d),C.append(m),C.append(v),C.append(b);const S=new P({id:"footer"}),A=new w({class:"button",text:Yx("render.cancel")}),T=new w({class:"button",text:Yx("render.ok")});let E,k;S.append(A),S.append(T),s.append(a),s.append(C),s.append(S),this.append(s),A.on("click",(()=>E())),T.on("click",(()=>k()));const M=e=>{switch(e.key){case"Escape":E();break;case"Enter":e.shiftKey||k();break;default:e.stopPropagation()}};this.show=()=>(this.hidden=!1,this.dom.addEventListener("keydown",M),this.dom.focus(),new Promise((t=>{E=()=>{t(null)},k=()=>{const s={540:960,720:1280,1080:1920,1440:2560,"4k":3840},i={540:540,720:720,1080:1080,1440:1440,"4k":2160},n=p.value,a=(n?i:s)[o.value],r=(n?s:i)[o.value],l=e.invoke("timeline.frameRate"),h={low:.001,medium:.01,high:.1,ultra:1}[c.value]*{540:1,720:.5,1080:1/3,1440:1/4,"4k":.2}[o.value],d=Math.floor(10*a*r*l*h);console.log(d);const u={startFrame:0,endFrame:e.invoke("timeline.frames")-1,frameRate:l,width:a,height:r,bitrate:d,transparentBg:g.value,showDebug:y.value};t(u)}})).finally((()=>{this.dom.removeEventListener("keydown",M),this.hide()}))),this.hide=()=>{this.hidden=!0},this.destroy=()=>{this.hide(),super.destroy()}}}const vT=new yt,_T=new yt,yT=new yt,xT=new Et;class wT extends P{update;constructor(e,t={}){super(t={...t,id:"view-cube-container"});const s=document.createElementNS("http://www.w3.org/2000/svg","svg");s.id="view-cube-svg";const i=document.createElementNS(s.namespaceURI,"g");s.appendChild(i);const n=(e,t,n)=>{const a=document.createElementNS(s.namespaceURI,"g"),r=document.createElementNS(s.namespaceURI,"circle");if(r.setAttribute("fill",t?e:"#555"),r.setAttribute("stroke",e),r.setAttribute("stroke-width","2"),r.setAttribute("r","10"),r.setAttribute("cx","0"),r.setAttribute("cy","0"),r.setAttribute("pointer-events","all"),a.appendChild(r),n){const e=document.createElementNS(s.namespaceURI,"text");e.setAttribute("font-size","10"),e.setAttribute("font-family","Arial"),e.setAttribute("font-weight","bold"),e.setAttribute("text-anchor","middle"),e.setAttribute("alignment-baseline","central"),e.textContent=n,a.appendChild(e)}return a.setAttribute("cursor","pointer"),i.appendChild(a),a},a=e=>{const t=document.createElementNS(s.namespaceURI,"line");return t.setAttribute("stroke",e),t.setAttribute("stroke-width","2"),i.appendChild(t),t},r="#f44",o="#4f4",l="#77f",h={nx:n(r,!1),ny:n(o,!1),nz:n(l,!1),xaxis:a(r),yaxis:a(o),zaxis:a(l),px:n(r,!0,"X"),py:n(o,!0,"Y"),pz:n(l,!0,"Z")};h.px.children[0].addEventListener("pointerdown",(t=>{e.fire("camera.align","px"),t.stopPropagation()})),h.py.children[0].addEventListener("pointerdown",(t=>{e.fire("camera.align","py"),t.stopPropagation()})),h.pz.children[0].addEventListener("pointerdown",(t=>{e.fire("camera.align","pz"),t.stopPropagation()})),h.nx.children[0].addEventListener("pointerdown",(t=>{e.fire("camera.align","nx"),t.stopPropagation()})),h.ny.children[0].addEventListener("pointerdown",(t=>{e.fire("camera.align","ny"),t.stopPropagation()})),h.nz.children[0].addEventListener("pointerdown",(t=>{e.fire("camera.align","nz"),t.stopPropagation()})),this.dom.appendChild(s);let c=0,d=0;this.update=e=>{const t=this.dom.clientWidth,n=this.dom.clientHeight;if(t&&n){t===c&&n===d||(s.setAttribute("width",t.toString()),s.setAttribute("height",n.toString()),i.setAttribute("transform",`translate(${.5*t}, ${.5*n})`),c=t,d=n),xT.invert(e),xT.getX(vT),xT.getY(_T),xT.getZ(yT);const a=(e,t,s)=>{e.setAttribute("transform",`translate(${40*t}, ${40*s})`)},r=(e,t,s)=>{e.setAttribute("x2",(40*t).toString()),e.setAttribute("y2",(40*s).toString())};a(h.px,vT.x,-vT.y),a(h.nx,-vT.x,vT.y),a(h.py,_T.x,-_T.y),a(h.ny,-_T.x,_T.y),a(h.pz,yT.x,-yT.y),a(h.nz,-yT.x,yT.y),r(h.xaxis,vT.x,-vT.y),r(h.yaxis,_T.x,-_T.y),r(h.zaxis,yT.x,-yT.y);const o=[{n:["xaxis","px"],value:vT.z},{n:["yaxis","py"],value:_T.z},{n:["zaxis","pz"],value:yT.z},{n:["nx"],value:-vT.z},{n:["ny"],value:-_T.z},{n:["nz"],value:-yT.z}].sort(((e,t)=>e.value-t.value)),l=document.createDocumentFragment();o.forEach((e=>{e.n.forEach((e=>{l.appendChild(h[e])}))})),i.appendChild(l)}}}}class bT extends P{constructor(e,t,s={}){super(s={...s,id:"view-panel",class:"panel",hidden:!0}),["pointerdown","pointerup","pointermove","wheel","dblclick"].forEach((e=>{this.dom.addEventListener(e,(e=>e.stopPropagation()))}));const i=new P({class:"panel-header"}),n=new F({text:"",class:"panel-header-icon"}),a=new F({text:Yx("options"),class:"panel-header-label"});i.append(n),i.append(a);const r=new P({class:"view-panel-row"}),o=new F({text:Yx("options.colors"),class:"view-panel-row-label"}),l=new P({class:"view-panel-row-pickers"}),h=new ie({class:"view-panel-row-picker",channels:3}),c=new ie({class:"view-panel-row-picker",channels:4}),d=new ie({class:"view-panel-row-picker",channels:4}),u=new ie({class:"view-panel-row-picker",channels:4}),p=e=>[e.r,e.g,e.b,e.a];e.on("bgClr",(e=>{h.value=p(e)})),e.on("selectedClr",(e=>{c.value=p(e)})),e.on("unselectedClr",(e=>{d.value=p(e)})),e.on("lockedClr",(e=>{u.value=p(e)})),l.append(h),l.append(c),l.append(d),l.append(u),r.append(o),r.append(l);const m=new P({class:"view-panel-row"}),f=new F({text:Yx("options.tonemapping"),class:"view-panel-row-label"}),g=new Pe({class:"view-panel-row-select",defaultValue:"none",options:[{v:"none",t:Yx("options.tonemapping-none")},{v:"linear",t:Yx("options.tonemapping-linear")},{v:"neutral",t:Yx("options.tonemapping-neutral")},{v:"aces",t:Yx("options.tonemapping-aces")},{v:"aces2",t:Yx("options.tonemapping-aces2")},{v:"filmic",t:Yx("options.tonemapping-filmic")},{v:"hejl",t:Yx("options.tonemapping-hejl")}]});m.append(f),m.append(g);const v=new P({class:"view-panel-row"}),_=new F({text:Yx("options.fov"),class:"view-panel-row-label"}),y=new Fe({class:"view-panel-row-slider",min:10,max:120,precision:1,value:60});v.append(_),v.append(y);const x=new P({class:"view-panel-row"}),w=new F({text:Yx("options.sh-bands"),class:"view-panel-row-label"}),b=new Fe({class:"view-panel-row-slider",min:0,max:3,precision:0,value:3});x.append(w),x.append(b);const C=new P({class:"view-panel-row"}),S=new F({text:Yx("options.centers-size"),class:"view-panel-row-label"}),A=new Fe({class:"view-panel-row-slider",min:0,max:10,precision:1,value:2});C.append(S),C.append(A);const T=new P({class:"view-panel-row"}),E=new F({text:Yx("options.camera-fly-speed"),class:"view-panel-row-label"}),k=new Fe({class:"view-panel-row-slider",min:.1,max:30,precision:1,value:5});T.append(E),T.append(k);const M=new P({class:"view-panel-row"}),I=new F({text:Yx("options.outline-selection"),class:"view-panel-row-label"}),D=new X({type:"toggle",class:"view-panel-row-toggle",value:!1});M.append(I),M.append(D);const R=new P({class:"view-panel-row"}),L=new F({text:Yx("options.show-grid"),class:"view-panel-row-label"}),B=new X({type:"toggle",class:"view-panel-row-toggle",value:!0});R.append(L),R.append(B);const O=new P({class:"view-panel-row"}),z=new F({text:Yx("options.show-bound"),class:"view-panel-row-label"}),V=new X({type:"toggle",class:"view-panel-row-toggle",value:!0});O.append(z),O.append(V),this.append(i),this.append(r),this.append(m),this.append(v),this.append(x),this.append(C),this.append(T),this.append(M),this.append(R),this.append(O);const N=t=>{t===this.hidden&&(this.hidden=!t,e.fire("viewPanel.visible",t))};e.function("viewPanel.visible",(()=>!this.hidden)),e.on("viewPanel.setVisible",(e=>{N(e)})),e.on("viewPanel.toggleVisible",(()=>{N(this.hidden)})),e.on("colorPanel.visible",(e=>{e&&N(!1)})),e.on("view.bands",(e=>{b.value=e})),b.on("change",(t=>{e.fire("view.setBands",t)})),e.on("camera.splatSize",(e=>{A.value=e})),A.on("change",(t=>{e.fire("camera.setSplatSize",t),e.fire("camera.setOverlay",!0),e.fire("camera.setMode","centers")})),e.on("camera.flySpeed",(e=>{k.value=e})),k.on("change",(t=>{e.fire("camera.setFlySpeed",t)})),e.on("view.outlineSelection",(e=>{D.value=e})),D.on("change",(t=>{e.fire("view.setOutlineSelection",t)})),e.on("grid.visible",(e=>{B.value=e})),B.on("change",(()=>{e.fire("grid.setVisible",B.value)})),e.on("camera.bound",(e=>{V.value=e})),V.on("change",(()=>{e.fire("camera.setBound",V.value)})),h.on("change",(t=>{e.fire("setBgClr",new mt(t[0],t[1],t[2]))})),c.on("change",(t=>{e.fire("setSelectedClr",new mt(t[0],t[1],t[2],t[3]))})),d.on("change",(t=>{e.fire("setUnselectedClr",new mt(t[0],t[1],t[2],t[3]))})),u.on("change",(t=>{e.fire("setLockedClr",new mt(t[0],t[1],t[2],t[3]))})),e.on("camera.fov",(e=>{y.value=e})),y.on("change",(t=>{e.fire("camera.setFov",t)})),e.on("camera.tonemapping",(e=>{g.value=e})),g.on("change",(t=>{e.fire("camera.setTonemapping",t)})),t.register(h,Yx("options.bg-color"),"left"),t.register(c,Yx("options.selected-color"),"top"),t.register(d,Yx("options.unselected-color"),"top"),t.register(u,Yx("options.locked-color"),"top")}}class CT extends P{show;hide;destroy;constructor(e,t={}){super(t={id:"export-popup",hidden:!0,tabIndex:-1,...t});const s=new P({id:"dialog"}),i=new P({id:"header"}),n=new F({id:"header",text:Yx("export.header")});i.append(((e,t={})=>{const s=decodeURIComponent(e.substring(19));return new x({dom:(new DOMParser).parseFromString(s,"image/svg+xml").documentElement,...t})})(GA,{id:"icon"})),i.append(n);const a=new P({id:"content"}),r=new P({class:"row"}),o=new F({class:"label",text:Yx("export.type")}),l=new Pe({class:"select",defaultValue:"html",options:[{v:"html",t:Yx("export.html")},{v:"zip",t:Yx("export.package")}]});r.append(o),r.append(l);const h=new P({class:"row"}),c=new F({class:"label",text:Yx("export.version-type")}),d=new Pe({class:"select",defaultValue:"dev",options:[{v:"dev",t:Yx("export.version-dev")},{v:"client",t:Yx("export.version-client")},{v:"both",t:Yx("export.version-both")}]});h.append(c),h.append(d);const u=new P({class:"row"}),p=new F({class:"label",text:Yx("export.sh-bands")}),m=new Fe({class:"slider",min:0,max:3,precision:0,value:3});u.append(p),u.append(m);const f=new P({class:"row"}),g=new F({class:"label",text:Yx("export.start-position")}),v=new Pe({class:"select",defaultValue:"viewport",options:[{v:"default",t:Yx("export.default")},{v:"viewport",t:Yx("export.viewport")},{v:"pose",t:Yx("export.pose-camera")}]});f.append(g),f.append(v);const _=new F({class:"label",text:Yx("export.animation")}),y=new Pe({class:"select",defaultValue:"none",options:[{v:"none",t:Yx("export.animation-none")},{v:"track",t:Yx("export.animation-track")}]}),b=new P({class:"row"});b.append(_),b.append(y);const C=new P({class:"row"}),S=new F({class:"label",text:Yx("export.background-color")}),A=new ie({class:"color-picker",value:[1,1,1,1]});C.append(S),C.append(A);const T=new P({class:"row"}),E=new F({class:"label",text:Yx("export.fov")}),k=new Fe({class:"slider",min:10,max:120,precision:0,value:60});T.append(E),T.append(k);const M=new P({class:"row"}),I=new F({class:"label",text:Yx("export.filename")}),D=new se({class:"text-input"});M.append(I),M.append(D),a.append(r),a.append(h),a.append(u),a.append(f),a.append(b),a.append(C),a.append(T),a.append(M);const R=new P({id:"footer"}),L=new w({class:"button",text:Yx("popup.cancel")}),B=new w({class:"button",text:Yx("file.export")});let O,z;R.append(L),R.append(B),s.append(i),s.append(a),s.append(R),this.append(s),L.on("click",(()=>O())),B.on("click",(()=>z()));const V=e=>{switch(e.key){case"Escape":O();break;case"Enter":e.shiftKey||z();break;default:e.stopPropagation()}},N=()=>{if(!M.hidden){const e=e=>e.substring(0,e.length-Ye.getExtension(e).length);D.value=e(D.value)+("html"===l.value?".html":".zip")}};l.on("change",N);this.show=t=>((()=>{const t=e.invoke("camera.poses").length>0,s=e.invoke("bgClr");m.value=e.invoke("view.bands"),v.value=t?"pose":"viewport",v.disabledOptions=t?{}:{pose:v.options[2].t},y.value=t?"track":"none",y.disabledOptions=t?{}:{track:y.options[1].t},A.value=[s.r,s.g,s.b],k.value=e.invoke("camera.fov"),d.value="dev"})(),M.hidden=!t,t&&(D.value=t,N()),this.hidden=!1,this.dom.addEventListener("keydown",V),this.dom.focus(),new Promise((s=>{O=()=>{s(null)},z=()=>{const i=e.invoke("timeline.frames");e.invoke("timeline.frameRate");const n=e.invoke("camera.poses").slice().filter((e=>e.frame>=0&&e.frame<i)).sort(((e,t)=>e.frame-t.frame));let a;switch(v.value){case"pose":a=n?.[0];break;case"viewport":a=e.invoke("camera.getPose")}const r=a?.position,o=a?.target,h=(()=>{switch(y.value){case"none":return"none";case"track":return"animTrack"}})(),c={camera:{fov:k.value,position:r?[r.x,r.y,r.z]:null,target:o?[o.x,o.y,o.z]:null,startAnim:h,animTrack:"animTrack"===h?"cameraAnim":null},background:{color:A.value.slice()},animTracks:[]},u={maxSHBands:m.value};s({type:l.value,filename:t&&D.value,serializeSettings:u,experienceSettings:c,versionType:d.value})}})).finally((()=>{this.dom.removeEventListener("keydown",V),this.hide()}))),this.hide=()=>{this.hidden=!0},this.destroy=()=>{this.hide(),super.destroy()}}}class ST{appContainer;topContainer;canvasContainer;toolsContainer;canvas;popup;constructor(e,t){Ex.use(Xx).init({detection:{order:["querystring","navigator","htmlTag"]},supportedLngs:["de","en","fr","ja","ko","zh-CN"],fallbackLng:"en",resources:{de:{translation:{file:"Datei","file.new":"Neu","file.open":"ffnen","file.import":"Importieren...","file.load-all-data":"PLY-Daten vollstndig laden","file.save":"Speichern","file.save-as":"Speichern als...","file.publish":"Verffentlichen...","file.export":"Exportieren","file.export.compressed-ply":"Komprimiertes PLY","file.export.splat":"Splat","file.export.viewer":"Viewer App...",select:"Auswahl","select.all":"Alles","select.none":"Aufheben","select.invert":"Invertieren","select.lock":"Selektion sperren","select.unlock":"Sperre aufheben","select.delete":"Selektion aufheben","select.reset":"Splats zurcksetzen","select.duplicate":"Duplizieren","select.separate":"Separieren",help:"Hilfe","help.shortcuts":"Tastaturkrzel","help.user-guide":"Handbuch","help.log-issue":"Problem melden","help.github-repo":"GitHub Repository","help.basics-video":"Grundlagen Video","help.discord":"Discord Server","help.forum":"Forum","help.about":"ber SuperSplat","mode.centers":"Punkt Modus","mode.rings":"Ring Modus","scene-manager":"SZENEN MANAGER",transform:"TRANSFORMATION",position:"Position",rotation:"Rotation",scale:"Skalierung",options:"ANSICHTS OPTIONEN","options.colors":"Farben","options.bg-color":"Hintergrundfarbe","options.selected-color":"Selektierte Farbe","options.unselected-color":"Nicht selektierte Farbe","options.locked-color":"Gesperrte Farbe","options.fov":"Sichtfeld (FoV)","options.sh-bands":"SH Bnder","options.centers-size":"Punktgren","options.outline-selection":"Umriss Selektion","options.show-grid":"Raster anzeigen","options.show-bound":"Objektbox anzeigen","options.camera-fly-speed":"Kamera Geschwindigkeit",camera:"KAMERA POSEN","camera.add-pose":"Pose hinzufgen","camera.prev-pose":"Vorherige Pose","camera.next-pose":"Nchste Pose","camera.play-poses":"Posen abspielen","camera.clear-poses":"Posen leeren",data:"SPLAT DATEN","data.distance":"Entfernung","data.volume":"Volumen","data.surface-area":"Oberflche","data.scale-x":"Gre X","data.scale-y":"Gre Y","data.scale-z":"Gre Z","data.red":"Rot","data.green":"Grn","data.blue":"Blau","data.opacity":"Deckkraft","data.hue":"Farbe","data.saturation":"Sttigung","data.value":"Helligkeit","data.log-scale":"Logarithmische Skala","data.totals":"Summe","data.totals.splats":"Splats","data.totals.selected":"Selektiert","data.totals.hidden":"Ausgeblendet","data.totals.deleted":"Gelscht","shortcuts.title":"TASTATURKRZEL","shortcuts.tools":"WERKZEUGE","shortcuts.move":"Bewegen","shortcuts.rotate":"Drehen","shortcuts.scale":"Skalieren","shortcuts.rect-selection":"Rechteckselektion","shortcuts.brush-selection":"Pinselselektion","shortcuts.picker-selection":"Einzelselektion","shortcuts.brush-size":"Pinsel Verkleinern/Vergrern","shortcuts.deactivate-tool":"Werkzeug deaktivieren","shortcuts.selection":"SELEKTION","shortcuts.select-all":"Alle Selektieren","shortcuts.deselect-all":"Selektion aufheben","shortcuts.invert-selection":"Selektion invertieren","shortcuts.add-to-selection":"Zur Selektion hinzufgen","shortcuts.remove-from-selection":"Von Selektion entfernen","shortcuts.delete-selected-splats":"Selektierte Splats lschen","shortcuts.show":"ANZEIGEN","shortcuts.hide-selected-splats":"Selektierte Splats ausblenden","shortcuts.unhide-all-splats":"Alle Splats einblenden","shortcuts.toggle-data-panel":"Splat Daten Panel anzeigen","shortcuts.other":"WEITERE","shortcuts.select-next-splat":"Nchsten Splat selektieren","shortcuts.undo":"Rckgngig","shortcuts.redo":"Wiederholen","shortcuts.toggle-splat-overlay":"Splateinblendung umschalten","shortcuts.focus-camera":"Kamera auf selektion ausrichten","shortcuts.toggle-camera-mode":"Kameramodus umschalten","shortcuts.toggle-grid":"Rasteranzeige umschalten","shortcuts.toggle-gizmo-coordinate-space":"Gizmoanzeige umschalten","popup.ok":"OK","popup.cancel":"Abbrechen","popup.yes":"Ja","popup.no":"Nein","popup.error":"FEHLER","popup.error-loading":"FEHLER BEIM LADEN DER DATEI","popup.drop-files":"Bitte Dateien und Ordner ablegen","popup.copy-to-clipboard":"Link in die Zwischenablage kopieren","tooltip.splat-mode":"Splat Modus ( M )","tooltip.show-hide":"Anzeigen/Ausplenden Splats ( Leertaste )","tooltip.frame-selection":"Rechteckselektion ( F )","tooltip.camera-reset":"Kamera zurcksetzen","tooltip.color-panel":"Farben","tooltip.view-options":"Anzeige Optionen","tooltip.undo":"Rckgngig ( Strg + Z )","tooltip.redo":"Wiederholen ( Strg + Shift + Z )","tooltip.picker":"Einzelselektion ( R )","tooltip.polygon":"Polygonselektion ( P )","tooltip.brush":"Pinselselektion ( B )","tooltip.sphere":"Kugelselektion","tooltip.translate":"Verschieben ( 1 )","tooltip.rotate":"Drehen ( 2 )","tooltip.scale":"Skalieren ( 3 )","tooltip.local-space":"Gizmo in local-space","tooltip.bound-center":"Mittelpunkt verwenden","export.type":"Export Typ","export.html":"HTML","export.package":"ZIP Paket","export.sh-bands":"SH Bnder","export.start-position":"Start Position","export.default":"Standard","export.viewport":"Aktuelle Ansicht","export.pose-camera":"1. Kamera Pose","export.fov":"Sichtfeld (FoV)","export.background-color":"Hintergrund","export.filename":"Dateiname","cursor.click-to-copy":"Klicken zum kopieren","cursor.copied":"Kopiert!"}},en:{translation:{file:"File","file.new":"New","file.open":"Open","file.import":"Import...","file.load-all-data":"Load all PLY data","file.save":"Save","file.save-as":"Save As...","file.publish":"Publish...","file.export":"Export","file.export.ply":"PLY (.ply)","file.export.compressed-ply":"Compressed PLY (.ply)","file.export.splat":"Splat file (.splat)","file.export.viewer":"Viewer App...",render:"Render","render.image":"Image","render.video":"Video...","render.ok":"Render","render.cancel":"Cancel",select:"Select","select.all":"All","select.none":"None","select.invert":"Invert","select.lock":"Lock Selection","select.unlock":"Unlock All","select.delete":"Delete Selection","select.reset":"Reset Splat","select.duplicate":"Duplicate","select.separate":"Separate",help:"Help","help.shortcuts":"Keyboard Shortcuts","help.user-guide":"User Guide","help.log-issue":"Log an Issue","help.github-repo":"GitHub Repo","help.basics-video":"Basics Video","help.discord":"Discord Server","help.forum":"Forum","help.about":"About SuperSplat","mode.centers":"Centers Mode","mode.rings":"Rings Mode","scene-manager":"SCENE MANAGER",transform:"TRANSFORM",position:"Position",rotation:"Rotation",scale:"Scale",options:"VIEW OPTIONS","options.colors":"Colors","options.bg-color":"Background Color","options.selected-color":"Selected Color","options.unselected-color":"Unselected Color","options.locked-color":"Locked Color","options.fov":"Field of View","options.sh-bands":"SH Bands","options.centers-size":"Centers Size","options.outline-selection":"Outline Selection","options.show-grid":"Show Grid","options.show-bound":"Show Bound","options.camera-fly-speed":"Fly Speed","options.tonemapping":"Tonemapping","options.tonemapping-none":"None","options.tonemapping-linear":"Linear","options.tonemapping-neutral":"Neutral","options.tonemapping-aces":"ACES","options.tonemapping-aces2":"ACES2","options.tonemapping-filmic":"Filmic","options.tonemapping-hejl":"Hejl",camera:"CAMERA POSES","camera.add-pose":"Add Pose","camera.prev-pose":"Previous Pose","camera.next-pose":"Next Pose","camera.play-poses":"Play Poses","camera.clear-poses":"Clear Poses",colors:"COLORS","colors.tint":"Tint","colors.brightness":"Brightness","colors.blackPoint":"Black Point","colors.whitePoint":"White Point","colors.transparency":"Transparency","colors.reset":"Reset",data:"SPLAT DATA","data.distance":"Distance","data.volume":"Volume","data.surface-area":"Surface Area","data.scale-x":"Scale X","data.scale-y":"Scale Y","data.scale-z":"Scale Z","data.red":"Red","data.green":"Green","data.blue":"Blue","data.opacity":"Opacity","data.hue":"Hue","data.saturation":"Saturation","data.value":"Value","data.log-scale":"Log Scale","data.totals":"Totals","data.totals.splats":"Splats","data.totals.selected":"Selected","data.totals.hidden":"Hidden","data.totals.deleted":"Deleted","shortcuts.title":"KEYBOARD SHORTCUTS","shortcuts.tools":"TOOLS","shortcuts.move":"Move","shortcuts.rotate":"Rotate","shortcuts.scale":"Scale","shortcuts.rect-selection":"Rect Selection","shortcuts.brush-selection":"Brush Selection","shortcuts.picker-selection":"Picker Selection","shortcuts.brush-size":"Decrease/Increase brush size","shortcuts.deactivate-tool":"Deactivate Tool","shortcuts.selection":"SELECTION","shortcuts.select-all":"Select All","shortcuts.deselect-all":"Deselect All","shortcuts.invert-selection":"Invert Selection","shortcuts.add-to-selection":"Add to Selection","shortcuts.remove-from-selection":"Remove from Selection","shortcuts.delete-selected-splats":"Delete Selected Splats","shortcuts.show":"SHOW","shortcuts.hide-selected-splats":"Hide Selected Splats","shortcuts.unhide-all-splats":"Unhide All Splats","shortcuts.toggle-data-panel":"Toggle Data Panel","shortcuts.other":"OTHER","shortcuts.select-next-splat":"Select Next Splat","shortcuts.undo":"Undo","shortcuts.redo":"Redo","shortcuts.toggle-splat-overlay":"Toggle Splat Overlay","shortcuts.focus-camera":"Focus Camera on current selection","shortcuts.toggle-camera-mode":"Toggle Camera Mode","shortcuts.toggle-grid":"Toggle Grid","shortcuts.toggle-gizmo-coordinate-space":"Toggle Gizmo Coordinate Space","popup.ok":"OK","popup.cancel":"Cancel","popup.yes":"Yes","popup.no":"No","popup.error":"ERROR","popup.error-loading":"ERROR LOADING FILE","popup.drop-files":"Please drop files and folders","popup.copy-to-clipboard":"Copy link to clipboard","tooltip.splat-mode":"Splat Mode ( M )","tooltip.show-hide":"Show/Hide Splats ( Space )","tooltip.frame-selection":"Frame Selection ( F )","tooltip.camera-reset":"Reset Camera","tooltip.color-panel":"Colors","tooltip.view-options":"View Options","tooltip.undo":"Undo ( Ctrl + Z )","tooltip.redo":"Redo ( Ctrl + Shift + Z )","tooltip.picker":"Picker Select ( R )","tooltip.polygon":"Polygon Select ( P )","tooltip.brush":"Brush Select ( B )","tooltip.sphere":"Sphere Select","tooltip.translate":"Translate ( 1 )","tooltip.rotate":"Rotate ( 2 )","tooltip.scale":"Scale ( 3 )","tooltip.local-space":"Use Local Orientation","tooltip.bound-center":"Use Bound Center","export.header":"VIEWER EXPORT","export.type":"Export Type","export.html":"HTML","export.package":"ZIP Package","export.sh-bands":"SH Bands","export.start-position":"Start Position","export.default":"Default","export.viewport":"Current Viewport","export.pose-camera":"1st Camera Pose","export.fov":"Field of View","export.background-color":"Background","export.filename":"Filename","export.animation":"Animation","export.animation-none":"None","export.animation-track":"Track","export.version-type":"Version Type","export.version-dev":"Developer","export.version-client":"Client","export.version-both":"Both","cursor.click-to-copy":"Click to copy","cursor.copied":"Copied!","doc.reset":"RESET SCENE","doc.unsaved-message":"You have unsaved changes. Are you sure you want to reset the scene?","doc.reset-message":"Are you sure you want to reset the scene?","doc.save-failed":"FAILED TO SAVE","doc.load-failed":"FAILED TO LOAD","publish.header":"PUBLISH SETTINGS","publish.ok":"Publish","publish.cancel":"Cancel","publish.title":"Title","publish.description":"Description","publish.listed":"Listed","publish.failed":"PUBLISH FAILED","publish.please-try-again":"Please try again later.","publish.succeeded":"PUBLISH SUCCEEDED","publish.message":"Use the link below to access your scene.","publish.please-log-in":"Publishing to PlayCanvas requires a user account. Please log in and try again.","video.header":"VIDEO SETTINGS","video.resolution":"Resolution","video.bitrate":"Bitrate","video.portrait":"Portrait Mode","video.transparentBg":"Transparent Background","video.showDebug":"Show Debug Overlays","timeline.prev-key":"Jump to previous keyframe","timeline.play":"Play/Stop","timeline.next-key":"Jump to next keyframe","timeline.add-key":"Add Key","timeline.remove-key":"Remove Key","timeline.frame-rate":"Frame Rate","timeline.total-frames":"Total Frames"}},fr:{translation:{file:"Fichier","file.new":"Crer","file.open":"Ouvrir","file.import":"Importer...","file.load-all-data":"Charger toutes les donnes ply","file.save":"Enregistrer","file.save-as":"Enregistrer sous...","file.publish":"Publier...","file.export":"Exporter","file.export.compressed-ply":"Ply compress","file.export.splat":"Fichier splat","file.export.viewer":"Application de visualisation...",select:"Slection","select.all":"Tout","select.none":"Aucune","select.invert":"Inverser","select.lock":"Verrouiller la slection","select.unlock":"Tout dbloquer","select.delete":"Supprimer la slection","select.reset":"Rinitialiser splat","select.duplicate":"Dupliquer","select.separate":"Sparer",help:"Aide","help.shortcuts":"Raccourcis claviers","help.user-guide":"Guide utilisateur","help.log-issue":"Signaler un problme","help.github-repo":"Dpt GitHub","help.basics-video":"Vido de base","help.discord":"Serveur Discord","help.forum":"Forum","help.about":" propos de SuperSplat","mode.centers":"Mode centres","mode.rings":"Mode anneaux","scene-manager":"GESTIONNAIRE DE SCENE",transform:"TRANSFORMATION",position:"Position",rotation:"Rotation",scale:"chelle",options:"OPTIONS D'AFFICHAGE","options.colors":"Couleurs","options.bg-color":"Couleur de fond","options.selected-color":"Couleur slectionne","options.unselected-color":"Couleur non slectionne","options.locked-color":"Couleur verrouille","options.fov":"Champ de vision","options.sh-bands":"Ordres d'HS","options.centers-size":"chelle des centres","options.outline-selection":"Contour de la slection","options.show-grid":"Afficher la grille","options.show-bound":"Afficher limites","options.camera-fly-speed":"Vitesse de vol",camera:"POSES DE LA CAMERA","camera.add-pose":"Ajouter une pose","camera.prev-pose":"Pose prcdente","camera.next-pose":"Pose suivante","camera.play-poses":"Lire les poses","camera.clear-poses":"Effacer les poses",data:"DONNEES SPLAT","data.distance":"Distance","data.volume":"Volume","data.surface-area":"Zone de surface","data.scale-x":"chelle X","data.scale-y":"chelle Y","data.scale-z":"chelle Z","data.red":"Rouge","data.green":"Vert","data.blue":"Bleu","data.opacity":"Opacit","data.hue":"Teinte","data.saturation":"Saturation","data.value":"Luminosit","data.log-scale":"chelle logarithmique","data.totals":"Totaux","data.totals.splats":"Splats","data.totals.selected":"Selectionn","data.totals.hidden":"Cach","data.totals.deleted":"Supprim","shortcuts.title":"RACCOURCIS CLAVIERS","shortcuts.tools":"OUTILS","shortcuts.move":"Dplacer","shortcuts.rotate":"Tourner","shortcuts.scale":"Changer l'chelle","shortcuts.rect-selection":"Slection avec rectangle","shortcuts.brush-selection":"Slection avec pinceau","shortcuts.picker-selection":"Slection avec pipette","shortcuts.brush-size":"Augmenter/Diminuer la taille du pinceau","shortcuts.deactivate-tool":"Dsactiver l'outil","shortcuts.selection":"SELECTION","shortcuts.select-all":"Tout slectionner","shortcuts.deselect-all":"Tout deslectionner","shortcuts.invert-selection":"Inverser la slection","shortcuts.add-to-selection":"Ajouter  la slection","shortcuts.remove-from-selection":"Retirer de la slection","shortcuts.delete-selected-splats":"Supprimer splats slectionns","shortcuts.show":"AFFICHER","shortcuts.hide-selected-splats":"Masquer splats slectionns","shortcuts.unhide-all-splats":"Rafficher tous les splats","shortcuts.toggle-data-panel":"Afficher/Cacher l'onglet donnes","shortcuts.other":"AUTRES","shortcuts.select-next-splat":"Slectionner le splat suivant","shortcuts.undo":"Annuler","shortcuts.redo":"Rtablir","shortcuts.toggle-splat-overlay":"Basculer affichage splat","shortcuts.focus-camera":"Focaliser la camra sur la slection actuelle","shortcuts.toggle-camera-mode":"Basculer le mode de camera","shortcuts.toggle-grid":"Afficher/Cacher la grille","shortcuts.toggle-gizmo-coordinate-space":"Basculer en espace de coordonnes Gizmo","popup.ok":"OK","popup.cancel":"Annuler","popup.yes":"Oui","popup.no":"Non","popup.error":"ERREUR","popup.error-loading":"Erreur de chargement du fichier","popup.drop-files":"Veuillez dposer des fichiers et des dossiers","popup.copy-to-clipboard":"Copier le lien dans le presse-papiers","tooltip.splat-mode":"Mode splat ( M )","tooltip.show-hide":"Afficher/cacher les splats ( Barre espace )","tooltip.frame-selection":"Cadrer la slection ( F )","tooltip.camera-reset":"Rinitialiser la camra","tooltip.color-panel":"Couleurs","tooltip.view-options":"Options d'affichage","tooltip.undo":"Annuler ( Ctrl + Z )","tooltip.redo":"Rtablir ( Ctrl + Shift + Z )","tooltip.picker":"Slection avec pipette ( R )","tooltip.polygon":"Slection avec polygone ( P )","tooltip.brush":"Slection avec pinceau ( B )","tooltip.sphere":"Slection avec sphre","tooltip.translate":"Translation ( 1 )","tooltip.rotate":"Rotation ( 2 )","tooltip.scale":"chelle ( 3 )","tooltip.local-space":"Espace local gizmo","tooltip.bound-center":"Utiliser le centre de la limite","export.type":"Type d'export","export.html":"HTML","export.package":"Package ZIP","export.sh-bands":"Bandes SH","export.start-position":"Position de dpart","export.default":"Dfaut","export.viewport":"Vue actuelle","export.pose-camera":"1re pose de camra","export.fov":"Champ de vision","export.background-color":"Arrire-plan","export.filename":"Nom de fichier","cursor.click-to-copy":"Cliquez pour copier","cursor.copied":"Copi!"}},ja:{translation:{file:"","file.new":"","file.open":"","file.import":"...","file.load-all-data":"PLY","file.save":"","file.save-as":"","file.publish":"...","file.export":"","file.export.compressed-ply":"Compressed PLY (.ply)","file.export.splat":"Splat (.splat)","file.export.viewer":"Viewer App...",select:"","select.all":"","select.none":"","select.invert":"","select.lock":"","select.unlock":"","select.delete":"","select.reset":"","select.duplicate":"","select.separate":"",help:"","help.shortcuts":"","help.user-guide":"","help.log-issue":"","help.github-repo":"GitHub","help.basics-video":"","help.discord":"Discord","help.forum":"","help.about":"SuperSplat","mode.centers":"","mode.rings":"","scene-manager":"",transform:"",position:"",rotation:"",scale:"",options:"","options.colors":"","options.bg-color":"","options.selected-color":"","options.unselected-color":"","options.locked-color":"","options.fov":" ( FOV )","options.sh-bands":"","options.centers-size":"","options.outline-selection":"","options.show-grid":"","options.show-bound":"","options.camera-fly-speed":"",camera:"","camera.add-pose":"","camera.prev-pose":"","camera.next-pose":"","camera.play-poses":"","camera.clear-poses":"",data:"","data.distance":"","data.volume":"","data.surface-area":"","data.scale-x":" X","data.scale-y":" Y","data.scale-z":" Z","data.red":"","data.green":"","data.blue":"","data.opacity":"","data.hue":"","data.saturation":"","data.value":"","data.log-scale":"","data.totals":"","data.totals.splats":"","data.totals.selected":"","data.totals.hidden":"","data.totals.deleted":"","shortcuts.title":"","shortcuts.tools":"","shortcuts.move":"","shortcuts.rotate":"","shortcuts.scale":"","shortcuts.rect-selection":"","shortcuts.brush-selection":"","shortcuts.picker-selection":"","shortcuts.brush-size":"","shortcuts.deactivate-tool":"","shortcuts.selection":"","shortcuts.select-all":"","shortcuts.deselect-all":"","shortcuts.invert-selection":"","shortcuts.add-to-selection":"","shortcuts.remove-from-selection":"","shortcuts.delete-selected-splats":"","shortcuts.show":"","shortcuts.hide-selected-splats":"","shortcuts.unhide-all-splats":"","shortcuts.toggle-data-panel":"","shortcuts.other":"","shortcuts.select-next-splat":"","shortcuts.undo":"","shortcuts.redo":"","shortcuts.toggle-splat-overlay":"","shortcuts.focus-camera":"","shortcuts.toggle-camera-mode":"","shortcuts.toggle-grid":"","shortcuts.toggle-gizmo-coordinate-space":"","popup.ok":"OK","popup.cancel":"","popup.yes":"","popup.no":"","popup.error":"","popup.error-loading":"","popup.drop-files":"","popup.copy-to-clipboard":"","tooltip.splat-mode":" ( M )","tooltip.show-hide":"/ ( Space )","tooltip.frame-selection":" ( F )","tooltip.camera-reset":"","tooltip.color-panel":"","tooltip.view-options":"","tooltip.undo":" ( Ctrl + Z )","tooltip.redo":" ( Ctrl + Shift + Z )","tooltip.picker":" ( R )","tooltip.polygon":" ( P )","tooltip.brush":" ( B )","tooltip.sphere":"","tooltip.translate":" ( 1 )","tooltip.rotate":" ( 2 )","tooltip.scale":" ( 3 )","tooltip.local-space":"","tooltip.bound-center":"","export.type":"","export.html":"HTML","export.package":"ZIP","export.sh-bands":"SH","export.start-position":"","export.default":"","export.viewport":"","export.pose-camera":"1","export.fov":"","export.background-color":"","export.filename":"","cursor.click-to-copy":"","cursor.copied":""}},ko:{translation:{file:"","file.new":" ","file.open":"","file.import":"...","file.load-all-data":" PLY  ","file.save":"","file.save-as":"  ...","file.publish":"...","file.export":"","file.export.compressed-ply":" PLY","file.export.splat":"Splat ","file.export.viewer":" ...",select:"","select.all":"","select.none":"","select.invert":"","select.lock":" ","select.unlock":"  ","select.delete":" ","select.reset":"Splat ","select.duplicate":"","select.separate":"",help:"","help.shortcuts":" ","help.user-guide":" ","help.log-issue":" ","help.github-repo":"GitHub ","help.basics-video":" ","help.discord":"Discord ","help.forum":"","help.about":"SuperSplat ","mode.centers":" ","mode.rings":" ","scene-manager":" ",transform:"",position:"",rotation:"",scale:"",options:" ","options.colors":"","options.bg-color":" ","options.selected-color":" ","options.unselected-color":"  ","options.locked-color":" ","options.fov":"","options.sh-bands":"SH ","options.centers-size":" ","options.outline-selection":" ","options.show-grid":" ","options.show-bound":" ","options.camera-fly-speed":"  ",camera:" ","camera.add-pose":" ","camera.prev-pose":" ","camera.next-pose":" ","camera.play-poses":" ","camera.clear-poses":" ",data:"SPLAT ","data.distance":"","data.volume":"","data.surface-area":"","data.scale-x":" X","data.scale-y":" Y","data.scale-z":" Z","data.red":"","data.green":"","data.blue":"","data.opacity":"","data.hue":"","data.saturation":"","data.value":"","data.log-scale":" ","data.totals":"","data.totals.splats":"Splat","data.totals.selected":"","data.totals.hidden":"","data.totals.deleted":"","shortcuts.title":" ","shortcuts.tools":"","shortcuts.move":"","shortcuts.rotate":"","shortcuts.scale":" ","shortcuts.rect-selection":" ","shortcuts.brush-selection":" ","shortcuts.picker-selection":" ","shortcuts.brush-size":"  ","shortcuts.deactivate-tool":" ","shortcuts.selection":"","shortcuts.select-all":" ","shortcuts.deselect-all":"  ","shortcuts.invert-selection":" ","shortcuts.add-to-selection":" ","shortcuts.remove-from-selection":" ","shortcuts.delete-selected-splats":" Splat ","shortcuts.show":"","shortcuts.hide-selected-splats":" Splat ","shortcuts.unhide-all-splats":" Splat ","shortcuts.toggle-data-panel":"  ","shortcuts.other":"","shortcuts.select-next-splat":" Splat ","shortcuts.undo":" ","shortcuts.redo":" ","shortcuts.toggle-splat-overlay":"Splat  ","shortcuts.focus-camera":"   ","shortcuts.toggle-camera-mode":"  ","shortcuts.toggle-grid":" ","shortcuts.toggle-gizmo-coordinate-space":"   ","popup.ok":"","popup.cancel":"","popup.yes":"","popup.no":"","popup.error":"","popup.error-loading":"  ","popup.drop-files":"   ","popup.copy-to-clipboard":"   ","tooltip.splat-mode":"Splat  ( M )","tooltip.show-hide":" / ( Space )","tooltip.frame-selection":"  ( F )","tooltip.camera-reset":" ","tooltip.color-panel":"","tooltip.view-options":" ","tooltip.undo":"  ( Ctrl + Z )","tooltip.redo":"  ( Ctrl + Shift + Z )","tooltip.picker":"  ( R )","tooltip.polygon":"  ( P )","tooltip.brush":"  ( B )","tooltip.sphere":" ","tooltip.translate":" ( 1 )","tooltip.rotate":" ( 2 )","tooltip.scale":"  ( 3 )","tooltip.local-space":" ","tooltip.bound-center":"  ","export.type":" ","export.html":"HTML","export.package":"ZIP ","export.sh-bands":"SH ","export.start-position":" ","export.default":"","export.viewport":" ","export.pose-camera":"1  ","export.fov":"","export.background-color":"","export.filename":" ","cursor.click-to-copy":" ","cursor.copied":"!"}},"zh-CN":{translation:{file:"","file.new":"","file.open":"","file.import":"...","file.load-all-data":" PLY ","file.save":"","file.save-as":"...","file.publish":"...","file.export":"","file.export.compressed-ply":" PLY","file.export.splat":"Splat ","file.export.viewer":"...",select:"","select.all":"","select.none":"","select.invert":"","select.lock":"","select.unlock":"","select.delete":"","select.reset":" Splat","select.duplicate":"","select.separate":"",help:"","help.shortcuts":"","help.user-guide":"","help.log-issue":"","help.github-repo":"GitHub ","help.basics-video":"","help.discord":"Discord ","help.forum":"","help.about":" SuperSplat","mode.centers":"","mode.rings":"","scene-manager":"",transform:"",position:"",rotation:"",scale:"",options:"","options.colors":"","options.bg-color":"","options.selected-color":"","options.unselected-color":"","options.locked-color":"","options.fov":"","options.sh-bands":"SH ","options.centers-size":"","options.outline-selection":"","options.show-grid":"","options.show-bound":"","options.camera-fly-speed":"",camera:"","camera.add-pose":"","camera.prev-pose":"","camera.next-pose":"","camera.play-poses":"","camera.clear-poses":"",data:"SPLAT ","data.distance":"","data.volume":"","data.surface-area":"","data.scale-x":" X","data.scale-y":" Y","data.scale-z":" Z","data.red":"","data.green":"","data.blue":"","data.opacity":"","data.hue":"","data.saturation":"","data.value":"","data.log-scale":"","data.totals":"","data.totals.splats":"Splat","data.totals.selected":"","data.totals.hidden":"","data.totals.deleted":"","shortcuts.title":"","shortcuts.tools":"","shortcuts.move":"","shortcuts.rotate":"","shortcuts.scale":"","shortcuts.rect-selection":"","shortcuts.brush-selection":"","shortcuts.picker-selection":"","shortcuts.brush-size":"/","shortcuts.deactivate-tool":"","shortcuts.selection":"","shortcuts.select-all":"","shortcuts.deselect-all":"","shortcuts.invert-selection":"","shortcuts.add-to-selection":"","shortcuts.remove-from-selection":"","shortcuts.delete-selected-splats":" Splat","shortcuts.show":"","shortcuts.hide-selected-splats":" Splat","shortcuts.unhide-all-splats":" Splat","shortcuts.toggle-data-panel":"","shortcuts.other":"","shortcuts.select-next-splat":" Splat","shortcuts.undo":"","shortcuts.redo":"","shortcuts.toggle-splat-overlay":" Splat ","shortcuts.focus-camera":"","shortcuts.toggle-camera-mode":"","shortcuts.toggle-grid":"","shortcuts.toggle-gizmo-coordinate-space":" Gizmo ","popup.ok":"","popup.cancel":"","popup.yes":"","popup.no":"","popup.error":"","popup.error-loading":"","popup.drop-files":"","popup.copy-to-clipboard":"","tooltip.splat-mode":"Splat  ( M )","tooltip.show-hide":"/ Splats ( Space )","tooltip.frame-selection":" ( F )","tooltip.camera-reset":"","tooltip.color-panel":"","tooltip.view-options":"","tooltip.undo":" ( Ctrl + Z )","tooltip.redo":" ( Ctrl + Shift + Z )","tooltip.picker":" ( R )","tooltip.polygon":" ( P )","tooltip.brush":" ( B )","tooltip.sphere":"","tooltip.translate":" ( 1 )","tooltip.rotate":" ( 2 )","tooltip.scale":" ( 3 )","tooltip.local-space":"","tooltip.bound-center":"","export.type":"","export.html":"HTML","export.package":"ZIP ","export.sh-bands":"SH ","export.start-position":"","export.default":"","export.viewport":"","export.pose-camera":"","export.fov":"","export.background-color":"","export.filename":"","cursor.click-to-copy":"","cursor.copied":"!"}}},interpolation:{escapeValue:!1}});const s=document.createElement("link");s.rel="icon",s.href="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAEAAAABACAYAAACqaXHeAAAOI3pUWHRSYXcgcHJvZmlsZSB0eXBlIGV4aWYAAHjapZnpcSQ7DoT/04o1oXiCNIdnxHqw5u8H1tHdkiZm5j0p1F0HiwSBRCZQMvN//13mP/wEF5MJUXIqKR38hBKKqxzk4/yp+9MeYX/un3Dd4vzjunluOC55vv15mtM1/r5unwnOr8pRfJso9+tG+7xRrhVc/jLRtZBXixwH45qoXBN5d96w1wT13NaRSpb3LbR5fo97J/n8M/rhZc/9TPL1PAjeG5GL3rnprT/49P4ywOufM75ykPl0HncwKHHMUD6DT5clOOQnPz0/BYvWvELxfdBHVJ4j+/N18zVawV1D/Bcnp+f7x+vGxp+jsl3/jp98HbnP69Ed67Toi/f1b62R194zu6gh4ep0bereyj5iXGMJXTobTEuH8BeZQvZv4TeD6k7UxtGPxm+3xTpisGyww1a77Nzf3XZMDG4aJxw41wmaXsxeXHHda/yC/trlxBc/iKzzfYc9ePfYYvey5ehmr5ZZeViGOstkVnHxt7/mbx9YS1PB2iM/vsIu59TZmKGR00+GERG7LqfG7eD79+uPxtUTwahe1hQpOLadU7RoX0zgd6A9AyPfZ7pYGdcEuIilI8ZYTwSImvXRJnuIc2ItjswEqGK688E1ImBjdAMjXfA+EZvsdGkeEbuHuui4bLgOmRGJSJYJsSm+EqwQIviRkMFQjT6GGGOKEnMssSafQoopJUlKilW8BCNRkohkKVKzzyHHnLLknEuuxRUPacaSipRcSqmVNSszV56uDKi1ueZbaNG01KTlVlrtwKeHHnvq0nMvvQ43/IA/Rhoy8iijTjuB0gwzzjRl5llmXUBtebPCiistWXmVVZ+oXWH99vsXUbNX1NyOlA6UJ2pcFbmnsEonUWNGwJwJloiLhgBAO43ZkW0ITiOnMTuKIyuiw8ioMRtWI0YEw7QuLnvHzrgzohq5fxU3I+Ejbu6fRs5o6P4yct/j9lPUhspQ3xE7s1CdevilQtTFhjHGHGEJH72u4kJebQXbDE8WL9Kimy53kiXARHpuWxtVr+Tq+nGe7UkSm7UhwkHv48yPA11uCNt5Nleq1xLnqM914bOiV8398L5q837uXCnXsEdakaULb9utDmWVLxdLMJh4zLF0ssUcaWyrYxZO0Rom5QEv9wTtNVjvpngPN1MfByGdLw1BGZPYQw69cRpGjyFPD5BY143c4eTtN9mb8Db389RM9Qibzwh1mPpB0Kori51V1fik49XrxK/t7XqkBITpTdlHgr8MA0B52fOsPfmuEHQrZQSebrm/3TvSaUneDxwAbtsznSnX+Q6Cb9sXx2tikBSOuZeeKFriIXfMhh2ludGpPjSRYhjoGi7j4dhscW8TRO/qafp3Q09r1Flk6nZCj0aroV/d1p2clpJTR/qY9tCA3SbzkHlFgCnPFc8lflzhdLSevGKjbindsMthn53P7lJs5ZAAFmraB0mhTuDx5mvnXMtzvq2sUSMw79j4FsU7UvW++WY2pydyzDwHi3wsl489+eWsK7DndOfedpzhqqVRtqMnc8HgRxS0G7aPpU2dILJXzF1itbMfK8FZRvOA4YE8Oo8cc7T0BmJ1x5s5asG9wA0Ll6uR+UQszrJkVEftIx1ZCRBi835RZPUpdpKs0GLMFRPqAmh9MzEbiquaAnOmRWC1WLPLr3EsL22uY1AAtj1hG7Cg13x3fWFO8tybFHKs3RtiwPLGy2j+V+tXWKFRriVIf7KKpBZqg5cZvdwZJxZh1Wlg9KXzUKXcC38uu1g2DlWkmuZwAc5jsuAQj/44i6TFQchT29EPVcZJI3+CgzO0Gno9N3ckjq9UgjauMFeInu6DzfkjrfBGd/Wmu6ImVXM8xm3CG9/XIyuf1dprL+Uxr42jBaPeQcA14n17KqrPKSYBmVe3DySi5WM/P3P3k2xEx1KrBfO2pGqBYIoEP+SwHUmVUkdOqGRCOv0CyAihRzrV9zrjbHWp+4/vC5vPlUetPg8gK2EQ8SNpQVwLsh65k2YDiQ0JaYlKYc1im6eQWNl7Osipca4EFatsHNEpXkFUnhacotHTSRlxUWZ4VBsYL/C1BhKPRSWJQsUiR3MhS4p7W3trkwJ2jsJwFaq07U80EV0aAielRLiaeoFAkbAJlCaQFZcBizVQsGBMG6SGBZV2bbujuoiDWKbql840EohqvbLbyu5HBeGpFkTBUD5J9p+EAULLF3J7+Go+SvDSNKUY8wy4tVHqyTdbfYChNJvKKdvR3XB0ukTY2XCRi/nKvQ+BPWz0HYZTGYjb80XMytkMj2l2DQhO0kgIyEgKIHXyQAFJmNlzhHtybc2ldhBFNjmTqHjO1cXQCqonF8XfkFRqnPgasYGkGAMvOAryLoo0P6mAYtDq0FPlJQXtcEuwQpbpsJGAsiEwQ2vi+0xAuGujOY44ueMbpSnVigewR80LH4mMFS21AXkoAliIWopjTnrh1Ac+XQBePtktJcpNCkgIcFGBNVEoQ46dCkgoAUAedwzMCl8BOziTT9ghdlapNGnw4mg5dmXINimGV7XU2Oim1/VmxDl4FMxS0pvVNxvajXCV52JxdYYNXZssTp1W4nS15wUyEuTnmai1d5kMNnlDONujXC9glrOWOr4JnUPnVebdvA6OHijyaLPEDle0xI9XsYjKH++6JZ8ifXxC+q48zNvtmFio47x4o4nIEjLQVCvjiFPY7KIXJoFNuIwhFMI+mwaKGwwRSH0GqGwcNAtlad4jLAN33Io2EZ4IAlwiOopVrZvAUaGegfwj9ZynrahDaQdUNIbWCjNNDY6Cd4NukzK5X6QxqUMUYZCls45WYEjanqKcAY1YmrAiNDXDZXo5pa/MMrgKymxgWZG2jQRpSPdkAD0Q0Z19kz87V0yfhA/qGxU4uOkobWHhBifBX6BNQK0Ur2qDQ0HSSW+RHsREV7GWC9gED1QljUQmIcXaEXVdwgJqPCLU9X5auip/Ef/tQhxo3jzYTw/GYXur0Q3K3QzI2ahXiEzyBwM6DejMfqVj6Usbh5oofZt5KK4zhYGwF01HVa5N6wLNZ7vThqlIIPQlWuSVHC3D02cM8jysUilnzAej8kBLm+YUof7pFH7gvRfryj43u5JTNhwHldyx4U7BxlbY1tXPKMmmkN/TpeSX1heVdrOLSjXpW8n5kCwtMDqUyWKpkGFQ0N0q+0Tb7HDjXkTVwVIBQSfRWRaiLQOzowVb1Eatav3k6ceQzDmQvqVImjo1qmW+z72nthsLZQ4enHDkWk/qkRGhC+VcVzDPDH0cPhiyZXKqvR+pCIoa4sNYnR6ShtnQ3UpHiKW+UTWdeQC4YVXVa5p0AXTmlc+aF+hxSbBJcNCatmLIGCMnZD2Bh9BY33PJOdep/oSf6YiT1aICmlazcS4lIxRGKRGsnYFKZPlaNU2svthohaxtmPvuLTMRLdwV3yOR91Fv4bzC7qFgtL5pkUVgqCKobQ/YEca3brOXUS1CyJZuXKFQg/oKYKkAIYVLfebxLHUq9UqmxMji4vzoAmOnPA6vvvRNgYFS/97NgNFrwNmW3a2Jm4cZRV/Gh7q7N+qU0jZpa49WkvaNTleJdaPzWqI+5cjuoDdyjUI3ZmrLoDXdJI9v4glKXRmBjoM8v4gjqW4i4fpmZtemxKRDcJXuiOzH1R51WwdcHmmf1wH+/HYi4NRyDf0ErsAgLfcQjqebXmyDhaZRaYR7ZDhlCKi2p3EE2atQT1ZkemSVeLpgLXp7gO6tAKcEDflN5kJojIeBpqMUbJvJKU2KInYXmlAbZeOgnQEwUa9A43vAhuEKCkJJKftezWhaTnptxfQVGzmWgXNie8X7UbqddmZ968UGOjUSZF4eLlqWiepGgnn5/TfNy7cGGiy8VXHm7HLph66uPQOPwztquBGGvoXVV0EwzKF+0irzF9/mPrAOf1IWUwr7svMZQNgDtGzfUP9r5IJGLpLiAUkLYj3l/aIdocsmYTKJONGYYd/CeUdTs/hPFjB7heaDp1Cl4i1zU8PWLqJNywNrg0koEjxrCTh2eFhnBB5apdEt4B/jB6RWKRdC4dlFaQ+ZKDXTocjJw7v41+kXlWpBfeyiocf00rWrqJBB9AYqx69MbLUZgHeYvx1alQxblKnYv5ZQSPEU2aneKP8m5V8KyyGHFJ7AUv8JdSmkaj3tcotUPa4IXT08UkjEEVGDEEK/0rc5H+wpehKv1zX6amwn8/uLojOxEQ34lG9FxkF+ib4VVrbmq8bsbNJ2WrthPTDP0esAymZi93HtdbMP/a8n9iBFtGp0jBO9G4b6BtCqK2dus2xB2nEb0B5FE/276P8hLrj8Ei3mK1z4+z0gaTcprcG9BsFzqWd6WpQsUltonEIr0x1kv+zHsxUtRdQk8hHfEFzOaK67lqBbGCi2Gg1RN2V3wkyaqMJhh1oDSShKQNHRltDytoy/vN/v1mBpggIyqv7nlTgWvYNL6dcweFBMwVc10d5/ZmtyYedidLo/neUX3yb/ZsCffu+JxKk1wyPDAzu7BSvKTF1t42J254sIRcRhN11tBjlfXiNRXDRvVy8BOhQs5314nCTcB/oifKPJKUr3EyVsj+0nnPn6rN2oOx/J9wF+BOanOxM5ZVX+1ulEGgvHUKNjVayvxa2cE5xbmadN52a6Llz0rfRPg8zHqOtFesbq+6X+9cxvB5lfjwJqJLxTPqNmhz50P9S9XhWNgruKHKHru/05GjRyXqZz1bIXhoKyqCkbuZibV21h+rFPGb5CLDSn99PXwyShM/ouHo3Rc7+n+IczmmfK/XZ//FOD0P5/Z5AnjKdFChxtm7N2cTR65v+Zx884tugEmQAAAYRpQ0NQSUNDIHByb2ZpbGUAAHicfZE9SMNAHMVfW6VVKh2sIOKQoTpZEBVx1CoUoUKoFVp1MLn0C5o0JCkujoJrwcGPxaqDi7OuDq6CIPgB4ujkpOgiJf4vKbSI8eC4H+/uPe7eAf5Ghalm1zigapaRTiaEbG5VCL4ihAFE0IOwxEx9ThRT8Bxf9/Dx9S7Os7zP/Tn6lLzJAJ9APMt0wyLeIJ7etHTO+8RRVpIU4nPiMYMuSPzIddnlN85Fh/08M2pk0vPEUWKh2MFyB7OSoRJPEccUVaN8f9ZlhfMWZ7VSY6178heG89rKMtdpDiOJRSxBhAAZNZRRgYU4rRopJtK0n/DwDzl+kVwyucpg5FhAFSokxw/+B7+7NQuTE25SOAF0v9j2xwgQ3AWaddv+Prbt5gkQeAautLa/2gBmPkmvt7XYERDZBi6u25q8B1zuAINPumRIjhSg6S8UgPcz+qYc0H8L9K65vbX2cfoAZKir1A1wcAiMFil73ePdoc7e/j3T6u8HEfZygJPuyxoAAA0caVRYdFhNTDpjb20uYWRvYmUueG1wAAAAAAA8P3hwYWNrZXQgYmVnaW49Iu+7vyIgaWQ9Ilc1TTBNcENlaGlIenJlU3pOVGN6a2M5ZCI/Pgo8eDp4bXBtZXRhIHhtbG5zOng9ImFkb2JlOm5zOm1ldGEvIiB4OnhtcHRrPSJYTVAgQ29yZSA0LjQuMC1FeGl2MiI+CiA8cmRmOlJERiB4bWxuczpyZGY9Imh0dHA6Ly93d3cudzMub3JnLzE5OTkvMDIvMjItcmRmLXN5bnRheC1ucyMiPgogIDxyZGY6RGVzY3JpcHRpb24gcmRmOmFib3V0PSIiCiAgICB4bWxuczp4bXBNTT0iaHR0cDovL25zLmFkb2JlLmNvbS94YXAvMS4wL21tLyIKICAgIHhtbG5zOnN0RXZ0PSJodHRwOi8vbnMuYWRvYmUuY29tL3hhcC8xLjAvc1R5cGUvUmVzb3VyY2VFdmVudCMiCiAgICB4bWxuczpkYz0iaHR0cDovL3B1cmwub3JnL2RjL2VsZW1lbnRzLzEuMS8iCiAgICB4bWxuczpHSU1QPSJodHRwOi8vd3d3LmdpbXAub3JnL3htcC8iCiAgICB4bWxuczp0aWZmPSJodHRwOi8vbnMuYWRvYmUuY29tL3RpZmYvMS4wLyIKICAgIHhtbG5zOnhtcD0iaHR0cDovL25zLmFkb2JlLmNvbS94YXAvMS4wLyIKICAgeG1wTU06RG9jdW1lbnRJRD0iZ2ltcDpkb2NpZDpnaW1wOjFhZmYwNDM3LTNiOWMtNDU0MC1hMTUzLTZiZjlkZDBlZWIxYSIKICAgeG1wTU06SW5zdGFuY2VJRD0ieG1wLmlpZDphNGQ1OTg0MC02ZmQzLTRmYWUtOTdkMS1mMWU5MDA0MjQ0MDIiCiAgIHhtcE1NOk9yaWdpbmFsRG9jdW1lbnRJRD0ieG1wLmRpZDo2M2RlZWVkMS05ZmQ0LTRiZjYtODk3OS0yZGQwNTFiNWQ3ZGQiCiAgIGRjOkZvcm1hdD0iaW1hZ2UvcG5nIgogICBHSU1QOkFQST0iMi4wIgogICBHSU1QOlBsYXRmb3JtPSJNYWMgT1MiCiAgIEdJTVA6VGltZVN0YW1wPSIxNjYxMDk0NjQ4OTUzMzQ1IgogICBHSU1QOlZlcnNpb249IjIuMTAuMzAiCiAgIHRpZmY6T3JpZW50YXRpb249IjEiCiAgIHhtcDpDcmVhdG9yVG9vbD0iR0lNUCAyLjEwIj4KICAgPHhtcE1NOkhpc3Rvcnk+CiAgICA8cmRmOlNlcT4KICAgICA8cmRmOmxpCiAgICAgIHN0RXZ0OmFjdGlvbj0ic2F2ZWQiCiAgICAgIHN0RXZ0OmNoYW5nZWQ9Ii8iCiAgICAgIHN0RXZ0Omluc3RhbmNlSUQ9InhtcC5paWQ6ODJiZDExNWItNjA1Ny00Njg2LTgxYzQtYmUxNWMxODA3ZmNlIgogICAgICBzdEV2dDpzb2Z0d2FyZUFnZW50PSJHaW1wIDIuMTAgKE1hYyBPUykiCiAgICAgIHN0RXZ0OndoZW49IjIwMjItMDgtMjFUMTY6MTA6NDgrMDE6MDAiLz4KICAgIDwvcmRmOlNlcT4KICAgPC94bXBNTTpIaXN0b3J5PgogIDwvcmRmOkRlc2NyaXB0aW9uPgogPC9yZGY6UkRGPgo8L3g6eG1wbWV0YT4KICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIAogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIAogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIAogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIAogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIAogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIAogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIAogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgCiAgICAgICAgICAgICAgICAgICAgICAgICAgIAo8P3hwYWNrZXQgZW5kPSJ3Ij8+5TXgPwAAAAZiS0dEAAAAAAAA+UO7fwAAAAlwSFlzAAALEwAACxMBAJqcGAAAAAd0SU1FB+YIFQ8KMIwUIUgAAAm9SURBVHja5VpLjx5HFT2nvs9jDyQONkgosIiEEufFjD2BJRiEwOa1IApjKxDx2LFgYXaINX8AhEBCQuDECCmRZeNkgRCb+BEDEfbgxLFlRYosFjFPjxGyPd+M+7DoV1X1rer+JuMEkpbG8teP6rq3zj333FvNf3/nEaEQwkNAfKo6Xf7D+gck86ae5+1HMicGHpzuWUeMAUArLvN+ZScqla81XJO3RYkL0bs1tU843P4tBcZ0BJwLJ0bvffLMYzxRgmxnx+C26mYqsLVxEGkjjdH49Q1MI6n+SWYQmTjGIKvJhBOgYoeGE1YwIQ96ppNCFNF/GUO0yFpIy0nyR2kHJbvh2iDTcM6YzgGOXWQyEfuMLtejR/EneZDwIdVjGI3zsp5hz0KzvYmVUYyfIbsIoAVNb7Dyknp5hz5y5EMqdJxaD0bGtVBjMkRqnihDUVnEGHN0xBiOoGOzygqWYuAqNfNnBTXZq+HHboMkHx3RoKpX33Je6y3GocWWy+owjEEoCXCudECJgnIlaEJJPj+WccUuqzNAkQVbRUjqCQtGhFo5VgwfogAxETc+SStCqAPGJCGyxYm58uU1Jrgu5khajyeNi0iDKUmhJq44BSpbNLXZjTVaKS8EcgMMYucSRbTQHBlgai0rhwWLaHhfUXJKEqPnPD9cHEodIJo5JAgaIsfEda5nmKWktECh7yTBoulAZFnG0Z9f2oHwrsm3h5UOoGMnd6sjfHytoKwgasM9dKiUEW0WS/vjxQ8wFqldhHXTkloaEkCHigQdOy5nT2rq+kWRk/yZuJIkmZK+NNOkGtLJqcaa4JhwrifefCgHJFinQXKA/g/P0fdEN/AhMU2EseTskKSfNWjwktBRZtZ869U3eK4kQVqsGemYxhjZZJMgILLLxFa6EtLXzDqERibqzEPNAjRVhQ9SV9cCLqX+YEhJJvJ7FbVJqSqYMSBfQqVIlh7R5nVDrg5hnBkc4VghgLUjmr/qCSI8T+/Pofprr9ERdMDmbx/EaP5L7e11uu2MUVWjLj7nzcPBG9v7o+ucC8dA4n3leZa1gAOcjNydIqZMEeIh1t19D2b2H0Cx+1GsnTiC4uVfd8RgkBrYoodBxUtr+RpuDfRBB2R22DVIanWAhRFOVQeEgq69wd19D2b2HUDx8UexdvIIipePRYbQKKDq93TlbZ3NSS9Vx0Tb0w5oMkadBun3Q0BQ8poWVix3qiDPCAsmlSMWD6D4WOWI88cyZW3EoLJrA2YJuK4bmCykymqwjuXa/CodMgNz/51SQnevrQLjTVlH3Dp1BMX5Z9HtlrDbgkzp8p6MZCOWTbxw8oPPSjeU7tMpUY6ipxl614cw+uQ3MHrgo6Yj6qO4chm3Th1F8cqxnh6i3dZRUI0y7FWkGq71uVmCkx9+TrhZJASPBjZtlZw4t92L0Se+CbdjARiN+x1x4dnhDdTBC6QgYzf/nyU4+dHnhRtFb3c21xo37Y8mze33Y7T7a3D3DXDEC0ehi88Fq66o1zGsa93T4n8XwdUff0G4UXTrePX1+adve0sAt+/AaPfX4e7dlXWErlzGrdNHUVx8rndsmW0M5cMJAmYduPqTL5YhMABWwkDPD+ASvn8Bo8e+B757a7ZtXbx2HmuHvwvcWpluYyUXNbWynXVRNRi4s5s+mMjfnaavjAiqFdBoFu4jT8A98pm88Tev49a551H8/iCoSatK/VkoQfWiLcXjlp1jvTHCYDQJidzJTFXos4uRRkebwV1fLQ2/4z15w186juIPvwBWltvUSHZTG9MQH7Q/wkAHMNWYsZK90bGl/RI3A+78CtzCp8E7tmUNL14+juKPB4GV5ZKPHECOgdEstPofI9crWcEy5ikagqFGQNsPSJBcQk11ujTBfMbg/OPgrj3gnRnDVyrDX3yyWvG6gHFw84/DLexF8bufAn85YRjPkLyVKFxSEpn1vgBp1tGMF9ZqbydWZfTEz4Ct7+01XH96CpgsV8UNAY7g5vaDC3vBre/zujfMNmQou5YJVGsUpmUt0AwekohZmNCogJoumUIpnDJ+5TqK88ehM4dKw1GXpiPw4f0lYmrDmzCKehYJku7AOCgEFW7CAOXGCF3LAVkNkN3siHqItA3XKyegs4egSQh1PrQfbuceIDY82sQw2T16p3Jdqk6YMuwI2TvCMbPGAoh5tl25Dl04AS0dAibXmioMdMCD++Dm04bXz+Pm1XKOSmgQb75Mahl292nrvcEGUjmPxaTXJ0dXrkMXT0B//qUHdQAcgQ8sgnN78xwxuQFdOAmdeRKYLAc81b/KyoZJc9YB1K8WhclasMy5Ym+wHN50F7B6zft6YQTcvwjO7QHu7DH84skKMVfzWj4xuWBfNKduZ8a1EgwVlN1ttVve9ELTL02xdq1i7xGw48vgh/sMvwldOgUsPQVNrjZdW+Xi3vpYwGuL0Y9dCxFlQyTcYkr3+phoeRv7gSzTGe57DHi4x/DVFeDV0+WKr/y9MTzccbJ6iFHjpJOpkBdoUpUGU0fuWyPri4VALgtY+Bbw0KcQ9NviY20CvPBz6PJv2qwga2cJYf7u9PgSEjbKVIr3HEhQT+8TJqsGq6jHE0LvF1nb54G5ReCDD+Yd8ddXgaXDwN9OD6ys89Ve9tMyhRxQOWAy/BM7GuHR99z2nQMcIeD1S8C5w8A/XhyWaQLlug6HbNoE6ulFYXUVb8qxbYAjJODKJeAlzxFGE2pYN8juITZdpZnGAZPbYG0GGtt2AvP7gA/0OOL1i8C5Z4B/ncW6vh5N9jmruW2aAfXMYhkCb8UxyBEF8NvvA/88s/Hv3zRTZQFq3TzXuUcGABgXMtUNy0vA80vA9l3AXMIRdMBoc3c5yfAT0QDuDLun/r3+VhuBcRZaHIj01O84lVn9BgK4ugQcXwK25RxheD45vvGbdlyM7WDpo/bEZ1+d5WcCEokxGkfsBOb2t45oELoBqTm4VykhpOnZxd9xgIz7NIShIkdUiCjWesaaZu6IEMAMB6yH+DfyWD4LnDg7cGz2OIChiGITAsLb45gCtV7t080CfWEkw+HJr7mjT28Gf9oyjDI6FBMLpvjD787HmBYHcEqYZ38rPSYHjM838H72ZYNsFni7HjTSIG8DeVmFJQeGUeqLj16x1fN+P9QVIEC3BwFcZ9hMC3u+gfdTcHiHH/la4H8tyw0Nqakd8P9AgtOE1BSHAxWmjvhFNM6/2YqQt+t+eQhIepj5fL6uSbBHshpqh7l7jfFSNiD8ANsNLlA2dMWnKWaG3DtN8RZmPYMENbz5sdGw72tKa4N/l0JIb11s3y4ZPJgshTG0BRi9Q0WAtuC/rByz/QyBVXYAAAAASUVORK5CYII=",document.head.appendChild(s);const i=new P({id:"app-container"}),n=new P({id:"editor-container"}),a=new P({id:"tooltips-container"}),r=new P({id:"top-container"}),o=document.createElement("canvas");o.id="canvas";const l=new F({id:"app-label",text:`SUPERSPLAT v${yy}`}),h=new F({id:"cursor-label"});let c="";e.on("camera.focalPointPicked",(e=>{h.text=`${e.position.x.toFixed(2)}, ${e.position.y.toFixed(2)}, ${e.position.z.toFixed(2)}`,c=`${e.position.x}, ${e.position.y}, ${e.position.z}`})),["pointerdown","pointerup","pointermove","wheel","dblclick"].forEach((e=>{h.dom.addEventListener(e,(e=>e.stopPropagation()))})),h.dom.addEventListener("pointerdown",(()=>{navigator.clipboard.writeText(c);const e=h.text;h.text=Yx("cursor.copied"),setTimeout((()=>{h.text=e}),1e3)}));const d=new P({id:"canvas-container"}),u=new P({id:"tools-container"}),p=new fT;a.append(p);const m=new hT(e,p),f=new bT(e,p),g=new zA(e,p),v=new BA(e,p),_=new sT(e,p),y=new JA(e,p),x=new YA(e);d.dom.appendChild(o),d.append(l),d.append(h),d.append(u),d.append(m),d.append(f),d.append(g),d.append(v),d.append(_),d.append(y),d.append(x);const w=new wT(e);d.append(w),e.on("prerender",(e=>{w.update(e)}));const b=new P({id:"main-container"}),C=new mT(e,p),S=new LA(e);b.append(d),b.append(C),b.append(S),n.append(b),p.register(h,Yx("cursor.click-to-copy"),"top");const A=new QA(p),T=new dT,E=new CT(e),k=new eT(e),M=new gT(e);r.append(A),r.append(E),r.append(k),r.append(M),i.append(n),i.append(r),i.append(a),i.append(T),this.appContainer=i,this.topContainer=r,this.canvasContainer=d,this.toolsContainer=u,this.canvas=o,this.popup=A,document.body.appendChild(i.dom),document.body.setAttribute("tabIndex","-1"),e.on("show.shortcuts",(()=>{T.hidden=!1})),e.function("show.viewerExportPopup",(e=>E.show(e))),e.function("show.publishSettingsDialog",(async()=>{if(!await e.invoke("publish.enabled"))return await e.invoke("showPopup",{type:"error",header:Yx("popup.error"),message:Yx("publish.please-log-in")}),!1;const t=await k.show();t&&await e.invoke("scene.publish",t)})),e.function("show.videoSettingsDialog",(async()=>{const t=await M.show();t&&await e.invoke("render.video",t)})),e.function("show.about",(()=>this.popup.show({type:"info",header:"About",message:`SUPERSPLAT v${yy}`}))),e.function("showPopup",(e=>this.popup.show(e)));const I=new uT;r.append(I),e.on("startSpinner",(()=>{I.hidden=!1})),e.on("stopSpinner",(()=>{I.hidden=!0}));const D=window.devicePixelRatio;o.width=Math.ceil(d.dom.offsetWidth*D),o.height=Math.ceil(d.dom.offsetHeight*D),["contextmenu","gesturestart","gesturechange","gestureend"].forEach((e=>{document.addEventListener(e,(e=>{e.preventDefault()}),!0)})),d.dom.addEventListener("pointerdown",(e=>{(e.target===o||u.dom.contains(e.target))&&document.body.focus()}),!0)}}const AT=()=>{const e={};return new URLSearchParams(window.location.search.slice(1)).forEach(((t,s)=>{((t,s)=>{let i=e;t.split(".").forEach(((e,t,n)=>{t===n.length-1?i[e]=s:(i.hasOwnProperty(e)||(i[e]={}),i=i[e])}))})(s,t)})),e};console.log(`SuperSplat v${yy} | PCUI v5.2.0 (f03db26) | Engine v${We} (${je})`),(async()=>{const e=new gw,t=new URL(window.location.href);let s;try{s=JSON.parse(decodeURIComponent(t.searchParams.get("remoteStorage")))}catch(e){}const i=new Jx(e),n=new ST(e,!!s),a=await function(e,t){var s;void 0===t&&(t={});var i,n=null!=(s=t.deviceTypes)?s:[];n.includes(ri)||n.push(ri),n.includes(li)||n.push(li),Qe.browser&&navigator.xr&&(null!=(i=t).xrCompatible||(i.xrCompatible=!0));for(var a=[],r=0;r<n.length;r++){var o,l,h=n[r];h===oi&&(null==(l=window)||null==(o=l.navigator)?void 0:o.gpu)&&a.push((()=>new lr(e,t).initWebGpu(t.glslangUrl,t.twgslUrl))),h===ri&&a.push((()=>new Tr(e,t))),h===li&&a.push((()=>new Dr(e,t)))}return new Promise(((e,t)=>{var s=0,i=()=>{s>=a.length?t(new Error("Failed to create a graphics device")):Promise.resolve(a[s++]()).then((t=>{t?e(t):i()})).catch((e=>{console.log(e),i()}))};i()}))}(n.canvas,{deviceTypes:["webgl2"],antialias:!1,depth:!1,stencil:!1,xrCompatible:!1,powerPreference:"high-performance"}),r=[AT()],o=eA(r),l=new ZS(e,o,n.canvas,a),h=new mt,c=new mt,d=new mt,u=new mt,p=(t,s,i)=>{t.equals(s)||(t.copy(s),e.fire(i,t))},m=e=>{p(h,e,"bgClr")},f=e=>{p(c,e,"selectedClr")},g=e=>{p(d,e,"unselectedClr")},v=e=>{p(u,e,"lockedClr")};e.on("setBgClr",(e=>{m(e)})),e.on("setSelectedClr",(e=>{f(e)})),e.on("setUnselectedClr",(e=>{g(e)})),e.on("setLockedClr",(e=>{v(e)})),e.function("bgClr",(()=>h)),e.function("selectedClr",(()=>c)),e.function("unselectedClr",(()=>d)),e.function("lockedClr",(()=>u)),e.on("bgClr",(e=>{const t=e=>`${Math.max(0,Math.min(255,255*e)).toFixed(0)}`;document.body.style.backgroundColor=`rgba(${t(e.r)},${t(e.g)},${t(e.b)},1)`})),e.on("selectedClr",(e=>{l.forceRender=!0})),e.on("unselectedClr",(e=>{l.forceRender=!0})),e.on("lockedClr",(e=>{l.forceRender=!0}));const _=e=>new mt(e.r,e.g,e.b,e.a);m(_(o.bgClr)),f(_(o.selectedClr)),g(_(o.unselectedClr)),v(_(o.lockedClr));const y=document.createElement("canvas"),x=y.getContext("2d");y.setAttribute("id","mask-canvas"),x.globalCompositeOperation="copy";const w={canvas:y,context:x},b=new fA(e);b.register("rectSelection",new lA(e,n.toolsContainer.dom)),b.register("brushSelection",new iA(e,n.toolsContainer.dom,w)),b.register("polygonSelection",new oA(e,n.toolsContainer.dom,w)),b.register("lassoSelection",new nA(e,n.toolsContainer.dom,w)),b.register("sphereSelection",new mA(e,l,n.canvasContainer)),b.register("move",new rA(e,l)),b.register("rotate",new hA(e,l)),b.register("scale",new cA(e,l)),n.toolsContainer.dom.appendChild(y),window.scene=l,fw(e,i,l),((e,t)=>{let s=null;const i=t=>{if(t!==s&&(!t||t.visible)){const i=s;s=t,e.fire("selection.changed",s,i)}};e.on("selection",(e=>{i(e)})),e.function("selection",(()=>s)),e.on("selection.next",(()=>{const e=t.getElementsByType(xw.splat);if(e.length>1){const t=e.indexOf(s);i(e[(t+1)%e.length])}})),e.on("scene.elementAdded",(e=>{e.type===xw.splat&&i(e)})),e.on("scene.elementRemoved",(e=>{if(e===s){const s=t.getElementsByType(xw.splat);i(1===s.length?null:s.find((t=>t!==e)))}})),e.on("splat.visibility",(e=>{e!==s||e.visible||i(null)})),e.on("camera.focalPointPicked",(e=>{i(e.splat)}))})(e,l),sA(e),F_(e),TA(e),Pw(e),Mw(e),Zx(l,e),((e,t)=>{let s;t.function("render.image",(async()=>{t.fire("startSpinner");try{const i=e.camera.entity.camera.renderTarget,n=i.colorBuffer,a=new Uint8Array(n.width*n.height*4);await n.read(0,0,n.width,n.height,{renderTarget:i,data:a}),s||(s=new dS);const r=new Uint8ClampedArray(a.buffer),{r:o,g:l,b:h}=t.invoke("bgClr");for(let e=0;e<r.length;e+=4){const t=255-r[e+3];r[e+0]+=o*t,r[e+1]+=l*t,r[e+2]+=h*t,r[e+3]=255}const c=await s.compress(new Uint32Array(r.buffer),n.width,n.height),d=t.invoke("selection"),u=`${uS(d?.name??"SuperSplat")}-image.png`;pS(c,u)}finally{t.fire("stopSpinner")}})),t.function("render.video",(async s=>{t.fire("startSpinner");try{const{startFrame:i,endFrame:n,frameRate:a,width:r,height:o,bitrate:l,transparentBg:h,showDebug:c}=s,d=new lS({target:new tC,video:{codec:"avc",width:r,height:o},fastStart:"in-memory",firstTimestampBehavior:"offset"}),u=new VideoEncoder({output:(e,t)=>{d.addVideoChunk(e,t)},error:e=>{console.log(e)}});u.configure({codec:o<1080?"avc1.420028":"avc1.640033",width:r,height:o,bitrate:l}),e.camera.startOffscreenMode(r,o),e.camera.renderOverlays=c,h||e.camera.entity.camera.clearColor.copy(t.invoke("bgClr")),e.lockedRenderMode=!0;const p=new Uint8Array(r*o*4),m=new Uint8Array(4*r),f=e.getElementsByType(xw.splat).filter((e=>e.visible)),g=async s=>{t.fire("timeline.setFrame",s),e.camera.onUpdate(0),await Promise.all(f.map((t=>new Promise((s=>{const{instance:i}=t.entity.gsplat,n=i.sorter.on("updated",(()=>{n.off(),s()}));i.sort(e.camera.entity),setTimeout((()=>{s()}),1e3)}))))),e.lockedRender=!0},v=async t=>{const{renderTarget:s}=e.camera.entity.camera,{colorBuffer:i}=s;await i.read(0,0,r,o,{renderTarget:s,data:p});for(let e=0;e<o/2;e++){const t=e*r*4,s=(o-e-1)*r*4;m.set(p.subarray(t,t+4*r)),p.copyWithin(t,s,s+4*r),p.set(m,s)}const n=new VideoFrame(p,{format:"RGBA",codedWidth:r,codedHeight:o,timestamp:Math.floor(1e6*t/a),duration:Math.floor(1e6/a)});u.encode(n),n.close()};for(let t=i;t<=n;t++){const s=new Promise(((s,i)=>{const n=e.events.on("postrender",(async()=>{n.off();try{await v(t),s(!0)}catch(e){i(e)}}))}));await g(t),await s}return await u.flush(),d.finalize(),pS(d.target.buffer,`${uS(f[0]?.name??"SuperSplat")}-video.mp4`),u.close(),!0}catch(e){await t.invoke("showPopup",{type:"error",header:Yx("render.failed"),message:`'${e.message??e}'`})}finally{e.camera.endOffscreenMode(),e.camera.renderOverlays=!0,e.camera.entity.camera.clearColor.set(0,0,0,0),e.lockedRenderMode=!1,e.forceRender=!0,t.fire("stopSpinner")}}))})(l,e),(e=>{const t=new tA(e);t.register(["Delete","Backspace"],{event:"select.delete"}),t.register(["Escape"],{event:"tool.deactivate"}),t.register(["Tab"],{event:"selection.next"}),t.register(["1"],{event:"tool.move",sticky:!0}),t.register(["2"],{event:"tool.rotate",sticky:!0}),t.register(["3"],{event:"tool.scale",sticky:!0}),t.register(["G","g"],{event:"grid.toggleVisible"}),t.register(["C","c"],{event:"tool.toggleCoordSpace"}),t.register(["F","f"],{event:"camera.focus"}),t.register(["R","r"],{event:"tool.rectSelection",sticky:!0}),t.register(["P","p"],{event:"tool.polygonSelection",sticky:!0}),t.register(["L","l"],{event:"tool.lassoSelection",sticky:!0}),t.register(["B","b"],{event:"tool.brushSelection",sticky:!0}),t.register(["A","a"],{event:"select.all",ctrl:!0}),t.register(["A","a"],{event:"select.none",shift:!0}),t.register(["I","i"],{event:"select.invert",ctrl:!0}),t.register(["H","h"],{event:"select.hide"}),t.register(["U","u"],{event:"select.unhide"}),t.register(["["],{event:"tool.brushSelection.smaller"}),t.register(["]"],{event:"tool.brushSelection.bigger"}),t.register(["Z","z"],{event:"edit.undo",ctrl:!0,capture:!0}),t.register(["Z","z"],{event:"edit.redo",ctrl:!0,shift:!0,capture:!0}),t.register(["M","m"],{event:"camera.toggleMode"}),t.register(["D","d"],{event:"dataPanel.toggle"}),t.register([" "],{event:"camera.toggleOverlay"})})(e),Tw(l,e,n.appContainer.dom),l.start();const C=t.searchParams.getAll("load");for(const t of C)await e.invoke("import",decodeURIComponent(t));"launchQueue"in window&&window.launchQueue.setConsumer((async t=>{for(const s of t.files){const t=await s.getFile(),i=URL.createObjectURL(t);await e.invoke("import",i,s.name),URL.revokeObjectURL(i)}}))})();
//# sourceMappingURL=index.js.map
